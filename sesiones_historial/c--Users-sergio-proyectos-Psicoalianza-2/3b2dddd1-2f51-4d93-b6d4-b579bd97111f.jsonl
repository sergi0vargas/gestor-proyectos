{"type":"file-history-snapshot","messageId":"b8a855fd-f688-4dd4-81ed-108eb568f47b","snapshot":{"messageId":"b8a855fd-f688-4dd4-81ed-108eb568f47b","trackedFileBackups":{},"timestamp":"2026-01-29T20:32:47.589Z"},"isSnapshotUpdate":false}
{"parentUuid":"6a3b4ce4-739a-40aa-b2ea-6e8ed673e77e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). STOP what you are doing and wait for the user to tell you how to proceed.","is_error":true,"tool_use_id":"toolu_019m29fXpij7Szp9YQ64uLXy"}]},"uuid":"61aa9972-b221-4848-885c-d410acc4ed44","timestamp":"2026-01-29T20:32:47.450Z","toolUseResult":"Error: The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). STOP what you are doing and wait for the user to tell you how to proceed.","sourceToolAssistantUUID":"6a3b4ce4-739a-40aa-b2ea-6e8ed673e77e"}
{"parentUuid":"61aa9972-b221-4848-885c-d410acc4ed44","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":[{"type":"text","text":"[Request interrupted by user for tool use]"}]},"uuid":"72924b4f-2ff9-4343-9a1d-051ba14906e4","timestamp":"2026-01-29T20:32:47.452Z"}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":"Implement the following plan:\n\n# Plan: Corrección del Sistema de Filtros con Chips - Modal Historial de Compras\n\n## Resumen del Problema\n\nEn `/planes-clientes`, modal \"Historial de compras\", pestaña \"Créditos IA\" (`#pestana-compras-creditos`):\n\n1. **Al remover un tag o \"Limpiar filtros\"**: El filtro sigue aplicado (la tabla no se actualiza)\n2. **Al hacer clic en \"BUSQUEDAS RECIENTES\"**: No aplica el filtro seleccionado\n\n## Causa Raíz\n\n- Cuando se crea un chip (Enter), el input se vacía pero `busqueda_tablas.creditos` mantiene el valor anterior\n- `procesarFiltrosTabla()` no procesa el array `chips` del `json_filtros`\n- No existe sincronización entre los chips del localStorage y la búsqueda local de DataTables\n- Falta implementar `restablecerFiltrosDropdownAdicional()` para limpiar la búsqueda\n\n## Archivo a Modificar\n\n- `public/js/empresa/planes/modal-recompras.js`\n\n## Cambios a Implementar\n\n### 1. Agregar función `obtenerBusquedaChips()` (después de línea 51)\n\n```javascript\n/**\n * Obtener la busqueda combinada de chips activos.\n *\n * @param {string} id_input ID del input de filtro\n * @returns {string} Texto combinado de los chips separados por espacio\n * @author Sergio Vargas\n */\nfunction obtenerBusquedaChips(id_input) {\n    let componentes_chips_storage = localStorage.getItem('componentes_chips_storage');\n    if (componentes_chips_storage == null) return '';\n\n    componentes_chips_storage = JSON.parse(componentes_chips_storage);\n    if (componentes_chips_storage[window.location.pathname] == null) return '';\n    if (componentes_chips_storage[window.location.pathname][id_input] == null) return '';\n\n    let chips = componentes_chips_storage[window.location.pathname][id_input].chips;\n    return chips.join(' ');\n}\n```\n\n### 2. Agregar función `actualizarBusquedaConChips()`\n\n```javascript\n/**\n * Actualizar la busqueda de la tabla con los chips activos.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction actualizarBusquedaConChips(nombre_tabla) {\n    const id_input = `filtro_dropdown_${nombre_tabla}`;\n    const busqueda_chips = obtenerBusquedaChips(id_input);\n    const valor_input = $(`#${id_input}`).val() || '';\n\n    let busqueda_combinada = '';\n    if (valor_input && busqueda_chips) {\n        busqueda_combinada = valor_input + ' ' + busqueda_chips;\n    } else if (valor_input) {\n        busqueda_combinada = valor_input;\n    } else if (busqueda_chips) {\n        busqueda_combinada = busqueda_chips;\n    }\n\n    busqueda_tablas[nombre_tabla] = busqueda_combinada;\n    aplicarBusquedaTabla(nombre_tabla, busqueda_combinada);\n}\n```\n\n### 3. Modificar eventos `input` (líneas 59-62)\n\nReemplazar los 4 eventos input para combinar chips con el valor del input:\n\n```javascript\n$(document).on('input', '#filtro_dropdown_seleccion', function () {\n    const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_seleccion');\n    const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n    busqueda_tablas.seleccion = valor_combinado;\n    aplicarBusquedaTabla('seleccion', valor_combinado);\n});\n$(document).on('input', '#filtro_dropdown_organizacional', function () {\n    const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_organizacional');\n    const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n    busqueda_tablas.organizacional = valor_combinado;\n    aplicarBusquedaTabla('organizacional', valor_combinado);\n});\n$(document).on('input', '#filtro_dropdown_vocacional', function () {\n    const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_vocacional');\n    const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n    busqueda_tablas.vocacional = valor_combinado;\n    aplicarBusquedaTabla('vocacional', valor_combinado);\n});\n$(document).on('input', '#filtro_dropdown_creditos', function () {\n    const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_creditos');\n    const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n    busqueda_tablas.creditos = valor_combinado;\n    aplicarBusquedaTabla('creditos', valor_combinado);\n});\n```\n\n### 4. Modificar `aplicarFiltrosDropdownRecompras()` (líneas 842-870)\n\nAgregar `setTimeout` para actualizar búsqueda con chips después de recargar tabla:\n\n```javascript\nfunction aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('seleccion'), 100);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('organizacional'), 100);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('vocacional'), 100);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('creditos'), 100);\n    }\n}\n```\n\n### 5. Agregar función `restablecerFiltrosDropdownAdicional()` (después de línea 880)\n\n```javascript\n/**\n * Funcion para restablecer filtros adicionales - limpia la busqueda de las tablas.\n *\n * @param {string} input_id ID del input de filtro\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction restablecerFiltrosDropdownAdicional(input_id) {\n    const mapa_tablas = {\n        'filtro_dropdown_seleccion': 'seleccion',\n        'filtro_dropdown_organizacional': 'organizacional',\n        'filtro_dropdown_vocacional': 'vocacional',\n        'filtro_dropdown_creditos': 'creditos'\n    };\n\n    const nombre_tabla = mapa_tablas[input_id];\n    if (nombre_tabla) {\n        busqueda_tablas[nombre_tabla] = '';\n        aplicarBusquedaTabla(nombre_tabla, '');\n    }\n}\n\nwindow.restablecerFiltrosDropdownAdicional = restablecerFiltrosDropdownAdicional;\n```\n\n## Verificación\n\n1. Ir a `/planes-clientes`\n2. Abrir modal \"Historial de compras\"\n3. Ir a pestaña \"Créditos IA\"\n\n**Test 1 - Crear chip:**\n- Escribir texto y presionar Enter\n- Verificar que el chip aparece y la tabla filtra\n\n**Test 2 - Quitar chip:**\n- Hacer clic en X del chip\n- Verificar que la tabla muestra todos los registros\n\n**Test 3 - Limpiar filtros:**\n- Crear chips y filtros avanzados\n- Clic en \"Restablecer filtros\"\n- Verificar que todo se limpia\n\n**Test 4 - Búsquedas recientes:**\n- Clic en input de búsqueda\n- Clic en una búsqueda reciente\n- Verificar que aplica el filtro\n\n\nIf you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: C:\\Users\\sergio\\.claude\\projects\\C--Users-sergio-proyectos-Psicoalianza-2\\33e7e39b-d533-4d54-a4a4-a8d42f72ebfd.jsonl"},"uuid":"b8a855fd-f688-4dd4-81ed-108eb568f47b","timestamp":"2026-01-29T20:32:47.448Z","planContent":"# Plan: Corrección del Sistema de Filtros con Chips - Modal Historial de Compras\n\n## Resumen del Problema\n\nEn `/planes-clientes`, modal \"Historial de compras\", pestaña \"Créditos IA\" (`#pestana-compras-creditos`):\n\n1. **Al remover un tag o \"Limpiar filtros\"**: El filtro sigue aplicado (la tabla no se actualiza)\n2. **Al hacer clic en \"BUSQUEDAS RECIENTES\"**: No aplica el filtro seleccionado\n\n## Causa Raíz\n\n- Cuando se crea un chip (Enter), el input se vacía pero `busqueda_tablas.creditos` mantiene el valor anterior\n- `procesarFiltrosTabla()` no procesa el array `chips` del `json_filtros`\n- No existe sincronización entre los chips del localStorage y la búsqueda local de DataTables\n- Falta implementar `restablecerFiltrosDropdownAdicional()` para limpiar la búsqueda\n\n## Archivo a Modificar\n\n- `public/js/empresa/planes/modal-recompras.js`\n\n## Cambios a Implementar\n\n### 1. Agregar función `obtenerBusquedaChips()` (después de línea 51)\n\n```javascript\n/**\n * Obtener la busqueda combinada de chips activos.\n *\n * @param {string} id_input ID del input de filtro\n * @returns {string} Texto combinado de los chips separados por espacio\n * @author Sergio Vargas\n */\nfunction obtenerBusquedaChips(id_input) {\n    let componentes_chips_storage = localStorage.getItem('componentes_chips_storage');\n    if (componentes_chips_storage == null) return '';\n\n    componentes_chips_storage = JSON.parse(componentes_chips_storage);\n    if (componentes_chips_storage[window.location.pathname] == null) return '';\n    if (componentes_chips_storage[window.location.pathname][id_input] == null) return '';\n\n    let chips = componentes_chips_storage[window.location.pathname][id_input].chips;\n    return chips.join(' ');\n}\n```\n\n### 2. Agregar función `actualizarBusquedaConChips()`\n\n```javascript\n/**\n * Actualizar la busqueda de la tabla con los chips activos.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction actualizarBusquedaConChips(nombre_tabla) {\n    const id_input = `filtro_dropdown_${nombre_tabla}`;\n    const busqueda_chips = obtenerBusquedaChips(id_input);\n    const valor_input = $(`#${id_input}`).val() || '';\n\n    let busqueda_combinada = '';\n    if (valor_input && busqueda_chips) {\n        busqueda_combinada = valor_input + ' ' + busqueda_chips;\n    } else if (valor_input) {\n        busqueda_combinada = valor_input;\n    } else if (busqueda_chips) {\n        busqueda_combinada = busqueda_chips;\n    }\n\n    busqueda_tablas[nombre_tabla] = busqueda_combinada;\n    aplicarBusquedaTabla(nombre_tabla, busqueda_combinada);\n}\n```\n\n### 3. Modificar eventos `input` (líneas 59-62)\n\nReemplazar los 4 eventos input para combinar chips con el valor del input:\n\n```javascript\n$(document).on('input', '#filtro_dropdown_seleccion', function () {\n    const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_seleccion');\n    const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n    busqueda_tablas.seleccion = valor_combinado;\n    aplicarBusquedaTabla('seleccion', valor_combinado);\n});\n$(document).on('input', '#filtro_dropdown_organizacional', function () {\n    const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_organizacional');\n    const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n    busqueda_tablas.organizacional = valor_combinado;\n    aplicarBusquedaTabla('organizacional', valor_combinado);\n});\n$(document).on('input', '#filtro_dropdown_vocacional', function () {\n    const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_vocacional');\n    const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n    busqueda_tablas.vocacional = valor_combinado;\n    aplicarBusquedaTabla('vocacional', valor_combinado);\n});\n$(document).on('input', '#filtro_dropdown_creditos', function () {\n    const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_creditos');\n    const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n    busqueda_tablas.creditos = valor_combinado;\n    aplicarBusquedaTabla('creditos', valor_combinado);\n});\n```\n\n### 4. Modificar `aplicarFiltrosDropdownRecompras()` (líneas 842-870)\n\nAgregar `setTimeout` para actualizar búsqueda con chips después de recargar tabla:\n\n```javascript\nfunction aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('seleccion'), 100);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('organizacional'), 100);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('vocacional'), 100);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('creditos'), 100);\n    }\n}\n```\n\n### 5. Agregar función `restablecerFiltrosDropdownAdicional()` (después de línea 880)\n\n```javascript\n/**\n * Funcion para restablecer filtros adicionales - limpia la busqueda de las tablas.\n *\n * @param {string} input_id ID del input de filtro\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction restablecerFiltrosDropdownAdicional(input_id) {\n    const mapa_tablas = {\n        'filtro_dropdown_seleccion': 'seleccion',\n        'filtro_dropdown_organizacional': 'organizacional',\n        'filtro_dropdown_vocacional': 'vocacional',\n        'filtro_dropdown_creditos': 'creditos'\n    };\n\n    const nombre_tabla = mapa_tablas[input_id];\n    if (nombre_tabla) {\n        busqueda_tablas[nombre_tabla] = '';\n        aplicarBusquedaTabla(nombre_tabla, '');\n    }\n}\n\nwindow.restablecerFiltrosDropdownAdicional = restablecerFiltrosDropdownAdicional;\n```\n\n## Verificación\n\n1. Ir a `/planes-clientes`\n2. Abrir modal \"Historial de compras\"\n3. Ir a pestaña \"Créditos IA\"\n\n**Test 1 - Crear chip:**\n- Escribir texto y presionar Enter\n- Verificar que el chip aparece y la tabla filtra\n\n**Test 2 - Quitar chip:**\n- Hacer clic en X del chip\n- Verificar que la tabla muestra todos los registros\n\n**Test 3 - Limpiar filtros:**\n- Crear chips y filtros avanzados\n- Clic en \"Restablecer filtros\"\n- Verificar que todo se limpia\n\n**Test 4 - Búsquedas recientes:**\n- Clic en input de búsqueda\n- Clic en una búsqueda reciente\n- Verificar que aplica el filtro\n"}
{"parentUuid":"b8a855fd-f688-4dd4-81ed-108eb568f47b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01P7nW7rCBoc1JvquPdiLyJs","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a implementar el plan para corregir el sistema de filtros con chips en el modal de historial de compras. Primero, déjame leer el archivo que necesito modificar."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":32411,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":32411},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXcJiK63qpBJtx5WJELRj","type":"assistant","uuid":"59539b20-382f-496b-b607-6c9ef98ef057","timestamp":"2026-01-29T20:32:52.992Z"}
{"parentUuid":"59539b20-382f-496b-b607-6c9ef98ef057","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01P7nW7rCBoc1JvquPdiLyJs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XEPr2Q6KWBnhhPN3KyUUWt","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":32411,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":32411},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXcJiK63qpBJtx5WJELRj","type":"assistant","uuid":"9ce3c003-488d-4bcf-91a6-343c4514482d","timestamp":"2026-01-29T20:32:54.048Z"}
{"parentUuid":"9ce3c003-488d-4bcf-91a6-343c4514482d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XEPr2Q6KWBnhhPN3KyUUWt","type":"tool_result","content":"     1→\n     2→const MODAL_FILTROS_AVANZADOS_COMPRAS_ID = 'modal-filtros-avanzados-compras';\n     3→const MODAL_HISTORIAL_COMPRAS_ID = 'modal-historial-recompras';\n     4→\n     5→const FILTRO_DURACION_ID = 'filtro-duracion';\n     6→const FILTRO_FECHA_ACTIVACION_ID = 'filtro-fecha-activacion';\n     7→const FILTRO_FECHA_VENCIMIENTO_ID = 'filtro-fecha-vencimiento';\n     8→const FILTRO_ESTADO_PLAN_ID = 'filtro-estado-plan';\n     9→\n    10→const normalizarFechaFiltro = fecha => {\n    11→    if (!fecha || typeof fecha !== 'string') return fecha;\n    12→    const limpio = fecha.trim();\n    13→    if (!limpio) return limpio;\n    14→    const separador = limpio.includes('/') ? '/' : (limpio.includes('-') ? '-' : null);\n    15→    if (!separador) return limpio;\n    16→    const partes = limpio.split(separador);\n    17→    if (partes.length < 3) return limpio;\n    18→    let dia = '';\n    19→    let mes = '';\n    20→    let anio = '';\n    21→    if (partes[0].length === 4) {\n    22→        anio = partes[0];\n    23→        mes = partes[1];\n    24→        dia = partes[2];\n    25→    } else if (partes[2].length === 4) {\n    26→        dia = partes[0];\n    27→        mes = partes[1];\n    28→        anio = partes[2];\n    29→    } else {\n    30→        return limpio;\n    31→    }\n    32→    return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;\n    33→};\n    34→\n    35→let compras_seleccionadas_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] };\n    36→\n    37→let compras_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] }\n    38→\n    39→let compras = [];\n    40→\n    41→// Variables globales para filtros de cada tabla\n    42→let filtros_seleccion = {};\n    43→let filtros_organizacional = {};\n    44→let filtros_vocacional = {};\n    45→let filtros_creditos = {};\n    46→\n    47→let filtro_html_seleccion = '';\n    48→let filtro_html_organizacional = '';\n    49→let filtro_html_vocacional = '';\n    50→let filtro_html_creditos = '';\n    51→let busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n    52→\n    53→$(document).ready(() => {\n    54→    $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));\n    55→    $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });\n    56→    $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });\n    57→    $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });\n    58→    $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });\n    59→    $(document).on('input', '#filtro_dropdown_seleccion', function () { busqueda_tablas.seleccion = this.value; aplicarBusquedaTabla('seleccion', this.value); });\n    60→    $(document).on('input', '#filtro_dropdown_organizacional', function () { busqueda_tablas.organizacional = this.value; aplicarBusquedaTabla('organizacional', this.value); });\n    61→    $(document).on('input', '#filtro_dropdown_vocacional', function () { busqueda_tablas.vocacional = this.value; aplicarBusquedaTabla('vocacional', this.value); });\n    62→    $(document).on('input', '#filtro_dropdown_creditos', function () { busqueda_tablas.creditos = this.value; aplicarBusquedaTabla('creditos', this.value); });\n    63→    $(document).on('keydown', '#filtro_dropdown_seleccion, #filtro_dropdown_organizacional, #filtro_dropdown_vocacional, #filtro_dropdown_creditos', function (event) {\n    64→        if (event.key === 'Enter') {\n    65→            event.preventDefault();\n    66→            event.stopPropagation();\n    67→        }\n    68→    });\n    69→\n    70→});\n    71→\n    72→/**\n    73→ * Renderiza la modal de historial de compras de planes de empresa.\n    74→ *\n    75→ * @param {number} empresa_id ID de la empresa.\n    76→ * @param {boolean} recarga verifica si tiene que recargar.\n    77→ * @param {string} tabla nombre de la tabla.\n    78→ * @param {string} filtro filtros para la busqueda.\n    79→ * @returns {void}\n    80→ * @author Andres Morales\n    81→ * @author Jair Carvajal\n    82→ */\n    83→async function modalHistorialCompras(id_empresa, recarga = false, tabla = '', filtro = {}) {\n    84→    let historial_compras = await getHistorialCompras(id_empresa, filtro);\n    85→\n    86→    if (tabla === '' || tabla === 'seleccion') {\n    87→        await renderizarTablas(historial_compras[1], 'seleccion');\n    88→        establecerEventoDescargarComprasExcel('seleccion');\n    89→    }\n    90→\n    91→    if (tabla === '' || tabla === 'organizacional') {\n    92→        await renderizarTablas(historial_compras[2], 'organizacional');\n    93→        establecerEventoDescargarComprasExcel('organizacional');\n    94→    }\n    95→\n    96→    if (tabla === '' || tabla === 'vocacional') {\n    97→        await renderizarTablas(historial_compras[3], 'vocacional');\n    98→        establecerEventoDescargarComprasExcel('vocacional');\n    99→    }\n   100→\n   101→    if (tabla === '' || tabla === 'creditos') {\n   102→        let historial_creditos = await getHistorialComprasCreditos(id_empresa, filtro);\n   103→        await renderizarTablaCreditos(historial_creditos, 'creditos');\n   104→        establecerEventoDescargarComprasExcel('creditos');\n   105→    }\n   106→\n   107→    if (!recarga) {\n   108→        $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n   109→    }\n   110→\n   111→    cargarDataTablas();\n   112→    inicializarTooltips();\n   113→}\n   114→\n   115→\n   116→/**\n   117→ * Obtener historial de recompras de planes de empresa.\n   118→ *\n   119→ * @param {number} empresa_id ID de la empresa.\n   120→ * @returns {array}\n   121→ * @author Daniel Beltrán\n   122→ * @author Andres Morales\n   123→ */\n   124→async function getHistorialCompras(empresa_id, filtros = {}) {\n   125→    let datos = [];\n   126→    let agrupadosPorTipoPrueba = {\n   127→        1: [],\n   128→        2: [],\n   129→        3: [],\n   130→    };\n   131→    await $.ajax({\n   132→        type: 'GET',\n   133→        url : `/planes-historial-recompras/${empresa_id}`,\n   134→        data: filtros\n   135→    }).then(respuesta => {\n   136→        datos = respuesta.data || [];\n   137→        datos.forEach(item => {\n   138→            let tipoPruebaNombre = item.plan.tipo_prueba.id;\n   139→            agrupadosPorTipoPrueba[tipoPruebaNombre].push(item);\n   140→        });\n   141→    }).catch((error) => {\n   142→        console.error(error);\n   143→    });\n   144→    return agrupadosPorTipoPrueba;\n   145→}\n   146→\n   147→/**\n   148→ * Obtener historial de compras de planes con creditos.\n   149→ *\n   150→ * @param {number} empresa_id ID de la empresa.\n   151→ * @param {Object} filtros Filtros aplicados.\n   152→ * @returns {array}\n   153→ * @author Sergio Vargas\n   154→ * @author Jair Carvajal\n   155→ */\n   156→async function getHistorialComprasCreditos(empresa_id, filtros = {}) {\n   157→    let datos = [];\n   158→\n   159→    await $.ajax({\n   160→        type: 'GET',\n   161→        url: `/planes-historial-recompras-creditos/${empresa_id}`,\n   162→        data: filtros\n   163→    }).then(respuesta => {\n   164→        datos = respuesta.data || [];\n   165→    }).catch((error) => {\n   166→        console.error(error);\n   167→    });\n   168→\n   169→    return datos;\n   170→}\n   171→\n   172→/**\n   173→ * Renderiza las distintas tablas de compras.\n   174→ *\n   175→ * @param {array} datos_entrada Array de datos a renderizar.\n   176→ * @param {string} nombre_tabla Nombre de la tabla.\n   177→ * @returns {void}\n   178→ * @author Andres Morales\n   179→ * @author Jair Carvajal\n   180→ */\n   181→async function renderizarTablas(datos_entrada, nombre_tabla) {\n   182→    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n   183→    compras_ids[nombre_tabla] = [];\n   184→    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n   185→    let totalUnidades = datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_agendas || 0), 0);\n   186→    let totalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_ofertas_laborales || 0), 0);\n   187→    let baseTotalUnidades =  datos_entrada.reduce((total, dato) => total + (dato.unidades || 0), 0);\n   188→    let baseTotalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.cantidad_ofertas_laborales || 0), 0);\n   189→    $(`#${nombre_tabla}-totales-unidades`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>${crearProgressBar({ label: `${totalUnidades}/${baseTotalUnidades}`,height: '8px', porcentaje: {porcentaje: (totalUnidades / (baseTotalUnidades ?? 1)) * 100, texto:false }})}`);\n   190→    $(`#${nombre_tabla}-totales-ofertas`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>${crearProgressBar({ label: `${totalOfertas}/${baseTotalOfertas}`,height: '8px', porcentaje: {porcentaje: (totalOfertas / (baseTotalOfertas ?? 1)) * 100, texto:false }})}`);\n   191→    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n   192→        ...configuracion_tablas,\n   193→        data: datos_entrada,\n   194→        columns: [\n   195→            {\n   196→                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n   197→                data: null,\n   198→                orderable: false,\n   199→                searchable: false,\n   200→                render: (dato) => `\n   201→                    ${crearCheckbox({\n   202→                        id: `${dato.id}`,\n   203→                        class: 'checkbox-compra',\n   204→                        name: 'checkbox',\n   205→                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n   206→                    })}\n   207→                `,\n   208→             },\n   209→            {\n   210→                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n   211→                data: null,\n   212→                className: 'nombre-plan-columna',\n   213→                orderable: false,\n   214→                render: (dato) => `\n   215→                    <div class=\"row\">\n   216→                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n   217→                            ${crearBoton({\n   218→                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n   219→                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n   220→                                data: [{ texto: 'id', value: dato.id }],\n   221→                            })}\n   222→                        </div>\n   223→                        <div class=\"col pe-0\">\n   224→                            <span class=\"text-body-3\">${dato.plan.nombre}</span>\n   225→                        </div>\n   226→                    </div>\n   227→                `,\n   228→            },\n   229→            {\n   230→                title: '<span class=\"text-body-3\">Vigencia</span>',\n   231→                data: null,\n   232→                className: 'vigencia-columna',\n   233→                orderable: false,\n   234→                render:  (dato) => `\n   235→                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n   236→                    ${dato.fecha_inicio ? `\n   237→                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n   238→                    `: ''}\n   239→                `,\n   240→            },\n   241→            {\n   242→                title: '<span class=\"text-body-3\">Duración</span>',\n   243→                data: null,\n   244→                orderable: false,\n   245→                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias} dias</span>`\n   246→            },\n   247→            {\n   248→                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-box\"></i> Consumo unidades</span>`,\n   249→                data: null,\n   250→                orderable: false,\n   251→                render: (dato) => `<div ${tooltipConsumoUnidades(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_agendas, dato.unidades ?? 0, false)}</div>`,\n   252→            },\n   253→            {\n   254→                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-briefcase\"></i> Consumo vacantes</span>`,\n   255→                data: null,\n   256→                orderable: false,\n   257→                render: (dato) => `<div ${tooltipConsumoOfertas(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_ofertas_laborales, dato.cantidad_ofertas_laborales ?? 0, false)}</div>`,\n   258→            },\n   259→            {\n   260→                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-person\"></i> Consumo usuarios</span>`,\n   261→                data: null,\n   262→                orderable: false,\n   263→                render: (dato) => `<div ${tooltipConsumoUsuarios(usuarios)}>${crearProgressBarTemplate('', false, total_usuarios, dato.cantidad_usuarios ?? 0, false)}</div>`,\n   264→            },\n   265→            {\n   266→                title: '<span class=\"text-body-3\">Ver factura</span>',\n   267→                data: null,\n   268→                orderable: false,\n   269→                searchable: false,\n   270→                render: (dato) => `\n   271→                    ${crearBoton({\n   272→                        clases: 'btn-text-primary btn-circle p-2',\n   273→                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n   274→                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n   275→                    })}\n   276→                `,\n   277→            },\n   278→            {\n   279→                title: '<span class=\"text-body-3\">Acciones</span>',\n   280→                data: null,\n   281→                orderable: false,\n   282→                searchable: false,\n   283→                render: (dato) => `\n   284→                    ${crearBoton({\n   285→                        clases: 'btn-text-primary btn-circle p-2',\n   286→                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n   287→                        onclick: `abrirModalConsumos(${dato.id}, '${dato.plan.nombre}', '${dato.plan.tipo_prueba.nombre}')`,\n   288→                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n   289→                    })}\n   290→                `,\n   291→            }\n   292→        ],\n   293→        drawCallback: function(settings) {\n   294→            inicializarTooltips();\n   295→        },\n   296→    });\n   297→    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n   298→}\n   299→\n   300→/**\n   301→ * Renderiza la tabla de compras de creditos.\n   302→ *\n   303→ * @param {array} datos_entrada Array de datos a renderizar.\n   304→ * @param {string} nombre_tabla Nombre de la tabla.\n   305→ * @returns {void}\n   306→ * @author Sergio Vargas\n   307→ */\n   308→async function renderizarTablaCreditos(datos_entrada, nombre_tabla) {\n   309→    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n   310→    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n   311→\n   312→    let total_consumidos = datos_entrada.reduce((total, dato) => total + (dato.creditos_consumidos || 0), 0);\n   313→    let total_creditos = datos_entrada.reduce((total, dato) => total + (dato.creditos_totales || 0), 0);\n   314→    let porcentaje_total = total_creditos > 0 ? (total_consumidos / total_creditos) * 100 : 0;\n   315→\n   316→    $('#creditos-totales')\n   317→        .empty()\n   318→        .append(`\n   319→            <p class=\"text-label-2 mb-1\"><img class=\"me-2\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\">Créditos totales</p>\n   320→            ${crearProgressBar({ label: `${formatearNumero(total_consumidos)}/${formatearNumero(total_creditos)}`, height: '8px', porcentaje: { porcentaje: porcentaje_total, texto: false }})}\n   321→        `);\n   322→\n   323→    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n   324→        ...configuracion_tablas,\n   325→        data: datos_entrada,\n   326→        columns: [\n   327→            {\n   328→                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n   329→                data: null,\n   330→                orderable: false,\n   331→                searchable: false,\n   332→                render: (dato) => `\n   333→                    ${crearCheckbox({\n   334→                        id: `${dato.id}`,\n   335→                        class: 'checkbox-compra',\n   336→                        name: 'checkbox',\n   337→                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n   338→                    })}\n   339→                `,\n   340→            },\n   341→            {\n   342→                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n   343→                data: null,\n   344→                className: 'nombre-plan-columna',\n   345→                orderable: false,\n   346→                render: (dato) => `\n   347→                    <div class=\"row\">\n   348→                        <div class=\"col pe-0\">\n   349→                            <span class=\"text-body-3\">${dato.plan_credito?.nombre ?? '---'}</span>\n   350→                        </div>\n   351→                    </div>\n   352→                `,\n   353→            },\n   354→            {\n   355→                title: '<span class=\"text-body-3\">Vigencia</span>',\n   356→                data: null,\n   357→                className: 'vigencia-columna',\n   358→                orderable: false,\n   359→                render:  (dato) => `\n   360→                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n   361→                    ${dato.fecha_inicio ? `\n   362→                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n   363→                    `: ''}\n   364→                `,\n   365→            },\n   366→            {\n   367→                title: '<span class=\"text-body-3\">Duración</span>',\n   368→                data: null,\n   369→                orderable: false,\n   370→                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias ? `${dato.vigencia_dias} dias` : 'Sin tiempo'}</span>`\n   371→            },\n   372→            {\n   373→                title: `<span class=\"text-body-3\"><img class=\"me-1\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\"> Consumo créditos</span>`,\n   374→                data: null,\n   375→                orderable: false,\n   376→                render: (dato) => {\n   377→                    let total = dato.creditos_totales ?? 0;\n   378→                    let consumidos = dato.creditos_consumidos ?? 0;\n   379→                    return `${crearProgressBarTemplate('', false, consumidos, total, false)}`;\n   380→                },\n   381→            },\n   382→            {\n   383→                title: '<span class=\"text-body-3\">Ver factura</span>',\n   384→                data: null,\n   385→                orderable: false,\n   386→                searchable: false,\n   387→                render: (dato) => `\n   388→                    ${crearBoton({\n   389→                        clases: 'btn-text-primary btn-circle p-2',\n   390→                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n   391→                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n   392→                    })}\n   393→                `,\n   394→            },\n   395→            {\n   396→                title: '<span class=\"text-body-3\">Acciones</span>',\n   397→                data: null,\n   398→                orderable: false,\n   399→                searchable: false,\n   400→                render: (dato) => `\n   401→                    ${crearBoton({\n   402→                        clases: 'btn-text-primary btn-circle p-2',\n   403→                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n   404→                        onclick: `abrirModalConsumosCreditos(${dato.empresa_id}, ${dato.id}, '${dato.plan_credito?.nombre ?? ''}')`,\n   405→                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n   406→                    })}\n   407→                `,\n   408→            }\n   409→        ],\n   410→        drawCallback: function(settings) {\n   411→            inicializarTooltips();\n   412→        },\n   413→    });\n   414→    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n   415→}\n   416→\n   417→function aplicarBusquedaTabla(nombre_tabla, valor) {\n   418→    const selector = `#tabla-compras-${nombre_tabla}`;\n   419→    if (!$.fn.DataTable.isDataTable(selector)) return;\n   420→    $(selector).DataTable().search(valor || '').draw();\n   421→}\n   422→\n   423→/**\n   424→ * Renderiza el contenido de las subtablas.\n   425→ *\n   426→ * @param {array} data Array de datos a renderizar.\n   427→ * @returns {string} HTML de la subtabla.\n   428→ * @author Andres Morales\n   429→ */\n   430→function crearContenidoSubTabla(data) {\n   431→    let pruebas_html = \"\";\n   432→    data.pruebas.forEach(prueba => {\n   433→        pruebas_html += `\n   434→            <div class=\"col-12 my-2 col-md-6 d-flex justify-content-start align-items-center gap-3\">\n   435→                <img src=\"/imagenes/logos/pruebas/${slugify(prueba.nombre)}.png\" width=\"32px\" height=\"32px\" class=\"object-fit-cover\" alt=\"Logo prueba\">\n   436→                <p class=\"mb-0 text-label-2\">${prueba.nombre}</p>\n   437→            </div>\n   438→        `;\n   439→    });\n   440→\n   441→    let funcionalidades_predeterminadas_html = \"\";\n   442→    data.funcionalidades.forEach(funcionalidad => {\n   443→        if (funcionalidad.predeterminado) funcionalidades_predeterminadas_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n   444→    });\n   445→\n   446→    let funcionalidades_html = \"\";\n   447→    data.funcionalidades.forEach(funcionalidad => {\n   448→        if (!funcionalidad.predeterminado) funcionalidades_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n   449→    });\n   450→\n   451→    return `\n   452→        <div class=\"row w-100 my-3 ps-8\">\n   453→            <div class=\"col-4\">\n   454→                <p class=\"text-body-3 fw-bolder\">Pruebas</p>\n   455→                <div class=\"row\">\n   456→                    ${pruebas_html}\n   457→                </div>\n   458→            </div>\n   459→            <div class=\"col-8\">\n   460→                <div class=\"container-fluid\">\n   461→                    <div class=\"row border-bottom pb-2\">\n   462→                        <div class=\"col-4\">\n   463→                            <p class=\"mb-0\"><span class=\"fw-bolder\">Costo:</span> <br> $ ${formatearNumero(data.precio)}</p>\n   464→                        </div>\n   465→                        <div class=\"col-4\">\n   466→                            <p class=\"mb-0\"><span class=\"fw-bolder\">Descuento:</span> <br> ${data.porcentaje_descuento !== 0 ? data.porcentaje_descuento + '%' : `Sin descuento`}</p>\n   467→                        </div>\n   468→                         <div class=\"col-4\">\n   469→                            <p class=\"mb-0\"><span class=\"fw-bolder\">Valor de venta:</span> <br> $ ${data.porcentaje_descuento !== 0 ? formatearNumero(data.precio * (1 - (data.porcentaje_descuento / 100))) : formatearNumero(data.precio) }</p>\n   470→                        </div>\n   471→                    </div>\n   472→                    <div class=\"row\">\n   473→                        <div class=\"col-6 text-label-1 border-bottom\">\n   474→                            <p class=\"my-3\">Beneficios adicionales</p>\n   475→                        </div>\n   476→                        <div class=\"col-6 text-label-1 border-bottom\">\n   477→                            <p class=\"my-3\">Beneficios predefinidos</p>\n   478→                        </div>\n   479→                        <div class=\"col-6 text-label-1\">\n   480→                            <p>${funcionalidades_html}</p>\n   481→                        </div>\n   482→                        <div class=\"col-6 text-label-1\">\n   483→                            <p>${funcionalidades_predeterminadas_html}</p>\n   484→                        </div>\n   485→                    </div>\n   486→                </div>\n   487→            </div>\n   488→        </div>\n   489→    `;\n   490→}\n   491→\n   492→/**\n   493→ * Generar el tooltip de consumo de unidades.\n   494→ *\n   495→ * @param {array} consumos Array de datos.\n   496→ * @returns {string} componente tooltip.\n   497→ * @author Andres Morales\n   498→ */\n   499→function tooltipConsumoUnidades(consumos) {\n   500→    var agrupado = consumos.reduce((acc, item) => {\n   501→        if(item.agenda && item.agenda.prueba) {\n   502→          var { id, nombre } = item.agenda.prueba;\n   503→          var key = `${id}-${nombre}`;\n   504→          if(!acc[key]) {\n   505→            acc[key] = { prueba_id: id, prueba_nombre: nombre, cantidad: 0 };\n   506→          }\n   507→          acc[key].cantidad++;\n   508→        }\n   509→        return acc;\n   510→    }, {});\n   511→\n   512→    var resultado = Object.values(agrupado);\n   513→    let tooltip = '';\n   514→    if (resultado.length > 0) {\n   515→        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n   516→        tooltip = `\n   517→        <div class='row text-white'>\n   518→            <div class='col-12 d-flex justify-content-between mb-3'>\n   519→                <span class='text-body-3 text-white'>Cantidad consumida</span>\n   520→                <span class='text-body-3 text-white'>${total}</span>\n   521→            </div>\n   522→            ${resultado.map(item => `\n   523→                <div class='col-12 d-flex justify-content-between mb-3'>\n   524→                    <span class='text-body-3 text-white'>\n   525→                        <img src='/imagenes/logos/pruebas/${slugify(item.prueba_nombre)}.png' width='22px' height='22px' class='object-fit-cover me-2' alt='>\n   526→                    </span>\n   527→                    <span class='text-body-3 text-white'>\n   528→                        ${item.prueba_nombre}\n   529→                    </span>\n   530→                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n   531→                </div>\n   532→            `).join('')}\n   533→        </div>\n   534→    `;\n   535→    } else {\n   536→        tooltip = `\n   537→            <div class='row text-white'>\n   538→                <div class='col-12 d-flex justify-content-between'>\n   539→                    <span class='text-body-3 text-white me-3'>Cantidad consumida</span>\n   540→                    <span class='text-body-3 text-white'>0</span>\n   541→                </div>\n   542→            </div>\n   543→        `;\n   544→    }\n   545→\n   546→    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n   547→}\n   548→\n   549→/**\n   550→ * Generar el tooltip de consumo de ofertas.\n   551→ *\n   552→ * @param {array} consumos Array de datos.\n   553→ * @returns {string} componente tooltip.\n   554→ * @author Andres Morales\n   555→ */\n   556→function tooltipConsumoOfertas(consumos) {\n   557→    const resultado = Object.values(\n   558→        consumos.filter(item => item.oferta_laboral_id !== null).reduce((acc, item) => {\n   559→            const key = `${item.empresa.id}-${item.empresa.nombre_comercial}`;\n   560→            if (!acc[key]) {\n   561→              acc[key] = {\n   562→                empresa_id: item.empresa.id,\n   563→                empresa_nombre_comercial: item.empresa.nombre_comercial,\n   564→                cantidad: 0\n   565→              };\n   566→            }\n   567→            acc[key].cantidad++;\n   568→            return acc;\n   569→        }, {})\n   570→    );\n   571→    let tooltip = '';\n   572→    if (resultado.length > 0) {\n   573→        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n   574→        tooltip = `\n   575→        <div class='row text-white'>\n   576→            <div class='col-12 d-flex justify-content-between mb-3'>\n   577→                <span class='text-body-3 text-white text-start'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n   578→                <span class='text-body-3 text-white'>${total}</span>\n   579→            </div>\n   580→            ${resultado.map(item => `\n   581→                <div class='col-12 d-flex justify-content-between mb-3'>\n   582→                    <span class='text-body-3 text-white text-start'>\n   583→                        ${item.empresa_nombre_comercial}\n   584→                    </span>\n   585→                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n   586→                </div>\n   587→            `).join('')}\n   588→        </div>\n   589→    `;\n   590→    } else {\n   591→        tooltip = `\n   592→            <div class='row text-white'>\n   593→                <div class='col-12 d-flex justify-content-between'>\n   594→                    <span class='text-body-3 text-white text-start me-3'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n   595→                    <span class='text-body-3 text-white'>0</span>\n   596→                </div>\n   597→            </div>\n   598→        `;\n   599→    }\n   600→\n   601→    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n   602→}\n   603→\n   604→/**\n   605→ * Generar el tooltip de consumo de usuarios.\n   606→ *\n   607→ * @param {array} usuarios Array de datos.\n   608→ * @returns {string} componente tooltip.\n   609→ * @author Andres Morales\n   610→ */\n   611→function tooltipConsumoUsuarios(usuarios) {\n   612→    const agrupado = usuarios.reduce((acc, usuario) => {\n   613→        if (Array.isArray(usuario.empresas_usuarios)) {\n   614→          // Recorremos las empresas del usuario y contamos sólo la primera que no tenga id 1\n   615→          for (let i = 0; i < usuario.empresas_usuarios.length; i++) {\n   616→            const { id, nombre_comercial } = usuario.empresas_usuarios[i].empresa;\n   617→            if (id === 1) continue; // omitir la empresa con id 1\n   618→            const key = `${id}-${nombre_comercial}`;\n   619→            if (!acc[key]) {\n   620→              acc[key] = {\n   621→                empresa_id: id,\n   622→                nombre_comercial,\n   623→                cantidad: 0\n   624→              };\n   625→            }\n   626→            acc[key].cantidad++;\n   627→            // Una vez que se cuenta el usuario para una empresa, salimos del ciclo\n   628→            break;\n   629→          }\n   630→        }\n   631→        return acc;\n   632→      }, {});\n   633→\n   634→      const resultado = Object.values(agrupado);\n   635→\n   636→    let tooltip = '';\n   637→    if (resultado.length > 0) {\n   638→        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n   639→        tooltip = `\n   640→        <div class='row text-white'>\n   641→            <div class='col-12 d-flex justify-content-between mb-3'>\n   642→                <span class='text-body-3 text-white text-start'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n   643→                <span class='text-body-3 text-white'>${total}</span>\n   644→            </div>\n   645→            ${resultado.map(item => `\n   646→                <div class='col-12 d-flex justify-content-between mb-3'>\n   647→                    <span class='text-body-3 text-white text-start'>\n   648→                        ${item.nombre_comercial}\n   649→                    </span>\n   650→                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n   651→                </div>\n   652→            `).join('')}\n   653→        </div>\n   654→    `;\n   655→    } else {\n   656→        tooltip = `\n   657→            <div class='row text-white'>\n   658→                <div class='col-12 d-flex justify-content-between'>\n   659→                    <span class='text-body-3 text-white text-start me-3'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n   660→                    <span class='text-body-3 text-white'>0</span>\n   661→                </div>\n   662→            </div>\n   663→        `;\n   664→    }\n   665→\n   666→    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n   667→}\n   668→\n   669→/**\n   670→ * Aplicar los filtros a las compras.\n   671→ *\n   672→ * @returns {void}\n   673→ * @author Fahibram Cárcamo\n   674→ */\n   675→function aplicarFiltrosAvanzadosCompras() {\n   676→    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('hide');\n   677→    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n   678→}\n   679→\n   680→/**\n   681→ * Abrir el modal de filtros de compras.\n   682→ *\n   683→ * @returns {void}\n   684→ * @author Fahibram Cárcamo\n   685→ */\n   686→function abrirModalFiltrosAvanzadosCompras() {\n   687→    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('hide');\n   688→    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('show');\n   689→}\n   690→\n   691→/**\n   692→ * Seleccionar una compra.\n   693→ *\n   694→ * @param {boolean} seleccion Selección.\n   695→ * @param {number} compra_id Id de la compra seleccionada.\n   696→ * @param {string} tabla_compras_id Id del elemento html de la tabla de compras.\n   697→ * @param {string} nombre_tabla Nombre de la tabla.\n   698→ * @returns {void}\n   699→ * @author Fahibram Cárcamo\n   700→ */\n   701→function seleccionarCompra(seleccion, compra_id, tabla_compras_id, nombre_tabla) {\n   702→    if (seleccion) {\n   703→        compras_seleccionadas_ids[nombre_tabla].push(parseInt(compra_id));\n   704→    } else {\n   705→        let indice = compras_seleccionadas_ids[nombre_tabla].indexOf(compra_id);\n   706→        if (indice !== -1) compras_seleccionadas_ids[nombre_tabla].splice(indice, 1);\n   707→    }\n   708→\n   709→    let checkbox_seleccionar_todos = $(`#checkbox-seleccionar-todos-${tabla_compras_id}`);\n   710→    if (compras_seleccionadas_ids[nombre_tabla].length === compras_ids[nombre_tabla].length) {\n   711→        checkbox_seleccionar_todos.prop('indeterminate', false);\n   712→        checkbox_seleccionar_todos.prop('checked', true);\n   713→    } else if (compras_seleccionadas_ids[nombre_tabla].length === 0) {\n   714→        checkbox_seleccionar_todos.prop('indeterminate', false);\n   715→        checkbox_seleccionar_todos.prop('checked', false);\n   716→    } else {\n   717→        checkbox_seleccionar_todos.prop('indeterminate', true);\n   718→    }\n   719→}\n   720→\n   721→/**\n   722→ * Seleccionar todas las compras.\n   723→ *\n   724→ * @param {boolean} seleccion Selección\n   725→ * @param {string} nombre_tabla Nombre de la tabla\n   726→ * @returns {void}\n   727→ * @author Fahibram Cárcamo\n   728→ * @author Andres Morales\n   729→ */\n   730→function seleccionarTodasCompras(seleccion, nombre_tabla) {\n   731→    if (!seleccion) compras_seleccionadas_ids[nombre_tabla] = [];\n   732→    let checkboxes_compras = $(`#tabla-compras-${nombre_tabla}`).find(\".checkbox-compra\").toArray();\n   733→    checkboxes_compras.forEach(checkbox => {\n   734→        checkbox.checked = seleccion;\n   735→        if (seleccion && !compras_seleccionadas_ids[nombre_tabla].includes(checkbox.id)) {\n   736→            compras_seleccionadas_ids[nombre_tabla].push(parseInt(checkbox.id));\n   737→        }\n   738→    });\n   739→}\n   740→\n   741→/**\n   742→ * Establecer el evento para el botón de descarga del archivo Excel.\n   743→ *\n   744→ * @param {string} nombre_tabla Nombre de la tabla\n   745→ * @returns {void}\n   746→ * @author Fahibram Cárcamo\n   747→ */\n   748→function establecerEventoDescargarComprasExcel(nombre_tabla) {\n   749→    $(`#boton-descargar-historial-compras-${nombre_tabla}`).off('click');\n   750→    $(`#boton-descargar-historial-compras-${nombre_tabla}`).on('click', () => {\n   751→        if (nombre_tabla === 'creditos') {\n   752→            descargarExcelCreditos();\n   753→            return;\n   754→        }\n   755→        let empresas_planes_ids = compras_seleccionadas_ids[nombre_tabla].length ? [...compras_seleccionadas_ids[nombre_tabla]] : [...compras_ids[nombre_tabla]];\n   756→        descargarExcel(\n   757→            'planes-historial-recompras-exportar',\n   758→            `compras_${nombre_tabla}`,\n   759→            true,\n   760→            empresas_planes_ids.length ? { empresas_planes_ids, empresa_id } : { empresa_id }\n   761→        );\n   762→    });\n   763→}\n   764→\n   765→/**\n   766→ * Descargar Excel del historial de créditos de IA.\n   767→ *\n   768→ * @returns {void}\n   769→ * @author Jair Carvajal\n   770→ */\n   771→function descargarExcelCreditos() {\n   772→    descargarExcel(\n   773→        `planes-historial-creditos-exportar/${empresa_id}`,\n   774→        'historial_creditos_ia',\n   775→        true,\n   776→        {}\n   777→    );\n   778→}\n   779→\n   780→/**\n   781→ * Procesar los filtros de las tablas de compras.\n   782→ *\n   783→ * @param {Object} json_filtros Filtros aplicados del dropdown\n   784→ * @param {string} tabla Nombre de la tabla\n   785→ * @returns {Object} Datos procesados para enviar al backend\n   786→ * @author Andres Morales\n   787→ */\n   788→function procesarFiltrosTabla(json_filtros, tabla) {\n   789→    let datos = {};\n   790→\n   791→    if (json_filtros[`estado_plan_filtro_${tabla}`]) {\n   792→        datos.estado_id = json_filtros[`estado_plan_filtro_${tabla}`];\n   793→    }\n   794→\n   795→    if (json_filtros[`duracion_filtro_${tabla}`]) {\n   796→        datos.duracion = json_filtros[`duracion_filtro_${tabla}`];\n   797→    }\n   798→\n   799→    if (tabla === 'creditos') {\n   800→        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n   801→            const partesFechaCompra = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n   802→            if (partesFechaCompra[0]) {\n   803→                datos.created_at_desde = normalizarFechaFiltro(partesFechaCompra[0]);\n   804→            }\n   805→            if (partesFechaCompra[1]) {\n   806→                datos.created_at_hasta = normalizarFechaFiltro(partesFechaCompra[1]);\n   807→            }\n   808→        }\n   809→    } else {\n   810→        if (json_filtros[`fecha_vencimiento_filtro_${tabla}`] && typeof json_filtros[`fecha_vencimiento_filtro_${tabla}`] === 'string') {\n   811→            const partesFechaVencimiento = json_filtros[`fecha_vencimiento_filtro_${tabla}`].split(' a ');\n   812→            if (partesFechaVencimiento[0]) {\n   813→                datos.fecha_vencimiento_desde = normalizarFechaFiltro(partesFechaVencimiento[0]);\n   814→            }\n   815→            if (partesFechaVencimiento[1]) {\n   816→                datos.fecha_vencimiento_hasta = normalizarFechaFiltro(partesFechaVencimiento[1]);\n   817→            }\n   818→        }\n   819→\n   820→        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n   821→            const partesFechaActivacion = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n   822→            if (partesFechaActivacion[0]) {\n   823→                datos.fecha_inicio_desde = normalizarFechaFiltro(partesFechaActivacion[0]);\n   824→            }\n   825→            if (partesFechaActivacion[1]) {\n   826→                datos.fecha_inicio_hasta = normalizarFechaFiltro(partesFechaActivacion[1]);\n   827→            }\n   828→        }\n   829→    }\n   830→\n   831→    return datos;\n   832→}\n   833→\n   834→/**\n   835→ * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n   836→ *\n   837→ * @param {string} filtro ID del elemento html del filtro\n   838→ * @param {Object} filtros Filtros aplicados\n   839→ * @returns {void}\n   840→ * @author Andres Morales\n   841→ */\n   842→function aplicarFiltrosDropdownRecompras(filtro, filtros) {\n   843→    let filtros_generados = {};\n   844→\n   845→    if (filtro === 'filtro_unidades_pruebas') {\n   846→        filtro_html = filtro;\n   847→        json_filtros = filtros;\n   848→        actualizarDatatables('tabla-consumos-unidades-pruebas');\n   849→    } else if (filtro === 'filtro_dropdown_seleccion') {\n   850→        filtro_html_seleccion = filtro;\n   851→        filtros_seleccion = filtros;\n   852→        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n   853→        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n   854→    } else if (filtro === 'filtro_dropdown_organizacional') {\n   855→        filtro_html_organizacional = filtro;\n   856→        filtros_organizacional = filtros;\n   857→        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n   858→        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n   859→    } else if (filtro === 'filtro_dropdown_vocacional') {\n   860→        filtro_html_vocacional = filtro;\n   861→        filtros_vocacional = filtros;\n   862→        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n   863→        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n   864→    } else if (filtro === 'filtro_dropdown_creditos') {\n   865→        filtro_html_creditos = filtro;\n   866→        filtros_creditos = filtros;\n   867→        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n   868→        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n   869→    }\n   870→}\n   871→\n   872→window.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\n   873→window.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n   874→\n   875→if (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n   876→    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n   877→        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n   878→    };\n   879→    window.aplicarFiltrosDropdown.__esDispatcher = true;\n   880→}\n   881→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6711198f-e1d6-4195-9e85-d209151c36d4","timestamp":"2026-01-29T20:32:54.885Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","content":"\nconst MODAL_FILTROS_AVANZADOS_COMPRAS_ID = 'modal-filtros-avanzados-compras';\nconst MODAL_HISTORIAL_COMPRAS_ID = 'modal-historial-recompras';\n\nconst FILTRO_DURACION_ID = 'filtro-duracion';\nconst FILTRO_FECHA_ACTIVACION_ID = 'filtro-fecha-activacion';\nconst FILTRO_FECHA_VENCIMIENTO_ID = 'filtro-fecha-vencimiento';\nconst FILTRO_ESTADO_PLAN_ID = 'filtro-estado-plan';\n\nconst normalizarFechaFiltro = fecha => {\n    if (!fecha || typeof fecha !== 'string') return fecha;\n    const limpio = fecha.trim();\n    if (!limpio) return limpio;\n    const separador = limpio.includes('/') ? '/' : (limpio.includes('-') ? '-' : null);\n    if (!separador) return limpio;\n    const partes = limpio.split(separador);\n    if (partes.length < 3) return limpio;\n    let dia = '';\n    let mes = '';\n    let anio = '';\n    if (partes[0].length === 4) {\n        anio = partes[0];\n        mes = partes[1];\n        dia = partes[2];\n    } else if (partes[2].length === 4) {\n        dia = partes[0];\n        mes = partes[1];\n        anio = partes[2];\n    } else {\n        return limpio;\n    }\n    return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;\n};\n\nlet compras_seleccionadas_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] };\n\nlet compras_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] }\n\nlet compras = [];\n\n// Variables globales para filtros de cada tabla\nlet filtros_seleccion = {};\nlet filtros_organizacional = {};\nlet filtros_vocacional = {};\nlet filtros_creditos = {};\n\nlet filtro_html_seleccion = '';\nlet filtro_html_organizacional = '';\nlet filtro_html_vocacional = '';\nlet filtro_html_creditos = '';\nlet busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n\n$(document).ready(() => {\n    $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));\n    $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });\n    $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });\n    $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });\n    $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });\n    $(document).on('input', '#filtro_dropdown_seleccion', function () { busqueda_tablas.seleccion = this.value; aplicarBusquedaTabla('seleccion', this.value); });\n    $(document).on('input', '#filtro_dropdown_organizacional', function () { busqueda_tablas.organizacional = this.value; aplicarBusquedaTabla('organizacional', this.value); });\n    $(document).on('input', '#filtro_dropdown_vocacional', function () { busqueda_tablas.vocacional = this.value; aplicarBusquedaTabla('vocacional', this.value); });\n    $(document).on('input', '#filtro_dropdown_creditos', function () { busqueda_tablas.creditos = this.value; aplicarBusquedaTabla('creditos', this.value); });\n    $(document).on('keydown', '#filtro_dropdown_seleccion, #filtro_dropdown_organizacional, #filtro_dropdown_vocacional, #filtro_dropdown_creditos', function (event) {\n        if (event.key === 'Enter') {\n            event.preventDefault();\n            event.stopPropagation();\n        }\n    });\n\n});\n\n/**\n * Renderiza la modal de historial de compras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {boolean} recarga verifica si tiene que recargar.\n * @param {string} tabla nombre de la tabla.\n * @param {string} filtro filtros para la busqueda.\n * @returns {void}\n * @author Andres Morales\n * @author Jair Carvajal\n */\nasync function modalHistorialCompras(id_empresa, recarga = false, tabla = '', filtro = {}) {\n    let historial_compras = await getHistorialCompras(id_empresa, filtro);\n\n    if (tabla === '' || tabla === 'seleccion') {\n        await renderizarTablas(historial_compras[1], 'seleccion');\n        establecerEventoDescargarComprasExcel('seleccion');\n    }\n\n    if (tabla === '' || tabla === 'organizacional') {\n        await renderizarTablas(historial_compras[2], 'organizacional');\n        establecerEventoDescargarComprasExcel('organizacional');\n    }\n\n    if (tabla === '' || tabla === 'vocacional') {\n        await renderizarTablas(historial_compras[3], 'vocacional');\n        establecerEventoDescargarComprasExcel('vocacional');\n    }\n\n    if (tabla === '' || tabla === 'creditos') {\n        let historial_creditos = await getHistorialComprasCreditos(id_empresa, filtro);\n        await renderizarTablaCreditos(historial_creditos, 'creditos');\n        establecerEventoDescargarComprasExcel('creditos');\n    }\n\n    if (!recarga) {\n        $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n    }\n\n    cargarDataTablas();\n    inicializarTooltips();\n}\n\n\n/**\n * Obtener historial de recompras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @returns {array}\n * @author Daniel Beltrán\n * @author Andres Morales\n */\nasync function getHistorialCompras(empresa_id, filtros = {}) {\n    let datos = [];\n    let agrupadosPorTipoPrueba = {\n        1: [],\n        2: [],\n        3: [],\n    };\n    await $.ajax({\n        type: 'GET',\n        url : `/planes-historial-recompras/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n        datos.forEach(item => {\n            let tipoPruebaNombre = item.plan.tipo_prueba.id;\n            agrupadosPorTipoPrueba[tipoPruebaNombre].push(item);\n        });\n    }).catch((error) => {\n        console.error(error);\n    });\n    return agrupadosPorTipoPrueba;\n}\n\n/**\n * Obtener historial de compras de planes con creditos.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {Object} filtros Filtros aplicados.\n * @returns {array}\n * @author Sergio Vargas\n * @author Jair Carvajal\n */\nasync function getHistorialComprasCreditos(empresa_id, filtros = {}) {\n    let datos = [];\n\n    await $.ajax({\n        type: 'GET',\n        url: `/planes-historial-recompras-creditos/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Renderiza las distintas tablas de compras.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Andres Morales\n * @author Jair Carvajal\n */\nasync function renderizarTablas(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = [];\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n    let totalUnidades = datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_agendas || 0), 0);\n    let totalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_ofertas_laborales || 0), 0);\n    let baseTotalUnidades =  datos_entrada.reduce((total, dato) => total + (dato.unidades || 0), 0);\n    let baseTotalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.cantidad_ofertas_laborales || 0), 0);\n    $(`#${nombre_tabla}-totales-unidades`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>${crearProgressBar({ label: `${totalUnidades}/${baseTotalUnidades}`,height: '8px', porcentaje: {porcentaje: (totalUnidades / (baseTotalUnidades ?? 1)) * 100, texto:false }})}`);\n    $(`#${nombre_tabla}-totales-ofertas`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>${crearProgressBar({ label: `${totalOfertas}/${baseTotalOfertas}`,height: '8px', porcentaje: {porcentaje: (totalOfertas / (baseTotalOfertas ?? 1)) * 100, texto:false }})}`);\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n             },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n                                data: [{ texto: 'id', value: dato.id }],\n                            })}\n                        </div>\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan.nombre}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias} dias</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-box\"></i> Consumo unidades</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUnidades(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_agendas, dato.unidades ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-briefcase\"></i> Consumo vacantes</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoOfertas(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_ofertas_laborales, dato.cantidad_ofertas_laborales ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-person\"></i> Consumo usuarios</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUsuarios(usuarios)}>${crearProgressBarTemplate('', false, total_usuarios, dato.cantidad_usuarios ?? 0, false)}</div>`,\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumos(${dato.id}, '${dato.plan.nombre}', '${dato.plan.tipo_prueba.nombre}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n}\n\n/**\n * Renderiza la tabla de compras de creditos.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Sergio Vargas\n */\nasync function renderizarTablaCreditos(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n\n    let total_consumidos = datos_entrada.reduce((total, dato) => total + (dato.creditos_consumidos || 0), 0);\n    let total_creditos = datos_entrada.reduce((total, dato) => total + (dato.creditos_totales || 0), 0);\n    let porcentaje_total = total_creditos > 0 ? (total_consumidos / total_creditos) * 100 : 0;\n\n    $('#creditos-totales')\n        .empty()\n        .append(`\n            <p class=\"text-label-2 mb-1\"><img class=\"me-2\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\">Créditos totales</p>\n            ${crearProgressBar({ label: `${formatearNumero(total_consumidos)}/${formatearNumero(total_creditos)}`, height: '8px', porcentaje: { porcentaje: porcentaje_total, texto: false }})}\n        `);\n\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan_credito?.nombre ?? '---'}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias ? `${dato.vigencia_dias} dias` : 'Sin tiempo'}</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><img class=\"me-1\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\"> Consumo créditos</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => {\n                    let total = dato.creditos_totales ?? 0;\n                    let consumidos = dato.creditos_consumidos ?? 0;\n                    return `${crearProgressBarTemplate('', false, consumidos, total, false)}`;\n                },\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumosCreditos(${dato.empresa_id}, ${dato.id}, '${dato.plan_credito?.nombre ?? ''}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n}\n\nfunction aplicarBusquedaTabla(nombre_tabla, valor) {\n    const selector = `#tabla-compras-${nombre_tabla}`;\n    if (!$.fn.DataTable.isDataTable(selector)) return;\n    $(selector).DataTable().search(valor || '').draw();\n}\n\n/**\n * Renderiza el contenido de las subtablas.\n *\n * @param {array} data Array de datos a renderizar.\n * @returns {string} HTML de la subtabla.\n * @author Andres Morales\n */\nfunction crearContenidoSubTabla(data) {\n    let pruebas_html = \"\";\n    data.pruebas.forEach(prueba => {\n        pruebas_html += `\n            <div class=\"col-12 my-2 col-md-6 d-flex justify-content-start align-items-center gap-3\">\n                <img src=\"/imagenes/logos/pruebas/${slugify(prueba.nombre)}.png\" width=\"32px\" height=\"32px\" class=\"object-fit-cover\" alt=\"Logo prueba\">\n                <p class=\"mb-0 text-label-2\">${prueba.nombre}</p>\n            </div>\n        `;\n    });\n\n    let funcionalidades_predeterminadas_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (funcionalidad.predeterminado) funcionalidades_predeterminadas_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    let funcionalidades_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (!funcionalidad.predeterminado) funcionalidades_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    return `\n        <div class=\"row w-100 my-3 ps-8\">\n            <div class=\"col-4\">\n                <p class=\"text-body-3 fw-bolder\">Pruebas</p>\n                <div class=\"row\">\n                    ${pruebas_html}\n                </div>\n            </div>\n            <div class=\"col-8\">\n                <div class=\"container-fluid\">\n                    <div class=\"row border-bottom pb-2\">\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Costo:</span> <br> $ ${formatearNumero(data.precio)}</p>\n                        </div>\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Descuento:</span> <br> ${data.porcentaje_descuento !== 0 ? data.porcentaje_descuento + '%' : `Sin descuento`}</p>\n                        </div>\n                         <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Valor de venta:</span> <br> $ ${data.porcentaje_descuento !== 0 ? formatearNumero(data.precio * (1 - (data.porcentaje_descuento / 100))) : formatearNumero(data.precio) }</p>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios adicionales</p>\n                        </div>\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios predefinidos</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_html}</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_predeterminadas_html}</p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Generar el tooltip de consumo de unidades.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUnidades(consumos) {\n    var agrupado = consumos.reduce((acc, item) => {\n        if(item.agenda && item.agenda.prueba) {\n          var { id, nombre } = item.agenda.prueba;\n          var key = `${id}-${nombre}`;\n          if(!acc[key]) {\n            acc[key] = { prueba_id: id, prueba_nombre: nombre, cantidad: 0 };\n          }\n          acc[key].cantidad++;\n        }\n        return acc;\n    }, {});\n\n    var resultado = Object.values(agrupado);\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white'>Cantidad consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white'>\n                        <img src='/imagenes/logos/pruebas/${slugify(item.prueba_nombre)}.png' width='22px' height='22px' class='object-fit-cover me-2' alt='>\n                    </span>\n                    <span class='text-body-3 text-white'>\n                        ${item.prueba_nombre}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white me-3'>Cantidad consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de ofertas.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoOfertas(consumos) {\n    const resultado = Object.values(\n        consumos.filter(item => item.oferta_laboral_id !== null).reduce((acc, item) => {\n            const key = `${item.empresa.id}-${item.empresa.nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: item.empresa.id,\n                empresa_nombre_comercial: item.empresa.nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            return acc;\n        }, {})\n    );\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.empresa_nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de usuarios.\n *\n * @param {array} usuarios Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUsuarios(usuarios) {\n    const agrupado = usuarios.reduce((acc, usuario) => {\n        if (Array.isArray(usuario.empresas_usuarios)) {\n          // Recorremos las empresas del usuario y contamos sólo la primera que no tenga id 1\n          for (let i = 0; i < usuario.empresas_usuarios.length; i++) {\n            const { id, nombre_comercial } = usuario.empresas_usuarios[i].empresa;\n            if (id === 1) continue; // omitir la empresa con id 1\n            const key = `${id}-${nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: id,\n                nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            // Una vez que se cuenta el usuario para una empresa, salimos del ciclo\n            break;\n          }\n        }\n        return acc;\n      }, {});\n\n      const resultado = Object.values(agrupado);\n\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Aplicar los filtros a las compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction aplicarFiltrosAvanzadosCompras() {\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Abrir el modal de filtros de compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalFiltrosAvanzadosCompras() {\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Seleccionar una compra.\n *\n * @param {boolean} seleccion Selección.\n * @param {number} compra_id Id de la compra seleccionada.\n * @param {string} tabla_compras_id Id del elemento html de la tabla de compras.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction seleccionarCompra(seleccion, compra_id, tabla_compras_id, nombre_tabla) {\n    if (seleccion) {\n        compras_seleccionadas_ids[nombre_tabla].push(parseInt(compra_id));\n    } else {\n        let indice = compras_seleccionadas_ids[nombre_tabla].indexOf(compra_id);\n        if (indice !== -1) compras_seleccionadas_ids[nombre_tabla].splice(indice, 1);\n    }\n\n    let checkbox_seleccionar_todos = $(`#checkbox-seleccionar-todos-${tabla_compras_id}`);\n    if (compras_seleccionadas_ids[nombre_tabla].length === compras_ids[nombre_tabla].length) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', true);\n    } else if (compras_seleccionadas_ids[nombre_tabla].length === 0) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', false);\n    } else {\n        checkbox_seleccionar_todos.prop('indeterminate', true);\n    }\n}\n\n/**\n * Seleccionar todas las compras.\n *\n * @param {boolean} seleccion Selección\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nfunction seleccionarTodasCompras(seleccion, nombre_tabla) {\n    if (!seleccion) compras_seleccionadas_ids[nombre_tabla] = [];\n    let checkboxes_compras = $(`#tabla-compras-${nombre_tabla}`).find(\".checkbox-compra\").toArray();\n    checkboxes_compras.forEach(checkbox => {\n        checkbox.checked = seleccion;\n        if (seleccion && !compras_seleccionadas_ids[nombre_tabla].includes(checkbox.id)) {\n            compras_seleccionadas_ids[nombre_tabla].push(parseInt(checkbox.id));\n        }\n    });\n}\n\n/**\n * Establecer el evento para el botón de descarga del archivo Excel.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction establecerEventoDescargarComprasExcel(nombre_tabla) {\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).off('click');\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).on('click', () => {\n        if (nombre_tabla === 'creditos') {\n            descargarExcelCreditos();\n            return;\n        }\n        let empresas_planes_ids = compras_seleccionadas_ids[nombre_tabla].length ? [...compras_seleccionadas_ids[nombre_tabla]] : [...compras_ids[nombre_tabla]];\n        descargarExcel(\n            'planes-historial-recompras-exportar',\n            `compras_${nombre_tabla}`,\n            true,\n            empresas_planes_ids.length ? { empresas_planes_ids, empresa_id } : { empresa_id }\n        );\n    });\n}\n\n/**\n * Descargar Excel del historial de créditos de IA.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction descargarExcelCreditos() {\n    descargarExcel(\n        `planes-historial-creditos-exportar/${empresa_id}`,\n        'historial_creditos_ia',\n        true,\n        {}\n    );\n}\n\n/**\n * Procesar los filtros de las tablas de compras.\n *\n * @param {Object} json_filtros Filtros aplicados del dropdown\n * @param {string} tabla Nombre de la tabla\n * @returns {Object} Datos procesados para enviar al backend\n * @author Andres Morales\n */\nfunction procesarFiltrosTabla(json_filtros, tabla) {\n    let datos = {};\n\n    if (json_filtros[`estado_plan_filtro_${tabla}`]) {\n        datos.estado_id = json_filtros[`estado_plan_filtro_${tabla}`];\n    }\n\n    if (json_filtros[`duracion_filtro_${tabla}`]) {\n        datos.duracion = json_filtros[`duracion_filtro_${tabla}`];\n    }\n\n    if (tabla === 'creditos') {\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaCompra = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaCompra[0]) {\n                datos.created_at_desde = normalizarFechaFiltro(partesFechaCompra[0]);\n            }\n            if (partesFechaCompra[1]) {\n                datos.created_at_hasta = normalizarFechaFiltro(partesFechaCompra[1]);\n            }\n        }\n    } else {\n        if (json_filtros[`fecha_vencimiento_filtro_${tabla}`] && typeof json_filtros[`fecha_vencimiento_filtro_${tabla}`] === 'string') {\n            const partesFechaVencimiento = json_filtros[`fecha_vencimiento_filtro_${tabla}`].split(' a ');\n            if (partesFechaVencimiento[0]) {\n                datos.fecha_vencimiento_desde = normalizarFechaFiltro(partesFechaVencimiento[0]);\n            }\n            if (partesFechaVencimiento[1]) {\n                datos.fecha_vencimiento_hasta = normalizarFechaFiltro(partesFechaVencimiento[1]);\n            }\n        }\n\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaActivacion = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaActivacion[0]) {\n                datos.fecha_inicio_desde = normalizarFechaFiltro(partesFechaActivacion[0]);\n            }\n            if (partesFechaActivacion[1]) {\n                datos.fecha_inicio_hasta = normalizarFechaFiltro(partesFechaActivacion[1]);\n            }\n        }\n    }\n\n    return datos;\n}\n\n/**\n * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n *\n * @param {string} filtro ID del elemento html del filtro\n * @param {Object} filtros Filtros aplicados\n * @returns {void}\n * @author Andres Morales\n */\nfunction aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n    }\n}\n\nwindow.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\nwindow.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n\nif (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n    };\n    window.aplicarFiltrosDropdown.__esDispatcher = true;\n}\n","numLines":881,"startLine":1,"totalLines":881}},"sourceToolAssistantUUID":"9ce3c003-488d-4bcf-91a6-343c4514482d"}
{"parentUuid":"6711198f-e1d6-4195-9e85-d209151c36d4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01XEPr2Q6KWBnhhPN3KyUUWt","toolUseID":"toolu_01XEPr2Q6KWBnhhPN3KyUUWt","timestamp":"2026-01-29T20:32:54.887Z","uuid":"510216d6-13fe-4084-be46-f1c0299d822c"}
{"parentUuid":"510216d6-13fe-4084-be46-f1c0299d822c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_017WQ8Vi38cBNMWmvAXyyFAU","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a implementar los cambios según el plan. Primero agregaré las nuevas funciones después de la línea 51, luego modificaré los eventos input y la función `aplicarFiltrosDropdownRecompras`."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":14832,"cache_read_input_tokens":32411,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":14832},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXcJimmAbD2zQaviGLEqU","type":"assistant","uuid":"e7444011-6a15-4e58-8aec-3f69c624331d","timestamp":"2026-01-29T20:32:59.347Z"}
{"type":"file-history-snapshot","messageId":"649af750-d322-43ff-ab52-ed5ba07e3761","snapshot":{"messageId":"b8a855fd-f688-4dd4-81ed-108eb568f47b","trackedFileBackups":{"public\\js\\empresa\\planes\\modal-recompras.js":{"backupFileName":"453856d74d36a9e8@v1","version":1,"backupTime":"2026-01-29T20:33:10.688Z"}},"timestamp":"2026-01-29T20:32:47.589Z"},"isSnapshotUpdate":true}
{"parentUuid":"e7444011-6a15-4e58-8aec-3f69c624331d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_017WQ8Vi38cBNMWmvAXyyFAU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LFhceDEdepBAF6nfMU8U51","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","old_string":"let busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n\n$(document).ready(() => {","new_string":"let busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n\n/**\n * Obtener la busqueda combinada de chips activos.\n *\n * @param {string} id_input ID del input de filtro\n * @returns {string} Texto combinado de los chips separados por espacio\n * @author Sergio Vargas\n */\nfunction obtenerBusquedaChips(id_input) {\n    let componentes_chips_storage = localStorage.getItem('componentes_chips_storage');\n    if (componentes_chips_storage == null) return '';\n\n    componentes_chips_storage = JSON.parse(componentes_chips_storage);\n    if (componentes_chips_storage[window.location.pathname] == null) return '';\n    if (componentes_chips_storage[window.location.pathname][id_input] == null) return '';\n\n    let chips = componentes_chips_storage[window.location.pathname][id_input].chips;\n    return chips.join(' ');\n}\n\n/**\n * Actualizar la busqueda de la tabla con los chips activos.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction actualizarBusquedaConChips(nombre_tabla) {\n    const id_input = `filtro_dropdown_${nombre_tabla}`;\n    const busqueda_chips = obtenerBusquedaChips(id_input);\n    const valor_input = $(`#${id_input}`).val() || '';\n\n    let busqueda_combinada = '';\n    if (valor_input && busqueda_chips) {\n        busqueda_combinada = valor_input + ' ' + busqueda_chips;\n    } else if (valor_input) {\n        busqueda_combinada = valor_input;\n    } else if (busqueda_chips) {\n        busqueda_combinada = busqueda_chips;\n    }\n\n    busqueda_tablas[nombre_tabla] = busqueda_combinada;\n    aplicarBusquedaTabla(nombre_tabla, busqueda_combinada);\n}\n\n$(document).ready(() => {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":14832,"cache_read_input_tokens":32411,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":14832},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXcJimmAbD2zQaviGLEqU","type":"assistant","uuid":"649af750-d322-43ff-ab52-ed5ba07e3761","timestamp":"2026-01-29T20:33:09.982Z"}
{"parentUuid":"649af750-d322-43ff-ab52-ed5ba07e3761","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LFhceDEdepBAF6nfMU8U51","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js has been updated successfully."}]},"uuid":"f8edac08-8ab4-40e0-8d87-407643d5daba","timestamp":"2026-01-29T20:33:10.708Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","oldString":"let busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n\n$(document).ready(() => {","newString":"let busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n\n/**\n * Obtener la busqueda combinada de chips activos.\n *\n * @param {string} id_input ID del input de filtro\n * @returns {string} Texto combinado de los chips separados por espacio\n * @author Sergio Vargas\n */\nfunction obtenerBusquedaChips(id_input) {\n    let componentes_chips_storage = localStorage.getItem('componentes_chips_storage');\n    if (componentes_chips_storage == null) return '';\n\n    componentes_chips_storage = JSON.parse(componentes_chips_storage);\n    if (componentes_chips_storage[window.location.pathname] == null) return '';\n    if (componentes_chips_storage[window.location.pathname][id_input] == null) return '';\n\n    let chips = componentes_chips_storage[window.location.pathname][id_input].chips;\n    return chips.join(' ');\n}\n\n/**\n * Actualizar la busqueda de la tabla con los chips activos.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction actualizarBusquedaConChips(nombre_tabla) {\n    const id_input = `filtro_dropdown_${nombre_tabla}`;\n    const busqueda_chips = obtenerBusquedaChips(id_input);\n    const valor_input = $(`#${id_input}`).val() || '';\n\n    let busqueda_combinada = '';\n    if (valor_input && busqueda_chips) {\n        busqueda_combinada = valor_input + ' ' + busqueda_chips;\n    } else if (valor_input) {\n        busqueda_combinada = valor_input;\n    } else if (busqueda_chips) {\n        busqueda_combinada = busqueda_chips;\n    }\n\n    busqueda_tablas[nombre_tabla] = busqueda_combinada;\n    aplicarBusquedaTabla(nombre_tabla, busqueda_combinada);\n}\n\n$(document).ready(() => {","originalFile":"\nconst MODAL_FILTROS_AVANZADOS_COMPRAS_ID = 'modal-filtros-avanzados-compras';\nconst MODAL_HISTORIAL_COMPRAS_ID = 'modal-historial-recompras';\n\nconst FILTRO_DURACION_ID = 'filtro-duracion';\nconst FILTRO_FECHA_ACTIVACION_ID = 'filtro-fecha-activacion';\nconst FILTRO_FECHA_VENCIMIENTO_ID = 'filtro-fecha-vencimiento';\nconst FILTRO_ESTADO_PLAN_ID = 'filtro-estado-plan';\n\nconst normalizarFechaFiltro = fecha => {\n    if (!fecha || typeof fecha !== 'string') return fecha;\n    const limpio = fecha.trim();\n    if (!limpio) return limpio;\n    const separador = limpio.includes('/') ? '/' : (limpio.includes('-') ? '-' : null);\n    if (!separador) return limpio;\n    const partes = limpio.split(separador);\n    if (partes.length < 3) return limpio;\n    let dia = '';\n    let mes = '';\n    let anio = '';\n    if (partes[0].length === 4) {\n        anio = partes[0];\n        mes = partes[1];\n        dia = partes[2];\n    } else if (partes[2].length === 4) {\n        dia = partes[0];\n        mes = partes[1];\n        anio = partes[2];\n    } else {\n        return limpio;\n    }\n    return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;\n};\n\nlet compras_seleccionadas_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] };\n\nlet compras_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] }\n\nlet compras = [];\n\n// Variables globales para filtros de cada tabla\nlet filtros_seleccion = {};\nlet filtros_organizacional = {};\nlet filtros_vocacional = {};\nlet filtros_creditos = {};\n\nlet filtro_html_seleccion = '';\nlet filtro_html_organizacional = '';\nlet filtro_html_vocacional = '';\nlet filtro_html_creditos = '';\nlet busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n\n$(document).ready(() => {\n    $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));\n    $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });\n    $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });\n    $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });\n    $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });\n    $(document).on('input', '#filtro_dropdown_seleccion', function () { busqueda_tablas.seleccion = this.value; aplicarBusquedaTabla('seleccion', this.value); });\n    $(document).on('input', '#filtro_dropdown_organizacional', function () { busqueda_tablas.organizacional = this.value; aplicarBusquedaTabla('organizacional', this.value); });\n    $(document).on('input', '#filtro_dropdown_vocacional', function () { busqueda_tablas.vocacional = this.value; aplicarBusquedaTabla('vocacional', this.value); });\n    $(document).on('input', '#filtro_dropdown_creditos', function () { busqueda_tablas.creditos = this.value; aplicarBusquedaTabla('creditos', this.value); });\n    $(document).on('keydown', '#filtro_dropdown_seleccion, #filtro_dropdown_organizacional, #filtro_dropdown_vocacional, #filtro_dropdown_creditos', function (event) {\n        if (event.key === 'Enter') {\n            event.preventDefault();\n            event.stopPropagation();\n        }\n    });\n\n});\n\n/**\n * Renderiza la modal de historial de compras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {boolean} recarga verifica si tiene que recargar.\n * @param {string} tabla nombre de la tabla.\n * @param {string} filtro filtros para la busqueda.\n * @returns {void}\n * @author Andres Morales\n * @author Jair Carvajal\n */\nasync function modalHistorialCompras(id_empresa, recarga = false, tabla = '', filtro = {}) {\n    let historial_compras = await getHistorialCompras(id_empresa, filtro);\n\n    if (tabla === '' || tabla === 'seleccion') {\n        await renderizarTablas(historial_compras[1], 'seleccion');\n        establecerEventoDescargarComprasExcel('seleccion');\n    }\n\n    if (tabla === '' || tabla === 'organizacional') {\n        await renderizarTablas(historial_compras[2], 'organizacional');\n        establecerEventoDescargarComprasExcel('organizacional');\n    }\n\n    if (tabla === '' || tabla === 'vocacional') {\n        await renderizarTablas(historial_compras[3], 'vocacional');\n        establecerEventoDescargarComprasExcel('vocacional');\n    }\n\n    if (tabla === '' || tabla === 'creditos') {\n        let historial_creditos = await getHistorialComprasCreditos(id_empresa, filtro);\n        await renderizarTablaCreditos(historial_creditos, 'creditos');\n        establecerEventoDescargarComprasExcel('creditos');\n    }\n\n    if (!recarga) {\n        $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n    }\n\n    cargarDataTablas();\n    inicializarTooltips();\n}\n\n\n/**\n * Obtener historial de recompras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @returns {array}\n * @author Daniel Beltrán\n * @author Andres Morales\n */\nasync function getHistorialCompras(empresa_id, filtros = {}) {\n    let datos = [];\n    let agrupadosPorTipoPrueba = {\n        1: [],\n        2: [],\n        3: [],\n    };\n    await $.ajax({\n        type: 'GET',\n        url : `/planes-historial-recompras/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n        datos.forEach(item => {\n            let tipoPruebaNombre = item.plan.tipo_prueba.id;\n            agrupadosPorTipoPrueba[tipoPruebaNombre].push(item);\n        });\n    }).catch((error) => {\n        console.error(error);\n    });\n    return agrupadosPorTipoPrueba;\n}\n\n/**\n * Obtener historial de compras de planes con creditos.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {Object} filtros Filtros aplicados.\n * @returns {array}\n * @author Sergio Vargas\n * @author Jair Carvajal\n */\nasync function getHistorialComprasCreditos(empresa_id, filtros = {}) {\n    let datos = [];\n\n    await $.ajax({\n        type: 'GET',\n        url: `/planes-historial-recompras-creditos/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Renderiza las distintas tablas de compras.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Andres Morales\n * @author Jair Carvajal\n */\nasync function renderizarTablas(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = [];\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n    let totalUnidades = datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_agendas || 0), 0);\n    let totalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_ofertas_laborales || 0), 0);\n    let baseTotalUnidades =  datos_entrada.reduce((total, dato) => total + (dato.unidades || 0), 0);\n    let baseTotalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.cantidad_ofertas_laborales || 0), 0);\n    $(`#${nombre_tabla}-totales-unidades`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>${crearProgressBar({ label: `${totalUnidades}/${baseTotalUnidades}`,height: '8px', porcentaje: {porcentaje: (totalUnidades / (baseTotalUnidades ?? 1)) * 100, texto:false }})}`);\n    $(`#${nombre_tabla}-totales-ofertas`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>${crearProgressBar({ label: `${totalOfertas}/${baseTotalOfertas}`,height: '8px', porcentaje: {porcentaje: (totalOfertas / (baseTotalOfertas ?? 1)) * 100, texto:false }})}`);\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n             },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n                                data: [{ texto: 'id', value: dato.id }],\n                            })}\n                        </div>\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan.nombre}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias} dias</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-box\"></i> Consumo unidades</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUnidades(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_agendas, dato.unidades ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-briefcase\"></i> Consumo vacantes</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoOfertas(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_ofertas_laborales, dato.cantidad_ofertas_laborales ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-person\"></i> Consumo usuarios</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUsuarios(usuarios)}>${crearProgressBarTemplate('', false, total_usuarios, dato.cantidad_usuarios ?? 0, false)}</div>`,\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumos(${dato.id}, '${dato.plan.nombre}', '${dato.plan.tipo_prueba.nombre}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n}\n\n/**\n * Renderiza la tabla de compras de creditos.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Sergio Vargas\n */\nasync function renderizarTablaCreditos(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n\n    let total_consumidos = datos_entrada.reduce((total, dato) => total + (dato.creditos_consumidos || 0), 0);\n    let total_creditos = datos_entrada.reduce((total, dato) => total + (dato.creditos_totales || 0), 0);\n    let porcentaje_total = total_creditos > 0 ? (total_consumidos / total_creditos) * 100 : 0;\n\n    $('#creditos-totales')\n        .empty()\n        .append(`\n            <p class=\"text-label-2 mb-1\"><img class=\"me-2\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\">Créditos totales</p>\n            ${crearProgressBar({ label: `${formatearNumero(total_consumidos)}/${formatearNumero(total_creditos)}`, height: '8px', porcentaje: { porcentaje: porcentaje_total, texto: false }})}\n        `);\n\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan_credito?.nombre ?? '---'}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias ? `${dato.vigencia_dias} dias` : 'Sin tiempo'}</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><img class=\"me-1\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\"> Consumo créditos</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => {\n                    let total = dato.creditos_totales ?? 0;\n                    let consumidos = dato.creditos_consumidos ?? 0;\n                    return `${crearProgressBarTemplate('', false, consumidos, total, false)}`;\n                },\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumosCreditos(${dato.empresa_id}, ${dato.id}, '${dato.plan_credito?.nombre ?? ''}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n}\n\nfunction aplicarBusquedaTabla(nombre_tabla, valor) {\n    const selector = `#tabla-compras-${nombre_tabla}`;\n    if (!$.fn.DataTable.isDataTable(selector)) return;\n    $(selector).DataTable().search(valor || '').draw();\n}\n\n/**\n * Renderiza el contenido de las subtablas.\n *\n * @param {array} data Array de datos a renderizar.\n * @returns {string} HTML de la subtabla.\n * @author Andres Morales\n */\nfunction crearContenidoSubTabla(data) {\n    let pruebas_html = \"\";\n    data.pruebas.forEach(prueba => {\n        pruebas_html += `\n            <div class=\"col-12 my-2 col-md-6 d-flex justify-content-start align-items-center gap-3\">\n                <img src=\"/imagenes/logos/pruebas/${slugify(prueba.nombre)}.png\" width=\"32px\" height=\"32px\" class=\"object-fit-cover\" alt=\"Logo prueba\">\n                <p class=\"mb-0 text-label-2\">${prueba.nombre}</p>\n            </div>\n        `;\n    });\n\n    let funcionalidades_predeterminadas_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (funcionalidad.predeterminado) funcionalidades_predeterminadas_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    let funcionalidades_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (!funcionalidad.predeterminado) funcionalidades_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    return `\n        <div class=\"row w-100 my-3 ps-8\">\n            <div class=\"col-4\">\n                <p class=\"text-body-3 fw-bolder\">Pruebas</p>\n                <div class=\"row\">\n                    ${pruebas_html}\n                </div>\n            </div>\n            <div class=\"col-8\">\n                <div class=\"container-fluid\">\n                    <div class=\"row border-bottom pb-2\">\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Costo:</span> <br> $ ${formatearNumero(data.precio)}</p>\n                        </div>\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Descuento:</span> <br> ${data.porcentaje_descuento !== 0 ? data.porcentaje_descuento + '%' : `Sin descuento`}</p>\n                        </div>\n                         <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Valor de venta:</span> <br> $ ${data.porcentaje_descuento !== 0 ? formatearNumero(data.precio * (1 - (data.porcentaje_descuento / 100))) : formatearNumero(data.precio) }</p>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios adicionales</p>\n                        </div>\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios predefinidos</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_html}</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_predeterminadas_html}</p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Generar el tooltip de consumo de unidades.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUnidades(consumos) {\n    var agrupado = consumos.reduce((acc, item) => {\n        if(item.agenda && item.agenda.prueba) {\n          var { id, nombre } = item.agenda.prueba;\n          var key = `${id}-${nombre}`;\n          if(!acc[key]) {\n            acc[key] = { prueba_id: id, prueba_nombre: nombre, cantidad: 0 };\n          }\n          acc[key].cantidad++;\n        }\n        return acc;\n    }, {});\n\n    var resultado = Object.values(agrupado);\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white'>Cantidad consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white'>\n                        <img src='/imagenes/logos/pruebas/${slugify(item.prueba_nombre)}.png' width='22px' height='22px' class='object-fit-cover me-2' alt='>\n                    </span>\n                    <span class='text-body-3 text-white'>\n                        ${item.prueba_nombre}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white me-3'>Cantidad consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de ofertas.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoOfertas(consumos) {\n    const resultado = Object.values(\n        consumos.filter(item => item.oferta_laboral_id !== null).reduce((acc, item) => {\n            const key = `${item.empresa.id}-${item.empresa.nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: item.empresa.id,\n                empresa_nombre_comercial: item.empresa.nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            return acc;\n        }, {})\n    );\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.empresa_nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de usuarios.\n *\n * @param {array} usuarios Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUsuarios(usuarios) {\n    const agrupado = usuarios.reduce((acc, usuario) => {\n        if (Array.isArray(usuario.empresas_usuarios)) {\n          // Recorremos las empresas del usuario y contamos sólo la primera que no tenga id 1\n          for (let i = 0; i < usuario.empresas_usuarios.length; i++) {\n            const { id, nombre_comercial } = usuario.empresas_usuarios[i].empresa;\n            if (id === 1) continue; // omitir la empresa con id 1\n            const key = `${id}-${nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: id,\n                nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            // Una vez que se cuenta el usuario para una empresa, salimos del ciclo\n            break;\n          }\n        }\n        return acc;\n      }, {});\n\n      const resultado = Object.values(agrupado);\n\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Aplicar los filtros a las compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction aplicarFiltrosAvanzadosCompras() {\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Abrir el modal de filtros de compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalFiltrosAvanzadosCompras() {\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Seleccionar una compra.\n *\n * @param {boolean} seleccion Selección.\n * @param {number} compra_id Id de la compra seleccionada.\n * @param {string} tabla_compras_id Id del elemento html de la tabla de compras.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction seleccionarCompra(seleccion, compra_id, tabla_compras_id, nombre_tabla) {\n    if (seleccion) {\n        compras_seleccionadas_ids[nombre_tabla].push(parseInt(compra_id));\n    } else {\n        let indice = compras_seleccionadas_ids[nombre_tabla].indexOf(compra_id);\n        if (indice !== -1) compras_seleccionadas_ids[nombre_tabla].splice(indice, 1);\n    }\n\n    let checkbox_seleccionar_todos = $(`#checkbox-seleccionar-todos-${tabla_compras_id}`);\n    if (compras_seleccionadas_ids[nombre_tabla].length === compras_ids[nombre_tabla].length) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', true);\n    } else if (compras_seleccionadas_ids[nombre_tabla].length === 0) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', false);\n    } else {\n        checkbox_seleccionar_todos.prop('indeterminate', true);\n    }\n}\n\n/**\n * Seleccionar todas las compras.\n *\n * @param {boolean} seleccion Selección\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nfunction seleccionarTodasCompras(seleccion, nombre_tabla) {\n    if (!seleccion) compras_seleccionadas_ids[nombre_tabla] = [];\n    let checkboxes_compras = $(`#tabla-compras-${nombre_tabla}`).find(\".checkbox-compra\").toArray();\n    checkboxes_compras.forEach(checkbox => {\n        checkbox.checked = seleccion;\n        if (seleccion && !compras_seleccionadas_ids[nombre_tabla].includes(checkbox.id)) {\n            compras_seleccionadas_ids[nombre_tabla].push(parseInt(checkbox.id));\n        }\n    });\n}\n\n/**\n * Establecer el evento para el botón de descarga del archivo Excel.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction establecerEventoDescargarComprasExcel(nombre_tabla) {\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).off('click');\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).on('click', () => {\n        if (nombre_tabla === 'creditos') {\n            descargarExcelCreditos();\n            return;\n        }\n        let empresas_planes_ids = compras_seleccionadas_ids[nombre_tabla].length ? [...compras_seleccionadas_ids[nombre_tabla]] : [...compras_ids[nombre_tabla]];\n        descargarExcel(\n            'planes-historial-recompras-exportar',\n            `compras_${nombre_tabla}`,\n            true,\n            empresas_planes_ids.length ? { empresas_planes_ids, empresa_id } : { empresa_id }\n        );\n    });\n}\n\n/**\n * Descargar Excel del historial de créditos de IA.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction descargarExcelCreditos() {\n    descargarExcel(\n        `planes-historial-creditos-exportar/${empresa_id}`,\n        'historial_creditos_ia',\n        true,\n        {}\n    );\n}\n\n/**\n * Procesar los filtros de las tablas de compras.\n *\n * @param {Object} json_filtros Filtros aplicados del dropdown\n * @param {string} tabla Nombre de la tabla\n * @returns {Object} Datos procesados para enviar al backend\n * @author Andres Morales\n */\nfunction procesarFiltrosTabla(json_filtros, tabla) {\n    let datos = {};\n\n    if (json_filtros[`estado_plan_filtro_${tabla}`]) {\n        datos.estado_id = json_filtros[`estado_plan_filtro_${tabla}`];\n    }\n\n    if (json_filtros[`duracion_filtro_${tabla}`]) {\n        datos.duracion = json_filtros[`duracion_filtro_${tabla}`];\n    }\n\n    if (tabla === 'creditos') {\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaCompra = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaCompra[0]) {\n                datos.created_at_desde = normalizarFechaFiltro(partesFechaCompra[0]);\n            }\n            if (partesFechaCompra[1]) {\n                datos.created_at_hasta = normalizarFechaFiltro(partesFechaCompra[1]);\n            }\n        }\n    } else {\n        if (json_filtros[`fecha_vencimiento_filtro_${tabla}`] && typeof json_filtros[`fecha_vencimiento_filtro_${tabla}`] === 'string') {\n            const partesFechaVencimiento = json_filtros[`fecha_vencimiento_filtro_${tabla}`].split(' a ');\n            if (partesFechaVencimiento[0]) {\n                datos.fecha_vencimiento_desde = normalizarFechaFiltro(partesFechaVencimiento[0]);\n            }\n            if (partesFechaVencimiento[1]) {\n                datos.fecha_vencimiento_hasta = normalizarFechaFiltro(partesFechaVencimiento[1]);\n            }\n        }\n\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaActivacion = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaActivacion[0]) {\n                datos.fecha_inicio_desde = normalizarFechaFiltro(partesFechaActivacion[0]);\n            }\n            if (partesFechaActivacion[1]) {\n                datos.fecha_inicio_hasta = normalizarFechaFiltro(partesFechaActivacion[1]);\n            }\n        }\n    }\n\n    return datos;\n}\n\n/**\n * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n *\n * @param {string} filtro ID del elemento html del filtro\n * @param {Object} filtros Filtros aplicados\n * @returns {void}\n * @author Andres Morales\n */\nfunction aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n    }\n}\n\nwindow.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\nwindow.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n\nif (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n    };\n    window.aplicarFiltrosDropdown.__esDispatcher = true;\n}\n","structuredPatch":[{"oldStart":50,"oldLines":6,"newStart":50,"newLines":50,"lines":[" let filtro_html_creditos = '';"," let busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };"," ","+/**","+ * Obtener la busqueda combinada de chips activos.","+ *","+ * @param {string} id_input ID del input de filtro","+ * @returns {string} Texto combinado de los chips separados por espacio","+ * @author Sergio Vargas","+ */","+function obtenerBusquedaChips(id_input) {","+    let componentes_chips_storage = localStorage.getItem('componentes_chips_storage');","+    if (componentes_chips_storage == null) return '';","+","+    componentes_chips_storage = JSON.parse(componentes_chips_storage);","+    if (componentes_chips_storage[window.location.pathname] == null) return '';","+    if (componentes_chips_storage[window.location.pathname][id_input] == null) return '';","+","+    let chips = componentes_chips_storage[window.location.pathname][id_input].chips;","+    return chips.join(' ');","+}","+","+/**","+ * Actualizar la busqueda de la tabla con los chips activos.","+ *","+ * @param {string} nombre_tabla Nombre de la tabla","+ * @returns {void}","+ * @author Sergio Vargas","+ */","+function actualizarBusquedaConChips(nombre_tabla) {","+    const id_input = `filtro_dropdown_${nombre_tabla}`;","+    const busqueda_chips = obtenerBusquedaChips(id_input);","+    const valor_input = $(`#${id_input}`).val() || '';","+","+    let busqueda_combinada = '';","+    if (valor_input && busqueda_chips) {","+        busqueda_combinada = valor_input + ' ' + busqueda_chips;","+    } else if (valor_input) {","+        busqueda_combinada = valor_input;","+    } else if (busqueda_chips) {","+        busqueda_combinada = busqueda_chips;","+    }","+","+    busqueda_tablas[nombre_tabla] = busqueda_combinada;","+    aplicarBusquedaTabla(nombre_tabla, busqueda_combinada);","+}","+"," $(document).ready(() => {","     $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));","     $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"649af750-d322-43ff-ab52-ed5ba07e3761"}
{"parentUuid":"f8edac08-8ab4-40e0-8d87-407643d5daba","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KBWCqj5GZCC3DptLctvfKG","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a modificar los eventos input para combinar chips con el valor del input:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":841,"cache_read_input_tokens":47243,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":841},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXcJjwzM9oR7JVphLEmfx","type":"assistant","uuid":"82b6c0cf-2503-4d59-82b8-b6f55635afdc","timestamp":"2026-01-29T20:33:13.837Z"}
{"parentUuid":"82b6c0cf-2503-4d59-82b8-b6f55635afdc","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KBWCqj5GZCC3DptLctvfKG","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017hwxdo7qVqFjtd7VRE94ky","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","old_string":"    $(document).on('input', '#filtro_dropdown_seleccion', function () { busqueda_tablas.seleccion = this.value; aplicarBusquedaTabla('seleccion', this.value); });\n    $(document).on('input', '#filtro_dropdown_organizacional', function () { busqueda_tablas.organizacional = this.value; aplicarBusquedaTabla('organizacional', this.value); });\n    $(document).on('input', '#filtro_dropdown_vocacional', function () { busqueda_tablas.vocacional = this.value; aplicarBusquedaTabla('vocacional', this.value); });\n    $(document).on('input', '#filtro_dropdown_creditos', function () { busqueda_tablas.creditos = this.value; aplicarBusquedaTabla('creditos', this.value); });","new_string":"    $(document).on('input', '#filtro_dropdown_seleccion', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_seleccion');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.seleccion = valor_combinado;\n        aplicarBusquedaTabla('seleccion', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_organizacional', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_organizacional');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.organizacional = valor_combinado;\n        aplicarBusquedaTabla('organizacional', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_vocacional', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_vocacional');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.vocacional = valor_combinado;\n        aplicarBusquedaTabla('vocacional', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_creditos', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_creditos');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.creditos = valor_combinado;\n        aplicarBusquedaTabla('creditos', valor_combinado);\n    });"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":841,"cache_read_input_tokens":47243,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":841},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXcJjwzM9oR7JVphLEmfx","type":"assistant","uuid":"0e7025c3-a74c-43e9-8b3c-cffab8253cb1","timestamp":"2026-01-29T20:33:19.960Z"}
{"parentUuid":"0e7025c3-a74c-43e9-8b3c-cffab8253cb1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017hwxdo7qVqFjtd7VRE94ky","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js has been updated successfully."}]},"uuid":"ffc2826f-062f-48aa-b74e-b1e47c96e27b","timestamp":"2026-01-29T20:33:20.665Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","oldString":"    $(document).on('input', '#filtro_dropdown_seleccion', function () { busqueda_tablas.seleccion = this.value; aplicarBusquedaTabla('seleccion', this.value); });\n    $(document).on('input', '#filtro_dropdown_organizacional', function () { busqueda_tablas.organizacional = this.value; aplicarBusquedaTabla('organizacional', this.value); });\n    $(document).on('input', '#filtro_dropdown_vocacional', function () { busqueda_tablas.vocacional = this.value; aplicarBusquedaTabla('vocacional', this.value); });\n    $(document).on('input', '#filtro_dropdown_creditos', function () { busqueda_tablas.creditos = this.value; aplicarBusquedaTabla('creditos', this.value); });","newString":"    $(document).on('input', '#filtro_dropdown_seleccion', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_seleccion');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.seleccion = valor_combinado;\n        aplicarBusquedaTabla('seleccion', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_organizacional', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_organizacional');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.organizacional = valor_combinado;\n        aplicarBusquedaTabla('organizacional', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_vocacional', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_vocacional');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.vocacional = valor_combinado;\n        aplicarBusquedaTabla('vocacional', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_creditos', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_creditos');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.creditos = valor_combinado;\n        aplicarBusquedaTabla('creditos', valor_combinado);\n    });","originalFile":"\nconst MODAL_FILTROS_AVANZADOS_COMPRAS_ID = 'modal-filtros-avanzados-compras';\nconst MODAL_HISTORIAL_COMPRAS_ID = 'modal-historial-recompras';\n\nconst FILTRO_DURACION_ID = 'filtro-duracion';\nconst FILTRO_FECHA_ACTIVACION_ID = 'filtro-fecha-activacion';\nconst FILTRO_FECHA_VENCIMIENTO_ID = 'filtro-fecha-vencimiento';\nconst FILTRO_ESTADO_PLAN_ID = 'filtro-estado-plan';\n\nconst normalizarFechaFiltro = fecha => {\n    if (!fecha || typeof fecha !== 'string') return fecha;\n    const limpio = fecha.trim();\n    if (!limpio) return limpio;\n    const separador = limpio.includes('/') ? '/' : (limpio.includes('-') ? '-' : null);\n    if (!separador) return limpio;\n    const partes = limpio.split(separador);\n    if (partes.length < 3) return limpio;\n    let dia = '';\n    let mes = '';\n    let anio = '';\n    if (partes[0].length === 4) {\n        anio = partes[0];\n        mes = partes[1];\n        dia = partes[2];\n    } else if (partes[2].length === 4) {\n        dia = partes[0];\n        mes = partes[1];\n        anio = partes[2];\n    } else {\n        return limpio;\n    }\n    return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;\n};\n\nlet compras_seleccionadas_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] };\n\nlet compras_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] }\n\nlet compras = [];\n\n// Variables globales para filtros de cada tabla\nlet filtros_seleccion = {};\nlet filtros_organizacional = {};\nlet filtros_vocacional = {};\nlet filtros_creditos = {};\n\nlet filtro_html_seleccion = '';\nlet filtro_html_organizacional = '';\nlet filtro_html_vocacional = '';\nlet filtro_html_creditos = '';\nlet busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n\n/**\n * Obtener la busqueda combinada de chips activos.\n *\n * @param {string} id_input ID del input de filtro\n * @returns {string} Texto combinado de los chips separados por espacio\n * @author Sergio Vargas\n */\nfunction obtenerBusquedaChips(id_input) {\n    let componentes_chips_storage = localStorage.getItem('componentes_chips_storage');\n    if (componentes_chips_storage == null) return '';\n\n    componentes_chips_storage = JSON.parse(componentes_chips_storage);\n    if (componentes_chips_storage[window.location.pathname] == null) return '';\n    if (componentes_chips_storage[window.location.pathname][id_input] == null) return '';\n\n    let chips = componentes_chips_storage[window.location.pathname][id_input].chips;\n    return chips.join(' ');\n}\n\n/**\n * Actualizar la busqueda de la tabla con los chips activos.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction actualizarBusquedaConChips(nombre_tabla) {\n    const id_input = `filtro_dropdown_${nombre_tabla}`;\n    const busqueda_chips = obtenerBusquedaChips(id_input);\n    const valor_input = $(`#${id_input}`).val() || '';\n\n    let busqueda_combinada = '';\n    if (valor_input && busqueda_chips) {\n        busqueda_combinada = valor_input + ' ' + busqueda_chips;\n    } else if (valor_input) {\n        busqueda_combinada = valor_input;\n    } else if (busqueda_chips) {\n        busqueda_combinada = busqueda_chips;\n    }\n\n    busqueda_tablas[nombre_tabla] = busqueda_combinada;\n    aplicarBusquedaTabla(nombre_tabla, busqueda_combinada);\n}\n\n$(document).ready(() => {\n    $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));\n    $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });\n    $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });\n    $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });\n    $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });\n    $(document).on('input', '#filtro_dropdown_seleccion', function () { busqueda_tablas.seleccion = this.value; aplicarBusquedaTabla('seleccion', this.value); });\n    $(document).on('input', '#filtro_dropdown_organizacional', function () { busqueda_tablas.organizacional = this.value; aplicarBusquedaTabla('organizacional', this.value); });\n    $(document).on('input', '#filtro_dropdown_vocacional', function () { busqueda_tablas.vocacional = this.value; aplicarBusquedaTabla('vocacional', this.value); });\n    $(document).on('input', '#filtro_dropdown_creditos', function () { busqueda_tablas.creditos = this.value; aplicarBusquedaTabla('creditos', this.value); });\n    $(document).on('keydown', '#filtro_dropdown_seleccion, #filtro_dropdown_organizacional, #filtro_dropdown_vocacional, #filtro_dropdown_creditos', function (event) {\n        if (event.key === 'Enter') {\n            event.preventDefault();\n            event.stopPropagation();\n        }\n    });\n\n});\n\n/**\n * Renderiza la modal de historial de compras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {boolean} recarga verifica si tiene que recargar.\n * @param {string} tabla nombre de la tabla.\n * @param {string} filtro filtros para la busqueda.\n * @returns {void}\n * @author Andres Morales\n * @author Jair Carvajal\n */\nasync function modalHistorialCompras(id_empresa, recarga = false, tabla = '', filtro = {}) {\n    let historial_compras = await getHistorialCompras(id_empresa, filtro);\n\n    if (tabla === '' || tabla === 'seleccion') {\n        await renderizarTablas(historial_compras[1], 'seleccion');\n        establecerEventoDescargarComprasExcel('seleccion');\n    }\n\n    if (tabla === '' || tabla === 'organizacional') {\n        await renderizarTablas(historial_compras[2], 'organizacional');\n        establecerEventoDescargarComprasExcel('organizacional');\n    }\n\n    if (tabla === '' || tabla === 'vocacional') {\n        await renderizarTablas(historial_compras[3], 'vocacional');\n        establecerEventoDescargarComprasExcel('vocacional');\n    }\n\n    if (tabla === '' || tabla === 'creditos') {\n        let historial_creditos = await getHistorialComprasCreditos(id_empresa, filtro);\n        await renderizarTablaCreditos(historial_creditos, 'creditos');\n        establecerEventoDescargarComprasExcel('creditos');\n    }\n\n    if (!recarga) {\n        $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n    }\n\n    cargarDataTablas();\n    inicializarTooltips();\n}\n\n\n/**\n * Obtener historial de recompras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @returns {array}\n * @author Daniel Beltrán\n * @author Andres Morales\n */\nasync function getHistorialCompras(empresa_id, filtros = {}) {\n    let datos = [];\n    let agrupadosPorTipoPrueba = {\n        1: [],\n        2: [],\n        3: [],\n    };\n    await $.ajax({\n        type: 'GET',\n        url : `/planes-historial-recompras/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n        datos.forEach(item => {\n            let tipoPruebaNombre = item.plan.tipo_prueba.id;\n            agrupadosPorTipoPrueba[tipoPruebaNombre].push(item);\n        });\n    }).catch((error) => {\n        console.error(error);\n    });\n    return agrupadosPorTipoPrueba;\n}\n\n/**\n * Obtener historial de compras de planes con creditos.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {Object} filtros Filtros aplicados.\n * @returns {array}\n * @author Sergio Vargas\n * @author Jair Carvajal\n */\nasync function getHistorialComprasCreditos(empresa_id, filtros = {}) {\n    let datos = [];\n\n    await $.ajax({\n        type: 'GET',\n        url: `/planes-historial-recompras-creditos/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Renderiza las distintas tablas de compras.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Andres Morales\n * @author Jair Carvajal\n */\nasync function renderizarTablas(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = [];\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n    let totalUnidades = datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_agendas || 0), 0);\n    let totalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_ofertas_laborales || 0), 0);\n    let baseTotalUnidades =  datos_entrada.reduce((total, dato) => total + (dato.unidades || 0), 0);\n    let baseTotalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.cantidad_ofertas_laborales || 0), 0);\n    $(`#${nombre_tabla}-totales-unidades`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>${crearProgressBar({ label: `${totalUnidades}/${baseTotalUnidades}`,height: '8px', porcentaje: {porcentaje: (totalUnidades / (baseTotalUnidades ?? 1)) * 100, texto:false }})}`);\n    $(`#${nombre_tabla}-totales-ofertas`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>${crearProgressBar({ label: `${totalOfertas}/${baseTotalOfertas}`,height: '8px', porcentaje: {porcentaje: (totalOfertas / (baseTotalOfertas ?? 1)) * 100, texto:false }})}`);\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n             },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n                                data: [{ texto: 'id', value: dato.id }],\n                            })}\n                        </div>\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan.nombre}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias} dias</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-box\"></i> Consumo unidades</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUnidades(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_agendas, dato.unidades ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-briefcase\"></i> Consumo vacantes</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoOfertas(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_ofertas_laborales, dato.cantidad_ofertas_laborales ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-person\"></i> Consumo usuarios</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUsuarios(usuarios)}>${crearProgressBarTemplate('', false, total_usuarios, dato.cantidad_usuarios ?? 0, false)}</div>`,\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumos(${dato.id}, '${dato.plan.nombre}', '${dato.plan.tipo_prueba.nombre}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n}\n\n/**\n * Renderiza la tabla de compras de creditos.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Sergio Vargas\n */\nasync function renderizarTablaCreditos(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n\n    let total_consumidos = datos_entrada.reduce((total, dato) => total + (dato.creditos_consumidos || 0), 0);\n    let total_creditos = datos_entrada.reduce((total, dato) => total + (dato.creditos_totales || 0), 0);\n    let porcentaje_total = total_creditos > 0 ? (total_consumidos / total_creditos) * 100 : 0;\n\n    $('#creditos-totales')\n        .empty()\n        .append(`\n            <p class=\"text-label-2 mb-1\"><img class=\"me-2\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\">Créditos totales</p>\n            ${crearProgressBar({ label: `${formatearNumero(total_consumidos)}/${formatearNumero(total_creditos)}`, height: '8px', porcentaje: { porcentaje: porcentaje_total, texto: false }})}\n        `);\n\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan_credito?.nombre ?? '---'}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias ? `${dato.vigencia_dias} dias` : 'Sin tiempo'}</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><img class=\"me-1\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\"> Consumo créditos</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => {\n                    let total = dato.creditos_totales ?? 0;\n                    let consumidos = dato.creditos_consumidos ?? 0;\n                    return `${crearProgressBarTemplate('', false, consumidos, total, false)}`;\n                },\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumosCreditos(${dato.empresa_id}, ${dato.id}, '${dato.plan_credito?.nombre ?? ''}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n}\n\nfunction aplicarBusquedaTabla(nombre_tabla, valor) {\n    const selector = `#tabla-compras-${nombre_tabla}`;\n    if (!$.fn.DataTable.isDataTable(selector)) return;\n    $(selector).DataTable().search(valor || '').draw();\n}\n\n/**\n * Renderiza el contenido de las subtablas.\n *\n * @param {array} data Array de datos a renderizar.\n * @returns {string} HTML de la subtabla.\n * @author Andres Morales\n */\nfunction crearContenidoSubTabla(data) {\n    let pruebas_html = \"\";\n    data.pruebas.forEach(prueba => {\n        pruebas_html += `\n            <div class=\"col-12 my-2 col-md-6 d-flex justify-content-start align-items-center gap-3\">\n                <img src=\"/imagenes/logos/pruebas/${slugify(prueba.nombre)}.png\" width=\"32px\" height=\"32px\" class=\"object-fit-cover\" alt=\"Logo prueba\">\n                <p class=\"mb-0 text-label-2\">${prueba.nombre}</p>\n            </div>\n        `;\n    });\n\n    let funcionalidades_predeterminadas_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (funcionalidad.predeterminado) funcionalidades_predeterminadas_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    let funcionalidades_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (!funcionalidad.predeterminado) funcionalidades_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    return `\n        <div class=\"row w-100 my-3 ps-8\">\n            <div class=\"col-4\">\n                <p class=\"text-body-3 fw-bolder\">Pruebas</p>\n                <div class=\"row\">\n                    ${pruebas_html}\n                </div>\n            </div>\n            <div class=\"col-8\">\n                <div class=\"container-fluid\">\n                    <div class=\"row border-bottom pb-2\">\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Costo:</span> <br> $ ${formatearNumero(data.precio)}</p>\n                        </div>\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Descuento:</span> <br> ${data.porcentaje_descuento !== 0 ? data.porcentaje_descuento + '%' : `Sin descuento`}</p>\n                        </div>\n                         <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Valor de venta:</span> <br> $ ${data.porcentaje_descuento !== 0 ? formatearNumero(data.precio * (1 - (data.porcentaje_descuento / 100))) : formatearNumero(data.precio) }</p>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios adicionales</p>\n                        </div>\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios predefinidos</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_html}</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_predeterminadas_html}</p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Generar el tooltip de consumo de unidades.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUnidades(consumos) {\n    var agrupado = consumos.reduce((acc, item) => {\n        if(item.agenda && item.agenda.prueba) {\n          var { id, nombre } = item.agenda.prueba;\n          var key = `${id}-${nombre}`;\n          if(!acc[key]) {\n            acc[key] = { prueba_id: id, prueba_nombre: nombre, cantidad: 0 };\n          }\n          acc[key].cantidad++;\n        }\n        return acc;\n    }, {});\n\n    var resultado = Object.values(agrupado);\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white'>Cantidad consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white'>\n                        <img src='/imagenes/logos/pruebas/${slugify(item.prueba_nombre)}.png' width='22px' height='22px' class='object-fit-cover me-2' alt='>\n                    </span>\n                    <span class='text-body-3 text-white'>\n                        ${item.prueba_nombre}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white me-3'>Cantidad consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de ofertas.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoOfertas(consumos) {\n    const resultado = Object.values(\n        consumos.filter(item => item.oferta_laboral_id !== null).reduce((acc, item) => {\n            const key = `${item.empresa.id}-${item.empresa.nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: item.empresa.id,\n                empresa_nombre_comercial: item.empresa.nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            return acc;\n        }, {})\n    );\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.empresa_nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de usuarios.\n *\n * @param {array} usuarios Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUsuarios(usuarios) {\n    const agrupado = usuarios.reduce((acc, usuario) => {\n        if (Array.isArray(usuario.empresas_usuarios)) {\n          // Recorremos las empresas del usuario y contamos sólo la primera que no tenga id 1\n          for (let i = 0; i < usuario.empresas_usuarios.length; i++) {\n            const { id, nombre_comercial } = usuario.empresas_usuarios[i].empresa;\n            if (id === 1) continue; // omitir la empresa con id 1\n            const key = `${id}-${nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: id,\n                nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            // Una vez que se cuenta el usuario para una empresa, salimos del ciclo\n            break;\n          }\n        }\n        return acc;\n      }, {});\n\n      const resultado = Object.values(agrupado);\n\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Aplicar los filtros a las compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction aplicarFiltrosAvanzadosCompras() {\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Abrir el modal de filtros de compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalFiltrosAvanzadosCompras() {\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Seleccionar una compra.\n *\n * @param {boolean} seleccion Selección.\n * @param {number} compra_id Id de la compra seleccionada.\n * @param {string} tabla_compras_id Id del elemento html de la tabla de compras.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction seleccionarCompra(seleccion, compra_id, tabla_compras_id, nombre_tabla) {\n    if (seleccion) {\n        compras_seleccionadas_ids[nombre_tabla].push(parseInt(compra_id));\n    } else {\n        let indice = compras_seleccionadas_ids[nombre_tabla].indexOf(compra_id);\n        if (indice !== -1) compras_seleccionadas_ids[nombre_tabla].splice(indice, 1);\n    }\n\n    let checkbox_seleccionar_todos = $(`#checkbox-seleccionar-todos-${tabla_compras_id}`);\n    if (compras_seleccionadas_ids[nombre_tabla].length === compras_ids[nombre_tabla].length) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', true);\n    } else if (compras_seleccionadas_ids[nombre_tabla].length === 0) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', false);\n    } else {\n        checkbox_seleccionar_todos.prop('indeterminate', true);\n    }\n}\n\n/**\n * Seleccionar todas las compras.\n *\n * @param {boolean} seleccion Selección\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nfunction seleccionarTodasCompras(seleccion, nombre_tabla) {\n    if (!seleccion) compras_seleccionadas_ids[nombre_tabla] = [];\n    let checkboxes_compras = $(`#tabla-compras-${nombre_tabla}`).find(\".checkbox-compra\").toArray();\n    checkboxes_compras.forEach(checkbox => {\n        checkbox.checked = seleccion;\n        if (seleccion && !compras_seleccionadas_ids[nombre_tabla].includes(checkbox.id)) {\n            compras_seleccionadas_ids[nombre_tabla].push(parseInt(checkbox.id));\n        }\n    });\n}\n\n/**\n * Establecer el evento para el botón de descarga del archivo Excel.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction establecerEventoDescargarComprasExcel(nombre_tabla) {\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).off('click');\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).on('click', () => {\n        if (nombre_tabla === 'creditos') {\n            descargarExcelCreditos();\n            return;\n        }\n        let empresas_planes_ids = compras_seleccionadas_ids[nombre_tabla].length ? [...compras_seleccionadas_ids[nombre_tabla]] : [...compras_ids[nombre_tabla]];\n        descargarExcel(\n            'planes-historial-recompras-exportar',\n            `compras_${nombre_tabla}`,\n            true,\n            empresas_planes_ids.length ? { empresas_planes_ids, empresa_id } : { empresa_id }\n        );\n    });\n}\n\n/**\n * Descargar Excel del historial de créditos de IA.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction descargarExcelCreditos() {\n    descargarExcel(\n        `planes-historial-creditos-exportar/${empresa_id}`,\n        'historial_creditos_ia',\n        true,\n        {}\n    );\n}\n\n/**\n * Procesar los filtros de las tablas de compras.\n *\n * @param {Object} json_filtros Filtros aplicados del dropdown\n * @param {string} tabla Nombre de la tabla\n * @returns {Object} Datos procesados para enviar al backend\n * @author Andres Morales\n */\nfunction procesarFiltrosTabla(json_filtros, tabla) {\n    let datos = {};\n\n    if (json_filtros[`estado_plan_filtro_${tabla}`]) {\n        datos.estado_id = json_filtros[`estado_plan_filtro_${tabla}`];\n    }\n\n    if (json_filtros[`duracion_filtro_${tabla}`]) {\n        datos.duracion = json_filtros[`duracion_filtro_${tabla}`];\n    }\n\n    if (tabla === 'creditos') {\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaCompra = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaCompra[0]) {\n                datos.created_at_desde = normalizarFechaFiltro(partesFechaCompra[0]);\n            }\n            if (partesFechaCompra[1]) {\n                datos.created_at_hasta = normalizarFechaFiltro(partesFechaCompra[1]);\n            }\n        }\n    } else {\n        if (json_filtros[`fecha_vencimiento_filtro_${tabla}`] && typeof json_filtros[`fecha_vencimiento_filtro_${tabla}`] === 'string') {\n            const partesFechaVencimiento = json_filtros[`fecha_vencimiento_filtro_${tabla}`].split(' a ');\n            if (partesFechaVencimiento[0]) {\n                datos.fecha_vencimiento_desde = normalizarFechaFiltro(partesFechaVencimiento[0]);\n            }\n            if (partesFechaVencimiento[1]) {\n                datos.fecha_vencimiento_hasta = normalizarFechaFiltro(partesFechaVencimiento[1]);\n            }\n        }\n\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaActivacion = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaActivacion[0]) {\n                datos.fecha_inicio_desde = normalizarFechaFiltro(partesFechaActivacion[0]);\n            }\n            if (partesFechaActivacion[1]) {\n                datos.fecha_inicio_hasta = normalizarFechaFiltro(partesFechaActivacion[1]);\n            }\n        }\n    }\n\n    return datos;\n}\n\n/**\n * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n *\n * @param {string} filtro ID del elemento html del filtro\n * @param {Object} filtros Filtros aplicados\n * @returns {void}\n * @author Andres Morales\n */\nfunction aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n    }\n}\n\nwindow.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\nwindow.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n\nif (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n    };\n    window.aplicarFiltrosDropdown.__esDispatcher = true;\n}\n","structuredPatch":[{"oldStart":100,"oldLines":10,"newStart":100,"newLines":30,"lines":["     $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });","     $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });","     $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });","-    $(document).on('input', '#filtro_dropdown_seleccion', function () { busqueda_tablas.seleccion = this.value; aplicarBusquedaTabla('seleccion', this.value); });","-    $(document).on('input', '#filtro_dropdown_organizacional', function () { busqueda_tablas.organizacional = this.value; aplicarBusquedaTabla('organizacional', this.value); });","-    $(document).on('input', '#filtro_dropdown_vocacional', function () { busqueda_tablas.vocacional = this.value; aplicarBusquedaTabla('vocacional', this.value); });","-    $(document).on('input', '#filtro_dropdown_creditos', function () { busqueda_tablas.creditos = this.value; aplicarBusquedaTabla('creditos', this.value); });","+    $(document).on('input', '#filtro_dropdown_seleccion', function () {","+        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_seleccion');","+        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');","+        busqueda_tablas.seleccion = valor_combinado;","+        aplicarBusquedaTabla('seleccion', valor_combinado);","+    });","+    $(document).on('input', '#filtro_dropdown_organizacional', function () {","+        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_organizacional');","+        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');","+        busqueda_tablas.organizacional = valor_combinado;","+        aplicarBusquedaTabla('organizacional', valor_combinado);","+    });","+    $(document).on('input', '#filtro_dropdown_vocacional', function () {","+        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_vocacional');","+        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');","+        busqueda_tablas.vocacional = valor_combinado;","+        aplicarBusquedaTabla('vocacional', valor_combinado);","+    });","+    $(document).on('input', '#filtro_dropdown_creditos', function () {","+        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_creditos');","+        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');","+        busqueda_tablas.creditos = valor_combinado;","+        aplicarBusquedaTabla('creditos', valor_combinado);","+    });","     $(document).on('keydown', '#filtro_dropdown_seleccion, #filtro_dropdown_organizacional, #filtro_dropdown_vocacional, #filtro_dropdown_creditos', function (event) {","         if (event.key === 'Enter') {","             event.preventDefault();"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"0e7025c3-a74c-43e9-8b3c-cffab8253cb1"}
{"parentUuid":"ffc2826f-062f-48aa-b74e-b1e47c96e27b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VUJuJXue7pomBXHqQ2Sjpn","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a modificar la función `aplicarFiltrosDropdownRecompras` para agregar el `setTimeout` que actualiza la búsqueda con chips:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":904,"cache_read_input_tokens":48084,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":904},"output_tokens":9,"service_tier":"standard"}},"requestId":"req_011CXcJkgE6T9J7VYTQesSQ8","type":"assistant","uuid":"d18f10f9-c991-4754-ae71-cc37b3db333c","timestamp":"2026-01-29T20:33:25.176Z"}
{"parentUuid":"d18f10f9-c991-4754-ae71-cc37b3db333c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VUJuJXue7pomBXHqQ2Sjpn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Qtax9theyqZiLCXC1LLJmR","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","old_string":"function aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n    }\n}","new_string":"function aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('seleccion'), 100);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('organizacional'), 100);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('vocacional'), 100);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('creditos'), 100);\n    }\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":904,"cache_read_input_tokens":48084,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":904},"output_tokens":9,"service_tier":"standard"}},"requestId":"req_011CXcJkgE6T9J7VYTQesSQ8","type":"assistant","uuid":"cc5629c8-5d4e-4643-ad68-5325692f088e","timestamp":"2026-01-29T20:33:35.656Z"}
{"parentUuid":"cc5629c8-5d4e-4643-ad68-5325692f088e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Qtax9theyqZiLCXC1LLJmR","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js has been updated successfully."}]},"uuid":"2566b0ba-38f3-428e-9071-22e2871b65ce","timestamp":"2026-01-29T20:33:36.526Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","oldString":"function aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n    }\n}","newString":"function aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('seleccion'), 100);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('organizacional'), 100);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('vocacional'), 100);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('creditos'), 100);\n    }\n}","originalFile":"\nconst MODAL_FILTROS_AVANZADOS_COMPRAS_ID = 'modal-filtros-avanzados-compras';\nconst MODAL_HISTORIAL_COMPRAS_ID = 'modal-historial-recompras';\n\nconst FILTRO_DURACION_ID = 'filtro-duracion';\nconst FILTRO_FECHA_ACTIVACION_ID = 'filtro-fecha-activacion';\nconst FILTRO_FECHA_VENCIMIENTO_ID = 'filtro-fecha-vencimiento';\nconst FILTRO_ESTADO_PLAN_ID = 'filtro-estado-plan';\n\nconst normalizarFechaFiltro = fecha => {\n    if (!fecha || typeof fecha !== 'string') return fecha;\n    const limpio = fecha.trim();\n    if (!limpio) return limpio;\n    const separador = limpio.includes('/') ? '/' : (limpio.includes('-') ? '-' : null);\n    if (!separador) return limpio;\n    const partes = limpio.split(separador);\n    if (partes.length < 3) return limpio;\n    let dia = '';\n    let mes = '';\n    let anio = '';\n    if (partes[0].length === 4) {\n        anio = partes[0];\n        mes = partes[1];\n        dia = partes[2];\n    } else if (partes[2].length === 4) {\n        dia = partes[0];\n        mes = partes[1];\n        anio = partes[2];\n    } else {\n        return limpio;\n    }\n    return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;\n};\n\nlet compras_seleccionadas_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] };\n\nlet compras_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] }\n\nlet compras = [];\n\n// Variables globales para filtros de cada tabla\nlet filtros_seleccion = {};\nlet filtros_organizacional = {};\nlet filtros_vocacional = {};\nlet filtros_creditos = {};\n\nlet filtro_html_seleccion = '';\nlet filtro_html_organizacional = '';\nlet filtro_html_vocacional = '';\nlet filtro_html_creditos = '';\nlet busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n\n/**\n * Obtener la busqueda combinada de chips activos.\n *\n * @param {string} id_input ID del input de filtro\n * @returns {string} Texto combinado de los chips separados por espacio\n * @author Sergio Vargas\n */\nfunction obtenerBusquedaChips(id_input) {\n    let componentes_chips_storage = localStorage.getItem('componentes_chips_storage');\n    if (componentes_chips_storage == null) return '';\n\n    componentes_chips_storage = JSON.parse(componentes_chips_storage);\n    if (componentes_chips_storage[window.location.pathname] == null) return '';\n    if (componentes_chips_storage[window.location.pathname][id_input] == null) return '';\n\n    let chips = componentes_chips_storage[window.location.pathname][id_input].chips;\n    return chips.join(' ');\n}\n\n/**\n * Actualizar la busqueda de la tabla con los chips activos.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction actualizarBusquedaConChips(nombre_tabla) {\n    const id_input = `filtro_dropdown_${nombre_tabla}`;\n    const busqueda_chips = obtenerBusquedaChips(id_input);\n    const valor_input = $(`#${id_input}`).val() || '';\n\n    let busqueda_combinada = '';\n    if (valor_input && busqueda_chips) {\n        busqueda_combinada = valor_input + ' ' + busqueda_chips;\n    } else if (valor_input) {\n        busqueda_combinada = valor_input;\n    } else if (busqueda_chips) {\n        busqueda_combinada = busqueda_chips;\n    }\n\n    busqueda_tablas[nombre_tabla] = busqueda_combinada;\n    aplicarBusquedaTabla(nombre_tabla, busqueda_combinada);\n}\n\n$(document).ready(() => {\n    $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));\n    $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });\n    $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });\n    $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });\n    $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });\n    $(document).on('input', '#filtro_dropdown_seleccion', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_seleccion');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.seleccion = valor_combinado;\n        aplicarBusquedaTabla('seleccion', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_organizacional', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_organizacional');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.organizacional = valor_combinado;\n        aplicarBusquedaTabla('organizacional', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_vocacional', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_vocacional');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.vocacional = valor_combinado;\n        aplicarBusquedaTabla('vocacional', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_creditos', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_creditos');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.creditos = valor_combinado;\n        aplicarBusquedaTabla('creditos', valor_combinado);\n    });\n    $(document).on('keydown', '#filtro_dropdown_seleccion, #filtro_dropdown_organizacional, #filtro_dropdown_vocacional, #filtro_dropdown_creditos', function (event) {\n        if (event.key === 'Enter') {\n            event.preventDefault();\n            event.stopPropagation();\n        }\n    });\n\n});\n\n/**\n * Renderiza la modal de historial de compras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {boolean} recarga verifica si tiene que recargar.\n * @param {string} tabla nombre de la tabla.\n * @param {string} filtro filtros para la busqueda.\n * @returns {void}\n * @author Andres Morales\n * @author Jair Carvajal\n */\nasync function modalHistorialCompras(id_empresa, recarga = false, tabla = '', filtro = {}) {\n    let historial_compras = await getHistorialCompras(id_empresa, filtro);\n\n    if (tabla === '' || tabla === 'seleccion') {\n        await renderizarTablas(historial_compras[1], 'seleccion');\n        establecerEventoDescargarComprasExcel('seleccion');\n    }\n\n    if (tabla === '' || tabla === 'organizacional') {\n        await renderizarTablas(historial_compras[2], 'organizacional');\n        establecerEventoDescargarComprasExcel('organizacional');\n    }\n\n    if (tabla === '' || tabla === 'vocacional') {\n        await renderizarTablas(historial_compras[3], 'vocacional');\n        establecerEventoDescargarComprasExcel('vocacional');\n    }\n\n    if (tabla === '' || tabla === 'creditos') {\n        let historial_creditos = await getHistorialComprasCreditos(id_empresa, filtro);\n        await renderizarTablaCreditos(historial_creditos, 'creditos');\n        establecerEventoDescargarComprasExcel('creditos');\n    }\n\n    if (!recarga) {\n        $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n    }\n\n    cargarDataTablas();\n    inicializarTooltips();\n}\n\n\n/**\n * Obtener historial de recompras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @returns {array}\n * @author Daniel Beltrán\n * @author Andres Morales\n */\nasync function getHistorialCompras(empresa_id, filtros = {}) {\n    let datos = [];\n    let agrupadosPorTipoPrueba = {\n        1: [],\n        2: [],\n        3: [],\n    };\n    await $.ajax({\n        type: 'GET',\n        url : `/planes-historial-recompras/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n        datos.forEach(item => {\n            let tipoPruebaNombre = item.plan.tipo_prueba.id;\n            agrupadosPorTipoPrueba[tipoPruebaNombre].push(item);\n        });\n    }).catch((error) => {\n        console.error(error);\n    });\n    return agrupadosPorTipoPrueba;\n}\n\n/**\n * Obtener historial de compras de planes con creditos.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {Object} filtros Filtros aplicados.\n * @returns {array}\n * @author Sergio Vargas\n * @author Jair Carvajal\n */\nasync function getHistorialComprasCreditos(empresa_id, filtros = {}) {\n    let datos = [];\n\n    await $.ajax({\n        type: 'GET',\n        url: `/planes-historial-recompras-creditos/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Renderiza las distintas tablas de compras.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Andres Morales\n * @author Jair Carvajal\n */\nasync function renderizarTablas(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = [];\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n    let totalUnidades = datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_agendas || 0), 0);\n    let totalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_ofertas_laborales || 0), 0);\n    let baseTotalUnidades =  datos_entrada.reduce((total, dato) => total + (dato.unidades || 0), 0);\n    let baseTotalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.cantidad_ofertas_laborales || 0), 0);\n    $(`#${nombre_tabla}-totales-unidades`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>${crearProgressBar({ label: `${totalUnidades}/${baseTotalUnidades}`,height: '8px', porcentaje: {porcentaje: (totalUnidades / (baseTotalUnidades ?? 1)) * 100, texto:false }})}`);\n    $(`#${nombre_tabla}-totales-ofertas`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>${crearProgressBar({ label: `${totalOfertas}/${baseTotalOfertas}`,height: '8px', porcentaje: {porcentaje: (totalOfertas / (baseTotalOfertas ?? 1)) * 100, texto:false }})}`);\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n             },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n                                data: [{ texto: 'id', value: dato.id }],\n                            })}\n                        </div>\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan.nombre}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias} dias</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-box\"></i> Consumo unidades</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUnidades(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_agendas, dato.unidades ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-briefcase\"></i> Consumo vacantes</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoOfertas(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_ofertas_laborales, dato.cantidad_ofertas_laborales ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-person\"></i> Consumo usuarios</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUsuarios(usuarios)}>${crearProgressBarTemplate('', false, total_usuarios, dato.cantidad_usuarios ?? 0, false)}</div>`,\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumos(${dato.id}, '${dato.plan.nombre}', '${dato.plan.tipo_prueba.nombre}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n}\n\n/**\n * Renderiza la tabla de compras de creditos.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Sergio Vargas\n */\nasync function renderizarTablaCreditos(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n\n    let total_consumidos = datos_entrada.reduce((total, dato) => total + (dato.creditos_consumidos || 0), 0);\n    let total_creditos = datos_entrada.reduce((total, dato) => total + (dato.creditos_totales || 0), 0);\n    let porcentaje_total = total_creditos > 0 ? (total_consumidos / total_creditos) * 100 : 0;\n\n    $('#creditos-totales')\n        .empty()\n        .append(`\n            <p class=\"text-label-2 mb-1\"><img class=\"me-2\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\">Créditos totales</p>\n            ${crearProgressBar({ label: `${formatearNumero(total_consumidos)}/${formatearNumero(total_creditos)}`, height: '8px', porcentaje: { porcentaje: porcentaje_total, texto: false }})}\n        `);\n\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan_credito?.nombre ?? '---'}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias ? `${dato.vigencia_dias} dias` : 'Sin tiempo'}</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><img class=\"me-1\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\"> Consumo créditos</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => {\n                    let total = dato.creditos_totales ?? 0;\n                    let consumidos = dato.creditos_consumidos ?? 0;\n                    return `${crearProgressBarTemplate('', false, consumidos, total, false)}`;\n                },\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumosCreditos(${dato.empresa_id}, ${dato.id}, '${dato.plan_credito?.nombre ?? ''}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n}\n\nfunction aplicarBusquedaTabla(nombre_tabla, valor) {\n    const selector = `#tabla-compras-${nombre_tabla}`;\n    if (!$.fn.DataTable.isDataTable(selector)) return;\n    $(selector).DataTable().search(valor || '').draw();\n}\n\n/**\n * Renderiza el contenido de las subtablas.\n *\n * @param {array} data Array de datos a renderizar.\n * @returns {string} HTML de la subtabla.\n * @author Andres Morales\n */\nfunction crearContenidoSubTabla(data) {\n    let pruebas_html = \"\";\n    data.pruebas.forEach(prueba => {\n        pruebas_html += `\n            <div class=\"col-12 my-2 col-md-6 d-flex justify-content-start align-items-center gap-3\">\n                <img src=\"/imagenes/logos/pruebas/${slugify(prueba.nombre)}.png\" width=\"32px\" height=\"32px\" class=\"object-fit-cover\" alt=\"Logo prueba\">\n                <p class=\"mb-0 text-label-2\">${prueba.nombre}</p>\n            </div>\n        `;\n    });\n\n    let funcionalidades_predeterminadas_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (funcionalidad.predeterminado) funcionalidades_predeterminadas_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    let funcionalidades_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (!funcionalidad.predeterminado) funcionalidades_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    return `\n        <div class=\"row w-100 my-3 ps-8\">\n            <div class=\"col-4\">\n                <p class=\"text-body-3 fw-bolder\">Pruebas</p>\n                <div class=\"row\">\n                    ${pruebas_html}\n                </div>\n            </div>\n            <div class=\"col-8\">\n                <div class=\"container-fluid\">\n                    <div class=\"row border-bottom pb-2\">\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Costo:</span> <br> $ ${formatearNumero(data.precio)}</p>\n                        </div>\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Descuento:</span> <br> ${data.porcentaje_descuento !== 0 ? data.porcentaje_descuento + '%' : `Sin descuento`}</p>\n                        </div>\n                         <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Valor de venta:</span> <br> $ ${data.porcentaje_descuento !== 0 ? formatearNumero(data.precio * (1 - (data.porcentaje_descuento / 100))) : formatearNumero(data.precio) }</p>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios adicionales</p>\n                        </div>\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios predefinidos</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_html}</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_predeterminadas_html}</p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Generar el tooltip de consumo de unidades.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUnidades(consumos) {\n    var agrupado = consumos.reduce((acc, item) => {\n        if(item.agenda && item.agenda.prueba) {\n          var { id, nombre } = item.agenda.prueba;\n          var key = `${id}-${nombre}`;\n          if(!acc[key]) {\n            acc[key] = { prueba_id: id, prueba_nombre: nombre, cantidad: 0 };\n          }\n          acc[key].cantidad++;\n        }\n        return acc;\n    }, {});\n\n    var resultado = Object.values(agrupado);\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white'>Cantidad consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white'>\n                        <img src='/imagenes/logos/pruebas/${slugify(item.prueba_nombre)}.png' width='22px' height='22px' class='object-fit-cover me-2' alt='>\n                    </span>\n                    <span class='text-body-3 text-white'>\n                        ${item.prueba_nombre}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white me-3'>Cantidad consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de ofertas.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoOfertas(consumos) {\n    const resultado = Object.values(\n        consumos.filter(item => item.oferta_laboral_id !== null).reduce((acc, item) => {\n            const key = `${item.empresa.id}-${item.empresa.nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: item.empresa.id,\n                empresa_nombre_comercial: item.empresa.nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            return acc;\n        }, {})\n    );\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.empresa_nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de usuarios.\n *\n * @param {array} usuarios Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUsuarios(usuarios) {\n    const agrupado = usuarios.reduce((acc, usuario) => {\n        if (Array.isArray(usuario.empresas_usuarios)) {\n          // Recorremos las empresas del usuario y contamos sólo la primera que no tenga id 1\n          for (let i = 0; i < usuario.empresas_usuarios.length; i++) {\n            const { id, nombre_comercial } = usuario.empresas_usuarios[i].empresa;\n            if (id === 1) continue; // omitir la empresa con id 1\n            const key = `${id}-${nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: id,\n                nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            // Una vez que se cuenta el usuario para una empresa, salimos del ciclo\n            break;\n          }\n        }\n        return acc;\n      }, {});\n\n      const resultado = Object.values(agrupado);\n\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Aplicar los filtros a las compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction aplicarFiltrosAvanzadosCompras() {\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Abrir el modal de filtros de compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalFiltrosAvanzadosCompras() {\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Seleccionar una compra.\n *\n * @param {boolean} seleccion Selección.\n * @param {number} compra_id Id de la compra seleccionada.\n * @param {string} tabla_compras_id Id del elemento html de la tabla de compras.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction seleccionarCompra(seleccion, compra_id, tabla_compras_id, nombre_tabla) {\n    if (seleccion) {\n        compras_seleccionadas_ids[nombre_tabla].push(parseInt(compra_id));\n    } else {\n        let indice = compras_seleccionadas_ids[nombre_tabla].indexOf(compra_id);\n        if (indice !== -1) compras_seleccionadas_ids[nombre_tabla].splice(indice, 1);\n    }\n\n    let checkbox_seleccionar_todos = $(`#checkbox-seleccionar-todos-${tabla_compras_id}`);\n    if (compras_seleccionadas_ids[nombre_tabla].length === compras_ids[nombre_tabla].length) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', true);\n    } else if (compras_seleccionadas_ids[nombre_tabla].length === 0) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', false);\n    } else {\n        checkbox_seleccionar_todos.prop('indeterminate', true);\n    }\n}\n\n/**\n * Seleccionar todas las compras.\n *\n * @param {boolean} seleccion Selección\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nfunction seleccionarTodasCompras(seleccion, nombre_tabla) {\n    if (!seleccion) compras_seleccionadas_ids[nombre_tabla] = [];\n    let checkboxes_compras = $(`#tabla-compras-${nombre_tabla}`).find(\".checkbox-compra\").toArray();\n    checkboxes_compras.forEach(checkbox => {\n        checkbox.checked = seleccion;\n        if (seleccion && !compras_seleccionadas_ids[nombre_tabla].includes(checkbox.id)) {\n            compras_seleccionadas_ids[nombre_tabla].push(parseInt(checkbox.id));\n        }\n    });\n}\n\n/**\n * Establecer el evento para el botón de descarga del archivo Excel.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction establecerEventoDescargarComprasExcel(nombre_tabla) {\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).off('click');\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).on('click', () => {\n        if (nombre_tabla === 'creditos') {\n            descargarExcelCreditos();\n            return;\n        }\n        let empresas_planes_ids = compras_seleccionadas_ids[nombre_tabla].length ? [...compras_seleccionadas_ids[nombre_tabla]] : [...compras_ids[nombre_tabla]];\n        descargarExcel(\n            'planes-historial-recompras-exportar',\n            `compras_${nombre_tabla}`,\n            true,\n            empresas_planes_ids.length ? { empresas_planes_ids, empresa_id } : { empresa_id }\n        );\n    });\n}\n\n/**\n * Descargar Excel del historial de créditos de IA.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction descargarExcelCreditos() {\n    descargarExcel(\n        `planes-historial-creditos-exportar/${empresa_id}`,\n        'historial_creditos_ia',\n        true,\n        {}\n    );\n}\n\n/**\n * Procesar los filtros de las tablas de compras.\n *\n * @param {Object} json_filtros Filtros aplicados del dropdown\n * @param {string} tabla Nombre de la tabla\n * @returns {Object} Datos procesados para enviar al backend\n * @author Andres Morales\n */\nfunction procesarFiltrosTabla(json_filtros, tabla) {\n    let datos = {};\n\n    if (json_filtros[`estado_plan_filtro_${tabla}`]) {\n        datos.estado_id = json_filtros[`estado_plan_filtro_${tabla}`];\n    }\n\n    if (json_filtros[`duracion_filtro_${tabla}`]) {\n        datos.duracion = json_filtros[`duracion_filtro_${tabla}`];\n    }\n\n    if (tabla === 'creditos') {\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaCompra = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaCompra[0]) {\n                datos.created_at_desde = normalizarFechaFiltro(partesFechaCompra[0]);\n            }\n            if (partesFechaCompra[1]) {\n                datos.created_at_hasta = normalizarFechaFiltro(partesFechaCompra[1]);\n            }\n        }\n    } else {\n        if (json_filtros[`fecha_vencimiento_filtro_${tabla}`] && typeof json_filtros[`fecha_vencimiento_filtro_${tabla}`] === 'string') {\n            const partesFechaVencimiento = json_filtros[`fecha_vencimiento_filtro_${tabla}`].split(' a ');\n            if (partesFechaVencimiento[0]) {\n                datos.fecha_vencimiento_desde = normalizarFechaFiltro(partesFechaVencimiento[0]);\n            }\n            if (partesFechaVencimiento[1]) {\n                datos.fecha_vencimiento_hasta = normalizarFechaFiltro(partesFechaVencimiento[1]);\n            }\n        }\n\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaActivacion = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaActivacion[0]) {\n                datos.fecha_inicio_desde = normalizarFechaFiltro(partesFechaActivacion[0]);\n            }\n            if (partesFechaActivacion[1]) {\n                datos.fecha_inicio_hasta = normalizarFechaFiltro(partesFechaActivacion[1]);\n            }\n        }\n    }\n\n    return datos;\n}\n\n/**\n * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n *\n * @param {string} filtro ID del elemento html del filtro\n * @param {Object} filtros Filtros aplicados\n * @returns {void}\n * @author Andres Morales\n */\nfunction aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n    }\n}\n\nwindow.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\nwindow.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n\nif (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n    };\n    window.aplicarFiltrosDropdown.__esDispatcher = true;\n}\n","structuredPatch":[{"oldStart":915,"oldLines":21,"newStart":915,"newLines":25,"lines":["         filtros_seleccion = filtros;","         filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');","         modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);","+        setTimeout(() => actualizarBusquedaConChips('seleccion'), 100);","     } else if (filtro === 'filtro_dropdown_organizacional') {","         filtro_html_organizacional = filtro;","         filtros_organizacional = filtros;","         filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');","         modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);","+        setTimeout(() => actualizarBusquedaConChips('organizacional'), 100);","     } else if (filtro === 'filtro_dropdown_vocacional') {","         filtro_html_vocacional = filtro;","         filtros_vocacional = filtros;","         filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');","         modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);","+        setTimeout(() => actualizarBusquedaConChips('vocacional'), 100);","     } else if (filtro === 'filtro_dropdown_creditos') {","         filtro_html_creditos = filtro;","         filtros_creditos = filtros;","         filtros_generados = procesarFiltrosTabla(filtros, 'creditos');","         modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);","+        setTimeout(() => actualizarBusquedaConChips('creditos'), 100);","     }"," }"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"cc5629c8-5d4e-4643-ad68-5325692f088e"}
{"parentUuid":"2566b0ba-38f3-428e-9071-22e2871b65ce","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QZZPJ4mrA5Joam3iaGx1Ub","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a agregar la función `restablecerFiltrosDropdownAdicional` al final del archivo:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1269,"cache_read_input_tokens":48988,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1269},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXcJmrUGJBTV7owvd8qTs","type":"assistant","uuid":"bc456d18-1789-477d-9191-39d31ff72df9","timestamp":"2026-01-29T20:33:39.649Z"}
{"parentUuid":"bc456d18-1789-477d-9191-39d31ff72df9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QZZPJ4mrA5Joam3iaGx1Ub","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019UDbdnKhZTwgFwngSvSW9z","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","old_string":"window.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\nwindow.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n\nif (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n    };\n    window.aplicarFiltrosDropdown.__esDispatcher = true;\n}","new_string":"/**\n * Funcion para restablecer filtros adicionales - limpia la busqueda de las tablas.\n *\n * @param {string} input_id ID del input de filtro\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction restablecerFiltrosDropdownAdicional(input_id) {\n    const mapa_tablas = {\n        'filtro_dropdown_seleccion': 'seleccion',\n        'filtro_dropdown_organizacional': 'organizacional',\n        'filtro_dropdown_vocacional': 'vocacional',\n        'filtro_dropdown_creditos': 'creditos'\n    };\n\n    const nombre_tabla = mapa_tablas[input_id];\n    if (nombre_tabla) {\n        busqueda_tablas[nombre_tabla] = '';\n        aplicarBusquedaTabla(nombre_tabla, '');\n    }\n}\n\nwindow.restablecerFiltrosDropdownAdicional = restablecerFiltrosDropdownAdicional;\n\nwindow.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\nwindow.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n\nif (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n    };\n    window.aplicarFiltrosDropdown.__esDispatcher = true;\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1269,"cache_read_input_tokens":48988,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1269},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXcJmrUGJBTV7owvd8qTs","type":"assistant","uuid":"85780d78-6930-47de-a50a-5964836aefee","timestamp":"2026-01-29T20:33:47.528Z"}
{"parentUuid":"85780d78-6930-47de-a50a-5964836aefee","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019UDbdnKhZTwgFwngSvSW9z","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js has been updated successfully."}]},"uuid":"15e0a352-5064-40b0-99b2-f4635020f9a4","timestamp":"2026-01-29T20:33:48.255Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","oldString":"window.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\nwindow.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n\nif (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n    };\n    window.aplicarFiltrosDropdown.__esDispatcher = true;\n}","newString":"/**\n * Funcion para restablecer filtros adicionales - limpia la busqueda de las tablas.\n *\n * @param {string} input_id ID del input de filtro\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction restablecerFiltrosDropdownAdicional(input_id) {\n    const mapa_tablas = {\n        'filtro_dropdown_seleccion': 'seleccion',\n        'filtro_dropdown_organizacional': 'organizacional',\n        'filtro_dropdown_vocacional': 'vocacional',\n        'filtro_dropdown_creditos': 'creditos'\n    };\n\n    const nombre_tabla = mapa_tablas[input_id];\n    if (nombre_tabla) {\n        busqueda_tablas[nombre_tabla] = '';\n        aplicarBusquedaTabla(nombre_tabla, '');\n    }\n}\n\nwindow.restablecerFiltrosDropdownAdicional = restablecerFiltrosDropdownAdicional;\n\nwindow.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\nwindow.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n\nif (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n    };\n    window.aplicarFiltrosDropdown.__esDispatcher = true;\n}","originalFile":"\nconst MODAL_FILTROS_AVANZADOS_COMPRAS_ID = 'modal-filtros-avanzados-compras';\nconst MODAL_HISTORIAL_COMPRAS_ID = 'modal-historial-recompras';\n\nconst FILTRO_DURACION_ID = 'filtro-duracion';\nconst FILTRO_FECHA_ACTIVACION_ID = 'filtro-fecha-activacion';\nconst FILTRO_FECHA_VENCIMIENTO_ID = 'filtro-fecha-vencimiento';\nconst FILTRO_ESTADO_PLAN_ID = 'filtro-estado-plan';\n\nconst normalizarFechaFiltro = fecha => {\n    if (!fecha || typeof fecha !== 'string') return fecha;\n    const limpio = fecha.trim();\n    if (!limpio) return limpio;\n    const separador = limpio.includes('/') ? '/' : (limpio.includes('-') ? '-' : null);\n    if (!separador) return limpio;\n    const partes = limpio.split(separador);\n    if (partes.length < 3) return limpio;\n    let dia = '';\n    let mes = '';\n    let anio = '';\n    if (partes[0].length === 4) {\n        anio = partes[0];\n        mes = partes[1];\n        dia = partes[2];\n    } else if (partes[2].length === 4) {\n        dia = partes[0];\n        mes = partes[1];\n        anio = partes[2];\n    } else {\n        return limpio;\n    }\n    return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;\n};\n\nlet compras_seleccionadas_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] };\n\nlet compras_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] }\n\nlet compras = [];\n\n// Variables globales para filtros de cada tabla\nlet filtros_seleccion = {};\nlet filtros_organizacional = {};\nlet filtros_vocacional = {};\nlet filtros_creditos = {};\n\nlet filtro_html_seleccion = '';\nlet filtro_html_organizacional = '';\nlet filtro_html_vocacional = '';\nlet filtro_html_creditos = '';\nlet busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n\n/**\n * Obtener la busqueda combinada de chips activos.\n *\n * @param {string} id_input ID del input de filtro\n * @returns {string} Texto combinado de los chips separados por espacio\n * @author Sergio Vargas\n */\nfunction obtenerBusquedaChips(id_input) {\n    let componentes_chips_storage = localStorage.getItem('componentes_chips_storage');\n    if (componentes_chips_storage == null) return '';\n\n    componentes_chips_storage = JSON.parse(componentes_chips_storage);\n    if (componentes_chips_storage[window.location.pathname] == null) return '';\n    if (componentes_chips_storage[window.location.pathname][id_input] == null) return '';\n\n    let chips = componentes_chips_storage[window.location.pathname][id_input].chips;\n    return chips.join(' ');\n}\n\n/**\n * Actualizar la busqueda de la tabla con los chips activos.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction actualizarBusquedaConChips(nombre_tabla) {\n    const id_input = `filtro_dropdown_${nombre_tabla}`;\n    const busqueda_chips = obtenerBusquedaChips(id_input);\n    const valor_input = $(`#${id_input}`).val() || '';\n\n    let busqueda_combinada = '';\n    if (valor_input && busqueda_chips) {\n        busqueda_combinada = valor_input + ' ' + busqueda_chips;\n    } else if (valor_input) {\n        busqueda_combinada = valor_input;\n    } else if (busqueda_chips) {\n        busqueda_combinada = busqueda_chips;\n    }\n\n    busqueda_tablas[nombre_tabla] = busqueda_combinada;\n    aplicarBusquedaTabla(nombre_tabla, busqueda_combinada);\n}\n\n$(document).ready(() => {\n    $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));\n    $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });\n    $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });\n    $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });\n    $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });\n    $(document).on('input', '#filtro_dropdown_seleccion', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_seleccion');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.seleccion = valor_combinado;\n        aplicarBusquedaTabla('seleccion', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_organizacional', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_organizacional');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.organizacional = valor_combinado;\n        aplicarBusquedaTabla('organizacional', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_vocacional', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_vocacional');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.vocacional = valor_combinado;\n        aplicarBusquedaTabla('vocacional', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_creditos', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_creditos');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.creditos = valor_combinado;\n        aplicarBusquedaTabla('creditos', valor_combinado);\n    });\n    $(document).on('keydown', '#filtro_dropdown_seleccion, #filtro_dropdown_organizacional, #filtro_dropdown_vocacional, #filtro_dropdown_creditos', function (event) {\n        if (event.key === 'Enter') {\n            event.preventDefault();\n            event.stopPropagation();\n        }\n    });\n\n});\n\n/**\n * Renderiza la modal de historial de compras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {boolean} recarga verifica si tiene que recargar.\n * @param {string} tabla nombre de la tabla.\n * @param {string} filtro filtros para la busqueda.\n * @returns {void}\n * @author Andres Morales\n * @author Jair Carvajal\n */\nasync function modalHistorialCompras(id_empresa, recarga = false, tabla = '', filtro = {}) {\n    let historial_compras = await getHistorialCompras(id_empresa, filtro);\n\n    if (tabla === '' || tabla === 'seleccion') {\n        await renderizarTablas(historial_compras[1], 'seleccion');\n        establecerEventoDescargarComprasExcel('seleccion');\n    }\n\n    if (tabla === '' || tabla === 'organizacional') {\n        await renderizarTablas(historial_compras[2], 'organizacional');\n        establecerEventoDescargarComprasExcel('organizacional');\n    }\n\n    if (tabla === '' || tabla === 'vocacional') {\n        await renderizarTablas(historial_compras[3], 'vocacional');\n        establecerEventoDescargarComprasExcel('vocacional');\n    }\n\n    if (tabla === '' || tabla === 'creditos') {\n        let historial_creditos = await getHistorialComprasCreditos(id_empresa, filtro);\n        await renderizarTablaCreditos(historial_creditos, 'creditos');\n        establecerEventoDescargarComprasExcel('creditos');\n    }\n\n    if (!recarga) {\n        $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n    }\n\n    cargarDataTablas();\n    inicializarTooltips();\n}\n\n\n/**\n * Obtener historial de recompras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @returns {array}\n * @author Daniel Beltrán\n * @author Andres Morales\n */\nasync function getHistorialCompras(empresa_id, filtros = {}) {\n    let datos = [];\n    let agrupadosPorTipoPrueba = {\n        1: [],\n        2: [],\n        3: [],\n    };\n    await $.ajax({\n        type: 'GET',\n        url : `/planes-historial-recompras/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n        datos.forEach(item => {\n            let tipoPruebaNombre = item.plan.tipo_prueba.id;\n            agrupadosPorTipoPrueba[tipoPruebaNombre].push(item);\n        });\n    }).catch((error) => {\n        console.error(error);\n    });\n    return agrupadosPorTipoPrueba;\n}\n\n/**\n * Obtener historial de compras de planes con creditos.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {Object} filtros Filtros aplicados.\n * @returns {array}\n * @author Sergio Vargas\n * @author Jair Carvajal\n */\nasync function getHistorialComprasCreditos(empresa_id, filtros = {}) {\n    let datos = [];\n\n    await $.ajax({\n        type: 'GET',\n        url: `/planes-historial-recompras-creditos/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Renderiza las distintas tablas de compras.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Andres Morales\n * @author Jair Carvajal\n */\nasync function renderizarTablas(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = [];\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n    let totalUnidades = datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_agendas || 0), 0);\n    let totalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_ofertas_laborales || 0), 0);\n    let baseTotalUnidades =  datos_entrada.reduce((total, dato) => total + (dato.unidades || 0), 0);\n    let baseTotalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.cantidad_ofertas_laborales || 0), 0);\n    $(`#${nombre_tabla}-totales-unidades`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>${crearProgressBar({ label: `${totalUnidades}/${baseTotalUnidades}`,height: '8px', porcentaje: {porcentaje: (totalUnidades / (baseTotalUnidades ?? 1)) * 100, texto:false }})}`);\n    $(`#${nombre_tabla}-totales-ofertas`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>${crearProgressBar({ label: `${totalOfertas}/${baseTotalOfertas}`,height: '8px', porcentaje: {porcentaje: (totalOfertas / (baseTotalOfertas ?? 1)) * 100, texto:false }})}`);\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n             },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n                                data: [{ texto: 'id', value: dato.id }],\n                            })}\n                        </div>\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan.nombre}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias} dias</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-box\"></i> Consumo unidades</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUnidades(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_agendas, dato.unidades ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-briefcase\"></i> Consumo vacantes</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoOfertas(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_ofertas_laborales, dato.cantidad_ofertas_laborales ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-person\"></i> Consumo usuarios</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUsuarios(usuarios)}>${crearProgressBarTemplate('', false, total_usuarios, dato.cantidad_usuarios ?? 0, false)}</div>`,\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumos(${dato.id}, '${dato.plan.nombre}', '${dato.plan.tipo_prueba.nombre}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n}\n\n/**\n * Renderiza la tabla de compras de creditos.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Sergio Vargas\n */\nasync function renderizarTablaCreditos(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n\n    let total_consumidos = datos_entrada.reduce((total, dato) => total + (dato.creditos_consumidos || 0), 0);\n    let total_creditos = datos_entrada.reduce((total, dato) => total + (dato.creditos_totales || 0), 0);\n    let porcentaje_total = total_creditos > 0 ? (total_consumidos / total_creditos) * 100 : 0;\n\n    $('#creditos-totales')\n        .empty()\n        .append(`\n            <p class=\"text-label-2 mb-1\"><img class=\"me-2\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\">Créditos totales</p>\n            ${crearProgressBar({ label: `${formatearNumero(total_consumidos)}/${formatearNumero(total_creditos)}`, height: '8px', porcentaje: { porcentaje: porcentaje_total, texto: false }})}\n        `);\n\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan_credito?.nombre ?? '---'}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias ? `${dato.vigencia_dias} dias` : 'Sin tiempo'}</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><img class=\"me-1\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\"> Consumo créditos</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => {\n                    let total = dato.creditos_totales ?? 0;\n                    let consumidos = dato.creditos_consumidos ?? 0;\n                    return `${crearProgressBarTemplate('', false, consumidos, total, false)}`;\n                },\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos?.[0]?.id ?? 0})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumosCreditos(${dato.empresa_id}, ${dato.id}, '${dato.plan_credito?.nombre ?? ''}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n    aplicarBusquedaTabla(nombre_tabla, busqueda_tablas[nombre_tabla]);\n}\n\nfunction aplicarBusquedaTabla(nombre_tabla, valor) {\n    const selector = `#tabla-compras-${nombre_tabla}`;\n    if (!$.fn.DataTable.isDataTable(selector)) return;\n    $(selector).DataTable().search(valor || '').draw();\n}\n\n/**\n * Renderiza el contenido de las subtablas.\n *\n * @param {array} data Array de datos a renderizar.\n * @returns {string} HTML de la subtabla.\n * @author Andres Morales\n */\nfunction crearContenidoSubTabla(data) {\n    let pruebas_html = \"\";\n    data.pruebas.forEach(prueba => {\n        pruebas_html += `\n            <div class=\"col-12 my-2 col-md-6 d-flex justify-content-start align-items-center gap-3\">\n                <img src=\"/imagenes/logos/pruebas/${slugify(prueba.nombre)}.png\" width=\"32px\" height=\"32px\" class=\"object-fit-cover\" alt=\"Logo prueba\">\n                <p class=\"mb-0 text-label-2\">${prueba.nombre}</p>\n            </div>\n        `;\n    });\n\n    let funcionalidades_predeterminadas_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (funcionalidad.predeterminado) funcionalidades_predeterminadas_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    let funcionalidades_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (!funcionalidad.predeterminado) funcionalidades_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    return `\n        <div class=\"row w-100 my-3 ps-8\">\n            <div class=\"col-4\">\n                <p class=\"text-body-3 fw-bolder\">Pruebas</p>\n                <div class=\"row\">\n                    ${pruebas_html}\n                </div>\n            </div>\n            <div class=\"col-8\">\n                <div class=\"container-fluid\">\n                    <div class=\"row border-bottom pb-2\">\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Costo:</span> <br> $ ${formatearNumero(data.precio)}</p>\n                        </div>\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Descuento:</span> <br> ${data.porcentaje_descuento !== 0 ? data.porcentaje_descuento + '%' : `Sin descuento`}</p>\n                        </div>\n                         <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Valor de venta:</span> <br> $ ${data.porcentaje_descuento !== 0 ? formatearNumero(data.precio * (1 - (data.porcentaje_descuento / 100))) : formatearNumero(data.precio) }</p>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios adicionales</p>\n                        </div>\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios predefinidos</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_html}</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_predeterminadas_html}</p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Generar el tooltip de consumo de unidades.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUnidades(consumos) {\n    var agrupado = consumos.reduce((acc, item) => {\n        if(item.agenda && item.agenda.prueba) {\n          var { id, nombre } = item.agenda.prueba;\n          var key = `${id}-${nombre}`;\n          if(!acc[key]) {\n            acc[key] = { prueba_id: id, prueba_nombre: nombre, cantidad: 0 };\n          }\n          acc[key].cantidad++;\n        }\n        return acc;\n    }, {});\n\n    var resultado = Object.values(agrupado);\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white'>Cantidad consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white'>\n                        <img src='/imagenes/logos/pruebas/${slugify(item.prueba_nombre)}.png' width='22px' height='22px' class='object-fit-cover me-2' alt='>\n                    </span>\n                    <span class='text-body-3 text-white'>\n                        ${item.prueba_nombre}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white me-3'>Cantidad consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de ofertas.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoOfertas(consumos) {\n    const resultado = Object.values(\n        consumos.filter(item => item.oferta_laboral_id !== null).reduce((acc, item) => {\n            const key = `${item.empresa.id}-${item.empresa.nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: item.empresa.id,\n                empresa_nombre_comercial: item.empresa.nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            return acc;\n        }, {})\n    );\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.empresa_nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de usuarios.\n *\n * @param {array} usuarios Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUsuarios(usuarios) {\n    const agrupado = usuarios.reduce((acc, usuario) => {\n        if (Array.isArray(usuario.empresas_usuarios)) {\n          // Recorremos las empresas del usuario y contamos sólo la primera que no tenga id 1\n          for (let i = 0; i < usuario.empresas_usuarios.length; i++) {\n            const { id, nombre_comercial } = usuario.empresas_usuarios[i].empresa;\n            if (id === 1) continue; // omitir la empresa con id 1\n            const key = `${id}-${nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: id,\n                nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            // Una vez que se cuenta el usuario para una empresa, salimos del ciclo\n            break;\n          }\n        }\n        return acc;\n      }, {});\n\n      const resultado = Object.values(agrupado);\n\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Aplicar los filtros a las compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction aplicarFiltrosAvanzadosCompras() {\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Abrir el modal de filtros de compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalFiltrosAvanzadosCompras() {\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Seleccionar una compra.\n *\n * @param {boolean} seleccion Selección.\n * @param {number} compra_id Id de la compra seleccionada.\n * @param {string} tabla_compras_id Id del elemento html de la tabla de compras.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction seleccionarCompra(seleccion, compra_id, tabla_compras_id, nombre_tabla) {\n    if (seleccion) {\n        compras_seleccionadas_ids[nombre_tabla].push(parseInt(compra_id));\n    } else {\n        let indice = compras_seleccionadas_ids[nombre_tabla].indexOf(compra_id);\n        if (indice !== -1) compras_seleccionadas_ids[nombre_tabla].splice(indice, 1);\n    }\n\n    let checkbox_seleccionar_todos = $(`#checkbox-seleccionar-todos-${tabla_compras_id}`);\n    if (compras_seleccionadas_ids[nombre_tabla].length === compras_ids[nombre_tabla].length) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', true);\n    } else if (compras_seleccionadas_ids[nombre_tabla].length === 0) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', false);\n    } else {\n        checkbox_seleccionar_todos.prop('indeterminate', true);\n    }\n}\n\n/**\n * Seleccionar todas las compras.\n *\n * @param {boolean} seleccion Selección\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nfunction seleccionarTodasCompras(seleccion, nombre_tabla) {\n    if (!seleccion) compras_seleccionadas_ids[nombre_tabla] = [];\n    let checkboxes_compras = $(`#tabla-compras-${nombre_tabla}`).find(\".checkbox-compra\").toArray();\n    checkboxes_compras.forEach(checkbox => {\n        checkbox.checked = seleccion;\n        if (seleccion && !compras_seleccionadas_ids[nombre_tabla].includes(checkbox.id)) {\n            compras_seleccionadas_ids[nombre_tabla].push(parseInt(checkbox.id));\n        }\n    });\n}\n\n/**\n * Establecer el evento para el botón de descarga del archivo Excel.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction establecerEventoDescargarComprasExcel(nombre_tabla) {\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).off('click');\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).on('click', () => {\n        if (nombre_tabla === 'creditos') {\n            descargarExcelCreditos();\n            return;\n        }\n        let empresas_planes_ids = compras_seleccionadas_ids[nombre_tabla].length ? [...compras_seleccionadas_ids[nombre_tabla]] : [...compras_ids[nombre_tabla]];\n        descargarExcel(\n            'planes-historial-recompras-exportar',\n            `compras_${nombre_tabla}`,\n            true,\n            empresas_planes_ids.length ? { empresas_planes_ids, empresa_id } : { empresa_id }\n        );\n    });\n}\n\n/**\n * Descargar Excel del historial de créditos de IA.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction descargarExcelCreditos() {\n    descargarExcel(\n        `planes-historial-creditos-exportar/${empresa_id}`,\n        'historial_creditos_ia',\n        true,\n        {}\n    );\n}\n\n/**\n * Procesar los filtros de las tablas de compras.\n *\n * @param {Object} json_filtros Filtros aplicados del dropdown\n * @param {string} tabla Nombre de la tabla\n * @returns {Object} Datos procesados para enviar al backend\n * @author Andres Morales\n */\nfunction procesarFiltrosTabla(json_filtros, tabla) {\n    let datos = {};\n\n    if (json_filtros[`estado_plan_filtro_${tabla}`]) {\n        datos.estado_id = json_filtros[`estado_plan_filtro_${tabla}`];\n    }\n\n    if (json_filtros[`duracion_filtro_${tabla}`]) {\n        datos.duracion = json_filtros[`duracion_filtro_${tabla}`];\n    }\n\n    if (tabla === 'creditos') {\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaCompra = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaCompra[0]) {\n                datos.created_at_desde = normalizarFechaFiltro(partesFechaCompra[0]);\n            }\n            if (partesFechaCompra[1]) {\n                datos.created_at_hasta = normalizarFechaFiltro(partesFechaCompra[1]);\n            }\n        }\n    } else {\n        if (json_filtros[`fecha_vencimiento_filtro_${tabla}`] && typeof json_filtros[`fecha_vencimiento_filtro_${tabla}`] === 'string') {\n            const partesFechaVencimiento = json_filtros[`fecha_vencimiento_filtro_${tabla}`].split(' a ');\n            if (partesFechaVencimiento[0]) {\n                datos.fecha_vencimiento_desde = normalizarFechaFiltro(partesFechaVencimiento[0]);\n            }\n            if (partesFechaVencimiento[1]) {\n                datos.fecha_vencimiento_hasta = normalizarFechaFiltro(partesFechaVencimiento[1]);\n            }\n        }\n\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaActivacion = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaActivacion[0]) {\n                datos.fecha_inicio_desde = normalizarFechaFiltro(partesFechaActivacion[0]);\n            }\n            if (partesFechaActivacion[1]) {\n                datos.fecha_inicio_hasta = normalizarFechaFiltro(partesFechaActivacion[1]);\n            }\n        }\n    }\n\n    return datos;\n}\n\n/**\n * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n *\n * @param {string} filtro ID del elemento html del filtro\n * @param {Object} filtros Filtros aplicados\n * @returns {void}\n * @author Andres Morales\n */\nfunction aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('seleccion'), 100);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('organizacional'), 100);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('vocacional'), 100);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('creditos'), 100);\n    }\n}\n\nwindow.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\nwindow.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n\nif (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n    };\n    window.aplicarFiltrosDropdown.__esDispatcher = true;\n}\n","structuredPatch":[{"oldStart":937,"oldLines":6,"newStart":937,"newLines":30,"lines":["     }"," }"," ","+/**","+ * Funcion para restablecer filtros adicionales - limpia la busqueda de las tablas.","+ *","+ * @param {string} input_id ID del input de filtro","+ * @returns {void}","+ * @author Sergio Vargas","+ */","+function restablecerFiltrosDropdownAdicional(input_id) {","+    const mapa_tablas = {","+        'filtro_dropdown_seleccion': 'seleccion',","+        'filtro_dropdown_organizacional': 'organizacional',","+        'filtro_dropdown_vocacional': 'vocacional',","+        'filtro_dropdown_creditos': 'creditos'","+    };","+","+    const nombre_tabla = mapa_tablas[input_id];","+    if (nombre_tabla) {","+        busqueda_tablas[nombre_tabla] = '';","+        aplicarBusquedaTabla(nombre_tabla, '');","+    }","+}","+","+window.restablecerFiltrosDropdownAdicional = restablecerFiltrosDropdownAdicional;","+"," window.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];"," window.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"85780d78-6930-47de-a50a-5964836aefee"}
{"parentUuid":"15e0a352-5064-40b0-99b2-f4635020f9a4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_0185CT7goQBwfibr7pvBWPjS","type":"message","role":"assistant","content":[{"type":"text","text":"Los cambios han sido implementados. Déjame verificar que el archivo quedó correctamente modificado leyendo las secciones relevantes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":899,"cache_read_input_tokens":50257,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":899},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXcJniKuHarWbXbZkyt6h","type":"assistant","uuid":"db0a62a8-e817-452a-8d28-11a405fe809f","timestamp":"2026-01-29T20:33:53.806Z"}
{"parentUuid":"db0a62a8-e817-452a-8d28-11a405fe809f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_0185CT7goQBwfibr7pvBWPjS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JcFQPwsrAJzSsc8ZZHxLa5","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","offset":51,"limit":70}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":899,"cache_read_input_tokens":50257,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":899},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXcJniKuHarWbXbZkyt6h","type":"assistant","uuid":"39a407a2-8649-41da-8406-170ebb629246","timestamp":"2026-01-29T20:33:54.539Z"}
{"parentUuid":"39a407a2-8649-41da-8406-170ebb629246","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JcFQPwsrAJzSsc8ZZHxLa5","type":"tool_result","content":"    51→let busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n    52→\n    53→/**\n    54→ * Obtener la busqueda combinada de chips activos.\n    55→ *\n    56→ * @param {string} id_input ID del input de filtro\n    57→ * @returns {string} Texto combinado de los chips separados por espacio\n    58→ * @author Sergio Vargas\n    59→ */\n    60→function obtenerBusquedaChips(id_input) {\n    61→    let componentes_chips_storage = localStorage.getItem('componentes_chips_storage');\n    62→    if (componentes_chips_storage == null) return '';\n    63→\n    64→    componentes_chips_storage = JSON.parse(componentes_chips_storage);\n    65→    if (componentes_chips_storage[window.location.pathname] == null) return '';\n    66→    if (componentes_chips_storage[window.location.pathname][id_input] == null) return '';\n    67→\n    68→    let chips = componentes_chips_storage[window.location.pathname][id_input].chips;\n    69→    return chips.join(' ');\n    70→}\n    71→\n    72→/**\n    73→ * Actualizar la busqueda de la tabla con los chips activos.\n    74→ *\n    75→ * @param {string} nombre_tabla Nombre de la tabla\n    76→ * @returns {void}\n    77→ * @author Sergio Vargas\n    78→ */\n    79→function actualizarBusquedaConChips(nombre_tabla) {\n    80→    const id_input = `filtro_dropdown_${nombre_tabla}`;\n    81→    const busqueda_chips = obtenerBusquedaChips(id_input);\n    82→    const valor_input = $(`#${id_input}`).val() || '';\n    83→\n    84→    let busqueda_combinada = '';\n    85→    if (valor_input && busqueda_chips) {\n    86→        busqueda_combinada = valor_input + ' ' + busqueda_chips;\n    87→    } else if (valor_input) {\n    88→        busqueda_combinada = valor_input;\n    89→    } else if (busqueda_chips) {\n    90→        busqueda_combinada = busqueda_chips;\n    91→    }\n    92→\n    93→    busqueda_tablas[nombre_tabla] = busqueda_combinada;\n    94→    aplicarBusquedaTabla(nombre_tabla, busqueda_combinada);\n    95→}\n    96→\n    97→$(document).ready(() => {\n    98→    $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));\n    99→    $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });\n   100→    $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });\n   101→    $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });\n   102→    $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });\n   103→    $(document).on('input', '#filtro_dropdown_seleccion', function () {\n   104→        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_seleccion');\n   105→        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n   106→        busqueda_tablas.seleccion = valor_combinado;\n   107→        aplicarBusquedaTabla('seleccion', valor_combinado);\n   108→    });\n   109→    $(document).on('input', '#filtro_dropdown_organizacional', function () {\n   110→        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_organizacional');\n   111→        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n   112→        busqueda_tablas.organizacional = valor_combinado;\n   113→        aplicarBusquedaTabla('organizacional', valor_combinado);\n   114→    });\n   115→    $(document).on('input', '#filtro_dropdown_vocacional', function () {\n   116→        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_vocacional');\n   117→        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n   118→        busqueda_tablas.vocacional = valor_combinado;\n   119→        aplicarBusquedaTabla('vocacional', valor_combinado);\n   120→    });\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"9456c00d-f583-49cf-a229-60568e722594","timestamp":"2026-01-29T20:33:55.345Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","content":"let busqueda_tablas = { seleccion: '', organizacional: '', vocacional: '', creditos: '' };\n\n/**\n * Obtener la busqueda combinada de chips activos.\n *\n * @param {string} id_input ID del input de filtro\n * @returns {string} Texto combinado de los chips separados por espacio\n * @author Sergio Vargas\n */\nfunction obtenerBusquedaChips(id_input) {\n    let componentes_chips_storage = localStorage.getItem('componentes_chips_storage');\n    if (componentes_chips_storage == null) return '';\n\n    componentes_chips_storage = JSON.parse(componentes_chips_storage);\n    if (componentes_chips_storage[window.location.pathname] == null) return '';\n    if (componentes_chips_storage[window.location.pathname][id_input] == null) return '';\n\n    let chips = componentes_chips_storage[window.location.pathname][id_input].chips;\n    return chips.join(' ');\n}\n\n/**\n * Actualizar la busqueda de la tabla con los chips activos.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction actualizarBusquedaConChips(nombre_tabla) {\n    const id_input = `filtro_dropdown_${nombre_tabla}`;\n    const busqueda_chips = obtenerBusquedaChips(id_input);\n    const valor_input = $(`#${id_input}`).val() || '';\n\n    let busqueda_combinada = '';\n    if (valor_input && busqueda_chips) {\n        busqueda_combinada = valor_input + ' ' + busqueda_chips;\n    } else if (valor_input) {\n        busqueda_combinada = valor_input;\n    } else if (busqueda_chips) {\n        busqueda_combinada = busqueda_chips;\n    }\n\n    busqueda_tablas[nombre_tabla] = busqueda_combinada;\n    aplicarBusquedaTabla(nombre_tabla, busqueda_combinada);\n}\n\n$(document).ready(() => {\n    $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));\n    $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });\n    $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });\n    $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });\n    $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });\n    $(document).on('input', '#filtro_dropdown_seleccion', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_seleccion');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.seleccion = valor_combinado;\n        aplicarBusquedaTabla('seleccion', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_organizacional', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_organizacional');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.organizacional = valor_combinado;\n        aplicarBusquedaTabla('organizacional', valor_combinado);\n    });\n    $(document).on('input', '#filtro_dropdown_vocacional', function () {\n        const busqueda_chips = obtenerBusquedaChips('filtro_dropdown_vocacional');\n        const valor_combinado = this.value + (busqueda_chips ? ' ' + busqueda_chips : '');\n        busqueda_tablas.vocacional = valor_combinado;\n        aplicarBusquedaTabla('vocacional', valor_combinado);\n    });","numLines":70,"startLine":51,"totalLines":973}},"sourceToolAssistantUUID":"39a407a2-8649-41da-8406-170ebb629246"}
{"parentUuid":"9456c00d-f583-49cf-a229-60568e722594","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01JcFQPwsrAJzSsc8ZZHxLa5","toolUseID":"toolu_01JcFQPwsrAJzSsc8ZZHxLa5","timestamp":"2026-01-29T20:33:55.347Z","uuid":"c5ec4c89-4b9f-470c-ba5d-0b1d7cee2246"}
{"parentUuid":"c5ec4c89-4b9f-470c-ba5d-0b1d7cee2246","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01J8XfE39S7tkqykjjHf77y4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ANjzHfJUeLfy9UaYQZv2B1","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","offset":880,"limit":60}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1566,"cache_read_input_tokens":51156,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1566},"output_tokens":18,"service_tier":"standard"}},"requestId":"req_011CXcJoEbp4vCkQfEBbzp89","type":"assistant","uuid":"8d746e2f-8b4d-4619-a940-cde716925922","timestamp":"2026-01-29T20:33:59.500Z"}
{"parentUuid":"8d746e2f-8b4d-4619-a940-cde716925922","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ANjzHfJUeLfy9UaYQZv2B1","type":"tool_result","content":"   880→                datos.fecha_vencimiento_hasta = normalizarFechaFiltro(partesFechaVencimiento[1]);\n   881→            }\n   882→        }\n   883→\n   884→        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n   885→            const partesFechaActivacion = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n   886→            if (partesFechaActivacion[0]) {\n   887→                datos.fecha_inicio_desde = normalizarFechaFiltro(partesFechaActivacion[0]);\n   888→            }\n   889→            if (partesFechaActivacion[1]) {\n   890→                datos.fecha_inicio_hasta = normalizarFechaFiltro(partesFechaActivacion[1]);\n   891→            }\n   892→        }\n   893→    }\n   894→\n   895→    return datos;\n   896→}\n   897→\n   898→/**\n   899→ * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n   900→ *\n   901→ * @param {string} filtro ID del elemento html del filtro\n   902→ * @param {Object} filtros Filtros aplicados\n   903→ * @returns {void}\n   904→ * @author Andres Morales\n   905→ */\n   906→function aplicarFiltrosDropdownRecompras(filtro, filtros) {\n   907→    let filtros_generados = {};\n   908→\n   909→    if (filtro === 'filtro_unidades_pruebas') {\n   910→        filtro_html = filtro;\n   911→        json_filtros = filtros;\n   912→        actualizarDatatables('tabla-consumos-unidades-pruebas');\n   913→    } else if (filtro === 'filtro_dropdown_seleccion') {\n   914→        filtro_html_seleccion = filtro;\n   915→        filtros_seleccion = filtros;\n   916→        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n   917→        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n   918→        setTimeout(() => actualizarBusquedaConChips('seleccion'), 100);\n   919→    } else if (filtro === 'filtro_dropdown_organizacional') {\n   920→        filtro_html_organizacional = filtro;\n   921→        filtros_organizacional = filtros;\n   922→        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n   923→        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n   924→        setTimeout(() => actualizarBusquedaConChips('organizacional'), 100);\n   925→    } else if (filtro === 'filtro_dropdown_vocacional') {\n   926→        filtro_html_vocacional = filtro;\n   927→        filtros_vocacional = filtros;\n   928→        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n   929→        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n   930→        setTimeout(() => actualizarBusquedaConChips('vocacional'), 100);\n   931→    } else if (filtro === 'filtro_dropdown_creditos') {\n   932→        filtro_html_creditos = filtro;\n   933→        filtros_creditos = filtros;\n   934→        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n   935→        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n   936→        setTimeout(() => actualizarBusquedaConChips('creditos'), 100);\n   937→    }\n   938→}\n   939→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"f3f586ac-3986-47f2-9344-220072c983e5","timestamp":"2026-01-29T20:34:00.277Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","content":"                datos.fecha_vencimiento_hasta = normalizarFechaFiltro(partesFechaVencimiento[1]);\n            }\n        }\n\n        if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n            const partesFechaActivacion = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n            if (partesFechaActivacion[0]) {\n                datos.fecha_inicio_desde = normalizarFechaFiltro(partesFechaActivacion[0]);\n            }\n            if (partesFechaActivacion[1]) {\n                datos.fecha_inicio_hasta = normalizarFechaFiltro(partesFechaActivacion[1]);\n            }\n        }\n    }\n\n    return datos;\n}\n\n/**\n * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n *\n * @param {string} filtro ID del elemento html del filtro\n * @param {Object} filtros Filtros aplicados\n * @returns {void}\n * @author Andres Morales\n */\nfunction aplicarFiltrosDropdownRecompras(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('seleccion'), 100);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('organizacional'), 100);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('vocacional'), 100);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n        setTimeout(() => actualizarBusquedaConChips('creditos'), 100);\n    }\n}\n","numLines":60,"startLine":880,"totalLines":973}},"sourceToolAssistantUUID":"8d746e2f-8b4d-4619-a940-cde716925922"}
{"parentUuid":"f3f586ac-3986-47f2-9344-220072c983e5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01ANjzHfJUeLfy9UaYQZv2B1","toolUseID":"toolu_01ANjzHfJUeLfy9UaYQZv2B1","timestamp":"2026-01-29T20:34:00.279Z","uuid":"d6e5bb11-68a2-4696-b3fd-5e81093bb64e"}
{"parentUuid":"d6e5bb11-68a2-4696-b3fd-5e81093bb64e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WNPKu5xumiY4nMd2vdyA4e","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JNb87UBBdjXieDyM9Rw78K","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","offset":938,"limit":40}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1276,"cache_read_input_tokens":52722,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1276},"output_tokens":18,"service_tier":"standard"}},"requestId":"req_011CXcJobiovTsDHpcCoL4BY","type":"assistant","uuid":"fbf8bab5-af6a-43ca-9442-98bf99f2e975","timestamp":"2026-01-29T20:34:04.866Z"}
{"parentUuid":"fbf8bab5-af6a-43ca-9442-98bf99f2e975","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JNb87UBBdjXieDyM9Rw78K","type":"tool_result","content":"   938→}\n   939→\n   940→/**\n   941→ * Funcion para restablecer filtros adicionales - limpia la busqueda de las tablas.\n   942→ *\n   943→ * @param {string} input_id ID del input de filtro\n   944→ * @returns {void}\n   945→ * @author Sergio Vargas\n   946→ */\n   947→function restablecerFiltrosDropdownAdicional(input_id) {\n   948→    const mapa_tablas = {\n   949→        'filtro_dropdown_seleccion': 'seleccion',\n   950→        'filtro_dropdown_organizacional': 'organizacional',\n   951→        'filtro_dropdown_vocacional': 'vocacional',\n   952→        'filtro_dropdown_creditos': 'creditos'\n   953→    };\n   954→\n   955→    const nombre_tabla = mapa_tablas[input_id];\n   956→    if (nombre_tabla) {\n   957→        busqueda_tablas[nombre_tabla] = '';\n   958→        aplicarBusquedaTabla(nombre_tabla, '');\n   959→    }\n   960→}\n   961→\n   962→window.restablecerFiltrosDropdownAdicional = restablecerFiltrosDropdownAdicional;\n   963→\n   964→window.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\n   965→window.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n   966→\n   967→if (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n   968→    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n   969→        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n   970→    };\n   971→    window.aplicarFiltrosDropdown.__esDispatcher = true;\n   972→}\n   973→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"68eeac94-dd7b-49bc-a6aa-49c8c2a772c1","timestamp":"2026-01-29T20:34:05.644Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","content":"}\n\n/**\n * Funcion para restablecer filtros adicionales - limpia la busqueda de las tablas.\n *\n * @param {string} input_id ID del input de filtro\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction restablecerFiltrosDropdownAdicional(input_id) {\n    const mapa_tablas = {\n        'filtro_dropdown_seleccion': 'seleccion',\n        'filtro_dropdown_organizacional': 'organizacional',\n        'filtro_dropdown_vocacional': 'vocacional',\n        'filtro_dropdown_creditos': 'creditos'\n    };\n\n    const nombre_tabla = mapa_tablas[input_id];\n    if (nombre_tabla) {\n        busqueda_tablas[nombre_tabla] = '';\n        aplicarBusquedaTabla(nombre_tabla, '');\n    }\n}\n\nwindow.restablecerFiltrosDropdownAdicional = restablecerFiltrosDropdownAdicional;\n\nwindow.__aplicarFiltrosDropdownHandlers = window.__aplicarFiltrosDropdownHandlers || [];\nwindow.__aplicarFiltrosDropdownHandlers.push(aplicarFiltrosDropdownRecompras);\n\nif (!window.aplicarFiltrosDropdown || !window.aplicarFiltrosDropdown.__esDispatcher) {\n    window.aplicarFiltrosDropdown = function (filtro, filtros) {\n        (window.__aplicarFiltrosDropdownHandlers || []).forEach(handler => handler(filtro, filtros));\n    };\n    window.aplicarFiltrosDropdown.__esDispatcher = true;\n}\n","numLines":36,"startLine":938,"totalLines":973}},"sourceToolAssistantUUID":"fbf8bab5-af6a-43ca-9442-98bf99f2e975"}
{"parentUuid":"68eeac94-dd7b-49bc-a6aa-49c8c2a772c1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01JNb87UBBdjXieDyM9Rw78K","toolUseID":"toolu_01JNb87UBBdjXieDyM9Rw78K","timestamp":"2026-01-29T20:34:05.646Z","uuid":"c657cc5f-a541-4be2-98d3-d7dd6116125e"}
{"parentUuid":"c657cc5f-a541-4be2-98d3-d7dd6116125e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QWZiVMmYFC1Q8mZFXpSvAV","type":"message","role":"assistant","content":[{"type":"text","text":"Todos los cambios han sido implementados correctamente. Aquí está el resumen de lo que se modificó en `public/js/empresa/planes/modal-recompras.js`:\n\n## Cambios Implementados\n\n1. **Nueva función `obtenerBusquedaChips()`** (líneas 53-70): Obtiene los chips activos del localStorage y los combina en una cadena de búsqueda separada por espacios.\n\n2. **Nueva función `actualizarBusquedaConChips()`** (líneas 72-95): Combina el valor del input con los chips activos y aplica la búsqueda a la tabla correspondiente.\n\n3. **Eventos `input` modificados** (líneas 103-127): Ahora los 4 eventos de input combinan el valor escrito con los chips activos antes de aplicar la búsqueda.\n\n4. **Función `aplicarFiltrosDropdownRecompras()` modificada** (líneas 906-938): Se agregó `setTimeout(() => actualizarBusquedaConChips(...), 100)` después de cada llamada a `modalHistorialCompras()` para sincronizar la búsqueda con los chips después de recargar la tabla.\n\n5. **Nueva función `restablecerFiltrosDropdownAdicional()`** (líneas 940-962): Limpia la búsqueda de la tabla cuando se restablecen los filtros. Se expone globalmente en `window.restablecerFiltrosDropdownAdicional`.\n\nEstos cambios corrigen los problemas del sistema de filtros con chips:\n- Al remover un tag o hacer clic en \"Limpiar filtros\", la tabla ahora se actualizará correctamente\n- Al hacer clic en una búsqueda reciente, el filtro se aplicará correctamente a la tabla"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":742,"cache_read_input_tokens":53998,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":742},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXcJozUmyKJmNPSxHkq8t","type":"assistant","uuid":"12dd0fdd-db9d-4106-a107-6eaa262efdbc","timestamp":"2026-01-29T20:34:17.683Z"}
{"parentUuid":"12dd0fdd-db9d-4106-a107-6eaa262efdbc","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"3b2dddd1-2f51-4d93-b6d4-b579bd97111f","version":"2.1.23","gitBranch":"pre-main","slug":"snug-baking-hearth","type":"system","subtype":"turn_duration","durationMs":90192,"timestamp":"2026-01-29T20:34:17.795Z","uuid":"a1b04368-85e8-46b3-8d2a-1bdfb5cb7d8f","isMeta":false}
{"type":"summary","summary":"Fix Filter Chips System Modal Purchase History","leafUuid":"12dd0fdd-db9d-4106-a107-6eaa262efdbc"}
