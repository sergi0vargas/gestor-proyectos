{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":"I need to understand how credit consumption works in this Laravel project. Specifically:\n\n1. Find the Service and Repository related to credit consumption (ConsumoCredito, CreditoService, or similar)\n2. Find any logic that determines WHICH EmpresaPlan is selected when consuming credits\n3. Find any logic that handles splitting consumption across multiple plans\n4. Look for methods like \"consumir\", \"descontar\", \"registrarConsumo\" or similar in services related to credits or IA\n\nSearch in:\n- app/Http/Services/ (look for anything related to creditos, consumo, IA)\n- app/Http/Repositories/ (same)\n- app/Http/Controllers/ (look for credit consumption endpoints)\n\nBe very thorough - search for all files that reference ConsumoCredito, PlanCredito, or credit consumption logic. I need to understand the full flow of how credits are consumed and which plan is selected."},"uuid":"667bbbbe-bbb7-4bdd-8025-3aa8399567fe","timestamp":"2026-01-22T21:38:17.177Z"}
{"parentUuid":"667bbbbe-bbb7-4bdd-8025-3aa8399567fe","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q8im4ft7HnQSSR8KZwHUFE","type":"message","role":"assistant","content":[{"type":"text","text":"I'll conduct a thorough search for credit consumption logic in this Laravel project. Let me start by searching for key files and patterns."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15178,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15178,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP93UApHReF4MJN5BkLY","type":"assistant","uuid":"7805965f-0e0f-4d40-8a7e-e52441039032","timestamp":"2026-01-22T21:38:22.641Z"}
{"parentUuid":"7805965f-0e0f-4d40-8a7e-e52441039032","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q8im4ft7HnQSSR8KZwHUFE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CgZdXuaZN151RF1c9TyKRa","name":"Glob","input":{"pattern":"app/Http/Services/**/*[Cc]redit*"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15178,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15178,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP93UApHReF4MJN5BkLY","type":"assistant","uuid":"425c59a0-7277-48dc-ba38-91bcb6d6bb96","timestamp":"2026-01-22T21:38:22.705Z"}
{"parentUuid":"425c59a0-7277-48dc-ba38-91bcb6d6bb96","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q8im4ft7HnQSSR8KZwHUFE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Dk1XaM4LC8Pb1Vfd19piSz","name":"Glob","input":{"pattern":"app/Http/Services/**/*[Cc]onsumo*"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15178,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15178,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP93UApHReF4MJN5BkLY","type":"assistant","uuid":"9b3ebefb-8cd5-4550-8d52-09f0dc23681e","timestamp":"2026-01-22T21:38:22.776Z"}
{"parentUuid":"9b3ebefb-8cd5-4550-8d52-09f0dc23681e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q8im4ft7HnQSSR8KZwHUFE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WeeG9DceszLM7pmsnLb314","name":"Glob","input":{"pattern":"app/Http/Repositories/**/*[Cc]redit*"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15178,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15178,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP93UApHReF4MJN5BkLY","type":"assistant","uuid":"79438122-8224-435f-9b01-f1cb20d6a231","timestamp":"2026-01-22T21:38:22.856Z"}
{"parentUuid":"79438122-8224-435f-9b01-f1cb20d6a231","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q8im4ft7HnQSSR8KZwHUFE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015YQvfBjpvjJJrhKvk2BGLx","name":"Glob","input":{"pattern":"app/Http/Repositories/**/*[Cc]onsumo*"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15178,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15178,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP93UApHReF4MJN5BkLY","type":"assistant","uuid":"58895341-9d4d-4227-90d5-b54216d1db64","timestamp":"2026-01-22T21:38:22.927Z"}
{"parentUuid":"58895341-9d4d-4227-90d5-b54216d1db64","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q8im4ft7HnQSSR8KZwHUFE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015xKKKG9ttm3HCduJKTapp7","name":"Glob","input":{"pattern":"app/Models/**/*[Cc]redit*"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15178,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15178,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP93UApHReF4MJN5BkLY","type":"assistant","uuid":"43552176-62e9-447e-8bab-da639a7ddffe","timestamp":"2026-01-22T21:38:23.012Z"}
{"parentUuid":"43552176-62e9-447e-8bab-da639a7ddffe","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q8im4ft7HnQSSR8KZwHUFE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018tFBpnC3EVdrVVe56c6tec","name":"Glob","input":{"pattern":"app/Models/**/*[Cc]onsumo*"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15178,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15178,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP93UApHReF4MJN5BkLY","type":"assistant","uuid":"94d0698d-7bd7-4a86-8f87-be2df5b4d1e2","timestamp":"2026-01-22T21:38:23.091Z"}
{"parentUuid":"425c59a0-7277-48dc-ba38-91bcb6d6bb96","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CgZdXuaZN151RF1c9TyKRa","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\CreditoIAService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php"}]},"uuid":"73fc86f3-0a5f-480c-8b9e-d327651b3d9a","timestamp":"2026-01-22T21:38:30.889Z","sourceToolAssistantUUID":"425c59a0-7277-48dc-ba38-91bcb6d6bb96"}
{"parentUuid":"9b3ebefb-8cd5-4550-8d52-09f0dc23681e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Dk1XaM4LC8Pb1Vfd19piSz","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\ConsumoService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php"}]},"uuid":"4c7f4f07-967f-4e38-9d69-234b474fea15","timestamp":"2026-01-22T21:38:30.948Z","sourceToolAssistantUUID":"9b3ebefb-8cd5-4550-8d52-09f0dc23681e"}
{"parentUuid":"79438122-8224-435f-9b01-f1cb20d6a231","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WeeG9DceszLM7pmsnLb314","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php"}]},"uuid":"a29ac45f-b7bf-4213-b6ff-cfdc99afbb9d","timestamp":"2026-01-22T21:38:30.919Z","sourceToolAssistantUUID":"79438122-8224-435f-9b01-f1cb20d6a231"}
{"parentUuid":"58895341-9d4d-4227-90d5-b54216d1db64","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015YQvfBjpvjJJrhKvk2BGLx","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\ConsumoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php"}]},"uuid":"08927d70-7011-47dc-84d8-bbeeae2c53a7","timestamp":"2026-01-22T21:38:30.921Z","sourceToolAssistantUUID":"58895341-9d4d-4227-90d5-b54216d1db64"}
{"parentUuid":"43552176-62e9-447e-8bab-da639a7ddffe","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015xKKKG9ttm3HCduJKTapp7","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"}]},"uuid":"8980c0b2-6f69-4114-a35e-0b995e5f0b3e","timestamp":"2026-01-22T21:38:30.949Z","sourceToolAssistantUUID":"43552176-62e9-447e-8bab-da639a7ddffe"}
{"parentUuid":"94d0698d-7bd7-4a86-8f87-be2df5b4d1e2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018tFBpnC3EVdrVVe56c6tec","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Consumo.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php"}]},"uuid":"ecbdce71-8a43-4fa6-ba53-e59be2a53acf","timestamp":"2026-01-22T21:38:30.947Z","sourceToolAssistantUUID":"94d0698d-7bd7-4a86-8f87-be2df5b4d1e2"}
{"parentUuid":"ecbdce71-8a43-4fa6-ba53-e59be2a53acf","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01W1k2fspCJAzNaEjjbwBy2M","type":"message","role":"assistant","content":[{"type":"text","text":"Good start! Now let me search for additional files and methods related to credit consumption."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1228,"cache_read_input_tokens":15178,"cache_creation":{"ephemeral_5m_input_tokens":1228,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP94W5BrqC8BbgaddfDq","type":"assistant","uuid":"cd622ba3-28f8-4961-a7d2-0dbd24aedcad","timestamp":"2026-01-22T21:38:33.567Z"}
{"parentUuid":"cd622ba3-28f8-4961-a7d2-0dbd24aedcad","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01W1k2fspCJAzNaEjjbwBy2M","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011NN1225AabUUUNemmt9fCC","name":"Grep","input":{"pattern":"consumir|descontar|registrarConsumo","type":"php","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1228,"cache_read_input_tokens":15178,"cache_creation":{"ephemeral_5m_input_tokens":1228,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP94W5BrqC8BbgaddfDq","type":"assistant","uuid":"cdab21c6-bba6-4674-9a68-151f169a9594","timestamp":"2026-01-22T21:38:35.407Z"}
{"parentUuid":"cdab21c6-bba6-4674-9a68-151f169a9594","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01W1k2fspCJAzNaEjjbwBy2M","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KnXzcjV5MP2UseqQs5vVmC","name":"Grep","input":{"pattern":"ConsumoCredito|PlanCredito","type":"php","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1228,"cache_read_input_tokens":15178,"cache_creation":{"ephemeral_5m_input_tokens":1228,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP94W5BrqC8BbgaddfDq","type":"assistant","uuid":"0aa4e765-961f-460a-bb82-f3a683eae3c5","timestamp":"2026-01-22T21:38:35.466Z"}
{"parentUuid":"0aa4e765-961f-460a-bb82-f3a683eae3c5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KnXzcjV5MP2UseqQs5vVmC","type":"tool_result","content":"Found 20 files\nroutes\\web.php\napp\\Http\\Services\\IA\\ConsumoCreditoService.php\napp\\Http\\Controllers\\Empresas\\EmpresaPlanController.php\nresources\\views\\empresas\\index.blade.php\napp\\Http\\Services\\Empresas\\EmpresaPlanService.php\napp\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php\napp\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php\napp\\Models\\Empresas\\EmpresaPlan.php\napp\\Models\\IA\\ServicioIA.php\nresources\\views\\planes\\paginas\\crear-plan-creditos.blade.php\nresources\\views\\planes\\index.blade.php\nresources\\views\\empresas\\paginas\\asignar-plan.blade.php\ndatabase\\seeders\\DatabaseSeeder.php\ndatabase\\seeders\\PlanCreditoSeeder.php\napp\\Traits\\IATrait.php\napp\\Models\\Planes\\PlanCredito.php\napp\\Models\\IA\\ConsumoCredito.php\napp\\Http\\Services\\Planes\\PlanCreditoService.php\napp\\Http\\Repositories\\Planes\\PlanCreditoRepository.php\napp\\Http\\Controllers\\Planes\\PlanCreditoController.php"}]},"uuid":"ef588724-d9df-4132-aa79-0a3b66fe5617","timestamp":"2026-01-22T21:38:38.297Z","sourceToolAssistantUUID":"0aa4e765-961f-460a-bb82-f3a683eae3c5"}
{"parentUuid":"cdab21c6-bba6-4674-9a68-151f169a9594","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011NN1225AabUUUNemmt9fCC","type":"tool_result","content":"Found 13 files\nroutes\\web.php\napp\\Http\\Services\\IA\\ConsumoCreditoService.php\napp\\Http\\Services\\Vacantes\\VacanteService.php\napp\\Http\\Services\\Agendas\\AgendaService.php\nresources\\views\\vacantes\\paginas\\modales\\modal-consumo-creditos-ia.blade.php\napp\\Traits\\IATrait.php\napp\\Http\\Services\\Procesos\\ProcesoService.php\nresources\\views\\componentes\\componentes\\adicionales.blade.php\napp\\Http\\Services\\Planes\\ConsumoService.php\napp\\Http\\Services\\OfertasLaborales\\OfertaLaboralService.php\napp\\Http\\Services\\Agendas\\AgendaTiempoService.php\napp\\Http\\Middleware\\ValidarDisponibilidadOfertasLaboralesMiddleware.php\napp\\Http\\Controllers\\Agendas\\AgendaTiempoController.php"}]},"uuid":"d0222c02-149d-4e99-9b7d-2474fafb8a80","timestamp":"2026-01-22T21:38:38.314Z","sourceToolAssistantUUID":"cdab21c6-bba6-4674-9a68-151f169a9594"}
{"parentUuid":"d0222c02-149d-4e99-9b7d-2474fafb8a80","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GriTjXrXoATmabpqrTaVWH","type":"message","role":"assistant","content":[{"type":"text","text":"Excellent! Now let me read the key service files to understand the credit consumption flow."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":357,"cache_creation_input_tokens":633,"cache_read_input_tokens":16406,"cache_creation":{"ephemeral_5m_input_tokens":633,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXP952m9iujpdp1yj8kUa","type":"assistant","uuid":"b04ddd00-1cc5-4dee-8d3a-5d4f72e18152","timestamp":"2026-01-22T21:38:40.106Z"}
{"parentUuid":"b04ddd00-1cc5-4dee-8d3a-5d4f72e18152","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GriTjXrXoATmabpqrTaVWH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013McdNNQjGJMxMMTr6hmrz1","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":357,"cache_creation_input_tokens":633,"cache_read_input_tokens":16406,"cache_creation":{"ephemeral_5m_input_tokens":633,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXP952m9iujpdp1yj8kUa","type":"assistant","uuid":"cdbec7a2-16fb-4f39-bf21-c3373983f54e","timestamp":"2026-01-22T21:38:41.242Z"}
{"parentUuid":"cdbec7a2-16fb-4f39-bf21-c3373983f54e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GriTjXrXoATmabpqrTaVWH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ak14gY4aWXtDCRxr7Z8iEN","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":357,"cache_creation_input_tokens":633,"cache_read_input_tokens":16406,"cache_creation":{"ephemeral_5m_input_tokens":633,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXP952m9iujpdp1yj8kUa","type":"assistant","uuid":"dc3473a9-3097-4c4b-9cad-cbaa2374cb28","timestamp":"2026-01-22T21:38:42.134Z"}
{"parentUuid":"dc3473a9-3097-4c4b-9cad-cbaa2374cb28","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GriTjXrXoATmabpqrTaVWH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PibVmFQALvVRChaAh572Du","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\ConsumoService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":357,"cache_creation_input_tokens":633,"cache_read_input_tokens":16406,"cache_creation":{"ephemeral_5m_input_tokens":633,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXP952m9iujpdp1yj8kUa","type":"assistant","uuid":"321df3f6-8241-4544-86d1-8ca0ccc0af51","timestamp":"2026-01-22T21:38:42.181Z"}
{"parentUuid":"321df3f6-8241-4544-86d1-8ca0ccc0af51","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GriTjXrXoATmabpqrTaVWH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EVGrvPjtxzFqJZcJkHocXX","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":357,"cache_creation_input_tokens":633,"cache_read_input_tokens":16406,"cache_creation":{"ephemeral_5m_input_tokens":633,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXP952m9iujpdp1yj8kUa","type":"assistant","uuid":"10c2cac2-130b-4b31-9391-7fad8bea5057","timestamp":"2026-01-22T21:38:42.250Z"}
{"parentUuid":"cdbec7a2-16fb-4f39-bf21-c3373983f54e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013McdNNQjGJMxMMTr6hmrz1","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\IA;\n     4→\n     5→use Carbon\\Carbon;\n     6→use App\\Models\\Planes\\Plan;\n     7→use Illuminate\\Support\\Str;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Models\\IA\\ConsumoCredito;\n    10→use App\\Http\\Services\\BaseService;\n    11→use Illuminate\\Support\\Collection;\n    12→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    13→use App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n    14→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    15→use App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n    16→\n    17→class ConsumoCreditoService extends BaseService\n    18→{\n    19→    /**\n    20→     * Constructor.\n    21→     *\n    22→     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n    23→     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n    24→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n    25→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresa.\n    26→     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de empresas de usuarios.\n    27→     * @return void\n    28→     * @author Sergio Vargas\n    29→     * @author Daniel Beltrán\n    30→     * @author Andres Gonzalez\n    31→     */\n    32→    public function __construct(\n    33→        ConsumoCreditoRepository $repositorio,\n    34→        private readonly ServicioPrecioTokenService $precio_token_servicio,\n    35→        private readonly EmpresaPlanRepository $empresa_plan_repositorio,\n    36→        private readonly EmpresaPlanService $empresa_plan_servicio,\n    37→        private readonly EmpresaUsuarioRepository $empresa_usuario_repositorio\n    38→    ) {\n    39→        parent::__construct($repositorio);\n    40→    }\n    41→\n    42→    /**\n    43→     * Registra el consumo de tokens desde la respuesta de la API de IA.\n    44→     *\n    45→     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n    46→     *\n    47→     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n    48→     * @param array $respuesta_ia Respuesta completa de la API de IA.\n    49→     * @param ?int $usuario_id ID del usuario que realizó la petición.\n    50→     * @param ?int $empresa_id ID de la empresa del usuario.\n    51→     * @param array $contexto Array con agenda_id, vacante_id, etc.\n    52→     * @param ?string $payload_peticion JSON del payload enviado.\n    53→     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n    54→     * @return ?ConsumoCredito\n    55→     * @author Sergio Vargas\n    56→     * @author Daniel Beltrán\n    57→     * @author Andres Gonzalez\n    58→     */\n    59→    public function registrarConsumoDesdeRespuesta(\n    60→        string $ruta_endpoint,\n    61→        array $respuesta_ia,\n    62→        ?int $usuario_id = null,\n    63→        ?int $empresa_id = null,\n    64→        ?array $contexto = [],\n    65→        ?string $payload_peticion = null,\n    66→        ?int $latencia_ms = null\n    67→    ): ?ConsumoCredito {\n    68→        // Detectar si hay múltiples metadata de uso (formato nuevo)\n    69→        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n    70→        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n    71→        $ultimo_registro = null;\n    72→\n    73→        // Registrar Whisper si existe\n    74→        if ($uso_whisper) {\n    75→            $ultimo_registro = $this->registrarConsumoIndividual(\n    76→                ruta_endpoint: $ruta_endpoint . '.whisper',\n    77→                usage: $uso_whisper,\n    78→                respuesta_ia: $respuesta_ia,\n    79→                usuario_id: $usuario_id,\n    80→                empresa_id: $empresa_id,\n    81→                contexto: $contexto,\n    82→                payload_peticion: $payload_peticion,\n    83→                latencia_ms: $latencia_ms\n    84→            );\n    85→        }\n    86→\n    87→        // Registrar GPT si existe\n    88→        if ($uso_gpt) {\n    89→            $ultimo_registro = $this->registrarConsumoIndividual(\n    90→                ruta_endpoint: $ruta_endpoint . '.gpt',\n    91→                usage: $uso_gpt,\n    92→                respuesta_ia: $respuesta_ia,\n    93→                usuario_id: $usuario_id,\n    94→                empresa_id: $empresa_id,\n    95→                contexto: $contexto,\n    96→                payload_peticion: $payload_peticion,\n    97→                latencia_ms: $latencia_ms\n    98→            );\n    99→        }\n   100→\n   101→        // Fallback: Si solo hay \"usage\" (formato legacy)\n   102→        $usage_legacy = $respuesta_ia['usage'] ?? null;\n   103→\n   104→        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n   105→            $ultimo_registro = $this->registrarConsumoIndividual(\n   106→                ruta_endpoint: $ruta_endpoint,\n   107→                usage: $usage_legacy,\n   108→                respuesta_ia: $respuesta_ia,\n   109→                usuario_id: $usuario_id,\n   110→                empresa_id: $empresa_id,\n   111→                contexto: $contexto,\n   112→                payload_peticion: $payload_peticion,\n   113→                latencia_ms: $latencia_ms\n   114→            );\n   115→        }\n   116→\n   117→        // Validar y actualizar estado del plan según créditos restantes\n   118→        $this->actualizarEstadoPlanSegunCreditos();\n   119→\n   120→        return $ultimo_registro;\n   121→    }\n   122→\n   123→    /**\n   124→     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n   125→     *\n   126→     * @return void\n   127→     * @author Andres Gonzalez\n   128→     */\n   129→    private function actualizarEstadoPlanSegunCreditos(): void {\n   130→        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   131→        $plan_creditos = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n   132→\n   133→        if (!$plan_creditos) {\n   134→            return;\n   135→        }\n   136→\n   137→        $empresa_plan_id = $plan_creditos['empresa_plan_id'] ?? null;\n   138→        $creditos_plan = $plan_creditos['creditos_plan'] ?? 0;\n   139→        $creditos_disponibles = $plan_creditos['creditos_disponibles'] ?? 0;\n   140→\n   141→        if (!$empresa_plan_id || $creditos_plan <= 0) {\n   142→            return;\n   143→        }\n   144→\n   145→        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n   146→\n   147→        if ($creditos_disponibles <= 0) {\n   148→            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n   149→        } elseif ($porcentaje_restante < 20) {\n   150→            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n   151→        }\n   152→    }\n   153→\n   154→    /**\n   155→     * Registra un consumo individual de tokens desde una metadata de uso específica.\n   156→     *\n   157→     * @param string $ruta_endpoint Ruta del endpoint llamado.\n   158→     * @param array $usage Metadata de uso específica.\n   159→     * @param array $respuesta_ia Respuesta completa de la API de IA.\n   160→     * @param ?int $usuario_id ID del usuario que realizó la petición.\n   161→     * @param ?int $empresa_id ID de la empresa del usuario.\n   162→     * @param array $contexto Array con agenda_id, vacante_id, etc.\n   163→     * @param ?string $payload_peticion JSON del payload enviado.\n   164→     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n   165→     * @return ?ConsumoCredito\n   166→     * @author Sergio Vargas\n   167→     * @author Daniel Beltrán\n   168→     */\n   169→    private function registrarConsumoIndividual(\n   170→        string $ruta_endpoint,\n   171→        array $usage,\n   172→        array $respuesta_ia,\n   173→        ?int $usuario_id,\n   174→        ?int $empresa_id,\n   175→        array $contexto,\n   176→        ?string $payload_peticion,\n   177→        ?int $latencia_ms\n   178→    ): ?ConsumoCredito {\n   179→        $vacante_id = $contexto['vacante_id'] ?? null;\n   180→\n   181→        if (!$vacante_id && $payload_peticion) {\n   182→            $decoded = json_decode($payload_peticion, true);\n   183→\n   184→            if (is_array($decoded)) {\n   185→                $vacante_id = data_get($decoded, 'vacante_id')\n   186→                    ?? data_get($decoded, 'vacanteId')\n   187→                    ?? data_get($decoded, 'id')\n   188→                    ?? data_get($decoded, 'vacante.id');\n   189→\n   190→                if ($vacante_id && !is_numeric($vacante_id)) {\n   191→                    $vacante_id = null;\n   192→                } elseif (is_numeric($vacante_id)) {\n   193→                    $vacante_id = (int) $vacante_id;\n   194→                }\n   195→            }\n   196→        }\n   197→\n   198→        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n   199→        $modelo = $usage['model'] ?? 'desconocido';\n   200→\n   201→        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n   202→        $metadata_adicional = [];\n   203→\n   204→        if (isset($usage['audio_duration_minutes'])) {\n   205→            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n   206→        }\n   207→\n   208→        if (isset($usage['audio_duration_seconds'])) {\n   209→            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n   210→        }\n   211→\n   212→        // Calcular costo estimado (pasando metadata adicional para Whisper)\n   213→        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n   214→            $modelo,\n   215→            $usage['prompt_tokens'] ?? 0,\n   216→            $usage['completion_tokens'] ?? 0,\n   217→            $metadata_adicional ?: null\n   218→        );\n   219→\n   220→        // Generar huella digital\n   221→        $huella_peticion = null;\n   222→\n   223→        if ($payload_peticion) {\n   224→            $huella_peticion = hash('sha256', $payload_peticion);\n   225→        }\n   226→\n   227→        // Determinar estado de la respuesta\n   228→        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n   229→        $estado = 'exitoso';\n   230→\n   231→        if (isset($respuesta_ia['status_code'])) {\n   232→            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n   233→        } elseif (isset($respuesta_ia['error'])) {\n   234→            $estado = 'error';\n   235→        }\n   236→\n   237→        // Preparar datos\n   238→        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n   239→        $contenido_respuesta = $respuesta_ia['data']\n   240→            ?? $respuesta_ia['vacante']\n   241→            ?? $respuesta_ia['preguntas']\n   242→            ?? $respuesta_ia['pruebas']\n   243→            ?? $respuesta_ia['calificacion']\n   244→            ?? null;\n   245→\n   246→        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n   247→        if ($contenido_respuesta === null) {\n   248→            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n   249→        }\n   250→\n   251→        $datos = [\n   252→            'usuario_id'         => $usuario_id,\n   253→            'empresa_id'         => $empresa_id,\n   254→            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n   255→            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n   256→            'creditos'           => $contexto['creditos'] ?? 0,\n   257→            'ruta_endpoint'      => $ruta_endpoint,\n   258→            'nombre_servicio'    => $usage['service_name'] ?? null,\n   259→            'modelo'             => $modelo,\n   260→            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n   261→            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n   262→            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n   263→            'caracteres_entrada' => $usage['input_chars'] ?? null,\n   264→            'costo_estimado_usd' => $costo_estimado,\n   265→            'huella_peticion'    => $huella_peticion,\n   266→            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n   267→            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n   268→            'estado'             => $estado,\n   269→            'latencia_ms'        => $latencia_ms,\n   270→            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n   271→            'agenda_id'          => $contexto['agenda_id'] ?? null,\n   272→            'vacante_id'         => $vacante_id\n   273→        ];\n   274→\n   275→        return $this->repositorio->crear($datos);\n   276→    }\n   277→\n   278→    /**\n   279→     * Obtener historial de consumos de creditos por empresa.\n   280→     *\n   281→     * @param int $empresa_id ID de la empresa.\n   282→     * @param array $filtros Filtros de búsqueda (desde, hasta, servicio_ia_id, usuario_id).\n   283→     * @return Collection\n   284→     * @author Sergio Vargas\n   285→     * @author Jair Carvajal\n   286→     */\n   287→    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n   288→        $desde          = null;\n   289→        $hasta          = null;\n   290→        $servicio_ia_id = !empty($filtros['servicio_ia_id']) ? (int) $filtros['servicio_ia_id'] : null;\n   291→        $usuario_id     = !empty($filtros['usuario_id']) ? (int) $filtros['usuario_id'] : null;\n   292→\n   293→        if (!empty($filtros['desde'])) {\n   294→            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n   295→        }\n   296→\n   297→        if (!empty($filtros['hasta'])) {\n   298→            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n   299→        }\n   300→\n   301→        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta, $servicio_ia_id, $usuario_id);\n   302→\n   303→        return $consumos->map(function (ConsumoCredito $consumo) {\n   304→            $servicio = $consumo->servicioIA?->nombre\n   305→                ?? $consumo->nombre_servicio\n   306→                ?? $consumo->ruta_endpoint;\n   307→\n   308→            return [\n   309→                'usuario'        => $consumo->usuario ? [\n   310→                    'id'              => $consumo->usuario->id,\n   311→                    'nombre_completo' => $consumo->usuario->nombre_completo\n   312→                ] : null,\n   313→                'servicio'       => $servicio,\n   314→                'creditos'       => $consumo->creditos ?? 0,\n   315→                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n   316→                'fecha_consumo'  => $consumo->created_at\n   317→            ];\n   318→        });\n   319→    }\n   320→}\n   321→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"176e5519-0ed4-4e26-bc98-e64b4f587464","timestamp":"2026-01-22T21:38:46.205Z","sourceToolAssistantUUID":"cdbec7a2-16fb-4f39-bf21-c3373983f54e"}
{"parentUuid":"dc3473a9-3097-4c4b-9cad-cbaa2374cb28","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ak14gY4aWXtDCRxr7Z8iEN","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Planes;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Http\\Services\\BaseService;\n     7→use App\\Models\\Planes\\PlanCredito;\n     8→use Illuminate\\Support\\Collection;\n     9→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    10→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    11→\n    12→/**\n    13→ * @property PlanCreditoRepository $repositorio\n    14→ */\n    15→class PlanCreditoService extends BaseService\n    16→{\n    17→    /**\n    18→     * Constructor.\n    19→     *\n    20→     * @param PlanCreditoRepository $repositorio Repositorio de planes de créditos.\n    21→     * @param ServicioIARepository $repositorio Repositorio de planes de IA.\n    22→     * @return void\n    23→     * @author Sergio Vargas\n    24→     * @author Daniel Beltrán\n    25→     * @author Jair Carvajal\n    26→     */\n    27→    public function __construct(\n    28→        PlanCreditoRepository $repositorio,\n    29→        protected ServicioIARepository $servicio_ia_repositorio\n    30→    ) {\n    31→        parent::__construct($repositorio);\n    32→    }\n    33→\n    34→    /**\n    35→     * Obtener planes de créditos con datos calculados.\n    36→     *\n    37→     * @param Request $request Contenido de la petición.\n    38→     * @return Collection\n    39→     * @author Jair Carvajal\n    40→     */\n    41→    public function getTodoCreditosPromedio(Request $request): Collection {\n    42→        $planes                   = $this->repositorio->getTodo($request);\n    43→        $creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n    44→\n    45→        return $planes->map(function ($plan) use ($creditos_promedio_accion) {\n    46→            $plan->creditos_disponibles     = $plan->creditos;\n    47→            $plan->creditos_promedio_accion = $creditos_promedio_accion;\n    48→\n    49→            return $plan;\n    50→        });\n    51→    }\n    52→\n    53→    /**\n    54→     * Crear o actualizar un plan de créditos.\n    55→     *\n    56→     * @param Request $request Contenido de la petición.\n    57→     * @return PlanCredito\n    58→     * @author Sergio Vargas\n    59→     * @author Daniel Beltrán\n    60→     */\n    61→    public function guardar(Request $request): PlanCredito {\n    62→        $campos_excluidos = ['_token', '_method', 'id', 'servicios'];\n    63→\n    64→        if ($request->filled('id')) {\n    65→            return $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n    66→        }\n    67→\n    68→        return $this->repositorio->crear($request->except($campos_excluidos));\n    69→    }\n    70→\n    71→    /**\n    72→     * Calcular el precio final del plan.\n    73→     *\n    74→     * @param PlanCredito $plan Plan de crédito.\n    75→     * @return float\n    76→     * @author Sergio Vargas\n    77→     * @author Daniel Beltrán\n    78→     */\n    79→    public function calcularPrecioFinal(PlanCredito $plan): float {\n    80→        return $plan->precio_con_descuento;\n    81→    }\n    82→}\n    83→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"f610fd2b-a62b-4032-b1e6-8ec5638dc26b","timestamp":"2026-01-22T21:38:46.205Z","sourceToolAssistantUUID":"dc3473a9-3097-4c4b-9cad-cbaa2374cb28"}
{"parentUuid":"321df3f6-8241-4544-86d1-8ca0ccc0af51","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PibVmFQALvVRChaAh572Du","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Planes;\n     4→\n     5→use App\\Traits\\SesionTrait;\n     6→use Illuminate\\Http\\Request;\n     7→use App\\Models\\Agendas\\Agenda;\n     8→use App\\Models\\Vacantes\\Vacante;\n     9→use App\\Http\\Services\\BaseService;\n    10→use App\\Models\\Pruebas\\TipoPrueba;\n    11→use Illuminate\\Support\\Collection;\n    12→use App\\Models\\Planes\\{Consumo,Plan};\n    13→use App\\Models\\OfertasLaborales\\OfertaLaboral;\n    14→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    15→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    16→use App\\Http\\Repositories\\Agendas\\AgendaRepository;\n    17→use App\\Http\\Repositories\\Planes\\ConsumoRepository;\n    18→use App\\Http\\Repositories\\Vacantes\\VacanteRepository;\n    19→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    20→use App\\Http\\Repositories\\OfertasLaborales\\OfertaLaboralRepository;\n    21→use App\\Http\\Repositories\\Empresas\\{EmpresaPlanRepository, EmpresaRepository, EmpresaUsuarioRepository};\n    22→\n    23→/**\n    24→ * @property ConsumoRepository $repositorio\n    25→ */\n    26→class ConsumoService extends BaseService\n    27→{\n    28→    use SesionTrait;\n    29→\n    30→    private $modelo = Consumo::class;\n    31→\n    32→    /**\n    33→     * Constructor.\n    34→     *\n    35→     * @param ConsumoRepository $repositorio Repositorio de consumos.\n    36→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    37→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    38→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos pruebas.\n    39→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de empresas planes.\n    40→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de empresas planes.\n    41→     * @param OfertaLaboralRepository $oferta_laboral_repositorio Repositorio de ofertas laborales.\n    42→     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n    43→     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de empresas usuarios.\n    44→     * @return void\n    45→     * @author Fahibram Cárcamo\n    46→     */\n    47→    public function __construct(\n    48→        ConsumoRepository $repositorio,\n    49→        private EmpresaRepository $empresa_repositorio,\n    50→        private UserRepository $usuario_repositorio,\n    51→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    52→        private EmpresaPlanRepository $empresa_plan_repositorio,\n    53→        private EmpresaPlanService $empresa_plan_servicio,\n    54→        private OfertaLaboralRepository $oferta_laboral_repositorio,\n    55→        private AgendaRepository $agenda_repositorio,\n    56→        private EmpresaUsuarioRepository $empresa_usuario_repositorio,\n    57→        private VacanteRepository $vacante_repositorio\n    58→    ) {\n    59→        parent::__construct($repositorio);\n    60→    }\n    61→\n    62→    /**\n    63→     * Obtener los usuarios de los consumos de un registro de la tabla empresas_planes.\n    64→     *\n    65→     * @param Request $request Solicitud HTTP.\n    66→     * @return Collection\n    67→     * @author Fahibram Cárcamo\n    68→     */\n    69→    public function obtenerUsuariosConsumosPlan(Request $request): Collection {\n    70→        $consumos = $this->repositorio->getTodo(new Request([\n    71→            'empresa_plan_id'       => $request->empresa_plan_id,\n    72→            'con_agendas'           => true,\n    73→            'con_ofertas_laborales' => true,\n    74→            'con_empresa'           => true,\n    75→            'en'                    => true,\n    76→            'campo'                 => 'id',\n    77→            'valores'               => $request->ids_consumos\n    78→        ]));\n    79→\n    80→        $empresa  = $this->empresa_repositorio->getUnoBasico($this->obtenerDeSesion('empresa_id'));\n    81→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]), $empresa);\n    82→\n    83→        $usuarios_salida = collect();\n    84→\n    85→        foreach ($consumos as $consumo) {\n    86→            $usuario            = null;\n    87→            $usuarios_filtrados = [];\n    88→\n    89→            if ($consumo->agenda_id !== null) {\n    90→                $usuarios_filtrados = $usuarios->filter(fn($usuario) => $usuario->id === $consumo->agenda->evaluador_id);\n    91→            } elseif ($consumo->oferta_laboral_id !== null) {\n    92→                $usuarios_filtrados = $usuarios->filter(fn($usuario) => $usuario->id === $consumo->ofertaLaboral->usuario_id);\n    93→            }\n    94→\n    95→            if (count($usuarios_filtrados)) {\n    96→                $usuario                = clone $usuarios_filtrados->first();\n    97→                $empresa_usuario        = $usuario->empresasUsuarios->filter(fn($empresa_usuario) => $empresa_usuario->empresa_id === $consumo->empresa_id)->first();\n    98→                $usuario->rol           = $empresa_usuario->rol;\n    99→                $usuario->fecha_consumo = $consumo->created_at;\n   100→                $usuario->empresa       = $consumo->empresa;\n   101→                $usuarios_salida->push($usuario);\n   102→            }\n   103→        }\n   104→\n   105→        return $usuarios_salida;\n   106→    }\n   107→\n   108→    /**\n   109→     * Crear el consumo correspondiente al procesamiento de una agenda.\n   110→     *\n   111→     * @param Agenda|int $agenda Id o instancia de la nueva agenda registrada.\n   112→     * @return ?Consumo\n   113→     * @author Fahibram Cárcamo\n   114→     */\n   115→    public function registrarConsumoAgenda(int|Agenda $agenda): ?Consumo {\n   116→        $agenda              = gettype($agenda) === 'integer' ? $this->agenda_repositorio->getUno($agenda) : $agenda;\n   117→        $empresa_plan_activo = $this->empresa_plan_repositorio->planActivo($agenda->empresa_id, TipoPrueba::SELECCION_ID);\n   118→\n   119→        if ($this->empresa_plan_servicio->verificarVigenciaPlan($empresa_plan_activo)) {\n   120→            $this->crearConsumoModelo($agenda->empresa_id, $empresa_plan_activo->id, 'agenda_id', $agenda->id);\n   121→        } elseif (\n   122→            !$this->empresa_plan_servicio->validarDisponibilidadUnidades($empresa_plan_activo) &&\n   123→            !$this->empresa_plan_servicio->validarDisponibilidadOfertasLaborales($empresa_plan_activo)\n   124→        ) {\n   125→            $this->empresa_plan_repositorio->actualizar($empresa_plan_activo->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n   126→        }\n   127→\n   128→        return null;\n   129→    }\n   130→\n   131→    /**\n   132→     * Crear el consumo correspondiente a la creación de una nueva oferta laboral.\n   133→     *\n   134→     * @param int|OfertaLaboral $oferta_laboral Id o instancia de la nueva oferta laboral registrada.\n   135→     * @return ?Consumo\n   136→     * @author Fahibram Cárcamo\n   137→     */\n   138→    public function registrarConsumoOfertaLaboral(int|OfertaLaboral $oferta_laboral): ?Consumo {\n   139→        $oferta_laboral      = gettype($oferta_laboral) === 'integer' ? $this->oferta_laboral_repositorio->getUno($oferta_laboral) : $oferta_laboral;\n   140→        $empresa_plan_activo = $this->empresa_plan_repositorio->planActivo($oferta_laboral->empresa_id, TipoPrueba::SELECCION_ID);\n   141→\n   142→        if ($this->empresa_plan_servicio->verificarVigenciaPlanOfertasLaborales($empresa_plan_activo)) {\n   143→            $this->crearConsumoModelo($oferta_laboral->empresa_id, $empresa_plan_activo->id, 'oferta_laboral_id', $oferta_laboral->id);\n   144→        } elseif (\n   145→            !$this->empresa_plan_servicio->validarDisponibilidadUnidades($empresa_plan_activo) &&\n   146→            !$this->empresa_plan_servicio->validarDisponibilidadOfertasLaborales($empresa_plan_activo)\n   147→        ) {\n   148→            $this->empresa_plan_repositorio->actualizar($empresa_plan_activo->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n   149→        }\n   150→\n   151→        return null;\n   152→    }\n   153→\n   154→    /**\n   155→    * Crear el consumo correspondiente a la creación de una nueva vacante.\n   156→    *\n   157→    * @param int|Vacante $vacante  Id o instancia de la nueva vacante registrada.\n   158→    * @return ?Consumo  Retorna el registro de consumo creado, o null si no se generó.\n   159→    * @author Andres Gonzalez\n   160→    */\n   161→    public function registrarConsumoVacante(int|Vacante $vacante): ?Consumo {\n   162→        // Si llega un ID, obtener la instancia del modelo desde el repositorio\n   163→        $vacante = gettype($vacante) === 'integer' ? $this->vacante_repositorio->getUno($vacante) : $vacante;\n   164→\n   165→        // Buscar el plan activo de la empresa asociada a la vacante\n   166→        $empresa_plan_activo = $this->empresa_plan_repositorio->planActivo($vacante->empresa_id, TipoPrueba::SELECCION_ID);\n   167→\n   168→        // Validar vigencia del plan\n   169→        if ($this->empresa_plan_servicio->verificarVigenciaPlanOfertasLaborales($empresa_plan_activo)) {\n   170→            // Registrar consumo asociado a la vacante\n   171→            $this->crearConsumoModelo($vacante->empresa_id, $empresa_plan_activo->id, 'vacante_id', $vacante->id);\n   172→        } elseif (\n   173→            !$this->empresa_plan_servicio->validarDisponibilidadUnidades($empresa_plan_activo) &&\n   174→            !$this->empresa_plan_servicio->validarDisponibilidadOfertasLaborales($empresa_plan_activo)\n   175→        ) {\n   176→            // Marcar el plan como vencido si no hay unidades disponibles\n   177→            $this->empresa_plan_repositorio->actualizar($empresa_plan_activo->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n   178→        }\n   179→\n   180→        return null;\n   181→    }\n   182→\n   183→    /**\n   184→     * Crear un nuevo consumo según el modelo consumido (oferta laboral o agenda).\n   185→     *\n   186→     * @param int $empresa_id Id de la empresa del consumo.\n   187→     * @param int $empresa_plan_id Id del registro de la tabla empresas_planes.\n   188→     * @param string $llave_foranea Llave foránea del modelo relacionado.\n   189→     * @param int $valor_llave_foranea Valor de la llave foránea del modelo relacionado.\n   190→     * @return Consumo\n   191→     * @author Fahibram Cárcamo\n   192→     */\n   193→    private function crearConsumoModelo(int $empresa_id, int $empresa_plan_id, string $llave_foranea, int $valor_llave_foranea): Consumo {\n   194→        return $this->repositorio->crearSiNoExiste([\n   195→            $llave_foranea => $valor_llave_foranea\n   196→        ], [\n   197→            'empresa_id'      => $empresa_id,\n   198→            'empresa_plan_id' => $empresa_plan_id\n   199→        ]);\n   200→    }\n   201→\n   202→    /**\n   203→     * Obtener los datos de los consumos de un plan en una empresa y sus sucursales junto con sus usuarios responsables.\n   204→     *\n   205→     * @param Request $request Contenido de la petición HTTP.\n   206→     * @return Collection\n   207→     * @author Fahibram Cárcamo\n   208→     */\n   209→    public function obtenerConsumosUsuariosEmpresaSucursales(Request $request): Collection {\n   210→        $empresa = $request->filled('empresa_id')\n   211→            ? $this->empresa_repositorio->getUno($request->empresa_id)\n   212→            : $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   213→\n   214→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa->id, new Request());\n   215→        $sucursales->push($empresa);\n   216→        $sucursales_ids = $sucursales->pluck('id')->toArray();\n   217→\n   218→        $request->merge(compact('sucursales_ids'));\n   219→\n   220→        return $this->repositorio->obtenerConsumosUsuariosEmpresaSucursales($request);\n   221→    }\n   222→}\n   223→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6f9f5bcb-bc42-4230-bcdb-801cab85d668","timestamp":"2026-01-22T21:38:46.206Z","sourceToolAssistantUUID":"321df3f6-8241-4544-86d1-8ca0ccc0af51"}
{"parentUuid":"10c2cac2-130b-4b31-9391-7fad8bea5057","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EVGrvPjtxzFqJZcJkHocXX","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Empresas;\n     4→\n     5→use Exception;\n     6→use Carbon\\Carbon;\n     7→use App\\Models\\Planes\\Plan;\n     8→use Illuminate\\Support\\Arr;\n     9→use App\\Traits\\ArchivoTrait;\n    10→use Illuminate\\Http\\Request;\n    11→use App\\Mail\\CrearUsuarioMail;\n    12→use Illuminate\\Http\\UploadedFile;\n    13→use App\\Http\\Services\\BaseService;\n    14→use App\\Models\\Pruebas\\TipoPrueba;\n    15→use Illuminate\\Support\\Collection;\n    16→use App\\Models\\Empresas\\EmpresaPlan;\n    17→use Illuminate\\Support\\Facades\\Notification;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use Illuminate\\Support\\Facades\\{Mail, Password};\n    20→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    23→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    24→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    25→use App\\Notifications\\SolicitudRenovacionPlanNotification;\n    26→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    27→use Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n    28→\n    29→/**\n    30→ * @property EmpresaPlanRepository $repositorio\n    31→ */\n    32→class EmpresaPlanService extends BaseService\n    33→{\n    34→    use ArchivoTrait;\n    35→\n    36→    /**\n    37→     * Constructor.\n    38→     *\n    39→     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n    40→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    41→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    42→     * @param PlanRepository $plan_repositorio Repositorio de planes.\n    43→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    44→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    45→     * @return void\n    46→     * @author Daniel Beltrán\n    47→     */\n    48→    public function __construct(\n    49→        EmpresaPlanRepository $repositorio,\n    50→        protected EmpresaRepository $empresa_repositorio,\n    51→        protected RolRepository $rol_repositorio,\n    52→        protected PlanRepository $plan_repositorio,\n    53→        protected PlanCreditoRepository $plan_credito_repositorio,\n    54→        protected ArchivoRepository $archivo_repositorio,\n    55→        protected UserRepository $usuario_repositorio\n    56→    ) {\n    57→        parent::__construct($repositorio);\n    58→    }\n    59→\n    60→    /**\n    61→     * Guardar un plan de empresa.\n    62→     *\n    63→     * @param Request $request Contenido de la petición.\n    64→     * @return EmpresaPlan\n    65→     * @author Sergio Vargas\n    66→     * @author Daniel Beltrán\n    67→     * @author Andres Morales\n    68→     * @author Jair Carvajal\n    69→     * @author Andres Gonzalez\n    70→     */\n    71→    public function guardar(Request $request): EmpresaPlan {\n    72→        $bandera_enviar_correo = false;\n    73→        $campos_excluidos      = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n    74→        $es_solo_creditos      = $request->filled('plan_credito_id') && !$request->filled('plan_id');\n    75→        $plan                  = null;\n    76→        $plan_activo           = null;\n    77→        $vigencia              = null;\n    78→\n    79→        if (!$es_solo_creditos) {\n    80→            $plan        = $this->plan_repositorio->getUno($request->plan_id);\n    81→            $plan_activo = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n    82→            $vigencia    = $plan->vigencia;\n    83→        } else {\n    84→            $request->merge(['plan_id' => null]);\n    85→            $plan_activo = $this->repositorio->planCreditosActivo($request->empresa_id);\n    86→        }\n    87→\n    88→        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n    89→            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n    90→\n    91→            if ($plan_credito) {\n    92→                $request->merge(['creditos' => $plan_credito->creditos]);\n    93→            }\n    94→        } elseif (!$request->filled('plan_credito_id')) {\n    95→            $request->merge([\n    96→                'plan_credito_id' => null,\n    97→                'creditos'        => 0\n    98→            ]);\n    99→        }\n   100→\n   101→        if (!$es_solo_creditos) {\n   102→            if ($request->filled('vigencia')) {\n   103→                $vigencia = $request->vigencia;\n   104→            }\n   105→\n   106→            if (!is_null($plan_activo)) {\n   107→                if ($request->filled('id')) {\n   108→                    // Si el ID recibido es igual al plan activo, no se calcula vigencia\n   109→                    if ($request->id === $plan_activo->id) {\n   110→                        goto omitir_calcular_vigencia;\n   111→                    }\n   112→\n   113→                    // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n   114→                    if ($vigencia == $request->vigencia) {\n   115→                        array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n   116→                        goto omitir_calcular_vigencia;\n   117→                    }\n   118→                }\n   119→\n   120→                // Poner el nuevo plan como proximo\n   121→                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n   122→\n   123→                // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n   124→                if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n   125→                    // Agregar las nuevas fechas al nuevo plan\n   126→                    $hoy          = now();\n   127→                    $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n   128→                    $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n   129→                }\n   130→            } else {\n   131→                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   132→\n   133→                // Validar si el plan seleccionado tiene vigencia\n   134→                if (!is_null($plan->vigencia)) {\n   135→                    $request->merge($this->calcularFechasVigencia($vigencia));\n   136→                }\n   137→            }\n   138→        } else {\n   139→            $request->merge([\n   140→                'fecha_inicio'      => null,\n   141→                'fecha_vencimiento' => null\n   142→            ]);\n   143→\n   144→            if (!is_null($plan_activo)) {\n   145→                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n   146→            } else {\n   147→                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   148→            }\n   149→        }\n   150→\n   151→        omitir_calcular_vigencia:\n   152→\n   153→        if (!$es_solo_creditos) {\n   154→            if (!$request->filled('unidades')) {\n   155→                $request->merge(['unidades' => $plan->unidades]);\n   156→            } elseif ($request->unidades != $plan->unidades) {\n   157→                $request->merge(['plan_original' => false]);\n   158→            }\n   159→\n   160→            if (!$request->filled('cantidad_ofertas_laborales')) {\n   161→                $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n   162→            } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n   163→                $request->merge(['plan_original' => false]);\n   164→            }\n   165→\n   166→            if (!$request->filled('cantidad_usuarios')) {\n   167→                $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n   168→            } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n   169→                $request->merge(['plan_original' => false]);\n   170→            }\n   171→\n   172→            if (!$request->filled('cantidad_pruebas')) {\n   173→                $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n   174→            } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n   175→                $request->merge(['plan_original' => false]);\n   176→            }\n   177→\n   178→            // Comprobar si se modificaron las funcionalidades respecto al plan original\n   179→            if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n   180→                $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n   181→                $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n   182→                $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n   183→\n   184→                if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n   185→                    $request->merge(['plan_original' => false]);\n   186→                }\n   187→            }\n   188→        }\n   189→\n   190→        if ($request->filled('id')) {\n   191→            // Eliminar la factura actual\n   192→            if ($request->hasFile('factura')) {\n   193→                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n   194→\n   195→                if (!is_null($archivo)) {\n   196→                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n   197→                    $this->archivo_repositorio->eliminar($archivo->id);\n   198→                }\n   199→            }\n   200→\n   201→            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n   202→        } else {\n   203→            $bandera_enviar_correo = true;\n   204→            $request->merge(['usuario_id' => auth()->user()->id]);\n   205→            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n   206→        }\n   207→\n   208→        if ($request->filled('pruebas')) {\n   209→            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n   210→        }\n   211→\n   212→        if ($request->filled('funcionalidades')) {\n   213→            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n   214→        }\n   215→\n   216→        // Guardar la factura\n   217→        if ($request->hasFile('factura')) {\n   218→            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n   219→        }\n   220→\n   221→        if ($bandera_enviar_correo) {\n   222→            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n   223→            $usuario      = $empresa->usuarios[0];\n   224→            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n   225→            $titulo       = 'Usuario principal de la empresa creado';\n   226→            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n   227→        }\n   228→\n   229→        return $plan_asignado;\n   230→    }\n   231→\n   232→    /**\n   233→     * Renovar el plan asignado.\n   234→     *\n   235→     * @param int $id ID del plan de la empresa que se quiere renovar.\n   236→     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n   237→     * @return EmpresaPlan Plan de la empresa renovado.\n   238→     * @author Daniel Beltrán\n   239→     */\n   240→    public function renovar(int $id): EmpresaPlan {\n   241→        $empresa_plan = $this->repositorio->getUno($id);\n   242→\n   243→        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n   244→            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n   245→        }\n   246→\n   247→        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n   248→\n   249→        $request->merge(['por_facturar' => true]);\n   250→\n   251→        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n   252→            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n   253→            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n   254→        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {\n   255→            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n   256→            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   257→        }\n   258→\n   259→        $this->verificarYAsignarTiempo($empresa_plan, $request);\n   260→\n   261→        $plan_renovado = $this->repositorio->crear($request->toArray());\n   262→\n   263→        if ($request->filled('pruebas')) {\n   264→            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n   265→        }\n   266→\n   267→        if ($request->filled('funcionalidades')) {\n   268→            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n   269→        }\n   270→\n   271→        return $plan_renovado;\n   272→    }\n   273→\n   274→    /**\n   275→     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n   276→     *\n   277→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   278→     * @param Request $request Contenido de la petición.\n   279→     * @return void\n   280→     * @author Daniel Beltrán\n   281→     */\n   282→    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n   283→        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n   284→            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n   285→        }\n   286→    }\n   287→\n   288→    /**\n   289→     * Calcular las fechas en las que el plan estará vigente.\n   290→     *\n   291→     * @param int $vigencia Cantidad de días de vigencia.\n   292→     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n   293→     * @return array Fechas de inicio y vencimiento.\n   294→     * @author Daniel Beltrán\n   295→     */\n   296→    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n   297→        $hoy = now();\n   298→\n   299→        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n   300→\n   301→        // Si es múltiplo de 3, entonces la vigencia es en meses\n   302→\n   303→        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n   304→            $meses = $vigencia / 30;\n   305→\n   306→            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n   307→\n   308→            if ($fecha_inicio->day === 1) {\n   309→                $fecha_vencimiento->subDay();\n   310→            }\n   311→        } else {\n   312→            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n   313→\n   314→            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n   315→        }\n   316→\n   317→        return [\n   318→            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n   319→\n   320→            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n   321→        ];\n   322→    }\n   323→\n   324→    /**\n   325→     * Facturar un plan de empresa.\n   326→     *\n   327→     * @param int $id ID del plan de empresa.\n   328→     * @param Request $request Contenido de la petición.\n   329→     * @return EmpresaPlan\n   330→     * @author Daniel Beltrán\n   331→     */\n   332→    public function facturar(int $id, Request $request): EmpresaPlan {\n   333→        $empresa_plan = $this->repositorio->getUno($id);\n   334→\n   335→        if ($request->filled('vigencia')) {\n   336→            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n   337→        }\n   338→\n   339→        $request->merge(['por_facturar' => false]);\n   340→\n   341→        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n   342→\n   343→        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n   344→\n   345→        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n   346→\n   347→        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n   348→    }\n   349→\n   350→    /**\n   351→     * Guardar factura.\n   352→     *\n   353→     * @param int $id ID del plan de empresa.\n   354→     * @param int $empresa_id ID de la empresa.\n   355→     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n   356→     * @return void\n   357→     * @author Daniel Beltrán\n   358→     */\n   359→    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n   360→        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n   361→\n   362→        $this->generarDirectorios(\"app/{$ruta}\");\n   363→\n   364→        $nombre_archivo = $this->generarNombreArchivo($archivo);\n   365→\n   366→        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n   367→\n   368→        $this->archivo_repositorio->crear([\n   369→            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n   370→\n   371→            'modelo_id' => $id,\n   372→\n   373→            'nombre' => 'factura',\n   374→\n   375→            'ruta' => $ruta . '/' . $nombre_archivo\n   376→        ]);\n   377→    }\n   378→\n   379→    /**\n   380→     * Obtener el historial de recompras de una empresa por tipo de prueba.\n   381→     *\n   382→     * @param Request $request Contenido de la petición HTTP entrante.\n   383→     * @return Collection\n   384→     * @author Daniel Beltrán\n   385→     * @author Fahibram Cárcamo\n   386→     * @author Andres Morales\n   387→     * @author Andres Gonzalez\n   388→     */\n   389→    public function historialRecompras(Request $request): Collection {\n   390→        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n   391→\n   392→        $request->merge([\n   393→            'con_conteo_consumos_agendas'           => true,\n   394→            'con_conteo_consumos_ofertas_laborales' => true\n   395→        ]);\n   396→\n   397→        return match ($rol_usuario->id) {\n   398→            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n   399→\n   400→            RolRepository::ROL_PROPIETARIO_ID,\n   401→\n   402→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   403→\n   404→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   405→\n   406→            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n   407→        };\n   408→    }\n   409→\n   410→    /**\n   411→     * Obtener el historial de compras de planes con creditos para una empresa.\n   412→     *\n   413→     * @param int $empresa_id ID de la empresa.\n   414→     * @param Request $request Contenido de la peticion.\n   415→     * @return Collection\n   416→     * @author Sergio Vargas\n   417→     */\n   418→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   419→        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n   420→\n   421→        return $historial->map(function (EmpresaPlan $plan) {\n   422→            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n   423→\n   424→            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n   425→\n   426→            $plan->creditos_totales = $total_creditos;\n   427→\n   428→            $plan->creditos_consumidos = $creditos_consumidos;\n   429→\n   430→            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n   431→\n   432→            return $plan;\n   433→        });\n   434→    }\n   435→\n   436→    /**\n   437→     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n   438→     *\n   439→     * @param int $empresa_id ID de la empresa.\n   440→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   441→     * @return ?EmpresaPlan\n   442→     * @author Daniel Beltrán\n   443→     */\n   444→    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   445→        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n   446→            'empresa_id'             => $empresa_id,\n   447→            'tipo_prueba_id'         => $tipo_prueba_id,\n   448→            'excluir_estado_proximo' => true\n   449→        ]));\n   450→\n   451→        if (!is_null($plan)) {\n   452→            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   453→\n   454→            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n   455→        }\n   456→\n   457→        return $plan;\n   458→    }\n   459→\n   460→    /**\n   461→     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n   462→     *\n   463→     * @param int $id ID del plan de empresa.\n   464→     * @return ?EmpresaPlan\n   465→     * @author Daniel Beltrán\n   466→     */\n   467→    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n   468→        $plan               = $this->repositorio->getUno($id);\n   469→        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n   470→\n   471→        return $plan;\n   472→    }\n   473→\n   474→    /**\n   475→     * Obtener el plan activo de la empresa por tipo de prueba.\n   476→     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n   477→     * La propiedad se llama 'plan_proximo' y es un booleano.\n   478→     *\n   479→     * @param int $empresa_id ID de la empresa.\n   480→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   481→     * @return ?EmpresaPlan\n   482→     * @author Daniel Beltrán\n   483→     */\n   484→    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   485→        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   486→\n   487→        if (!is_null($plan)) {\n   488→            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n   489→        }\n   490→\n   491→        return $plan;\n   492→    }\n   493→\n   494→    /**\n   495→     * Solicitar la renovación de un plan específico de una empresa específica.\n   496→     *\n   497→     * @param Request $request Solicitud HTTP.\n   498→     * @return void\n   499→     * @author Fahibram Cárcamo\n   500→     */\n   501→    public function solicitarRenovacionPlan(Request $request) {\n   502→        $plan = $this->plan_repositorio->getUno($request->plan_id);\n   503→\n   504→        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n   505→\n   506→        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n   507→\n   508→        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   509→            'rol_id' => RolRepository::ROL_SUPERADMIN_ID,\n   510→\n   511→            'con_roles_ids' => true\n   512→        ]));\n   513→\n   514→        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   515→            'rol_id' => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n   516→\n   517→            'empresa_id' => $request->empresa_id,\n   518→\n   519→            'con_roles_ids' => true\n   520→        ]));\n   521→\n   522→        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n   523→\n   524→        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n   525→    }\n   526→\n   527→    /**\n   528→     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n   529→     *\n   530→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   531→     * @return bool\n   532→     * @author Daniel Beltrán\n   533→     * @author Fahibram Cárcamo\n   534→     */\n   535→    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n   536→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   537→            return true;\n   538→        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n   539→            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n   540→                return true;\n   541→            }\n   542→        }\n   543→\n   544→        return false;\n   545→    }\n   546→\n   547→    /**\n   548→     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n   549→     *\n   550→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   551→     * @return bool\n   552→     * @author Daniel Beltrán\n   553→     * @author Fahibram Cárcamo\n   554→     */\n   555→    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   556→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   557→            return true;\n   558→        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n   559→            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n   560→                return true;\n   561→            }\n   562→        }\n   563→\n   564→        return false;\n   565→    }\n   566→\n   567→    /**\n   568→     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n   569→     *\n   570→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   571→     * @return bool\n   572→     * @author Fahibram Cárcamo\n   573→     */\n   574→    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n   575→        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n   576→    }\n   577→\n   578→    /**\n   579→     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n   580→     *\n   581→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   582→     * @return bool\n   583→     * @author Fahibram Cárcamo\n   584→     */\n   585→    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   586→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n   587→    }\n   588→\n   589→    /**\n   590→     * Verificar que la fecha de vencimiento del plan no haya pasado.\n   591→     *\n   592→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   593→     * @return bool\n   594→     * @author Andres Gonzalez\n   595→     */\n   596→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   597→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n   598→            return true;\n   599→        }\n   600→\n   601→        return false;\n   602→    }\n   603→\n   604→    /**\n   605→     * Verificar que el plan tenga vacantes disponibles.\n   606→     *\n   607→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   608→     * @return bool\n   609→     * @author Andres Gonzalez\n   610→     */\n   611→    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n   612→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n   613→    }\n   614→\n   615→    /**\n   616→     * Obtener creditos disponibles para un plan de empresa.\n   617→     *\n   618→     * @param int $empresa_plan_id ID del plan de empresa.\n   619→     * @return int\n   620→     * @author Sergio Vargas\n   621→     * @author Daniel Beltrán\n   622→     */\n   623→    public function creditosDisponibles(int $empresa_plan_id): int {\n   624→        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n   625→\n   626→        return $empresa_plan?->creditos_restantes ?? 0;\n   627→    }\n   628→\n   629→    /**\n   630→     * Obtener creditos disponibles y plan asignado de una empresa.\n   631→     *\n   632→     * @param int $empresa_id ID de la empresa.\n   633→     * @param Request $request Contenido de la peticion.\n   634→     * @return array|null\n   635→     * @author Sergio Vargas\n   636→     * @author José Manuel Jiménez\n   637→     */\n   638→    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n   639→        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n   640→            ? (int) $request->tipo_prueba_id\n   641→            : TipoPrueba::SELECCION_ID;\n   642→\n   643→        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   644→\n   645→        if (!$empresa_plan) {\n   646→            return null;\n   647→        }\n   648→\n   649→        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n   650→\n   651→        return [\n   652→            'empresa_id'           => $empresa_id,\n   653→            'empresa_plan_id'      => $empresa_plan->id,\n   654→            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n   655→            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n   656→            'plan_credito'         => $empresa_plan->planCredito ? [\n   657→                'id'       => $empresa_plan->planCredito->id,\n   658→                'nombre'   => $empresa_plan->planCredito->nombre,\n   659→                'creditos' => $empresa_plan->planCredito->creditos,\n   660→                'precio'   => $empresa_plan->planCredito->precio\n   661→            ] : null,\n   662→            'estado'               => $empresa_plan->estado ? [\n   663→                'id'     => $empresa_plan->estado->id,\n   664→                'nombre' => $empresa_plan->estado->nombre,\n   665→            ] : null\n   666→        ];\n   667→    }\n   668→\n   669→    /**\n   670→     * Validar si hay creditos suficientes.\n   671→     *\n   672→     * @param int $empresa_plan_id ID del plan de empresa.\n   673→     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n   674→     * @return bool\n   675→     * @author Sergio Vargas\n   676→     * @author Daniel Beltrán\n   677→     */\n   678→    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n   679→        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n   680→    }\n   681→}\n   682→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"f359fdd2-6e3d-4a8b-81a6-ba0329032d51","timestamp":"2026-01-22T21:38:46.424Z","sourceToolAssistantUUID":"10c2cac2-130b-4b31-9391-7fad8bea5057"}
{"parentUuid":"f359fdd2-6e3d-4a8b-81a6-ba0329032d51","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q3Z7xKJoTGerN1s9xKRTjg","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me look at the repositories and models to understand the full picture:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":21504,"cache_read_input_tokens":17039,"cache_creation":{"ephemeral_5m_input_tokens":21504,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP95fUWr3fpj1LrEH9Sz","type":"assistant","uuid":"4b9a54d0-44a0-40f4-b841-47ded23788e1","timestamp":"2026-01-22T21:38:48.747Z"}
{"parentUuid":"4b9a54d0-44a0-40f4-b841-47ded23788e1","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q3Z7xKJoTGerN1s9xKRTjg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0151msPJAHgDCrA8oTg3WaXB","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":21504,"cache_read_input_tokens":17039,"cache_creation":{"ephemeral_5m_input_tokens":21504,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP95fUWr3fpj1LrEH9Sz","type":"assistant","uuid":"1d8f1423-586d-4d58-afd4-5c6c56bbd545","timestamp":"2026-01-22T21:38:50.161Z"}
{"parentUuid":"1d8f1423-586d-4d58-afd4-5c6c56bbd545","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q3Z7xKJoTGerN1s9xKRTjg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019hJeHHpMQVZSJUVUzK6uM4","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":21504,"cache_read_input_tokens":17039,"cache_creation":{"ephemeral_5m_input_tokens":21504,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP95fUWr3fpj1LrEH9Sz","type":"assistant","uuid":"bdab32a8-0e77-401a-849f-ccc40f533187","timestamp":"2026-01-22T21:38:51.035Z"}
{"parentUuid":"bdab32a8-0e77-401a-849f-ccc40f533187","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q3Z7xKJoTGerN1s9xKRTjg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UHcGmpjDMKEqu7dk6opcva","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":21504,"cache_read_input_tokens":17039,"cache_creation":{"ephemeral_5m_input_tokens":21504,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP95fUWr3fpj1LrEH9Sz","type":"assistant","uuid":"6089a677-517b-48be-8d31-aec48b0bb57d","timestamp":"2026-01-22T21:38:51.090Z"}
{"parentUuid":"1d8f1423-586d-4d58-afd4-5c6c56bbd545","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0151msPJAHgDCrA8oTg3WaXB","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\IA;\n     4→\n     5→use Carbon\\Carbon;\n     6→use App\\Models\\IA\\ConsumoCredito;\n     7→use Illuminate\\Support\\Collection;\n     8→use App\\Http\\Repositories\\BaseRepository;\n     9→\n    10→class ConsumoCreditoRepository extends BaseRepository\n    11→{\n    12→    /**\n    13→     * Constructor.\n    14→     *\n    15→     * @param ConsumoCredito $modelo Modelo de consumos de créditos.\n    16→     * @return void\n    17→     * @author Sergio Vargas\n    18→     * @author Daniel Beltrán\n    19→     */\n    20→    public function __construct(ConsumoCredito $modelo) {\n    21→        parent::__construct($modelo);\n    22→    }\n    23→\n    24→    /**\n    25→     * Obtener consumo por usuario.\n    26→     *\n    27→     * @param int $usuario_id ID del usuario.\n    28→     * @param ?Carbon $desde Fecha inicial.\n    29→     * @param ?Carbon $hasta Fecha final.\n    30→     * @return Collection\n    31→     * @author Sergio Vargas\n    32→     * @author Daniel Beltrán\n    33→     */\n    34→    public function obtenerConsumoPorUsuario(int $usuario_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n    35→        return $this->modelo\n    36→        ->where('usuario_id', $usuario_id)\n    37→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n    38→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n    39→        ->get();\n    40→    }\n    41→\n    42→    /**\n    43→     * Obtener consumo por empresa.\n    44→     *\n    45→     * @param int $empresa_id ID de la empresa.\n    46→     * @param ?Carbon $desde Fecha inicial.\n    47→     * @param ?Carbon $hasta Fecha final.\n    48→     * @return Collection\n    49→     * @author Sergio Vargas\n    50→     * @author Daniel Beltrán\n    51→     */\n    52→    public function obtenerConsumoPorEmpresa(int $empresa_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n    53→        return $this->modelo\n    54→        ->where('empresa_id', $empresa_id)\n    55→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n    56→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n    57→        ->get();\n    58→    }\n    59→\n    60→    /**\n    61→     * Obtener historial de consumos por empresa.\n    62→     *\n    63→     * @param int $empresa_id ID de la empresa.\n    64→     * @param ?Carbon $desde Fecha inicial.\n    65→     * @param ?Carbon $hasta Fecha final.\n    66→     * @param ?int $servicio_ia_id ID del servicio IA.\n    67→     * @param ?int $usuario_id ID del usuario.\n    68→     * @return Collection\n    69→     * @author Sergio Vargas\n    70→     * @author Jair Carvajal\n    71→     */\n    72→    public function historialPorEmpresa(\n    73→        int $empresa_id,\n    74→        ?Carbon $desde = null,\n    75→        ?Carbon $hasta = null,\n    76→        ?int $servicio_ia_id = null,\n    77→        ?int $usuario_id = null\n    78→    ): Collection {\n    79→        return $this->modelo\n    80→        ->select('id', 'usuario_id', 'servicio_ia_id', 'creditos', 'tokens_totales', 'created_at', 'nombre_servicio', 'ruta_endpoint')\n    81→        ->with([\n    82→            'usuario:id,nombres,apellidos',\n    83→            'servicioIA:id,nombre'\n    84→        ])\n    85→        ->where('empresa_id', $empresa_id)\n    86→        ->when($servicio_ia_id, fn($consulta) => $consulta->where('servicio_ia_id', $servicio_ia_id))\n    87→        ->when($usuario_id, fn($consulta) => $consulta->where('usuario_id', $usuario_id))\n    88→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n    89→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n    90→        ->when($servicio_ia_id, fn($consulta) => $consulta->where('servicio_ia_id', $servicio_ia_id))\n    91→        ->when($usuario_id, fn($consulta) => $consulta->where('usuario_id', $usuario_id))\n    92→        ->orderBy('created_at', 'DESC')\n    93→        ->get();\n    94→    }\n    95→\n    96→    /**\n    97→     * Obtener estadísticas por endpoint.\n    98→     *\n    99→     * @param string $ruta_endpoint Endpoint.\n   100→     * @param ?Carbon $desde Fecha inicial.\n   101→     * @param ?Carbon $hasta Fecha final.\n   102→     * @return ?object\n   103→     * @author Sergio Vargas\n   104→     * @author Daniel Beltrán\n   105→     */\n   106→    public function obtenerEstadisticasPorEndpoint(string $ruta_endpoint, ?Carbon $desde = null, ?Carbon $hasta = null): ?object {\n   107→        return $this->modelo\n   108→        ->where('ruta_endpoint', $ruta_endpoint)\n   109→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n   110→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n   111→        ->selectRaw('\n   112→            COUNT(*) as total_peticiones,\n   113→            SUM(tokens_totales) as total_tokens,\n   114→            SUM(costo_estimado_usd) as costo_total,\n   115→            AVG(latencia_ms) as latencia_promedio_ms\n   116→        ')\n   117→        ->first();\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener consumos por plan de empresa.\n   122→     *\n   123→     * @param int $empresa_plan_id ID del plan de empresa.\n   124→     * @return Collection\n   125→     * @author Sergio Vargas\n   126→     * @author Daniel Beltrán\n   127→     */\n   128→    public function obtenerConsumoPorEmpresaPlan(int $empresa_plan_id): Collection {\n   129→        return $this->modelo\n   130→        ->where('empresa_plan_id', $empresa_plan_id)\n   131→        ->get();\n   132→    }\n   133→\n   134→    /**\n   135→     * Obtener estadísticas por servicio de IA.\n   136→     *\n   137→     * @param int $empresa_id ID de la empresa.\n   138→     * @return Collection\n   139→     * @author Sergio Vargas\n   140→     * @author Daniel Beltrán\n   141→     */\n   142→    public function estadisticasPorServicio(int $empresa_id): Collection {\n   143→        return $this->modelo\n   144→        ->where('empresa_id', $empresa_id)\n   145→        ->selectRaw('servicio_ia_id, COUNT(*) as total_peticiones, SUM(creditos) as total_creditos')\n   146→        ->groupBy('servicio_ia_id')\n   147→        ->get();\n   148→    }\n   149→\n   150→    /**\n   151→     * Obtener total de créditos consumidos por plan de empresa.\n   152→     *\n   153→     * @param int $empresa_plan_id ID del plan de empresa.\n   154→     * @return int\n   155→     * @author Sergio Vargas\n   156→     * @author Daniel Beltrán\n   157→     */\n   158→    public function totalCreditosConsumidos(int $empresa_plan_id): int {\n   159→        return (int) $this->modelo->where('empresa_plan_id', $empresa_plan_id)->sum('creditos');\n   160→    }\n   161→}\n   162→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"66e1742e-c7d8-4611-9811-14c093500dcd","timestamp":"2026-01-22T21:38:54.386Z","sourceToolAssistantUUID":"1d8f1423-586d-4d58-afd4-5c6c56bbd545"}
{"parentUuid":"6089a677-517b-48be-8d31-aec48b0bb57d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UHcGmpjDMKEqu7dk6opcva","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\IA;\n     4→\n     5→use App\\Models\\Usuarios\\User;\n     6→use App\\Models\\Agendas\\Agenda;\n     7→use App\\Models\\Empresas\\Empresa;\n     8→use App\\Models\\Vacantes\\Vacante;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use Illuminate\\Database\\Eloquent\\Model;\n    11→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    12→\n    13→class ConsumoCredito extends Model\n    14→{\n    15→    protected $table = 'consumos_creditos';\n    16→\n    17→    protected $fillable = [\n    18→        'usuario_id',\n    19→        'empresa_id',\n    20→        'empresa_plan_id',\n    21→        'agenda_id',\n    22→        'vacante_id',\n    23→        'servicio_ia_id',\n    24→        'creditos',\n    25→        'ruta_endpoint',\n    26→        'nombre_servicio',\n    27→        'modelo',\n    28→        'tokens_entrada',\n    29→        'tokens_salida',\n    30→        'tokens_totales',\n    31→        'caracteres_entrada',\n    32→        'costo_estimado_usd',\n    33→        'huella_peticion',\n    34→        'extracto_peticion',\n    35→        'extracto_respuesta',\n    36→        'estado',\n    37→        'latencia_ms',\n    38→        'mensaje_error'\n    39→    ];\n    40→\n    41→    protected $casts = [\n    42→        'usuario_id'         => 'integer',\n    43→        'empresa_id'         => 'integer',\n    44→        'empresa_plan_id'    => 'integer',\n    45→        'agenda_id'          => 'integer',\n    46→        'vacante_id'         => 'integer',\n    47→        'servicio_ia_id'     => 'integer',\n    48→        'creditos'           => 'integer',\n    49→        'tokens_entrada'     => 'integer',\n    50→        'tokens_salida'      => 'integer',\n    51→        'tokens_totales'     => 'integer',\n    52→        'caracteres_entrada' => 'integer',\n    53→        'costo_estimado_usd' => 'decimal:6',\n    54→        'latencia_ms'        => 'integer',\n    55→        'created_at'         => 'datetime'\n    56→    ];\n    57→\n    58→    public $timestamps = false;\n    59→\n    60→    /**\n    61→     * Relación de muchos a uno con users.\n    62→     *\n    63→     * @return BelongsTo\n    64→     * @author Sergio Vargas\n    65→     * @author Daniel Beltrán\n    66→     */\n    67→    public function usuario(): BelongsTo {\n    68→        return $this->belongsTo(User::class, 'usuario_id');\n    69→    }\n    70→\n    71→    /**\n    72→     * Relación de muchos a uno con empresas.\n    73→     *\n    74→     * @return BelongsTo\n    75→     * @author Sergio Vargas\n    76→     * @author Daniel Beltrán\n    77→     */\n    78→    public function empresa(): BelongsTo {\n    79→        return $this->belongsTo(Empresa::class);\n    80→    }\n    81→\n    82→    /**\n    83→     * Relación de muchos a uno con empresas_planes.\n    84→     *\n    85→     * @return BelongsTo\n    86→     * @author Sergio Vargas\n    87→     * @author Daniel Beltrán\n    88→     */\n    89→    public function empresaPlan(): BelongsTo {\n    90→        return $this->belongsTo(EmpresaPlan::class, 'empresa_plan_id');\n    91→    }\n    92→\n    93→    /**\n    94→     * Relación de muchos a uno con servicios_ia.\n    95→     *\n    96→     * @return BelongsTo\n    97→     * @author Sergio Vargas\n    98→     * @author Daniel Beltrán\n    99→     */\n   100→    public function servicioIA(): BelongsTo {\n   101→        return $this->belongsTo(ServicioIA::class, 'servicio_ia_id');\n   102→    }\n   103→\n   104→    /**\n   105→     * Relación de muchos a uno con agendas.\n   106→     *\n   107→     * @return BelongsTo\n   108→     * @author Sergio Vargas\n   109→     * @author Daniel Beltrán\n   110→     */\n   111→    public function agenda(): BelongsTo {\n   112→        return $this->belongsTo(Agenda::class);\n   113→    }\n   114→\n   115→    /**\n   116→     * Relación de muchos a uno con vacantes.\n   117→     *\n   118→     * @return BelongsTo\n   119→     * @author Sergio Vargas\n   120→     * @author Daniel Beltrán\n   121→     */\n   122→    public function vacante(): BelongsTo {\n   123→        return $this->belongsTo(Vacante::class);\n   124→    }\n   125→}\n   126→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"87dac6d7-fe67-4070-8fe1-a10692574fdc","timestamp":"2026-01-22T21:38:54.387Z","sourceToolAssistantUUID":"6089a677-517b-48be-8d31-aec48b0bb57d"}
{"parentUuid":"bdab32a8-0e77-401a-849f-ccc40f533187","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019hJeHHpMQVZSJUVUzK6uM4","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\Empresas;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\Pruebas\\TipoPrueba;\n     7→use Illuminate\\Support\\Collection;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use App\\Http\\Repositories\\BaseRepository;\n    11→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    12→use App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n    13→\n    14→class EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n    15→{\n    16→    /**\n    17→     * Ids de los roles de tipo empresa.\n    18→     *\n    19→     * @var array\n    20→     * @author Fahibram Cárcamo\n    21→     */\n    22→    private const IDS_ROLES_TIPO_EMPRESA = [\n    23→        RolRepository::ROL_PROPIETARIO_ID,\n    24→        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n    25→        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n    26→        RolRepository::ROL_EVALUADOR_ID\n    27→    ];\n    28→\n    29→    private $consulta_conteo_total_usuarios_empresa_sucursales;\n    30→\n    31→    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n    32→\n    33→    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n    39→     * @return void\n    40→     * @author Daniel Beltrán\n    41→     * @author Fahibram Cárcamo\n    42→     */\n    43→    public function __construct(EmpresaPlan $modelo) {\n    44→        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n    45→            (\n    46→                SELECT COUNT(DISTINCT eu.usuario_id)\n    47→                FROM empresas_usuarios AS eu\n    48→                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n    49→                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n    50→                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n    51→            ) AS conteo_total_usuarios_empresa_sucursales\n    52→        ';\n    53→\n    54→        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n    55→            (\n    56→                SELECT COUNT(*)\n    57→                FROM consumos\n    58→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    59→                WHERE (\n    60→                    consumos.empresa_id = empresas_planes.empresa_id\n    61→                    OR suc.empresa_id = empresas_planes.empresa_id\n    62→                )\n    63→                AND consumos.agenda_id IS NOT NULL\n    64→            ) AS conteo_total_consumos_agendas_empresa_sucursales\n    65→        ';\n    66→\n    67→        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n    68→            (\n    69→                SELECT COUNT(*)\n    70→                FROM consumos\n    71→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    72→                WHERE (\n    73→                    consumos.empresa_id = empresas_planes.empresa_id\n    74→                    OR suc.empresa_id = empresas_planes.empresa_id\n    75→                )\n    76→                AND consumos.oferta_laboral_id IS NOT NULL\n    77→            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n    78→        ';\n    79→\n    80→        parent::__construct($modelo);\n    81→    }\n    82→\n    83→    /**\n    84→     * Obtener todos los planes de empresas.\n    85→     *\n    86→     * @param Request $request Contenido de la petición.\n    87→     * @return Collection\n    88→     * @author Daniel Beltrán\n    89→     * @author Fahibram Cárcamo\n    90→     * @author Jair Carvajal\n    91→     * @author Andres Gonzalez\n    92→     */\n    93→    public function getTodo(Request $request): Collection {\n    94→        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n    95→            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    96→        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n    97→            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n    98→        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n    99→            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n   100→        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n   101→            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n   102→        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n   103→            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n   104→\n   105→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   106→        ->with([\n   107→            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n   108→            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   109→            'plan.tipoPrueba:id,nombre',\n   110→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   111→            'estado:id,nombre',\n   112→            'pruebas:id,nombre',\n   113→            'funcionalidades:id,nombre,predeterminado',\n   114→            'archivos' => function ($archivos) {\n   115→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   116→            }\n   117→        ])\n   118→        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   119→            $query->with([\n   120→                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   121→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   122→                        ->with(['empresa' => function ($empresa) {\n   123→                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n   124→                        }])\n   125→                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n   126→                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n   127→                },\n   128→                'consumos.agenda:id,prueba_id',\n   129→                'consumos.agenda.prueba:id,nombre,slug'\n   130→            ]);\n   131→        })\n   132→        ->when($con_conteo_consumos_agendas, function ($consulta) {\n   133→            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   134→        })\n   135→        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n   136→            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   137→        })\n   138→        ->when($con_conteo_consumos_creditos, function ($consulta) {\n   139→            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n   140→        })\n   141→        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n   142→            $query->where('empresa_id', $request->empresa_id);\n   143→        })\n   144→        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n   145→            $query->whereHas('plan', function ($plan) use ($request) {\n   146→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   147→            });\n   148→        })\n   149→        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n   150→            $query->whereHas('plan', function ($plan) use ($request) {\n   151→                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n   152→            });\n   153→        })\n   154→        ->when($request->filled('plan_id'), function ($query) use ($request) {\n   155→            $query->where('plan_id', $request->plan_id);\n   156→        })\n   157→        ->when(\n   158→            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n   159→            function ($query) use ($request) {\n   160→                $query->whereIn($request->campo, $request->valores);\n   161→            }\n   162→        )\n   163→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   164→            $consulta->whereIn('estado_id', $request->estado_id);\n   165→        })\n   166→        ->when(\n   167→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   168→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   169→        )\n   170→        ->when(\n   171→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   172→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   173→        )\n   174→        ->when(\n   175→            $request->filled('fecha_vencimiento_desde'),\n   176→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   177→        )\n   178→        ->when(\n   179→            $request->filled('fecha_vencimiento_hasta'),\n   180→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   181→        )\n   182→        ->when(\n   183→            $request->filled('fecha_inicio_desde'),\n   184→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   185→        )\n   186→        ->when(\n   187→            $request->filled('fecha_inicio_hasta'),\n   188→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   189→        )\n   190→        ->orderBy('created_at', 'DESC')\n   191→        ->get();\n   192→    }\n   193→\n   194→    /**\n   195→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n   196→     *\n   197→     * @param Request $request Contenido de la petición HTTP entrante.\n   198→     * @return Collection\n   199→     * @author Fahibram Cárcamo\n   200→     * @author Jair Carvajal\n   201→     */\n   202→    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n   203→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   204→            ->addSelect([\n   205→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   206→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   207→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   208→            ])\n   209→            ->whereExists(function ($subconsulta) {\n   210→                $subconsulta->select(DB::raw(1))\n   211→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   212→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   213→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   214→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   215→            })\n   216→            ->with([\n   217→                'estado:id,nombre',\n   218→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   219→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n   220→            ])\n   221→            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n   222→            ->when(\n   223→                $request->filled('tipo_prueba_id'),\n   224→                function ($consulta) use ($request) {\n   225→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   226→                },\n   227→                function ($consulta) {\n   228→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   229→                        TipoPrueba::SELECCION_ID,\n   230→                        TipoPrueba::ORGANIZACIONAL_ID,\n   231→                        TipoPrueba::VOCACIONAL_ID\n   232→                    ]));\n   233→                }\n   234→            )\n   235→            ->get();\n   236→    }\n   237→\n   238→    /**\n   239→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n   240→     *\n   241→     * @param Request $request Contenido de la petición HTTP entrante.\n   242→     * @return Collection\n   243→     * @author Fahibram Cárcamo\n   244→     * @author Andres Gonzalez\n   245→     * @author Jair Carvajal\n   246→     */\n   247→    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n   248→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   249→            ->addSelect([\n   250→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   251→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   252→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   253→            ])\n   254→            ->whereExists(function ($sub_consulta) {\n   255→                $sub_consulta->select(DB::raw(1))\n   256→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   257→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   258→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   259→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   260→            })\n   261→            ->with([\n   262→                'estado:id,nombre',\n   263→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   264→                'plan.tipoPrueba:id,nombre',\n   265→                'pruebas:id,nombre,slug',\n   266→                'funcionalidades:id,nombre,predeterminado',\n   267→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n   268→                'consumos' => function ($consumos) {\n   269→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   270→                        ->with([\n   271→                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   272→                            'agenda:id,prueba_id',\n   273→                            'agenda.prueba:id,nombre,slug'\n   274→                        ]);\n   275→                }\n   276→            ])\n   277→            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   278→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   279→            })\n   280→            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   281→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n   282→            })\n   283→            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n   284→                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n   285→                    $sub_consulta->where('empresa_id', $request->empresa_id)\n   286→                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n   287→                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n   288→                        });\n   289→                });\n   290→            })\n   291→            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   292→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   293→            }, function ($consulta) {\n   294→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   295→                    TipoPrueba::SELECCION_ID,\n   296→                    TipoPrueba::ORGANIZACIONAL_ID,\n   297→                    TipoPrueba::VOCACIONAL_ID\n   298→                ]));\n   299→            })\n   300→            ->orderBy('created_at', 'DESC')\n   301→            ->get();\n   302→    }\n   303→\n   304→    /**\n   305→     * Obtener datos básicos de los planes de empresas.\n   306→     *\n   307→     * @param Request $request Contenido de la petición.\n   308→     * @return Collection\n   309→     * @author Daniel Beltrán\n   310→     * @author Fahibram Cárcamo\n   311→     * @author Jair Carvajal\n   312→     * @author Sergio Vargas\n   313→     */\n   314→    public function getDatosBasicos(Request $request): Collection {\n   315→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   316→        ->with([\n   317→            'plan:id,tipo_prueba_id,nombre',\n   318→            'planCredito:id,nombre,creditos',\n   319→            'consumosCreditos'\n   320→        ])\n   321→        ->withCount([\n   322→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   323→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n   324→        ])\n   325→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   326→            $consulta->where('empresa_id', $request->empresa_id);\n   327→        })\n   328→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   329→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   330→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   331→            });\n   332→        })\n   333→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   334→            $consulta->whereIn('estado_id', $request->estados_ids);\n   335→        })\n   336→        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n   337→            $sentido = $request->ordenar_sentido ?? 'ASC';\n   338→            $consulta->orderBy($request->ordenar_por, $sentido);\n   339→        })\n   340→        ->get();\n   341→    }\n   342→\n   343→    /**\n   344→     * Obtener el proximo plan de creditos de la empresa.\n   345→     *\n   346→     * @param int $empresa_id ID de la empresa.\n   347→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   348→     * @return EmpresaPlan|null\n   349→     * @author Sergio Vargas\n   350→     */\n   351→    public function planProximoCreditos(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   352→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   353→        ->with(['planCredito:id,nombre,creditos,precio'])\n   354→        ->where([\n   355→            'empresa_id' => $empresa_id,\n   356→            'estado_id'  => 3\n   357→        ])\n   358→        ->whereNotNull('plan_credito_id')\n   359→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   360→            $query->where(function ($q) use ($tipo_prueba_id) {\n   361→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   362→                  ->orWhereNull('plan_id');\n   363→            });\n   364→        })\n   365→        ->orderBy('created_at', 'ASC')\n   366→        ->first();\n   367→    }\n   368→\n   369→    /**\n   370→     * Obtener el plan de creditos activo de la empresa.\n   371→     *\n   372→     * @param int $empresa_id ID de la empresa.\n   373→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   374→     * @return EmpresaPlan|null\n   375→     * @author Sergio Vargas\n   376→     */\n   377→    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   378→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   379→        ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n   380→        ->where('empresa_id', $empresa_id)\n   381→        ->whereNotNull('plan_credito_id')\n   382→        ->whereIn('estado_id', [1, 4])\n   383→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   384→            $query->where(function ($q) use ($tipo_prueba_id) {\n   385→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   386→                  ->orWhereNull('plan_id');\n   387→            });\n   388→        })\n   389→        ->first();\n   390→    }\n   391→\n   392→    /**\n   393→     * Obtener un plan de empresa.\n   394→     *\n   395→     * @param int $id ID del plan de empresa.\n   396→     * @return EmpresaPlan|null\n   397→     * @author Daniel Beltrán\n   398→     * @author Jair Carvajal\n   399→     */\n   400→    public function getUno(int $id): ?EmpresaPlan {\n   401→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   402→        ->with([\n   403→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n   404→            'plan.tipoPrueba:id,nombre',\n   405→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   406→            'estado:id,nombre',\n   407→            'pruebas:id,nombre,slug',\n   408→            'funcionalidades:id,nombre,llave,valor',\n   409→            'archivos' => function ($archivos) {\n   410→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   411→            }\n   412→        ])\n   413→        ->find($id);\n   414→    }\n   415→\n   416→    /**\n   417→     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n   418→     *\n   419→     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n   420→     *\n   421→     * @param int $empresa_id ID de la empresa.\n   422→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   423→     * @return EmpresaPlan|null\n   424→     * @author Daniel Beltrán\n   425→     * @author Fahibram Cárcamo\n   426→     * @author José Manuel Jiménez\n   427→     * @author Andres Gonzalez\n   428→     * @author Sergio Vargas\n   429→     * @author Jair Carvajal\n   430→     */\n   431→    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   432→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   433→        ->with([\n   434→            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n   435→            'plan.tipoPrueba:id,nombre',\n   436→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   437→            'estado:id,nombre',\n   438→            'pruebas:id,nombre,slug',\n   439→            'usuario:id,nombres,apellidos',\n   440→            'archivos' => function ($archivos) {\n   441→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   442→                ->orderBy('created_at', 'DESC');\n   443→            }\n   444→        ])\n   445→        ->withCount([\n   446→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   447→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n   448→            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n   449→        ])\n   450→        ->where('empresa_id', $empresa_id)\n   451→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   452→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   453→        })\n   454→        ->whereIn('estado_id', [1, 4])\n   455→        ->first();\n   456→    }\n   457→\n   458→    /**\n   459→     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n   460→     *\n   461→     * @param int $empresa_id ID de la empresa.\n   462→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   463→     * @return EmpresaPlan|null\n   464→     * @author Daniel Beltrán\n   465→     * @author Jair Carvajal\n   466→     */\n   467→    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   468→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   469→        ->with([\n   470→            'plan:id,tipo_prueba_id,nombre',\n   471→            'plan.tipoPrueba:id,nombre',\n   472→            'estado:id,nombre',\n   473→            'pruebas:id,nombre',\n   474→            'archivos' => function ($archivos) {\n   475→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   476→                ->orderBy('created_at', 'DESC');\n   477→            }\n   478→        ])\n   479→        ->where([\n   480→            'empresa_id' => $empresa_id,\n   481→            'estado_id'  => 3\n   482→        ])\n   483→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   484→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   485→        })\n   486→        ->first();\n   487→    }\n   488→\n   489→    /**\n   490→     * Obtener el último plan asignado.\n   491→     *\n   492→     * @param Request $request Contenido de la petición.\n   493→     * @return EmpresaPlan|null\n   494→     * @author Daniel Beltrán\n   495→     * @author Jair Carvajal\n   496→     */\n   497→    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n   498→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   499→        ->with([\n   500→            'plan:id,tipo_prueba_id,nombre',\n   501→            'plan.tipoPrueba:id,nombre',\n   502→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   503→            'estado:id,nombre',\n   504→            'pruebas:id,nombre',\n   505→            'archivos' => function ($archivos) {\n   506→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   507→                ->orderBy('created_at', 'DESC');\n   508→            }\n   509→        ])\n   510→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   511→            $consulta->where('empresa_id', $request->empresa_id);\n   512→        })\n   513→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   514→            $consulta->where('estado_id', $request->estado_id);\n   515→        })\n   516→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   517→            $consulta->whereIn('estado_id', $request->estados_ids);\n   518→        })\n   519→        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   520→            $consulta->where('estado_id', '!=', 3);\n   521→        })\n   522→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   523→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   524→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   525→            });\n   526→        })\n   527→        ->orderBy('created_at', 'DESC')\n   528→        ->first();\n   529→    }\n   530→\n   531→    /**\n   532→     * Sincronizar pruebas.\n   533→     *\n   534→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   535→     * @param array $pruebas ID's de las pruebas.\n   536→     * @return void\n   537→     * @author Daniel Beltrán\n   538→     */\n   539→    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n   540→        $empresa_plan->pruebas()->sync($pruebas);\n   541→    }\n   542→\n   543→    /**\n   544→     * Sincronizar funcionalidades.\n   545→     *\n   546→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   547→     * @param array $funcionalidades ID's de las funcionalidades.\n   548→     * @return void\n   549→     * @author Daniel Beltrán\n   550→     */\n   551→    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n   552→        $empresa_plan->funcionalidades()->sync($funcionalidades);\n   553→    }\n   554→\n   555→    /**\n   556→     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n   557→     *\n   558→     * @param Request $request Contenido de la petición.\n   559→     * @return ?EmpresaPlan\n   560→     * @author Fahibram Cárcamo\n   561→     * @author Jair Carvajal\n   562→     */\n   563→    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n   564→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   565→        ->with([\n   566→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n   567→            'plan.tipoPrueba:id,nombre',\n   568→            'estado:id,nombre',\n   569→            'pruebas:id,nombre',\n   570→            'funcionalidades:id,nombre,llave,valor'\n   571→        ])\n   572→        ->when(\n   573→            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n   574→            function ($consulta) {\n   575→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   576→            }\n   577→        )\n   578→        ->when(\n   579→            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n   580→            function ($consulta) {\n   581→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   582→            }\n   583→        )\n   584→        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n   585→        ->first();\n   586→    }\n   587→\n   588→    /**\n   589→     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n   590→     *\n   591→     * @return Collection\n   592→     * @author Fahibram Cárcamo\n   593→     * @author Andres Gonzalez\n   594→     * @author José Manuel Jiménez\n   595→     * @author Jair Carvajal\n   596→     * @author Daniel Beltrán\n   597→     */\n   598→    public function datosConsumosEmpresas(Request $request): Collection {\n   599→        $roles_tipo_empresa_ids = [\n   600→            RolRepository::ROL_PROPIETARIO_ID,\n   601→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   602→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   603→            RolRepository::ROL_EVALUADOR_ID\n   604→        ];\n   605→\n   606→        $matriz_conteos = [\n   607→            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n   608→            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n   609→            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n   610→                'empresasUsuarios',\n   611→                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n   612→            )\n   613→        ];\n   614→\n   615→        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n   616→\n   617→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   618→            ->addSelect([\n   619→                DB::raw('\n   620→                    (\n   621→                        SELECT COUNT(DISTINCT eu.usuario_id)\n   622→                        FROM empresas_usuarios AS eu\n   623→                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n   624→                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n   625→                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n   626→                    ) AS conteo_total_usuarios_empresa_sucursales\n   627→                '),\n   628→                DB::raw('\n   629→                    (\n   630→                        SELECT COUNT(*)\n   631→                        FROM consumos\n   632→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   633→                        WHERE (\n   634→                            consumos.empresa_id = empresas_planes.empresa_id\n   635→                            OR suc.empresa_id = empresas_planes.empresa_id\n   636→                        )\n   637→                        AND consumos.agenda_id IS NOT NULL\n   638→                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n   639→                '),\n   640→                DB::raw('\n   641→                    (\n   642→                        SELECT COUNT(*)\n   643→                        FROM consumos\n   644→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   645→                        WHERE (\n   646→                            consumos.empresa_id = empresas_planes.empresa_id\n   647→                            OR suc.empresa_id = empresas_planes.empresa_id\n   648→                        )\n   649→                        AND consumos.oferta_laboral_id IS NOT NULL\n   650→                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n   651→                '),\n   652→            ])\n   653→            ->with([\n   654→                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n   655→                'plan.tipoPrueba:id,nombre',\n   656→                'pruebas:id,nombre,slug',\n   657→                'estado:id,nombre',\n   658→                'usuario:id,nombres,apellidos',\n   659→                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n   660→                    $consulta_empresa->select($campos_empresas)\n   661→                        ->whereNull('empresa_id')\n   662→                        ->withCount([\n   663→                            ...$matriz_conteos,\n   664→                            'sucursales as conteo_sucursales'\n   665→                        ])\n   666→                        ->with([\n   667→                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n   668→                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n   669→                            }\n   670→                        ]);\n   671→                }\n   672→            ])\n   673→            ->when(\n   674→                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n   675→                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n   676→            )\n   677→            ->whereNotIn('estado_id', [3, 8])\n   678→            ->when(\n   679→                $request->filled('prueba_id'),\n   680→                fn($consulta) => $consulta->whereHas(\n   681→                    'pruebas',\n   682→                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n   683→                )\n   684→            )\n   685→            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n   686→                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n   687→            })\n   688→            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n   689→                switch ($request->plan_por) {\n   690→                    case 'por unidades':\n   691→                        $consulta_plan_por->whereNotNull('unidades');\n   692→                        break;\n   693→\n   694→                    case 'por ofertas laborales':\n   695→                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n   696→                        break;\n   697→\n   698→                    case 'por tiempo':\n   699→                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n   700→                        break;\n   701→                }\n   702→            })\n   703→            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n   704→                $fecha_inicio = $request->fecha_vencimiento;\n   705→                $fecha_fin    = $request->fecha_vencimiento;\n   706→\n   707→                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n   708→                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n   709→                    $fecha_inicio = $fechas[0];\n   710→                    $fecha_fin    = $fechas[1];\n   711→                }\n   712→\n   713→                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n   714→            })\n   715→            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n   716→                $fecha_inicio = $request->fecha_inicio;\n   717→                $fecha_fin    = $request->fecha_inicio;\n   718→\n   719→                if (strpos($request->fecha_inicio, ' a ') !== false) {\n   720→                    $fechas       = explode(' a ', $request->fecha_inicio);\n   721→                    $fecha_inicio = $fechas[0];\n   722→                    $fecha_fin    = $fechas[1];\n   723→                }\n   724→\n   725→                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n   726→            })\n   727→            ->when(\n   728→                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   729→                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n   730→            )\n   731→            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n   732→                if ($request->tipo_activacion === 'compra') {\n   733→                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n   734→                        $subconsulta->select(DB::raw(1))\n   735→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   736→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   737→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   738→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   739→                    });\n   740→                } elseif ($request->tipo_activacion === 'recompra') {\n   741→                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n   742→                        $subconsulta->select(DB::raw(1))\n   743→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   744→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   745→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   746→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   747→                    });\n   748→                }\n   749→            })\n   750→            ->get();\n   751→    }\n   752→\n   753→    /**\n   754→     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n   755→     *\n   756→     * @param Request $request Contenido de la petición HTTP entrante.\n   757→     * @return Collection\n   758→     * @author Fahibram Cárcamo\n   759→     */\n   760→    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n   761→        return $this->modelo::select(\n   762→            'empresas_planes.id',\n   763→            'empresas_planes.empresa_id',\n   764→            'empresas_planes.plan_id',\n   765→            'empresas_planes.plan_credito_id',\n   766→            'empresas_planes.usuario_id',\n   767→            'empresas_planes.estado_id',\n   768→            'empresas_planes.unidades',\n   769→            'empresas_planes.cantidad_ofertas_laborales',\n   770→            'empresas_planes.cantidad_usuarios',\n   771→            'empresas_planes.cantidad_pruebas',\n   772→            'empresas_planes.creditos',\n   773→            'empresas_planes.fecha_inicio',\n   774→            'empresas_planes.fecha_vencimiento',\n   775→            'empresas_planes.precio',\n   776→            'empresas_planes.porcentaje_descuento',\n   777→            'empresas_planes.numero_factura',\n   778→            'empresas_planes.comentario',\n   779→            'empresas_planes.plan_original',\n   780→            'empresas_planes.renovando',\n   781→            'empresas_planes.por_facturar',\n   782→            'empresas_planes.created_at',\n   783→            'planes.id',\n   784→            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n   785→            'planes.nombre AS plan_nombre',\n   786→            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n   787→            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n   788→            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n   789→            'planes.unidades AS plan_unidades',\n   790→            'planes.vigencia AS plan_vigencia',\n   791→            'planes.precio AS plan_precio',\n   792→            'tipos_pruebas.id AS tipo_prueba_id',\n   793→            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n   794→            'estados_planes.id AS estado_plan_id',\n   795→            'estados_planes.nombre AS estado_plan_nombre',\n   796→            'users.id AS usuario_usuario_id',\n   797→            'users.nombres AS usuario_nombres',\n   798→            'users.apellidos AS usuario_apellidos',\n   799→            'empresas.id AS empresa_empresa_id',\n   800→            'empresas.empresa_id',\n   801→            'empresas.nombre_comercial AS empresa_nombre_comercial',\n   802→            'empresas.razon_social AS empresa_razon_social',\n   803→            'empresas.nombre_contacto',\n   804→            'empresas.celular_contacto',\n   805→            'empresas.email_contacto',\n   806→            'empresas.telefono_contacto',\n   807→            'empresas.extension_contacto',\n   808→            'empresas.nombre_tesorero',\n   809→            'empresas.celular_tesorero',\n   810→            'empresas.telefono_tesorero',\n   811→            'empresas.email_tesorero',\n   812→            DB::raw('\n   813→                (\n   814→                    SELECT COUNT(*)\n   815→                    FROM consumos\n   816→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n   817→                )\n   818→                AS conteo_consumos_agendas\n   819→            '),\n   820→            DB::raw('\n   821→                (\n   822→                    SELECT COUNT(*)\n   823→                    FROM consumos\n   824→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n   825→                )\n   826→                AS conteo_consumos_ofertas_laborales\n   827→            '),\n   828→            DB::raw('\n   829→                (\n   830→                    SELECT COUNT(*)\n   831→                    FROM empresas\n   832→                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n   833→                )\n   834→                AS conteo_sucursales\n   835→            '),\n   836→            DB::raw('\n   837→                (\n   838→                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n   839→                    FROM empresas AS sucursales\n   840→                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n   841→                )\n   842→                AS nombres_comerciales_sucursales\n   843→            ')\n   844→        )\n   845→        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n   846→        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n   847→        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n   848→        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n   849→        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n   850→        ->whereNull('empresas.empresa_id')\n   851→        ->when(\n   852→            $request->filled('plan_por'),\n   853→            function ($consulta) use ($request) {\n   854→                switch ($request->plan_por) {\n   855→                    case 'por unidades':\n   856→                        $consulta->whereNotNull('empresas_planes.unidades');\n   857→                        break;\n   858→\n   859→                    case 'por ofertas laborales':\n   860→                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n   861→                        break;\n   862→\n   863→                    case 'por tiempo':\n   864→                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n   865→                        break;\n   866→                }\n   867→            }\n   868→        )\n   869→        ->when(\n   870→            $request->filled('tipo_prueba_id'),\n   871→            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n   872→            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n   873→                TipoPrueba::SELECCION_ID,\n   874→                TipoPrueba::ORGANIZACIONAL_ID,\n   875→                TipoPrueba::VOCACIONAL_ID\n   876→            ])\n   877→        )\n   878→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n   879→        ->when(\n   880→            $request->filled('ejecutivo_id'),\n   881→            function ($consulta) use ($request) {\n   882→                $consulta->whereExists(function ($subconsulta) use ($request) {\n   883→                    $subconsulta->select(DB::raw(1))\n   884→                        ->from('empresas_usuarios')\n   885→                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n   886→                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n   887→                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n   888→                });\n   889→            }\n   890→        )\n   891→        ->when(\n   892→            $request->filled('fecha_vencimiento'),\n   893→            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n   894→        )\n   895→        ->when(\n   896→            $request->filled('fecha_inicio'),\n   897→            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n   898→        )\n   899→        ->when(\n   900→            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   901→            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n   902→        )\n   903→        ->get();\n   904→    }\n   905→\n   906→    /**\n   907→     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n   908→     *\n   909→     * @param int $empresa_id ID de la empresa.\n   910→     * @param Request $request Contenido de la peticion.\n   911→     * @return Collection\n   912→     * @author Sergio Vargas\n   913→     */\n   914→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   915→        return $this->modelo::select(\n   916→            'id',\n   917→            'empresa_id',\n   918→            'plan_credito_id',\n   919→            'estado_id',\n   920→            'creditos',\n   921→            'fecha_inicio',\n   922→            'fecha_vencimiento',\n   923→            'precio',\n   924→            'porcentaje_descuento',\n   925→            'numero_factura',\n   926→            'comentario',\n   927→            'created_at'\n   928→        )\n   929→        ->with([\n   930→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   931→            'estado:id,nombre',\n   932→            'archivos' => function ($archivos) {\n   933→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   934→                    ->orderBy('created_at', 'DESC');\n   935→            }\n   936→        ])\n   937→        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n   938→        ->where('empresa_id', $empresa_id)\n   939→        ->whereNotNull('plan_credito_id')\n   940→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n   941→        ->when(\n   942→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   943→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   944→        )\n   945→        ->when(\n   946→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   947→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   948→        )\n   949→        ->when(\n   950→            $request->filled('fecha_vencimiento_desde'),\n   951→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   952→        )\n   953→        ->when(\n   954→            $request->filled('fecha_vencimiento_hasta'),\n   955→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   956→        )\n   957→        ->when(\n   958→            $request->filled('fecha_inicio_desde'),\n   959→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   960→        )\n   961→        ->when(\n   962→            $request->filled('fecha_inicio_hasta'),\n   963→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   964→        )\n   965→        ->orderBy('created_at', 'DESC')\n   966→        ->get();\n   967→    }\n   968→}\n   969→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5f315a49-e9f0-4c4c-a8ca-2b800a8ca3da","timestamp":"2026-01-22T21:38:54.605Z","sourceToolAssistantUUID":"bdab32a8-0e77-401a-849f-ccc40f533187"}
{"parentUuid":"5f315a49-e9f0-4c4c-a8ca-2b800a8ca3da","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Fwgumbniepr3jSAdiNpK7v","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check how credit consumption is triggered from controllers and where the plan selection happens:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1571,"cache_creation_input_tokens":20434,"cache_read_input_tokens":38543,"cache_creation":{"ephemeral_5m_input_tokens":20434,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP96Fa7S2qTHHetV82TB","type":"assistant","uuid":"5a06397c-8263-424c-ad5b-5a63c0c506a4","timestamp":"2026-01-22T21:38:56.838Z"}
{"parentUuid":"5a06397c-8263-424c-ad5b-5a63c0c506a4","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Fwgumbniepr3jSAdiNpK7v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PFCVdhk9QqVj31syDLnzAa","name":"Grep","input":{"pattern":"registrarConsumoDesdeRespuesta|creditosDisponiblesEmpresa|planCreditosActivo","type":"php","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1571,"cache_creation_input_tokens":20434,"cache_read_input_tokens":38543,"cache_creation":{"ephemeral_5m_input_tokens":20434,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP96Fa7S2qTHHetV82TB","type":"assistant","uuid":"d74f08f8-3c56-42bc-8653-45f3f524bb36","timestamp":"2026-01-22T21:38:58.474Z"}
{"parentUuid":"d74f08f8-3c56-42bc-8653-45f3f524bb36","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Fwgumbniepr3jSAdiNpK7v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01THoiyYpw4FWggXEHNtG7cq","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php","limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1571,"cache_creation_input_tokens":20434,"cache_read_input_tokens":38543,"cache_creation":{"ephemeral_5m_input_tokens":20434,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP96Fa7S2qTHHetV82TB","type":"assistant","uuid":"9447aed8-24ad-4dc6-bf6a-a4fa8b5fcdb6","timestamp":"2026-01-22T21:38:59.371Z"}
{"parentUuid":"9447aed8-24ad-4dc6-bf6a-a4fa8b5fcdb6","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01THoiyYpw4FWggXEHNtG7cq","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Empresas;\n     4→\n     5→use App\\Models\\Planes\\Plan;\n     6→use App\\Models\\Usuarios\\User;\n     7→use App\\Models\\Planes\\Consumo;\n     8→use App\\Models\\Pruebas\\Prueba;\n     9→use OwenIt\\Auditing\\Auditable;\n    10→use App\\Models\\IA\\ConsumoCredito;\n    11→use App\\Models\\Planes\\EstadoPlan;\n    12→use App\\Models\\Planes\\PlanCredito;\n    13→use App\\Models\\Planes\\Funcionalidad;\n    14→use App\\Models\\Configuraciones\\Archivo;\n    15→use Illuminate\\Database\\Eloquent\\Model;\n    16→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n    17→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    18→use Illuminate\\Database\\Eloquent\\Relations\\MorphMany;\n    19→use Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n    20→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    21→\n    22→class EmpresaPlan extends Model implements AuditableContract\n    23→{\n    24→    use Auditable;\n    25→\n    26→    protected $table = 'empresas_planes';\n    27→\n    28→    protected $fillable = [\n    29→        'empresa_id',\n    30→        'plan_id',\n    31→        'plan_credito_id',\n    32→        'usuario_id',\n    33→        'estado_id',\n    34→        'unidades',\n    35→        'cantidad_ofertas_laborales',\n    36→        'cantidad_usuarios',\n    37→        'cantidad_pruebas',\n    38→        'creditos',\n    39→        'fecha_inicio',\n    40→        'fecha_vencimiento',\n    41→        'precio',\n    42→        'porcentaje_descuento',\n    43→        'numero_factura',\n    44→        'comentario',\n    45→        'plan_original',\n    46→        'renovando',\n    47→        'por_facturar'\n    48→    ];\n    49→\n    50→    protected $casts = [\n    51→        'plan_credito_id'   => 'integer',\n    52→        'creditos'          => 'integer',\n    53→        'fecha_inicio'      => 'date:Y-m-d',\n    54→        'fecha_vencimiento' => 'date:Y-m-d'\n    55→    ];\n    56→\n    57→    protected $appends = [\n    58→        'vigencia_dias',\n    59→        'creditos_restantes'\n    60→    ];\n    61→\n    62→    /**\n    63→     * Obtener el atributo vigencia_dias.\n    64→     *\n    65→     * @return int\n    66→     * @author Daniel Beltrán\n    67→     */\n    68→    public function getVigenciaDiasAttribute(): int {\n    69→        $vigencia = 0;\n    70→\n    71→        if (!is_null($this->fecha_vencimiento) && !is_null($this->fecha_inicio)) {\n    72→            $vigencia = $this->fecha_inicio->diffInDays($this->fecha_vencimiento);\n    73→        }\n    74→\n    75→        return $vigencia;\n    76→    }\n    77→\n    78→    /**\n    79→     * Obtener el atributo creditos_restantes.\n    80→     *\n    81→     * @return int\n    82→     * @author Sergio Vargas\n    83→     * @author Daniel Beltrán\n    84→     */\n    85→    public function getCreditosRestantesAttribute(): int {\n    86→        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    87→    }\n    88→\n    89→    /**\n    90→     * Relación de muchos a uno con empresas.\n    91→     *\n    92→     * @return BelongsTo\n    93→     * @author Daniel Beltrán\n    94→     */\n    95→    public function empresa(): BelongsTo {\n    96→        return $this->belongsTo(Empresa::class);\n    97→    }\n    98→\n    99→    /**\n   100→     * Relación de muchos a uno con planes.\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1407ddb9-026c-4cff-ad9c-bff06d04a7b2","timestamp":"2026-01-22T21:39:03.049Z","sourceToolAssistantUUID":"9447aed8-24ad-4dc6-bf6a-a4fa8b5fcdb6"}
{"parentUuid":"d74f08f8-3c56-42bc-8653-45f3f524bb36","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PFCVdhk9QqVj31syDLnzAa","type":"tool_result","content":"Found 9 files\nroutes\\web.php\napp\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php\napp\\Http\\Services\\IA\\ConsumoCreditoService.php\napp\\Http\\Controllers\\Empresas\\EmpresaPlanController.php\napp\\Http\\Services\\Empresas\\EmpresaPlanService.php\napp\\Http\\Services\\Empresas\\EmpresaService.php\napp\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php\napp\\Http\\Services\\Usuarios\\CompletarDatosService.php\napp\\Traits\\IATrait.php"}]},"uuid":"4d973ca5-9b55-40fe-ae44-1897ee334310","timestamp":"2026-01-22T21:39:03.729Z","sourceToolAssistantUUID":"d74f08f8-3c56-42bc-8653-45f3f524bb36"}
{"parentUuid":"4d973ca5-9b55-40fe-ae44-1897ee334310","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015bR2C99We5aqvNTT39wKaE","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the IATrait and look for where credits are actually consumed:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1295,"cache_creation_input_tokens":2375,"cache_read_input_tokens":58977,"cache_creation":{"ephemeral_5m_input_tokens":2375,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP96uxS63At8gEq7hzYs","type":"assistant","uuid":"268a1cf6-d36a-4567-b60c-02d7eaeb35da","timestamp":"2026-01-22T21:39:06.719Z"}
{"parentUuid":"268a1cf6-d36a-4567-b60c-02d7eaeb35da","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015bR2C99We5aqvNTT39wKaE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CJ9gqs3oY7NZDkpeRUjeH8","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Traits\\IATrait.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1295,"cache_creation_input_tokens":2375,"cache_read_input_tokens":58977,"cache_creation":{"ephemeral_5m_input_tokens":2375,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP96uxS63At8gEq7hzYs","type":"assistant","uuid":"c37cb7fb-5e4e-41e0-8a61-e34525493ec8","timestamp":"2026-01-22T21:39:07.961Z"}
{"parentUuid":"c37cb7fb-5e4e-41e0-8a61-e34525493ec8","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CJ9gqs3oY7NZDkpeRUjeH8","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Traits;\n     4→\n     5→use Exception;\n     6→use Illuminate\\Http\\UploadedFile;\n     7→use Illuminate\\Support\\Facades\\App;\n     8→use Illuminate\\Support\\Facades\\Http;\n     9→use App\\Http\\Services\\IA\\CreditoIAService;\n    10→use Illuminate\\Http\\Client\\RequestException;\n    11→use App\\Http\\Services\\IA\\ConsumoCreditoService;\n    12→use Illuminate\\Http\\Client\\ConnectionException;\n    13→\n    14→trait IATrait\n    15→{\n    16→    /**\n    17→     * Realizar petición a la IA.\n    18→     *\n    19→     * @param string $ruta Ruta del API de la IA.\n    20→     * @param array $parametros Parámetros a enviar a la IA (array asociativo).\n    21→     * @param bool $con_archivos Indica si la petición incluye archivos.\n    22→     * @param array $contexto_tracking Contexto para tracking (vacante_id, agenda_id, etc.)\n    23→     * @return array\n    24→     * @author Sergio Vargas\n    25→     * @author Daniel Beltrán\n    26→     */\n    27→    public function realizarPeticionIA(string $ruta, array $parametros, bool $con_archivos = false, array $contexto_tracking = []): array {\n    28→        $enlace_base      = config('app.psicoalianza_api_ia_url_base');\n    29→        $tiempo_inicio    = microtime(true);\n    30→        $payload_peticion = $con_archivos ? '[datos con archivos]' : json_encode($parametros);\n    31→\n    32→        // Propagar vacante_id desde los parámetros si no vino en el contexto explícito\n    33→        if (!isset($contexto_tracking['vacante_id']) && isset($parametros['vacante_id'])) {\n    34→            $contexto_tracking['vacante_id'] = $parametros['vacante_id'];\n    35→        }\n    36→\n    37→        $validacion_creditos = $this->validarCreditosParaLlamada($ruta, $contexto_tracking);\n    38→\n    39→        if (!$validacion_creditos['puede_llamar']) {\n    40→            return [\n    41→                'status_code' => 403,\n    42→                'error'       => $validacion_creditos['mensaje'],\n    43→            ];\n    44→        }\n    45→\n    46→        if ($validacion_creditos['empresa_plan_id'] ?? null) {\n    47→            $contexto_tracking['empresa_plan_id'] = $validacion_creditos['empresa_plan_id'];\n    48→        }\n    49→\n    50→        try {\n    51→            if ($con_archivos) {\n    52→                $peticion = Http::asMultipart();\n    53→\n    54→                foreach ($parametros as $nombre => $valor) {\n    55→                    if ($valor instanceof UploadedFile) {\n    56→                        $peticion->attach($nombre, file_get_contents($valor->getRealPath()), $valor->getClientOriginalName());\n    57→                    } elseif (is_resource($valor)) {\n    58→                        // Manejar recursos de archivo (fopen)\n    59→                        $contenido      = stream_get_contents($valor);\n    60→                        $nombre_archivo = $parametros['nombre_archivo'] ?? 'archivo.bin';\n    61→                        $peticion->attach($nombre, $contenido, $nombre_archivo);\n    62→                    } else {\n    63→                        $peticion->attach($nombre, $valor);\n    64→                    }\n    65→                }\n    66→\n    67→                $respuesta = $peticion->post(\"{$enlace_base}/{$ruta}\")->json();\n    68→            } else {\n    69→                $respuesta = Http::post(\"{$enlace_base}/{$ruta}\", $parametros)->json();\n    70→            }\n    71→\n    72→            $latencia_ms = (int) ((microtime(true) - $tiempo_inicio) * 1000);\n    73→\n    74→            // Registrar consumo de tokens (solo si la respuesta es válida)\n    75→            if (is_array($respuesta)) {\n    76→                if ($this->esRespuestaExitosa($respuesta)) {\n    77→                    $contexto_tracking = array_merge(\n    78→                        $contexto_tracking,\n    79→                        $this->consumirCreditosDespuesLlamada($ruta, $contexto_tracking)\n    80→                    );\n    81→                }\n    82→\n    83→                $this->registrarConsumoTokens(\n    84→                    ruta_endpoint: $ruta,\n    85→                    respuesta_ia: $respuesta,\n    86→                    payload_peticion: $payload_peticion,\n    87→                    latencia_ms: $latencia_ms,\n    88→                    contexto: $contexto_tracking\n    89→                );\n    90→            }\n    91→\n    92→            return $respuesta ?? [];\n    93→        } catch (RequestException|ConnectionException $error) {\n    94→            $this->registrarConsumoTokens(\n    95→                ruta_endpoint: $ruta,\n    96→                respuesta_ia: [\n    97→                    'status_code' => 500,\n    98→                    'error'       => $error->getMessage(),\n    99→                ],\n   100→                payload_peticion: $payload_peticion,\n   101→                latencia_ms: (int) ((microtime(true) - $tiempo_inicio) * 1000),\n   102→                contexto: $contexto_tracking\n   103→            );\n   104→\n   105→            return [];\n   106→        }\n   107→    }\n   108→\n   109→    /**\n   110→     * Realizar petición a la IA con soporte para arrays anidados recursivos.\n   111→     *\n   112→     * Esta función sirve para poder enviar arrays de objetos hacia algún endpoint de IA.\n   113→     *\n   114→     * @param string $ruta Ruta del API de la IA.\n   115→     * @param array $parametros Parámetros a enviar a la IA (array asociativo, puede contener arrays anidados).\n   116→     * @param bool $con_archivos Indica si la petición incluye archivos.\n   117→     * @param array $contexto_tracking Contexto para tracking (vacante_id, agenda_id, etc.)\n   118→     * @return array\n   119→     * @author Sergio Vargas\n   120→     * @author Daniel Beltrán\n   121→     */\n   122→    public function realizarPeticionIARecursiva(string $ruta, array $parametros, bool $con_archivos = false, array $contexto_tracking = []): array {\n   123→        $enlace_base      = config('app.psicoalianza_api_ia_url_base');\n   124→        $tiempo_inicio    = microtime(true);\n   125→        $payload_peticion = $con_archivos ? '[datos con archivos recursivos]' : json_encode($parametros);\n   126→\n   127→        // Propagar vacante_id desde los parámetros si no vino en el contexto explícito\n   128→        if (!isset($contexto_tracking['vacante_id']) && isset($parametros['vacante_id'])) {\n   129→            $contexto_tracking['vacante_id'] = $parametros['vacante_id'];\n   130→        }\n   131→\n   132→        $validacion_creditos = $this->validarCreditosParaLlamada($ruta, $contexto_tracking);\n   133→\n   134→        if (!$validacion_creditos['puede_llamar']) {\n   135→            return [\n   136→                'status_code' => 403,\n   137→                'error'       => $validacion_creditos['mensaje'],\n   138→            ];\n   139→        }\n   140→\n   141→        if ($validacion_creditos['empresa_plan_id'] ?? null) {\n   142→            $contexto_tracking['empresa_plan_id'] = $validacion_creditos['empresa_plan_id'];\n   143→        }\n   144→\n   145→        try {\n   146→            if ($con_archivos) {\n   147→                $peticion = Http::timeout(300)->asMultipart();\n   148→\n   149→                foreach ($parametros as $nombre => $valor) {\n   150→                    $this->adjuntarParametroRecursivo($peticion, $nombre, $valor);\n   151→                }\n   152→\n   153→                $respuesta = $peticion->post(\"{$enlace_base}/{$ruta}\")->json();\n   154→            } else {\n   155→                $respuesta = Http::timeout(300)->post(\"{$enlace_base}/{$ruta}\", $parametros)->json();\n   156→            }\n   157→\n   158→            $latencia_ms = (int) ((microtime(true) - $tiempo_inicio) * 1000);\n   159→\n   160→            // Registrar consumo de tokens (solo si la respuesta es válida)\n   161→            if (is_array($respuesta)) {\n   162→                if ($this->esRespuestaExitosa($respuesta)) {\n   163→                    $contexto_tracking = array_merge(\n   164→                        $contexto_tracking,\n   165→                        $this->consumirCreditosDespuesLlamada($ruta, $contexto_tracking)\n   166→                    );\n   167→                }\n   168→\n   169→                $this->registrarConsumoTokens(\n   170→                    ruta_endpoint: $ruta,\n   171→                    respuesta_ia: $respuesta,\n   172→                    payload_peticion: $payload_peticion,\n   173→                    latencia_ms: $latencia_ms,\n   174→                    contexto: $contexto_tracking\n   175→                );\n   176→            }\n   177→\n   178→            return $respuesta ?? [];\n   179→        } catch (RequestException|ConnectionException $error) {\n   180→            $this->registrarConsumoTokens(\n   181→                ruta_endpoint: $ruta,\n   182→                respuesta_ia: [\n   183→                    'status_code' => 500,\n   184→                    'error'       => $error->getMessage(),\n   185→                ],\n   186→                payload_peticion: $payload_peticion,\n   187→                latencia_ms: (int) ((microtime(true) - $tiempo_inicio) * 1000),\n   188→                contexto: $contexto_tracking\n   189→            );\n   190→\n   191→            return [];\n   192→        }\n   193→    }\n   194→\n   195→    /**\n   196→     * Adjuntar parámetro de forma recursiva, manejando arrays anidados.\n   197→     *\n   198→     * @param mixed $peticion Instancia de la petición HTTP.\n   199→     * @param string $nombre Nombre del parámetro.\n   200→     * @param mixed $valor Valor del parámetro.\n   201→     * @return void\n   202→     * @author Sergio Vargas\n   203→     * @author Daniel Beltrán\n   204→     */\n   205→    private function adjuntarParametroRecursivo(mixed $peticion, string $nombre, mixed $valor): void {\n   206→        if ($valor instanceof UploadedFile) {\n   207→            $peticion->attach($nombre, file_get_contents($valor->getRealPath()), $valor->getClientOriginalName());\n   208→        } elseif (is_resource($valor)) {\n   209→            $contenido      = stream_get_contents($valor);\n   210→            $nombre_archivo = 'archivo.bin';\n   211→            $peticion->attach($nombre, $contenido, $nombre_archivo);\n   212→        } elseif (is_array($valor)) {\n   213→            foreach ($valor as $key => $item) {\n   214→                $this->adjuntarParametroRecursivo($peticion, \"{$nombre}[{$key}]\", $item);\n   215→            }\n   216→        } else {\n   217→            $peticion->attach($nombre, (string) $valor);\n   218→        }\n   219→    }\n   220→\n   221→    /**\n   222→     * Registrar consumo de tokens de OpenAI.\n   223→     *\n   224→     * @param string $ruta_endpoint Ruta del endpoint utilizado.\n   225→     * @param array $respuesta_ia Respuesta de la API de IA.\n   226→     * @param string $payload_peticion Payload de la petición.\n   227→     * @param int $latencia_ms Latencia en milisegundos.\n   228→     * @param array $contexto Contexto adicional (vacante_id, agenda_id, etc).\n   229→     * @return void\n   230→     * @author Sergio Vargas\n   231→     * @author Daniel Beltrán\n   232→     */\n   233→    private function registrarConsumoTokens(\n   234→        string $ruta_endpoint,\n   235→        array $respuesta_ia,\n   236→        string $payload_peticion,\n   237→        int $latencia_ms,\n   238→        array $contexto\n   239→    ): void {\n   240→        $servicio_token = App::make(ConsumoCreditoService::class);\n   241→\n   242→        $servicio_token->registrarConsumoDesdeRespuesta(\n   243→            ruta_endpoint: $ruta_endpoint,\n   244→            respuesta_ia: $respuesta_ia,\n   245→            usuario_id: auth()->id(),\n   246→            empresa_id: session('empresa_id'),\n   247→            contexto: $contexto,\n   248→            payload_peticion: $payload_peticion,\n   249→            latencia_ms: $latencia_ms\n   250→        );\n   251→    }\n   252→\n   253→    /**\n   254→     * Validar créditos disponibles antes de llamar la IA.\n   255→     *\n   256→     * @param string $endpoint Endpoint.\n   257→     * @param array $contexto Contexto.\n   258→     * @return array\n   259→     * @author Sergio Vargas\n   260→     * @author Daniel Beltrán\n   261→     */\n   262→    private function validarCreditosParaLlamada(string $endpoint, array $contexto): array {\n   263→        try {\n   264→            $servicio_creditos = App::make(CreditoIAService::class);\n   265→            $empresa_plan_id   = $contexto['empresa_plan_id'] ?? null;\n   266→            $empresa_id        = $contexto['empresa_id'] ?? session('empresa_id');\n   267→\n   268→            $resultado = $servicio_creditos->validarCreditosDisponibles(\n   269→                $empresa_plan_id,\n   270→                $endpoint,\n   271→                $empresa_id\n   272→            );\n   273→\n   274→            if (!$resultado['tiene_creditos']) {\n   275→                return [\n   276→                    'puede_llamar'         => false,\n   277→                    'creditos_necesarios'  => $resultado['creditos_necesarios'],\n   278→                    'creditos_disponibles' => $resultado['creditos_disponibles'],\n   279→                    'empresa_plan_id'      => $resultado['empresa_plan_id'],\n   280→                    'mensaje'              => 'No tienes créditos disponibles en este momento. Renueva tu plan o adquiere más créditos para continuar.'\n   281→                ];\n   282→            }\n   283→\n   284→            return [\n   285→                'puede_llamar'         => true,\n   286→                'creditos_necesarios'  => $resultado['creditos_necesarios'],\n   287→                'creditos_disponibles' => $resultado['creditos_disponibles'],\n   288→                'empresa_plan_id'      => $resultado['empresa_plan_id'],\n   289→                'servicio_ia_id'       => $resultado['servicio_ia_id'],\n   290→                'mensaje'              => 'ok'\n   291→            ];\n   292→        } catch (Exception $error) {\n   293→            return [\n   294→                'puede_llamar'         => true,\n   295→                'creditos_necesarios'  => 0,\n   296→                'creditos_disponibles' => 0,\n   297→                'empresa_plan_id'      => $contexto['empresa_plan_id'] ?? null,\n   298→                'mensaje'              => 'ok'\n   299→            ];\n   300→        }\n   301→    }\n   302→\n   303→    /**\n   304→     * Preparar datos para consumo de créditos.\n   305→     *\n   306→     * @param string $endpoint Endpoint.\n   307→     * @param array $contexto Contexto.\n   308→     * @return array\n   309→     * @author Sergio Vargas\n   310→     * @author Daniel Beltrán\n   311→     */\n   312→    private function consumirCreditosDespuesLlamada(string $endpoint, array $contexto): array {\n   313→        try {\n   314→            $servicio_creditos = App::make(CreditoIAService::class);\n   315→            $empresa_plan_id   = $contexto['empresa_plan_id'] ?? null;\n   316→            $empresa_id        = $contexto['empresa_id'] ?? session('empresa_id');\n   317→\n   318→            return $servicio_creditos->prepararConsumo($empresa_plan_id, $endpoint, $empresa_id);\n   319→        } catch (Exception $error) {\n   320→            return [\n   321→                'empresa_plan_id' => $contexto['empresa_plan_id'] ?? null,\n   322→                'servicio_ia_id'  => null,\n   323→                'creditos'        => 0\n   324→            ];\n   325→        }\n   326→    }\n   327→\n   328→    /**\n   329→     * Determinar si la respuesta de IA fue éxitosa.\n   330→     *\n   331→     * @param array $respuesta Respuesta.\n   332→     * @return bool\n   333→     * @author Sergio Vargas\n   334→     * @author Daniel Beltrán\n   335→     */\n   336→    private function esRespuestaExitosa(array $respuesta): bool {\n   337→        if (isset($respuesta['error'])) {\n   338→            return false;\n   339→        }\n   340→\n   341→        if (isset($respuesta['status_code'])) {\n   342→            return (int) $respuesta['status_code'] === 200;\n   343→        }\n   344→\n   345→        return true;\n   346→    }\n   347→}\n   348→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"73bcbfa7-f894-40e1-a881-6aecbe6a8e42","timestamp":"2026-01-22T21:39:10.171Z","sourceToolAssistantUUID":"c37cb7fb-5e4e-41e0-8a61-e34525493ec8"}
{"parentUuid":"73bcbfa7-f894-40e1-a881-6aecbe6a8e42","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DaurPNk89fnbkU2vYAVHsj","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the CreditoIAService which contains the plan selection logic:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":6496,"cache_read_input_tokens":61352,"cache_creation":{"ephemeral_5m_input_tokens":6496,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP97Q1tm9dtFom3JdFKW","type":"assistant","uuid":"84e1e7b7-5d3f-45c2-bedb-2737b45cf61a","timestamp":"2026-01-22T21:39:14.809Z"}
{"parentUuid":"84e1e7b7-5d3f-45c2-bedb-2737b45cf61a","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DaurPNk89fnbkU2vYAVHsj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PaNTVYCYiDa4KsCTH1HAW8","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\CreditoIAService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":6496,"cache_read_input_tokens":61352,"cache_creation":{"ephemeral_5m_input_tokens":6496,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP97Q1tm9dtFom3JdFKW","type":"assistant","uuid":"840deb9d-aebb-4018-a7cb-6e030b825cbf","timestamp":"2026-01-22T21:39:14.856Z"}
{"parentUuid":"840deb9d-aebb-4018-a7cb-6e030b825cbf","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PaNTVYCYiDa4KsCTH1HAW8","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\IA;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\IA\\ServicioIA;\n     7→use App\\Models\\Pruebas\\TipoPrueba;\n     8→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n     9→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    10→\n    11→class CreditoIAService\n    12→{\n    13→    /**\n    14→     * Constructor.\n    15→     *\n    16→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios de IA.\n    17→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n    18→     * @return void\n    19→     * @author Sergio Vargas\n    20→     * @author Daniel Beltrán\n    21→     */\n    22→    public function __construct(\n    23→        private ServicioIARepository $servicio_ia_repositorio,\n    24→        private EmpresaPlanRepository $empresa_plan_repositorio\n    25→    ) {}\n    26→\n    27→    /**\n    28→     * Validar si hay créditos disponibles para un endpoint.\n    29→     *\n    30→     * @param ?int $empresa_plan_id ID del plan de empresa.\n    31→     * @param string $endpoint\n    32→     * @param ?int $empresa_id ID de la empresa.\n    33→     * @return array\n    34→     * @author Sergio Vargas\n    35→     * @author Daniel Beltrán\n    36→     */\n    37→    public function validarCreditosDisponibles(?int $empresa_plan_id, string $endpoint, ?int $empresa_id = null): array {\n    38→        $servicio             = $this->obtenerServicioPorEndpoint($endpoint);\n    39→        $creditos_necesarios  = $servicio?->consume_creditos ?? 0;\n    40→        $empresa_plan_id      = $this->resolverEmpresaPlanId($empresa_plan_id, $empresa_id);\n    41→        $creditos_disponibles = 0;\n    42→\n    43→        if ($empresa_plan_id) {\n    44→            $empresa_plan         = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n    45→            $creditos_disponibles = $empresa_plan?->creditos_restantes ?? 0;\n    46→        }\n    47→\n    48→        $datos_creditos = [\n    49→            'tiene_creditos'       => $creditos_disponibles >= $creditos_necesarios,\n    50→            'creditos_necesarios'  => $creditos_necesarios,\n    51→            'creditos_disponibles' => $creditos_disponibles,\n    52→            'servicio_ia_id'       => $servicio->id,\n    53→            'empresa_plan_id'      => $empresa_plan_id\n    54→        ];\n    55→\n    56→        if (!$servicio) {\n    57→            $datos_creditos['tiene_creditos']      = true;\n    58→            $datos_creditos['creditos_necesarios'] = 0;\n    59→            $datos_creditos['servicio_ia_id']      = null;\n    60→        }\n    61→\n    62→        if ($creditos_necesarios <= 0) {\n    63→            $datos_creditos['tiene_creditos']      = true;\n    64→            $datos_creditos['creditos_necesarios'] = 0;\n    65→        }\n    66→\n    67→        if (!$empresa_plan_id) {\n    68→            $datos_creditos['tiene_creditos'] = false;\n    69→        }\n    70→\n    71→        return $datos_creditos;\n    72→    }\n    73→\n    74→    /**\n    75→     * Obtener créditos configurados para un servicio.\n    76→     *\n    77→     * @param string $endpoint Endpoint.\n    78→     * @return ?int\n    79→     * @author Sergio Vargas\n    80→     * @author Daniel Beltrán\n    81→     */\n    82→    public function obtenerCreditosServicio(string $endpoint): ?int {\n    83→        $servicio = $this->obtenerServicioPorEndpoint($endpoint);\n    84→        return $servicio?->consume_creditos;\n    85→    }\n    86→\n    87→    /**\n    88→     * Preparar datos de consumo para el tracking.\n    89→     *\n    90→     * @param ?int $empresa_plan_id ID del plan de empresa.\n    91→     * @param string $endpoint Endpoint.\n    92→     * @param ?int $empresa_id ID de la empresa.\n    93→     * @return array\n    94→     * @author Sergio Vargas\n    95→     * @author Daniel Beltrán\n    96→     */\n    97→    public function prepararConsumo(?int $empresa_plan_id, string $endpoint, ?int $empresa_id = null): array {\n    98→        $servicio = $this->obtenerServicioPorEndpoint($endpoint);\n    99→\n   100→        return [\n   101→            'empresa_plan_id' => $this->resolverEmpresaPlanId($empresa_plan_id, $empresa_id),\n   102→            'servicio_ia_id'  => $servicio?->id,\n   103→            'creditos'        => $servicio?->consume_creditos ?? 0,\n   104→        ];\n   105→    }\n   106→\n   107→    /**\n   108→     * Resolver servicio IA por endpoint normalizado.\n   109→     *\n   110→     * @param string $endpoint Endpoint.\n   111→     * @return ?ServicioIA\n   112→     * @author Sergio Vargas\n   113→     * @author Daniel Beltrán\n   114→     */\n   115→    private function obtenerServicioPorEndpoint(string $endpoint): ?ServicioIA {\n   116→        $servicio = $this->servicio_ia_repositorio->getUnoAvanzado(new Request([\n   117→            'endpoint' => $this->normalizarEndpoint($endpoint)\n   118→        ]));\n   119→\n   120→        if ($servicio && !$servicio->activo) {\n   121→            return null;\n   122→        }\n   123→\n   124→        return $servicio;\n   125→    }\n   126→\n   127→    /**\n   128→     * Normalizar endpoint para búsqueda.\n   129→     *\n   130→     * @param string $endpoint Endpoint.\n   131→     * @return string\n   132→     * @author Sergio Vargas\n   133→     * @author Daniel Beltrán\n   134→     */\n   135→    private function normalizarEndpoint(string $endpoint): string {\n   136→        return preg_replace('/\\.(whisper|gpt)$/', '', trim($endpoint, '/'));\n   137→    }\n   138→\n   139→    /**\n   140→     * Resolver empresa_plan_id desde contexto.\n   141→     *\n   142→     * @param ?int $empresa_plan_id ID del plan de empresa.\n   143→     * @param ?int $empresa_id ID de la empresa.\n   144→     * @return ?int\n   145→     * @author Sergio Vargas\n   146→     * @author Daniel Beltrán\n   147→     */\n   148→    private function resolverEmpresaPlanId(?int $empresa_plan_id, ?int $empresa_id = null): ?int {\n   149→        if ($empresa_plan_id) {\n   150→            return $empresa_plan_id;\n   151→        }\n   152→\n   153→        if (!$empresa_id) {\n   154→            return null;\n   155→        }\n   156→\n   157→        $plan = $this->empresa_plan_repositorio->planActivo($empresa_id, TipoPrueba::SELECCION_ID);\n   158→\n   159→        return $plan?->id;\n   160→    }\n   161→}\n   162→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e99d54f7-df90-4522-bab4-20ac0274bb08","timestamp":"2026-01-22T21:39:16.136Z","sourceToolAssistantUUID":"840deb9d-aebb-4018-a7cb-6e030b825cbf"}
{"parentUuid":"e99d54f7-df90-4522-bab4-20ac0274bb08","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DNJmmhFsS1VsLZdJAn4g1a","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! Now let me check how planActivo works specifically and what credentials are there in EmpresaPlan:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":2368,"cache_read_input_tokens":67848,"cache_creation":{"ephemeral_5m_input_tokens":2368,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP97prsRZkuQSuWhVTRa","type":"assistant","uuid":"8833ff1e-4d92-4dd8-a8cd-2a6f071fc96e","timestamp":"2026-01-22T21:39:18.462Z"}
{"parentUuid":"8833ff1e-4d92-4dd8-a8cd-2a6f071fc96e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DNJmmhFsS1VsLZdJAn4g1a","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N7RgLCncg8dkQaHh4b6qWd","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php","offset":100,"limit":150}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":2368,"cache_read_input_tokens":67848,"cache_creation":{"ephemeral_5m_input_tokens":2368,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP97prsRZkuQSuWhVTRa","type":"assistant","uuid":"79eb8859-8327-4c1e-be28-8b1d83f32893","timestamp":"2026-01-22T21:39:18.970Z"}
{"parentUuid":"79eb8859-8327-4c1e-be28-8b1d83f32893","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DNJmmhFsS1VsLZdJAn4g1a","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01D92P4prgRFAvGBfJkiCFUW","name":"Grep","input":{"pattern":"consumosCreditos|creditos_restantes","type":"php","output_mode":"content","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models","head_limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":2368,"cache_read_input_tokens":67848,"cache_creation":{"ephemeral_5m_input_tokens":2368,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP97prsRZkuQSuWhVTRa","type":"assistant","uuid":"fcf47972-fd02-4c5b-8de9-f9fa4a5c1d77","timestamp":"2026-01-22T21:39:19.552Z"}
{"parentUuid":"79eb8859-8327-4c1e-be28-8b1d83f32893","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N7RgLCncg8dkQaHh4b6qWd","type":"tool_result","content":"   100→     * Relación de muchos a uno con planes.\n   101→     *\n   102→     * @return BelongsTo\n   103→     * @author Daniel Beltrán\n   104→     */\n   105→    public function plan(): BelongsTo {\n   106→        return $this->belongsTo(Plan::class);\n   107→    }\n   108→\n   109→    /**\n   110→     * Relación de muchos a uno con planes_creditos.\n   111→     *\n   112→     * @return BelongsTo\n   113→     * @author Sergio Vargas\n   114→     * @author Daniel Beltrán\n   115→     * @author Jair Carvajal\n   116→     */\n   117→    public function planCredito(): BelongsTo {\n   118→        return $this->belongsTo(PlanCredito::class, 'plan_credito_id')->withDefault([]);\n   119→    }\n   120→\n   121→    /**\n   122→     * Relación de uno a varios con users.\n   123→     *\n   124→     * @return BelongsTo\n   125→     * @author José Manuel Jiménez\n   126→     */\n   127→    public function usuario(): BelongsTo {\n   128→        return $this->belongsTo(User::class);\n   129→    }\n   130→\n   131→    /**\n   132→     * Relación de muchos a uno con estados_planes.\n   133→     *\n   134→     * @return BelongsTo\n   135→     * @author Daniel Beltrán\n   136→     */\n   137→    public function estado(): BelongsTo {\n   138→        return $this->belongsTo(EstadoPlan::class);\n   139→    }\n   140→\n   141→    /**\n   142→     * Relación de uno a muchos con consumos.\n   143→     *\n   144→     * @return HasMany\n   145→     * @author Daniel Beltrán\n   146→     */\n   147→    public function consumos(): HasMany {\n   148→        return $this->hasMany(Consumo::class, 'empresa_plan_id');\n   149→    }\n   150→\n   151→    /**\n   152→     * Relación de uno a muchos con consumos de créditos.\n   153→     *\n   154→     * @return HasMany\n   155→     * @author Sergio Vargas\n   156→     * @author Daniel Beltrán\n   157→     */\n   158→    public function consumosCreditos(): HasMany {\n   159→        return $this->hasMany(ConsumoCredito::class, 'empresa_plan_id');\n   160→    }\n   161→\n   162→    /**\n   163→     * Relación de muchos a muchos con pruebas.\n   164→     *\n   165→     * @return BelongsToMany\n   166→     * @author Daniel Beltrán\n   167→     */\n   168→    public function pruebas(): BelongsToMany {\n   169→        return $this->belongsToMany(Prueba::class, 'empresas_planes_pruebas', 'empresa_plan_id', 'prueba_id')->withTimestamps();\n   170→    }\n   171→\n   172→    /**\n   173→     * Relación polimórfica de uno a muchos con archivos.\n   174→     *\n   175→     * @return MorphMany\n   176→     * @author Daniel Beltrán\n   177→     */\n   178→    public function archivos(): MorphMany {\n   179→        return $this->morphMany(Archivo::class, 'modelo', 'modelo', 'modelo_id');\n   180→    }\n   181→\n   182→    /**\n   183→     * Relación de muchos a muchos con funcionalidades.\n   184→     *\n   185→     * @return BelongsToMany\n   186→     * @author Daniel Beltrán\n   187→     */\n   188→    public function funcionalidades(): BelongsToMany {\n   189→        return $this->belongsToMany(Funcionalidad::class, 'empresas_planes_funcionalidades', 'empresa_plan_id', 'funcionalidad_id')->withTimestamps();\n   190→    }\n   191→\n   192→    /**\n   193→     * Determinar si es un plan solo de creditos (sin plan base).\n   194→     *\n   195→     * @return bool\n   196→     * @author Sergio Vargas\n   197→     */\n   198→    public function esSoloPlanCreditos(): bool {\n   199→        return !is_null($this->plan_credito_id) && is_null($this->plan_id);\n   200→    }\n   201→\n   202→    /**\n   203→     * Determinar si es un plan hibrido (plan base + creditos).\n   204→     *\n   205→     * @return bool\n   206→     * @author Sergio Vargas\n   207→     */\n   208→    public function esPlanHibrido(): bool {\n   209→        return !is_null($this->plan_id) && !is_null($this->plan_credito_id);\n   210→    }\n   211→\n   212→    /**\n   213→     * Determinar si tiene creditos asignados.\n   214→     *\n   215→     * @return bool\n   216→     * @author Sergio Vargas\n   217→     */\n   218→    public function tieneCreditos(): bool {\n   219→        return !is_null($this->plan_credito_id) || $this->creditos > 0;\n   220→    }\n   221→\n   222→    /**\n   223→     * Verificar si los creditos estan agotados.\n   224→     *\n   225→     * @return bool\n   226→     * @author Sergio Vargas\n   227→     */\n   228→    public function creditosAgotados(): bool {\n   229→        if (!$this->tieneCreditos()) {\n   230→            return false;\n   231→        }\n   232→\n   233→        return $this->creditos_restantes <= 0;\n   234→    }\n   235→}\n   236→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7359b48b-2044-43f7-9803-16301a2ac799","timestamp":"2026-01-22T21:39:21.572Z","sourceToolAssistantUUID":"79eb8859-8327-4c1e-be28-8b1d83f32893"}
{"parentUuid":"fcf47972-fd02-4c5b-8de9-f9fa4a5c1d77","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01D92P4prgRFAvGBfJkiCFUW","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php:74:    public function consumosCreditos(): HasMany {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php:59:        'creditos_restantes'\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php:79:     * Obtener el atributo creditos_restantes.\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php:86:        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php:158:    public function consumosCreditos(): HasMany {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php:233:        return $this->creditos_restantes <= 0;\n\n[Showing results with pagination = limit: 20, offset: 0]"}]},"uuid":"80883b4b-0f42-421d-8894-fc178651b650","timestamp":"2026-01-22T21:39:22.141Z","sourceToolAssistantUUID":"fcf47972-fd02-4c5b-8de9-f9fa4a5c1d77"}
{"parentUuid":"80883b4b-0f42-421d-8894-fc178651b650","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Em678eCuMhEP9U5agaBqBe","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! Now let me look for how multiple plans are handled and verify if there's any splitting logic:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2629,"cache_read_input_tokens":70216,"cache_creation":{"ephemeral_5m_input_tokens":2629,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP98GWE8x9npgwdKHr6b","type":"assistant","uuid":"c8008b23-70cd-4860-abbf-df227fef620f","timestamp":"2026-01-22T21:39:26.549Z"}
{"parentUuid":"c8008b23-70cd-4860-abbf-df227fef620f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Em678eCuMhEP9U5agaBqBe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JXYcJHuxhB3MpwuheP2oSv","name":"Grep","input":{"pattern":"planCreditosActivo|planProximoCreditos","type":"php","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2629,"cache_read_input_tokens":70216,"cache_creation":{"ephemeral_5m_input_tokens":2629,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP98GWE8x9npgwdKHr6b","type":"assistant","uuid":"75c792ef-a0d3-4966-81a4-dd6d23758ba1","timestamp":"2026-01-22T21:39:26.609Z"}
{"parentUuid":"75c792ef-a0d3-4966-81a4-dd6d23758ba1","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JXYcJHuxhB3MpwuheP2oSv","type":"tool_result","content":"Found 3 files\napp\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php\napp\\Http\\Services\\Empresas\\EmpresaPlanService.php\napp\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php"}]},"uuid":"ea1a3083-94a3-4efd-8a1f-0343e84e0738","timestamp":"2026-01-22T21:39:28.468Z","sourceToolAssistantUUID":"75c792ef-a0d3-4966-81a4-dd6d23758ba1"}
{"parentUuid":"ea1a3083-94a3-4efd-8a1f-0343e84e0738","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0166hbmKewcGk5SPJDyD1aZM","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the ActivarEInactivarPlanesCommand to see if there's any logic about plan state transitions:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":243,"cache_read_input_tokens":72845,"cache_creation":{"ephemeral_5m_input_tokens":243,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXP98j4QGmnXjfHabe3r9","type":"assistant","uuid":"736a4c98-180b-41e7-829e-9c3da316bfd5","timestamp":"2026-01-22T21:39:31.470Z"}
{"parentUuid":"736a4c98-180b-41e7-829e-9c3da316bfd5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0166hbmKewcGk5SPJDyD1aZM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CJ8MqenpU8AoYyMz6Z2B88","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":243,"cache_read_input_tokens":72845,"cache_creation":{"ephemeral_5m_input_tokens":243,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXP98j4QGmnXjfHabe3r9","type":"assistant","uuid":"621b5497-34a2-4107-b272-ee2b0196e439","timestamp":"2026-01-22T21:39:32.354Z"}
{"parentUuid":"621b5497-34a2-4107-b272-ee2b0196e439","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CJ8MqenpU8AoYyMz6Z2B88","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Console\\Commands\\Empresas;\n     4→\n     5→use Exception;\n     6→use Carbon\\Carbon;\n     7→use App\\Models\\Planes\\Plan;\n     8→use Illuminate\\Http\\Request;\n     9→use Illuminate\\Console\\Command;\n    10→use Illuminate\\Support\\Facades\\DB;\n    11→use App\\Models\\Empresas\\EmpresaPlan;\n    12→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    13→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    14→\n    15→/**\n    16→ * Comando para gestionar la activación e inactivación de los planes de las empresas.\n    17→ * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n    18→ * completa de los estados de los planes con sus descripciones.\n    19→ *\n    20→ * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n    21→ * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n    22→ * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n    23→ * días fueron recomendados desde comercial.\n    24→ * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n    25→ * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n    26→ * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n    27→ * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n    28→ * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n    29→ * una vez se sube el archivo, el plan pasa a estar activo.\n    30→ * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n    31→ *\n    32→ * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n    33→ *\n    34→ * @package App\\Console\\Commands\\Empresas\n    35→ * @version 0.0.3\n    36→ * @author Daniel Beltrán\n    37→ * @author Fahibram Cárcamo\n    38→ */\n    39→class ActivarEInactivarPlanesCommand extends Command\n    40→{\n    41→    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n    42→\n    43→    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n    44→\n    45→    /**\n    46→     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n    47→     * @var int\n    48→     * @author Fahibram Cárcamo\n    49→     */\n    50→    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n    51→\n    52→    /**\n    53→     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n    54→     * @var int\n    55→     * @author Fahibram Cárcamo\n    56→     */\n    57→    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n    58→\n    59→    /**\n    60→     * Constructor.\n    61→     *\n    62→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n    63→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    64→     * @return void\n    65→     * @author Daniel Beltrán\n    66→     */\n    67→    public function __construct(\n    68→        private EmpresaPlanRepository $empresa_plan_repositorio,\n    69→        private EmpresaPlanService $empresa_plan_servicio\n    70→    ) {\n    71→        parent::__construct();\n    72→    }\n    73→\n    74→    /**\n    75→     * Activar e inactivar los planes de las empresas.\n    76→     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n    77→     * @return void\n    78→     * @author Daniel Beltrán\n    79→     * @author Fahibram Cárcamo\n    80→     */\n    81→    public function handle() {\n    82→        $empresa_id   = $this->argument('empresa_id');\n    83→        $fecha_actual = now()->startOfDay();\n    84→        $request      = new Request([\n    85→            'estados_ids'     => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n    86→            'ordenar_por'     => 'created_at',\n    87→            'ordenar_sentido' => 'ASC'\n    88→        ]);\n    89→\n    90→        if (!is_null($empresa_id)) {\n    91→            $request->merge(['empresa_id' => $empresa_id]);\n    92→        }\n    93→\n    94→        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n    95→        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n    96→\n    97→        try {\n    98→            DB::beginTransaction();\n    99→\n   100→            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n   101→                foreach ($planes as $plan) {\n   102→                    $empresa_id = $plan->empresa_id;\n   103→\n   104→                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n   105→                        if ($this->planVencido($plan)) {\n   106→                            // Desactivar el plan si ya ha vencido\n   107→                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n   108→\n   109→                            if ($plan->tieneCreditos()) {\n   110→                                $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n   111→                            }\n   112→                        } else {\n   113→                            $this->establecerPlanProximoAVencer($plan);\n   114→\n   115→                            if (!$plan->esSoloPlanCreditos()) {\n   116→                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n   117→                            }\n   118→                        }\n   119→\n   120→                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n   121→                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n   122→                        if ($plan->esSoloPlanCreditos()) {\n   123→                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n   124→\n   125→                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n   126→                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   127→                            }\n   128→                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n   129→                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n   130→                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   131→\n   132→                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n   133→                                continue;\n   134→                            }\n   135→\n   136→                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   137→                        }\n   138→                    }\n   139→                }\n   140→            }\n   141→\n   142→            DB::commit();\n   143→\n   144→            $this->info('Planes de empresas actualizados correctamente');\n   145→        } catch (Exception $error) {\n   146→            DB::rollBack();\n   147→\n   148→            $this->error('Error al actualizar los planes de empresas');\n   149→        }\n   150→    }\n   151→\n   152→    /**\n   153→     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n   154→     *\n   155→     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n   156→     * @return bool\n   157→     * @author Fahibram Cárcamo\n   158→     * @author Sergio Vargas\n   159→     */\n   160→    private function planVencido(EmpresaPlan $empresa_plan): bool {\n   161→        if ($empresa_plan->esSoloPlanCreditos()) {\n   162→            return $empresa_plan->creditosAgotados();\n   163→        }\n   164→\n   165→        if (is_null($empresa_plan->fecha_vencimiento)) {\n   166→            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n   167→            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas)\n   168→                && (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n   169→        } else {\n   170→            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n   171→            // tienen una fecha de inicio posterior a la actual).\n   172→            $fecha_actual = now()->startOfDay();\n   173→            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n   174→        }\n   175→    }\n   176→\n   177→    /**\n   178→     * Establecer las fechas de vigencia del próximo plan del cliente.\n   179→     *\n   180→     * @param int $empresa_id Id de la empresa.\n   181→     * @param int $tipo_prueba_id Id del tipo de prueba.\n   182→     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n   183→     * @return void\n   184→     * @author Daniel Beltrán\n   185→     * @author Fahibram Cárcamo\n   186→     */\n   187→    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n   188→        // Se busca el próximo plan\n   189→        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   190→\n   191→        // Se verifica si existe un próximo plan y si es ilimitado\n   192→        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n   193→            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n   194→                $plan_proximo->vigencia_dias,\n   195→                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n   196→            );\n   197→\n   198→            // Se establecen las fechas de vigencia del la suscripción al plan\n   199→            $this->empresa_plan_repositorio->actualizar(\n   200→                $plan_proximo->id,\n   201→                [\n   202→                    'fecha_inicio'      => $fechas['fecha_inicio'],\n   203→                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n   204→                ]\n   205→            );\n   206→        }\n   207→    }\n   208→\n   209→    /**\n   210→     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n   211→     *\n   212→     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n   213→     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n   214→     * @return void\n   215→     * @author Fahibram Cárcamo\n   216→     * @author Sergio Vargas\n   217→     */\n   218→    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n   219→        if ($empresa_plan->esSoloPlanCreditos()) {\n   220→            $total_creditos = $empresa_plan->creditos;\n   221→\n   222→            if ($total_creditos > 0) {\n   223→                $creditos_consumidos = $total_creditos - $empresa_plan->creditos_restantes;\n   224→\n   225→                $porcentaje_consumido = ($creditos_consumidos / $total_creditos) * 100;\n   226→\n   227→                if (\n   228→                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n   229→                    && $empresa_plan->creditos_restantes > 0\n   230→                ) {\n   231→                    $this->empresa_plan_repositorio->actualizar(\n   232→                        $empresa_plan->id,\n   233→                        ['estado_id' => Plan::ESTADO_POR_VENCER_ID]\n   234→                    );\n   235→                }\n   236→            }\n   237→\n   238→            return;\n   239→        }\n   240→\n   241→        if (is_null($empresa_plan->fecha_vencimiento)) {\n   242→            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n   243→\n   244→            $total_consumido = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n   245→\n   246→            if (\n   247→                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n   248→                && $total_consumido < $total_consumos_disponibles\n   249→            ) {\n   250→                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n   251→            }\n   252→        } else {\n   253→            $fecha_actual = now()->startOfDay();\n   254→\n   255→            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n   256→\n   257→            if (\n   258→                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n   259→                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n   260→            ) {\n   261→                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n   262→            }\n   263→        }\n   264→    }\n   265→\n   266→    /**\n   267→     * Activar el proximo plan de creditos de la empresa.\n   268→     * @param int $empresa_id ID de la empresa.\n   269→     * @param int|null $tipo_prueba_id ID del tipo de prueba.\n   270→     * @return void\n   271→     * @author Sergio Vargas\n   272→     */\n   273→    private function activarPlanCreditoProximo(int $empresa_id, ?int $tipo_prueba_id): void {\n   274→        $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos($empresa_id, $tipo_prueba_id);\n   275→\n   276→        if (!is_null($plan_proximo)) {\n   277→            $this->empresa_plan_repositorio->actualizar(\n   278→                $plan_proximo->id,\n   279→                ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n   280→            );\n   281→        }\n   282→    }\n   283→}\n   284→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7c596a9f-234b-4e52-b229-628557731081","timestamp":"2026-01-22T21:39:33.493Z","sourceToolAssistantUUID":"621b5497-34a2-4107-b272-ee2b0196e439"}
{"parentUuid":"7c596a9f-234b-4e52-b229-628557731081","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RhaicQoTrrvgXqeiQnFzfE","type":"message","role":"assistant","content":[{"type":"text","text":"Excellent! Now let me verify the models to get the complete picture:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":5244,"cache_read_input_tokens":73088,"cache_creation":{"ephemeral_5m_input_tokens":5244,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXP997eCVUEAJ4jjwiJRe","type":"assistant","uuid":"fd3bafad-dc07-44be-8924-e164d612215b","timestamp":"2026-01-22T21:39:35.535Z"}
{"parentUuid":"fd3bafad-dc07-44be-8924-e164d612215b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RhaicQoTrrvgXqeiQnFzfE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BAysxbFhGLDE858ej8UH6R","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php","limit":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":5244,"cache_read_input_tokens":73088,"cache_creation":{"ephemeral_5m_input_tokens":5244,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXP997eCVUEAJ4jjwiJRe","type":"assistant","uuid":"41de3994-58d3-4af2-9401-465f4c1f3f1c","timestamp":"2026-01-22T21:39:36.785Z"}
{"parentUuid":"41de3994-58d3-4af2-9401-465f4c1f3f1c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RhaicQoTrrvgXqeiQnFzfE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Q7irK5ahHbZ3XkJamEJWAz","name":"Glob","input":{"pattern":"app/Models/Planes/EstadoPlan.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":5244,"cache_read_input_tokens":73088,"cache_creation":{"ephemeral_5m_input_tokens":5244,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXP997eCVUEAJ4jjwiJRe","type":"assistant","uuid":"c0c37897-f7fd-41b5-b9eb-9963a4a04170","timestamp":"2026-01-22T21:39:36.833Z"}
{"parentUuid":"41de3994-58d3-4af2-9401-465f4c1f3f1c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BAysxbFhGLDE858ej8UH6R","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Planes;\n     4→\n     5→use OwenIt\\Auditing\\Auditable;\n     6→use App\\Models\\Empresas\\EmpresaPlan;\n     7→use Illuminate\\Database\\Eloquent\\Model;\n     8→use Illuminate\\Database\\Eloquent\\Builder;\n     9→use Illuminate\\Database\\Eloquent\\SoftDeletes;\n    10→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n    11→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    12→\n    13→class PlanCredito extends Model implements AuditableContract\n    14→{\n    15→    use Auditable, SoftDeletes;\n    16→\n    17→    protected $table = 'planes_creditos';\n    18→\n    19→    protected $fillable = [\n    20→        'nombre',\n    21→        'descripcion',\n    22→        'creditos',\n    23→        'precio',\n    24→        'porcentaje_descuento',\n    25→        'fecha_inicio_promocion',\n    26→        'fecha_fin_promocion',\n    27→        'activo'\n    28→    ];\n    29→\n    30→    protected $casts = [\n    31→        'creditos'               => 'integer',\n    32→        'precio'                 => 'decimal:2',\n    33→        'porcentaje_descuento'   => 'integer',\n    34→        'fecha_inicio_promocion' => 'date:Y-m-d',\n    35→        'fecha_fin_promocion'    => 'date:Y-m-d',\n    36→        'activo'                 => 'boolean'\n    37→    ];\n    38→\n    39→    protected $appends = [\n    40→        'precio_con_descuento'\n    41→    ];\n    42→\n    43→    /**\n    44→     * Filtrar registros activos.\n    45→     *\n    46→     * @param Builder $consulta Consulta.\n    47→     * @return Builder\n    48→     * @author Sergio Vargas\n    49→     * @author Daniel Beltrán\n    50→     */\n    51→    public function scopeActivos(Builder $consulta): Builder {\n    52→        return $consulta->where('activo', true);\n    53→    }\n    54→\n    55→    /**\n    56→     * Relación de uno a muchos con empresas_planes.\n    57→     *\n    58→     * @return HasMany\n    59→     * @author Sergio Vargas\n    60→     * @author Daniel Beltrán\n    61→     */\n    62→    public function empresasPlanes(): HasMany {\n    63→        return $this->hasMany(EmpresaPlan::class, 'plan_credito_id');\n    64→    }\n    65→\n    66→    /**\n    67→     * Obtener el precio con descuento aplicado.\n    68→     *\n    69→     * @return float\n    70→     * @author Sergio Vargas\n    71→     * @author Daniel Beltrán\n    72→     */\n    73→    public function getPrecioConDescuentoAttribute(): float {\n    74→        if (!$this->estaEnPromocion()) {\n    75→            return (float) $this->precio;\n    76→        }\n    77→\n    78→        $porcentaje = $this->porcentaje_descuento ?? 0;\n    79→        $descuento  = $this->precio * ($porcentaje / 100);\n    80→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"4c73dd1a-452a-437d-b9f9-aae27f32abff","timestamp":"2026-01-22T21:39:38.919Z","sourceToolAssistantUUID":"41de3994-58d3-4af2-9401-465f4c1f3f1c"}
{"parentUuid":"c0c37897-f7fd-41b5-b9eb-9963a4a04170","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Q7irK5ahHbZ3XkJamEJWAz","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\EstadoPlan.php"}]},"uuid":"5fb3dcd9-df4c-498b-b787-d9d6ffa66220","timestamp":"2026-01-22T21:39:40.236Z","sourceToolAssistantUUID":"c0c37897-f7fd-41b5-b9eb-9963a4a04170"}
{"parentUuid":"5fb3dcd9-df4c-498b-b787-d9d6ffa66220","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"606e57fc-89da-499c-8a24-f59b796ed4e4","version":"2.1.16","gitBranch":"pre-main","agentId":"a54fac1","slug":"sunny-shimmying-locket","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01T9mPbxvnUsLPaFUNRsuBfn","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I have gathered comprehensive information about the credit consumption system. Let me now create a detailed report for the user.\n\n## Credit Consumption Flow Analysis\n\nBased on my thorough investigation of the PsicoAlianza codebase, here's a complete understanding of how credit consumption works:\n\n---\n\n## 1. Key Files & Architecture\n\n### **Service Layer**\n- **ConsumoCreditoService** (`app/Http/Services/IA/ConsumoCreditoService.php`) - Handles credit consumption logging and plan state updates\n- **CreditoIAService** (`app/Http/Services/IA/CreditoIAService.php`) - **CRITICAL: Determines which EmpresaPlan is selected**\n- **EmpresaPlanService** (`app/Http/Services/Empresas/EmpresaPlanService.php`) - Manages plan assignments and credit availability checks\n- **ConsumoService** (`app/Http/Services/Planes/ConsumoService.php`) - Handles unit/agenda/vacancy consumptions (separate from credit consumption)\n\n### **Repository Layer**\n- **ConsumoCreditoRepository** - Stores and retrieves credit consumption records\n- **EmpresaPlanRepository** - Queries active/next credit plans for companies\n\n### **Models**\n- **ConsumoCredito** - Records individual API call token consumption\n- **EmpresaPlan** - Represents company's plan subscription with `creditos_restantes` calculated attribute\n- **PlanCredito** - Credit plan definitions\n\n---\n\n## 2. How EmpresaPlan is Selected (THE CRITICAL DECISION POINT)\n\n### **Flow:** IATrait → CreditoIAService → EmpresaPlanRepository\n\nWhen an IA API call is made, here's the exact selection logic:\n\n#### **In `IATrait.php` (lines 262-301):**\n```\nvalidarCreditosParaLlamada() \n  → calls CreditoIAService->validarCreditosDisponibles()\n```\n\n#### **In `CreditoIAService.php` (lines 148-160):**\n```php\nprivate function resolverEmpresaPlanId(?int $empresa_plan_id, ?int $empresa_id = null): ?int {\n    // Step 1: If explicit empresa_plan_id is provided, USE IT\n    if ($empresa_plan_id) {\n        return $empresa_plan_id;\n    }\n\n    // Step 2: If no explicit ID, look up the ACTIVE plan for the company\n    if (!$empresa_id) {\n        return null;\n    }\n\n    // THIS IS THE KEY SELECTION LOGIC:\n    $plan = $this->empresa_plan_repositorio->planActivo(\n        $empresa_id, \n        TipoPrueba::SELECCION_ID  // Hardcoded to \"SELECCION\" type!\n    );\n\n    return $plan?->id;\n}\n```\n\n### **The `planActivo()` Query** (EmpresaPlanRepository.php, lines 431-456):\n```sql\nSELECT * FROM empresas_planes\nWHERE \n  - empresa_id = ?\n  - estado_id IN [1, 4]  -- ACTIVO (1) or POR_VENCER (4)\n  - JOINS to plans WHERE tipo_prueba_id = SELECCION_ID\nORDER BY first match\nLIMIT 1\n```\n\n**Key states:**\n- `estado_id = 1` → ACTIVO (Active)\n- `estado_id = 4` → POR_VENCER (About to expire - when <20 days left or 90% consumed)\n- `estado_id = 3` → PROXIMO (Next/Pending)\n- `estado_id = 2` → VENCIDO (Expired)\n\n---\n\n## 3. Credit Consumption Logic (NO SPLITTING ACROSS PLANS)\n\n### **In `ConsumoCreditoService.php` (lines 59-121):**\n\nWhen credits are consumed:\n\n1. **Registers consumption:** `registrarConsumoDesdeRespuesta()` receives API response with token usage\n2. **Records single entry:** Creates ONE `ConsumoCredito` record with:\n   - `empresa_plan_id` - The SINGLE plan that was charged\n   - `creditos` - Amount deducted from that ONE plan\n   - `tokens_entrada`, `tokens_salida`, `tokens_totales` - Token counts from API\n\n3. **Updates plan state:** `actualizarEstadoPlanSegunCreditos()` (lines 129-152):\n   ```php\n   if ($creditos_disponibles <= 0) {\n       // Mark plan as VENCIDO (expired)\n       $estado_id = Plan::ESTADO_VENCIDO_ID;\n   } elseif ($porcentaje_restante < 20) {\n       // Mark plan as POR_VENCER (about to expire)\n       $estado_id = Plan::ESTADO_POR_VENCER_ID;\n   }\n   ```\n\n**IMPORTANT:** There is NO logic for splitting consumption across multiple plans. Credits are deducted from ONE active plan only.\n\n---\n\n## 4. Plan Transitions & Fallback Logic\n\n### **In `ActivarEInactivarPlanesCommand.php` (lines 110-127):**\n\nWhen a plan with credits becomes VENCIDO (expired):\n\n```php\nif ($plan->tieneCreditos()) {\n    // Activate the NEXT credit plan in queue\n    $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n}\n\nprivate function activarPlanCreditoProximo(int $empresa_id, ?int $tipo_prueba_id): void {\n    $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos(\n        $empresa_id, \n        $tipo_prueba_id\n    );\n    \n    if (!is_null($plan_proximo)) {\n        // Transition from PROXIMO (3) → ACTIVO (1)\n        $this->empresa_plan_repositorio->actualizar(\n            $plan_proximo->id,\n            ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n        );\n    }\n}\n```\n\n**The `planProximoCreditos()` query** (lines 351-367):\n```sql\nSELECT * FROM empresas_planes\nWHERE \n  - empresa_id = ?\n  - estado_id = 3  -- Only PROXIMO (Next)\n  - plan_credito_id IS NOT NULL  -- Only credit plans\nORDER BY created_at ASC  -- First one created becomes active\nLIMIT 1\n```\n\n---\n\n## 5. Credit Availability Calculation\n\n### **In `EmpresaPlan` model (lines 79-87):**\n```php\npublic function getCreditosRestantesAttribute(): int {\n    return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n}\n```\n\n- **Total Credits:** Stored in `empresas_planes.creditos`\n- **Consumed Credits:** SUM of all `consumos_creditos.creditos` where `empresa_plan_id = this.id`\n- **Remaining:** `creditos - SUM(consumed)` (never negative)\n\n---\n\n## 6. Where Credits Are Actually Consumed (Step-by-Step)\n\n1. **IATrait.php:** Calls `realizarPeticionIA()` (lines 27-107)\n   - Gets IA response with token usage metadata\n   - Calls `validarCreditosParaLlamada()` → Checks if credits exist\n   - Calls `consumirCreditosDespuesLlamada()` → Prepares consumption data\n   - Calls `registrarConsumoTokens()` → Logs the consumption\n\n2. **CreditoIAService.php:** `validarCreditosDisponibles()` & `prepararConsumo()` (lines 37-105)\n   - Resolves which `empresa_plan_id` to charge\n   - Returns credits needed from `ServicioIA.consume_creditos` field\n   - Sets `contexto['empresa_plan_id']` for downstream use\n\n3. **ConsumoCreditoService.php:** `registrarConsumoDesdeRespuesta()` (lines 59-121)\n   - Actually creates the `ConsumoCredito` record\n   - Stores `empresa_plan_id`, `creditos`, token counts, and metadata\n   - Triggers plan state updates\n\n---\n\n## 7. Multi-Plan Behavior\n\nThere is **NO splitting of consumption across plans**. However:\n\n- **Active Plans:** Only ONE plan can be in ACTIVO state at a time per tipo_prueba_id\n- **Queued Plans:** Multiple plans can be in PROXIMO state and are activated sequentially\n- **Transitions:** When current plan's credits are exhausted, the system automatically activates the next PROXIMO plan\n\n**Example Scenario:**\n1. Plan A (ACTIVO, 100 credits) is being used\n2. Plan B (PROXIMO, 200 credits) waits in queue\n3. When Plan A reaches 0 credits → transitioned to VENCIDO\n4. Plan B automatically → ACTIVO\n5. Subsequent IA calls use Plan B's 200 credits\n\n---\n\n## 8. Service Relationship Diagram\n\n```\nIATrait (Controller/Trait)\n    ↓\nCreditoIAService\n    ├─ Resolves EmpresaPlan ID (planActivo query)\n    ├─ Validates credits available\n    └─ Prepares consumption metadata\n    ↓\nConsumoCreditoService\n    ├─ Logs consumption to DB (ConsumoCredito)\n    ├─ Updates plan state based on remaining credits\n    └─ Triggers ActivarEInactivarPlanesCommand (background)\n    ↓\nActivarEInactivarPlanesCommand (scheduled)\n    └─ Transitions VENCIDO → Activates planProximoCreditos\n```\n\n---\n\n## 9. Key Method Reference\n\n| Method | File | Purpose |\n|--------|------|---------|\n| `resolverEmpresaPlanId()` | CreditoIAService | **SELECTS WHICH PLAN** |\n| `planActivo()` | EmpresaPlanRepository | Finds active plan (estado IN [1,4]) |\n| `planProximoCreditos()` | EmpresaPlanRepository | Finds next queued credit plan |\n| `registrarConsumoDesdeRespuesta()` | ConsumoCreditoService | **DEDUCTS CREDITS** |\n| `actualizarEstadoPlanSegunCreditos()` | ConsumoCreditoService | Updates plan state after deduction |\n| `activarPlanCreditoProximo()` | ActivarEInactivarPlanesCommand | Auto-transitions expired plan |\n| `getCreditosRestantesAttribute()` | EmpresaPlan | Calculates remaining credits |\n\n---\n\n## 10. Important Observations\n\n1. **Hardcoded Type:** Plan selection always uses `TipoPrueba::SELECCION_ID` (ID 2)\n2. **No Partial Splits:** Credits are fully deducted from ONE plan only\n3. **Automatic Fallback:** Expired plans automatically activate the next queued plan\n4. **State Management:** Uses `estado_id` field with specific numeric IDs (1=ACTIVO, 2=VENCIDO, 3=PROXIMO, 4=POR_VENCER)\n5. **Audit Trail:** All consumption is logged in `consumos_creditos` table with full context (usuario_id, empresa_id, vacante_id, agenda_id, etc.)\n\n---\n\nThis is the complete credit consumption architecture. The system is **single-plan-per-call** with automatic queued plan activation."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1557,"cache_read_input_tokens":78332,"cache_creation":{"ephemeral_5m_input_tokens":1557,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP99bv4ggDMgW8PqHRgk","type":"assistant","uuid":"ea189647-9a40-4054-adab-45fcb5869de7","timestamp":"2026-01-22T21:40:05.492Z"}
