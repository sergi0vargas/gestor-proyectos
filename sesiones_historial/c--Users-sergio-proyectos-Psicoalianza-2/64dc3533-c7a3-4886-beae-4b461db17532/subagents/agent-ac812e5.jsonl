{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":"Necesito entender completamente el sistema de créditos y su integración con planes. Busca:\n\n1. Cómo se asignan créditos a un EmpresaPlan\n2. Cómo se consumen los créditos (ConsumoCredito)\n3. Servicios relacionados con créditos (CreditoService, IAService, etc.)\n4. Controladores que manejen compra de planes de créditos\n5. Cualquier validación sobre créditos restantes\n\nEnfócate en:\n- El flujo de compra de un PlanCredito\n- Cómo se relaciona plan_credito_id con empresas_planes\n- La diferencia entre un plan normal y un plan de créditos\n- Si existen planes \"vacíos\" (sin unidades ni fecha pero con créditos)\n\nBusca en app/Http/Services/, app/Http/Controllers/, app/Models/"},"uuid":"e8f88822-a044-4428-a417-82d5b5e18002","timestamp":"2026-01-21T15:01:28.343Z"}
{"parentUuid":"e8f88822-a044-4428-a417-82d5b5e18002","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TDsryskcD67RqJkv6fyJiC","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a realizar una búsqueda exhaustiva del sistema de créditos y su integración. Comenzaré con búsquedas paralelas en los directorios clave."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14949,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14949,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXLiyaGG8qQ7vkR7AeHf9","type":"assistant","uuid":"bb96b73c-91c6-493d-99e3-b48ebe0fe215","timestamp":"2026-01-21T15:01:30.159Z"}
{"parentUuid":"bb96b73c-91c6-493d-99e3-b48ebe0fe215","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TDsryskcD67RqJkv6fyJiC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011nm27r89eiBxDkBNLVpH4e","name":"Glob","input":{"pattern":"**/app/Http/Services/**/*Credito*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14949,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14949,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXLiyaGG8qQ7vkR7AeHf9","type":"assistant","uuid":"abcabbfe-b63b-48d3-8a5a-b10936fd8b6b","timestamp":"2026-01-21T15:01:30.462Z"}
{"parentUuid":"abcabbfe-b63b-48d3-8a5a-b10936fd8b6b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TDsryskcD67RqJkv6fyJiC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UAg5Dewc4zqgSMU4i5tfKu","name":"Glob","input":{"pattern":"**/app/Http/Controllers/**/*Credito*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14949,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14949,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXLiyaGG8qQ7vkR7AeHf9","type":"assistant","uuid":"3b64346e-e235-42b8-997d-f17594c8e3b5","timestamp":"2026-01-21T15:01:30.631Z"}
{"parentUuid":"3b64346e-e235-42b8-997d-f17594c8e3b5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TDsryskcD67RqJkv6fyJiC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01C26LmsaZUBGuHz6sibN61H","name":"Glob","input":{"pattern":"**/app/Models/**/*Credito*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14949,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14949,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXLiyaGG8qQ7vkR7AeHf9","type":"assistant","uuid":"57fdcbe3-5112-4052-b278-6f3957a69651","timestamp":"2026-01-21T15:01:30.801Z"}
{"parentUuid":"57fdcbe3-5112-4052-b278-6f3957a69651","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TDsryskcD67RqJkv6fyJiC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BCGHppFtgNWYcJA6UHeDsB","name":"Glob","input":{"pattern":"**/app/Http/Repositories/**/*Credito*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14949,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14949,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXLiyaGG8qQ7vkR7AeHf9","type":"assistant","uuid":"b74fa48a-0f88-4c2a-bbe9-03a119886634","timestamp":"2026-01-21T15:01:30.966Z"}
{"parentUuid":"b74fa48a-0f88-4c2a-bbe9-03a119886634","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BCGHppFtgNWYcJA6UHeDsB","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php"}]},"uuid":"034c30e7-a12b-401b-94da-00f15ebe5f0f","timestamp":"2026-01-21T15:01:50.921Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php"],"durationMs":15833,"numFiles":2,"truncated":false},"sourceToolAssistantUUID":"b74fa48a-0f88-4c2a-bbe9-03a119886634"}
{"parentUuid":"abcabbfe-b63b-48d3-8a5a-b10936fd8b6b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011nm27r89eiBxDkBNLVpH4e","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\CreditoIAService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php"}]},"uuid":"2257b6d0-fc33-4f48-baa6-83c5af10e4cc","timestamp":"2026-01-21T15:01:50.925Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\CreditoIAService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php"],"durationMs":15845,"numFiles":3,"truncated":false},"sourceToolAssistantUUID":"abcabbfe-b63b-48d3-8a5a-b10936fd8b6b"}
{"parentUuid":"3b64346e-e235-42b8-997d-f17594c8e3b5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UAg5Dewc4zqgSMU4i5tfKu","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php"}]},"uuid":"9cfc66bb-3a42-4841-bc0c-8f61915410fa","timestamp":"2026-01-21T15:01:50.924Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php"],"durationMs":15842,"numFiles":1,"truncated":false},"sourceToolAssistantUUID":"3b64346e-e235-42b8-997d-f17594c8e3b5"}
{"parentUuid":"57fdcbe3-5112-4052-b278-6f3957a69651","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01C26LmsaZUBGuHz6sibN61H","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"}]},"uuid":"6caf8032-711a-4d65-bab9-0ecb56d79050","timestamp":"2026-01-21T15:01:50.922Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"],"durationMs":15839,"numFiles":2,"truncated":false},"sourceToolAssistantUUID":"57fdcbe3-5112-4052-b278-6f3957a69651"}
{"parentUuid":"6caf8032-711a-4d65-bab9-0ecb56d79050","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XXhR91fcSvPdS9GLTvfyGZ","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente. Ahora buscaré en los modelos relacionados con planes y empresas:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":106,"cache_creation_input_tokens":827,"cache_read_input_tokens":14949,"cache_creation":{"ephemeral_5m_input_tokens":827,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj1MCWRq18dbFDfoMUq","type":"assistant","uuid":"6551edc1-a612-40ce-abb0-ec7615f155b7","timestamp":"2026-01-21T15:01:54.156Z"}
{"parentUuid":"6551edc1-a612-40ce-abb0-ec7615f155b7","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XXhR91fcSvPdS9GLTvfyGZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013pN1fX7AtW6feVTAymPkkX","name":"Glob","input":{"pattern":"**/app/Models/Planes/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":106,"cache_creation_input_tokens":827,"cache_read_input_tokens":14949,"cache_creation":{"ephemeral_5m_input_tokens":827,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj1MCWRq18dbFDfoMUq","type":"assistant","uuid":"c80b6a32-3aa3-4e1e-8f65-3240eaf8843b","timestamp":"2026-01-21T15:01:54.588Z"}
{"parentUuid":"c80b6a32-3aa3-4e1e-8f65-3240eaf8843b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XXhR91fcSvPdS9GLTvfyGZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MC9hAMQCvTijVDpY4XbsAw","name":"Glob","input":{"pattern":"**/app/Models/Empresas/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":106,"cache_creation_input_tokens":827,"cache_read_input_tokens":14949,"cache_creation":{"ephemeral_5m_input_tokens":827,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj1MCWRq18dbFDfoMUq","type":"assistant","uuid":"6b2c3313-6ac8-434a-8f3c-5b62a6af3851","timestamp":"2026-01-21T15:01:54.716Z"}
{"parentUuid":"6b2c3313-6ac8-434a-8f3c-5b62a6af3851","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XXhR91fcSvPdS9GLTvfyGZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VWDe8WqyyHwuvXxj9fEqer","name":"Glob","input":{"pattern":"**/app/Models/IA/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":106,"cache_creation_input_tokens":827,"cache_read_input_tokens":14949,"cache_creation":{"ephemeral_5m_input_tokens":827,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj1MCWRq18dbFDfoMUq","type":"assistant","uuid":"573f089b-d0e2-4b4d-a171-aedf60fc4433","timestamp":"2026-01-21T15:01:54.877Z"}
{"parentUuid":"573f089b-d0e2-4b4d-a171-aedf60fc4433","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VWDe8WqyyHwuvXxj9fEqer","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\CategoriaServicioIA.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php"}]},"uuid":"f092f6a2-8c79-4881-bf0b-bed39edbe233","timestamp":"2026-01-21T15:02:00.642Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\CategoriaServicioIA.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php"],"durationMs":2048,"numFiles":3,"truncated":false},"sourceToolAssistantUUID":"573f089b-d0e2-4b4d-a171-aedf60fc4433"}
{"parentUuid":"c80b6a32-3aa3-4e1e-8f65-3240eaf8843b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013pN1fX7AtW6feVTAymPkkX","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\EstadoPlan.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Funcionalidad.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\FuncionalidadPlan.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Modulo.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Consumo.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"}]},"uuid":"28717309-5386-4128-8192-3d458836491d","timestamp":"2026-01-21T15:02:00.675Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\EstadoPlan.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Funcionalidad.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\FuncionalidadPlan.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Modulo.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Consumo.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"],"durationMs":2085,"numFiles":7,"truncated":false},"sourceToolAssistantUUID":"c80b6a32-3aa3-4e1e-8f65-3240eaf8843b"}
{"parentUuid":"6b2c3313-6ac8-434a-8f3c-5b62a6af3851","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MC9hAMQCvTijVDpY4XbsAw","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\Area.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\Cargo.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\Empresa.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaEnlaceCreacion.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaUsuario.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EstadoPortalEmpleo.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\MigracionEmpresa.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\Motivador.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\PortalEmpleo.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\PremioDestacado.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\Sector.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\TamanoEmpresa.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPerfil.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlanFuncionalidad.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php"}]},"uuid":"285489bd-8856-4a2d-82ef-e908bee823be","timestamp":"2026-01-21T15:02:00.716Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\Area.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\Cargo.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\Empresa.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaEnlaceCreacion.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaUsuario.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EstadoPortalEmpleo.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\MigracionEmpresa.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\Motivador.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\PortalEmpleo.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\PremioDestacado.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\Sector.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\TamanoEmpresa.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPerfil.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlanFuncionalidad.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php"],"durationMs":2124,"numFiles":15,"truncated":false},"sourceToolAssistantUUID":"6b2c3313-6ac8-434a-8f3c-5b62a6af3851"}
{"parentUuid":"285489bd-8856-4a2d-82ef-e908bee823be","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01N9WofeAYaEuP8dbsqmQDBP","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a leer los archivos clave. Comenzaré con los modelos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":133,"cache_creation_input_tokens":1127,"cache_read_input_tokens":15776,"cache_creation":{"ephemeral_5m_input_tokens":1127,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj1xxpLtzyUCQPshJe6","type":"assistant","uuid":"fc09331a-9314-4589-ad83-37e945973d7b","timestamp":"2026-01-21T15:02:02.217Z"}
{"parentUuid":"fc09331a-9314-4589-ad83-37e945973d7b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01N9WofeAYaEuP8dbsqmQDBP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XwjAK69GfmfCJpfMUpsCbE","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":133,"cache_creation_input_tokens":1127,"cache_read_input_tokens":15776,"cache_creation":{"ephemeral_5m_input_tokens":1127,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj1xxpLtzyUCQPshJe6","type":"assistant","uuid":"99cdfd4d-2182-48d5-bcd6-ddbb8f628650","timestamp":"2026-01-21T15:02:06.051Z"}
{"parentUuid":"99cdfd4d-2182-48d5-bcd6-ddbb8f628650","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01N9WofeAYaEuP8dbsqmQDBP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DbAn6pwHhVDocMwdmijkKm","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":133,"cache_creation_input_tokens":1127,"cache_read_input_tokens":15776,"cache_creation":{"ephemeral_5m_input_tokens":1127,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj1xxpLtzyUCQPshJe6","type":"assistant","uuid":"021d1d3a-8c00-4021-89a8-78a7835b0605","timestamp":"2026-01-21T15:02:06.151Z"}
{"parentUuid":"021d1d3a-8c00-4021-89a8-78a7835b0605","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01N9WofeAYaEuP8dbsqmQDBP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RvJkmWKBCA37dYLVaw7gu2","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":133,"cache_creation_input_tokens":1127,"cache_read_input_tokens":15776,"cache_creation":{"ephemeral_5m_input_tokens":1127,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj1xxpLtzyUCQPshJe6","type":"assistant","uuid":"7cc5e39b-4915-4f31-ad21-417d376bf253","timestamp":"2026-01-21T15:02:06.522Z"}
{"parentUuid":"7cc5e39b-4915-4f31-ad21-417d376bf253","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01N9WofeAYaEuP8dbsqmQDBP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XBfqu59PaWJV4S5zvRPVzg","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":133,"cache_creation_input_tokens":1127,"cache_read_input_tokens":15776,"cache_creation":{"ephemeral_5m_input_tokens":1127,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj1xxpLtzyUCQPshJe6","type":"assistant","uuid":"d9f62157-cdea-4acc-9787-a0531cbb66ab","timestamp":"2026-01-21T15:02:06.583Z"}
{"parentUuid":"99cdfd4d-2182-48d5-bcd6-ddbb8f628650","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XwjAK69GfmfCJpfMUpsCbE","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Planes;\n     4→\n     5→use OwenIt\\Auditing\\Auditable;\n     6→use App\\Models\\Empresas\\EmpresaPlan;\n     7→use Illuminate\\Database\\Eloquent\\Model;\n     8→use Illuminate\\Database\\Eloquent\\Builder;\n     9→use Illuminate\\Database\\Eloquent\\SoftDeletes;\n    10→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n    11→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    12→\n    13→class PlanCredito extends Model implements AuditableContract\n    14→{\n    15→    use Auditable, SoftDeletes;\n    16→\n    17→    protected $table = 'planes_creditos';\n    18→\n    19→    protected $fillable = [\n    20→        'nombre',\n    21→        'descripcion',\n    22→        'creditos',\n    23→        'precio',\n    24→        'porcentaje_descuento',\n    25→        'fecha_inicio_promocion',\n    26→        'fecha_fin_promocion',\n    27→        'activo'\n    28→    ];\n    29→\n    30→    protected $casts = [\n    31→        'creditos'               => 'integer',\n    32→        'precio'                 => 'decimal:2',\n    33→        'porcentaje_descuento'   => 'integer',\n    34→        'fecha_inicio_promocion' => 'date:Y-m-d',\n    35→        'fecha_fin_promocion'    => 'date:Y-m-d',\n    36→        'activo'                 => 'boolean'\n    37→    ];\n    38→\n    39→    protected $appends = [\n    40→        'precio_con_descuento'\n    41→    ];\n    42→\n    43→    /**\n    44→     * Filtrar registros activos.\n    45→     *\n    46→     * @param Builder $consulta Consulta.\n    47→     * @return Builder\n    48→     * @author Sergio Vargas\n    49→     * @author Daniel Beltrán\n    50→     */\n    51→    public function scopeActivos(Builder $consulta): Builder {\n    52→        return $consulta->where('activo', true);\n    53→    }\n    54→\n    55→    /**\n    56→     * Relación de uno a muchos con empresas_planes.\n    57→     *\n    58→     * @return HasMany\n    59→     * @author Sergio Vargas\n    60→     * @author Daniel Beltrán\n    61→     */\n    62→    public function empresasPlanes(): HasMany {\n    63→        return $this->hasMany(EmpresaPlan::class, 'plan_credito_id');\n    64→    }\n    65→\n    66→    /**\n    67→     * Obtener el precio con descuento aplicado.\n    68→     *\n    69→     * @return float\n    70→     * @author Sergio Vargas\n    71→     * @author Daniel Beltrán\n    72→     */\n    73→    public function getPrecioConDescuentoAttribute(): float {\n    74→        if (!$this->estaEnPromocion()) {\n    75→            return (float) $this->precio;\n    76→        }\n    77→\n    78→        $porcentaje = $this->porcentaje_descuento ?? 0;\n    79→        $descuento  = $this->precio * ($porcentaje / 100);\n    80→\n    81→        return (float) max(0, $this->precio - $descuento);\n    82→    }\n    83→\n    84→    /**\n    85→     * Verificar si el plan esta en promoción vigente.\n    86→     *\n    87→     * @return bool\n    88→     * @author Sergio Vargas\n    89→     * @author Daniel Beltrán\n    90→     */\n    91→    public function estaEnPromocion(): bool {\n    92→        if (!$this->porcentaje_descuento) {\n    93→            return false;\n    94→        }\n    95→\n    96→        $hoy = now()->startOfDay();\n    97→\n    98→        if ($this->fecha_inicio_promocion && $hoy->lt($this->fecha_inicio_promocion)) {\n    99→            return false;\n   100→        }\n   101→\n   102→        if ($this->fecha_fin_promocion && $hoy->gt($this->fecha_fin_promocion)) {\n   103→            return false;\n   104→        }\n   105→\n   106→        return true;\n   107→    }\n   108→}\n   109→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b92abe44-ecea-4717-8b2f-3f68384226bb","timestamp":"2026-01-21T15:02:16.008Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php","content":"<?php\n\nnamespace App\\Models\\Planes;\n\nuse OwenIt\\Auditing\\Auditable;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Builder;\nuse Illuminate\\Database\\Eloquent\\SoftDeletes;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\nuse OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n\nclass PlanCredito extends Model implements AuditableContract\n{\n    use Auditable, SoftDeletes;\n\n    protected $table = 'planes_creditos';\n\n    protected $fillable = [\n        'nombre',\n        'descripcion',\n        'creditos',\n        'precio',\n        'porcentaje_descuento',\n        'fecha_inicio_promocion',\n        'fecha_fin_promocion',\n        'activo'\n    ];\n\n    protected $casts = [\n        'creditos'               => 'integer',\n        'precio'                 => 'decimal:2',\n        'porcentaje_descuento'   => 'integer',\n        'fecha_inicio_promocion' => 'date:Y-m-d',\n        'fecha_fin_promocion'    => 'date:Y-m-d',\n        'activo'                 => 'boolean'\n    ];\n\n    protected $appends = [\n        'precio_con_descuento'\n    ];\n\n    /**\n     * Filtrar registros activos.\n     *\n     * @param Builder $consulta Consulta.\n     * @return Builder\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function scopeActivos(Builder $consulta): Builder {\n        return $consulta->where('activo', true);\n    }\n\n    /**\n     * Relación de uno a muchos con empresas_planes.\n     *\n     * @return HasMany\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function empresasPlanes(): HasMany {\n        return $this->hasMany(EmpresaPlan::class, 'plan_credito_id');\n    }\n\n    /**\n     * Obtener el precio con descuento aplicado.\n     *\n     * @return float\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getPrecioConDescuentoAttribute(): float {\n        if (!$this->estaEnPromocion()) {\n            return (float) $this->precio;\n        }\n\n        $porcentaje = $this->porcentaje_descuento ?? 0;\n        $descuento  = $this->precio * ($porcentaje / 100);\n\n        return (float) max(0, $this->precio - $descuento);\n    }\n\n    /**\n     * Verificar si el plan esta en promoción vigente.\n     *\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function estaEnPromocion(): bool {\n        if (!$this->porcentaje_descuento) {\n            return false;\n        }\n\n        $hoy = now()->startOfDay();\n\n        if ($this->fecha_inicio_promocion && $hoy->lt($this->fecha_inicio_promocion)) {\n            return false;\n        }\n\n        if ($this->fecha_fin_promocion && $hoy->gt($this->fecha_fin_promocion)) {\n            return false;\n        }\n\n        return true;\n    }\n}\n","numLines":109,"startLine":1,"totalLines":109}},"sourceToolAssistantUUID":"99cdfd4d-2182-48d5-bcd6-ddbb8f628650"}
{"parentUuid":"021d1d3a-8c00-4021-89a8-78a7835b0605","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DbAn6pwHhVDocMwdmijkKm","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\IA;\n     4→\n     5→use App\\Models\\Usuarios\\User;\n     6→use App\\Models\\Agendas\\Agenda;\n     7→use App\\Models\\Empresas\\Empresa;\n     8→use App\\Models\\Vacantes\\Vacante;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use Illuminate\\Database\\Eloquent\\Model;\n    11→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    12→\n    13→class ConsumoCredito extends Model\n    14→{\n    15→    protected $table = 'consumos_creditos';\n    16→\n    17→    protected $fillable = [\n    18→        'usuario_id',\n    19→        'empresa_id',\n    20→        'empresa_plan_id',\n    21→        'agenda_id',\n    22→        'vacante_id',\n    23→        'servicio_ia_id',\n    24→        'creditos',\n    25→        'ruta_endpoint',\n    26→        'nombre_servicio',\n    27→        'modelo',\n    28→        'tokens_entrada',\n    29→        'tokens_salida',\n    30→        'tokens_totales',\n    31→        'caracteres_entrada',\n    32→        'costo_estimado_usd',\n    33→        'huella_peticion',\n    34→        'extracto_peticion',\n    35→        'extracto_respuesta',\n    36→        'estado',\n    37→        'latencia_ms',\n    38→        'mensaje_error'\n    39→    ];\n    40→\n    41→    protected $casts = [\n    42→        'usuario_id'         => 'integer',\n    43→        'empresa_id'         => 'integer',\n    44→        'empresa_plan_id'    => 'integer',\n    45→        'agenda_id'          => 'integer',\n    46→        'vacante_id'         => 'integer',\n    47→        'servicio_ia_id'     => 'integer',\n    48→        'creditos'           => 'integer',\n    49→        'tokens_entrada'     => 'integer',\n    50→        'tokens_salida'      => 'integer',\n    51→        'tokens_totales'     => 'integer',\n    52→        'caracteres_entrada' => 'integer',\n    53→        'costo_estimado_usd' => 'decimal:6',\n    54→        'latencia_ms'        => 'integer',\n    55→        'created_at'         => 'datetime'\n    56→    ];\n    57→\n    58→    public $timestamps = false;\n    59→\n    60→    /**\n    61→     * Relación de muchos a uno con users.\n    62→     *\n    63→     * @return BelongsTo\n    64→     * @author Sergio Vargas\n    65→     * @author Daniel Beltrán\n    66→     */\n    67→    public function usuario(): BelongsTo {\n    68→        return $this->belongsTo(User::class, 'usuario_id');\n    69→    }\n    70→\n    71→    /**\n    72→     * Relación de muchos a uno con empresas.\n    73→     *\n    74→     * @return BelongsTo\n    75→     * @author Sergio Vargas\n    76→     * @author Daniel Beltrán\n    77→     */\n    78→    public function empresa(): BelongsTo {\n    79→        return $this->belongsTo(Empresa::class);\n    80→    }\n    81→\n    82→    /**\n    83→     * Relación de muchos a uno con empresas_planes.\n    84→     *\n    85→     * @return BelongsTo\n    86→     * @author Sergio Vargas\n    87→     * @author Daniel Beltrán\n    88→     */\n    89→    public function empresaPlan(): BelongsTo {\n    90→        return $this->belongsTo(EmpresaPlan::class, 'empresa_plan_id');\n    91→    }\n    92→\n    93→    /**\n    94→     * Relación de muchos a uno con servicios_ia.\n    95→     *\n    96→     * @return BelongsTo\n    97→     * @author Sergio Vargas\n    98→     * @author Daniel Beltrán\n    99→     */\n   100→    public function servicioIA(): BelongsTo {\n   101→        return $this->belongsTo(ServicioIA::class, 'servicio_ia_id');\n   102→    }\n   103→\n   104→    /**\n   105→     * Relación de muchos a uno con agendas.\n   106→     *\n   107→     * @return BelongsTo\n   108→     * @author Sergio Vargas\n   109→     * @author Daniel Beltrán\n   110→     */\n   111→    public function agenda(): BelongsTo {\n   112→        return $this->belongsTo(Agenda::class);\n   113→    }\n   114→\n   115→    /**\n   116→     * Relación de muchos a uno con vacantes.\n   117→     *\n   118→     * @return BelongsTo\n   119→     * @author Sergio Vargas\n   120→     * @author Daniel Beltrán\n   121→     */\n   122→    public function vacante(): BelongsTo {\n   123→        return $this->belongsTo(Vacante::class);\n   124→    }\n   125→}\n   126→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"c4e0ab12-30d0-4bf7-83f2-216c4d446885","timestamp":"2026-01-21T15:02:16.009Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php","content":"<?php\n\nnamespace App\\Models\\IA;\n\nuse App\\Models\\Usuarios\\User;\nuse App\\Models\\Agendas\\Agenda;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Models\\Vacantes\\Vacante;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n\nclass ConsumoCredito extends Model\n{\n    protected $table = 'consumos_creditos';\n\n    protected $fillable = [\n        'usuario_id',\n        'empresa_id',\n        'empresa_plan_id',\n        'agenda_id',\n        'vacante_id',\n        'servicio_ia_id',\n        'creditos',\n        'ruta_endpoint',\n        'nombre_servicio',\n        'modelo',\n        'tokens_entrada',\n        'tokens_salida',\n        'tokens_totales',\n        'caracteres_entrada',\n        'costo_estimado_usd',\n        'huella_peticion',\n        'extracto_peticion',\n        'extracto_respuesta',\n        'estado',\n        'latencia_ms',\n        'mensaje_error'\n    ];\n\n    protected $casts = [\n        'usuario_id'         => 'integer',\n        'empresa_id'         => 'integer',\n        'empresa_plan_id'    => 'integer',\n        'agenda_id'          => 'integer',\n        'vacante_id'         => 'integer',\n        'servicio_ia_id'     => 'integer',\n        'creditos'           => 'integer',\n        'tokens_entrada'     => 'integer',\n        'tokens_salida'      => 'integer',\n        'tokens_totales'     => 'integer',\n        'caracteres_entrada' => 'integer',\n        'costo_estimado_usd' => 'decimal:6',\n        'latencia_ms'        => 'integer',\n        'created_at'         => 'datetime'\n    ];\n\n    public $timestamps = false;\n\n    /**\n     * Relación de muchos a uno con users.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function usuario(): BelongsTo {\n        return $this->belongsTo(User::class, 'usuario_id');\n    }\n\n    /**\n     * Relación de muchos a uno con empresas.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function empresa(): BelongsTo {\n        return $this->belongsTo(Empresa::class);\n    }\n\n    /**\n     * Relación de muchos a uno con empresas_planes.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function empresaPlan(): BelongsTo {\n        return $this->belongsTo(EmpresaPlan::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de muchos a uno con servicios_ia.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function servicioIA(): BelongsTo {\n        return $this->belongsTo(ServicioIA::class, 'servicio_ia_id');\n    }\n\n    /**\n     * Relación de muchos a uno con agendas.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function agenda(): BelongsTo {\n        return $this->belongsTo(Agenda::class);\n    }\n\n    /**\n     * Relación de muchos a uno con vacantes.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function vacante(): BelongsTo {\n        return $this->belongsTo(Vacante::class);\n    }\n}\n","numLines":126,"startLine":1,"totalLines":126}},"sourceToolAssistantUUID":"021d1d3a-8c00-4021-89a8-78a7835b0605"}
{"parentUuid":"7cc5e39b-4915-4f31-ad21-417d376bf253","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RvJkmWKBCA37dYLVaw7gu2","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Empresas;\n     4→\n     5→use App\\Models\\Planes\\Plan;\n     6→use App\\Models\\Usuarios\\User;\n     7→use App\\Models\\Planes\\Consumo;\n     8→use App\\Models\\Pruebas\\Prueba;\n     9→use OwenIt\\Auditing\\Auditable;\n    10→use App\\Models\\IA\\ConsumoCredito;\n    11→use App\\Models\\Planes\\EstadoPlan;\n    12→use App\\Models\\Planes\\PlanCredito;\n    13→use App\\Models\\Planes\\Funcionalidad;\n    14→use App\\Models\\Configuraciones\\Archivo;\n    15→use Illuminate\\Database\\Eloquent\\Model;\n    16→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n    17→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    18→use Illuminate\\Database\\Eloquent\\Relations\\MorphMany;\n    19→use Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n    20→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    21→\n    22→class EmpresaPlan extends Model implements AuditableContract\n    23→{\n    24→    use Auditable;\n    25→\n    26→    protected $table = 'empresas_planes';\n    27→\n    28→    protected $fillable = [\n    29→        'empresa_id',\n    30→        'plan_id',\n    31→        'plan_credito_id',\n    32→        'usuario_id',\n    33→        'estado_id',\n    34→        'unidades',\n    35→        'cantidad_ofertas_laborales',\n    36→        'cantidad_usuarios',\n    37→        'cantidad_pruebas',\n    38→        'creditos',\n    39→        'fecha_inicio',\n    40→        'fecha_vencimiento',\n    41→        'precio',\n    42→        'porcentaje_descuento',\n    43→        'numero_factura',\n    44→        'comentario',\n    45→        'plan_original',\n    46→        'renovando',\n    47→        'por_facturar'\n    48→    ];\n    49→\n    50→    protected $casts = [\n    51→        'plan_credito_id'   => 'integer',\n    52→        'creditos'          => 'integer',\n    53→        'fecha_inicio'      => 'date:Y-m-d',\n    54→        'fecha_vencimiento' => 'date:Y-m-d'\n    55→    ];\n    56→\n    57→    protected $appends = [\n    58→        'vigencia_dias',\n    59→        'creditos_restantes'\n    60→    ];\n    61→\n    62→    /**\n    63→     * Obtener el atributo vigencia_dias.\n    64→     *\n    65→     * @return int\n    66→     * @author Daniel Beltrán\n    67→     */\n    68→    public function getVigenciaDiasAttribute(): int {\n    69→        $vigencia = 0;\n    70→\n    71→        if (!is_null($this->fecha_vencimiento) && !is_null($this->fecha_inicio)) {\n    72→            $vigencia = $this->fecha_inicio->diffInDays($this->fecha_vencimiento);\n    73→        }\n    74→\n    75→        return $vigencia;\n    76→    }\n    77→\n    78→    /**\n    79→     * Obtener el atributo creditos_restantes.\n    80→     *\n    81→     * @return int\n    82→     * @author Sergio Vargas\n    83→     * @author Daniel Beltrán\n    84→     */\n    85→    public function getCreditosRestantesAttribute(): int {\n    86→        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    87→    }\n    88→\n    89→    /**\n    90→     * Relación de muchos a uno con empresas.\n    91→     *\n    92→     * @return BelongsTo\n    93→     * @author Daniel Beltrán\n    94→     */\n    95→    public function empresa(): BelongsTo {\n    96→        return $this->belongsTo(Empresa::class);\n    97→    }\n    98→\n    99→    /**\n   100→     * Relación de muchos a uno con planes.\n   101→     *\n   102→     * @return BelongsTo\n   103→     * @author Daniel Beltrán\n   104→     */\n   105→    public function plan(): BelongsTo {\n   106→        return $this->belongsTo(Plan::class);\n   107→    }\n   108→\n   109→    /**\n   110→     * Relación de muchos a uno con planes_creditos.\n   111→     *\n   112→     * @return BelongsTo\n   113→     * @author Sergio Vargas\n   114→     * @author Daniel Beltrán\n   115→     * @author Jair Carvajal\n   116→     */\n   117→    public function planCredito(): BelongsTo {\n   118→        return $this->belongsTo(PlanCredito::class, 'plan_credito_id')->withDefault([]);\n   119→    }\n   120→\n   121→    /**\n   122→     * Relación de uno a varios con users.\n   123→     *\n   124→     * @return BelongsTo\n   125→     * @author José Manuel Jiménez\n   126→     */\n   127→    public function usuario(): BelongsTo {\n   128→        return $this->belongsTo(User::class);\n   129→    }\n   130→\n   131→    /**\n   132→     * Relación de muchos a uno con estados_planes.\n   133→     *\n   134→     * @return BelongsTo\n   135→     * @author Daniel Beltrán\n   136→     */\n   137→    public function estado(): BelongsTo {\n   138→        return $this->belongsTo(EstadoPlan::class);\n   139→    }\n   140→\n   141→    /**\n   142→     * Relación de uno a muchos con consumos.\n   143→     *\n   144→     * @return HasMany\n   145→     * @author Daniel Beltrán\n   146→     */\n   147→    public function consumos(): HasMany {\n   148→        return $this->hasMany(Consumo::class, 'empresa_plan_id');\n   149→    }\n   150→\n   151→    /**\n   152→     * Relación de uno a muchos con consumos de créditos.\n   153→     *\n   154→     * @return HasMany\n   155→     * @author Sergio Vargas\n   156→     * @author Daniel Beltrán\n   157→     */\n   158→    public function consumosCreditos(): HasMany {\n   159→        return $this->hasMany(ConsumoCredito::class, 'empresa_plan_id');\n   160→    }\n   161→\n   162→    /**\n   163→     * Relación de muchos a muchos con pruebas.\n   164→     *\n   165→     * @return BelongsToMany\n   166→     * @author Daniel Beltrán\n   167→     */\n   168→    public function pruebas(): BelongsToMany {\n   169→        return $this->belongsToMany(Prueba::class, 'empresas_planes_pruebas', 'empresa_plan_id', 'prueba_id')->withTimestamps();\n   170→    }\n   171→\n   172→    /**\n   173→     * Relación polimórfica de uno a muchos con archivos.\n   174→     *\n   175→     * @return MorphMany\n   176→     * @author Daniel Beltrán\n   177→     */\n   178→    public function archivos(): MorphMany {\n   179→        return $this->morphMany(Archivo::class, 'modelo', 'modelo', 'modelo_id');\n   180→    }\n   181→\n   182→    /**\n   183→     * Relación de muchos a muchos con funcionalidades.\n   184→     *\n   185→     * @return BelongsToMany\n   186→     * @author Daniel Beltrán\n   187→     */\n   188→    public function funcionalidades(): BelongsToMany {\n   189→        return $this->belongsToMany(Funcionalidad::class, 'empresas_planes_funcionalidades', 'empresa_plan_id', 'funcionalidad_id')->withTimestamps();\n   190→    }\n   191→}\n   192→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1203c052-feb7-4d82-a869-fd80f22ad414","timestamp":"2026-01-21T15:02:16.010Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php","content":"<?php\n\nnamespace App\\Models\\Empresas;\n\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Usuarios\\User;\nuse App\\Models\\Planes\\Consumo;\nuse App\\Models\\Pruebas\\Prueba;\nuse OwenIt\\Auditing\\Auditable;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Models\\Planes\\EstadoPlan;\nuse App\\Models\\Planes\\PlanCredito;\nuse App\\Models\\Planes\\Funcionalidad;\nuse App\\Models\\Configuraciones\\Archivo;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Database\\Eloquent\\Relations\\MorphMany;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\nuse OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n\nclass EmpresaPlan extends Model implements AuditableContract\n{\n    use Auditable;\n\n    protected $table = 'empresas_planes';\n\n    protected $fillable = [\n        'empresa_id',\n        'plan_id',\n        'plan_credito_id',\n        'usuario_id',\n        'estado_id',\n        'unidades',\n        'cantidad_ofertas_laborales',\n        'cantidad_usuarios',\n        'cantidad_pruebas',\n        'creditos',\n        'fecha_inicio',\n        'fecha_vencimiento',\n        'precio',\n        'porcentaje_descuento',\n        'numero_factura',\n        'comentario',\n        'plan_original',\n        'renovando',\n        'por_facturar'\n    ];\n\n    protected $casts = [\n        'plan_credito_id'   => 'integer',\n        'creditos'          => 'integer',\n        'fecha_inicio'      => 'date:Y-m-d',\n        'fecha_vencimiento' => 'date:Y-m-d'\n    ];\n\n    protected $appends = [\n        'vigencia_dias',\n        'creditos_restantes'\n    ];\n\n    /**\n     * Obtener el atributo vigencia_dias.\n     *\n     * @return int\n     * @author Daniel Beltrán\n     */\n    public function getVigenciaDiasAttribute(): int {\n        $vigencia = 0;\n\n        if (!is_null($this->fecha_vencimiento) && !is_null($this->fecha_inicio)) {\n            $vigencia = $this->fecha_inicio->diffInDays($this->fecha_vencimiento);\n        }\n\n        return $vigencia;\n    }\n\n    /**\n     * Obtener el atributo creditos_restantes.\n     *\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getCreditosRestantesAttribute(): int {\n        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    }\n\n    /**\n     * Relación de muchos a uno con empresas.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function empresa(): BelongsTo {\n        return $this->belongsTo(Empresa::class);\n    }\n\n    /**\n     * Relación de muchos a uno con planes.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function plan(): BelongsTo {\n        return $this->belongsTo(Plan::class);\n    }\n\n    /**\n     * Relación de muchos a uno con planes_creditos.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planCredito(): BelongsTo {\n        return $this->belongsTo(PlanCredito::class, 'plan_credito_id')->withDefault([]);\n    }\n\n    /**\n     * Relación de uno a varios con users.\n     *\n     * @return BelongsTo\n     * @author José Manuel Jiménez\n     */\n    public function usuario(): BelongsTo {\n        return $this->belongsTo(User::class);\n    }\n\n    /**\n     * Relación de muchos a uno con estados_planes.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function estado(): BelongsTo {\n        return $this->belongsTo(EstadoPlan::class);\n    }\n\n    /**\n     * Relación de uno a muchos con consumos.\n     *\n     * @return HasMany\n     * @author Daniel Beltrán\n     */\n    public function consumos(): HasMany {\n        return $this->hasMany(Consumo::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de uno a muchos con consumos de créditos.\n     *\n     * @return HasMany\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function consumosCreditos(): HasMany {\n        return $this->hasMany(ConsumoCredito::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de muchos a muchos con pruebas.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function pruebas(): BelongsToMany {\n        return $this->belongsToMany(Prueba::class, 'empresas_planes_pruebas', 'empresa_plan_id', 'prueba_id')->withTimestamps();\n    }\n\n    /**\n     * Relación polimórfica de uno a muchos con archivos.\n     *\n     * @return MorphMany\n     * @author Daniel Beltrán\n     */\n    public function archivos(): MorphMany {\n        return $this->morphMany(Archivo::class, 'modelo', 'modelo', 'modelo_id');\n    }\n\n    /**\n     * Relación de muchos a muchos con funcionalidades.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function funcionalidades(): BelongsToMany {\n        return $this->belongsToMany(Funcionalidad::class, 'empresas_planes_funcionalidades', 'empresa_plan_id', 'funcionalidad_id')->withTimestamps();\n    }\n}\n","numLines":192,"startLine":1,"totalLines":192}},"sourceToolAssistantUUID":"7cc5e39b-4915-4f31-ad21-417d376bf253"}
{"parentUuid":"d9f62157-cdea-4acc-9787-a0531cbb66ab","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XBfqu59PaWJV4S5zvRPVzg","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Planes;\n     4→\n     5→use OwenIt\\Auditing\\Auditable;\n     6→use App\\Models\\Empresas\\Empresa;\n     7→use App\\Models\\Pruebas\\TipoPrueba;\n     8→use Illuminate\\Database\\Eloquent\\Model;\n     9→use Illuminate\\Database\\Eloquent\\SoftDeletes;\n    10→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    11→use Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\n    12→use Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n    13→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    14→\n    15→class Plan extends Model implements AuditableContract\n    16→{\n    17→    use HasFactory, SoftDeletes, Auditable;\n    18→\n    19→    public const ESTADO_ACTIVO_ID     = 1;\n    20→    public const ESTADO_INACTIVO_ID   = 2;\n    21→    public const ESTADO_PROXIMO_ID    = 3;\n    22→    public const ESTADO_POR_VENCER_ID = 4;\n    23→    public const ESTADO_VENCIDO_ID    = 5;\n    24→\n    25→    protected $table = 'planes';\n    26→\n    27→    protected $fillable = [\n    28→        'tipo_prueba_id',\n    29→        'nombre',\n    30→        'descripcion',\n    31→        'unidades',\n    32→        'cantidad_ofertas_laborales',\n    33→        'vigencia',\n    34→        'cantidad_usuarios',\n    35→        'cantidad_pruebas',\n    36→        'precio',\n    37→        'en_promocion',\n    38→        'porcentaje_descuento',\n    39→        'fecha_inicio_promocion',\n    40→        'fecha_fin_promocion',\n    41→        'comentario',\n    42→        'activo'\n    43→    ];\n    44→\n    45→    protected $casts = [\n    46→        'created_at' => 'datetime:d/m/Y',\n    47→        'updated_at' => 'datetime:d/m/Y'\n    48→    ];\n    49→\n    50→    /**\n    51→     * Relación de muchos a uno con tipos_pruebas.\n    52→     *\n    53→     * @return BelongsTo\n    54→     * @author Daniel Beltrán\n    55→     */\n    56→    public function tipoPrueba(): BelongsTo {\n    57→        return $this->belongsTo(TipoPrueba::class);\n    58→    }\n    59→\n    60→    /**\n    61→     * Relación de muchos a muchos con funcionalidades.\n    62→     *\n    63→     * @return BelongsToMany\n    64→     * @author Daniel Beltrán\n    65→     */\n    66→    public function funcionalidades(): BelongsToMany {\n    67→        return $this->belongsToMany(Funcionalidad::class, 'funcionalidades_planes', 'plan_id', 'funcionalidad_id')->withTimestamps();\n    68→    }\n    69→\n    70→    /**\n    71→     * Relación de muchos a muchos con modulos.\n    72→     *\n    73→     * @return BelongsToMany\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function modulos(): BelongsToMany {\n    77→        return $this->belongsToMany(Modulo::class, 'modulos_planes', 'plan_id', 'modulo_id')->withTimestamps();\n    78→    }\n    79→\n    80→    /**\n    81→     * Relación de muchos a muchos con empresas.\n    82→     *\n    83→     * @return BelongsToMany\n    84→     * @author Daniel Beltrán\n    85→     */\n    86→    public function empresas(): BelongsToMany {\n    87→        return $this->belongsToMany(Empresa::class, 'empresas_planes', 'plan_id', 'empresa_id')\n    88→        ->withPivot(['unidades', 'fecha_vencimiento', 'precio'])\n    89→        ->withTimestamps();\n    90→    }\n    91→}\n    92→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"9508b343-8b3a-45c8-985b-1ec3041befbc","timestamp":"2026-01-21T15:02:16.010Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php","content":"<?php\n\nnamespace App\\Models\\Planes;\n\nuse OwenIt\\Auditing\\Auditable;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\SoftDeletes;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\nuse OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n\nclass Plan extends Model implements AuditableContract\n{\n    use HasFactory, SoftDeletes, Auditable;\n\n    public const ESTADO_ACTIVO_ID     = 1;\n    public const ESTADO_INACTIVO_ID   = 2;\n    public const ESTADO_PROXIMO_ID    = 3;\n    public const ESTADO_POR_VENCER_ID = 4;\n    public const ESTADO_VENCIDO_ID    = 5;\n\n    protected $table = 'planes';\n\n    protected $fillable = [\n        'tipo_prueba_id',\n        'nombre',\n        'descripcion',\n        'unidades',\n        'cantidad_ofertas_laborales',\n        'vigencia',\n        'cantidad_usuarios',\n        'cantidad_pruebas',\n        'precio',\n        'en_promocion',\n        'porcentaje_descuento',\n        'fecha_inicio_promocion',\n        'fecha_fin_promocion',\n        'comentario',\n        'activo'\n    ];\n\n    protected $casts = [\n        'created_at' => 'datetime:d/m/Y',\n        'updated_at' => 'datetime:d/m/Y'\n    ];\n\n    /**\n     * Relación de muchos a uno con tipos_pruebas.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function tipoPrueba(): BelongsTo {\n        return $this->belongsTo(TipoPrueba::class);\n    }\n\n    /**\n     * Relación de muchos a muchos con funcionalidades.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function funcionalidades(): BelongsToMany {\n        return $this->belongsToMany(Funcionalidad::class, 'funcionalidades_planes', 'plan_id', 'funcionalidad_id')->withTimestamps();\n    }\n\n    /**\n     * Relación de muchos a muchos con modulos.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function modulos(): BelongsToMany {\n        return $this->belongsToMany(Modulo::class, 'modulos_planes', 'plan_id', 'modulo_id')->withTimestamps();\n    }\n\n    /**\n     * Relación de muchos a muchos con empresas.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function empresas(): BelongsToMany {\n        return $this->belongsToMany(Empresa::class, 'empresas_planes', 'plan_id', 'empresa_id')\n        ->withPivot(['unidades', 'fecha_vencimiento', 'precio'])\n        ->withTimestamps();\n    }\n}\n","numLines":92,"startLine":1,"totalLines":92}},"sourceToolAssistantUUID":"d9f62157-cdea-4acc-9787-a0531cbb66ab"}
{"parentUuid":"9508b343-8b3a-45c8-985b-1ec3041befbc","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01D8fa9v5rfNdpkp5mKejnjj","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a leer los servicios y controladores:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":7409,"cache_read_input_tokens":16903,"cache_creation":{"ephemeral_5m_input_tokens":7409,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj3BVAGot51FviFhwX6","type":"assistant","uuid":"96e4d84e-d7f6-44b0-b807-d7e6460772f3","timestamp":"2026-01-21T15:02:19.281Z"}
{"parentUuid":"96e4d84e-d7f6-44b0-b807-d7e6460772f3","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01D8fa9v5rfNdpkp5mKejnjj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0161r6EpbNY6xbjjsKxSAPJK","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":7409,"cache_read_input_tokens":16903,"cache_creation":{"ephemeral_5m_input_tokens":7409,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj3BVAGot51FviFhwX6","type":"assistant","uuid":"a3ea617f-5e3f-4974-95de-32ba488af970","timestamp":"2026-01-21T15:02:20.758Z"}
{"parentUuid":"a3ea617f-5e3f-4974-95de-32ba488af970","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01D8fa9v5rfNdpkp5mKejnjj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014epJBdkLzDs4vZqYFtkwDQ","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":7409,"cache_read_input_tokens":16903,"cache_creation":{"ephemeral_5m_input_tokens":7409,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj3BVAGot51FviFhwX6","type":"assistant","uuid":"d8bcdbac-17fc-4795-84ec-b76213bc0ec0","timestamp":"2026-01-21T15:02:22.841Z"}
{"parentUuid":"d8bcdbac-17fc-4795-84ec-b76213bc0ec0","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01D8fa9v5rfNdpkp5mKejnjj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WsmmBAhss4pVSmm9bjPvdu","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\CreditoIAService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":7409,"cache_read_input_tokens":16903,"cache_creation":{"ephemeral_5m_input_tokens":7409,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj3BVAGot51FviFhwX6","type":"assistant","uuid":"37f273a2-b694-482d-9f8c-d83f898ccadc","timestamp":"2026-01-21T15:02:22.941Z"}
{"parentUuid":"37f273a2-b694-482d-9f8c-d83f898ccadc","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01D8fa9v5rfNdpkp5mKejnjj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TrfoggQyg2Q8HQhBnCgLvA","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":7409,"cache_read_input_tokens":16903,"cache_creation":{"ephemeral_5m_input_tokens":7409,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj3BVAGot51FviFhwX6","type":"assistant","uuid":"35e96a2b-e789-4b8d-b299-4c05a80385f7","timestamp":"2026-01-21T15:02:23.093Z"}
{"parentUuid":"a3ea617f-5e3f-4974-95de-32ba488af970","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0161r6EpbNY6xbjjsKxSAPJK","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Planes;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Http\\Services\\BaseService;\n     7→use App\\Models\\Planes\\PlanCredito;\n     8→use Illuminate\\Support\\Collection;\n     9→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    10→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    11→\n    12→/**\n    13→ * @property PlanCreditoRepository $repositorio\n    14→ */\n    15→class PlanCreditoService extends BaseService\n    16→{\n    17→    /**\n    18→     * Constructor.\n    19→     *\n    20→     * @param PlanCreditoRepository $repositorio Repositorio de planes de créditos.\n    21→     * @param ServicioIARepository $repositorio Repositorio de planes de IA.\n    22→     * @return void\n    23→     * @author Sergio Vargas\n    24→     * @author Daniel Beltrán\n    25→     * @author Jair Carvajal\n    26→     */\n    27→    public function __construct(\n    28→        PlanCreditoRepository $repositorio,\n    29→        protected ServicioIARepository $servicio_ia_repositorio\n    30→    ) {\n    31→        parent::__construct($repositorio);\n    32→    }\n    33→\n    34→    /**\n    35→     * Obtener planes de créditos con datos calculados.\n    36→     *\n    37→     * @param Request $request Contenido de la petición.\n    38→     * @return Collection\n    39→     * @author Jair Carvajal\n    40→     */\n    41→    public function getTodoCreditosPromedio(Request $request): Collection {\n    42→        $planes                   = $this->repositorio->getTodo($request);\n    43→        $creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n    44→\n    45→        return $planes->map(function ($plan) use ($creditos_promedio_accion) {\n    46→            $plan->creditos_disponibles     = $plan->creditos;\n    47→            $plan->creditos_promedio_accion = $creditos_promedio_accion;\n    48→\n    49→            return $plan;\n    50→        });\n    51→    }\n    52→\n    53→    /**\n    54→     * Crear o actualizar un plan de créditos.\n    55→     *\n    56→     * @param Request $request Contenido de la petición.\n    57→     * @return PlanCredito\n    58→     * @author Sergio Vargas\n    59→     * @author Daniel Beltrán\n    60→     */\n    61→    public function guardar(Request $request): PlanCredito {\n    62→        $campos_excluidos = ['_token', '_method', 'id', 'servicios'];\n    63→\n    64→        if ($request->filled('id')) {\n    65→            return $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n    66→        }\n    67→\n    68→        return $this->repositorio->crear($request->except($campos_excluidos));\n    69→    }\n    70→\n    71→    /**\n    72→     * Calcular el precio final del plan.\n    73→     *\n    74→     * @param PlanCredito $plan Plan de crédito.\n    75→     * @return float\n    76→     * @author Sergio Vargas\n    77→     * @author Daniel Beltrán\n    78→     */\n    79→    public function calcularPrecioFinal(PlanCredito $plan): float {\n    80→        return $plan->precio_con_descuento;\n    81→    }\n    82→}\n    83→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"f6675d2f-ba05-4bcc-a208-f42fd636c8af","timestamp":"2026-01-21T15:02:31.347Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Planes;\n\nuse Illuminate\\Http\\Request;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Planes\\PlanCredito;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ServicioIARepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n\n/**\n * @property PlanCreditoRepository $repositorio\n */\nclass PlanCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param PlanCreditoRepository $repositorio Repositorio de planes de créditos.\n     * @param ServicioIARepository $repositorio Repositorio de planes de IA.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function __construct(\n        PlanCreditoRepository $repositorio,\n        protected ServicioIARepository $servicio_ia_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Obtener planes de créditos con datos calculados.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Jair Carvajal\n     */\n    public function getTodoCreditosPromedio(Request $request): Collection {\n        $planes                   = $this->repositorio->getTodo($request);\n        $creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n\n        return $planes->map(function ($plan) use ($creditos_promedio_accion) {\n            $plan->creditos_disponibles     = $plan->creditos;\n            $plan->creditos_promedio_accion = $creditos_promedio_accion;\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Crear o actualizar un plan de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return PlanCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function guardar(Request $request): PlanCredito {\n        $campos_excluidos = ['_token', '_method', 'id', 'servicios'];\n\n        if ($request->filled('id')) {\n            return $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        }\n\n        return $this->repositorio->crear($request->except($campos_excluidos));\n    }\n\n    /**\n     * Calcular el precio final del plan.\n     *\n     * @param PlanCredito $plan Plan de crédito.\n     * @return float\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function calcularPrecioFinal(PlanCredito $plan): float {\n        return $plan->precio_con_descuento;\n    }\n}\n","numLines":83,"startLine":1,"totalLines":83}},"sourceToolAssistantUUID":"a3ea617f-5e3f-4974-95de-32ba488af970"}
{"parentUuid":"d8bcdbac-17fc-4795-84ec-b76213bc0ec0","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014epJBdkLzDs4vZqYFtkwDQ","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\IA;\n     4→\n     5→use Carbon\\Carbon;\n     6→use Illuminate\\Support\\Str;\n     7→use App\\Models\\IA\\ConsumoCredito;\n     8→use App\\Http\\Services\\BaseService;\n     9→use Illuminate\\Support\\Collection;\n    10→use App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n    11→\n    12→class ConsumoCreditoService extends BaseService\n    13→{\n    14→    /**\n    15→     * Constructor.\n    16→     *\n    17→     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n    18→     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n    19→     * @return void\n    20→     * @author Sergio Vargas\n    21→     * @author Daniel Beltrán\n    22→     */\n    23→    public function __construct(\n    24→        ConsumoCreditoRepository $repositorio,\n    25→        private readonly ServicioPrecioTokenService $precio_token_servicio\n    26→    ) {\n    27→        parent::__construct($repositorio);\n    28→    }\n    29→\n    30→    /**\n    31→     * Registra el consumo de tokens desde la respuesta de la API de IA.\n    32→     *\n    33→     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n    34→     *\n    35→     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n    36→     * @param array $respuesta_ia Respuesta completa de la API de IA.\n    37→     * @param ?int $usuario_id ID del usuario que realizó la petición.\n    38→     * @param ?int $empresa_id ID de la empresa del usuario.\n    39→     * @param array $contexto Array con agenda_id, vacante_id, etc.\n    40→     * @param ?string $payload_peticion JSON del payload enviado.\n    41→     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n    42→     * @return ?ConsumoCredito\n    43→     * @author Sergio Vargas\n    44→     * @author Daniel Beltrán\n    45→     */\n    46→    public function registrarConsumoDesdeRespuesta(\n    47→        string $ruta_endpoint,\n    48→        array $respuesta_ia,\n    49→        ?int $usuario_id = null,\n    50→        ?int $empresa_id = null,\n    51→        ?array $contexto = [],\n    52→        ?string $payload_peticion = null,\n    53→        ?int $latencia_ms = null\n    54→    ): ?ConsumoCredito {\n    55→        // Detectar si hay múltiples metadata de uso (formato nuevo)\n    56→        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n    57→        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n    58→        $ultimo_registro = null;\n    59→\n    60→        // Registrar Whisper si existe\n    61→        if ($uso_whisper) {\n    62→            $ultimo_registro = $this->registrarConsumoIndividual(\n    63→                ruta_endpoint: $ruta_endpoint . '.whisper',\n    64→                usage: $uso_whisper,\n    65→                respuesta_ia: $respuesta_ia,\n    66→                usuario_id: $usuario_id,\n    67→                empresa_id: $empresa_id,\n    68→                contexto: $contexto,\n    69→                payload_peticion: $payload_peticion,\n    70→                latencia_ms: $latencia_ms\n    71→            );\n    72→        }\n    73→\n    74→        // Registrar GPT si existe\n    75→        if ($uso_gpt) {\n    76→            $ultimo_registro = $this->registrarConsumoIndividual(\n    77→                ruta_endpoint: $ruta_endpoint . '.gpt',\n    78→                usage: $uso_gpt,\n    79→                respuesta_ia: $respuesta_ia,\n    80→                usuario_id: $usuario_id,\n    81→                empresa_id: $empresa_id,\n    82→                contexto: $contexto,\n    83→                payload_peticion: $payload_peticion,\n    84→                latencia_ms: $latencia_ms\n    85→            );\n    86→        }\n    87→\n    88→        // Fallback: Si solo hay \"usage\" (formato legacy)\n    89→        $usage_legacy = $respuesta_ia['usage'] ?? null;\n    90→\n    91→        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n    92→            $ultimo_registro = $this->registrarConsumoIndividual(\n    93→                ruta_endpoint: $ruta_endpoint,\n    94→                usage: $usage_legacy,\n    95→                respuesta_ia: $respuesta_ia,\n    96→                usuario_id: $usuario_id,\n    97→                empresa_id: $empresa_id,\n    98→                contexto: $contexto,\n    99→                payload_peticion: $payload_peticion,\n   100→                latencia_ms: $latencia_ms\n   101→            );\n   102→        }\n   103→\n   104→        return $ultimo_registro;\n   105→    }\n   106→\n   107→    /**\n   108→     * Registra un consumo individual de tokens desde una metadata de uso específica.\n   109→     *\n   110→     * @param string $ruta_endpoint Ruta del endpoint llamado.\n   111→     * @param array $usage Metadata de uso específica.\n   112→     * @param array $respuesta_ia Respuesta completa de la API de IA.\n   113→     * @param ?int $usuario_id ID del usuario que realizó la petición.\n   114→     * @param ?int $empresa_id ID de la empresa del usuario.\n   115→     * @param array $contexto Array con agenda_id, vacante_id, etc.\n   116→     * @param ?string $payload_peticion JSON del payload enviado.\n   117→     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n   118→     * @return ?ConsumoCredito\n   119→     * @author Sergio Vargas\n   120→     * @author Daniel Beltrán\n   121→     */\n   122→    private function registrarConsumoIndividual(\n   123→        string $ruta_endpoint,\n   124→        array $usage,\n   125→        array $respuesta_ia,\n   126→        ?int $usuario_id,\n   127→        ?int $empresa_id,\n   128→        array $contexto,\n   129→        ?string $payload_peticion,\n   130→        ?int $latencia_ms\n   131→    ): ?ConsumoCredito {\n   132→        $vacante_id = $contexto['vacante_id'] ?? null;\n   133→\n   134→        if (!$vacante_id && $payload_peticion) {\n   135→            $decoded = json_decode($payload_peticion, true);\n   136→\n   137→            if (is_array($decoded)) {\n   138→                $vacante_id = data_get($decoded, 'vacante_id')\n   139→                    ?? data_get($decoded, 'vacanteId')\n   140→                    ?? data_get($decoded, 'id')\n   141→                    ?? data_get($decoded, 'vacante.id');\n   142→\n   143→                if ($vacante_id && !is_numeric($vacante_id)) {\n   144→                    $vacante_id = null;\n   145→                } elseif (is_numeric($vacante_id)) {\n   146→                    $vacante_id = (int) $vacante_id;\n   147→                }\n   148→            }\n   149→        }\n   150→\n   151→        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n   152→        $modelo = $usage['model'] ?? 'desconocido';\n   153→\n   154→        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n   155→        $metadata_adicional = [];\n   156→\n   157→        if (isset($usage['audio_duration_minutes'])) {\n   158→            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n   159→        }\n   160→\n   161→        if (isset($usage['audio_duration_seconds'])) {\n   162→            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n   163→        }\n   164→\n   165→        // Calcular costo estimado (pasando metadata adicional para Whisper)\n   166→        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n   167→            $modelo,\n   168→            $usage['prompt_tokens'] ?? 0,\n   169→            $usage['completion_tokens'] ?? 0,\n   170→            $metadata_adicional ?: null\n   171→        );\n   172→\n   173→        // Generar huella digital\n   174→        $huella_peticion = null;\n   175→\n   176→        if ($payload_peticion) {\n   177→            $huella_peticion = hash('sha256', $payload_peticion);\n   178→        }\n   179→\n   180→        // Determinar estado de la respuesta\n   181→        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n   182→        $estado = 'exitoso';\n   183→\n   184→        if (isset($respuesta_ia['status_code'])) {\n   185→            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n   186→        } elseif (isset($respuesta_ia['error'])) {\n   187→            $estado = 'error';\n   188→        }\n   189→\n   190→        // Preparar datos\n   191→        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n   192→        $contenido_respuesta = $respuesta_ia['data']\n   193→            ?? $respuesta_ia['vacante']\n   194→            ?? $respuesta_ia['preguntas']\n   195→            ?? $respuesta_ia['pruebas']\n   196→            ?? $respuesta_ia['calificacion']\n   197→            ?? null;\n   198→\n   199→        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n   200→        if ($contenido_respuesta === null) {\n   201→            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n   202→        }\n   203→\n   204→        $datos = [\n   205→            'usuario_id'         => $usuario_id,\n   206→            'empresa_id'         => $empresa_id,\n   207→            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n   208→            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n   209→            'creditos'           => $contexto['creditos'] ?? 0,\n   210→            'ruta_endpoint'      => $ruta_endpoint,\n   211→            'nombre_servicio'    => $usage['service_name'] ?? null,\n   212→            'modelo'             => $modelo,\n   213→            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n   214→            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n   215→            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n   216→            'caracteres_entrada' => $usage['input_chars'] ?? null,\n   217→            'costo_estimado_usd' => $costo_estimado,\n   218→            'huella_peticion'    => $huella_peticion,\n   219→            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n   220→            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n   221→            'estado'             => $estado,\n   222→            'latencia_ms'        => $latencia_ms,\n   223→            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n   224→            'agenda_id'          => $contexto['agenda_id'] ?? null,\n   225→            'vacante_id'         => $vacante_id\n   226→        ];\n   227→\n   228→        return $this->repositorio->crear($datos);\n   229→    }\n   230→\n   231→    /**\n   232→     * Obtener historial de consumos de creditos por empresa.\n   233→     *\n   234→     * @param int $empresa_id ID de la empresa.\n   235→     * @param array $filtros Filtros de fecha.\n   236→     * @return Collection\n   237→     * @author Sergio Vargas\n   238→     */\n   239→    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n   240→        $desde = null;\n   241→        $hasta = null;\n   242→\n   243→        if (!empty($filtros['desde'])) {\n   244→            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n   245→        }\n   246→\n   247→        if (!empty($filtros['hasta'])) {\n   248→            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n   249→        }\n   250→\n   251→        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n   252→\n   253→        return $consumos->map(function (ConsumoCredito $consumo) {\n   254→            $servicio = $consumo->servicioIA?->nombre\n   255→                ?? $consumo->nombre_servicio\n   256→                ?? $consumo->ruta_endpoint;\n   257→\n   258→            return [\n   259→                'usuario'        => $consumo->usuario ? [\n   260→                    'id'              => $consumo->usuario->id,\n   261→                    'nombre_completo' => $consumo->usuario->nombre_completo\n   262→                ] : null,\n   263→                'servicio'       => $servicio,\n   264→                'creditos'       => $consumo->creditos ?? 0,\n   265→                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n   266→                'fecha_consumo'  => $consumo->created_at\n   267→            ];\n   268→        });\n   269→    }\n   270→}\n   271→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"04ea7b90-1ec8-4315-9519-45ab2c875b69","timestamp":"2026-01-21T15:02:31.347Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","content":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n\nclass ConsumoCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Registra el consumo de tokens desde la respuesta de la API de IA.\n     *\n     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function registrarConsumoDesdeRespuesta(\n        string $ruta_endpoint,\n        array $respuesta_ia,\n        ?int $usuario_id = null,\n        ?int $empresa_id = null,\n        ?array $contexto = [],\n        ?string $payload_peticion = null,\n        ?int $latencia_ms = null\n    ): ?ConsumoCredito {\n        // Detectar si hay múltiples metadata de uso (formato nuevo)\n        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n        $ultimo_registro = null;\n\n        // Registrar Whisper si existe\n        if ($uso_whisper) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.whisper',\n                usage: $uso_whisper,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Registrar GPT si existe\n        if ($uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.gpt',\n                usage: $uso_gpt,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Registra un consumo individual de tokens desde una metadata de uso específica.\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado.\n     * @param array $usage Metadata de uso específica.\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function registrarConsumoIndividual(\n        string $ruta_endpoint,\n        array $usage,\n        array $respuesta_ia,\n        ?int $usuario_id,\n        ?int $empresa_id,\n        array $contexto,\n        ?string $payload_peticion,\n        ?int $latencia_ms\n    ): ?ConsumoCredito {\n        $vacante_id = $contexto['vacante_id'] ?? null;\n\n        if (!$vacante_id && $payload_peticion) {\n            $decoded = json_decode($payload_peticion, true);\n\n            if (is_array($decoded)) {\n                $vacante_id = data_get($decoded, 'vacante_id')\n                    ?? data_get($decoded, 'vacanteId')\n                    ?? data_get($decoded, 'id')\n                    ?? data_get($decoded, 'vacante.id');\n\n                if ($vacante_id && !is_numeric($vacante_id)) {\n                    $vacante_id = null;\n                } elseif (is_numeric($vacante_id)) {\n                    $vacante_id = (int) $vacante_id;\n                }\n            }\n        }\n\n        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n        $modelo = $usage['model'] ?? 'desconocido';\n\n        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n        $metadata_adicional = [];\n\n        if (isset($usage['audio_duration_minutes'])) {\n            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n        }\n\n        if (isset($usage['audio_duration_seconds'])) {\n            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n        }\n\n        // Calcular costo estimado (pasando metadata adicional para Whisper)\n        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n            $modelo,\n            $usage['prompt_tokens'] ?? 0,\n            $usage['completion_tokens'] ?? 0,\n            $metadata_adicional ?: null\n        );\n\n        // Generar huella digital\n        $huella_peticion = null;\n\n        if ($payload_peticion) {\n            $huella_peticion = hash('sha256', $payload_peticion);\n        }\n\n        // Determinar estado de la respuesta\n        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n        $estado = 'exitoso';\n\n        if (isset($respuesta_ia['status_code'])) {\n            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n        } elseif (isset($respuesta_ia['error'])) {\n            $estado = 'error';\n        }\n\n        // Preparar datos\n        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n        $contenido_respuesta = $respuesta_ia['data']\n            ?? $respuesta_ia['vacante']\n            ?? $respuesta_ia['preguntas']\n            ?? $respuesta_ia['pruebas']\n            ?? $respuesta_ia['calificacion']\n            ?? null;\n\n        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n        if ($contenido_respuesta === null) {\n            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n        }\n\n        $datos = [\n            'usuario_id'         => $usuario_id,\n            'empresa_id'         => $empresa_id,\n            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n            'creditos'           => $contexto['creditos'] ?? 0,\n            'ruta_endpoint'      => $ruta_endpoint,\n            'nombre_servicio'    => $usage['service_name'] ?? null,\n            'modelo'             => $modelo,\n            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n            'caracteres_entrada' => $usage['input_chars'] ?? null,\n            'costo_estimado_usd' => $costo_estimado,\n            'huella_peticion'    => $huella_peticion,\n            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n            'estado'             => $estado,\n            'latencia_ms'        => $latencia_ms,\n            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n            'agenda_id'          => $contexto['agenda_id'] ?? null,\n            'vacante_id'         => $vacante_id\n        ];\n\n        return $this->repositorio->crear($datos);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param array $filtros Filtros de fecha.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n        $desde = null;\n        $hasta = null;\n\n        if (!empty($filtros['desde'])) {\n            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n        }\n\n        if (!empty($filtros['hasta'])) {\n            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n        }\n\n        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n\n        return $consumos->map(function (ConsumoCredito $consumo) {\n            $servicio = $consumo->servicioIA?->nombre\n                ?? $consumo->nombre_servicio\n                ?? $consumo->ruta_endpoint;\n\n            return [\n                'usuario'        => $consumo->usuario ? [\n                    'id'              => $consumo->usuario->id,\n                    'nombre_completo' => $consumo->usuario->nombre_completo\n                ] : null,\n                'servicio'       => $servicio,\n                'creditos'       => $consumo->creditos ?? 0,\n                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n                'fecha_consumo'  => $consumo->created_at\n            ];\n        });\n    }\n}\n","numLines":271,"startLine":1,"totalLines":271}},"sourceToolAssistantUUID":"d8bcdbac-17fc-4795-84ec-b76213bc0ec0"}
{"parentUuid":"37f273a2-b694-482d-9f8c-d83f898ccadc","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WsmmBAhss4pVSmm9bjPvdu","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\IA;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\IA\\ServicioIA;\n     7→use App\\Models\\Pruebas\\TipoPrueba;\n     8→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n     9→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    10→\n    11→class CreditoIAService\n    12→{\n    13→    /**\n    14→     * Constructor.\n    15→     *\n    16→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios de IA.\n    17→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n    18→     * @return void\n    19→     * @author Sergio Vargas\n    20→     * @author Daniel Beltrán\n    21→     */\n    22→    public function __construct(\n    23→        private ServicioIARepository $servicio_ia_repositorio,\n    24→        private EmpresaPlanRepository $empresa_plan_repositorio\n    25→    ) {}\n    26→\n    27→    /**\n    28→     * Validar si hay créditos disponibles para un endpoint.\n    29→     *\n    30→     * @param ?int $empresa_plan_id ID del plan de empresa.\n    31→     * @param string $endpoint\n    32→     * @param ?int $empresa_id ID de la empresa.\n    33→     * @return array\n    34→     * @author Sergio Vargas\n    35→     * @author Daniel Beltrán\n    36→     */\n    37→    public function validarCreditosDisponibles(?int $empresa_plan_id, string $endpoint, ?int $empresa_id = null): array {\n    38→        $servicio             = $this->obtenerServicioPorEndpoint($endpoint);\n    39→        $creditos_necesarios  = $servicio?->consume_creditos ?? 0;\n    40→        $empresa_plan_id      = $this->resolverEmpresaPlanId($empresa_plan_id, $empresa_id);\n    41→        $creditos_disponibles = 0;\n    42→\n    43→        if ($empresa_plan_id) {\n    44→            $empresa_plan         = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n    45→            $creditos_disponibles = $empresa_plan?->creditos_restantes ?? 0;\n    46→        }\n    47→\n    48→        $datos_creditos = [\n    49→            'tiene_creditos'       => $creditos_disponibles >= $creditos_necesarios,\n    50→            'creditos_necesarios'  => $creditos_necesarios,\n    51→            'creditos_disponibles' => $creditos_disponibles,\n    52→            'servicio_ia_id'       => $servicio->id,\n    53→            'empresa_plan_id'      => $empresa_plan_id\n    54→        ];\n    55→\n    56→        if (!$servicio) {\n    57→            $datos_creditos['tiene_creditos']      = true;\n    58→            $datos_creditos['creditos_necesarios'] = 0;\n    59→            $datos_creditos['servicio_ia_id']      = null;\n    60→        }\n    61→\n    62→        if ($creditos_necesarios <= 0) {\n    63→            $datos_creditos['tiene_creditos']      = true;\n    64→            $datos_creditos['creditos_necesarios'] = 0;\n    65→        }\n    66→\n    67→        if (!$empresa_plan_id) {\n    68→            $datos_creditos['tiene_creditos'] = false;\n    69→        }\n    70→\n    71→        return $datos_creditos;\n    72→    }\n    73→\n    74→    /**\n    75→     * Obtener créditos configurados para un servicio.\n    76→     *\n    77→     * @param string $endpoint Endpoint.\n    78→     * @return ?int\n    79→     * @author Sergio Vargas\n    80→     * @author Daniel Beltrán\n    81→     */\n    82→    public function obtenerCreditosServicio(string $endpoint): ?int {\n    83→        $servicio = $this->obtenerServicioPorEndpoint($endpoint);\n    84→        return $servicio?->consume_creditos;\n    85→    }\n    86→\n    87→    /**\n    88→     * Preparar datos de consumo para el tracking.\n    89→     *\n    90→     * @param ?int $empresa_plan_id ID del plan de empresa.\n    91→     * @param string $endpoint Endpoint.\n    92→     * @param ?int $empresa_id ID de la empresa.\n    93→     * @return array\n    94→     * @author Sergio Vargas\n    95→     * @author Daniel Beltrán\n    96→     */\n    97→    public function prepararConsumo(?int $empresa_plan_id, string $endpoint, ?int $empresa_id = null): array {\n    98→        $servicio = $this->obtenerServicioPorEndpoint($endpoint);\n    99→\n   100→        return [\n   101→            'empresa_plan_id' => $this->resolverEmpresaPlanId($empresa_plan_id, $empresa_id),\n   102→            'servicio_ia_id'  => $servicio?->id,\n   103→            'creditos'        => $servicio?->consume_creditos ?? 0,\n   104→        ];\n   105→    }\n   106→\n   107→    /**\n   108→     * Resolver servicio IA por endpoint normalizado.\n   109→     *\n   110→     * @param string $endpoint Endpoint.\n   111→     * @return ?ServicioIA\n   112→     * @author Sergio Vargas\n   113→     * @author Daniel Beltrán\n   114→     */\n   115→    private function obtenerServicioPorEndpoint(string $endpoint): ?ServicioIA {\n   116→        $servicio = $this->servicio_ia_repositorio->getUnoAvanzado(new Request([\n   117→            'endpoint' => $this->normalizarEndpoint($endpoint)\n   118→        ]));\n   119→\n   120→        if ($servicio && !$servicio->activo) {\n   121→            return null;\n   122→        }\n   123→\n   124→        return $servicio;\n   125→    }\n   126→\n   127→    /**\n   128→     * Normalizar endpoint para búsqueda.\n   129→     *\n   130→     * @param string $endpoint Endpoint.\n   131→     * @return string\n   132→     * @author Sergio Vargas\n   133→     * @author Daniel Beltrán\n   134→     */\n   135→    private function normalizarEndpoint(string $endpoint): string {\n   136→        return preg_replace('/\\.(whisper|gpt)$/', '', trim($endpoint, '/'));\n   137→    }\n   138→\n   139→    /**\n   140→     * Resolver empresa_plan_id desde contexto.\n   141→     *\n   142→     * @param ?int $empresa_plan_id ID del plan de empresa.\n   143→     * @param ?int $empresa_id ID de la empresa.\n   144→     * @return ?int\n   145→     * @author Sergio Vargas\n   146→     * @author Daniel Beltrán\n   147→     */\n   148→    private function resolverEmpresaPlanId(?int $empresa_plan_id, ?int $empresa_id = null): ?int {\n   149→        if ($empresa_plan_id) {\n   150→            return $empresa_plan_id;\n   151→        }\n   152→\n   153→        if (!$empresa_id) {\n   154→            return null;\n   155→        }\n   156→\n   157→        $plan = $this->empresa_plan_repositorio->planActivo($empresa_id, TipoPrueba::SELECCION_ID);\n   158→\n   159→        return $plan?->id;\n   160→    }\n   161→}\n   162→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5f869404-efb6-444e-a76c-26a4129dc7e9","timestamp":"2026-01-21T15:02:31.348Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\CreditoIAService.php","content":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\IA\\ServicioIA;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse App\\Http\\Repositories\\IA\\ServicioIARepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\nclass CreditoIAService\n{\n    /**\n     * Constructor.\n     *\n     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios de IA.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private ServicioIARepository $servicio_ia_repositorio,\n        private EmpresaPlanRepository $empresa_plan_repositorio\n    ) {}\n\n    /**\n     * Validar si hay créditos disponibles para un endpoint.\n     *\n     * @param ?int $empresa_plan_id ID del plan de empresa.\n     * @param string $endpoint\n     * @param ?int $empresa_id ID de la empresa.\n     * @return array\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function validarCreditosDisponibles(?int $empresa_plan_id, string $endpoint, ?int $empresa_id = null): array {\n        $servicio             = $this->obtenerServicioPorEndpoint($endpoint);\n        $creditos_necesarios  = $servicio?->consume_creditos ?? 0;\n        $empresa_plan_id      = $this->resolverEmpresaPlanId($empresa_plan_id, $empresa_id);\n        $creditos_disponibles = 0;\n\n        if ($empresa_plan_id) {\n            $empresa_plan         = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n            $creditos_disponibles = $empresa_plan?->creditos_restantes ?? 0;\n        }\n\n        $datos_creditos = [\n            'tiene_creditos'       => $creditos_disponibles >= $creditos_necesarios,\n            'creditos_necesarios'  => $creditos_necesarios,\n            'creditos_disponibles' => $creditos_disponibles,\n            'servicio_ia_id'       => $servicio->id,\n            'empresa_plan_id'      => $empresa_plan_id\n        ];\n\n        if (!$servicio) {\n            $datos_creditos['tiene_creditos']      = true;\n            $datos_creditos['creditos_necesarios'] = 0;\n            $datos_creditos['servicio_ia_id']      = null;\n        }\n\n        if ($creditos_necesarios <= 0) {\n            $datos_creditos['tiene_creditos']      = true;\n            $datos_creditos['creditos_necesarios'] = 0;\n        }\n\n        if (!$empresa_plan_id) {\n            $datos_creditos['tiene_creditos'] = false;\n        }\n\n        return $datos_creditos;\n    }\n\n    /**\n     * Obtener créditos configurados para un servicio.\n     *\n     * @param string $endpoint Endpoint.\n     * @return ?int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function obtenerCreditosServicio(string $endpoint): ?int {\n        $servicio = $this->obtenerServicioPorEndpoint($endpoint);\n        return $servicio?->consume_creditos;\n    }\n\n    /**\n     * Preparar datos de consumo para el tracking.\n     *\n     * @param ?int $empresa_plan_id ID del plan de empresa.\n     * @param string $endpoint Endpoint.\n     * @param ?int $empresa_id ID de la empresa.\n     * @return array\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function prepararConsumo(?int $empresa_plan_id, string $endpoint, ?int $empresa_id = null): array {\n        $servicio = $this->obtenerServicioPorEndpoint($endpoint);\n\n        return [\n            'empresa_plan_id' => $this->resolverEmpresaPlanId($empresa_plan_id, $empresa_id),\n            'servicio_ia_id'  => $servicio?->id,\n            'creditos'        => $servicio?->consume_creditos ?? 0,\n        ];\n    }\n\n    /**\n     * Resolver servicio IA por endpoint normalizado.\n     *\n     * @param string $endpoint Endpoint.\n     * @return ?ServicioIA\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function obtenerServicioPorEndpoint(string $endpoint): ?ServicioIA {\n        $servicio = $this->servicio_ia_repositorio->getUnoAvanzado(new Request([\n            'endpoint' => $this->normalizarEndpoint($endpoint)\n        ]));\n\n        if ($servicio && !$servicio->activo) {\n            return null;\n        }\n\n        return $servicio;\n    }\n\n    /**\n     * Normalizar endpoint para búsqueda.\n     *\n     * @param string $endpoint Endpoint.\n     * @return string\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function normalizarEndpoint(string $endpoint): string {\n        return preg_replace('/\\.(whisper|gpt)$/', '', trim($endpoint, '/'));\n    }\n\n    /**\n     * Resolver empresa_plan_id desde contexto.\n     *\n     * @param ?int $empresa_plan_id ID del plan de empresa.\n     * @param ?int $empresa_id ID de la empresa.\n     * @return ?int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function resolverEmpresaPlanId(?int $empresa_plan_id, ?int $empresa_id = null): ?int {\n        if ($empresa_plan_id) {\n            return $empresa_plan_id;\n        }\n\n        if (!$empresa_id) {\n            return null;\n        }\n\n        $plan = $this->empresa_plan_repositorio->planActivo($empresa_id, TipoPrueba::SELECCION_ID);\n\n        return $plan?->id;\n    }\n}\n","numLines":162,"startLine":1,"totalLines":162}},"sourceToolAssistantUUID":"37f273a2-b694-482d-9f8c-d83f898ccadc"}
{"parentUuid":"35e96a2b-e789-4b8d-b299-4c05a80385f7","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TrfoggQyg2Q8HQhBnCgLvA","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use Illuminate\\Http\\Request;\n     8→use Illuminate\\Http\\JsonResponse;\n     9→use Illuminate\\Support\\Facades\\DB;\n    10→use App\\Http\\Controllers\\Controller;\n    11→use App\\Http\\Services\\IA\\ServicioIAService;\n    12→use App\\Http\\Services\\Planes\\PlanCreditoService;\n    13→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    14→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    15→\n    16→class PlanCreditoController extends Controller\n    17→{\n    18→    /**\n    19→     * Constructor.\n    20→     *\n    21→     * @param PlanCreditoService $servicio Servicio de planes de créditos.\n    22→     * @param PlanCreditoRepository $repositorio Repositorio de planes de créditos.\n    23→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    24→     * @param ServicioIAService $servicio_ia_servicio Servicio de servicios de IA.\n    25→     * @return void\n    26→     * @author Sergio Vargas\n    27→     * @author Daniel Beltrán\n    28→     */\n    29→    public function __construct(\n    30→        private PlanCreditoService $servicio,\n    31→        private PlanCreditoRepository $repositorio,\n    32→        private RutaRepository $ruta_repositorio,\n    33→        private ServicioIAService $servicio_ia_servicio\n    34→    ) {}\n    35→\n    36→    /**\n    37→     * Listar planes de créditos.\n    38→     *\n    39→     * @param Request $request Contenido de la petición.\n    40→     * @return JsonResponse\n    41→     * @author Sergio Vargas\n    42→     * @author Daniel Beltrán\n    43→     * @author Jair Carvajal\n    44→     */\n    45→    public function index(Request $request): JsonResponse {\n    46→        return new JsonResponse([\n    47→            'data' => [\n    48→                'planes'            => $this->servicio->getTodoCreditosPromedio($request),\n    49→                'creditos_promedio' => $this->servicio_ia_servicio->obtenerPromedioCreditos()\n    50→            ]\n    51→        ], JsonResponse::HTTP_OK);\n    52→    }\n    53→\n    54→    /**\n    55→     * Cargar la página para crear plan de créditos.\n    56→     *\n    57→     * @return View\n    58→     * @author Daniel Beltrán\n    59→     */\n    60→    public function create(): View {\n    61→        return view('planes.paginas.crear-plan-creditos')->with([\n    62→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    63→        ]);\n    64→    }\n    65→\n    66→    /**\n    67→     * Cargar la página para editar un plan de créditos.\n    68→     *\n    69→     * @param int $id ID del plan de créditos.\n    70→     * @return View\n    71→     * @author Daniel Beltrán\n    72→     */\n    73→    public function edit(int $id): View {\n    74→        return view('planes.paginas.crear-plan-creditos')->with([\n    75→            'plan'       => $this->servicio->getUno($id),\n    76→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    77→        ]);\n    78→    }\n    79→\n    80→    /**\n    81→     * Crear plan de créditos.\n    82→     *\n    83→     * @param Request $request Contenido de la petición.\n    84→     * @return JsonResponse\n    85→     * @author Sergio Vargas\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function store(Request $request): JsonResponse {\n    89→        $codigo    = JsonResponse::HTTP_CREATED;\n    90→        $respuesta = ['message' => 'Plan de créditos creado correctamente'];\n    91→\n    92→        try {\n    93→            DB::beginTransaction();\n    94→            $this->servicio->guardar($request);\n    95→            DB::commit();\n    96→        } catch (Exception $error) {\n    97→            DB::rollBack();\n    98→            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n    99→            $respuesta = [\n   100→                'message' => 'Ocurrio un error',\n   101→                'errors'  => $error->getMessage(),\n   102→            ];\n   103→        }\n   104→\n   105→        return new JsonResponse($respuesta, $codigo);\n   106→    }\n   107→\n   108→    /**\n   109→     * Actualizar plan de créditos.\n   110→     *\n   111→     * @param int $id ID del plan de créditos.\n   112→     * @param Request $request Contenido de la petición.\n   113→     * @return JsonResponse\n   114→     * @author Sergio Vargas\n   115→     * @author Daniel Beltrán\n   116→     */\n   117→    public function update(int $id, Request $request): JsonResponse {\n   118→        $codigo    = JsonResponse::HTTP_OK;\n   119→        $respuesta = ['message' => 'Plan de créditos actualizado correctamente'];\n   120→\n   121→        try {\n   122→            DB::beginTransaction();\n   123→            $request->merge(['id' => $id]);\n   124→            $this->servicio->guardar($request);\n   125→            DB::commit();\n   126→        } catch (Exception $error) {\n   127→            DB::rollBack();\n   128→            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n   129→            $respuesta = [\n   130→                'message' => 'Ocurrio un error',\n   131→                'errors'  => $error->getMessage(),\n   132→            ];\n   133→        }\n   134→\n   135→        return new JsonResponse($respuesta, $codigo);\n   136→    }\n   137→\n   138→    /**\n   139→     * Eliminar plan de creditos.\n   140→     *\n   141→     * @param int $id ID del plan de créditos.\n   142→     * @return JsonResponse\n   143→     * @author Sergio Vargas\n   144→     * @author Daniel Beltrán\n   145→     */\n   146→    public function destroy(int $id): JsonResponse {\n   147→        $codigo    = JsonResponse::HTTP_OK;\n   148→        $respuesta = ['message' => 'Plan de créditos eliminado correctamente'];\n   149→\n   150→        try {\n   151→            DB::beginTransaction();\n   152→            $this->repositorio->eliminar($id);\n   153→            DB::commit();\n   154→        } catch (Exception $error) {\n   155→            DB::rollBack();\n   156→            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n   157→            $respuesta = [\n   158→                'message' => 'Ocurrio un error',\n   159→                'errors'  => $error->getMessage(),\n   160→            ];\n   161→        }\n   162→\n   163→        return new JsonResponse($respuesta, $codigo);\n   164→    }\n   165→}\n   166→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e671a81b-c822-4499-aa6f-b194494916c6","timestamp":"2026-01-21T15:02:31.348Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php","content":"<?php\n\nnamespace App\\Http\\Controllers\\Planes;\n\nuse Exception;\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\JsonResponse;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Http\\Controllers\\Controller;\nuse App\\Http\\Services\\IA\\ServicioIAService;\nuse App\\Http\\Services\\Planes\\PlanCreditoService;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n\nclass PlanCreditoController extends Controller\n{\n    /**\n     * Constructor.\n     *\n     * @param PlanCreditoService $servicio Servicio de planes de créditos.\n     * @param PlanCreditoRepository $repositorio Repositorio de planes de créditos.\n     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n     * @param ServicioIAService $servicio_ia_servicio Servicio de servicios de IA.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private PlanCreditoService $servicio,\n        private PlanCreditoRepository $repositorio,\n        private RutaRepository $ruta_repositorio,\n        private ServicioIAService $servicio_ia_servicio\n    ) {}\n\n    /**\n     * Listar planes de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function index(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => [\n                'planes'            => $this->servicio->getTodoCreditosPromedio($request),\n                'creditos_promedio' => $this->servicio_ia_servicio->obtenerPromedioCreditos()\n            ]\n        ], JsonResponse::HTTP_OK);\n    }\n\n    /**\n     * Cargar la página para crear plan de créditos.\n     *\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function create(): View {\n        return view('planes.paginas.crear-plan-creditos')->with([\n            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Cargar la página para editar un plan de créditos.\n     *\n     * @param int $id ID del plan de créditos.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function edit(int $id): View {\n        return view('planes.paginas.crear-plan-creditos')->with([\n            'plan'       => $this->servicio->getUno($id),\n            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Crear plan de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function store(Request $request): JsonResponse {\n        $codigo    = JsonResponse::HTTP_CREATED;\n        $respuesta = ['message' => 'Plan de créditos creado correctamente'];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n            $respuesta = [\n                'message' => 'Ocurrio un error',\n                'errors'  => $error->getMessage(),\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar plan de créditos.\n     *\n     * @param int $id ID del plan de créditos.\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function update(int $id, Request $request): JsonResponse {\n        $codigo    = JsonResponse::HTTP_OK;\n        $respuesta = ['message' => 'Plan de créditos actualizado correctamente'];\n\n        try {\n            DB::beginTransaction();\n            $request->merge(['id' => $id]);\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n            $respuesta = [\n                'message' => 'Ocurrio un error',\n                'errors'  => $error->getMessage(),\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Eliminar plan de creditos.\n     *\n     * @param int $id ID del plan de créditos.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function destroy(int $id): JsonResponse {\n        $codigo    = JsonResponse::HTTP_OK;\n        $respuesta = ['message' => 'Plan de créditos eliminado correctamente'];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->eliminar($id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n            $respuesta = [\n                'message' => 'Ocurrio un error',\n                'errors'  => $error->getMessage(),\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n}\n","numLines":166,"startLine":1,"totalLines":166}},"sourceToolAssistantUUID":"35e96a2b-e789-4b8d-b299-4c05a80385f7"}
{"parentUuid":"e671a81b-c822-4499-aa6f-b194494916c6","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_018eMYrrvkr4X4LRyjziHAwc","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a buscar el controlador de planes normales y las rutas:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":10168,"cache_read_input_tokens":24312,"cache_creation":{"ephemeral_5m_input_tokens":10168,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj4Jqhsm57Knhbdcf1k","type":"assistant","uuid":"637f810e-1671-45e0-b273-3b3ddafb10ee","timestamp":"2026-01-21T15:02:34.530Z"}
{"parentUuid":"637f810e-1671-45e0-b273-3b3ddafb10ee","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_018eMYrrvkr4X4LRyjziHAwc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01STfuAEc3LjqY8ay3A2GWRA","name":"Glob","input":{"pattern":"**/app/Http/Controllers/Planes/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":10168,"cache_read_input_tokens":24312,"cache_creation":{"ephemeral_5m_input_tokens":10168,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj4Jqhsm57Knhbdcf1k","type":"assistant","uuid":"e420d13a-6b56-41e6-8748-3524864f564c","timestamp":"2026-01-21T15:02:36.601Z"}
{"parentUuid":"e420d13a-6b56-41e6-8748-3524864f564c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_018eMYrrvkr4X4LRyjziHAwc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NkYkN1Y9fiQpA9Gq3eJqqe","name":"Glob","input":{"pattern":"**/routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":10168,"cache_read_input_tokens":24312,"cache_creation":{"ephemeral_5m_input_tokens":10168,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj4Jqhsm57Knhbdcf1k","type":"assistant","uuid":"eb0a550b-8049-415d-818e-8503e93502f2","timestamp":"2026-01-21T15:02:36.697Z"}
{"parentUuid":"eb0a550b-8049-415d-818e-8503e93502f2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NkYkN1Y9fiQpA9Gq3eJqqe","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\vendor\\laravel\\passport\\routes\\web.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}]},"uuid":"793fa0eb-bb9b-4de7-bd77-fb0144bc6cf1","timestamp":"2026-01-21T15:02:43.497Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\channels.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\console.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\vendor\\laravel\\passport\\routes\\web.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"],"durationMs":4302,"numFiles":5,"truncated":false},"sourceToolAssistantUUID":"eb0a550b-8049-415d-818e-8503e93502f2"}
{"parentUuid":"e420d13a-6b56-41e6-8748-3524864f564c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01STfuAEc3LjqY8ay3A2GWRA","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ConsumoController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadPlanController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ModuloController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php"}]},"uuid":"9d5f2cf8-dc16-4ce6-8037-17c9df4480ad","timestamp":"2026-01-21T15:02:43.533Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ConsumoController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadPlanController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ModuloController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php"],"durationMs":4340,"numFiles":6,"truncated":false},"sourceToolAssistantUUID":"e420d13a-6b56-41e6-8748-3524864f564c"}
{"parentUuid":"9d5f2cf8-dc16-4ce6-8037-17c9df4480ad","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GWuvHg7yuZJFVAQ9eXn3aY","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a buscar migraciones y controladores relacionados con compra:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":162,"cache_creation_input_tokens":412,"cache_read_input_tokens":34480,"cache_creation":{"ephemeral_5m_input_tokens":412,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj57rSDHqKsMJtFLBQ2","type":"assistant","uuid":"0def97fa-21a3-4e57-a39b-08f3fda79b35","timestamp":"2026-01-21T15:02:46.415Z"}
{"parentUuid":"0def97fa-21a3-4e57-a39b-08f3fda79b35","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GWuvHg7yuZJFVAQ9eXn3aY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XmSALmbmX9Gi3haMKz5vwv","name":"Bash","input":{"command":"find \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" -type f -name \"*[Cc]ompra*\" -o -name \"*[Pp]agos*\" | head -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":162,"cache_creation_input_tokens":412,"cache_read_input_tokens":34480,"cache_creation":{"ephemeral_5m_input_tokens":412,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj57rSDHqKsMJtFLBQ2","type":"assistant","uuid":"0b92ed04-1fe0-4528-b94a-2bb69b9a48b5","timestamp":"2026-01-21T15:02:46.487Z"}
{"parentUuid":"0b92ed04-1fe0-4528-b94a-2bb69b9a48b5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GWuvHg7yuZJFVAQ9eXn3aY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JE3FxUsZiAqABmAbYrb3VE","name":"Grep","input":{"pattern":"plan_credito|PlanCredito|comprar.*credito","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","type":"php","head_limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":162,"cache_creation_input_tokens":412,"cache_read_input_tokens":34480,"cache_creation":{"ephemeral_5m_input_tokens":412,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj57rSDHqKsMJtFLBQ2","type":"assistant","uuid":"9ab316f6-8368-4bcd-bca2-5636b64dd5cf","timestamp":"2026-01-21T15:02:47.014Z"}
{"parentUuid":"9ab316f6-8368-4bcd-bca2-5636b64dd5cf","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JE3FxUsZiAqABmAbYrb3VE","type":"tool_result","content":"Found 14 files limit: 30, offset: 0\nroutes\\web.php\nroutes\\api.php\nresources\\views\\planes\\paginas\\crear-plan-creditos.blade.php\nresources\\views\\empresas\\paginas\\asignar-plan.blade.php\ndatabase\\seeders\\DatabaseSeeder.php\ndatabase\\seeders\\PlanCreditoSeeder.php\ndatabase\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php\napp\\Models\\Planes\\PlanCredito.php\napp\\Models\\Empresas\\EmpresaPlan.php\napp\\Http\\Services\\Planes\\PlanCreditoService.php\napp\\Http\\Services\\Empresas\\EmpresaPlanService.php\napp\\Http\\Repositories\\Planes\\PlanCreditoRepository.php\napp\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php\napp\\Http\\Controllers\\Planes\\PlanCreditoController.php"}]},"uuid":"961111b8-de39-4d3f-9aa4-115de4c1da92","timestamp":"2026-01-21T15:02:52.971Z","toolUseResult":{"mode":"files_with_matches","filenames":["routes\\web.php","routes\\api.php","resources\\views\\planes\\paginas\\crear-plan-creditos.blade.php","resources\\views\\empresas\\paginas\\asignar-plan.blade.php","database\\seeders\\DatabaseSeeder.php","database\\seeders\\PlanCreditoSeeder.php","database\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php","app\\Models\\Planes\\PlanCredito.php","app\\Models\\Empresas\\EmpresaPlan.php","app\\Http\\Services\\Planes\\PlanCreditoService.php","app\\Http\\Services\\Empresas\\EmpresaPlanService.php","app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php","app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","app\\Http\\Controllers\\Planes\\PlanCreditoController.php"],"numFiles":14,"appliedLimit":30},"sourceToolAssistantUUID":"9ab316f6-8368-4bcd-bca2-5636b64dd5cf"}
{"parentUuid":"961111b8-de39-4d3f-9aa4-115de4c1da92","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"progress","data":{"type":"bash_progress","output":"","fullOutput":"","elapsedTimeSeconds":2,"totalLines":0},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_01XmSALmbmX9Gi3haMKz5vwv","uuid":"64072142-a8d6-49ae-b5db-cbaa09d373ce","timestamp":"2026-01-21T15:02:55.268Z"}
{"parentUuid":"0b92ed04-1fe0-4528-b94a-2bb69b9a48b5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XmSALmbmX9Gi3haMKz5vwv","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2/.git/logs/refs/heads/D26-230-modal-comprar-mas-creditos\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/.git/logs/refs/remotes/origin/D26-230-modal-comprar-mas-creditos\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/.git/refs/heads/D26-230-modal-comprar-mas-creditos\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/.git/refs/remotes/origin/D26-230-modal-comprar-mas-creditos\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/public/js/empresa/planes/modal-recompras.js\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/resources/views/empresa/paginas/planes/modal-recompras.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/resources/views/excel/empresas/historial-recompras.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/venv/Lib/site-packages/pytz/zoneinfo/Pacific/Galapagos\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/venv/Lib/site-packages/tzdata/zoneinfo/Pacific/Galapagos","is_error":false}]},"uuid":"c0e65495-94b0-4607-b6aa-70c0478ae211","timestamp":"2026-01-21T15:02:55.887Z","toolUseResult":{"stdout":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2/.git/logs/refs/heads/D26-230-modal-comprar-mas-creditos\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/.git/logs/refs/remotes/origin/D26-230-modal-comprar-mas-creditos\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/.git/refs/heads/D26-230-modal-comprar-mas-creditos\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/.git/refs/remotes/origin/D26-230-modal-comprar-mas-creditos\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/public/js/empresa/planes/modal-recompras.js\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/resources/views/empresa/paginas/planes/modal-recompras.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/resources/views/excel/empresas/historial-recompras.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/venv/Lib/site-packages/pytz/zoneinfo/Pacific/Galapagos\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/venv/Lib/site-packages/tzdata/zoneinfo/Pacific/Galapagos\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"0b92ed04-1fe0-4528-b94a-2bb69b9a48b5"}
{"parentUuid":"c0e65495-94b0-4607-b6aa-70c0478ae211","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01ANSjryERZkSYNBf6MRL9PQ","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto, voy a revisar las rutas, migraciones y el servicio de EmpresaPlan:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":279,"cache_creation_input_tokens":1191,"cache_read_input_tokens":34892,"cache_creation":{"ephemeral_5m_input_tokens":1191,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj6GGEaZC6qXeyeNug4","type":"assistant","uuid":"dd20784b-90f8-4adf-b59e-f80d9e99937e","timestamp":"2026-01-21T15:03:00.697Z"}
{"parentUuid":"dd20784b-90f8-4adf-b59e-f80d9e99937e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01ANSjryERZkSYNBf6MRL9PQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BE6i7nEwJaoD2dApAXWw3Z","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":279,"cache_creation_input_tokens":1191,"cache_read_input_tokens":34892,"cache_creation":{"ephemeral_5m_input_tokens":1191,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj6GGEaZC6qXeyeNug4","type":"assistant","uuid":"a51aca36-6fba-4e91-a364-646caa1d9243","timestamp":"2026-01-21T15:03:01.804Z"}
{"parentUuid":"a51aca36-6fba-4e91-a364-646caa1d9243","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01ANSjryERZkSYNBf6MRL9PQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LjKEueKjQ9bUP71LNezpGN","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":279,"cache_creation_input_tokens":1191,"cache_read_input_tokens":34892,"cache_creation":{"ephemeral_5m_input_tokens":1191,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj6GGEaZC6qXeyeNug4","type":"assistant","uuid":"325ad4c0-ff84-4f94-bd28-982309635130","timestamp":"2026-01-21T15:03:02.200Z"}
{"parentUuid":"325ad4c0-ff84-4f94-bd28-982309635130","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01ANSjryERZkSYNBf6MRL9PQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013ti744kY5HZ8dfZrb1EzzV","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":279,"cache_creation_input_tokens":1191,"cache_read_input_tokens":34892,"cache_creation":{"ephemeral_5m_input_tokens":1191,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj6GGEaZC6qXeyeNug4","type":"assistant","uuid":"1c5e86c0-f9d1-4cfd-8667-9e75db707e30","timestamp":"2026-01-21T15:03:02.261Z"}
{"parentUuid":"325ad4c0-ff84-4f94-bd28-982309635130","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LjKEueKjQ9bUP71LNezpGN","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Facades\\Schema;\n     4→use Illuminate\\Database\\Schema\\Blueprint;\n     5→use Illuminate\\Database\\Migrations\\Migration;\n     6→\n     7→return new class extends Migration\n     8→{\n     9→    /**\n    10→     * Run the migrations.\n    11→     */\n    12→    public function up(): void {\n    13→        Schema::table('empresas_planes', function (Blueprint $table) {\n    14→            $table->foreignId('plan_credito_id')->nullable()->constrained('planes_creditos')->nullOnDelete()->after('plan_id');\n    15→            $table->integer('creditos')->default(0)->after('cantidad_pruebas')->comment('Cantidad de créditos iniciales');\n    16→        });\n    17→    }\n    18→\n    19→    /**\n    20→     * Reverse the migrations.\n    21→     */\n    22→    public function down(): void {\n    23→        Schema::table('empresas_planes', function (Blueprint $table) {\n    24→            $table->dropConstrainedForeignId('plan_credito_id');\n    25→            $table->dropColumn('creditos');\n    26→        });\n    27→    }\n    28→};\n    29→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"c41e55a4-a7ae-48ea-ade3-25f84f06012f","timestamp":"2026-01-21T15:03:06.072Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php","content":"<?php\n\nuse Illuminate\\Support\\Facades\\Schema;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Database\\Migrations\\Migration;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void {\n        Schema::table('empresas_planes', function (Blueprint $table) {\n            $table->foreignId('plan_credito_id')->nullable()->constrained('planes_creditos')->nullOnDelete()->after('plan_id');\n            $table->integer('creditos')->default(0)->after('cantidad_pruebas')->comment('Cantidad de créditos iniciales');\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void {\n        Schema::table('empresas_planes', function (Blueprint $table) {\n            $table->dropConstrainedForeignId('plan_credito_id');\n            $table->dropColumn('creditos');\n        });\n    }\n};\n","numLines":29,"startLine":1,"totalLines":29}},"sourceToolAssistantUUID":"325ad4c0-ff84-4f94-bd28-982309635130"}
{"parentUuid":"1c5e86c0-f9d1-4cfd-8667-9e75db707e30","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013ti744kY5HZ8dfZrb1EzzV","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Empresas;\n     4→\n     5→use Exception;\n     6→use Carbon\\Carbon;\n     7→use Illuminate\\Support\\Arr;\n     8→use App\\Traits\\ArchivoTrait;\n     9→use Illuminate\\Http\\Request;\n    10→use App\\Mail\\CrearUsuarioMail;\n    11→use Illuminate\\Http\\UploadedFile;\n    12→use App\\Http\\Services\\BaseService;\n    13→use Illuminate\\Support\\Collection;\n    14→use App\\Models\\Empresas\\EmpresaPlan;\n    15→use App\\Models\\Pruebas\\TipoPrueba;\n    16→use Illuminate\\Support\\Facades\\Notification;\n    17→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    18→use Illuminate\\Support\\Facades\\{Mail, Password};\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    21→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    22→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    23→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    24→use App\\Notifications\\SolicitudRenovacionPlanNotification;\n    25→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    26→use Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n    27→\n    28→/**\n    29→ * @property EmpresaPlanRepository $repositorio\n    30→ */\n    31→class EmpresaPlanService extends BaseService\n    32→{\n    33→    use ArchivoTrait;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n    39→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    40→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    41→     * @param PlanRepository $plan_repositorio Repositorio de planes.\n    42→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    43→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    44→     * @return void\n    45→     * @author Daniel Beltrán\n    46→     */\n    47→    public function __construct(\n    48→        EmpresaPlanRepository $repositorio,\n    49→        protected EmpresaRepository $empresa_repositorio,\n    50→        protected RolRepository $rol_repositorio,\n    51→        protected PlanRepository $plan_repositorio,\n    52→        protected PlanCreditoRepository $plan_credito_repositorio,\n    53→        protected ArchivoRepository $archivo_repositorio,\n    54→        protected UserRepository $usuario_repositorio\n    55→    ) {\n    56→        parent::__construct($repositorio);\n    57→    }\n    58→\n    59→    /**\n    60→     * Guardar un plan de empresa.\n    61→     *\n    62→     * @param Request $request Contenido de la petición.\n    63→     * @return EmpresaPlan\n    64→     * @author Sergio Vargas\n    65→     * @author Daniel Beltrán\n    66→     * @author Andres Morales\n    67→     * @author Jair Carvajal\n    68→     */\n    69→    public function guardar(Request $request): EmpresaPlan {\n    70→        $bandera_enviar_correo = false;\n    71→        $campos_excluidos      = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n    72→        $plan                  = $this->plan_repositorio->getUno($request->plan_id);\n    73→        $plan_activo           = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n    74→        $vigencia              = $plan->vigencia;\n    75→\n    76→        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n    77→            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n    78→\n    79→            if ($plan_credito) {\n    80→                $request->merge(['creditos' => $plan_credito->creditos]);\n    81→            }\n    82→        } elseif (!$request->filled('plan_credito_id')) {\n    83→            $request->merge([\n    84→                'plan_credito_id' => null,\n    85→                'creditos'        => null\n    86→            ]);\n    87→        }\n    88→\n    89→        if ($request->filled('vigencia')) {\n    90→            $vigencia = $request->vigencia;\n    91→        }\n    92→\n    93→        if (!is_null($plan_activo)) {\n    94→            if ($request->filled('id')) {\n    95→                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n    96→                if ($request->id === $plan_activo->id) {\n    97→                    goto omitir_calcular_vigencia;\n    98→                }\n    99→\n   100→                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n   101→                if ($vigencia == $request->vigencia) {\n   102→                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n   103→                    goto omitir_calcular_vigencia;\n   104→                }\n   105→            }\n   106→\n   107→            // Poner el nuevo plan como próximo\n   108→            $request->merge(['estado_id' => 3]);\n   109→\n   110→            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n   111→            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n   112→                // Agregar las nuevas fechas al nuevo plan\n   113→                $hoy          = now();\n   114→                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n   115→                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n   116→            }\n   117→        } else {\n   118→            $request->merge(['estado_id' => 1]);\n   119→\n   120→            // Validar si el plan seleccionado tiene vigencia\n   121→            if (!is_null($plan->vigencia)) {\n   122→                $request->merge($this->calcularFechasVigencia($vigencia));\n   123→            }\n   124→        }\n   125→\n   126→        omitir_calcular_vigencia:\n   127→\n   128→        if (!$request->filled('unidades')) {\n   129→            $request->merge(['unidades' => $plan->unidades]);\n   130→        } elseif ($request->unidades != $plan->unidades) {\n   131→            $request->merge(['plan_original' => false]);\n   132→        }\n   133→\n   134→        if (!$request->filled('cantidad_ofertas_laborales')) {\n   135→            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n   136→        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n   137→            $request->merge(['plan_original' => false]);\n   138→        }\n   139→\n   140→        if (!$request->filled('cantidad_usuarios')) {\n   141→            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n   142→        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n   143→            $request->merge(['plan_original' => false]);\n   144→        }\n   145→\n   146→        if (!$request->filled('cantidad_pruebas')) {\n   147→            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n   148→        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n   149→            $request->merge(['plan_original' => false]);\n   150→        }\n   151→\n   152→        // Comprobar si se modificaron las funcionalidades respecto al plan original\n   153→        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n   154→            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n   155→            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n   156→            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n   157→\n   158→            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n   159→                $request->merge(['plan_original' => false]);\n   160→            }\n   161→        }\n   162→\n   163→        if ($request->filled('id')) {\n   164→            // Eliminar la factura actual\n   165→            if ($request->hasFile('factura')) {\n   166→                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n   167→\n   168→                if (!is_null($archivo)) {\n   169→                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n   170→                    $this->archivo_repositorio->eliminar($archivo->id);\n   171→                }\n   172→            }\n   173→\n   174→            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n   175→        } else {\n   176→            $bandera_enviar_correo = true;\n   177→            $request->merge(['usuario_id' => auth()->user()->id]);\n   178→            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n   179→        }\n   180→\n   181→        if ($request->filled('pruebas')) {\n   182→            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n   183→        }\n   184→\n   185→        if ($request->filled('funcionalidades')) {\n   186→            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n   187→        }\n   188→\n   189→        // Guardar la factura\n   190→        if ($request->hasFile('factura')) {\n   191→            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n   192→        }\n   193→\n   194→        if ($bandera_enviar_correo) {\n   195→            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n   196→            $usuario      = $empresa->usuarios[0];\n   197→            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n   198→\n   199→            $titulo = 'Usuario principal de la empresa creado';\n   200→            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n   201→        }\n   202→\n   203→        return $plan_asignado;\n   204→    }\n   205→\n   206→    /**\n   207→     * Renovar el plan asignado.\n   208→     *\n   209→     * @param int $id ID del plan de la empresa que se quiere renovar.\n   210→     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n   211→     * @return EmpresaPlan Plan de la empresa renovado.\n   212→     * @author Daniel Beltrán\n   213→     */\n   214→    public function renovar(int $id): EmpresaPlan {\n   215→        $empresa_plan = $this->repositorio->getUno($id);\n   216→\n   217→        if ($empresa_plan->estado_id === 3) {\n   218→            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n   219→        }\n   220→\n   221→        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n   222→        $request->merge(['por_facturar' => true]);\n   223→\n   224→        if (in_array($empresa_plan->estado_id, [1, 4])) {\n   225→            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n   226→            $request->merge(['estado_id' => 3]);\n   227→        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n   228→            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n   229→            $request->merge(['estado_id' => 1]);\n   230→        }\n   231→\n   232→        $this->verificarYAsignarTiempo($empresa_plan, $request);\n   233→        $plan_renovado = $this->repositorio->crear($request->toArray());\n   234→\n   235→        if ($request->filled('pruebas')) {\n   236→            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n   237→        }\n   238→\n   239→        if ($request->filled('funcionalidades')) {\n   240→            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n   241→        }\n   242→\n   243→        return $plan_renovado;\n   244→    }\n   245→\n   246→    /**\n   247→     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n   248→     *\n   249→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   250→     * @param Request $request Contenido de la petición.\n   251→     * @return void\n   252→     * @author Daniel Beltrán\n   253→     */\n   254→    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n   255→        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n   256→            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n   257→        }\n   258→    }\n   259→\n   260→    /**\n   261→     * Calcular las fechas en las que el plan estará vigente.\n   262→     *\n   263→     * @param int $vigencia Cantidad de días de vigencia.\n   264→     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n   265→     * @return array Fechas de inicio y vencimiento.\n   266→     * @author Daniel Beltrán\n   267→     */\n   268→    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n   269→        $hoy          = now();\n   270→        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n   271→\n   272→        // Si es múltiplo de 3, entonces la vigencia es en meses\n   273→        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n   274→            $meses             = $vigencia / 30;\n   275→            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n   276→\n   277→            if ($fecha_inicio->day === 1) {\n   278→                $fecha_vencimiento->subDay();\n   279→            }\n   280→        } else {\n   281→            $vigencia          = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n   282→            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n   283→        }\n   284→\n   285→        return [\n   286→            'fecha_inicio'      => $fecha_inicio->format('Y-m-d'),\n   287→            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n   288→        ];\n   289→    }\n   290→\n   291→    /**\n   292→     * Facturar un plan de empresa.\n   293→     *\n   294→     * @param int $id ID del plan de empresa.\n   295→     * @param Request $request Contenido de la petición.\n   296→     * @return EmpresaPlan\n   297→     * @author Daniel Beltrán\n   298→     */\n   299→    public function facturar(int $id, Request $request): EmpresaPlan {\n   300→        $empresa_plan = $this->repositorio->getUno($id);\n   301→\n   302→        if ($request->filled('vigencia')) {\n   303→            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n   304→        }\n   305→\n   306→        $request->merge(['por_facturar' => false]);\n   307→\n   308→        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n   309→        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n   310→\n   311→        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n   312→        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n   313→    }\n   314→\n   315→    /**\n   316→     * Guardar factura.\n   317→     *\n   318→     * @param int $id ID del plan de empresa.\n   319→     * @param int $empresa_id ID de la empresa.\n   320→     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n   321→     * @return void\n   322→     * @author Daniel Beltrán\n   323→     */\n   324→    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n   325→        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n   326→        $this->generarDirectorios(\"app/{$ruta}\");\n   327→        $nombre_archivo = $this->generarNombreArchivo($archivo);\n   328→        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n   329→\n   330→        $this->archivo_repositorio->crear([\n   331→            'modelo'    => 'App\\Models\\Empresas\\EmpresaPlan',\n   332→            'modelo_id' => $id,\n   333→            'nombre'    => 'factura',\n   334→            'ruta'      => $ruta . '/' . $nombre_archivo\n   335→        ]);\n   336→    }\n   337→\n   338→    /**\n   339→     * Obtener el historial de recompras de una empresa por tipo de prueba.\n   340→     *\n   341→     * @param Request $request Contenido de la petición HTTP entrante.\n   342→     * @return Collection\n   343→     * @author Daniel Beltrán\n   344→     * @author Fahibram Cárcamo\n   345→     * @author Andres Morales\n   346→     * @author Andres Gonzalez\n   347→     */\n   348→    public function historialRecompras(Request $request): Collection {\n   349→        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n   350→        $request->merge([\n   351→            'con_conteo_consumos_agendas'           => true,\n   352→            'con_conteo_consumos_ofertas_laborales' => true\n   353→        ]);\n   354→\n   355→        return match ($rol_usuario->id) {\n   356→            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n   357→            RolRepository::ROL_PROPIETARIO_ID,\n   358→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   359→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   360→            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n   361→        };\n   362→    }\n   363→\n   364→    /**\n   365→     * Obtener el historial de compras de planes con creditos para una empresa.\n   366→     *\n   367→     * @param int $empresa_id ID de la empresa.\n   368→     * @param Request $request Contenido de la peticion.\n   369→     * @return Collection\n   370→     * @author Sergio Vargas\n   371→     */\n   372→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   373→        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n   374→\n   375→        return $historial->map(function (EmpresaPlan $plan) {\n   376→            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n   377→            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n   378→\n   379→            $plan->creditos_totales = $total_creditos;\n   380→            $plan->creditos_consumidos = $creditos_consumidos;\n   381→            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n   382→\n   383→            return $plan;\n   384→        });\n   385→    }\n   386→\n   387→    /**\n   388→     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n   389→     *\n   390→     * @param int $empresa_id ID de la empresa.\n   391→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   392→     * @return ?EmpresaPlan\n   393→     * @author Daniel Beltrán\n   394→     */\n   395→    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   396→        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n   397→            'empresa_id'             => $empresa_id,\n   398→            'tipo_prueba_id'         => $tipo_prueba_id,\n   399→            'excluir_estado_proximo' => true\n   400→        ]));\n   401→\n   402→        if (!is_null($plan)) {\n   403→            $plan_proximo       = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   404→            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n   405→        }\n   406→\n   407→        return $plan;\n   408→    }\n   409→\n   410→    /**\n   411→     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n   412→     *\n   413→     * @param int $id ID del plan de empresa.\n   414→     * @return ?EmpresaPlan\n   415→     * @author Daniel Beltrán\n   416→     */\n   417→    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n   418→        $plan               = $this->repositorio->getUno($id);\n   419→        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n   420→        return $plan;\n   421→    }\n   422→\n   423→    /**\n   424→     * Obtener el plan activo de la empresa por tipo de prueba.\n   425→     *\n   426→     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n   427→     * La propiedad se llama 'plan_proximo' y es un booleano.\n   428→     *\n   429→     * @param int $empresa_id ID de la empresa.\n   430→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   431→     * @return ?EmpresaPlan\n   432→     * @author Daniel Beltrán\n   433→     */\n   434→    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   435→        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   436→\n   437→        if (!is_null($plan)) {\n   438→            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n   439→        }\n   440→\n   441→        return $plan;\n   442→    }\n   443→\n   444→    /**\n   445→     * Solicitar la renovación de un plan específico de una empresa específica.\n   446→     *\n   447→     * @param Request $request Solicitud HTTP.\n   448→     * @return void\n   449→     * @author Fahibram Cárcamo\n   450→     */\n   451→    public function solicitarRenovacionPlan(Request $request) {\n   452→        $plan                = $this->plan_repositorio->getUno($request->plan_id);\n   453→        $empresa             = $this->empresa_repositorio->getUno($request->empresa_id);\n   454→        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n   455→\n   456→        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   457→            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n   458→            'con_roles_ids' => true\n   459→        ]));\n   460→\n   461→        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   462→            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n   463→            'empresa_id'    => $request->empresa_id,\n   464→            'con_roles_ids' => true\n   465→        ]));\n   466→\n   467→        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n   468→\n   469→        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n   470→    }\n   471→\n   472→    /**\n   473→     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n   474→     *\n   475→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   476→     * @return bool\n   477→     * @author Daniel Beltrán\n   478→     * @author Fahibram Cárcamo\n   479→     */\n   480→    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n   481→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   482→            return true;\n   483→        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n   484→            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n   485→                return true;\n   486→            }\n   487→        }\n   488→\n   489→        return false;\n   490→    }\n   491→\n   492→    /**\n   493→     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n   494→     *\n   495→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   496→     * @return bool\n   497→     * @author Daniel Beltrán\n   498→     * @author Fahibram Cárcamo\n   499→     */\n   500→    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   501→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   502→            return true;\n   503→        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n   504→            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n   505→                return true;\n   506→            }\n   507→        }\n   508→\n   509→        return false;\n   510→    }\n   511→\n   512→    /**\n   513→     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n   514→     *\n   515→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   516→     * @return bool\n   517→     * @author Fahibram Cárcamo\n   518→     */\n   519→    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n   520→        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n   521→    }\n   522→\n   523→    /**\n   524→     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n   525→     *\n   526→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   527→     * @return bool\n   528→     * @author Fahibram Cárcamo\n   529→     */\n   530→    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   531→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n   532→    }\n   533→\n   534→    /**\n   535→     * Verificar que la fecha de vencimiento del plan no haya pasado.\n   536→     *\n   537→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   538→     * @return bool\n   539→     * @author Andres Gonzalez\n   540→     */\n   541→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   542→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n   543→            return true;\n   544→        }\n   545→\n   546→        return false;\n   547→    }\n   548→\n   549→    /**\n   550→     * Verificar que el plan tenga vacantes disponibles.\n   551→     *\n   552→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   553→     * @return bool\n   554→     * @author Andres Gonzalez\n   555→     */\n   556→    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n   557→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n   558→    }\n   559→\n   560→    /**\n   561→     * Obtener creditos disponibles para un plan de empresa.\n   562→     *\n   563→     * @param int $empresa_plan_id ID del plan de empresa.\n   564→     * @return int\n   565→     * @author Sergio Vargas\n   566→     * @author Daniel Beltrán\n   567→     */\n   568→    public function creditosDisponibles(int $empresa_plan_id): int {\n   569→        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n   570→        return $empresa_plan?->creditos_restantes ?? 0;\n   571→    }\n   572→\n   573→    /**\n   574→     * Obtener creditos disponibles y plan asignado de una empresa.\n   575→     *\n   576→     * @param int $empresa_id ID de la empresa.\n   577→     * @param Request $request Contenido de la peticion.\n   578→     * @return array|null\n   579→     * @author Sergio Vargas\n   580→     */\n   581→    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n   582→        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n   583→            ? (int) $request->tipo_prueba_id\n   584→            : TipoPrueba::SELECCION_ID;\n   585→\n   586→        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   587→\n   588→        if (!$empresa_plan) {\n   589→            return null;\n   590→        }\n   591→\n   592→        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n   593→\n   594→        return [\n   595→            'empresa_id'           => $empresa_id,\n   596→            'empresa_plan_id'      => $empresa_plan->id,\n   597→            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n   598→            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n   599→            'plan_credito'         => $empresa_plan->planCredito ? [\n   600→                'id'       => $empresa_plan->planCredito->id,\n   601→                'nombre'   => $empresa_plan->planCredito->nombre,\n   602→                'creditos' => $empresa_plan->planCredito->creditos,\n   603→                'precio'   => $empresa_plan->planCredito->precio\n   604→            ] : null\n   605→        ];\n   606→    }\n   607→\n   608→    /**\n   609→     * Validar si hay creditos suficientes.\n   610→     *\n   611→     * @param int $empresa_plan_id ID del plan de empresa.\n   612→     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n   613→     * @return bool\n   614→     * @author Sergio Vargas\n   615→     * @author Daniel Beltrán\n   616→     */\n   617→    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n   618→        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n   619→    }\n   620→}\n   621→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"45f9b791-26c7-4629-a38d-3d5ed8b2055c","timestamp":"2026-01-21T15:03:06.272Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos      = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $plan                  = $this->plan_repositorio->getUno($request->plan_id);\n        $plan_activo           = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n        $vigencia              = $plan->vigencia;\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        } elseif (!$request->filled('plan_credito_id')) {\n            $request->merge([\n                'plan_credito_id' => null,\n                'creditos'        => null\n            ]);\n        }\n\n        if ($request->filled('vigencia')) {\n            $vigencia = $request->vigencia;\n        }\n\n        if (!is_null($plan_activo)) {\n            if ($request->filled('id')) {\n                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                if ($request->id === $plan_activo->id) {\n                    goto omitir_calcular_vigencia;\n                }\n\n                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                if ($vigencia == $request->vigencia) {\n                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                    goto omitir_calcular_vigencia;\n                }\n            }\n\n            // Poner el nuevo plan como próximo\n            $request->merge(['estado_id' => 3]);\n\n            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                // Agregar las nuevas fechas al nuevo plan\n                $hoy          = now();\n                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n            }\n        } else {\n            $request->merge(['estado_id' => 1]);\n\n            // Validar si el plan seleccionado tiene vigencia\n            if (!is_null($plan->vigencia)) {\n                $request->merge($this->calcularFechasVigencia($vigencia));\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$request->filled('unidades')) {\n            $request->merge(['unidades' => $plan->unidades]);\n        } elseif ($request->unidades != $plan->unidades) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_ofertas_laborales')) {\n            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_usuarios')) {\n            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_pruebas')) {\n            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        // Comprobar si se modificaron las funcionalidades respecto al plan original\n        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n\n            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                $request->merge(['plan_original' => false]);\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario      = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     *\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     *\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy          = now();\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses             = $vigencia / 30;\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia          = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio'      => $fecha_inicio->format('Y-m-d'),\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n        $this->generarDirectorios(\"app/{$ruta}\");\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo'    => 'App\\Models\\Empresas\\EmpresaPlan',\n            'modelo_id' => $id,\n            'nombre'    => 'factura',\n            'ruta'      => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n        $request->merge([\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n            $plan->creditos_consumidos = $creditos_consumidos;\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo       = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan               = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     *\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan                = $this->plan_repositorio->getUno($request->plan_id);\n        $empresa             = $this->empresa_repositorio->getUno($request->empresa_id);\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n            'empresa_id'    => $request->empresa_id,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","numLines":621,"startLine":1,"totalLines":621}},"sourceToolAssistantUUID":"1c5e86c0-f9d1-4cfd-8667-9e75db707e30"}
{"parentUuid":"a51aca36-6fba-4e91-a364-646caa1d9243","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BE6i7nEwJaoD2dApAXWw3Z","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Str;\n     4→use Illuminate\\Http\\Request;\n     5→use Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n     6→\n     7→Route::get('/', function () {\n     8→    return redirect()->route('login');\n     9→});\n    10→\n    11→Auth::routes(['register' => false]);\n    12→\n    13→// Rutas de acceso para aplicante.\n    14→Route::group([\n    15→    'prefix'    => 'control-acceso',\n    16→    'namespace' => 'App\\Http\\Controllers\\Auth'\n    17→], function ($ruta) {\n    18→    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    19→    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    20→    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n    21→});\n    22→\n    23→// Rutas de migración de usuarios desde la base de datos antigua.\n    24→Route::group([\n    25→    'prefix'    => 'migrar-usuario-app-antigua',\n    26→    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n    27→], function ($ruta) {\n    28→    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    29→    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n    30→});\n    31→\n    32→// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\n    33→Route::group([\n    34→    'prefix'     => 'rol-empresa',\n    35→    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    36→    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n    37→], function ($ruta) {\n    38→    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    39→    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n    40→});\n    41→\n    42→// Rutas protegidas por autenticación y selección de rol y empresa.\n    43→Route::group([\n    44→    'middleware' => ['auth', 'auth.rol-empresa'],\n    45→    'namespace'  => 'App\\Http\\Controllers'\n    46→], function ($ruta) {\n    47→    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n    48→\n    49→    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n    50→        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n    51→        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n    52→\n    53→        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n    54→            // Usuarios\n    55→            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n    56→            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n    57→            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n    58→            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n    59→            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n    60→            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n    61→            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n    62→            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n    63→            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n    64→            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n    65→            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n    66→            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n    67→            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n    68→            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n    69→\n    70→            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n    71→            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n    72→            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n    73→        });\n    74→    });\n    75→\n    76→    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n    77→        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n    78→            // Pruebas\n    79→            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n    80→            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n    81→            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n    82→            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n    83→            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n    84→            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n    85→            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n    86→            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n    87→        });\n    88→\n    89→        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n    90→            // Carga masiva de pruebas\n    91→            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n    92→            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n    93→            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n    94→            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n    95→        });\n    96→\n    97→        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n    98→            // Baremos\n    99→            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n   100→            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n   101→            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n   102→            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n   103→        });\n   104→\n   105→        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n   106→            // Dimensiones\n   107→            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n   108→            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n   109→            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n   110→            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n   111→            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n   112→        });\n   113→\n   114→        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n   115→            // Factores\n   116→            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n   117→            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n   118→            $ruta->resource('factores', 'Pruebas\\FactorController');\n   119→            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n   120→        });\n   121→\n   122→        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n   123→            // Reactivos\n   124→            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n   125→            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n   126→            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n   127→\n   128→            // Opciones\n   129→            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n   130→        });\n   131→\n   132→        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n   133→            // Calificaciones\n   134→            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n   135→            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n   136→            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n   137→        });\n   138→\n   139→        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n   140→            // Grupos de opciones\n   141→            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n   142→            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n   143→            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n   144→        });\n   145→\n   146→        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n   147→            // Secciones de texto\n   148→            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n   149→            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n   150→            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n   151→        });\n   152→\n   153→        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n   154→    });\n   155→\n   156→    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n   157→        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n   158→            // Perfiles\n   159→            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n   160→            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n   161→            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n   162→        });\n   163→\n   164→        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n   165→            // Módulos de preguntas\n   166→            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n   167→            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n   168→            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n   169→            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n   170→            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n   171→        });\n   172→\n   173→        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n   174→            // Demográficas\n   175→            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n   176→            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n   177→            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n   178→        });\n   179→    });\n   180→\n   181→    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n   182→        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n   183→            // Listado de empresas\n   184→            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n   185→            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n   186→            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n   187→            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n   188→            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n   189→            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n   190→            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n   191→            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n   192→            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n   193→            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n   194→            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n   195→            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n   196→            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n   197→            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n   198→            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n   199→        });\n   200→\n   201→        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n   202→            // Gestionar empresas\n   203→            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n   204→            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n   205→            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n   206→            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n   207→\n   208→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n   209→                // Usuarios\n   210→                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n   211→                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n   212→            });\n   213→\n   214→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n   215→                // Planes\n   216→                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n   217→                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n   218→            });\n   219→        });\n   220→\n   221→        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n   222→            // Archivo de empresas\n   223→            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n   224→            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n   225→            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n   226→        });\n   227→\n   228→        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n   229→            // Migración de empresas\n   230→            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n   231→            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n   232→            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n   233→            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n   234→        });\n   235→\n   236→        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n   237→            // Portales de empleo\n   238→            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   239→            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   240→            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n   241→            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n   242→\n   243→            // Premios destacados\n   244→            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n   245→            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n   246→\n   247→            // Motivadores\n   248→            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n   249→        });\n   250→\n   251→        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n   252→        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n   253→        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n   254→    });\n   255→\n   256→    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n   257→        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n   258→        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n   259→        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n   260→        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n   261→    });\n   262→\n   263→    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n   264→        // Planes\n   265→        $ruta->resource('planes', 'Planes\\PlanController');\n   266→        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n   267→        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n   268→        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n   269→        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n   270→        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n   271→        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n   272→        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n   273→        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n   274→        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n   275→        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n   276→        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n   277→        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n   278→        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n   279→        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n   280→        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n   281→\n   282→        // Planes de Créditos - Vista de creación\n   283→        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n   284→        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   285→\n   286→        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n   287→            // Consumos\n   288→            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n   289→            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n   290→            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n   291→            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n   292→            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n   293→            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n   294→            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n   295→            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n   296→            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n   297→            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n   298→            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n   299→            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n   300→        });\n   301→\n   302→        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n   303→            // Archivo\n   304→            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n   305→            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n   306→        });\n   307→    });\n   308→\n   309→    // Perfiles laborales\n   310→    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n   311→    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n   312→    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n   313→    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n   314→\n   315→    // Preguntas de ofertas laborales\n   316→    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n   317→    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n   318→    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n   319→    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n   320→    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n   321→    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n   322→\n   323→    // Preguntas de videoentrevista\n   324→    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n   325→    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n   326→    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n   327→    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n   328→\n   329→    // Vacantes\n   330→    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n   331→    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n   332→    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n   333→    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n   334→    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n   335→    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n   336→    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n   337→    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n   338→    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n   339→    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n   340→    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n   341→    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n   342→\n   343→    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n   344→\n   345→    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n   346→    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n   347→\n   348→    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n   349→        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n   350→            // Ajustes - General\n   351→            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n   352→        });\n   353→\n   354→        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n   355→            // Ajustes - Roles y permisos\n   356→            $ruta->get('roles', 'Auth\\RolController@index');\n   357→        });\n   358→\n   359→        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n   360→            // Ajustes - Deshacer acciones\n   361→            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n   362→            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n   363→            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n   364→            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n   365→        });\n   366→\n   367→        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n   368→            // Ajustes - Ofertas y anuncios\n   369→            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n   370→            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n   371→            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n   372→            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n   373→            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n   374→        });\n   375→\n   376→        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n   377→            // Webinars\n   378→            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n   379→            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n   380→            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n   381→            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n   382→            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n   383→            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n   384→\n   385→            // Eventos\n   386→            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n   387→            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n   388→            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n   389→            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n   390→            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n   391→            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n   392→\n   393→            // Guías\n   394→            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n   395→            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n   396→            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n   397→            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n   398→            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n   399→            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n   400→\n   401→            // Tutoriales\n   402→            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n   403→            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n   404→            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n   405→            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n   406→            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n   407→\n   408→            // Podcast\n   409→            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n   410→            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n   411→            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n   412→            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n   413→            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n   414→\n   415→            // Capacitación\n   416→            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n   417→            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n   418→            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n   419→            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n   420→            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n   421→\n   422→            // Certificación\n   423→            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n   424→            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n   425→            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n   426→            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n   427→            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n   428→            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n   429→        });\n   430→    });\n   431→\n   432→    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n   433→        // Soportes\n   434→        $ruta->resource('soportes', 'Soportes\\SoporteController');\n   435→        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n   436→        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n   437→        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n   438→        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n   439→        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n   440→        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n   441→        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n   442→        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n   443→        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n   444→\n   445→        // Manuales\n   446→        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n   447→        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n   448→\n   449→        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n   450→            // Aplicantes\n   451→            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n   452→        });\n   453→\n   454→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n   455→            // Preguntas frecuentes\n   456→            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n   457→            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n   458→            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n   459→            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n   460→            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n   461→        });\n   462→\n   463→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n   464→            // Preguntas frecuentes reacciónes\n   465→            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n   466→        });\n   467→    });\n   468→\n   469→    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n   470→    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n   471→    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n   472→\n   473→    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n   474→        // Módulos\n   475→        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n   476→        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n   477→\n   478→        // Auditorías\n   479→        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n   480→\n   481→        // Accesos\n   482→        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n   483→\n   484→        // Registros de actividad\n   485→        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n   486→\n   487→        // Novedades\n   488→        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n   489→        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n   490→        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n   491→\n   492→        // Países\n   493→        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n   494→        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n   495→        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n   496→        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n   497→        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n   498→\n   499→        // Reportes\n   500→        $ruta->resource('reportes', 'Reportes\\ReporteController');\n   501→        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n   502→        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n   503→\n   504→        // Minería de datos.\n   505→        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n   506→        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n   507→\n   508→        // Pruebas completas\n   509→        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n   510→        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n   511→        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n   512→        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n   513→        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n   514→    });\n   515→\n   516→    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n   517→        // Ordenes de servicio\n   518→        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n   519→        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n   520→        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n   521→\n   522→        // Ofertas laborales\n   523→        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n   524→        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n   525→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n   526→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n   527→        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n   528→        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n   529→        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n   530→        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n   531→        ->name('sin-disponibilidad-ofertas-laborales');\n   532→        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n   533→        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n   534→        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n   535→        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n   536→        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n   537→        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n   538→        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n   539→\n   540→        // Vacantes\n   541→        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n   542→        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n   543→\n   544→        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n   545→            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n   546→            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n   547→            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n   548→            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n   549→            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n   550→            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n   551→            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n   552→            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n   553→            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n   554→        });\n   555→\n   556→        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n   557→        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n   558→        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n   559→        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n   560→        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n   561→        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n   562→        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n   563→        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n   564→        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n   565→        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n   566→        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n   567→        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n   568→        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n   569→        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n   570→        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n   571→        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n   572→        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n   573→        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n   574→        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n   575→        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n   576→        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n   577→        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n   578→\n   579→        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n   580→        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n   581→        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n   582→\n   583→        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n   584→        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n   585→        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n   586→\n   587→        // Etapas\n   588→        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n   589→        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n   590→        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n   591→        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n   592→        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n   593→        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n   594→\n   595→        // Movimientos\n   596→        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n   597→        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n   598→        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n   599→        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n   600→\n   601→        // Novedades\n   602→        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n   603→\n   604→        $ruta->get('feedback', 'DashboardController@enConstruccion');\n   605→        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n   606→\n   607→        // Procesos\n   608→        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n   609→        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n   610→        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n   611→        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n   612→        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n   613→        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n   614→        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n   615→        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n   616→        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n   617→        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n   618→        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n   619→        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n   620→        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n   621→        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n   622→        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n   623→        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n   624→        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n   625→        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n   626→        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n   627→        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n   628→        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n   629→        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n   630→        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n   631→        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n   632→        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n   633→        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n   634→        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n   635→        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n   636→        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n   637→        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n   638→        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n   639→        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n   640→\n   641→        // Firmas de rutas\n   642→        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n   643→\n   644→        // Perfiles pruebas\n   645→        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n   646→\n   647→        // Agendas\n   648→        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n   649→        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n   650→        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n   651→        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n   652→\n   653→        // Comentarios\n   654→        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n   655→\n   656→        // Usuarios\n   657→        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n   658→    });\n   659→\n   660→    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n   661→        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n   662→\n   663→        // Debug de calificaciones de agendas\n   664→        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n   665→        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n   666→        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n   667→        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n   668→    });\n   669→\n   670→    // Suplantación de rol Administrador general\n   671→    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n   672→        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n   673→    });\n   674→\n   675→    // Suplantación de rol Administrador sucursal\n   676→    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n   677→        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n   678→    });\n   679→\n   680→    // Restablecimiento de la sesión original que había antes de la suplantación\n   681→    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n   682→        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n   683→    });\n   684→\n   685→    // Ruta para completar los datos de un usuario aplicante\n   686→    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n   687→        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n   688→        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n   689→        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n   690→        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n   691→    });\n   692→\n   693→    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n   694→    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n   695→        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n   696→        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n   697→        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n   698→        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n   699→        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n   700→        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n   701→        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n   702→        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n   703→        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n   704→        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n   705→        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n   706→        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n   707→        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n   708→        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n   709→        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n   710→        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n   711→        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n   712→        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n   713→        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n   714→        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   715→        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n   716→            ->name('ofertas-laborales.detalles-aplicante');\n   717→        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   718→        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n   719→\n   720→        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n   721→    });\n   722→\n   723→    // Ofertas laborales\n   724→    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n   725→\n   726→    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n   727→    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n   728→    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n   729→    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n   730→    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n   731→    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n   732→    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n   733→\n   734→    // Usuarios\n   735→    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n   736→    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n   737→\n   738→    // Perfiles\n   739→    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n   740→    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n   741→    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n   742→    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n   743→    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n   744→\n   745→    // Archivos\n   746→    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n   747→    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n   748→    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n   749→\n   750→    // Menú clientes\n   751→    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n   752→    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n   753→    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n   754→\n   755→    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n   756→    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n   757→    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n   758→    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n   759→    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n   760→\n   761→    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n   762→    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n   763→    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n   764→    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n   765→    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n   766→    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n   767→    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n   768→    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n   769→    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n   770→\n   771→    // Agendas - Accesible para aplicantes y usuarios de empresa\n   772→    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n   773→\n   774→    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n   775→    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n   776→    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n   777→    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n   778→    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n   779→\n   780→    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n   781→    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n   782→\n   783→    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n   784→    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n   785→    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n   786→\n   787→    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n   788→    $ruta->get('novedades', 'DashboardController@enConstruccion');\n   789→\n   790→    // Áreas\n   791→    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n   792→    $ruta->post('areas', 'Empresas\\AreaController@store');\n   793→\n   794→    // Cargos\n   795→    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n   796→    $ruta->post('cargos', 'Empresas\\CargoController@store');\n   797→\n   798→    // Niveles educativos\n   799→    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n   800→\n   801→    // Áreas de estudio\n   802→    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n   803→\n   804→    // Idiomas\n   805→    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n   806→\n   807→    // Autenticación del websoket\n   808→    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n   809→\n   810→    $ruta->get('/botones', function () {\n   811→        return view('botones');\n   812→    })->name('botones');\n   813→\n   814→    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n   815→    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n   816→    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n   817→\n   818→    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n   819→    $ruta->get('analiticas', 'DashboardController@index');\n   820→    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n   821→    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n   822→    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n   823→    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n   824→    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n   825→\n   826→    // Rutas de componentes de desarrollo\n   827→    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n   828→    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n   829→\n   830→    // TODO: ruta de prueba, eliminarla próximamente\n   831→    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n   832→    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n   833→    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n   834→    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n   835→    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n   836→\n   837→    // Rutas para las encuestas\n   838→    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n   839→    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n   840→});\n   841→\n   842→// Rutas no protegidas por autenticación\n   843→Route::group([\n   844→    'namespace' => 'App\\Http\\Controllers'\n   845→], function ($ruta) {\n   846→    // Contraseñas\n   847→    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n   848→\n   849→    // Empresas\n   850→    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n   851→    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n   852→    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n   853→    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n   854→    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n   855→\n   856→    // Ordenes de servicio\n   857→    $ruta->group([\n   858→        'middleware' => 'orden-servicio-enlace-publico'\n   859→    ], function ($ruta) {\n   860→        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n   861→        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n   862→    });\n   863→\n   864→    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n   865→\n   866→    // Países\n   867→    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n   868→    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n   869→\n   870→    // Departamentos\n   871→    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n   872→\n   873→    // Ciudades\n   874→    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n   875→\n   876→    // Portales de empleo\n   877→    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n   878→    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n   879→    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n   880→    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n   881→    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n   882→    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n   883→    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n   884→\n   885→    // Firmas de rutas\n   886→    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n   887→    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n   888→    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n   889→    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n   890→\n   891→    // Archivos\n   892→    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n   893→\n   894→    // Imagen de usuarios\n   895→    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n   896→\n   897→    // Consultar reportes con firma\n   898→    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n   899→});\n   900→\n   901→/**\n   902→ * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n   903→ *\n   904→ * @author Fahibram Cárcamo\n   905→ */\n   906→Route::group([\n   907→    'prefix'     => 'rutas-firmadas',\n   908→    'middleware' => ['ruta-firmada'],\n   909→    'namespace'  => 'App\\Http\\Controllers'\n   910→], function ($ruta) {\n   911→    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n   912→    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n   913→});\n   914→\n   915→/**\n   916→ * Genera un token SSO firmado y redirige a WordPress.\n   917→ *\n   918→ * Flujo:\n   919→ *  - Requiere un usuario autenticado (será el admin en WP).\n   920→ *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n   921→ *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n   922→ *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n   923→ *  - Redirige al callback configurado en WordPress.\n   924→ *\n   925→ * @author Sergio Vargas\n   926→ */\n   927→Route::get('/sso/wordpress', function (Request $request) {\n   928→    $user = $request->user();\n   929→\n   930→    $studentId   = $request->input('student_id');\n   931→    $studentData = null;\n   932→\n   933→    if ($studentId) {\n   934→        $student = App\\Models\\Usuarios\\User::find($studentId);\n   935→\n   936→        if ($student && $student->id !== $user->id) {\n   937→            $studentData = [\n   938→                'id'    => (string) $student->id,\n   939→                'email' => $student->email,\n   940→                'name'  => $student->getNombreCompletoAttribute(),\n   941→            ];\n   942→        }\n   943→    }\n   944→\n   945→    $nonce = (string) Str::uuid();\n   946→    $exp   = now()->addSeconds(60)->timestamp;\n   947→\n   948→    Cache::put(\"sso_nonce:{$nonce}\", [\n   949→        'user_id' => $user->id,\n   950→        'exp'     => $exp,\n   951→    ], now()->addMinutes(5));\n   952→\n   953→    $payload = [\n   954→        'sub'     => (string) $user->id,\n   955→        'email'   => $user->email,\n   956→        'name'    => $user->getNombreCompletoAttribute(),\n   957→        'nonce'   => $nonce,\n   958→        'exp'     => $exp,\n   959→        'student' => $studentData,\n   960→    ];\n   961→\n   962→    $token    = sso_sign_token($payload, config('services.sso.secret'));\n   963→    $wp       = rtrim(config('services.sso.wp_url'), '/');\n   964→    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n   965→    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n   966→\n   967→    return redirect()->away(\n   968→        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n   969→    );\n   970→})->middleware('auth');\n   971→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b6de690f-6c17-4645-b7f6-3deb66be2262","timestamp":"2026-01-21T15:03:06.298Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","content":"<?php\n\nuse Illuminate\\Support\\Str;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n\nRoute::get('/', function () {\n    return redirect()->route('login');\n});\n\nAuth::routes(['register' => false]);\n\n// Rutas de acceso para aplicante.\nRoute::group([\n    'prefix'    => 'control-acceso',\n    'namespace' => 'App\\Http\\Controllers\\Auth'\n], function ($ruta) {\n    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n});\n\n// Rutas de migración de usuarios desde la base de datos antigua.\nRoute::group([\n    'prefix'    => 'migrar-usuario-app-antigua',\n    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n], function ($ruta) {\n    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n});\n\n// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\nRoute::group([\n    'prefix'     => 'rol-empresa',\n    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n], function ($ruta) {\n    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n});\n\n// Rutas protegidas por autenticación y selección de rol y empresa.\nRoute::group([\n    'middleware' => ['auth', 'auth.rol-empresa'],\n    'namespace'  => 'App\\Http\\Controllers'\n], function ($ruta) {\n    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n\n    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n\n        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n            // Usuarios\n            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n\n            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n            // Pruebas\n            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n            // Carga masiva de pruebas\n            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n            // Baremos\n            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n            // Dimensiones\n            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n            // Factores\n            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n            $ruta->resource('factores', 'Pruebas\\FactorController');\n            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n            // Reactivos\n            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n\n            // Opciones\n            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n            // Calificaciones\n            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n            // Grupos de opciones\n            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n            // Secciones de texto\n            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n        });\n\n        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n    });\n\n    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n            // Perfiles\n            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n        });\n\n        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n            // Módulos de preguntas\n            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n        });\n\n        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n            // Demográficas\n            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n            // Listado de empresas\n            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n            // Gestionar empresas\n            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n\n            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n                // Usuarios\n                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n            });\n\n            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n                // Planes\n                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n            });\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n            // Archivo de empresas\n            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n            // Migración de empresas\n            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n            // Portales de empleo\n            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n\n            // Premios destacados\n            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n\n            // Motivadores\n            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n        });\n\n        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n    });\n\n    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n    });\n\n    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n        // Planes\n        $ruta->resource('planes', 'Planes\\PlanController');\n        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n\n        // Planes de Créditos - Vista de creación\n        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n\n        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n            // Consumos\n            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n        });\n\n        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n            // Archivo\n            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n        });\n    });\n\n    // Perfiles laborales\n    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n\n    // Preguntas de ofertas laborales\n    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n\n    // Preguntas de videoentrevista\n    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n\n    // Vacantes\n    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n\n    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n\n    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n\n    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n            // Ajustes - General\n            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n            // Ajustes - Roles y permisos\n            $ruta->get('roles', 'Auth\\RolController@index');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n            // Ajustes - Deshacer acciones\n            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n            // Ajustes - Ofertas y anuncios\n            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n            // Webinars\n            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n\n            // Eventos\n            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n\n            // Guías\n            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n\n            // Tutoriales\n            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n\n            // Podcast\n            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n\n            // Capacitación\n            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n\n            // Certificación\n            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n        // Soportes\n        $ruta->resource('soportes', 'Soportes\\SoporteController');\n        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n\n        // Manuales\n        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n\n        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n            // Aplicantes\n            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n        });\n\n        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n            // Preguntas frecuentes\n            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n        });\n\n        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n            // Preguntas frecuentes reacciónes\n            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n        });\n    });\n\n    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n\n    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n        // Módulos\n        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n\n        // Auditorías\n        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n\n        // Accesos\n        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n\n        // Registros de actividad\n        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n\n        // Novedades\n        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n\n        // Países\n        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n\n        // Reportes\n        $ruta->resource('reportes', 'Reportes\\ReporteController');\n        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n\n        // Minería de datos.\n        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n\n        // Pruebas completas\n        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n    });\n\n    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n        // Ordenes de servicio\n        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n\n        // Ofertas laborales\n        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n        ->name('sin-disponibilidad-ofertas-laborales');\n        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n\n        // Vacantes\n        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n\n        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n        });\n\n        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n\n        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n\n        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n\n        // Etapas\n        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n\n        // Movimientos\n        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n\n        // Novedades\n        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n\n        $ruta->get('feedback', 'DashboardController@enConstruccion');\n        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n\n        // Procesos\n        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n\n        // Firmas de rutas\n        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n\n        // Perfiles pruebas\n        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n\n        // Agendas\n        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n\n        // Comentarios\n        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n\n        // Usuarios\n        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n    });\n\n    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n\n        // Debug de calificaciones de agendas\n        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n    });\n\n    // Suplantación de rol Administrador general\n    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n    });\n\n    // Suplantación de rol Administrador sucursal\n    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n    });\n\n    // Restablecimiento de la sesión original que había antes de la suplantación\n    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n    });\n\n    // Ruta para completar los datos de un usuario aplicante\n    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n    });\n\n    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n            ->name('ofertas-laborales.detalles-aplicante');\n        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n\n        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n    });\n\n    // Ofertas laborales\n    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n\n    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n\n    // Usuarios\n    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n\n    // Perfiles\n    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n\n    // Archivos\n    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n\n    // Menú clientes\n    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n\n    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n\n    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n\n    // Agendas - Accesible para aplicantes y usuarios de empresa\n    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n\n    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n\n    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n\n    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n\n    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n    $ruta->get('novedades', 'DashboardController@enConstruccion');\n\n    // Áreas\n    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n    $ruta->post('areas', 'Empresas\\AreaController@store');\n\n    // Cargos\n    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n    $ruta->post('cargos', 'Empresas\\CargoController@store');\n\n    // Niveles educativos\n    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n\n    // Áreas de estudio\n    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n\n    // Idiomas\n    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n\n    // Autenticación del websoket\n    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n\n    $ruta->get('/botones', function () {\n        return view('botones');\n    })->name('botones');\n\n    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n\n    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n    $ruta->get('analiticas', 'DashboardController@index');\n    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n\n    // Rutas de componentes de desarrollo\n    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n\n    // TODO: ruta de prueba, eliminarla próximamente\n    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n\n    // Rutas para las encuestas\n    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n});\n\n// Rutas no protegidas por autenticación\nRoute::group([\n    'namespace' => 'App\\Http\\Controllers'\n], function ($ruta) {\n    // Contraseñas\n    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n\n    // Empresas\n    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n\n    // Ordenes de servicio\n    $ruta->group([\n        'middleware' => 'orden-servicio-enlace-publico'\n    ], function ($ruta) {\n        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n    });\n\n    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n\n    // Países\n    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n\n    // Departamentos\n    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n\n    // Ciudades\n    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n\n    // Portales de empleo\n    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n\n    // Firmas de rutas\n    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n\n    // Archivos\n    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n\n    // Imagen de usuarios\n    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n\n    // Consultar reportes con firma\n    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n});\n\n/**\n * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n *\n * @author Fahibram Cárcamo\n */\nRoute::group([\n    'prefix'     => 'rutas-firmadas',\n    'middleware' => ['ruta-firmada'],\n    'namespace'  => 'App\\Http\\Controllers'\n], function ($ruta) {\n    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n});\n\n/**\n * Genera un token SSO firmado y redirige a WordPress.\n *\n * Flujo:\n *  - Requiere un usuario autenticado (será el admin en WP).\n *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n *  - Redirige al callback configurado en WordPress.\n *\n * @author Sergio Vargas\n */\nRoute::get('/sso/wordpress', function (Request $request) {\n    $user = $request->user();\n\n    $studentId   = $request->input('student_id');\n    $studentData = null;\n\n    if ($studentId) {\n        $student = App\\Models\\Usuarios\\User::find($studentId);\n\n        if ($student && $student->id !== $user->id) {\n            $studentData = [\n                'id'    => (string) $student->id,\n                'email' => $student->email,\n                'name'  => $student->getNombreCompletoAttribute(),\n            ];\n        }\n    }\n\n    $nonce = (string) Str::uuid();\n    $exp   = now()->addSeconds(60)->timestamp;\n\n    Cache::put(\"sso_nonce:{$nonce}\", [\n        'user_id' => $user->id,\n        'exp'     => $exp,\n    ], now()->addMinutes(5));\n\n    $payload = [\n        'sub'     => (string) $user->id,\n        'email'   => $user->email,\n        'name'    => $user->getNombreCompletoAttribute(),\n        'nonce'   => $nonce,\n        'exp'     => $exp,\n        'student' => $studentData,\n    ];\n\n    $token    = sso_sign_token($payload, config('services.sso.secret'));\n    $wp       = rtrim(config('services.sso.wp_url'), '/');\n    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n\n    return redirect()->away(\n        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n    );\n})->middleware('auth');\n","numLines":971,"startLine":1,"totalLines":971}},"sourceToolAssistantUUID":"a51aca36-6fba-4e91-a364-646caa1d9243"}
{"parentUuid":"b6de690f-6c17-4645-b7f6-3deb66be2262","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0184PBb6qBQLpvdwqLVpaMhk","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a revisar los repositorios para entender mejor la consulta de créditos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10183,"cache_creation_input_tokens":27126,"cache_read_input_tokens":36083,"cache_creation":{"ephemeral_5m_input_tokens":27126,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj6zwWswPNjVQLPgPRC","type":"assistant","uuid":"0ac64ed1-1def-4439-a5a2-c469b430d90b","timestamp":"2026-01-21T15:03:12.143Z"}
{"parentUuid":"0ac64ed1-1def-4439-a5a2-c469b430d90b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0184PBb6qBQLpvdwqLVpaMhk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DSvGQPNXJMASBK5zqHT1ky","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10183,"cache_creation_input_tokens":27126,"cache_read_input_tokens":36083,"cache_creation":{"ephemeral_5m_input_tokens":27126,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj6zwWswPNjVQLPgPRC","type":"assistant","uuid":"cac4dee8-fafe-4113-b710-cdff5595549d","timestamp":"2026-01-21T15:03:13.123Z"}
{"parentUuid":"cac4dee8-fafe-4113-b710-cdff5595549d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0184PBb6qBQLpvdwqLVpaMhk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XLxjVoneKf89QbNLnkd5zB","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php","limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10183,"cache_creation_input_tokens":27126,"cache_read_input_tokens":36083,"cache_creation":{"ephemeral_5m_input_tokens":27126,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj6zwWswPNjVQLPgPRC","type":"assistant","uuid":"a168c1c1-fb23-4a98-8f25-6ca001c68f9c","timestamp":"2026-01-21T15:03:13.199Z"}
{"parentUuid":"a168c1c1-fb23-4a98-8f25-6ca001c68f9c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0184PBb6qBQLpvdwqLVpaMhk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JKPa82VYNW8877fA6Mfvb1","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10183,"cache_creation_input_tokens":27126,"cache_read_input_tokens":36083,"cache_creation":{"ephemeral_5m_input_tokens":27126,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj6zwWswPNjVQLPgPRC","type":"assistant","uuid":"f68b4b76-bfdc-491f-99ce-1bfaf5c52ce8","timestamp":"2026-01-21T15:03:13.271Z"}
{"parentUuid":"cac4dee8-fafe-4113-b710-cdff5595549d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DSvGQPNXJMASBK5zqHT1ky","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\Empresas;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\Pruebas\\TipoPrueba;\n     7→use Illuminate\\Support\\Collection;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use App\\Http\\Repositories\\BaseRepository;\n    11→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    12→use App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n    13→\n    14→class EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n    15→{\n    16→    /**\n    17→     * Ids de los roles de tipo empresa.\n    18→     *\n    19→     * @var array\n    20→     * @author Fahibram Cárcamo\n    21→     */\n    22→    private const IDS_ROLES_TIPO_EMPRESA = [\n    23→        RolRepository::ROL_PROPIETARIO_ID,\n    24→        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n    25→        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n    26→        RolRepository::ROL_EVALUADOR_ID\n    27→    ];\n    28→\n    29→    private $consulta_conteo_total_usuarios_empresa_sucursales;\n    30→\n    31→    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n    32→\n    33→    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n    39→     * @return void\n    40→     * @author Daniel Beltrán\n    41→     * @author Fahibram Cárcamo\n    42→     */\n    43→    public function __construct(EmpresaPlan $modelo) {\n    44→        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n    45→            (\n    46→                SELECT COUNT(DISTINCT eu.usuario_id)\n    47→                FROM empresas_usuarios AS eu\n    48→                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n    49→                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n    50→                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n    51→            ) AS conteo_total_usuarios_empresa_sucursales\n    52→        ';\n    53→\n    54→        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n    55→            (\n    56→                SELECT COUNT(*)\n    57→                FROM consumos\n    58→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    59→                WHERE (\n    60→                    consumos.empresa_id = empresas_planes.empresa_id\n    61→                    OR suc.empresa_id = empresas_planes.empresa_id\n    62→                )\n    63→                AND consumos.agenda_id IS NOT NULL\n    64→            ) AS conteo_total_consumos_agendas_empresa_sucursales\n    65→        ';\n    66→\n    67→        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n    68→            (\n    69→                SELECT COUNT(*)\n    70→                FROM consumos\n    71→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    72→                WHERE (\n    73→                    consumos.empresa_id = empresas_planes.empresa_id\n    74→                    OR suc.empresa_id = empresas_planes.empresa_id\n    75→                )\n    76→                AND consumos.oferta_laboral_id IS NOT NULL\n    77→            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n    78→        ';\n    79→\n    80→        parent::__construct($modelo);\n    81→    }\n    82→\n    83→    /**\n    84→     * Obtener todos los planes de empresas.\n    85→     *\n    86→     * @param Request $request Contenido de la petición.\n    87→     * @return Collection\n    88→     * @author Daniel Beltrán\n    89→     * @author Fahibram Cárcamo\n    90→     * @author Jair Carvajal\n    91→     */\n    92→    public function getTodo(Request $request): Collection {\n    93→        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n    94→            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    95→        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n    96→            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n    97→        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n    98→            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    99→        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n   100→            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"43e80488-3003-4aa7-8ae5-bec01e28d189","timestamp":"2026-01-21T15:03:16.645Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","content":"<?php\n\nnamespace App\\Http\\Repositories\\Empresas;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Repositories\\BaseRepository;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n\nclass EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n{\n    /**\n     * Ids de los roles de tipo empresa.\n     *\n     * @var array\n     * @author Fahibram Cárcamo\n     */\n    private const IDS_ROLES_TIPO_EMPRESA = [\n        RolRepository::ROL_PROPIETARIO_ID,\n        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n        RolRepository::ROL_EVALUADOR_ID\n    ];\n\n    private $consulta_conteo_total_usuarios_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(EmpresaPlan $modelo) {\n        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n            (\n                SELECT COUNT(DISTINCT eu.usuario_id)\n                FROM empresas_usuarios AS eu\n                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n            ) AS conteo_total_usuarios_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.agenda_id IS NOT NULL\n            ) AS conteo_total_consumos_agendas_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.oferta_laboral_id IS NOT NULL\n            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n        ';\n\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener todos los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getTodo(Request $request): Collection {\n        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);","numLines":100,"startLine":1,"totalLines":911}},"sourceToolAssistantUUID":"cac4dee8-fafe-4113-b710-cdff5595549d"}
{"parentUuid":"a168c1c1-fb23-4a98-8f25-6ca001c68f9c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XLxjVoneKf89QbNLnkd5zB","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\IA;\n     4→\n     5→use Carbon\\Carbon;\n     6→use App\\Models\\IA\\ConsumoCredito;\n     7→use Illuminate\\Support\\Collection;\n     8→use App\\Http\\Repositories\\BaseRepository;\n     9→\n    10→class ConsumoCreditoRepository extends BaseRepository\n    11→{\n    12→    /**\n    13→     * Constructor.\n    14→     *\n    15→     * @param ConsumoCredito $modelo Modelo de consumos de créditos.\n    16→     * @return void\n    17→     * @author Sergio Vargas\n    18→     * @author Daniel Beltrán\n    19→     */\n    20→    public function __construct(ConsumoCredito $modelo) {\n    21→        parent::__construct($modelo);\n    22→    }\n    23→\n    24→    /**\n    25→     * Obtener consumo por usuario.\n    26→     *\n    27→     * @param int $usuario_id ID del usuario.\n    28→     * @param ?Carbon $desde Fecha inicial.\n    29→     * @param ?Carbon $hasta Fecha final.\n    30→     * @return Collection\n    31→     * @author Sergio Vargas\n    32→     * @author Daniel Beltrán\n    33→     */\n    34→    public function obtenerConsumoPorUsuario(int $usuario_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n    35→        return $this->modelo\n    36→        ->where('usuario_id', $usuario_id)\n    37→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n    38→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n    39→        ->get();\n    40→    }\n    41→\n    42→    /**\n    43→     * Obtener consumo por empresa.\n    44→     *\n    45→     * @param int $empresa_id ID de la empresa.\n    46→     * @param ?Carbon $desde Fecha inicial.\n    47→     * @param ?Carbon $hasta Fecha final.\n    48→     * @return Collection\n    49→     * @author Sergio Vargas\n    50→     * @author Daniel Beltrán\n    51→     */\n    52→    public function obtenerConsumoPorEmpresa(int $empresa_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n    53→        return $this->modelo\n    54→        ->where('empresa_id', $empresa_id)\n    55→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n    56→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n    57→        ->get();\n    58→    }\n    59→\n    60→    /**\n    61→     * Obtener historial de consumos por empresa.\n    62→     *\n    63→     * @param int $empresa_id ID de la empresa.\n    64→     * @param ?Carbon $desde Fecha inicial.\n    65→     * @param ?Carbon $hasta Fecha final.\n    66→     * @return Collection\n    67→     * @author Sergio Vargas\n    68→     */\n    69→    public function historialPorEmpresa(int $empresa_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n    70→        return $this->modelo\n    71→        ->select('id', 'usuario_id', 'servicio_ia_id', 'creditos', 'tokens_totales', 'created_at', 'nombre_servicio', 'ruta_endpoint')\n    72→        ->with([\n    73→            'usuario:id,nombres,apellidos',\n    74→            'servicioIA:id,nombre'\n    75→        ])\n    76→        ->where('empresa_id', $empresa_id)\n    77→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n    78→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n    79→        ->orderBy('created_at', 'DESC')\n    80→        ->get();\n    81→    }\n    82→\n    83→    /**\n    84→     * Obtener estadísticas por endpoint.\n    85→     *\n    86→     * @param string $ruta_endpoint Endpoint.\n    87→     * @param ?Carbon $desde Fecha inicial.\n    88→     * @param ?Carbon $hasta Fecha final.\n    89→     * @return ?object\n    90→     * @author Sergio Vargas\n    91→     * @author Daniel Beltrán\n    92→     */\n    93→    public function obtenerEstadisticasPorEndpoint(string $ruta_endpoint, ?Carbon $desde = null, ?Carbon $hasta = null): ?object {\n    94→        return $this->modelo\n    95→        ->where('ruta_endpoint', $ruta_endpoint)\n    96→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n    97→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n    98→        ->selectRaw('\n    99→            COUNT(*) as total_peticiones,\n   100→            SUM(tokens_totales) as total_tokens,\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5fbf56ec-d8b9-4045-bbf1-2d60f0ec0be2","timestamp":"2026-01-21T15:03:16.645Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php","content":"<?php\n\nnamespace App\\Http\\Repositories\\IA;\n\nuse Carbon\\Carbon;\nuse App\\Models\\IA\\ConsumoCredito;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\BaseRepository;\n\nclass ConsumoCreditoRepository extends BaseRepository\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCredito $modelo Modelo de consumos de créditos.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(ConsumoCredito $modelo) {\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener consumo por usuario.\n     *\n     * @param int $usuario_id ID del usuario.\n     * @param ?Carbon $desde Fecha inicial.\n     * @param ?Carbon $hasta Fecha final.\n     * @return Collection\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function obtenerConsumoPorUsuario(int $usuario_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n        return $this->modelo\n        ->where('usuario_id', $usuario_id)\n        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n        ->get();\n    }\n\n    /**\n     * Obtener consumo por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param ?Carbon $desde Fecha inicial.\n     * @param ?Carbon $hasta Fecha final.\n     * @return Collection\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function obtenerConsumoPorEmpresa(int $empresa_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n        return $this->modelo\n        ->where('empresa_id', $empresa_id)\n        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n        ->get();\n    }\n\n    /**\n     * Obtener historial de consumos por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param ?Carbon $desde Fecha inicial.\n     * @param ?Carbon $hasta Fecha final.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialPorEmpresa(int $empresa_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n        return $this->modelo\n        ->select('id', 'usuario_id', 'servicio_ia_id', 'creditos', 'tokens_totales', 'created_at', 'nombre_servicio', 'ruta_endpoint')\n        ->with([\n            'usuario:id,nombres,apellidos',\n            'servicioIA:id,nombre'\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    /**\n     * Obtener estadísticas por endpoint.\n     *\n     * @param string $ruta_endpoint Endpoint.\n     * @param ?Carbon $desde Fecha inicial.\n     * @param ?Carbon $hasta Fecha final.\n     * @return ?object\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function obtenerEstadisticasPorEndpoint(string $ruta_endpoint, ?Carbon $desde = null, ?Carbon $hasta = null): ?object {\n        return $this->modelo\n        ->where('ruta_endpoint', $ruta_endpoint)\n        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n        ->selectRaw('\n            COUNT(*) as total_peticiones,\n            SUM(tokens_totales) as total_tokens,","numLines":100,"startLine":1,"totalLines":149}},"sourceToolAssistantUUID":"a168c1c1-fb23-4a98-8f25-6ca001c68f9c"}
{"parentUuid":"f68b4b76-bfdc-491f-99ce-1bfaf5c52ce8","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JKPa82VYNW8877fA6Mfvb1","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\IA;\n     4→\n     5→use Illuminate\\Database\\Eloquent\\Model;\n     6→use Illuminate\\Database\\Eloquent\\Builder;\n     7→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n     8→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n     9→\n    10→class ServicioIA extends Model\n    11→{\n    12→    public const OBTENER_HV_ID = 9;\n    13→\n    14→    protected $table = 'servicios_ia';\n    15→\n    16→    protected $fillable = [\n    17→        'categoria_servicio_ia_id',\n    18→        'nombre',\n    19→        'endpoint',\n    20→        'descripcion',\n    21→        'consume_creditos',\n    22→        'activo'\n    23→    ];\n    24→\n    25→    protected $casts = [\n    26→        'categoria_servicio_ia_id' => 'integer',\n    27→        'consume_creditos'         => 'integer',\n    28→        'activo'                   => 'boolean'\n    29→    ];\n    30→\n    31→    /**\n    32→     * Filtrar por registros activos.\n    33→     *\n    34→     * @param Builder $consulta Consulta.\n    35→     * @return Builder\n    36→     * @author Sergio Vargas\n    37→     * @author Daniel Beltrán\n    38→     */\n    39→    public function scopeActivos(Builder $consulta): Builder {\n    40→        return $consulta->where('activo', true);\n    41→    }\n    42→\n    43→    /**\n    44→     * Filtrar por endpoint.\n    45→     *\n    46→     * @param Builder $consulta Consulta.\n    47→     * @param string $endpoint Enpoint por el cual filtrar.\n    48→     * @return Builder\n    49→     * @author Sergio Vargas\n    50→     * @author Daniel Beltrán\n    51→     */\n    52→    public function scopePorEndpoint(Builder $consulta, string $endpoint): Builder {\n    53→        return $consulta->where('endpoint', $endpoint);\n    54→    }\n    55→\n    56→    /**\n    57→     * Relación de muchos a uno con categorias_ia.\n    58→     *\n    59→     * @return BelongsTo\n    60→     * @author Sergio Vargas\n    61→     * @author Daniel Beltrán\n    62→     */\n    63→    public function categoria(): BelongsTo {\n    64→        return $this->belongsTo(CategoriaServicioIA::class, 'categoria_servicio_ia_id');\n    65→    }\n    66→\n    67→    /**\n    68→     * Relación de uno a muchos con consumos_creditos.\n    69→     *\n    70→     * @return HasMany\n    71→     * @author Sergio Vargas\n    72→     * @author Daniel Beltrán\n    73→     */\n    74→    public function consumosCreditos(): HasMany {\n    75→        return $this->hasMany(ConsumoCredito::class, 'servicio_ia_id');\n    76→    }\n    77→}\n    78→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"01da9eea-f9a5-419a-89b7-81b936b619e4","timestamp":"2026-01-21T15:03:16.646Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php","content":"<?php\n\nnamespace App\\Models\\IA;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Builder;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n\nclass ServicioIA extends Model\n{\n    public const OBTENER_HV_ID = 9;\n\n    protected $table = 'servicios_ia';\n\n    protected $fillable = [\n        'categoria_servicio_ia_id',\n        'nombre',\n        'endpoint',\n        'descripcion',\n        'consume_creditos',\n        'activo'\n    ];\n\n    protected $casts = [\n        'categoria_servicio_ia_id' => 'integer',\n        'consume_creditos'         => 'integer',\n        'activo'                   => 'boolean'\n    ];\n\n    /**\n     * Filtrar por registros activos.\n     *\n     * @param Builder $consulta Consulta.\n     * @return Builder\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function scopeActivos(Builder $consulta): Builder {\n        return $consulta->where('activo', true);\n    }\n\n    /**\n     * Filtrar por endpoint.\n     *\n     * @param Builder $consulta Consulta.\n     * @param string $endpoint Enpoint por el cual filtrar.\n     * @return Builder\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function scopePorEndpoint(Builder $consulta, string $endpoint): Builder {\n        return $consulta->where('endpoint', $endpoint);\n    }\n\n    /**\n     * Relación de muchos a uno con categorias_ia.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function categoria(): BelongsTo {\n        return $this->belongsTo(CategoriaServicioIA::class, 'categoria_servicio_ia_id');\n    }\n\n    /**\n     * Relación de uno a muchos con consumos_creditos.\n     *\n     * @return HasMany\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function consumosCreditos(): HasMany {\n        return $this->hasMany(ConsumoCredito::class, 'servicio_ia_id');\n    }\n}\n","numLines":78,"startLine":1,"totalLines":78}},"sourceToolAssistantUUID":"f68b4b76-bfdc-491f-99ce-1bfaf5c52ce8"}
{"parentUuid":"01da9eea-f9a5-419a-89b7-81b936b619e4","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PGagAE7pLBs68UUBvkSq6k","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente. Ahora voy a buscar vistas y archivos JS relacionados con la compra de créditos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":14899,"cache_read_input_tokens":63209,"cache_creation":{"ephemeral_5m_input_tokens":14899,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj7bzAozAeNsPAVG4Fm","type":"assistant","uuid":"5aa66cf4-c9c5-41fa-9eb3-9630d3e58a66","timestamp":"2026-01-21T15:03:20.140Z"}
{"parentUuid":"5aa66cf4-c9c5-41fa-9eb3-9630d3e58a66","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PGagAE7pLBs68UUBvkSq6k","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Wq4h3MF7N3xZLHz2x8qh6p","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\modal-recompras.blade.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":14899,"cache_read_input_tokens":63209,"cache_creation":{"ephemeral_5m_input_tokens":14899,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj7bzAozAeNsPAVG4Fm","type":"assistant","uuid":"1da9cfe7-6c56-4d3f-a86f-bd58d74c6427","timestamp":"2026-01-21T15:03:20.472Z"}
{"parentUuid":"1da9cfe7-6c56-4d3f-a86f-bd58d74c6427","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PGagAE7pLBs68UUBvkSq6k","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01We4zH17kuUcv5WR8ea62U6","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":14899,"cache_read_input_tokens":63209,"cache_creation":{"ephemeral_5m_input_tokens":14899,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj7bzAozAeNsPAVG4Fm","type":"assistant","uuid":"4fd4c16e-174e-4f06-8f0e-a5b17abbe91c","timestamp":"2026-01-21T15:03:20.652Z"}
{"parentUuid":"4fd4c16e-174e-4f06-8f0e-a5b17abbe91c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PGagAE7pLBs68UUBvkSq6k","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XwwmpXrzBAQpAEgG1WKXWv","name":"Grep","input":{"pattern":"historialComprasCreditos|plane.*credito|comprarcredito","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":14899,"cache_read_input_tokens":63209,"cache_creation":{"ephemeral_5m_input_tokens":14899,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj7bzAozAeNsPAVG4Fm","type":"assistant","uuid":"689a0c8e-9bac-4351-92c2-fb7a1e60d3e4","timestamp":"2026-01-21T15:03:21.456Z"}
{"parentUuid":"1da9cfe7-6c56-4d3f-a86f-bd58d74c6427","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Wq4h3MF7N3xZLHz2x8qh6p","type":"tool_result","content":"     1→${crearModal({\n     2→    id: 'modal-historial-recompras',\n     3→    dialog_class: 'modal-dialog-centered modal-xl modal-dialog-scrollable',\n     4→    titulo_header: `\n     5→        @php\n     6→            $migasDePan = [\n     7→                ['nombre' => 'Mi empresa', 'url' => '', 'active' => true],\n     8→                ['nombre' => 'Planes y consumo', 'url' => '', 'active' => true],\n     9→                ['nombre' => 'Historial de compras', 'url' => '', 'active' => true],\n    10→            ];\n    11→        @endphp\n    12→        ${crearMigaDePan({migas:@json($migasDePan), volver:false})}\n    13→    `,\n    14→    modal_body: `\n    15→        <h3 class=\"text-headline-4 fw-bolder mt-5\"><i class=\"bi bi-cart-fill text-headline-2 me-3\"></i> Historial de compras</h3>\n    16→        <div class=\"col-12 mb-5 text-body-2 fw-normal\">Aquí puedes ver un registro detallado de las recompras realizadas.</div>\n    17→        ${crearTabsHorizontal({\n    18→            id: 'tabs-modal-consumos',\n    19→            tabs: [\n    20→                {\n    21→                    id: 'pestana-compras-seleccion',\n    22→                    icono: `<i class=\"bi bi-box-fill text-headline-4 me-3\"></i>`,\n    23→                    titulo: `Selección`,\n    24→                    contenido: `\n    25→                        <div class=\"col-12 mt-5\">\n    26→                            ${crearTabla({\n    27→                                id: 'tabla-compras-seleccion',\n    28→                                registros_paginas: true,\n    29→                                issubtabla: '.desplegarSubRow',\n    30→                                chips: `\n    31→                                    <div class=\"col-12\">\n    32→                                        <div class=\"row align-items-center w-100 mx-0 contenedor-chips my-2\" id=\"contenedor-chips-filtro_dropdown_seleccion\"></div>\n    33→                                    </div>\n    34→                                `,\n    35→                                botones: `\n    36→                                    <div class=\"col-auto\">\n    37→                                        ${crearFiltroDropdown({\n    38→                                            id: 'filtro_dropdown_seleccion',\n    39→                                            name: 'filtro_dropdown_seleccion',\n    40→                                            type: 'text',\n    41→                                            value: '',\n    42→                                            class: 'filtro-chips',\n    43→                                            placeholder: 'Buscar',\n    44→                                            icono: '<i class=\"bi bi-search input-icono1\"></i>',\n    45→                                            icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n    46→                                            dropdown: {\n    47→                                                titulo: 'Filtros avanzados',\n    48→                                                contenido: `\n    49→                                                    <div class=\"row mt-4\">\n    50→                                                        <div class=\"col-5 pt-2\">Duración</div>\n    51→                                                        <div class=\"col-7\">\n    52→                                                            ${crearSelect2({\n    53→                                                                opciones: [\n    54→                                                                    { nombre: 'Todos', id: '' },\n    55→                                                                    { nombre: 'Con tiempo', id: 'con_tiempo' },\n    56→                                                                    { nombre: 'Sin tiempo', id: 'sin_tiempo' },\n    57→                                                                ],\n    58→                                                                opcion_vacia: false,\n    59→                                                                id: 'duracion_filtro_seleccion',\n    60→                                                                class: 'select2-filtro filtro',\n    61→                                                                input_container_class: 'mb-0',\n    62→                                                                data: [\n    63→                                                                    { texto: 'filtro', value: 'Duración'}\n    64→                                                                ]\n    65→                                                            })}\n    66→                                                        </div>\n    67→                                                    </div>\n    68→                                                    <div class=\"row mt-4\">\n    69→                                                        <div class=\"col-5 pt-2\">Fecha de activación</div>\n    70→                                                        <div class=\"col-7\">\n    71→                                                            ${crearDatePicker({\n    72→                                                                id: 'fecha_activacion_filtro_seleccion',\n    73→                                                                class: 'flatpickr-range filtro',\n    74→                                                                input_container_class: 'mb-1',\n    75→                                                                placeholder: 'Desde - hasta',\n    76→                                                                disabled: false,\n    77→                                                                icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n    78→                                                                data: [\n    79→                                                                    { texto: 'filtro', value: 'Fecha de activación'}\n    80→                                                                ]\n    81→                                                            })}\n    82→                                                        </div>\n    83→                                                    </div>\n    84→                                                    <div class=\"row mt-4\">\n    85→                                                        <div class=\"col-5 pt-2\">Fecha de vencimiento</div>\n    86→                                                        <div class=\"col-7\">\n    87→                                                            ${crearDatePicker({\n    88→                                                                id: 'fecha_vencimiento_filtro_seleccion',\n    89→                                                                class: 'flatpickr-range filtro',\n    90→                                                                input_container_class: 'mb-1',\n    91→                                                                placeholder: 'Desde - hasta',\n    92→                                                                disabled: false,\n    93→                                                                icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n    94→                                                                data: [\n    95→                                                                    { texto: 'filtro', value: 'Fecha de vencimiento'}\n    96→                                                                ]\n    97→                                                            })}\n    98→                                                        </div>\n    99→                                                    </div>\n   100→                                                    <div class=\"row mt-4\">\n   101→                                                        <div class=\"col-5 pt-2\">Estado del plan</div>\n   102→                                                        <div class=\"col-7\">\n   103→                                                            ${crearSelect2({\n   104→                                                                opciones: [\n   105→                                                                    { nombre: 'Todos', id: '' },\n   106→                                                                    { nombre: 'Activo', id: '1' },\n   107→                                                                    { nombre: 'Inactivo', id: '2' },\n   108→                                                                    { nombre: 'Próximo', id: '3' },\n   109→                                                                    { nombre: 'Por vencer', id: '4' },\n   110→                                                                    { nombre: 'Vencido', id: '5' },\n   111→                                                                    { nombre: 'Renovando', id: '6' },\n   112→                                                                ],\n   113→                                                                opcion_vacia: false,\n   114→                                                                id: 'estado_plan_filtro_seleccion',\n   115→                                                                class: 'select2-filtro filtro',\n   116→                                                                input_container_class: 'mb-0',\n   117→                                                                data: [\n   118→                                                                    { texto: 'filtro', value: 'Estado del plan'}\n   119→                                                                ]\n   120→                                                            })}\n   121→                                                        </div>\n   122→                                                    </div>\n   123→                                                `,\n   124→                                            }\n   125→                                        })}\n   126→                                    </div>\n   127→                                    <div class=\"col-auto\" id=\"seleccion-totales-unidades\">\n   128→                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>\n   129→                                    </div>\n   130→                                    <div class=\"col-auto\" id=\"seleccion-totales-ofertas\">\n   131→                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>\n   132→\n   133→                                    </div>\n   134→                                    <div class=\"col-auto ms-auto\">\n   135→                                        ${crearBoton({ id: 'boton-descargar-historial-compras-seleccion', clases: 'btn-outline-success', texto: '<img class=\"me-3\" src=\"{{ asset('/iconos/excel_icon.svg') }}\"> Exportar todo' })}\n   136→                                    </div>\n   137→                                `,\n   138→                            })}\n   139→                        </div>\n   140→                    `,\n   141→                    activo: true\n   142→                },\n   143→                {\n   144→                    id: 'pestana-compras-organizacional',\n   145→                    icono: `<i class=\"bi bi-briefcase-fill text-headline-4 me-3\"></i>`,\n   146→                    titulo: `Organizacional`,\n   147→                    contenido: `\n   148→                        <div class=\"col-12 mt-5\">\n   149→                            ${crearTabla({\n   150→                                id: 'tabla-compras-organizacional',\n   151→                                registros_paginas: true,\n   152→                                input_container_class: 'mb-0',\n   153→                                filtro: crearFiltroDropdown({\n   154→                                    id: 'filtro_dropdown_organizacional',\n   155→                                    name: 'filtro_dropdown_organizacional',\n   156→                                    type: 'text',\n   157→                                    value: '',\n   158→                                    class: 'filtro-chips',\n   159→                                    input_container_class: 'mb-0',\n   160→                                    placeholder: 'Buscar',\n   161→                                    icono: '<i class=\"bi bi-search input-icono1\"></i>',\n   162→                                    icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n   163→                                    dropdown: {\n   164→                                        titulo: 'Filtros avanzados',\n   165→                                        contenido: `\n   166→                                            <div class=\"row mt-4\">\n   167→                                                <div class=\"col-5 pt-2\">Duración</div>\n   168→                                                <div class=\"col-7\">\n   169→                                                    ${crearSelect2({\n   170→                                                        opciones: [\n   171→                                                            { nombre: 'Todos', id: '' },\n   172→                                                            { nombre: 'Con tiempo', id: 'con-tiempo' },\n   173→                                                            { nombre: 'Sin tiempo', id: 'sin-tiempo' },\n   174→                                                        ],\n   175→                                                        opcion_vacia: false,\n   176→                                                        id: 'duracion_filtro_organizacional',\n   177→                                                        class: 'select2-filtro filtro',\n   178→                                                        input_container_class: 'mb-0',\n   179→                                                        data: [\n   180→                                                            { texto: 'filtro', value: 'Duración'}\n   181→                                                        ]\n   182→                                                    })}\n   183→                                                </div>\n   184→                                            </div>\n   185→                                            <div class=\"row mt-4\">\n   186→                                                <div class=\"col-5 pt-2\">Fecha de activación</div>\n   187→                                                <div class=\"col-7\">\n   188→                                                    ${crearDatePicker({\n   189→                                                        id: 'fecha_activacion_filtro_organizacional',\n   190→                                                        class: 'flatpickr-range filtro',\n   191→                                                        input_container_class: 'mb-1',\n   192→                                                        placeholder: 'Desde - hasta',\n   193→                                                        disabled: false,\n   194→                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n   195→                                                        data: [\n   196→                                                            { texto: 'filtro', value: 'Fecha de activación'}\n   197→                                                        ]\n   198→                                                    })}\n   199→                                                </div>\n   200→                                            </div>\n   201→                                            <div class=\"row mt-4\">\n   202→                                                <div class=\"col-5 pt-2\">Fecha de vencimiento</div>\n   203→                                                <div class=\"col-7\">\n   204→                                                    ${crearDatePicker({\n   205→                                                        id: 'fecha_vencimiento_filtro_organizacional',\n   206→                                                        class: 'flatpickr-range filtro',\n   207→                                                        input_container_class: 'mb-1',\n   208→                                                        placeholder: 'Desde - hasta',\n   209→                                                        disabled: false,\n   210→                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n   211→                                                        data: [\n   212→                                                            { texto: 'filtro', value: 'Fecha de vencimiento'}\n   213→                                                        ]\n   214→                                                    })}\n   215→                                                </div>\n   216→                                            </div>\n   217→                                            <div class=\"row mt-4\">\n   218→                                                <div class=\"col-5 pt-2\">Estado del plan</div>\n   219→                                                <div class=\"col-7\">\n   220→                                                    ${crearSelect2({\n   221→                                                        opciones: [\n   222→                                                            { nombre: 'Todos', id: '' },\n   223→                                                            { nombre: 'Activo', id: '1' },\n   224→                                                            { nombre: 'Inactivo', id: '2' },\n   225→                                                            { nombre: 'Próximo', id: '3' },\n   226→                                                            { nombre: 'Por vencer', id: '4' },\n   227→                                                            { nombre: 'Vencido', id: '5' },\n   228→                                                            { nombre: 'Renovando', id: '6' },\n   229→                                                        ],\n   230→                                                        opcion_vacia: false,\n   231→                                                        id: 'estado_plan_filtro_organizacional',\n   232→                                                        class: 'select2-filtro filtro',\n   233→                                                        input_container_class: 'mb-0',\n   234→                                                        data: [\n   235→                                                            { texto: 'filtro', value: 'Estado del plan'}\n   236→                                                        ]\n   237→                                                    })}\n   238→                                                </div>\n   239→                                            </div>\n   240→                                        `,\n   241→                                    }\n   242→                                }),\n   243→                                issubtabla: '.desplegarSubRow',\n   244→                                botones: `\n   245→                                    <div class=\"col-auto\" id=\"organizacional-totales-unidades\">\n   246→                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>\n   247→                                    </div>\n   248→                                    <div class=\"col-auto\" id=\"organizacional-totales-ofertas\">\n   249→                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>\n   250→                                    </div>\n   251→                                    <div class=\"col-auto ms-auto\">\n   252→                                        ${crearBoton({ id: 'boton-descargar-historial-compras-organizacional', clases: 'btn-outline-success', texto: '<img class=\"me-3\" src=\"{{ asset('/iconos/excel_icon.svg') }}\"> Exportar todo' })}\n   253→                                    </div>\n   254→                                `,\n   255→                                chips: `\n   256→                                    <div class=\"col-12\">\n   257→                                        <div class=\"row align-items-center w-100 mx-0 contenedor-chips my-2\" id=\"contenedor-chips-filtro_dropdown_organizacional\"></div>\n   258→                                    </div>\n   259→                                `\n   260→                            })}\n   261→                        </div>\n   262→                    `,\n   263→                },\n   264→                {\n   265→                    id: 'pestana-compras-vocacional',\n   266→                    icono: `<i class=\"bi bi-person-fill text-headline-4 me-3\"></i>`,\n   267→                    titulo: `Vocacional`,\n   268→                    contenido: `\n   269→                        <div class=\"col-12 mt-5\">\n   270→                            ${crearTabla({\n   271→                                id: 'tabla-compras-vocacional',\n   272→                                registros_paginas: true,\n   273→                                input_container_class: 'mb-0',\n   274→                                filtro: crearFiltroDropdown({\n   275→                                    id: 'filtro_dropdown_vocacional',\n   276→                                    name: 'filtro_dropdown_vocacional',\n   277→                                    type: 'text',\n   278→                                    value: '',\n   279→                                    class: 'filtro-chips',\n   280→                                    input_container_class: 'mb-0',\n   281→                                    placeholder: 'Buscar',\n   282→                                    icono: '<i class=\"bi bi-search input-icono1\"></i>',\n   283→                                    icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n   284→                                    dropdown: {\n   285→                                        titulo: 'Filtros avanzados',\n   286→                                        contenido: `\n   287→                                            <div class=\"row mt-4\">\n   288→                                                <div class=\"col-5 pt-2\">Duración</div>\n   289→                                                <div class=\"col-7\">\n   290→                                                    ${crearSelect2({\n   291→                                                        opciones: [\n   292→                                                            { nombre: 'Todos', id: '' },\n   293→                                                            { nombre: 'Con tiempo', id: 'con-tiempo' },\n   294→                                                            { nombre: 'Sin tiempo', id: 'sin-tiempo' },\n   295→                                                        ],\n   296→                                                        opcion_vacia: false,\n   297→                                                        id: 'duracion_filtro_vocacional',\n   298→                                                        class: 'select2-filtro filtro',\n   299→                                                        input_container_class: 'mb-0',\n   300→                                                        data: [\n   301→                                                            { texto: 'filtro', value: 'Duración'}\n   302→                                                        ]\n   303→                                                    })}\n   304→                                                </div>\n   305→                                            </div>\n   306→                                            <div class=\"row mt-4\">\n   307→                                                <div class=\"col-5 pt-2\">Fecha de activación</div>\n   308→                                                <div class=\"col-7\">\n   309→                                                    ${crearDatePicker({\n   310→                                                        id: 'fecha_activacion_filtro_vocacional',\n   311→                                                        class: 'flatpickr-range filtro',\n   312→                                                        input_container_class: 'mb-1',\n   313→                                                        placeholder: 'Desde - hasta',\n   314→                                                        disabled: false,\n   315→                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n   316→                                                        data: [\n   317→                                                            { texto: 'filtro', value: 'Fecha de activación'}\n   318→                                                        ]\n   319→                                                    })}\n   320→                                                </div>\n   321→                                            </div>\n   322→                                            <div class=\"row mt-4\">\n   323→                                                <div class=\"col-5 pt-2\">Fecha de vencimiento</div>\n   324→                                                <div class=\"col-7\">\n   325→                                                    ${crearDatePicker({\n   326→                                                        id: 'fecha_vencimiento_filtro_vocacional',\n   327→                                                        class: 'flatpickr-range filtro',\n   328→                                                        input_container_class: 'mb-1',\n   329→                                                        placeholder: 'Desde - hasta',\n   330→                                                        disabled: false,\n   331→                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n   332→                                                        data: [\n   333→                                                            { texto: 'filtro', value: 'Fecha de vencimiento'}\n   334→                                                        ]\n   335→                                                    })}\n   336→                                                </div>\n   337→                                            </div>\n   338→                                            <div class=\"row mt-4\">\n   339→                                                <div class=\"col-5 pt-2\">Estado del plan</div>\n   340→                                                <div class=\"col-7\">\n   341→                                                    ${crearSelect2({\n   342→                                                        opciones: [\n   343→                                                            { nombre: 'Todos', id: '' },\n   344→                                                            { nombre: 'Activo', id: '1' },\n   345→                                                            { nombre: 'Inactivo', id: '2' },\n   346→                                                            { nombre: 'Próximo', id: '3' },\n   347→                                                            { nombre: 'Por vencer', id: '4' },\n   348→                                                            { nombre: 'Vencido', id: '5' },\n   349→                                                            { nombre: 'Renovando', id: '6' },\n   350→                                                        ],\n   351→                                                        opcion_vacia: false,\n   352→                                                        id: 'estado_plan_filtro_vocacional',\n   353→                                                        class: 'select2-filtro filtro',\n   354→                                                        input_container_class: 'mb-0',\n   355→                                                        data: [\n   356→                                                            { texto: 'filtro', value: 'Estado del plan'}\n   357→                                                        ]\n   358→                                                    })}\n   359→                                                </div>\n   360→                                            </div>\n   361→                                        `,\n   362→                                    }\n   363→                                }),\n   364→                                issubtabla: '.desplegarSubRow',\n   365→                                botones: `\n   366→                                    <div class=\"col-auto\" id=\"vocacional-totales-unidades\">\n   367→                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>\n   368→                                    </div>\n   369→                                    <div class=\"col-auto\" id=\"vocacional-totales-ofertas\">\n   370→                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>\n   371→                                    </div>\n   372→                                    <div class=\"col-auto ms-auto\">\n   373→                                        ${crearBoton({ id: 'boton-descargar-historial-compras-vocacional', clases: 'btn-outline-success', texto: '<img class=\"me-3\" src=\"{{ asset('/iconos/excel_icon.svg') }}\"> Exportar todo' })}\n   374→                                    </div>\n   375→                                `,\n   376→                                chips: `\n   377→                                    <div class=\"col-12\">\n   378→                                        <div class=\"row align-items-center w-100 mx-0 contenedor-chips my-2\" id=\"contenedor-chips-filtro_dropdown_vocacional\"></div>\n   379→                                    </div>\n   380→                                `\n   381→                            })}\n   382→                        </div>  \n   383→                    `,\n   384→                },\n   385→                {\n   386→                    id: 'pestana-compras-creditos',\n   387→                    icono: `<img class=\"me-3\" src=\"{{ asset('/iconos/icono_ia.svg') }}\" width=\"20\" height=\"20\" alt=\"Icono IA\">`,\n   388→                    titulo: `Créditos IA`,\n   389→                    contenido: `\n   390→                        <div class=\"col-12 mt-5\">\n   391→                            ${crearTabla({\n   392→                                id: 'tabla-compras-creditos',\n   393→                                registros_paginas: true,\n   394→                                input_container_class: 'mb-0',\n   395→                                filtro: crearFiltroDropdown({\n   396→                                    id: 'filtro_dropdown_creditos',\n   397→                                    name: 'filtro_dropdown_creditos',\n   398→                                    type: 'text',\n   399→                                    value: '',\n   400→                                    class: 'filtro-chips',\n   401→                                    input_container_class: 'mb-0',\n   402→                                    placeholder: 'Buscar',\n   403→                                    icono: '<i class=\"bi bi-search input-icono1\"></i>',\n   404→                                    icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n   405→                                    dropdown: {\n   406→                                        titulo: 'Filtros avanzados',\n   407→                                        contenido: `\n   408→                                            <div class=\"row mt-4\">\n   409→                                                <div class=\"col-5 pt-2\">Duración</div>\n   410→                                                <div class=\"col-7\">\n   411→                                                    ${crearSelect2({\n   412→                                                        opciones: [\n   413→                                                            { nombre: 'Todos', id: '' },\n   414→                                                            { nombre: 'Con tiempo', id: 'con_tiempo' },\n   415→                                                            { nombre: 'Sin tiempo', id: 'sin_tiempo' },\n   416→                                                        ],\n   417→                                                        opcion_vacia: false,\n   418→                                                        id: 'duracion_filtro_creditos',\n   419→                                                        class: 'select2-filtro filtro',\n   420→                                                        input_container_class: 'mb-0',\n   421→                                                        data: [\n   422→                                                            { texto: 'filtro', value: 'Duración'}\n   423→                                                        ]\n   424→                                                    })}\n   425→                                                </div>\n   426→                                            </div>\n   427→                                            <div class=\"row mt-4\">\n   428→                                                <div class=\"col-5 pt-2\">Fecha de activación</div>\n   429→                                                <div class=\"col-7\">\n   430→                                                    ${crearDatePicker({\n   431→                                                        id: 'fecha_activacion_filtro_creditos',\n   432→                                                        class: 'flatpickr-range filtro',\n   433→                                                        input_container_class: 'mb-1',\n   434→                                                        placeholder: 'Desde - hasta',\n   435→                                                        disabled: false,\n   436→                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n   437→                                                        data: [\n   438→                                                            { texto: 'filtro', value: 'Fecha de activación'}\n   439→                                                        ]\n   440→                                                    })}\n   441→                                                </div>\n   442→                                            </div>\n   443→                                            <div class=\"row mt-4\">\n   444→                                                <div class=\"col-5 pt-2\">Fecha de vencimiento</div>\n   445→                                                <div class=\"col-7\">\n   446→                                                    ${crearDatePicker({\n   447→                                                        id: 'fecha_vencimiento_filtro_creditos',\n   448→                                                        class: 'flatpickr-range filtro',\n   449→                                                        input_container_class: 'mb-1',\n   450→                                                        placeholder: 'Desde - hasta',\n   451→                                                        disabled: false,\n   452→                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n   453→                                                        data: [\n   454→                                                            { texto: 'filtro', value: 'Fecha de vencimiento'}\n   455→                                                        ]\n   456→                                                    })}\n   457→                                                </div>\n   458→                                            </div>\n   459→                                            <div class=\"row mt-4\">\n   460→                                                <div class=\"col-5 pt-2\">Estado del plan</div>\n   461→                                                <div class=\"col-7\">\n   462→                                                    ${crearSelect2({\n   463→                                                        opciones: [\n   464→                                                            { nombre: 'Todos', id: '' },\n   465→                                                            { nombre: 'Activo', id: '1' },\n   466→                                                            { nombre: 'Inactivo', id: '2' },\n   467→                                                            { nombre: 'Próximo', id: '3' },\n   468→                                                            { nombre: 'Por vencer', id: '4' },\n   469→                                                            { nombre: 'Vencido', id: '5' },\n   470→                                                            { nombre: 'Renovando', id: '6' },\n   471→                                                        ],\n   472→                                                        opcion_vacia: false,\n   473→                                                        id: 'estado_plan_filtro_creditos',\n   474→                                                        class: 'select2-filtro filtro',\n   475→                                                        input_container_class: 'mb-0',\n   476→                                                        data: [\n   477→                                                            { texto: 'filtro', value: 'Estado del plan'}\n   478→                                                        ]\n   479→                                                    })}\n   480→                                                </div>\n   481→                                            </div>\n   482→                                        `,\n   483→                                    }\n   484→                                }),\n   485→                                issubtabla: '.desplegarSubRow',\n   486→                                botones: `\n   487→                                    <div class=\"col-auto\" id=\"creditos-totales\">\n   488→                                        <p class=\"text-label-2 mb-1\"><img class=\"me-2\" src=\"{{ asset('/iconos/icono_ia.svg') }}\" width=\"16\" height=\"16\" alt=\"Icono IA\">Créditos totales</p>\n   489→                                    </div>\n   490→                                    <div class=\"col-auto ms-auto\">\n   491→                                        ${crearBoton({ id: 'boton-descargar-historial-compras-creditos', clases: 'btn-outline-success', texto: '<img class=\"me-3\" src=\"{{ asset('/iconos/excel_icon.svg') }}\"> Exportar todo' })}\n   492→                                    </div>\n   493→                                `,\n   494→                                chips: `\n   495→                                    <div class=\"col-12\">\n   496→                                        <div class=\"row align-items-center w-100 mx-0 contenedor-chips my-2\" id=\"contenedor-chips-filtro_dropdown_creditos\"></div>\n   497→                                    </div>\n   498→                                `\n   499→                            })}\n   500→                        </div>\n   501→                    `,\n   502→                },\n   503→            ]\n   504→        })}\n   505→    `\n   506→})}\n   507→<div class=\"modal fade\" id=\"modal-filtros-avanzados-compras\" data-bs-backdrop=\"static\" tabindex=\"-1\" aria-labelledby=\"modal-filtros-avanzados-comprasLabel\" aria-hidden=\"true\">\n   508→    <div class=\"modal-dialog modal-dialog-centered modal-md\">\n   509→        <div class=\"modal-content rounded-4\">\n   510→            <div class=\"modal-header border-0\">\n   511→                <div class=\"row justify-content-between align-items-center m-0 w-100\">\n   512→                    <div class=\"col-auto text-headline-4 mb-0\" id=\"modal-filtros-avanzados-comprasLabel\">Filtros avanzados</div>\n   513→                    <div class=\"col-auto px-3 py-2 pointer\" data-bs-dismiss=\"modal\" aria-label=\"Close\">\n   514→                        <i class=\"bi bi-x-lg\"></i>\n   515→                    </div>\n   516→                </div>\n   517→            </div>\n   518→            <div class=\"modal-body pt-0\">\n   519→                <div class=\"row w-100 mx-0\">\n   520→                    <div class=\"col-4 pt-2\">Duración:</div>\n   521→                    <div class=\"col-8\">\n   522→                        <div class=\"row\">\n   523→                            <div class=\"col-12\">\n   524→                                <div class=\"input-container mb-2\">\n   525→                                    <select id=\"filtro-duracion\">\n   526→                                        <option value=\"\">Seleccionar duración...</option>\n   527→                                        <option value=\"con-tiempo\">Con tiempo</option>\n   528→                                        <option value=\"sin-tiempo\">Sin tiempo</option>\n   529→                                    </select>\n   530→                                </div>\n   531→                            </div>\n   532→                        </div>\n   533→                    </div>\n   534→                </div>\n   535→                <div class=\"row w-100 mx-0\">\n   536→                    <div class=\"col-4 pt-2\">Fecha de activación:</div>\n   537→                    <div class=\"col-8\">\n   538→                        <div class=\"input-container mb-5\">\n   539→                            <input class=\"rounded-2 text-body-2 flatpickr-range bg-transparent\" id=\"filtro-fecha-activacion\" placeholder=\"dd/mm/aaaa\">\n   540→                        </div>\n   541→                    </div>\n   542→                </div>\n   543→                <div class=\"row w-100 mx-0\">\n   544→                    <div class=\"col-4 pt-2\">Fecha de vencimiento:</div>\n   545→                    <div class=\"col-8\">\n   546→                        <div class=\"input-container mb-5\">\n   547→                            <input class=\"rounded-2 text-body-2 flatpickr-range bg-transparent\" id=\"filtro-fecha-vencimiento\" placeholder=\"dd/mm/aaaa\">\n   548→                        </div>\n   549→                    </div>\n   550→                </div>\n   551→                <div class=\"row w-100 mx-0\">\n   552→                    <div class=\"col-4 pt-2\">Estado del plan:</div>\n   553→                    <div class=\"col-8\">\n   554→                        <div class=\"row\">\n   555→                            <div class=\"col-12\">\n   556→                                <div class=\"input-container mb-2\">\n   557→                                    <select id=\"filtro-estado-plan\">\n   558→                                        <option value=\"\">Seleccionar estado del plan...</option>\n   559→                                        <option value=\"1\">Activo</option>\n   560→                                        <option value=\"2\">Inactivo</option>\n   561→                                        <option value=\"3\">Próximo</option>\n   562→                                        <option value=\"4\">Por vencer</option>\n   563→                                        <option value=\"5\">Vencido</option>\n   564→                                        <option value=\"6\">Renovando</option>\n   565→                                    </select>\n   566→                                </div>\n   567→                            </div>\n   568→                        </div>\n   569→                    </div>\n   570→                </div>\n   571→                <div class=\"row m-0 w-100\">\n   572→                    <button type=\"button\" class=\"col btn btn-outline-primary me-1 pt-2 text-center d-block\" data-bs-dismiss=\"modal\" aria-label=\"Close\" onclick=\"borrarFiltrosAvanzadosCompras()\">\n   573→                        Borrar filtros\n   574→                    </button>\n   575→                    <button type=\"button\" class=\"col btn btn-primary ms-1 pt-2 text-center d-block\" onclick=\"aplicarFiltrosAvanzadosCompras()\">\n   576→                        Aplicar filtros\n   577→                    </button>\n   578→                </div>\n   579→            </div>\n   580→        </div>\n   581→    </div>\n   582→</div>\n   583→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7ee184fd-f3a4-4fd7-9fc4-a13482464c8a","timestamp":"2026-01-21T15:03:24.897Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\modal-recompras.blade.php","content":"${crearModal({\n    id: 'modal-historial-recompras',\n    dialog_class: 'modal-dialog-centered modal-xl modal-dialog-scrollable',\n    titulo_header: `\n        @php\n            $migasDePan = [\n                ['nombre' => 'Mi empresa', 'url' => '', 'active' => true],\n                ['nombre' => 'Planes y consumo', 'url' => '', 'active' => true],\n                ['nombre' => 'Historial de compras', 'url' => '', 'active' => true],\n            ];\n        @endphp\n        ${crearMigaDePan({migas:@json($migasDePan), volver:false})}\n    `,\n    modal_body: `\n        <h3 class=\"text-headline-4 fw-bolder mt-5\"><i class=\"bi bi-cart-fill text-headline-2 me-3\"></i> Historial de compras</h3>\n        <div class=\"col-12 mb-5 text-body-2 fw-normal\">Aquí puedes ver un registro detallado de las recompras realizadas.</div>\n        ${crearTabsHorizontal({\n            id: 'tabs-modal-consumos',\n            tabs: [\n                {\n                    id: 'pestana-compras-seleccion',\n                    icono: `<i class=\"bi bi-box-fill text-headline-4 me-3\"></i>`,\n                    titulo: `Selección`,\n                    contenido: `\n                        <div class=\"col-12 mt-5\">\n                            ${crearTabla({\n                                id: 'tabla-compras-seleccion',\n                                registros_paginas: true,\n                                issubtabla: '.desplegarSubRow',\n                                chips: `\n                                    <div class=\"col-12\">\n                                        <div class=\"row align-items-center w-100 mx-0 contenedor-chips my-2\" id=\"contenedor-chips-filtro_dropdown_seleccion\"></div>\n                                    </div>\n                                `,\n                                botones: `\n                                    <div class=\"col-auto\">\n                                        ${crearFiltroDropdown({\n                                            id: 'filtro_dropdown_seleccion',\n                                            name: 'filtro_dropdown_seleccion',\n                                            type: 'text',\n                                            value: '',\n                                            class: 'filtro-chips',\n                                            placeholder: 'Buscar',\n                                            icono: '<i class=\"bi bi-search input-icono1\"></i>',\n                                            icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n                                            dropdown: {\n                                                titulo: 'Filtros avanzados',\n                                                contenido: `\n                                                    <div class=\"row mt-4\">\n                                                        <div class=\"col-5 pt-2\">Duración</div>\n                                                        <div class=\"col-7\">\n                                                            ${crearSelect2({\n                                                                opciones: [\n                                                                    { nombre: 'Todos', id: '' },\n                                                                    { nombre: 'Con tiempo', id: 'con_tiempo' },\n                                                                    { nombre: 'Sin tiempo', id: 'sin_tiempo' },\n                                                                ],\n                                                                opcion_vacia: false,\n                                                                id: 'duracion_filtro_seleccion',\n                                                                class: 'select2-filtro filtro',\n                                                                input_container_class: 'mb-0',\n                                                                data: [\n                                                                    { texto: 'filtro', value: 'Duración'}\n                                                                ]\n                                                            })}\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"row mt-4\">\n                                                        <div class=\"col-5 pt-2\">Fecha de activación</div>\n                                                        <div class=\"col-7\">\n                                                            ${crearDatePicker({\n                                                                id: 'fecha_activacion_filtro_seleccion',\n                                                                class: 'flatpickr-range filtro',\n                                                                input_container_class: 'mb-1',\n                                                                placeholder: 'Desde - hasta',\n                                                                disabled: false,\n                                                                icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n                                                                data: [\n                                                                    { texto: 'filtro', value: 'Fecha de activación'}\n                                                                ]\n                                                            })}\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"row mt-4\">\n                                                        <div class=\"col-5 pt-2\">Fecha de vencimiento</div>\n                                                        <div class=\"col-7\">\n                                                            ${crearDatePicker({\n                                                                id: 'fecha_vencimiento_filtro_seleccion',\n                                                                class: 'flatpickr-range filtro',\n                                                                input_container_class: 'mb-1',\n                                                                placeholder: 'Desde - hasta',\n                                                                disabled: false,\n                                                                icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n                                                                data: [\n                                                                    { texto: 'filtro', value: 'Fecha de vencimiento'}\n                                                                ]\n                                                            })}\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"row mt-4\">\n                                                        <div class=\"col-5 pt-2\">Estado del plan</div>\n                                                        <div class=\"col-7\">\n                                                            ${crearSelect2({\n                                                                opciones: [\n                                                                    { nombre: 'Todos', id: '' },\n                                                                    { nombre: 'Activo', id: '1' },\n                                                                    { nombre: 'Inactivo', id: '2' },\n                                                                    { nombre: 'Próximo', id: '3' },\n                                                                    { nombre: 'Por vencer', id: '4' },\n                                                                    { nombre: 'Vencido', id: '5' },\n                                                                    { nombre: 'Renovando', id: '6' },\n                                                                ],\n                                                                opcion_vacia: false,\n                                                                id: 'estado_plan_filtro_seleccion',\n                                                                class: 'select2-filtro filtro',\n                                                                input_container_class: 'mb-0',\n                                                                data: [\n                                                                    { texto: 'filtro', value: 'Estado del plan'}\n                                                                ]\n                                                            })}\n                                                        </div>\n                                                    </div>\n                                                `,\n                                            }\n                                        })}\n                                    </div>\n                                    <div class=\"col-auto\" id=\"seleccion-totales-unidades\">\n                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>\n                                    </div>\n                                    <div class=\"col-auto\" id=\"seleccion-totales-ofertas\">\n                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>\n\n                                    </div>\n                                    <div class=\"col-auto ms-auto\">\n                                        ${crearBoton({ id: 'boton-descargar-historial-compras-seleccion', clases: 'btn-outline-success', texto: '<img class=\"me-3\" src=\"{{ asset('/iconos/excel_icon.svg') }}\"> Exportar todo' })}\n                                    </div>\n                                `,\n                            })}\n                        </div>\n                    `,\n                    activo: true\n                },\n                {\n                    id: 'pestana-compras-organizacional',\n                    icono: `<i class=\"bi bi-briefcase-fill text-headline-4 me-3\"></i>`,\n                    titulo: `Organizacional`,\n                    contenido: `\n                        <div class=\"col-12 mt-5\">\n                            ${crearTabla({\n                                id: 'tabla-compras-organizacional',\n                                registros_paginas: true,\n                                input_container_class: 'mb-0',\n                                filtro: crearFiltroDropdown({\n                                    id: 'filtro_dropdown_organizacional',\n                                    name: 'filtro_dropdown_organizacional',\n                                    type: 'text',\n                                    value: '',\n                                    class: 'filtro-chips',\n                                    input_container_class: 'mb-0',\n                                    placeholder: 'Buscar',\n                                    icono: '<i class=\"bi bi-search input-icono1\"></i>',\n                                    icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n                                    dropdown: {\n                                        titulo: 'Filtros avanzados',\n                                        contenido: `\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Duración</div>\n                                                <div class=\"col-7\">\n                                                    ${crearSelect2({\n                                                        opciones: [\n                                                            { nombre: 'Todos', id: '' },\n                                                            { nombre: 'Con tiempo', id: 'con-tiempo' },\n                                                            { nombre: 'Sin tiempo', id: 'sin-tiempo' },\n                                                        ],\n                                                        opcion_vacia: false,\n                                                        id: 'duracion_filtro_organizacional',\n                                                        class: 'select2-filtro filtro',\n                                                        input_container_class: 'mb-0',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Duración'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Fecha de activación</div>\n                                                <div class=\"col-7\">\n                                                    ${crearDatePicker({\n                                                        id: 'fecha_activacion_filtro_organizacional',\n                                                        class: 'flatpickr-range filtro',\n                                                        input_container_class: 'mb-1',\n                                                        placeholder: 'Desde - hasta',\n                                                        disabled: false,\n                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Fecha de activación'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Fecha de vencimiento</div>\n                                                <div class=\"col-7\">\n                                                    ${crearDatePicker({\n                                                        id: 'fecha_vencimiento_filtro_organizacional',\n                                                        class: 'flatpickr-range filtro',\n                                                        input_container_class: 'mb-1',\n                                                        placeholder: 'Desde - hasta',\n                                                        disabled: false,\n                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Fecha de vencimiento'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Estado del plan</div>\n                                                <div class=\"col-7\">\n                                                    ${crearSelect2({\n                                                        opciones: [\n                                                            { nombre: 'Todos', id: '' },\n                                                            { nombre: 'Activo', id: '1' },\n                                                            { nombre: 'Inactivo', id: '2' },\n                                                            { nombre: 'Próximo', id: '3' },\n                                                            { nombre: 'Por vencer', id: '4' },\n                                                            { nombre: 'Vencido', id: '5' },\n                                                            { nombre: 'Renovando', id: '6' },\n                                                        ],\n                                                        opcion_vacia: false,\n                                                        id: 'estado_plan_filtro_organizacional',\n                                                        class: 'select2-filtro filtro',\n                                                        input_container_class: 'mb-0',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Estado del plan'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                        `,\n                                    }\n                                }),\n                                issubtabla: '.desplegarSubRow',\n                                botones: `\n                                    <div class=\"col-auto\" id=\"organizacional-totales-unidades\">\n                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>\n                                    </div>\n                                    <div class=\"col-auto\" id=\"organizacional-totales-ofertas\">\n                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>\n                                    </div>\n                                    <div class=\"col-auto ms-auto\">\n                                        ${crearBoton({ id: 'boton-descargar-historial-compras-organizacional', clases: 'btn-outline-success', texto: '<img class=\"me-3\" src=\"{{ asset('/iconos/excel_icon.svg') }}\"> Exportar todo' })}\n                                    </div>\n                                `,\n                                chips: `\n                                    <div class=\"col-12\">\n                                        <div class=\"row align-items-center w-100 mx-0 contenedor-chips my-2\" id=\"contenedor-chips-filtro_dropdown_organizacional\"></div>\n                                    </div>\n                                `\n                            })}\n                        </div>\n                    `,\n                },\n                {\n                    id: 'pestana-compras-vocacional',\n                    icono: `<i class=\"bi bi-person-fill text-headline-4 me-3\"></i>`,\n                    titulo: `Vocacional`,\n                    contenido: `\n                        <div class=\"col-12 mt-5\">\n                            ${crearTabla({\n                                id: 'tabla-compras-vocacional',\n                                registros_paginas: true,\n                                input_container_class: 'mb-0',\n                                filtro: crearFiltroDropdown({\n                                    id: 'filtro_dropdown_vocacional',\n                                    name: 'filtro_dropdown_vocacional',\n                                    type: 'text',\n                                    value: '',\n                                    class: 'filtro-chips',\n                                    input_container_class: 'mb-0',\n                                    placeholder: 'Buscar',\n                                    icono: '<i class=\"bi bi-search input-icono1\"></i>',\n                                    icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n                                    dropdown: {\n                                        titulo: 'Filtros avanzados',\n                                        contenido: `\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Duración</div>\n                                                <div class=\"col-7\">\n                                                    ${crearSelect2({\n                                                        opciones: [\n                                                            { nombre: 'Todos', id: '' },\n                                                            { nombre: 'Con tiempo', id: 'con-tiempo' },\n                                                            { nombre: 'Sin tiempo', id: 'sin-tiempo' },\n                                                        ],\n                                                        opcion_vacia: false,\n                                                        id: 'duracion_filtro_vocacional',\n                                                        class: 'select2-filtro filtro',\n                                                        input_container_class: 'mb-0',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Duración'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Fecha de activación</div>\n                                                <div class=\"col-7\">\n                                                    ${crearDatePicker({\n                                                        id: 'fecha_activacion_filtro_vocacional',\n                                                        class: 'flatpickr-range filtro',\n                                                        input_container_class: 'mb-1',\n                                                        placeholder: 'Desde - hasta',\n                                                        disabled: false,\n                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Fecha de activación'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Fecha de vencimiento</div>\n                                                <div class=\"col-7\">\n                                                    ${crearDatePicker({\n                                                        id: 'fecha_vencimiento_filtro_vocacional',\n                                                        class: 'flatpickr-range filtro',\n                                                        input_container_class: 'mb-1',\n                                                        placeholder: 'Desde - hasta',\n                                                        disabled: false,\n                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Fecha de vencimiento'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Estado del plan</div>\n                                                <div class=\"col-7\">\n                                                    ${crearSelect2({\n                                                        opciones: [\n                                                            { nombre: 'Todos', id: '' },\n                                                            { nombre: 'Activo', id: '1' },\n                                                            { nombre: 'Inactivo', id: '2' },\n                                                            { nombre: 'Próximo', id: '3' },\n                                                            { nombre: 'Por vencer', id: '4' },\n                                                            { nombre: 'Vencido', id: '5' },\n                                                            { nombre: 'Renovando', id: '6' },\n                                                        ],\n                                                        opcion_vacia: false,\n                                                        id: 'estado_plan_filtro_vocacional',\n                                                        class: 'select2-filtro filtro',\n                                                        input_container_class: 'mb-0',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Estado del plan'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                        `,\n                                    }\n                                }),\n                                issubtabla: '.desplegarSubRow',\n                                botones: `\n                                    <div class=\"col-auto\" id=\"vocacional-totales-unidades\">\n                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>\n                                    </div>\n                                    <div class=\"col-auto\" id=\"vocacional-totales-ofertas\">\n                                        <p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>\n                                    </div>\n                                    <div class=\"col-auto ms-auto\">\n                                        ${crearBoton({ id: 'boton-descargar-historial-compras-vocacional', clases: 'btn-outline-success', texto: '<img class=\"me-3\" src=\"{{ asset('/iconos/excel_icon.svg') }}\"> Exportar todo' })}\n                                    </div>\n                                `,\n                                chips: `\n                                    <div class=\"col-12\">\n                                        <div class=\"row align-items-center w-100 mx-0 contenedor-chips my-2\" id=\"contenedor-chips-filtro_dropdown_vocacional\"></div>\n                                    </div>\n                                `\n                            })}\n                        </div>  \n                    `,\n                },\n                {\n                    id: 'pestana-compras-creditos',\n                    icono: `<img class=\"me-3\" src=\"{{ asset('/iconos/icono_ia.svg') }}\" width=\"20\" height=\"20\" alt=\"Icono IA\">`,\n                    titulo: `Créditos IA`,\n                    contenido: `\n                        <div class=\"col-12 mt-5\">\n                            ${crearTabla({\n                                id: 'tabla-compras-creditos',\n                                registros_paginas: true,\n                                input_container_class: 'mb-0',\n                                filtro: crearFiltroDropdown({\n                                    id: 'filtro_dropdown_creditos',\n                                    name: 'filtro_dropdown_creditos',\n                                    type: 'text',\n                                    value: '',\n                                    class: 'filtro-chips',\n                                    input_container_class: 'mb-0',\n                                    placeholder: 'Buscar',\n                                    icono: '<i class=\"bi bi-search input-icono1\"></i>',\n                                    icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n                                    dropdown: {\n                                        titulo: 'Filtros avanzados',\n                                        contenido: `\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Duración</div>\n                                                <div class=\"col-7\">\n                                                    ${crearSelect2({\n                                                        opciones: [\n                                                            { nombre: 'Todos', id: '' },\n                                                            { nombre: 'Con tiempo', id: 'con_tiempo' },\n                                                            { nombre: 'Sin tiempo', id: 'sin_tiempo' },\n                                                        ],\n                                                        opcion_vacia: false,\n                                                        id: 'duracion_filtro_creditos',\n                                                        class: 'select2-filtro filtro',\n                                                        input_container_class: 'mb-0',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Duración'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Fecha de activación</div>\n                                                <div class=\"col-7\">\n                                                    ${crearDatePicker({\n                                                        id: 'fecha_activacion_filtro_creditos',\n                                                        class: 'flatpickr-range filtro',\n                                                        input_container_class: 'mb-1',\n                                                        placeholder: 'Desde - hasta',\n                                                        disabled: false,\n                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Fecha de activación'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Fecha de vencimiento</div>\n                                                <div class=\"col-7\">\n                                                    ${crearDatePicker({\n                                                        id: 'fecha_vencimiento_filtro_creditos',\n                                                        class: 'flatpickr-range filtro',\n                                                        input_container_class: 'mb-1',\n                                                        placeholder: 'Desde - hasta',\n                                                        disabled: false,\n                                                        icono: '<i class=\"bi bi-calendar4 input-icono1 text-gray-30 pointer\"></i>',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Fecha de vencimiento'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                            <div class=\"row mt-4\">\n                                                <div class=\"col-5 pt-2\">Estado del plan</div>\n                                                <div class=\"col-7\">\n                                                    ${crearSelect2({\n                                                        opciones: [\n                                                            { nombre: 'Todos', id: '' },\n                                                            { nombre: 'Activo', id: '1' },\n                                                            { nombre: 'Inactivo', id: '2' },\n                                                            { nombre: 'Próximo', id: '3' },\n                                                            { nombre: 'Por vencer', id: '4' },\n                                                            { nombre: 'Vencido', id: '5' },\n                                                            { nombre: 'Renovando', id: '6' },\n                                                        ],\n                                                        opcion_vacia: false,\n                                                        id: 'estado_plan_filtro_creditos',\n                                                        class: 'select2-filtro filtro',\n                                                        input_container_class: 'mb-0',\n                                                        data: [\n                                                            { texto: 'filtro', value: 'Estado del plan'}\n                                                        ]\n                                                    })}\n                                                </div>\n                                            </div>\n                                        `,\n                                    }\n                                }),\n                                issubtabla: '.desplegarSubRow',\n                                botones: `\n                                    <div class=\"col-auto\" id=\"creditos-totales\">\n                                        <p class=\"text-label-2 mb-1\"><img class=\"me-2\" src=\"{{ asset('/iconos/icono_ia.svg') }}\" width=\"16\" height=\"16\" alt=\"Icono IA\">Créditos totales</p>\n                                    </div>\n                                    <div class=\"col-auto ms-auto\">\n                                        ${crearBoton({ id: 'boton-descargar-historial-compras-creditos', clases: 'btn-outline-success', texto: '<img class=\"me-3\" src=\"{{ asset('/iconos/excel_icon.svg') }}\"> Exportar todo' })}\n                                    </div>\n                                `,\n                                chips: `\n                                    <div class=\"col-12\">\n                                        <div class=\"row align-items-center w-100 mx-0 contenedor-chips my-2\" id=\"contenedor-chips-filtro_dropdown_creditos\"></div>\n                                    </div>\n                                `\n                            })}\n                        </div>\n                    `,\n                },\n            ]\n        })}\n    `\n})}\n<div class=\"modal fade\" id=\"modal-filtros-avanzados-compras\" data-bs-backdrop=\"static\" tabindex=\"-1\" aria-labelledby=\"modal-filtros-avanzados-comprasLabel\" aria-hidden=\"true\">\n    <div class=\"modal-dialog modal-dialog-centered modal-md\">\n        <div class=\"modal-content rounded-4\">\n            <div class=\"modal-header border-0\">\n                <div class=\"row justify-content-between align-items-center m-0 w-100\">\n                    <div class=\"col-auto text-headline-4 mb-0\" id=\"modal-filtros-avanzados-comprasLabel\">Filtros avanzados</div>\n                    <div class=\"col-auto px-3 py-2 pointer\" data-bs-dismiss=\"modal\" aria-label=\"Close\">\n                        <i class=\"bi bi-x-lg\"></i>\n                    </div>\n                </div>\n            </div>\n            <div class=\"modal-body pt-0\">\n                <div class=\"row w-100 mx-0\">\n                    <div class=\"col-4 pt-2\">Duración:</div>\n                    <div class=\"col-8\">\n                        <div class=\"row\">\n                            <div class=\"col-12\">\n                                <div class=\"input-container mb-2\">\n                                    <select id=\"filtro-duracion\">\n                                        <option value=\"\">Seleccionar duración...</option>\n                                        <option value=\"con-tiempo\">Con tiempo</option>\n                                        <option value=\"sin-tiempo\">Sin tiempo</option>\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row w-100 mx-0\">\n                    <div class=\"col-4 pt-2\">Fecha de activación:</div>\n                    <div class=\"col-8\">\n                        <div class=\"input-container mb-5\">\n                            <input class=\"rounded-2 text-body-2 flatpickr-range bg-transparent\" id=\"filtro-fecha-activacion\" placeholder=\"dd/mm/aaaa\">\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row w-100 mx-0\">\n                    <div class=\"col-4 pt-2\">Fecha de vencimiento:</div>\n                    <div class=\"col-8\">\n                        <div class=\"input-container mb-5\">\n                            <input class=\"rounded-2 text-body-2 flatpickr-range bg-transparent\" id=\"filtro-fecha-vencimiento\" placeholder=\"dd/mm/aaaa\">\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row w-100 mx-0\">\n                    <div class=\"col-4 pt-2\">Estado del plan:</div>\n                    <div class=\"col-8\">\n                        <div class=\"row\">\n                            <div class=\"col-12\">\n                                <div class=\"input-container mb-2\">\n                                    <select id=\"filtro-estado-plan\">\n                                        <option value=\"\">Seleccionar estado del plan...</option>\n                                        <option value=\"1\">Activo</option>\n                                        <option value=\"2\">Inactivo</option>\n                                        <option value=\"3\">Próximo</option>\n                                        <option value=\"4\">Por vencer</option>\n                                        <option value=\"5\">Vencido</option>\n                                        <option value=\"6\">Renovando</option>\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row m-0 w-100\">\n                    <button type=\"button\" class=\"col btn btn-outline-primary me-1 pt-2 text-center d-block\" data-bs-dismiss=\"modal\" aria-label=\"Close\" onclick=\"borrarFiltrosAvanzadosCompras()\">\n                        Borrar filtros\n                    </button>\n                    <button type=\"button\" class=\"col btn btn-primary ms-1 pt-2 text-center d-block\" onclick=\"aplicarFiltrosAvanzadosCompras()\">\n                        Aplicar filtros\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n","numLines":583,"startLine":1,"totalLines":583}},"sourceToolAssistantUUID":"1da9cfe7-6c56-4d3f-a86f-bd58d74c6427"}
{"parentUuid":"4fd4c16e-174e-4f06-8f0e-a5b17abbe91c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01We4zH17kuUcv5WR8ea62U6","type":"tool_result","content":"     1→\n     2→const MODAL_FILTROS_AVANZADOS_COMPRAS_ID = 'modal-filtros-avanzados-compras';\n     3→const MODAL_HISTORIAL_COMPRAS_ID = 'modal-historial-recompras';\n     4→\n     5→const FILTRO_DURACION_ID = 'filtro-duracion';\n     6→const FILTRO_FECHA_ACTIVACION_ID = 'filtro-fecha-activacion';\n     7→const FILTRO_FECHA_VENCIMIENTO_ID = 'filtro-fecha-vencimiento';\n     8→const FILTRO_ESTADO_PLAN_ID = 'filtro-estado-plan';\n     9→\n    10→const convertirFecha = fecha => {\n    11→    if (!fecha) return \"Fecha no válida\";\n    12→    if (typeof fecha !== \"string\") {\n    13→        fecha = String(fecha);\n    14→    }\n    15→    return fecha.includes('-') ? fecha.split('-').reverse().join('-') : \"Formato incorrecto\";\n    16→};\n    17→\n    18→let compras_seleccionadas_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] };\n    19→\n    20→let compras_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] }\n    21→\n    22→let compras = [];\n    23→\n    24→// Variables globales para filtros de cada tabla\n    25→let filtros_seleccion = {};\n    26→let filtros_organizacional = {};\n    27→let filtros_vocacional = {};\n    28→let filtros_creditos = {};\n    29→\n    30→let filtro_html_seleccion = '';\n    31→let filtro_html_organizacional = '';\n    32→let filtro_html_vocacional = '';\n    33→let filtro_html_creditos = '';\n    34→\n    35→$(document).ready(() => {\n    36→    $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));\n    37→    $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });\n    38→    $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });\n    39→    $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });\n    40→    $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });\n    41→\n    42→});\n    43→\n    44→/**\n    45→ * Renderiza la modal de historial de compras de planes de empresa.\n    46→ *\n    47→ * @param {number} empresa_id ID de la empresa.\n    48→ * @param {boolean} recarga verifica si tiene que recargar.\n    49→ * @param {string} tabla nombre de la tabla.\n    50→ * @param {string} filtro filtros para la busqueda.\n    51→ * @returns {void}\n    52→ * @author Andres Morales\n    53→ */\n    54→async function modalHistorialCompras(id_empresa, recarga = false, tabla = '', filtro = {}) {\n    55→    let historial_compras = await getHistorialCompras(id_empresa, filtro);\n    56→    let historial_creditos = await getHistorialComprasCreditos(id_empresa, filtro);\n    57→\n    58→    if (tabla === '' || tabla === 'seleccion') {\n    59→        await renderizarTablas(historial_compras[1], 'seleccion');\n    60→        establecerEventoDescargarComprasExcel('seleccion');\n    61→    }\n    62→\n    63→    if (tabla === '' || tabla === 'organizacional') {\n    64→        await renderizarTablas(historial_compras[2], 'organizacional');\n    65→        establecerEventoDescargarComprasExcel('organizacional');\n    66→    }\n    67→\n    68→    if (tabla === '' || tabla === 'vocacional') {\n    69→        await renderizarTablas(historial_compras[3], 'vocacional');\n    70→        establecerEventoDescargarComprasExcel('vocacional');\n    71→    }\n    72→\n    73→    if (tabla === '' || tabla === 'creditos') {\n    74→        await renderizarTablaCreditos(historial_creditos, 'creditos');\n    75→        establecerEventoDescargarComprasExcel('creditos');\n    76→    }\n    77→\n    78→    if (!recarga) {\n    79→        $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n    80→    }\n    81→\n    82→    cargarDataTablas();\n    83→    inicializarTooltips();\n    84→}\n    85→\n    86→\n    87→/**\n    88→ * Obtener historial de recompras de planes de empresa.\n    89→ *\n    90→ * @param {number} empresa_id ID de la empresa.\n    91→ * @returns {array}\n    92→ * @author Daniel Beltrán\n    93→ * @author Andres Morales\n    94→ */\n    95→async function getHistorialCompras(empresa_id, filtros = {}) {\n    96→    let datos = [];\n    97→    let agrupadosPorTipoPrueba = {\n    98→        1: [],\n    99→        2: [],\n   100→        3: [],\n   101→    };\n   102→    await $.ajax({\n   103→        type: 'GET',\n   104→        url : `/planes-historial-recompras/${empresa_id}`,\n   105→        data: filtros\n   106→    }).then(respuesta => {\n   107→        datos = respuesta.data || [];\n   108→        datos.forEach(item => {\n   109→            let tipoPruebaNombre = item.plan.tipo_prueba.id;\n   110→            agrupadosPorTipoPrueba[tipoPruebaNombre].push(item);\n   111→        });\n   112→    }).catch((error) => {\n   113→        console.error(error);\n   114→    });\n   115→    return agrupadosPorTipoPrueba;\n   116→}\n   117→\n   118→/**\n   119→ * Obtener historial de compras de planes con creditos.\n   120→ *\n   121→ * @param {number} empresa_id ID de la empresa.\n   122→ * @param {Object} filtros Filtros aplicados.\n   123→ * @returns {array}\n   124→ * @author Sergio Vargas\n   125→ */\n   126→async function getHistorialComprasCreditos(empresa_id, filtros = {}) {\n   127→    let datos = [];\n   128→\n   129→    await $.ajax({\n   130→        type: 'GET',\n   131→        url: `/planes-historial-recompras-creditos/${empresa_id}`,\n   132→        data: filtros\n   133→    }).then(respuesta => {\n   134→        datos = respuesta.data || [];\n   135→    }).catch((error) => {\n   136→        console.error(error);\n   137→    });\n   138→\n   139→    return datos;\n   140→}\n   141→\n   142→/**\n   143→ * Renderiza las distintas tablas de compras.\n   144→ *\n   145→ * @param {array} datos_entrada Array de datos a renderizar.\n   146→ * @param {string} nombre_tabla Nombre de la tabla.\n   147→ * @returns {void}\n   148→ * @author Andres Morales\n   149→ */\n   150→async function renderizarTablas(datos_entrada, nombre_tabla) {\n   151→    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n   152→    compras_ids[nombre_tabla] = [];\n   153→    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n   154→    let totalUnidades = datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_agendas || 0), 0);\n   155→    let totalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_ofertas_laborales || 0), 0);\n   156→    let baseTotalUnidades =  datos_entrada.reduce((total, dato) => total + (dato.unidades || 0), 0);\n   157→    let baseTotalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.cantidad_ofertas_laborales || 0), 0);\n   158→    $(`#${nombre_tabla}-totales-unidades`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>${crearProgressBar({ label: `${totalUnidades}/${baseTotalUnidades}`,height: '8px', porcentaje: {porcentaje: (totalUnidades / (baseTotalUnidades ?? 1)) * 100, texto:false }})}`);\n   159→    $(`#${nombre_tabla}-totales-ofertas`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>${crearProgressBar({ label: `${totalOfertas}/${baseTotalOfertas}`,height: '8px', porcentaje: {porcentaje: (totalOfertas / (baseTotalOfertas ?? 1)) * 100, texto:false }})}`);\n   160→    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n   161→        ...configuracion_tablas,\n   162→        data: datos_entrada,\n   163→        columns: [\n   164→            {\n   165→                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n   166→                data: null,\n   167→                orderable: false,\n   168→                searchable: false,\n   169→                render: (dato) => `\n   170→                    ${crearCheckbox({\n   171→                        id: `${dato.id}`,\n   172→                        class: 'checkbox-compra',\n   173→                        name: 'checkbox',\n   174→                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n   175→                    })}\n   176→                `,\n   177→             },\n   178→            {\n   179→                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n   180→                data: null,\n   181→                className: 'nombre-plan-columna',\n   182→                orderable: false,\n   183→                render: (dato) => `\n   184→                    <div class=\"row\">\n   185→                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n   186→                            ${crearBoton({\n   187→                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n   188→                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n   189→                                data: [{ texto: 'id', value: dato.id }],\n   190→                            })}\n   191→                        </div>\n   192→                        <div class=\"col pe-0\">\n   193→                            <span class=\"text-body-3\">${dato.plan.nombre}</span>\n   194→                        </div>\n   195→                    </div>\n   196→                `,\n   197→            },\n   198→            {\n   199→                title: '<span class=\"text-body-3\">Vigencia</span>',\n   200→                data: null,\n   201→                className: 'vigencia-columna',\n   202→                orderable: false,\n   203→                render:  (dato) => `\n   204→                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n   205→                    ${dato.fecha_inicio ? `\n   206→                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n   207→                    `: ''}\n   208→                `,\n   209→            },\n   210→            {\n   211→                title: '<span class=\"text-body-3\">Duración</span>',\n   212→                data: null,\n   213→                orderable: false,\n   214→                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias} dias</span>`\n   215→            },\n   216→            {\n   217→                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-box\"></i> Consumo unidades</span>`,\n   218→                data: null,\n   219→                orderable: false,\n   220→                render: (dato) => `<div ${tooltipConsumoUnidades(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_agendas, dato.unidades ?? 0, false)}</div>`,\n   221→            },\n   222→            {\n   223→                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-briefcase\"></i> Consumo vacantes</span>`,\n   224→                data: null,\n   225→                orderable: false,\n   226→                render: (dato) => `<div ${tooltipConsumoOfertas(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_ofertas_laborales, dato.cantidad_ofertas_laborales ?? 0, false)}</div>`,\n   227→            },\n   228→            {\n   229→                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-person\"></i> Consumo usuarios</span>`,\n   230→                data: null,\n   231→                orderable: false,\n   232→                render: (dato) => `<div ${tooltipConsumoUsuarios(usuarios)}>${crearProgressBarTemplate('', false, total_usuarios, dato.cantidad_usuarios ?? 0, false)}</div>`,\n   233→            },\n   234→            {\n   235→                title: '<span class=\"text-body-3\">Ver factura</span>',\n   236→                data: null,\n   237→                orderable: false,\n   238→                searchable: false,\n   239→                render: (dato) => `\n   240→                    ${crearBoton({\n   241→                        clases: 'btn-text-primary btn-circle p-2',\n   242→                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n   243→                        onclick: `abrirFacturaPlan(${dato?.archivos[0]?.id})`,\n   244→                    })}\n   245→                `,\n   246→            },\n   247→            {\n   248→                title: '<span class=\"text-body-3\">Acciones</span>',\n   249→                data: null,\n   250→                orderable: false,\n   251→                searchable: false,\n   252→                render: (dato) => `\n   253→                    ${crearBoton({\n   254→                        clases: 'btn-text-primary btn-circle p-2',\n   255→                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n   256→                        onclick: `abrirModalConsumos(${dato.id}, '${dato.plan.nombre}', '${dato.plan.tipo_prueba.nombre}')`,\n   257→                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n   258→                    })}\n   259→                `,\n   260→            }\n   261→        ],\n   262→        drawCallback: function(settings) {\n   263→            inicializarTooltips();\n   264→        },\n   265→    });\n   266→}\n   267→\n   268→/**\n   269→ * Renderiza la tabla de compras de creditos.\n   270→ *\n   271→ * @param {array} datos_entrada Array de datos a renderizar.\n   272→ * @param {string} nombre_tabla Nombre de la tabla.\n   273→ * @returns {void}\n   274→ * @author Sergio Vargas\n   275→ */\n   276→async function renderizarTablaCreditos(datos_entrada, nombre_tabla) {\n   277→    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n   278→    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n   279→\n   280→    let total_consumidos = datos_entrada.reduce((total, dato) => total + (dato.creditos_consumidos || 0), 0);\n   281→    let total_creditos = datos_entrada.reduce((total, dato) => total + (dato.creditos_totales || 0), 0);\n   282→    let porcentaje_total = total_creditos > 0 ? (total_consumidos / total_creditos) * 100 : 0;\n   283→\n   284→    $('#creditos-totales')\n   285→        .empty()\n   286→        .append(`\n   287→            <p class=\"text-label-2 mb-1\"><img class=\"me-2\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\">Créditos totales</p>\n   288→            ${crearProgressBar({ label: `${formatearNumero(total_consumidos)}/${formatearNumero(total_creditos)}`, height: '8px', porcentaje: { porcentaje: porcentaje_total, texto: false }})}\n   289→        `);\n   290→\n   291→    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n   292→        ...configuracion_tablas,\n   293→        data: datos_entrada,\n   294→        columns: [\n   295→            {\n   296→                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n   297→                data: null,\n   298→                orderable: false,\n   299→                searchable: false,\n   300→                render: (dato) => `\n   301→                    ${crearCheckbox({\n   302→                        id: `${dato.id}`,\n   303→                        class: 'checkbox-compra',\n   304→                        name: 'checkbox',\n   305→                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n   306→                    })}\n   307→                `,\n   308→            },\n   309→            {\n   310→                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n   311→                data: null,\n   312→                className: 'nombre-plan-columna',\n   313→                orderable: false,\n   314→                render: (dato) => `\n   315→                    <div class=\"row\">\n   316→                        <div class=\"col pe-0\">\n   317→                            <span class=\"text-body-3\">${dato.plan_credito?.nombre ?? '---'}</span>\n   318→                        </div>\n   319→                    </div>\n   320→                `,\n   321→            },\n   322→            {\n   323→                title: '<span class=\"text-body-3\">Vigencia</span>',\n   324→                data: null,\n   325→                className: 'vigencia-columna',\n   326→                orderable: false,\n   327→                render:  (dato) => `\n   328→                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n   329→                    ${dato.fecha_inicio ? `\n   330→                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n   331→                    `: ''}\n   332→                `,\n   333→            },\n   334→            {\n   335→                title: '<span class=\"text-body-3\">Duración</span>',\n   336→                data: null,\n   337→                orderable: false,\n   338→                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias ? `${dato.vigencia_dias} dias` : 'Sin tiempo'}</span>`\n   339→            },\n   340→            {\n   341→                title: `<span class=\"text-body-3\"><img class=\"me-1\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\"> Consumo créditos</span>`,\n   342→                data: null,\n   343→                orderable: false,\n   344→                render: (dato) => {\n   345→                    let total = dato.creditos_totales ?? 0;\n   346→                    let consumidos = dato.creditos_consumidos ?? 0;\n   347→                    return `${crearProgressBarTemplate('', false, consumidos, total, false)}`;\n   348→                },\n   349→            },\n   350→            {\n   351→                title: '<span class=\"text-body-3\">Ver factura</span>',\n   352→                data: null,\n   353→                orderable: false,\n   354→                searchable: false,\n   355→                render: (dato) => `\n   356→                    ${crearBoton({\n   357→                        clases: 'btn-text-primary btn-circle p-2',\n   358→                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n   359→                        onclick: `abrirFacturaPlan(${dato?.archivos[0]?.id})`,\n   360→                    })}\n   361→                `,\n   362→            },\n   363→            {\n   364→                title: '<span class=\"text-body-3\">Acciones</span>',\n   365→                data: null,\n   366→                orderable: false,\n   367→                searchable: false,\n   368→                render: (dato) => `\n   369→                    ${crearBoton({\n   370→                        clases: 'btn-text-primary btn-circle p-2',\n   371→                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n   372→                        onclick: `abrirModalConsumosCreditos(${dato.id}, '${dato.plan_credito?.nombre ?? ''}')`,\n   373→                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n   374→                    })}\n   375→                `,\n   376→            }\n   377→        ],\n   378→        drawCallback: function(settings) {\n   379→            inicializarTooltips();\n   380→        },\n   381→    });\n   382→}\n   383→\n   384→/**\n   385→ * Renderiza el contenido de las subtablas.\n   386→ *\n   387→ * @param {array} data Array de datos a renderizar.\n   388→ * @returns {string} HTML de la subtabla.\n   389→ * @author Andres Morales\n   390→ */\n   391→function crearContenidoSubTabla(data) {\n   392→    let pruebas_html = \"\";\n   393→    data.pruebas.forEach(prueba => {\n   394→        pruebas_html += `\n   395→            <div class=\"col-12 my-2 col-md-6 d-flex justify-content-start align-items-center gap-3\">\n   396→                <img src=\"/imagenes/logos/pruebas/${slugify(prueba.nombre)}.png\" width=\"32px\" height=\"32px\" class=\"object-fit-cover\" alt=\"Logo prueba\">\n   397→                <p class=\"mb-0 text-label-2\">${prueba.nombre}</p>\n   398→            </div>\n   399→        `;\n   400→    });\n   401→\n   402→    let funcionalidades_predeterminadas_html = \"\";\n   403→    data.funcionalidades.forEach(funcionalidad => {\n   404→        if (funcionalidad.predeterminado) funcionalidades_predeterminadas_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n   405→    });\n   406→\n   407→    let funcionalidades_html = \"\";\n   408→    data.funcionalidades.forEach(funcionalidad => {\n   409→        if (!funcionalidad.predeterminado) funcionalidades_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n   410→    });\n   411→\n   412→    return `\n   413→        <div class=\"row w-100 my-3 ps-8\">\n   414→            <div class=\"col-4\">\n   415→                <p class=\"text-body-3 fw-bolder\">Pruebas</p>\n   416→                <div class=\"row\">\n   417→                    ${pruebas_html}\n   418→                </div>\n   419→            </div>\n   420→            <div class=\"col-8\">\n   421→                <div class=\"container-fluid\">\n   422→                    <div class=\"row border-bottom pb-2\">\n   423→                        <div class=\"col-4\">\n   424→                            <p class=\"mb-0\"><span class=\"fw-bolder\">Costo:</span> <br> $ ${formatearNumero(data.precio)}</p>\n   425→                        </div>\n   426→                        <div class=\"col-4\">\n   427→                            <p class=\"mb-0\"><span class=\"fw-bolder\">Descuento:</span> <br> ${data.porcentaje_descuento !== 0 ? data.porcentaje_descuento + '%' : `Sin descuento`}</p>\n   428→                        </div>\n   429→                         <div class=\"col-4\">\n   430→                            <p class=\"mb-0\"><span class=\"fw-bolder\">Valor de venta:</span> <br> $ ${data.porcentaje_descuento !== 0 ? formatearNumero(data.precio * (1 - (data.porcentaje_descuento / 100))) : formatearNumero(data.precio) }</p>\n   431→                        </div>\n   432→                    </div>\n   433→                    <div class=\"row\">\n   434→                        <div class=\"col-6 text-label-1 border-bottom\">\n   435→                            <p class=\"my-3\">Beneficios adicionales</p>\n   436→                        </div>\n   437→                        <div class=\"col-6 text-label-1 border-bottom\">\n   438→                            <p class=\"my-3\">Beneficios predefinidos</p>\n   439→                        </div>\n   440→                        <div class=\"col-6 text-label-1\">\n   441→                            <p>${funcionalidades_html}</p>\n   442→                        </div>\n   443→                        <div class=\"col-6 text-label-1\">\n   444→                            <p>${funcionalidades_predeterminadas_html}</p>\n   445→                        </div>\n   446→                    </div>\n   447→                </div>\n   448→            </div>\n   449→        </div>\n   450→    `;\n   451→}\n   452→\n   453→/**\n   454→ * Abrir detalle de consumo de creditos.\n   455→ *\n   456→ * @param {number} empresa_plan_id ID del plan de empresa.\n   457→ * @param {string} nombre_plan Nombre del plan.\n   458→ * @returns {void}\n   459→ * @author Sergio Vargas\n   460→ */\n   461→function abrirModalConsumosCreditos(empresa_plan_id, nombre_plan) {\n   462→    mostrarToast('info', `Detalle de consumo para ${nombre_plan} en desarrollo`);\n   463→}\n   464→\n   465→/**\n   466→ * Generar el tooltip de consumo de unidades.\n   467→ *\n   468→ * @param {array} consumos Array de datos.\n   469→ * @returns {string} componente tooltip.\n   470→ * @author Andres Morales\n   471→ */\n   472→function tooltipConsumoUnidades(consumos) {\n   473→    var agrupado = consumos.reduce((acc, item) => {\n   474→        if(item.agenda && item.agenda.prueba) {\n   475→          var { id, nombre } = item.agenda.prueba;\n   476→          var key = `${id}-${nombre}`;\n   477→          if(!acc[key]) {\n   478→            acc[key] = { prueba_id: id, prueba_nombre: nombre, cantidad: 0 };\n   479→          }\n   480→          acc[key].cantidad++;\n   481→        }\n   482→        return acc;\n   483→    }, {});\n   484→\n   485→    var resultado = Object.values(agrupado);\n   486→    let tooltip = '';\n   487→    if (resultado.length > 0) {\n   488→        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n   489→        tooltip = `\n   490→        <div class='row text-white'>\n   491→            <div class='col-12 d-flex justify-content-between mb-3'>\n   492→                <span class='text-body-3 text-white'>Cantidad consumida</span>\n   493→                <span class='text-body-3 text-white'>${total}</span>\n   494→            </div>\n   495→            ${resultado.map(item => `\n   496→                <div class='col-12 d-flex justify-content-between mb-3'>\n   497→                    <span class='text-body-3 text-white'>\n   498→                        <img src='/imagenes/logos/pruebas/${slugify(item.prueba_nombre)}.png' width='22px' height='22px' class='object-fit-cover me-2' alt='>\n   499→                    </span>\n   500→                    <span class='text-body-3 text-white'>\n   501→                        ${item.prueba_nombre}\n   502→                    </span>\n   503→                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n   504→                </div>\n   505→            `).join('')}\n   506→        </div>\n   507→    `;\n   508→    } else {\n   509→        tooltip = `\n   510→            <div class='row text-white'>\n   511→                <div class='col-12 d-flex justify-content-between'>\n   512→                    <span class='text-body-3 text-white me-3'>Cantidad consumida</span>\n   513→                    <span class='text-body-3 text-white'>0</span>\n   514→                </div>\n   515→            </div>\n   516→        `;\n   517→    }\n   518→\n   519→    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n   520→}\n   521→\n   522→/**\n   523→ * Generar el tooltip de consumo de ofertas.\n   524→ *\n   525→ * @param {array} consumos Array de datos.\n   526→ * @returns {string} componente tooltip.\n   527→ * @author Andres Morales\n   528→ */\n   529→function tooltipConsumoOfertas(consumos) {\n   530→    const resultado = Object.values(\n   531→        consumos.filter(item => item.oferta_laboral_id !== null).reduce((acc, item) => {\n   532→            const key = `${item.empresa.id}-${item.empresa.nombre_comercial}`;\n   533→            if (!acc[key]) {\n   534→              acc[key] = {\n   535→                empresa_id: item.empresa.id,\n   536→                empresa_nombre_comercial: item.empresa.nombre_comercial,\n   537→                cantidad: 0\n   538→              };\n   539→            }\n   540→            acc[key].cantidad++;\n   541→            return acc;\n   542→        }, {})\n   543→    );\n   544→    let tooltip = '';\n   545→    if (resultado.length > 0) {\n   546→        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n   547→        tooltip = `\n   548→        <div class='row text-white'>\n   549→            <div class='col-12 d-flex justify-content-between mb-3'>\n   550→                <span class='text-body-3 text-white text-start'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n   551→                <span class='text-body-3 text-white'>${total}</span>\n   552→            </div>\n   553→            ${resultado.map(item => `\n   554→                <div class='col-12 d-flex justify-content-between mb-3'>\n   555→                    <span class='text-body-3 text-white text-start'>\n   556→                        ${item.empresa_nombre_comercial}\n   557→                    </span>\n   558→                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n   559→                </div>\n   560→            `).join('')}\n   561→        </div>\n   562→    `;\n   563→    } else {\n   564→        tooltip = `\n   565→            <div class='row text-white'>\n   566→                <div class='col-12 d-flex justify-content-between'>\n   567→                    <span class='text-body-3 text-white text-start me-3'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n   568→                    <span class='text-body-3 text-white'>0</span>\n   569→                </div>\n   570→            </div>\n   571→        `;\n   572→    }\n   573→\n   574→    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n   575→}\n   576→\n   577→/**\n   578→ * Generar el tooltip de consumo de usuarios.\n   579→ *\n   580→ * @param {array} usuarios Array de datos.\n   581→ * @returns {string} componente tooltip.\n   582→ * @author Andres Morales\n   583→ */\n   584→function tooltipConsumoUsuarios(usuarios) {\n   585→    const agrupado = usuarios.reduce((acc, usuario) => {\n   586→        if (Array.isArray(usuario.empresas_usuarios)) {\n   587→          // Recorremos las empresas del usuario y contamos sólo la primera que no tenga id 1\n   588→          for (let i = 0; i < usuario.empresas_usuarios.length; i++) {\n   589→            const { id, nombre_comercial } = usuario.empresas_usuarios[i].empresa;\n   590→            if (id === 1) continue; // omitir la empresa con id 1\n   591→            const key = `${id}-${nombre_comercial}`;\n   592→            if (!acc[key]) {\n   593→              acc[key] = {\n   594→                empresa_id: id,\n   595→                nombre_comercial,\n   596→                cantidad: 0\n   597→              };\n   598→            }\n   599→            acc[key].cantidad++;\n   600→            // Una vez que se cuenta el usuario para una empresa, salimos del ciclo\n   601→            break;\n   602→          }\n   603→        }\n   604→        return acc;\n   605→      }, {});\n   606→\n   607→      const resultado = Object.values(agrupado);\n   608→\n   609→    let tooltip = '';\n   610→    if (resultado.length > 0) {\n   611→        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n   612→        tooltip = `\n   613→        <div class='row text-white'>\n   614→            <div class='col-12 d-flex justify-content-between mb-3'>\n   615→                <span class='text-body-3 text-white text-start'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n   616→                <span class='text-body-3 text-white'>${total}</span>\n   617→            </div>\n   618→            ${resultado.map(item => `\n   619→                <div class='col-12 d-flex justify-content-between mb-3'>\n   620→                    <span class='text-body-3 text-white text-start'>\n   621→                        ${item.nombre_comercial}\n   622→                    </span>\n   623→                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n   624→                </div>\n   625→            `).join('')}\n   626→        </div>\n   627→    `;\n   628→    } else {\n   629→        tooltip = `\n   630→            <div class='row text-white'>\n   631→                <div class='col-12 d-flex justify-content-between'>\n   632→                    <span class='text-body-3 text-white text-start me-3'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n   633→                    <span class='text-body-3 text-white'>0</span>\n   634→                </div>\n   635→            </div>\n   636→        `;\n   637→    }\n   638→\n   639→    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n   640→}\n   641→\n   642→/**\n   643→ * Aplicar los filtros a las compras.\n   644→ *\n   645→ * @returns {void}\n   646→ * @author Fahibram Cárcamo\n   647→ */\n   648→function aplicarFiltrosAvanzadosCompras() {\n   649→    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('hide');\n   650→    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n   651→}\n   652→\n   653→/**\n   654→ * Abrir el modal de filtros de compras.\n   655→ *\n   656→ * @returns {void}\n   657→ * @author Fahibram Cárcamo\n   658→ */\n   659→function abrirModalFiltrosAvanzadosCompras() {\n   660→    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('hide');\n   661→    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('show');\n   662→}\n   663→\n   664→/**\n   665→ * Seleccionar una compra.\n   666→ *\n   667→ * @param {boolean} seleccion Selección.\n   668→ * @param {number} compra_id Id de la compra seleccionada.\n   669→ * @param {string} tabla_compras_id Id del elemento html de la tabla de compras.\n   670→ * @param {string} nombre_tabla Nombre de la tabla.\n   671→ * @returns {void}\n   672→ * @author Fahibram Cárcamo\n   673→ */\n   674→function seleccionarCompra(seleccion, compra_id, tabla_compras_id, nombre_tabla) {\n   675→    if (seleccion) {\n   676→        compras_seleccionadas_ids[nombre_tabla].push(parseInt(compra_id));\n   677→    } else {\n   678→        let indice = compras_seleccionadas_ids[nombre_tabla].indexOf(compra_id);\n   679→        if (indice !== -1) compras_seleccionadas_ids[nombre_tabla].splice(indice, 1);\n   680→    }\n   681→\n   682→    let checkbox_seleccionar_todos = $(`#checkbox-seleccionar-todos-${tabla_compras_id}`);\n   683→    if (compras_seleccionadas_ids[nombre_tabla].length === compras_ids[nombre_tabla].length) {\n   684→        checkbox_seleccionar_todos.prop('indeterminate', false);\n   685→        checkbox_seleccionar_todos.prop('checked', true);\n   686→    } else if (compras_seleccionadas_ids[nombre_tabla].length === 0) {\n   687→        checkbox_seleccionar_todos.prop('indeterminate', false);\n   688→        checkbox_seleccionar_todos.prop('checked', false);\n   689→    } else {\n   690→        checkbox_seleccionar_todos.prop('indeterminate', true);\n   691→    }\n   692→}\n   693→\n   694→/**\n   695→ * Seleccionar todas las compras.\n   696→ *\n   697→ * @param {boolean} seleccion Selección\n   698→ * @param {string} nombre_tabla Nombre de la tabla\n   699→ * @returns {void}\n   700→ * @author Fahibram Cárcamo\n   701→ * @author Andres Morales\n   702→ */\n   703→function seleccionarTodasCompras(seleccion, nombre_tabla) {\n   704→    if (!seleccion) compras_seleccionadas_ids[nombre_tabla] = [];\n   705→    let checkboxes_compras = $(`#tabla-compras-${nombre_tabla}`).find(\".checkbox-compra\").toArray();\n   706→    checkboxes_compras.forEach(checkbox => {\n   707→        checkbox.checked = seleccion;\n   708→        if (seleccion && !compras_seleccionadas_ids[nombre_tabla].includes(checkbox.id)) {\n   709→            compras_seleccionadas_ids[nombre_tabla].push(parseInt(checkbox.id));\n   710→        }\n   711→    });\n   712→}\n   713→\n   714→/**\n   715→ * Establecer el evento para el botón de descarga del archivo Excel.\n   716→ *\n   717→ * @param {string} nombre_tabla Nombre de la tabla\n   718→ * @returns {void}\n   719→ * @author Fahibram Cárcamo\n   720→ */\n   721→function establecerEventoDescargarComprasExcel(nombre_tabla) {\n   722→    $(`#boton-descargar-historial-compras-${nombre_tabla}`).off('click');\n   723→    $(`#boton-descargar-historial-compras-${nombre_tabla}`).on('click', () => {\n   724→        if (nombre_tabla === 'creditos') {\n   725→            mostrarToast('info', 'Exportación de créditos en desarrollo');\n   726→            return;\n   727→        }\n   728→        let empresas_planes_ids = compras_seleccionadas_ids[nombre_tabla].length ? [...compras_seleccionadas_ids[nombre_tabla]] : [...compras_ids[nombre_tabla]];\n   729→        descargarExcel(\n   730→            'planes-historial-recompras-exportar',\n   731→            `compras_${nombre_tabla}`,\n   732→            true,\n   733→            empresas_planes_ids.length ? { empresas_planes_ids, empresa_id } : { empresa_id }\n   734→        );\n   735→    });\n   736→}\n   737→\n   738→/**\n   739→ * Procesar los filtros de las tablas de compras.\n   740→ *\n   741→ * @param {Object} json_filtros Filtros aplicados del dropdown\n   742→ * @param {string} tabla Nombre de la tabla\n   743→ * @returns {Object} Datos procesados para enviar al backend\n   744→ * @author Andres Morales\n   745→ */\n   746→function procesarFiltrosTabla(json_filtros, tabla) {\n   747→    let datos = {};\n   748→\n   749→    if (json_filtros[`estado_plan_filtro_${tabla}`]) {\n   750→        datos.estado_id = json_filtros[`estado_plan_filtro_${tabla}`];\n   751→    }\n   752→\n   753→    if (json_filtros[`duracion_filtro_${tabla}`]) {\n   754→        datos.duracion = json_filtros[`duracion_filtro_${tabla}`];\n   755→    }\n   756→\n   757→    if (json_filtros[`fecha_vencimiento_filtro_${tabla}`] && typeof json_filtros[`fecha_vencimiento_filtro_${tabla}`] === 'string') {\n   758→        const partesFechaVencimiento = json_filtros[`fecha_vencimiento_filtro_${tabla}`].split(' a ');\n   759→        if (partesFechaVencimiento[0]) {\n   760→            datos.fecha_vencimiento_desde = partesFechaVencimiento[0];\n   761→        }\n   762→        if (partesFechaVencimiento[1]) {\n   763→            datos.fecha_vencimiento_hasta = partesFechaVencimiento[1];\n   764→        }\n   765→    }\n   766→\n   767→    if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n   768→        const partesFechaActivacion = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n   769→        if (partesFechaActivacion[0]) {\n   770→            datos.fecha_inicio_desde = partesFechaActivacion[0];\n   771→        }\n   772→        if (partesFechaActivacion[1]) {\n   773→            datos.fecha_inicio_hasta = partesFechaActivacion[1];\n   774→        }\n   775→    }\n   776→\n   777→    return datos;\n   778→}\n   779→\n   780→/**\n   781→ * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n   782→ *\n   783→ * @param {string} filtro ID del elemento html del filtro\n   784→ * @param {Object} filtros Filtros aplicados\n   785→ * @returns {void}\n   786→ * @author Andres Morales\n   787→ */\n   788→function aplicarFiltrosDropdown(filtro, filtros) {\n   789→    let filtros_generados = {};\n   790→\n   791→    if (filtro === 'filtro_unidades_pruebas') {\n   792→        filtro_html = filtro;\n   793→        json_filtros = filtros;\n   794→        actualizarDatatables('tabla-consumos-unidades-pruebas');\n   795→    } else if (filtro === 'filtro_dropdown_seleccion') {\n   796→        filtro_html_seleccion = filtro;\n   797→        filtros_seleccion = filtros;\n   798→        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n   799→        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n   800→    } else if (filtro === 'filtro_dropdown_organizacional') {\n   801→        filtro_html_organizacional = filtro;\n   802→        filtros_organizacional = filtros;\n   803→        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n   804→        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n   805→    } else if (filtro === 'filtro_dropdown_vocacional') {\n   806→        filtro_html_vocacional = filtro;\n   807→        filtros_vocacional = filtros;\n   808→        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n   809→        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n   810→    } else if (filtro === 'filtro_dropdown_creditos') {\n   811→        filtro_html_creditos = filtro;\n   812→        filtros_creditos = filtros;\n   813→        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n   814→        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n   815→    }\n   816→}\n   817→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ae23b63a-f408-4b81-944e-c8d139a249aa","timestamp":"2026-01-21T15:03:24.936Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js","content":"\nconst MODAL_FILTROS_AVANZADOS_COMPRAS_ID = 'modal-filtros-avanzados-compras';\nconst MODAL_HISTORIAL_COMPRAS_ID = 'modal-historial-recompras';\n\nconst FILTRO_DURACION_ID = 'filtro-duracion';\nconst FILTRO_FECHA_ACTIVACION_ID = 'filtro-fecha-activacion';\nconst FILTRO_FECHA_VENCIMIENTO_ID = 'filtro-fecha-vencimiento';\nconst FILTRO_ESTADO_PLAN_ID = 'filtro-estado-plan';\n\nconst convertirFecha = fecha => {\n    if (!fecha) return \"Fecha no válida\";\n    if (typeof fecha !== \"string\") {\n        fecha = String(fecha);\n    }\n    return fecha.includes('-') ? fecha.split('-').reverse().join('-') : \"Formato incorrecto\";\n};\n\nlet compras_seleccionadas_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] };\n\nlet compras_ids = { seleccion: [], organizacional: [], vocacional: [], creditos: [] }\n\nlet compras = [];\n\n// Variables globales para filtros de cada tabla\nlet filtros_seleccion = {};\nlet filtros_organizacional = {};\nlet filtros_vocacional = {};\nlet filtros_creditos = {};\n\nlet filtro_html_seleccion = '';\nlet filtro_html_organizacional = '';\nlet filtro_html_vocacional = '';\nlet filtro_html_creditos = '';\n\n$(document).ready(() => {\n    $('#boton-modal-recompras').on('click', () => modalHistorialCompras(empresa_id));\n    $(document).on('click', '#pestana-compras-seleccion', async () => { ajustarRenderDataTable('tabla-compras-seleccion') });\n    $(document).on('click', '#pestana-compras-organizacional', async () => { ajustarRenderDataTable('tabla-compras-organizacional') });\n    $(document).on('click', '#pestana-compras-vocacional', async () => { ajustarRenderDataTable('tabla-compras-vocacional') });\n    $(document).on('click', '#pestana-compras-creditos', async () => { ajustarRenderDataTable('tabla-compras-creditos') });\n\n});\n\n/**\n * Renderiza la modal de historial de compras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {boolean} recarga verifica si tiene que recargar.\n * @param {string} tabla nombre de la tabla.\n * @param {string} filtro filtros para la busqueda.\n * @returns {void}\n * @author Andres Morales\n */\nasync function modalHistorialCompras(id_empresa, recarga = false, tabla = '', filtro = {}) {\n    let historial_compras = await getHistorialCompras(id_empresa, filtro);\n    let historial_creditos = await getHistorialComprasCreditos(id_empresa, filtro);\n\n    if (tabla === '' || tabla === 'seleccion') {\n        await renderizarTablas(historial_compras[1], 'seleccion');\n        establecerEventoDescargarComprasExcel('seleccion');\n    }\n\n    if (tabla === '' || tabla === 'organizacional') {\n        await renderizarTablas(historial_compras[2], 'organizacional');\n        establecerEventoDescargarComprasExcel('organizacional');\n    }\n\n    if (tabla === '' || tabla === 'vocacional') {\n        await renderizarTablas(historial_compras[3], 'vocacional');\n        establecerEventoDescargarComprasExcel('vocacional');\n    }\n\n    if (tabla === '' || tabla === 'creditos') {\n        await renderizarTablaCreditos(historial_creditos, 'creditos');\n        establecerEventoDescargarComprasExcel('creditos');\n    }\n\n    if (!recarga) {\n        $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n    }\n\n    cargarDataTablas();\n    inicializarTooltips();\n}\n\n\n/**\n * Obtener historial de recompras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @returns {array}\n * @author Daniel Beltrán\n * @author Andres Morales\n */\nasync function getHistorialCompras(empresa_id, filtros = {}) {\n    let datos = [];\n    let agrupadosPorTipoPrueba = {\n        1: [],\n        2: [],\n        3: [],\n    };\n    await $.ajax({\n        type: 'GET',\n        url : `/planes-historial-recompras/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n        datos.forEach(item => {\n            let tipoPruebaNombre = item.plan.tipo_prueba.id;\n            agrupadosPorTipoPrueba[tipoPruebaNombre].push(item);\n        });\n    }).catch((error) => {\n        console.error(error);\n    });\n    return agrupadosPorTipoPrueba;\n}\n\n/**\n * Obtener historial de compras de planes con creditos.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {Object} filtros Filtros aplicados.\n * @returns {array}\n * @author Sergio Vargas\n */\nasync function getHistorialComprasCreditos(empresa_id, filtros = {}) {\n    let datos = [];\n\n    await $.ajax({\n        type: 'GET',\n        url: `/planes-historial-recompras-creditos/${empresa_id}`,\n        data: filtros\n    }).then(respuesta => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Renderiza las distintas tablas de compras.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Andres Morales\n */\nasync function renderizarTablas(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = [];\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n    let totalUnidades = datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_agendas || 0), 0);\n    let totalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.conteo_consumos_ofertas_laborales || 0), 0);\n    let baseTotalUnidades =  datos_entrada.reduce((total, dato) => total + (dato.unidades || 0), 0);\n    let baseTotalOfertas =  datos_entrada.reduce((total, dato) => total + (dato.cantidad_ofertas_laborales || 0), 0);\n    $(`#${nombre_tabla}-totales-unidades`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-box-fill text-headline-5 me-2\"></i>Unidades totales</p>${crearProgressBar({ label: `${totalUnidades}/${baseTotalUnidades}`,height: '8px', porcentaje: {porcentaje: (totalUnidades / (baseTotalUnidades ?? 1)) * 100, texto:false }})}`);\n    $(`#${nombre_tabla}-totales-ofertas`).empty().append(`<p class=\"text-label-2 mb-1\"><i class=\"bi bi-briefcase-fill text-headline-5 me-2\"></i>Ofertar totales</p>${crearProgressBar({ label: `${totalOfertas}/${baseTotalOfertas}`,height: '8px', porcentaje: {porcentaje: (totalOfertas / (baseTotalOfertas ?? 1)) * 100, texto:false }})}`);\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n             },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n                                data: [{ texto: 'id', value: dato.id }],\n                            })}\n                        </div>\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan.nombre}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias} dias</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-box\"></i> Consumo unidades</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUnidades(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_agendas, dato.unidades ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-briefcase\"></i> Consumo vacantes</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoOfertas(dato.consumos)}>${crearProgressBarTemplate('', false, dato.conteo_consumos_ofertas_laborales, dato.cantidad_ofertas_laborales ?? 0, false)}</div>`,\n            },\n            {\n                title: `<span class=\"text-body-3\"><i class=\"text-headline-5 bi bi-person\"></i> Consumo usuarios</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => `<div ${tooltipConsumoUsuarios(usuarios)}>${crearProgressBarTemplate('', false, total_usuarios, dato.cantidad_usuarios ?? 0, false)}</div>`,\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos[0]?.id})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumos(${dato.id}, '${dato.plan.nombre}', '${dato.plan.tipo_prueba.nombre}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n}\n\n/**\n * Renderiza la tabla de compras de creditos.\n *\n * @param {array} datos_entrada Array de datos a renderizar.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Sergio Vargas\n */\nasync function renderizarTablaCreditos(datos_entrada, nombre_tabla) {\n    destruirTablaExistente(`tabla-compras-${nombre_tabla}`);\n    compras_ids[nombre_tabla] = datos_entrada.map(dato => dato.id);\n\n    let total_consumidos = datos_entrada.reduce((total, dato) => total + (dato.creditos_consumidos || 0), 0);\n    let total_creditos = datos_entrada.reduce((total, dato) => total + (dato.creditos_totales || 0), 0);\n    let porcentaje_total = total_creditos > 0 ? (total_consumidos / total_creditos) * 100 : 0;\n\n    $('#creditos-totales')\n        .empty()\n        .append(`\n            <p class=\"text-label-2 mb-1\"><img class=\"me-2\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\">Créditos totales</p>\n            ${crearProgressBar({ label: `${formatearNumero(total_consumidos)}/${formatearNumero(total_creditos)}`, height: '8px', porcentaje: { porcentaje: porcentaje_total, texto: false }})}\n        `);\n\n    await $(`#tabla-compras-${nombre_tabla}`).DataTable({\n        ...configuracion_tablas,\n        data: datos_entrada,\n        columns: [\n            {\n                title: `${crearCheckbox({ id: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, name: `checkbox-seleccionar-todos-tabla-compras-${nombre_tabla}`, onclick: `seleccionarTodasCompras(this.checked, '${nombre_tabla}')`, })}`,\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearCheckbox({\n                        id: `${dato.id}`,\n                        class: 'checkbox-compra',\n                        name: 'checkbox',\n                        onclick: `seleccionarCompra(this.checked, ${dato.id}, 'tabla-compras-${nombre_tabla}', '${nombre_tabla}')`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Nombre del plan</span>',\n                data: null,\n                className: 'nombre-plan-columna',\n                orderable: false,\n                render: (dato) => `\n                    <div class=\"row\">\n                        <div class=\"col pe-0\">\n                            <span class=\"text-body-3\">${dato.plan_credito?.nombre ?? '---'}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Vigencia</span>',\n                data: null,\n                className: 'vigencia-columna',\n                orderable: false,\n                render:  (dato) => `\n                    <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-green-cta me-2\"></i>${dato.fecha_inicio ? convertirFecha(dato.fecha_inicio) : 'Ilimitado'}</p>\n                    ${dato.fecha_inicio ? `\n                        <p class=\"text-label-1 p-0 m-0\"><i class=\"bi bi-circle-fill small text-danger me-2\"></i>${dato.fecha_vencimiento ? convertirFecha(dato.fecha_vencimiento) : 'Ilimitado'}</p>\n                    `: ''}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Duración</span>',\n                data: null,\n                orderable: false,\n                render: (dato) => `<span class=\"text-body-3\">${dato.vigencia_dias ? `${dato.vigencia_dias} dias` : 'Sin tiempo'}</span>`\n            },\n            {\n                title: `<span class=\"text-body-3\"><img class=\"me-1\" src=\"/iconos/icono_ia.svg\" width=\"16\" height=\"16\" alt=\"Icono IA\"> Consumo créditos</span>`,\n                data: null,\n                orderable: false,\n                render: (dato) => {\n                    let total = dato.creditos_totales ?? 0;\n                    let consumidos = dato.creditos_consumidos ?? 0;\n                    return `${crearProgressBarTemplate('', false, consumidos, total, false)}`;\n                },\n            },\n            {\n                title: '<span class=\"text-body-3\">Ver factura</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-paperclip text-headline-5\"></i>',\n                        onclick: `abrirFacturaPlan(${dato?.archivos[0]?.id})`,\n                    })}\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                orderable: false,\n                searchable: false,\n                render: (dato) => `\n                    ${crearBoton({\n                        clases: 'btn-text-primary btn-circle p-2',\n                        texto: '<i class=\"bi bi-eye text-headline-5\"></i>',\n                        onclick: `abrirModalConsumosCreditos(${dato.id}, '${dato.plan_credito?.nombre ?? ''}')`,\n                        tooltip: ` ${crearTooltip({placement: `top`,content: `Ver detalle consumo`,toggle: `popover`,})}`,\n                    })}\n                `,\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n}\n\n/**\n * Renderiza el contenido de las subtablas.\n *\n * @param {array} data Array de datos a renderizar.\n * @returns {string} HTML de la subtabla.\n * @author Andres Morales\n */\nfunction crearContenidoSubTabla(data) {\n    let pruebas_html = \"\";\n    data.pruebas.forEach(prueba => {\n        pruebas_html += `\n            <div class=\"col-12 my-2 col-md-6 d-flex justify-content-start align-items-center gap-3\">\n                <img src=\"/imagenes/logos/pruebas/${slugify(prueba.nombre)}.png\" width=\"32px\" height=\"32px\" class=\"object-fit-cover\" alt=\"Logo prueba\">\n                <p class=\"mb-0 text-label-2\">${prueba.nombre}</p>\n            </div>\n        `;\n    });\n\n    let funcionalidades_predeterminadas_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (funcionalidad.predeterminado) funcionalidades_predeterminadas_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    let funcionalidades_html = \"\";\n    data.funcionalidades.forEach(funcionalidad => {\n        if (!funcionalidad.predeterminado) funcionalidades_html += `<span class=\"fw-bolder\">∙</span> ${funcionalidad.nombre}<br>`;\n    });\n\n    return `\n        <div class=\"row w-100 my-3 ps-8\">\n            <div class=\"col-4\">\n                <p class=\"text-body-3 fw-bolder\">Pruebas</p>\n                <div class=\"row\">\n                    ${pruebas_html}\n                </div>\n            </div>\n            <div class=\"col-8\">\n                <div class=\"container-fluid\">\n                    <div class=\"row border-bottom pb-2\">\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Costo:</span> <br> $ ${formatearNumero(data.precio)}</p>\n                        </div>\n                        <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Descuento:</span> <br> ${data.porcentaje_descuento !== 0 ? data.porcentaje_descuento + '%' : `Sin descuento`}</p>\n                        </div>\n                         <div class=\"col-4\">\n                            <p class=\"mb-0\"><span class=\"fw-bolder\">Valor de venta:</span> <br> $ ${data.porcentaje_descuento !== 0 ? formatearNumero(data.precio * (1 - (data.porcentaje_descuento / 100))) : formatearNumero(data.precio) }</p>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios adicionales</p>\n                        </div>\n                        <div class=\"col-6 text-label-1 border-bottom\">\n                            <p class=\"my-3\">Beneficios predefinidos</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_html}</p>\n                        </div>\n                        <div class=\"col-6 text-label-1\">\n                            <p>${funcionalidades_predeterminadas_html}</p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Abrir detalle de consumo de creditos.\n *\n * @param {number} empresa_plan_id ID del plan de empresa.\n * @param {string} nombre_plan Nombre del plan.\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction abrirModalConsumosCreditos(empresa_plan_id, nombre_plan) {\n    mostrarToast('info', `Detalle de consumo para ${nombre_plan} en desarrollo`);\n}\n\n/**\n * Generar el tooltip de consumo de unidades.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUnidades(consumos) {\n    var agrupado = consumos.reduce((acc, item) => {\n        if(item.agenda && item.agenda.prueba) {\n          var { id, nombre } = item.agenda.prueba;\n          var key = `${id}-${nombre}`;\n          if(!acc[key]) {\n            acc[key] = { prueba_id: id, prueba_nombre: nombre, cantidad: 0 };\n          }\n          acc[key].cantidad++;\n        }\n        return acc;\n    }, {});\n\n    var resultado = Object.values(agrupado);\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white'>Cantidad consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white'>\n                        <img src='/imagenes/logos/pruebas/${slugify(item.prueba_nombre)}.png' width='22px' height='22px' class='object-fit-cover me-2' alt='>\n                    </span>\n                    <span class='text-body-3 text-white'>\n                        ${item.prueba_nombre}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white me-3'>Cantidad consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de ofertas.\n *\n * @param {array} consumos Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoOfertas(consumos) {\n    const resultado = Object.values(\n        consumos.filter(item => item.oferta_laboral_id !== null).reduce((acc, item) => {\n            const key = `${item.empresa.id}-${item.empresa.nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: item.empresa.id,\n                empresa_nombre_comercial: item.empresa.nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            return acc;\n        }, {})\n    );\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.empresa_nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><img class='me-2' src='/iconos/briefcase-search.svg'>Cantidad de vacantes consumidas</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Generar el tooltip de consumo de usuarios.\n *\n * @param {array} usuarios Array de datos.\n * @returns {string} componente tooltip.\n * @author Andres Morales\n */\nfunction tooltipConsumoUsuarios(usuarios) {\n    const agrupado = usuarios.reduce((acc, usuario) => {\n        if (Array.isArray(usuario.empresas_usuarios)) {\n          // Recorremos las empresas del usuario y contamos sólo la primera que no tenga id 1\n          for (let i = 0; i < usuario.empresas_usuarios.length; i++) {\n            const { id, nombre_comercial } = usuario.empresas_usuarios[i].empresa;\n            if (id === 1) continue; // omitir la empresa con id 1\n            const key = `${id}-${nombre_comercial}`;\n            if (!acc[key]) {\n              acc[key] = {\n                empresa_id: id,\n                nombre_comercial,\n                cantidad: 0\n              };\n            }\n            acc[key].cantidad++;\n            // Una vez que se cuenta el usuario para una empresa, salimos del ciclo\n            break;\n          }\n        }\n        return acc;\n      }, {});\n\n      const resultado = Object.values(agrupado);\n\n    let tooltip = '';\n    if (resultado.length > 0) {\n        let total = resultado.reduce((acc, item) => acc + item.cantidad, 0);\n        tooltip = `\n        <div class='row text-white'>\n            <div class='col-12 d-flex justify-content-between mb-3'>\n                <span class='text-body-3 text-white text-start'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                <span class='text-body-3 text-white'>${total}</span>\n            </div>\n            ${resultado.map(item => `\n                <div class='col-12 d-flex justify-content-between mb-3'>\n                    <span class='text-body-3 text-white text-start'>\n                        ${item.nombre_comercial}\n                    </span>\n                    <span class='text-body-3 text-white'>${item.cantidad}</span>\n                </div>\n            `).join('')}\n        </div>\n    `;\n    } else {\n        tooltip = `\n            <div class='row text-white'>\n                <div class='col-12 d-flex justify-content-between'>\n                    <span class='text-body-3 text-white text-start me-3'><i class='bi bi-person me-1'></i>Cantidad usuarios consumida</span>\n                    <span class='text-body-3 text-white'>0</span>\n                </div>\n            </div>\n        `;\n    }\n\n    return crearTooltip({ placement: `bottom`, content: tooltip, toggle: `popover`,});\n}\n\n/**\n * Aplicar los filtros a las compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction aplicarFiltrosAvanzadosCompras() {\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Abrir el modal de filtros de compras.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalFiltrosAvanzadosCompras() {\n    $(`#${MODAL_HISTORIAL_COMPRAS_ID}`).modal('hide');\n    $(`#${MODAL_FILTROS_AVANZADOS_COMPRAS_ID}`).modal('show');\n}\n\n/**\n * Seleccionar una compra.\n *\n * @param {boolean} seleccion Selección.\n * @param {number} compra_id Id de la compra seleccionada.\n * @param {string} tabla_compras_id Id del elemento html de la tabla de compras.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction seleccionarCompra(seleccion, compra_id, tabla_compras_id, nombre_tabla) {\n    if (seleccion) {\n        compras_seleccionadas_ids[nombre_tabla].push(parseInt(compra_id));\n    } else {\n        let indice = compras_seleccionadas_ids[nombre_tabla].indexOf(compra_id);\n        if (indice !== -1) compras_seleccionadas_ids[nombre_tabla].splice(indice, 1);\n    }\n\n    let checkbox_seleccionar_todos = $(`#checkbox-seleccionar-todos-${tabla_compras_id}`);\n    if (compras_seleccionadas_ids[nombre_tabla].length === compras_ids[nombre_tabla].length) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', true);\n    } else if (compras_seleccionadas_ids[nombre_tabla].length === 0) {\n        checkbox_seleccionar_todos.prop('indeterminate', false);\n        checkbox_seleccionar_todos.prop('checked', false);\n    } else {\n        checkbox_seleccionar_todos.prop('indeterminate', true);\n    }\n}\n\n/**\n * Seleccionar todas las compras.\n *\n * @param {boolean} seleccion Selección\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nfunction seleccionarTodasCompras(seleccion, nombre_tabla) {\n    if (!seleccion) compras_seleccionadas_ids[nombre_tabla] = [];\n    let checkboxes_compras = $(`#tabla-compras-${nombre_tabla}`).find(\".checkbox-compra\").toArray();\n    checkboxes_compras.forEach(checkbox => {\n        checkbox.checked = seleccion;\n        if (seleccion && !compras_seleccionadas_ids[nombre_tabla].includes(checkbox.id)) {\n            compras_seleccionadas_ids[nombre_tabla].push(parseInt(checkbox.id));\n        }\n    });\n}\n\n/**\n * Establecer el evento para el botón de descarga del archivo Excel.\n *\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction establecerEventoDescargarComprasExcel(nombre_tabla) {\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).off('click');\n    $(`#boton-descargar-historial-compras-${nombre_tabla}`).on('click', () => {\n        if (nombre_tabla === 'creditos') {\n            mostrarToast('info', 'Exportación de créditos en desarrollo');\n            return;\n        }\n        let empresas_planes_ids = compras_seleccionadas_ids[nombre_tabla].length ? [...compras_seleccionadas_ids[nombre_tabla]] : [...compras_ids[nombre_tabla]];\n        descargarExcel(\n            'planes-historial-recompras-exportar',\n            `compras_${nombre_tabla}`,\n            true,\n            empresas_planes_ids.length ? { empresas_planes_ids, empresa_id } : { empresa_id }\n        );\n    });\n}\n\n/**\n * Procesar los filtros de las tablas de compras.\n *\n * @param {Object} json_filtros Filtros aplicados del dropdown\n * @param {string} tabla Nombre de la tabla\n * @returns {Object} Datos procesados para enviar al backend\n * @author Andres Morales\n */\nfunction procesarFiltrosTabla(json_filtros, tabla) {\n    let datos = {};\n\n    if (json_filtros[`estado_plan_filtro_${tabla}`]) {\n        datos.estado_id = json_filtros[`estado_plan_filtro_${tabla}`];\n    }\n\n    if (json_filtros[`duracion_filtro_${tabla}`]) {\n        datos.duracion = json_filtros[`duracion_filtro_${tabla}`];\n    }\n\n    if (json_filtros[`fecha_vencimiento_filtro_${tabla}`] && typeof json_filtros[`fecha_vencimiento_filtro_${tabla}`] === 'string') {\n        const partesFechaVencimiento = json_filtros[`fecha_vencimiento_filtro_${tabla}`].split(' a ');\n        if (partesFechaVencimiento[0]) {\n            datos.fecha_vencimiento_desde = partesFechaVencimiento[0];\n        }\n        if (partesFechaVencimiento[1]) {\n            datos.fecha_vencimiento_hasta = partesFechaVencimiento[1];\n        }\n    }\n\n    if (json_filtros[`fecha_activacion_filtro_${tabla}`] && typeof json_filtros[`fecha_activacion_filtro_${tabla}`] === 'string') {\n        const partesFechaActivacion = json_filtros[`fecha_activacion_filtro_${tabla}`].split(' a ');\n        if (partesFechaActivacion[0]) {\n            datos.fecha_inicio_desde = partesFechaActivacion[0];\n        }\n        if (partesFechaActivacion[1]) {\n            datos.fecha_inicio_hasta = partesFechaActivacion[1];\n        }\n    }\n\n    return datos;\n}\n\n/**\n * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n *\n * @param {string} filtro ID del elemento html del filtro\n * @param {Object} filtros Filtros aplicados\n * @returns {void}\n * @author Andres Morales\n */\nfunction aplicarFiltrosDropdown(filtro, filtros) {\n    let filtros_generados = {};\n\n    if (filtro === 'filtro_unidades_pruebas') {\n        filtro_html = filtro;\n        json_filtros = filtros;\n        actualizarDatatables('tabla-consumos-unidades-pruebas');\n    } else if (filtro === 'filtro_dropdown_seleccion') {\n        filtro_html_seleccion = filtro;\n        filtros_seleccion = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'seleccion');\n        modalHistorialCompras(empresa_id, true, 'seleccion', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_organizacional') {\n        filtro_html_organizacional = filtro;\n        filtros_organizacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'organizacional');\n        modalHistorialCompras(empresa_id, true, 'organizacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_vocacional') {\n        filtro_html_vocacional = filtro;\n        filtros_vocacional = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'vocacional');\n        modalHistorialCompras(empresa_id, true, 'vocacional', filtros_generados);\n    } else if (filtro === 'filtro_dropdown_creditos') {\n        filtro_html_creditos = filtro;\n        filtros_creditos = filtros;\n        filtros_generados = procesarFiltrosTabla(filtros, 'creditos');\n        modalHistorialCompras(empresa_id, true, 'creditos', filtros_generados);\n    }\n}\n","numLines":817,"startLine":1,"totalLines":817}},"sourceToolAssistantUUID":"4fd4c16e-174e-4f06-8f0e-a5b17abbe91c"}
{"parentUuid":"689a0c8e-9bac-4351-92c2-fb7a1e60d3e4","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XwwmpXrzBAQpAEgG1WKXWv","type":"tool_result","content":"Found 2 files\napp\\Http\\Controllers\\Planes\\PlanCreditoController.php\napp\\Http\\Controllers\\Empresas\\EmpresaPlanController.php"}]},"uuid":"79301621-938e-4bce-9bdd-395450eaa78c","timestamp":"2026-01-21T15:03:26.016Z","toolUseResult":{"mode":"files_with_matches","filenames":["app\\Http\\Controllers\\Planes\\PlanCreditoController.php","app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php"],"numFiles":2},"sourceToolAssistantUUID":"689a0c8e-9bac-4351-92c2-fb7a1e60d3e4"}
{"parentUuid":"79301621-938e-4bce-9bdd-395450eaa78c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q3njRkQa4LcGXa7KGRuvhL","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a revisar el controlador de EmpresaPlan para ver cómo se maneja la compra de créditos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":24282,"cache_read_input_tokens":78108,"cache_creation":{"ephemeral_5m_input_tokens":24282,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj8KD972MTBetDgv9Hz","type":"assistant","uuid":"3135dd4e-1985-4785-8657-833ac4e9afce","timestamp":"2026-01-21T15:03:30.171Z"}
{"parentUuid":"3135dd4e-1985-4785-8657-833ac4e9afce","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q3njRkQa4LcGXa7KGRuvhL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NneaafLvqtWsE7Pd9VMv34","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":24282,"cache_read_input_tokens":78108,"cache_creation":{"ephemeral_5m_input_tokens":24282,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj8KD972MTBetDgv9Hz","type":"assistant","uuid":"421c7c55-9880-44de-94e7-02efa0e8b0a2","timestamp":"2026-01-21T15:03:31.486Z"}
{"parentUuid":"421c7c55-9880-44de-94e7-02efa0e8b0a2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NneaafLvqtWsE7Pd9VMv34","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Empresas;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use Illuminate\\Http\\Request;\n     8→use App\\Exports\\GlobalExport;\n     9→use Illuminate\\Http\\JsonResponse;\n    10→use Illuminate\\Support\\Facades\\DB;\n    11→use App\\Http\\Controllers\\Controller;\n    12→use Maatwebsite\\Excel\\Facades\\Excel;\n    13→use Illuminate\\Support\\Facades\\Storage;\n    14→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    15→use App\\Http\\Requests\\Empresas\\AsignarPlanRequest;\n    16→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    17→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    18→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    19→use App\\Http\\Requests\\Empresas\\FacturarPlanRequest;\n    20→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    21→use Symfony\\Component\\HttpFoundation\\StreamedResponse;\n    22→use App\\Http\\Services\\IA\\ConsumoCreditoService;\n    23→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    24→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    25→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    26→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    27→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    28→use App\\Http\\Requests\\Empresas\\DescargarEmpresasPlanesRequest;\n    29→\n    30→class EmpresaPlanController extends Controller\n    31→{\n    32→    /**\n    33→     * Constructor.\n    34→     *\n    35→     * @param EmpresaPlanService $servicio Servicio de planes de empresa.\n    36→     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresa.\n    37→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n    38→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    39→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    40→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    41→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    42→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    43→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    44→     * @return void\n    45→     * @author Daniel Beltrán\n    46→     * @author Fahibram Cárcamo\n    47→     */\n    48→    public function __construct(\n    49→        private EmpresaPlanService $servicio,\n    50→        private EmpresaPlanRepository $repositorio,\n    51→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    52→        private RutaRepository $ruta_repositorio,\n    53→        private EmpresaRepository $empresa_repositorio,\n    54→        private UserRepository $usuario_repositorio,\n    55→        private PruebaRepository $prueba_repositorio,\n    56→        private PerfilRepository $perfil_repositorio,\n    57→        private ArchivoRepository $archivo_repositorio,\n    58→        private ConsumoCreditoService $consumo_credito_servicio\n    59→    ) {}\n    60→\n    61→    /**\n    62→     * Retornar la vista principal de los empresas_planes de todas las empresas.\n    63→     *\n    64→     * @return View\n    65→     * @author Fahibram Cárcamo\n    66→     */\n    67→    public function index(): View {\n    68→        // FIXME: Esta vista no debería estar en este controlador, debe estar en el controlador de consumos al igual que todo lo relacionado con ello\n    69→        return view('empresas.empresas-planes.index')->with([\n    70→            'rutas_menu'      => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n    71→            'empresas_planes' => $this->repositorio->datosConsumosEmpresas(new Request()),\n    72→            'ejecutivos'      => $this->usuario_repositorio->getEjecutivos(),\n    73→            'pruebas'         => $this->prueba_repositorio->getTodo(new Request()),\n    74→            'perfiles'        => $this->perfil_repositorio->getTodo(new Request())\n    75→        ]);\n    76→    }\n    77→\n    78→    /**\n    79→     * Datos de empresas_planes de todas las empresas como respuesta json.\n    80→     *\n    81→     * @param DescargarEmpresasPlanesRequest $request Contenido de la petición HTTP.\n    82→     * @return JsonResponse\n    83→     * @author Fahibram Cárcamo\n    84→     * @author Daniel Beltrán\n    85→     */\n    86→    public function planesEmpresas(DescargarEmpresasPlanesRequest $request): JsonResponse {\n    87→        return datatables()->of($this->repositorio->datosConsumosEmpresas($request))->toJson();\n    88→    }\n    89→\n    90→    /**\n    91→     * Exportar Excel de los datos de empresas_planes de todas las empresas.\n    92→     *\n    93→     * @param DescargarEmpresasPlanesRequest $request Contenido de la solicitud HTTP.\n    94→     * @return BinaryFileResponse\n    95→     * @author Fahibram Cárcamo\n    96→     */\n    97→    public function exportarExcelEmpresasPlanesEmpresas(DescargarEmpresasPlanesRequest $request): BinaryFileResponse {\n    98→        return Excel::download(\n    99→            new GlobalExport(\n   100→                ['ID', 'Número de sucursales', 'Empresa', 'Ejecutivo de cuenta', 'Plan', 'Pruebas', 'Unidades', 'Ofertas laborales', 'Tiempo', 'Usuarios', 'Vigencia', 'Estado', 'Costo', 'Descuento', 'Valor de venta'],\n   101→                $this->repositorio->datosConsumosEmpresas($request),\n   102→                'Empresas-planes de todas las empresas',\n   103→                'excel.empresas-planes.empresas-planes'\n   104→            ),\n   105→            'consumos-pruebas.xlsx'\n   106→        );\n   107→    }\n   108→\n   109→    /**\n   110→     * Obtener los planes de una empresa.\n   111→     *\n   112→     * @param int $empresa_id ID de la empresa.\n   113→     * @param Request $request Contenido de la petición.\n   114→     * @return JsonResponse\n   115→     * @author Daniel Beltrán\n   116→     */\n   117→    public function datosTabla(int $empresa_id, Request $request): JsonResponse {\n   118→        $request->merge([\n   119→            'empresa_id'                            => $empresa_id,\n   120→            'con_conteo_consumos_agendas'           => true,\n   121→            'con_conteo_consumos_ofertas_laborales' => true\n   122→        ]);\n   123→\n   124→        return new JsonResponse([\n   125→            'data' => [\n   126→                'empresas_planes'             => $this->repositorio->getTodo($request),\n   127→                'sucursales_consumos_agendas' => $this->empresa_repositorio\n   128→                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n   129→                        'empresa_id'       => $empresa_id,\n   130→                        'consumos_agendas' => true\n   131→                    ])),\n   132→                'sucursales_consumos_ofertas_laborales' => $this->empresa_repositorio\n   133→                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n   134→                        'empresa_id'                 => $empresa_id,\n   135→                        'consumos_ofertas_laborales' => true\n   136→                    ]))\n   137→            ]\n   138→        ], 200);\n   139→    }\n   140→\n   141→    /**\n   142→     * Obtener un plan de empresa.\n   143→     *\n   144→     * @param int $id ID del plan de empresa.\n   145→     * @return JsonResponse\n   146→     * @author Daniel Beltrán\n   147→     */\n   148→    public function show(int $id): JsonResponse {\n   149→        return new JsonResponse([\n   150→            'data' => $this->servicio->obtenerUnoConProximo($id)\n   151→        ]);\n   152→    }\n   153→\n   154→    /**\n   155→     * Cargar la página para asignar un plan a una empresa.\n   156→     *\n   157→     * @param int $empresa_id ID de la empresa.\n   158→     * @return View\n   159→     * @author Daniel Beltrán\n   160→     */\n   161→    public function formularioAsignar(int $empresa_id): View {\n   162→        return view('empresas.paginas.asignar-plan')->with([\n   163→            'empresa_id'    => $empresa_id,\n   164→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   165→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   166→            'empresa'       => $this->empresa_repositorio->getUno($empresa_id),\n   167→            'opcion'        => 'asignar'\n   168→        ]);\n   169→    }\n   170→\n   171→    /**\n   172→     * Cargar la página para editar un plan de empresa.\n   173→     *\n   174→     * @param int $id ID de el plan de empresa.\n   175→     * @return View\n   176→     * @author Daniel Beltrán\n   177→     */\n   178→    public function edit(int $id): View {\n   179→        $empresa_plan = $this->repositorio->getUno($id);\n   180→        return view('empresas.paginas.asignar-plan')->with([\n   181→            'empresa_id'    => $empresa_plan->empresa_id,\n   182→            'empresa_plan'  => $empresa_plan,\n   183→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   184→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   185→            'empresa'       => $this->empresa_repositorio->getUno($empresa_plan->empresa_id),\n   186→            'opcion'        => 'editar'\n   187→        ]);\n   188→    }\n   189→\n   190→    /**\n   191→     * Asignar plan a una empresa.\n   192→     *\n   193→     * @param AsignarPlanRequest $request Contenido de la petición.\n   194→     * @return JsonResponse\n   195→     * @author Daniel Beltrán\n   196→     */\n   197→    public function store(AsignarPlanRequest $request): JsonResponse {\n   198→        $codigo    = 201;\n   199→        $respuesta = [\n   200→            'message' => 'Plan asignado correctamente'\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d5824288-9956-421f-a2fb-2b82b6d6c102","timestamp":"2026-01-21T15:03:33.624Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","content":"<?php\n\nnamespace App\\Http\\Controllers\\Empresas;\n\nuse Exception;\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\Request;\nuse App\\Exports\\GlobalExport;\nuse Illuminate\\Http\\JsonResponse;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Http\\Controllers\\Controller;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse Illuminate\\Support\\Facades\\Storage;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Requests\\Empresas\\AsignarPlanRequest;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Pruebas\\PerfilRepository;\nuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\nuse App\\Http\\Requests\\Empresas\\FacturarPlanRequest;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse Symfony\\Component\\HttpFoundation\\StreamedResponse;\nuse App\\Http\\Services\\IA\\ConsumoCreditoService;\nuse App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\nuse Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\nuse App\\Http\\Repositories\\Configuraciones\\RutaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Requests\\Empresas\\DescargarEmpresasPlanesRequest;\n\nclass EmpresaPlanController extends Controller\n{\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanService $servicio Servicio de planes de empresa.\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresa.\n     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(\n        private EmpresaPlanService $servicio,\n        private EmpresaPlanRepository $repositorio,\n        private TipoPruebaRepository $tipo_prueba_repositorio,\n        private RutaRepository $ruta_repositorio,\n        private EmpresaRepository $empresa_repositorio,\n        private UserRepository $usuario_repositorio,\n        private PruebaRepository $prueba_repositorio,\n        private PerfilRepository $perfil_repositorio,\n        private ArchivoRepository $archivo_repositorio,\n        private ConsumoCreditoService $consumo_credito_servicio\n    ) {}\n\n    /**\n     * Retornar la vista principal de los empresas_planes de todas las empresas.\n     *\n     * @return View\n     * @author Fahibram Cárcamo\n     */\n    public function index(): View {\n        // FIXME: Esta vista no debería estar en este controlador, debe estar en el controlador de consumos al igual que todo lo relacionado con ello\n        return view('empresas.empresas-planes.index')->with([\n            'rutas_menu'      => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresas_planes' => $this->repositorio->datosConsumosEmpresas(new Request()),\n            'ejecutivos'      => $this->usuario_repositorio->getEjecutivos(),\n            'pruebas'         => $this->prueba_repositorio->getTodo(new Request()),\n            'perfiles'        => $this->perfil_repositorio->getTodo(new Request())\n        ]);\n    }\n\n    /**\n     * Datos de empresas_planes de todas las empresas como respuesta json.\n     *\n     * @param DescargarEmpresasPlanesRequest $request Contenido de la petición HTTP.\n     * @return JsonResponse\n     * @author Fahibram Cárcamo\n     * @author Daniel Beltrán\n     */\n    public function planesEmpresas(DescargarEmpresasPlanesRequest $request): JsonResponse {\n        return datatables()->of($this->repositorio->datosConsumosEmpresas($request))->toJson();\n    }\n\n    /**\n     * Exportar Excel de los datos de empresas_planes de todas las empresas.\n     *\n     * @param DescargarEmpresasPlanesRequest $request Contenido de la solicitud HTTP.\n     * @return BinaryFileResponse\n     * @author Fahibram Cárcamo\n     */\n    public function exportarExcelEmpresasPlanesEmpresas(DescargarEmpresasPlanesRequest $request): BinaryFileResponse {\n        return Excel::download(\n            new GlobalExport(\n                ['ID', 'Número de sucursales', 'Empresa', 'Ejecutivo de cuenta', 'Plan', 'Pruebas', 'Unidades', 'Ofertas laborales', 'Tiempo', 'Usuarios', 'Vigencia', 'Estado', 'Costo', 'Descuento', 'Valor de venta'],\n                $this->repositorio->datosConsumosEmpresas($request),\n                'Empresas-planes de todas las empresas',\n                'excel.empresas-planes.empresas-planes'\n            ),\n            'consumos-pruebas.xlsx'\n        );\n    }\n\n    /**\n     * Obtener los planes de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function datosTabla(int $empresa_id, Request $request): JsonResponse {\n        $request->merge([\n            'empresa_id'                            => $empresa_id,\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return new JsonResponse([\n            'data' => [\n                'empresas_planes'             => $this->repositorio->getTodo($request),\n                'sucursales_consumos_agendas' => $this->empresa_repositorio\n                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n                        'empresa_id'       => $empresa_id,\n                        'consumos_agendas' => true\n                    ])),\n                'sucursales_consumos_ofertas_laborales' => $this->empresa_repositorio\n                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n                        'empresa_id'                 => $empresa_id,\n                        'consumos_ofertas_laborales' => true\n                    ]))\n            ]\n        ], 200);\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function show(int $id): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->obtenerUnoConProximo($id)\n        ]);\n    }\n\n    /**\n     * Cargar la página para asignar un plan a una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function formularioAsignar(int $empresa_id): View {\n        return view('empresas.paginas.asignar-plan')->with([\n            'empresa_id'    => $empresa_id,\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresa'       => $this->empresa_repositorio->getUno($empresa_id),\n            'opcion'        => 'asignar'\n        ]);\n    }\n\n    /**\n     * Cargar la página para editar un plan de empresa.\n     *\n     * @param int $id ID de el plan de empresa.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function edit(int $id): View {\n        $empresa_plan = $this->repositorio->getUno($id);\n        return view('empresas.paginas.asignar-plan')->with([\n            'empresa_id'    => $empresa_plan->empresa_id,\n            'empresa_plan'  => $empresa_plan,\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresa'       => $this->empresa_repositorio->getUno($empresa_plan->empresa_id),\n            'opcion'        => 'editar'\n        ]);\n    }\n\n    /**\n     * Asignar plan a una empresa.\n     *\n     * @param AsignarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function store(AsignarPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan asignado correctamente'","numLines":200,"startLine":1,"totalLines":491}},"sourceToolAssistantUUID":"421c7c55-9880-44de-94e7-02efa0e8b0a2"}
{"parentUuid":"d5824288-9956-421f-a2fb-2b82b6d6c102","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_019YPahb3Cb9NXV2yzifvcxk","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a leer más del controlador para encontrar el método que maneja el historial de compras de créditos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":3663,"cache_read_input_tokens":102390,"cache_creation":{"ephemeral_5m_input_tokens":3663,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj8pku4yYF3ewX794W5","type":"assistant","uuid":"b8423fab-f75b-4f65-be3b-623634b02e80","timestamp":"2026-01-21T15:03:35.650Z"}
{"parentUuid":"b8423fab-f75b-4f65-be3b-623634b02e80","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_019YPahb3Cb9NXV2yzifvcxk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EanaGgEEqMQhT27s2297G5","name":"Bash","input":{"command":"grep -n \"historialComprasCreditos\\|historialRecompras\" \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php\""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":3663,"cache_read_input_tokens":102390,"cache_creation":{"ephemeral_5m_input_tokens":3663,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj8pku4yYF3ewX794W5","type":"assistant","uuid":"d0a54b06-6c56-4da6-a2c6-c163fac18054","timestamp":"2026-01-21T15:03:36.477Z"}
{"parentUuid":"d0a54b06-6c56-4da6-a2c6-c163fac18054","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_019YPahb3Cb9NXV2yzifvcxk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012U9NZbpvM4PSEGWwXidphR","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","limit":400,"offset":240}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":3663,"cache_read_input_tokens":102390,"cache_creation":{"ephemeral_5m_input_tokens":3663,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj8pku4yYF3ewX794W5","type":"assistant","uuid":"4adf3310-12ab-4d93-a566-22a5e40f7656","timestamp":"2026-01-21T15:03:36.892Z"}
{"parentUuid":"4adf3310-12ab-4d93-a566-22a5e40f7656","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012U9NZbpvM4PSEGWwXidphR","type":"tool_result","content":"   240→     * Facturar plan de empresa.\n   241→     *\n   242→     * @param int $id ID del plan de empresa.\n   243→     * @param FacturarPlanRequest $request Contenido de la petición.\n   244→     * @return JsonResponse\n   245→     * @author Daniel Beltrán\n   246→     */\n   247→    public function facturar(int $id, FacturarPlanRequest $request): JsonResponse {\n   248→        $codigo    = 201;\n   249→        $respuesta = [\n   250→            'message' => 'Plan facturado correctamente'\n   251→        ];\n   252→\n   253→        try {\n   254→            DB::beginTransaction();\n   255→            $this->servicio->facturar($id, $request);\n   256→            DB::commit();\n   257→        } catch (Exception $error) {\n   258→            DB::rollBack();\n   259→\n   260→            $codigo    = 400;\n   261→            $respuesta = [\n   262→                'message' => 'Ocurrió un error',\n   263→                'errors'  => $error->getMessage()\n   264→            ];\n   265→        }\n   266→\n   267→        return new JsonResponse($respuesta, $codigo);\n   268→    }\n   269→\n   270→    /**\n   271→     * Obtener el historial de recompras de una empresa por plan.\n   272→     *\n   273→     * @param Request $request Contenido de la petición HTTP entrante.\n   274→     * @param int|null $empresa_id Id de la empresa.\n   275→     * @return JsonResponse\n   276→     * @author Daniel Beltrán\n   277→     * @author Fahibram Cárcamo\n   278→     */\n   279→    public function historialRecompras(Request $request, int $empresa_id = null): JsonResponse {\n   280→        if (!is_null($empresa_id)) {\n   281→            $request->merge(compact('empresa_id'));\n   282→        }\n   283→\n   284→        return datatables()->of($this->servicio->historialRecompras($request))->toJson();\n   285→    }\n   286→\n   287→    /**\n   288→     * Obtener el historial de compras de planes con creditos.\n   289→     *\n   290→     * @param int $empresa_id ID de la empresa.\n   291→     * @param Request $request Contenido de la peticion.\n   292→     * @return JsonResponse\n   293→     * @author Sergio Vargas\n   294→     */\n   295→    public function historialComprasCreditos(int $empresa_id, Request $request): JsonResponse {\n   296→        return new JsonResponse([\n   297→            'data' => $this->servicio->historialComprasCreditos($empresa_id, $request)\n   298→        ], JsonResponse::HTTP_OK);\n   299→    }\n   300→\n   301→    /**\n   302→     * Exportar Excel del historial de recompras.\n   303→     *\n   304→     * @param Request $request Contenido de la petición.\n   305→     * @return BinaryFileResponse\n   306→     * @author Daniel Beltrán\n   307→     * @author Fahibram Cárcamo\n   308→     */\n   309→    public function exportarExcelHistorialRecompras(Request $request): BinaryFileResponse {\n   310→        return Excel::download(\n   311→            // Por el momento no se mostrará el conteo de consumos ni nada relacionado con ofertas laborales.\n   312→            new GlobalExport(\n   313→                ['Plan', 'Plan modificado', 'Creación', 'Activación', 'Vencimiento', 'Duración', 'Uso de unidades/agendas', /* 'Consumo de ofertas laborales', */ 'Uso de usuarios', 'Uso de tiempo', 'Número de factura', 'Costo', 'Descuento', 'Valor de venta', 'Detalle de uso'],\n   314→                $this->servicio->historialRecompras($request),\n   315→                'Historial de recompras',\n   316→                'excel.empresas.historial-recompras'\n   317→            ),\n   318→            'historial-recompras.xlsx'\n   319→        );\n   320→    }\n   321→\n   322→    /**\n   323→     * Inactivar un plan de empresa.\n   324→     *\n   325→     * @param int $id ID del plan de empresa.\n   326→     * @return JsonResponse\n   327→     * @author Daniel Beltrán\n   328→     */\n   329→    public function inactivar(int $id): JsonResponse {\n   330→        $codigo    = 200;\n   331→        $respuesta = [\n   332→            'message' => 'Plan inactivado correctamente'\n   333→        ];\n   334→\n   335→        try {\n   336→            DB::beginTransaction();\n   337→            $this->repositorio->actualizar($id, ['estado_id' => 2]);\n   338→            DB::commit();\n   339→        } catch (Exception $error) {\n   340→            DB::rollBack();\n   341→\n   342→            $codigo    = 400;\n   343→            $respuesta = [\n   344→                'message' => 'Ocurrió un error',\n   345→                'errors'  => $error->getMessage()\n   346→            ];\n   347→        }\n   348→\n   349→        return new JsonResponse($respuesta, $codigo);\n   350→    }\n   351→\n   352→    /**\n   353→     * Actualizar un plan de empresa.\n   354→     *\n   355→     * @param int $id ID del plan de empresa.\n   356→     * @param AsignarPlanRequest $request Contenido de la petición.\n   357→     * @return JsonResponse\n   358→     * @author Daniel Beltrán\n   359→     */\n   360→    public function update(int $id, AsignarPlanRequest $request): JsonResponse {\n   361→        $codigo    = 200;\n   362→        $respuesta = [\n   363→            'message' => 'Plan actualizado correctamente'\n   364→        ];\n   365→\n   366→        try {\n   367→            DB::beginTransaction();\n   368→            $request->merge(['id' => $id]);\n   369→            $this->servicio->guardar($request);\n   370→            DB::commit();\n   371→        } catch (Exception $error) {\n   372→            DB::rollBack();\n   373→\n   374→            $codigo    = 400;\n   375→            $respuesta = [\n   376→                'message' => 'Ocurrió un error',\n   377→                'errors'  => $error->getMessage()\n   378→            ];\n   379→        }\n   380→\n   381→        return new JsonResponse($respuesta, $codigo);\n   382→    }\n   383→\n   384→    /**\n   385→     * Actualizar un plan de empresa.\n   386→     *\n   387→     * @param int $id ID del plan de empresa.\n   388→     * @param Request $request Contenido de la petición.\n   389→     * @return JsonResponse\n   390→     * @author Daniel Beltrán\n   391→     */\n   392→    public function actualizarInformacion(int $id, Request $request): JsonResponse {\n   393→        $codigo    = 200;\n   394→        $respuesta = [\n   395→            'message' => 'Plan actualizado correctamente'\n   396→        ];\n   397→\n   398→        try {\n   399→            DB::beginTransaction();\n   400→            $this->repositorio->actualizar($id, $request->except('_token', '_method'));\n   401→            DB::commit();\n   402→        } catch (Exception $error) {\n   403→            DB::rollBack();\n   404→\n   405→            $codigo    = 400;\n   406→            $respuesta = [\n   407→                'message' => 'Ocurrió un error',\n   408→                'errors'  => $error->getMessage()\n   409→            ];\n   410→        }\n   411→\n   412→        return new JsonResponse($respuesta, $codigo);\n   413→    }\n   414→\n   415→    /**\n   416→     * Envíar la notificación de solicitud de renovación de plan.\n   417→     *\n   418→     * @param Request $request Solicitud HTTP.\n   419→     * @return JsonResponse\n   420→     * @author Fahibram Cárcamo\n   421→     */\n   422→    public function solicitudRenovacionPlan(Request $request): JsonResponse {\n   423→        $codigo    = 200;\n   424→        $respuesta = ['message' => 'Solicitud de renovación de plan enviada correctamente'];\n   425→\n   426→        try {\n   427→            $this->servicio->solicitarRenovacionPlan($request);\n   428→        } catch (Exception $error) {\n   429→            $codigo    = 400;\n   430→            $respuesta = [\n   431→                'message' => 'Ocurrió un error',\n   432→                'errors'  => $error->getMessage(),\n   433→                'trace'   => $error->getTrace()\n   434→            ];\n   435→        }\n   436→\n   437→        return new JsonResponse($respuesta, $codigo);\n   438→    }\n   439→\n   440→    /**\n   441→     * Descargar archivo de factura de plan.\n   442→     *\n   443→     * @param int $id Id del archivo de la factura.\n   444→     * @return StreamedResponse\n   445→     * @author Fahibram Cárcamo\n   446→     */\n   447→    public function descargarFactura(int $archivo_id): StreamedResponse {\n   448→        $archivo_factura = $this->archivo_repositorio->getUno($archivo_id);\n   449→        return Storage::download($archivo_factura->ruta);\n   450→    }\n   451→\n   452→    /**\n   453→     * Obtener creditos disponibles y plan asignado de una empresa.\n   454→     *\n   455→     * @param int $empresa_id ID de la empresa.\n   456→     * @param Request $request Contenido de la peticion.\n   457→     * @return JsonResponse\n   458→     * @author Sergio Vargas\n   459→     */\n   460→    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): JsonResponse {\n   461→        $datos = $this->servicio->creditosDisponiblesEmpresa($empresa_id, $request);\n   462→\n   463→        if (!$datos) {\n   464→            return new JsonResponse([\n   465→                'message' => 'Plan de empresa no encontrado'\n   466→            ], JsonResponse::HTTP_NOT_FOUND);\n   467→        }\n   468→\n   469→        return new JsonResponse([\n   470→            'data' => $datos\n   471→        ], JsonResponse::HTTP_OK);\n   472→    }\n   473→\n   474→    /**\n   475→     * Obtener historial de consumos de creditos de una empresa.\n   476→     *\n   477→     * @param int $empresa_id ID de la empresa.\n   478→     * @param Request $request Contenido de la peticion.\n   479→     * @return JsonResponse\n   480→     * @author Sergio Vargas\n   481→     */\n   482→    public function historialConsumosCreditos(int $empresa_id, Request $request): JsonResponse {\n   483→        return new JsonResponse([\n   484→            'data' => $this->consumo_credito_servicio->historialConsumosEmpresa(\n   485→                $empresa_id,\n   486→                $request->only(['desde', 'hasta'])\n   487→            )\n   488→        ], JsonResponse::HTTP_OK);\n   489→    }\n   490→}\n   491→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3bc59e4d-f5ba-412b-b139-62ee3a8515e0","timestamp":"2026-01-21T15:03:38.669Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","content":"     * Facturar plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param FacturarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, FacturarPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan facturado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->facturar($id, $request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por plan.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @param int|null $empresa_id Id de la empresa.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function historialRecompras(Request $request, int $empresa_id = null): JsonResponse {\n        if (!is_null($empresa_id)) {\n            $request->merge(compact('empresa_id'));\n        }\n\n        return datatables()->of($this->servicio->historialRecompras($request))->toJson();\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->historialComprasCreditos($empresa_id, $request)\n        ], JsonResponse::HTTP_OK);\n    }\n\n    /**\n     * Exportar Excel del historial de recompras.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return BinaryFileResponse\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function exportarExcelHistorialRecompras(Request $request): BinaryFileResponse {\n        return Excel::download(\n            // Por el momento no se mostrará el conteo de consumos ni nada relacionado con ofertas laborales.\n            new GlobalExport(\n                ['Plan', 'Plan modificado', 'Creación', 'Activación', 'Vencimiento', 'Duración', 'Uso de unidades/agendas', /* 'Consumo de ofertas laborales', */ 'Uso de usuarios', 'Uso de tiempo', 'Número de factura', 'Costo', 'Descuento', 'Valor de venta', 'Detalle de uso'],\n                $this->servicio->historialRecompras($request),\n                'Historial de recompras',\n                'excel.empresas.historial-recompras'\n            ),\n            'historial-recompras.xlsx'\n        );\n    }\n\n    /**\n     * Inactivar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function inactivar(int $id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Plan inactivado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->actualizar($id, ['estado_id' => 2]);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param AsignarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function update(int $id, AsignarPlanRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Plan actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $request->merge(['id' => $id]);\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function actualizarInformacion(int $id, Request $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Plan actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->actualizar($id, $request->except('_token', '_method'));\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Envíar la notificación de solicitud de renovación de plan.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return JsonResponse\n     * @author Fahibram Cárcamo\n     */\n    public function solicitudRenovacionPlan(Request $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = ['message' => 'Solicitud de renovación de plan enviada correctamente'];\n\n        try {\n            $this->servicio->solicitarRenovacionPlan($request);\n        } catch (Exception $error) {\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage(),\n                'trace'   => $error->getTrace()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Descargar archivo de factura de plan.\n     *\n     * @param int $id Id del archivo de la factura.\n     * @return StreamedResponse\n     * @author Fahibram Cárcamo\n     */\n    public function descargarFactura(int $archivo_id): StreamedResponse {\n        $archivo_factura = $this->archivo_repositorio->getUno($archivo_id);\n        return Storage::download($archivo_factura->ruta);\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): JsonResponse {\n        $datos = $this->servicio->creditosDisponiblesEmpresa($empresa_id, $request);\n\n        if (!$datos) {\n            return new JsonResponse([\n                'message' => 'Plan de empresa no encontrado'\n            ], JsonResponse::HTTP_NOT_FOUND);\n        }\n\n        return new JsonResponse([\n            'data' => $datos\n        ], JsonResponse::HTTP_OK);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     */\n    public function historialConsumosCreditos(int $empresa_id, Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->consumo_credito_servicio->historialConsumosEmpresa(\n                $empresa_id,\n                $request->only(['desde', 'hasta'])\n            )\n        ], JsonResponse::HTTP_OK);\n    }\n}\n","numLines":252,"startLine":240,"totalLines":491}},"sourceToolAssistantUUID":"4adf3310-12ab-4d93-a566-22a5e40f7656"}
{"parentUuid":"d0a54b06-6c56-4da6-a2c6-c163fac18054","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EanaGgEEqMQhT27s2297G5","type":"tool_result","content":"279:    public function historialRecompras(Request $request, int $empresa_id = null): JsonResponse {\n284:        return datatables()->of($this->servicio->historialRecompras($request))->toJson();\n295:    public function historialComprasCreditos(int $empresa_id, Request $request): JsonResponse {\n297:            'data' => $this->servicio->historialComprasCreditos($empresa_id, $request)\n314:                $this->servicio->historialRecompras($request),","is_error":false}]},"uuid":"8d4d6c24-75dc-4dce-ba46-5d1adcf806df","timestamp":"2026-01-21T15:03:39.984Z","toolUseResult":{"stdout":"279:    public function historialRecompras(Request $request, int $empresa_id = null): JsonResponse {\n284:        return datatables()->of($this->servicio->historialRecompras($request))->toJson();\n295:    public function historialComprasCreditos(int $empresa_id, Request $request): JsonResponse {\n297:            'data' => $this->servicio->historialComprasCreditos($empresa_id, $request)\n314:                $this->servicio->historialRecompras($request),\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"d0a54b06-6c56-4da6-a2c6-c163fac18054"}
{"parentUuid":"8d4d6c24-75dc-4dce-ba46-5d1adcf806df","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01KJQaQbAFGjuoWcTVMwYS39","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora tengo suficiente información. Voy a compilar un reporte exhaustivo con toda la información recolectada sobre el sistema de créditos. Déjame buscar información adicional sobre la base de datos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3222,"cache_creation_input_tokens":442,"cache_read_input_tokens":106053,"cache_creation":{"ephemeral_5m_input_tokens":442,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj9Pm24ZeGtmfoPX3zx","type":"assistant","uuid":"d2528969-936a-4fa2-8117-e6c5dafdf133","timestamp":"2026-01-21T15:03:43.610Z"}
{"parentUuid":"d2528969-936a-4fa2-8117-e6c5dafdf133","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01KJQaQbAFGjuoWcTVMwYS39","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DK1gjcvMswrLTU9aHAopH2","name":"Bash","input":{"command":"find \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\" -name \"*credito*\" -o -name \"*consumo*\" | head -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3222,"cache_creation_input_tokens":442,"cache_read_input_tokens":106053,"cache_creation":{"ephemeral_5m_input_tokens":442,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj9Pm24ZeGtmfoPX3zx","type":"assistant","uuid":"f5b38182-eeb8-49f2-a94c-32dfba0cedf1","timestamp":"2026-01-21T15:03:44.373Z"}
{"parentUuid":"f5b38182-eeb8-49f2-a94c-32dfba0cedf1","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01KJQaQbAFGjuoWcTVMwYS39","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01D64CG2mVRSHPS7f51Ke2db","name":"Grep","input":{"pattern":"consume_creditos|creditos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3222,"cache_creation_input_tokens":442,"cache_read_input_tokens":106053,"cache_creation":{"ephemeral_5m_input_tokens":442,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj9Pm24ZeGtmfoPX3zx","type":"assistant","uuid":"b8a80728-6a6f-45d4-8eb2-785f35521963","timestamp":"2026-01-21T15:03:45.842Z"}
{"parentUuid":"b8a80728-6a6f-45d4-8eb2-785f35521963","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01D64CG2mVRSHPS7f51Ke2db","type":"tool_result","content":"Found 2 files\napp\\Models\\IA\\ServicioIA.php\napp\\Models\\IA\\ConsumoCredito.php"}]},"uuid":"994219ac-4fac-4ab5-9578-09190ac952f2","timestamp":"2026-01-21T15:03:48.759Z","toolUseResult":{"mode":"files_with_matches","filenames":["app\\Models\\IA\\ServicioIA.php","app\\Models\\IA\\ConsumoCredito.php"],"numFiles":2},"sourceToolAssistantUUID":"b8a80728-6a6f-45d4-8eb2-785f35521963"}
{"parentUuid":"f5b38182-eeb8-49f2-a94c-32dfba0cedf1","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DK1gjcvMswrLTU9aHAopH2","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_06_164444_create_consumos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_12_23_120722_add_oferta_laboral_id_column_to_consumos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2025_10_15_115655_add_vacante_id_to_consumos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2025_12_05_152922_create_consumos_tokens_openai_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000001_create_planes_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000005_rename_consumos_tokens_openai_to_consumos_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php","is_error":false}]},"uuid":"856e7f96-bcdf-4946-b1fc-34b9bfa48e62","timestamp":"2026-01-21T15:03:49.407Z","toolUseResult":{"stdout":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_06_164444_create_consumos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_12_23_120722_add_oferta_laboral_id_column_to_consumos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2025_10_15_115655_add_vacante_id_to_consumos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2025_12_05_152922_create_consumos_tokens_openai_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000001_create_planes_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000005_rename_consumos_tokens_openai_to_consumos_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"f5b38182-eeb8-49f2-a94c-32dfba0cedf1"}
{"parentUuid":"856e7f96-bcdf-4946-b1fc-34b9bfa48e62","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"ac812e5","slug":"floofy-imagining-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GqZXCKyzDeQwmhcRCe2fvk","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente. Ahora tengo toda la información necesaria. Voy a compilar un reporte completo y detallado sobre el sistema de créditos:\n\n## REPORTE COMPLETO: SISTEMA DE CRÉDITOS - PSICOALIANZA\n\n### 1. RESUMEN EJECUTIVO\n\nEl sistema de créditos de PsicoAlianza es un mecanismo de consumo basado en acciones IA que permite a las empresas comprar y utilizar créditos para servicios de inteligencia artificial. Es independiente del sistema de planes tradicionales (Selección, Organizacional, Vocacional) aunque pueden coexistir en la misma empresa.\n\n---\n\n### 2. ARQUITECTURA Y MODELOS\n\n#### 2.1 Modelos Clave\n\n**PlanCredito** (`app/Models/Planes/PlanCredito.php`)\n- **Tabla**: `planes_creditos`\n- **Propósito**: Define planes de compra de créditos (Ej: \"100 créditos por $500\")\n- **Campos**:\n  - `nombre` - Nombre del plan (ej: \"Plan 100 créditos\")\n  - `descripcion` - Descripción del plan\n  - `creditos` - Cantidad de créditos que se compran (ej: 100)\n  - `precio` - Precio sin descuento\n  - `porcentaje_descuento` - Descuento aplicable\n  - `fecha_inicio_promocion` / `fecha_fin_promocion` - Promociones\n  - `activo` - Boolean para habilitar/deshabilitar\n- **Relaciones**:\n  - `empresasPlanes()` - HasMany con EmpresaPlan (cuando se asigna este plan)\n- **Métodos**:\n  - `estaEnPromocion()` - Verifica si está en promoción vigente\n  - `getPrecioConDescuentoAttribute()` - Calcula precio final\n\n**EmpresaPlan** (`app/Models/Empresas/EmpresaPlan.php`)\n- **Tabla**: `empresas_planes`\n- **Propósito**: Registro de asignación de planes a empresas (tanto planes tradicionales como planes de créditos)\n- **Campos Relacionados con Créditos**:\n  - `plan_credito_id` (FK, nullable) - Referencia al PlanCredito comprado\n  - `creditos` (integer, default 0) - Cantidad de créditos iniciales asignados\n  - `fecha_inicio` / `fecha_vencimiento` - Vigencia del plan\n  - `unidades`, `cantidad_ofertas_laborales`, `cantidad_usuarios`, `cantidad_pruebas` - Para planes normales\n- **Atributo Calculado**:\n  - `creditos_restantes` - Calcula: `creditos - sum(consumos_creditos.creditos)`\n  - `vigencia_dias` - Días entre inicio y vencimiento\n- **Relaciones**:\n  - `consumosCreditos()` - HasMany con ConsumoCredito\n  - `planCredito()` - BelongsTo con PlanCredito (con default vacío)\n  - `plan()` - BelongsTo con Plan (para planes normales)\n- **DIFERENCIACIÓN**: \n  - Si tiene `plan_id` → Es un plan tradicional (Selección/Organizacional/Vocacional)\n  - Si tiene `plan_credito_id` → Es un plan de créditos IA\n  - Puede tener ambos simultáneamente (no son excluyentes)\n\n**ConsumoCredito** (`app/Models/IA/ConsumoCredito.php`)\n- **Tabla**: `consumos_creditos`\n- **Propósito**: Registro de cada consumo de créditos (cada llamada IA)\n- **Campos**:\n  - `usuario_id` - Quién hizo la solicitud\n  - `empresa_id` - Empresa a la que pertenece\n  - `empresa_plan_id` (FK) - Plan de créditos del que se deducen\n  - `servicio_ia_id` (FK) - Servicio IA utilizado\n  - `creditos` - Créditos consumidos en esta acción\n  - `ruta_endpoint` - Endpoint llamado (ej: \"generar-vacante\")\n  - `tokens_entrada`, `tokens_salida`, `tokens_totales` - Tokens de OpenAI\n  - `caracteres_entrada` - Para Whisper\n  - `costo_estimado_usd` - Costo en USD\n  - `modelo` - Modelo usado (gpt-4, whisper, etc)\n  - `estado` - 'exitoso' o 'error'\n  - `latencia_ms`, `mensaje_error` - Debugging\n  - Campos de contexto: `agenda_id`, `vacante_id`\n- **No tiene timestamps customizados**: Solo `created_at`\n\n**ServicioIA** (`app/Models/IA/ServicioIA.php`)\n- **Tabla**: `servicios_ia`\n- **Propósito**: Define qué servicios IA consumen créditos y cuántos\n- **Campos Clave**:\n  - `endpoint` - Ruta del endpoint (ej: \"generar-vacante\")\n  - `consume_creditos` - Créditos consumidos por cada llamada (ej: 10)\n  - `activo` - Boolean\n- **Ejemplo**: \"generar-vacante\" consume 10 créditos\n\n---\n\n### 3. FLUJO DE COMPRA DE CRÉDITOS\n\n#### 3.1 Paso 1: Crear/Gestionar Planes de Créditos\n**Ubicación**: `/planes-creditos` (rutas web.php línea 283)\n**Controlador**: `PlanCreditoController@store/update`\n**Acciones**:\n- Admin crea plans de crédito con: nombre, cantidad, precio, descuentos\n- Ejemplo: \"Plan 100 créditos - $500\" (con 10% descuento = $450)\n- Se almacenan en tabla `planes_creditos`\n\n**Servicio**: `PlanCreditoService`\n```php\nguardar(Request $request): PlanCredito\n  - Crear o actualizar PlanCredito\n  - Calcular precio con descuento\n  \ngetTodoCreditosPromedio(Request $request): Collection\n  - Obtiene todos los planes con datos calculados\n  - Incluye: creditos_disponibles, creditos_promedio_accion\n```\n\n#### 3.2 Paso 2: Asignar Plan de Créditos a una Empresa\n**Ubicación**: `/asignar-plan/{empresa_id}` (rutas web.php línea 272)\n**Controlador**: `EmpresaPlanController@store`\n**Proceso**:\n\nEn `EmpresaPlanService@guardar()`:\n```php\nif ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n    $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n    if ($plan_credito) {\n        $request->merge(['creditos' => $plan_credito->creditos]);\n    }\n}\n```\n\n**Resultado**:\n- Se crea registro en `empresas_planes` con:\n  - `plan_credito_id` = ID del plan comprado\n  - `creditos` = Cantidad comprada (ej: 100)\n  - `fecha_inicio` / `fecha_vencimiento` = Vigencia del plan\n  - `estado_id` = 1 (Activo)\n\n**Posibles Combinaciones**:\n1. **Plan Normal SOLO**: `plan_id` + `unidades` + `fecha_vencimiento` (SIN `plan_credito_id`)\n2. **Plan Créditos SOLO**: `plan_credito_id` + `creditos` (SIN `plan_id`)\n3. **AMBOS**: Empresa tiene plan normal + plan de créditos simultáneamente\n\n#### 3.3 Paso 3: Usar Créditos (Consumo)\n**Ubicación**: Cuando se ejecuta una acción IA\n**Proceso**:\n\n1. **Validar disponibilidad** → `CreditoIAService@validarCreditosDisponibles()`\n   ```php\n   $servicio = obtenerServicioPorEndpoint($endpoint);\n   $creditos_necesarios = $servicio?->consume_creditos ?? 0;\n   $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n   $creditos_disponibles = $empresa_plan?->creditos_restantes ?? 0;\n   \n   return [\n       'tiene_creditos' => $creditos_disponibles >= $creditos_necesarios,\n       'creditos_necesarios' => $creditos_necesarios,\n       'creditos_disponibles' => $creditos_disponibles\n   ];\n   ```\n\n2. **Registrar consumo** → `ConsumoCreditoService@registrarConsumoDesdeRespuesta()`\n   ```php\n   // FastAPI devuelve respuesta con usage\n   $uso_gpt = $respuesta_ia['usage_gpt']; // tokens consumidos\n   \n   $costo_estimado = $this->precio_token_servicio->calcularCosto(\n       $modelo,\n       $uso_gpt['prompt_tokens'],\n       $uso_gpt['completion_tokens']\n   );\n   \n   // Guardar en consumos_creditos\n   $this->repositorio->crear([\n       'empresa_plan_id' => $empresa_plan_id,\n       'servicio_ia_id' => $servicio->id,\n       'creditos' => $servicio->consume_creditos,\n       'tokens_entrada' => $uso_gpt['prompt_tokens'],\n       'tokens_salida' => $uso_gpt['completion_tokens'],\n       'costo_estimado_usd' => $costo_estimado,\n       // ... otros campos\n   ]);\n   ```\n\n**Deducción de Créditos**:\n- Los créditos NO se restan automáticamente en `empresas_planes.creditos`\n- Se consulta dinámicamente: `creditos_restantes = creditos - SUM(consumos_creditos.creditos)`\n- Esto permite queries en cualquier momento\n\n#### 3.4 Paso 4: Ver Historial y Analítica\n**Rutas**:\n- `/planes-historial-recompras/{empresa_id}` - Historial de planes\n- `/planes-historial-recompras-creditos/{empresa_id}` - Historial de compras de créditos\n- `/consumos-agendas-empresa-plan` - Consumos de IA por plan\n\n**Controlador**: `EmpresaPlanController@historialComprasCreditos()`\n```php\npublic function historialComprasCreditos(int $empresa_id, Request $request): JsonResponse {\n    return new JsonResponse([\n        'data' => $this->servicio->historialComprasCreditos($empresa_id, $request)\n    ], JsonResponse::HTTP_OK);\n}\n```\n\n**Servicio**: `EmpresaPlanService@historialComprasCreditos()`\n```php\npublic function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n    $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n    \n    return $historial->map(function (EmpresaPlan $plan) {\n        $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n        $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n        \n        return [\n            'creditos_totales' => $total_creditos,\n            'creditos_consumidos' => $creditos_consumidos,\n            'creditos_restantes' => max(0, $total_creditos - $creditos_consumidos)\n        ];\n    });\n}\n```\n\n---\n\n### 4. ASIGNACIÓN Y CONSUMO DE CRÉDITOS\n\n#### 4.1 ¿Cómo se Asignan Créditos a un EmpresaPlan?\n\n**NUNCA se asignan manualmente después de la creación**. Se asignan UNA SOLA VEZ:\n\n```php\n// En EmpresaPlanService::guardar()\nif ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n    $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n    if ($plan_credito) {\n        $request->merge(['creditos' => $plan_credito->creditos]);\n    }\n}\n// Después se guarda con esos créditos\n$plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n```\n\n**Resultado**: `empresas_planes.creditos = Plan->creditos` (ej: 100)\n\n#### 4.2 ¿Cómo se Consumen los Créditos?\n\n**Vía tabla `consumos_creditos`**:\n- Cada fila = 1 consumo de IA\n- Contiene: `empresa_plan_id`, `creditos` (cantidad consumida), `servicio_ia_id`\n- NO se actualiza `empresas_planes.creditos`\n- Se calcula dinámicamente:\n  ```php\n  public function getCreditosRestantesAttribute(): int {\n      return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n  }\n  ```\n\n#### 4.3 Validación de Créditos Restantes\n\n**Servicio**: `CreditoIAService@validarCreditosDisponibles()`\n```php\n$empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n$creditos_disponibles = $empresa_plan?->creditos_restantes ?? 0; // Cálculo dinámico\n\n$tiene_creditos = $creditos_disponibles >= $creditos_necesarios;\n```\n\n---\n\n### 5. DIFERENCIA ENTRE PLANES NORMALES Y PLANES DE CRÉDITOS\n\n| Aspecto | Plan Normal (Selección/Org/Voc) | Plan de Créditos |\n|---------|----------------------------------|------------------|\n| **Modelo** | Plan + EmpresaPlan | PlanCredito + EmpresaPlan |\n| **FK** | `plan_id` | `plan_credito_id` |\n| **Unidades** | Limitadas (unidades/cantidad_ofertas) | Ilimitadas (consumo por uso) |\n| **Vigencia** | Fecha inicio/vencimiento | Fecha inicio/vencimiento |\n| **Consumo** | Tabla `consumos` | Tabla `consumos_creditos` |\n| **Consumo Rastreo** | Por agenda/oferta | Por llamada IA |\n| **Escalabilidad** | Por cantidad fija | Flexible |\n| **Ejemplo** | 10 unidades de pruebas | 100 créditos para IA |\n\n---\n\n### 6. PLANES \"VACÍOS\" (SIN UNIDADES NI FECHA)\n\n**¿Existen?**: Sí, es posible pero no es la intención normal\n\n**Escenarios**:\n1. **Plan de créditos sin vigencia**: \n   ```php\n   - plan_credito_id = 1\n   - creditos = 100\n   - fecha_inicio = NULL\n   - fecha_vencimiento = NULL\n   - vigencia_dias = 0\n   ```\n   → Créditos ilimitados en tiempo\n\n2. **Plan normal sin unidades**: \n   ```php\n   - plan_id = 1\n   - unidades = 0\n   - fecha_vencimiento = NULL\n   ```\n   → Plan activo pero sin recursos\n\n3. **Ambos**:\n   ```php\n   - plan_id = 1 + plan_credito_id = 1\n   - unidades = 0 + creditos = 100\n   ```\n   → Plan normal sin recursos, pero con créditos IA\n\n**Recomendación**: No se recomienda dejar planes vacíos, pero el sistema no lo previene.\n\n---\n\n### 7. RELACIONES Y FLUJO DE DATOS\n\n```\nServicioIA\n├── consume_creditos = 10 (créditos por acción)\n└── endpoint = \"generar-vacante\"\n\n        ↓ (se usa en)\n\nPlanCredito\n├── creditos = 100\n├── precio = 500\n└── porcentaje_descuento = 10%\n\n        ↓ (se compra y asigna)\n\nEmpresaPlan\n├── plan_credito_id = 1\n├── creditos = 100 (asignados del PlanCredito)\n├── empresa_id = 5\n└── creditos_restantes = 100 - sum(consumos) [calculado]\n\n        ↓ (se consumen con cada acción)\n\nConsumoCredito\n├── empresa_plan_id = 1\n├── servicio_ia_id = 1\n├── creditos = 10 (deducidos del servicio)\n└── estado = 'exitoso'\n```\n\n---\n\n### 8. SERVICIOS Y CONTROLADORES CLAVE\n\n#### 8.1 Servicios\n\n**PlanCreditoService** (`app/Http/Services/Planes/PlanCreditoService.php`)\n- `getTodoCreditosPromedio()` - Obtiene planes con datos calculados\n- `guardar()` - Crear/actualizar plan de créditos\n- `calcularPrecioFinal()` - Aplica descuentos\n\n**EmpresaPlanService** (`app/Http/Services/Empresas/EmpresaPlanService.php`)\n- `guardar()` - Asignar plan (normal o créditos) a empresa\n- `historialComprasCreditos()` - Obtiene historial de compras de créditos con cálculos\n- `creditosDisponibles()` - Créditos restantes de un plan\n- `creditosDisponiblesEmpresa()` - Créditos totales y plan de una empresa\n- `tieneCreditosSuficientes()` - Valida disponibilidad\n\n**ConsumoCreditoService** (`app/Http/Services/IA/ConsumoCreditoService.php`)\n- `registrarConsumoDesdeRespuesta()` - Registra consumo de IA\n  - Soporta múltiples formatos: `usage_whisper`, `usage_gpt`, `usage` (legacy)\n  - Calcula costo estimado\n  - Genera huella digital (SHA256)\n  - Extrae vacante_id del payload\n- `historialConsumosEmpresa()` - Obtiene consumos por fecha\n\n**CreditoIAService** (`app/Http/Services/IA/CreditoIAService.php`)\n- `validarCreditosDisponibles()` - Valida antes de usar IA\n  - Obtiene servicio por endpoint\n  - Calcula créditos necesarios vs disponibles\n  - Retorna: `tiene_creditos`, `creditos_necesarios`, `creditos_disponibles`\n- `obtenerCreditosServicio()` - Créditos de un servicio\n- `prepararConsumo()` - Prepara datos para consumo\n\n#### 8.2 Controladores\n\n**PlanCreditoController**\n- `index()` - Listar planes de créditos con promedio\n- `create()` / `edit()` - Vistas para crear/editar\n- `store()` / `update()` - Guardar planes\n- `destroy()` - Eliminar planes\n\n**EmpresaPlanController**\n- `store()` - Asignar plan a empresa (con soporte para créditos)\n- `historialRecompras()` - Historial de planes normales\n- `historialComprasCreditos()` - Historial de compras de créditos IA\n- `creditosDisponiblesEmpresa()` - Obtener créditos disponibles\n\n---\n\n### 9. VISTAS Y FRONTEND\n\n**Modal de Historial**: `resources/views/empresa/paginas/planes/modal-recompras.blade.php`\n- Tab 1: Selección\n- Tab 2: Organizacional\n- Tab 3: Vocacional\n- **Tab 4: Créditos IA** ← Específica para planes de créditos\n\n**JavaScript**: `public/js/empresa/planes/modal-recompras.js`\n- `modalHistorialCompras()` - Renderiza modal\n- `getHistorialCompras()` - GET `/planes-historial-recompras/{empresa_id}`\n- `getHistorialComprasCreditos()` - GET `/planes-historial-recompras-creditos/{empresa_id}`\n- `renderizarTablaCreditos()` - Renderiza tabla con columnas:\n  - Nombre del plan (del PlanCredito)\n  - Vigencia (fecha_inicio / fecha_vencimiento)\n  - Duración (vigencia_dias)\n  - Consumo de créditos (barra de progreso)\n  - Acciones (ver detalle, descargar factura)\n\n---\n\n### 10. RUTAS RELACIONADAS\n\n```php\n// Crear/editar planes de créditos\nGET    /planes-creditos/create\nPOST   /planes-creditos\nGET    /planes-creditos/{id}/edit\nPUT    /planes-creditos/{id}\nDELETE /planes-creditos/{id}\n\n// Asignar plan a empresa (soporta ambos tipos)\nGET  /asignar-plan/{empresa_id}\nPOST /empresas-planes\n\n// Historial y consumo\nGET /planes-historial-recompras/{empresa_id}\nGET /planes-historial-recompras-creditos/{empresa_id}\nGET /consumos-agendas-empresa-plan\n\n// Datos de créditos\nGET /empresas-planes/{id}/creditos-disponibles\nGET /empresas-planes/{id}/historial-consumos-creditos\n\n// Exportar\nPOST /planes-historial-recompras-exportar\nPOST /planes-historial-recompras-creditos-exportar (en desarrollo)\n```\n\n---\n\n### 11. MIGRACIONES RELACIONADAS\n\n```\n2026_01_02_000001_create_planes_creditos_table.php\n├── Crea tabla planes_creditos\n└── Campos: nombre, descripcion, creditos, precio, porcentaje_descuento, etc.\n\n2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php\n├── Agrega plan_credito_id (FK, nullable)\n└── Agrega creditos (integer, default 0)\n\n2026_01_02_000005_rename_consumos_tokens_openai_to_consumos_creditos_table.php\n└── Renombra tabla de consumos de tokens a consumos_creditos\n\n2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php\n└── Agrega FK a servicios_ia\n\n2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php\n└── Renombra columna\n```\n\n---\n\n### 12. CÁLCULOS Y VALIDACIONES\n\n#### 12.1 Cálculo de Créditos Restantes\n```php\n// EmpresaPlan model\npublic function getCreditosRestantesAttribute(): int {\n    return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n}\n\n// Query equivalente\nSELECT \n    ep.creditos - COALESCE(SUM(cc.creditos), 0) as creditos_restantes\nFROM empresas_planes ep\nLEFT JOIN consumos_creditos cc ON ep.id = cc.empresa_plan_id\nWHERE ep.id = ?\nGROUP BY ep.id\n```\n\n#### 12.2 Precio con Descuento\n```php\n// PlanCredito model\npublic function getPrecioConDescuentoAttribute(): float {\n    if (!$this->estaEnPromocion()) {\n        return (float) $this->precio;\n    }\n    \n    $porcentaje = $this->porcentaje_descuento ?? 0;\n    $descuento = $this->precio * ($porcentaje / 100);\n    \n    return (float) max(0, $this->precio - $descuento);\n}\n\n// Ejemplo: $500 con 10% = $500 - ($500 * 0.10) = $450\n```\n\n#### 12.3 Validación de Promoción\n```php\npublic function estaEnPromocion(): bool {\n    if (!$this->porcentaje_descuento) return false;\n    \n    $hoy = now()->startOfDay();\n    \n    if ($this->fecha_inicio_promocion && $hoy->lt($this->fecha_inicio_promocion)) {\n        return false; // Aún no ha empezado\n    }\n    \n    if ($this->fecha_fin_promocion && $hoy->gt($this->fecha_fin_promocion)) {\n        return false; // Ya pasó\n    }\n    \n    return true;\n}\n```\n\n---\n\n### 13. ESTADOS Y CICLO DE VIDA\n\n#### Estado del Plan (`empresas_planes.estado_id`)\n- **1**: Activo\n- **2**: Inactivo\n- **3**: Próximo (cuando hay renovación pendiente)\n- **4**: Por vencer\n- **5**: Vencido\n- **6**: Renovando\n\n#### Vigencia del Plan de Créditos\n- **Con fecha**: Créditos disponibles hasta fecha_vencimiento\n- **Sin fecha (NULL)**: Créditos disponibles indefinidamente\n- **Vencido**: `fecha_vencimiento < today()` → No se pueden usar\n\n---\n\n### 14. SEGURIDAD Y AUDITORÍA\n\n**Auditoria**: Ambos modelos usan `Auditable` de Laravel\n```php\nuse OwenIt\\Auditing\\Auditable;\n```\n\n**Campos Registrados**:\n- PlanCredito: nombre, creditos, precio, descuentos\n- EmpresaPlan: plan_credito_id, creditos, fechas\n- ConsumoCredito: TODA la información de cada consumo\n\n**Rastreo de Consumo**:\n```php\n// ConsumoCredito guarda:\n- huella_peticion (SHA256 del payload)\n- extracto_peticion (primeros 500 chars)\n- extracto_respuesta (primeros 500 chars)\n- modelo (gpt-4, whisper, etc)\n- tokens_entrada / tokens_salida\n- latencia_ms\n```\n\n---\n\n### 15. CASOS DE USO Y EJEMPLOS\n\n#### Caso 1: Empresa Compra Plan de 100 Créditos\n\n1. Admin crea: PlanCredito(\"100 créditos\", creditos=100, precio=500)\n2. Asigna a Empresa 5: \n   - Crea EmpresaPlan(plan_credito_id=1, creditos=100, empresa_id=5)\n3. Usuario de Empresa 5 genera vacante (consume 10 créditos):\n   - Crea ConsumoCredito(empresa_plan_id=X, creditos=10)\n4. Créditos restantes: 100 - 10 = 90\n5. Repite 9 veces más → 0 créditos restantes\n6. Próxima acción fallará: \"No hay créditos disponibles\"\n\n#### Caso 2: Empresa Renace Plan + Plan de Créditos\n\n1. Empresa tiene:\n   - Plan Selección: 10 unidades + vencimiento\n   - Plan Créditos: 100 créditos + vencimiento\n2. Puede:\n   - Hacer 10 pruebas (consuma unidades)\n   - Hacer pruebas ilimitadas pero con IA (consume créditos)\n3. Consumos se registran en 2 tablas diferentes:\n   - `consumos` (para pruebas)\n   - `consumos_creditos` (para IA)\n\n#### Caso 3: Plan de Créditos Sin Vigencia\n\n1. PlanCredito(creditos=500, sin vencimiento)\n2. Asigna a empresa: EmpresaPlan(creditos=500, fecha_vencimiento=NULL)\n3. Empresa tiene 500 créditos para siempre (mientras no los use)\n4. Si consume 50 → 450 restantes indefinidamente\n\n---\n\n### 16. ARCHIVOS IMPORTANTES RESUMIDOS\n\n| Archivo | Línea/Referencia | Propósito |\n|---------|------------------|----------|\n| `PlanCredito.php` | model | Define estructura de planes de créditos |\n| `EmpresaPlan.php` | L85 `getCreditosRestantesAttribute` | Cálculo dinámico de créditos |\n| `ConsumoCredito.php` | model | Registra cada consumo de IA |\n| `PlanCreditoService.php` | service | Maneja CRUD de planes |\n| `EmpresaPlanService.php` | L76-87, L372-385 | Asigna créditos y calcula historial |\n| `ConsumoCreditoService.php` | L46-229 | Registra consumos de IA |\n| `CreditoIAService.php` | L37-72 | Valida disponibilidad |\n| `EmpresaPlanController.php` | L295-298 | API de historial de créditos |\n| Modal blade | L386-502 | UI para ver historial |\n| `modal-recompras.js` | L126-140 | Lógica para cargar créditos |\n\n---\n\n### 17. CONCLUSIONES Y RECOMENDACIONES\n\n**Flujo Claro**:\n✓ Plan de Créditos → Asignar a Empresa → Usar en IA → Registrar Consumo\n\n**Diferencia con Planes Normales**:\n✓ Planes = Unidades limitadas\n✓ Créditos = Consumo por acción IA\n\n**Características Únicas**:\n✓ Promociones con descuentos\n✓ Vigencia flexible (con o sin fecha)\n✓ Cálculo dinámico de restantes\n✓ Auditoría completa de consumos\n✓ Soporte para múltiples formatos de respuesta IA (Whisper, GPT, Legacy)\n\n**Pendiente**:\n⚠ Exportación de créditos en Excel (línea 725 en modal-recompras.js: \"en desarrollo\")\n⚠ Detalle de consumo de créditos por servicio (línea 462: \"en desarrollo\")\n\n---\n\n### ARCHIVOS ABSOLUTOS REFERENCIADOS\n\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\CreditoIAService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\modal-recompras.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\modal-recompras.js\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000001_create_planes_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000005_rename_consumos_tokens_openai_to_consumos_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":64,"cache_creation_input_tokens":4240,"cache_read_input_tokens":106495,"cache_creation":{"ephemeral_5m_input_tokens":4240,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLj9ybVLiGTu1GUoJuSL","type":"assistant","uuid":"34674bcb-3ce9-410d-9348-dd69c309c649","timestamp":"2026-01-21T15:04:56.048Z"}
