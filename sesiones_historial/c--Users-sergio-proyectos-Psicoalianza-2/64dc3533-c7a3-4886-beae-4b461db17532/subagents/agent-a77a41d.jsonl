{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":"## Contexto del Problema\n\nEl usuario tiene un sistema de planes en Laravel con dos tipos:\n1. **Planes normales**: Con unidades, fecha_inicio, fecha_vencimiento\n2. **Planes de créditos**: Con plan_credito_id y creditos (IA)\n\n### Flujo actual de renovación (EmpresaPlanService::renovar)\n```php\npublic function renovar(int $id): EmpresaPlan {\n    $empresa_plan = $this->repositorio->getUno($id);\n\n    if ($empresa_plan->estado_id === 3) {\n        throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n    }\n\n    $request = new Request(Arr::except($empresa_plan->toArray(), \n        ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n    $request->merge(['por_facturar' => true]);\n\n    if (in_array($empresa_plan->estado_id, [1, 4])) {\n        // Activo o por vencer → estado próximo\n        $request->merge(['estado_id' => 3]);\n    } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n        // Inactivo o vencido → estado activo\n        $request->merge(['estado_id' => 1]);\n    }\n\n    $this->verificarYAsignarTiempo($empresa_plan, $request);\n    // ... crea el plan renovado\n}\n```\n\n### El problema específico\n- Los planes normales SE RENUEVAN sin problema\n- Los planes de CRÉDITOS NO permiten renovar correctamente\n- La diferencia entre plan normal y de créditos:\n  - Plan normal: tiene `plan_id`, `unidades`, `fecha_vencimiento`\n  - Plan créditos: tiene `plan_credito_id`, `creditos` (puede no tener fechas ni plan_id)\n\n### Comportamiento deseado por el usuario\n1. Poder renovar un plan de créditos\n2. El nuevo plan de créditos debería quedar como \"próximo\" (estado 3)\n3. El nuevo plan podría ser \"vacío\" (sin unidades ni fecha)\n4. Se debería seguir consumiendo los créditos del plan vigente hasta que se acaben\n5. Una vez agotados los créditos del plan vigente, activar el nuevo plan de créditos\n\n### Archivos clave a modificar\n- `app/Http/Services/Empresas/EmpresaPlanService.php` - Método renovar()\n- `app/Console/Commands/Empresas/ActivarEInactivarPlanesCommand.php` - Lógica de activación/desactivación\n- Posiblemente el método `verificarYAsignarTiempo()` y `calcularFechasVigencia()`\n\n### Consideraciones\n1. Los planes de créditos NO deben vencer por fecha (vencen cuando se agotan los créditos)\n2. El comando diario `planes:activar-inactivar` debe manejar esta lógica\n3. El atributo `creditos_restantes` ya existe y calcula: `creditos - sum(consumos_creditos.creditos)`\n4. Debe soportar ambos escenarios: plan normal con créditos adicionales, y plan solo de créditos\n\n### Preguntas a resolver en el diseño\n1. ¿Cómo determinar si un plan de créditos debe vencer? (¿cuando creditos_restantes == 0?)\n2. ¿Cómo manejar la renovación cuando el plan vigente tiene créditos pero el nuevo no tiene fechas?\n3. ¿Debe el comando de activación considerar los créditos restantes además de las fechas?\n4. ¿Qué pasa con planes híbridos (plan normal + créditos)?\n\nDiseña un plan detallado para implementar esta funcionalidad de renovación de planes de créditos."},"uuid":"4cbb6a73-55ff-410a-9638-e3bf83b47407","timestamp":"2026-01-21T15:05:24.874Z"}
{"parentUuid":"4cbb6a73-55ff-410a-9638-e3bf83b47407","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ShcFLnHdR4iuPD7MsEnsJK","type":"message","role":"assistant","content":[{"type":"text","text":"I'll analyze the codebase to understand the current implementation and design a comprehensive plan for credit plan renewal functionality."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15845,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15845,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjH11mBCyDznqan5Bs7","type":"assistant","uuid":"c46f41e5-07ba-47b3-ad92-90a17ab1904c","timestamp":"2026-01-21T15:05:27.657Z"}
{"parentUuid":"c46f41e5-07ba-47b3-ad92-90a17ab1904c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ShcFLnHdR4iuPD7MsEnsJK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HC2y5zhPgFvRnKETxVKnyb","name":"Glob","input":{"pattern":"**/EmpresaPlan*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15845,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15845,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjH11mBCyDznqan5Bs7","type":"assistant","uuid":"4d33e67d-f1f5-484f-ba98-94d65dac8318","timestamp":"2026-01-21T15:05:28.087Z"}
{"parentUuid":"4d33e67d-f1f5-484f-ba98-94d65dac8318","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ShcFLnHdR4iuPD7MsEnsJK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FqJ1hgDb3ytpqoy3psS8pF","name":"Glob","input":{"pattern":"**/Planes/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15845,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15845,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjH11mBCyDznqan5Bs7","type":"assistant","uuid":"faea4f3e-6091-4e25-87af-8e65fae6cc85","timestamp":"2026-01-21T15:05:28.402Z"}
{"parentUuid":"faea4f3e-6091-4e25-87af-8e65fae6cc85","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ShcFLnHdR4iuPD7MsEnsJK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Utc4VtFTHimj64cqpm4sKe","name":"Glob","input":{"pattern":"**/ActivarEInactivarPlanesCommand.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15845,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15845,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjH11mBCyDznqan5Bs7","type":"assistant","uuid":"af673578-1ffe-42d6-b919-1311fde36941","timestamp":"2026-01-21T15:05:28.725Z"}
{"parentUuid":"4d33e67d-f1f5-484f-ba98-94d65dac8318","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HC2y5zhPgFvRnKETxVKnyb","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanFuncionalidadController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanFuncionalidadRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\factories\\Empresas\\EmpresaPlanFactory.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\seeders\\EmpresaPlanSeeder.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\seeders\\testing\\EmpresaPlanTestSeeder.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlanFuncionalidad.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php"}]},"uuid":"e410c857-f814-46fd-ac5b-a03c78e2f0fa","timestamp":"2026-01-21T15:05:32.628Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanFuncionalidadController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanFuncionalidadRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\factories\\Empresas\\EmpresaPlanFactory.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\seeders\\EmpresaPlanSeeder.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\seeders\\testing\\EmpresaPlanTestSeeder.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlanFuncionalidad.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php"],"durationMs":1164,"numFiles":10,"truncated":false},"sourceToolAssistantUUID":"4d33e67d-f1f5-484f-ba98-94d65dac8318"}
{"parentUuid":"af673578-1ffe-42d6-b919-1311fde36941","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Utc4VtFTHimj64cqpm4sKe","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php"}]},"uuid":"81a15c65-4e6b-435e-a680-72a490539646","timestamp":"2026-01-21T15:05:32.686Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php"],"durationMs":1220,"numFiles":1,"truncated":false},"sourceToolAssistantUUID":"af673578-1ffe-42d6-b919-1311fde36941"}
{"parentUuid":"faea4f3e-6091-4e25-87af-8e65fae6cc85","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FqJ1hgDb3ytpqoy3psS8pF","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ConsumoController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadPlanController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ModuloController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\ConsumoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\FuncionalidadPlanRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\FuncionalidadRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\ModuloRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Requests\\Planes\\ConsumosAgengasDeEmpresaPlanRequest.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Requests\\Planes\\CrearPlanRequest.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\ConsumoService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\FuncionalidadPlanService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\EstadoPlan.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Funcionalidad.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\FuncionalidadPlan.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Modulo.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Consumo.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"}]},"uuid":"5aa56265-4da2-4c29-b522-e91933356e11","timestamp":"2026-01-21T15:05:32.755Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ConsumoController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadPlanController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ModuloController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\ConsumoRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\FuncionalidadPlanRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\FuncionalidadRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\ModuloRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Requests\\Planes\\ConsumosAgengasDeEmpresaPlanRequest.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Requests\\Planes\\CrearPlanRequest.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\ConsumoService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\FuncionalidadPlanService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\EstadoPlan.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Funcionalidad.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\FuncionalidadPlan.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Modulo.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Consumo.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"],"durationMs":1289,"numFiles":25,"truncated":false},"sourceToolAssistantUUID":"faea4f3e-6091-4e25-87af-8e65fae6cc85"}
{"parentUuid":"5aa56265-4da2-4c29-b522-e91933356e11","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NfhDZXbMody1VqjwoaTGnw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0163HoEmRD12kAL9J6qMHKAT","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":73,"cache_creation_input_tokens":1791,"cache_read_input_tokens":15845,"cache_creation":{"ephemeral_5m_input_tokens":1791,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXLjHb5dUZjQJo5PXJsGY","type":"assistant","uuid":"dcc59cfe-4cd8-4cf5-bf2f-2435c01a6d51","timestamp":"2026-01-21T15:05:35.528Z"}
{"parentUuid":"dcc59cfe-4cd8-4cf5-bf2f-2435c01a6d51","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NfhDZXbMody1VqjwoaTGnw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013BoGFbRh7CyMcLqaATTKhg","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":73,"cache_creation_input_tokens":1791,"cache_read_input_tokens":15845,"cache_creation":{"ephemeral_5m_input_tokens":1791,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXLjHb5dUZjQJo5PXJsGY","type":"assistant","uuid":"954c3930-1f78-4344-914d-649000272e13","timestamp":"2026-01-21T15:05:36.012Z"}
{"parentUuid":"954c3930-1f78-4344-914d-649000272e13","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NfhDZXbMody1VqjwoaTGnw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Lm4RsHEK7n9SDvNQGt4qYZ","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":73,"cache_creation_input_tokens":1791,"cache_read_input_tokens":15845,"cache_creation":{"ephemeral_5m_input_tokens":1791,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXLjHb5dUZjQJo5PXJsGY","type":"assistant","uuid":"3ded8a6f-c71a-438a-8ff4-e5c309962872","timestamp":"2026-01-21T15:05:36.621Z"}
{"parentUuid":"954c3930-1f78-4344-914d-649000272e13","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013BoGFbRh7CyMcLqaATTKhg","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Empresas;\n     4→\n     5→use App\\Models\\Planes\\Plan;\n     6→use App\\Models\\Usuarios\\User;\n     7→use App\\Models\\Planes\\Consumo;\n     8→use App\\Models\\Pruebas\\Prueba;\n     9→use OwenIt\\Auditing\\Auditable;\n    10→use App\\Models\\IA\\ConsumoCredito;\n    11→use App\\Models\\Planes\\EstadoPlan;\n    12→use App\\Models\\Planes\\PlanCredito;\n    13→use App\\Models\\Planes\\Funcionalidad;\n    14→use App\\Models\\Configuraciones\\Archivo;\n    15→use Illuminate\\Database\\Eloquent\\Model;\n    16→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n    17→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    18→use Illuminate\\Database\\Eloquent\\Relations\\MorphMany;\n    19→use Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n    20→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    21→\n    22→class EmpresaPlan extends Model implements AuditableContract\n    23→{\n    24→    use Auditable;\n    25→\n    26→    protected $table = 'empresas_planes';\n    27→\n    28→    protected $fillable = [\n    29→        'empresa_id',\n    30→        'plan_id',\n    31→        'plan_credito_id',\n    32→        'usuario_id',\n    33→        'estado_id',\n    34→        'unidades',\n    35→        'cantidad_ofertas_laborales',\n    36→        'cantidad_usuarios',\n    37→        'cantidad_pruebas',\n    38→        'creditos',\n    39→        'fecha_inicio',\n    40→        'fecha_vencimiento',\n    41→        'precio',\n    42→        'porcentaje_descuento',\n    43→        'numero_factura',\n    44→        'comentario',\n    45→        'plan_original',\n    46→        'renovando',\n    47→        'por_facturar'\n    48→    ];\n    49→\n    50→    protected $casts = [\n    51→        'plan_credito_id'   => 'integer',\n    52→        'creditos'          => 'integer',\n    53→        'fecha_inicio'      => 'date:Y-m-d',\n    54→        'fecha_vencimiento' => 'date:Y-m-d'\n    55→    ];\n    56→\n    57→    protected $appends = [\n    58→        'vigencia_dias',\n    59→        'creditos_restantes'\n    60→    ];\n    61→\n    62→    /**\n    63→     * Obtener el atributo vigencia_dias.\n    64→     *\n    65→     * @return int\n    66→     * @author Daniel Beltrán\n    67→     */\n    68→    public function getVigenciaDiasAttribute(): int {\n    69→        $vigencia = 0;\n    70→\n    71→        if (!is_null($this->fecha_vencimiento) && !is_null($this->fecha_inicio)) {\n    72→            $vigencia = $this->fecha_inicio->diffInDays($this->fecha_vencimiento);\n    73→        }\n    74→\n    75→        return $vigencia;\n    76→    }\n    77→\n    78→    /**\n    79→     * Obtener el atributo creditos_restantes.\n    80→     *\n    81→     * @return int\n    82→     * @author Sergio Vargas\n    83→     * @author Daniel Beltrán\n    84→     */\n    85→    public function getCreditosRestantesAttribute(): int {\n    86→        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    87→    }\n    88→\n    89→    /**\n    90→     * Relación de muchos a uno con empresas.\n    91→     *\n    92→     * @return BelongsTo\n    93→     * @author Daniel Beltrán\n    94→     */\n    95→    public function empresa(): BelongsTo {\n    96→        return $this->belongsTo(Empresa::class);\n    97→    }\n    98→\n    99→    /**\n   100→     * Relación de muchos a uno con planes.\n   101→     *\n   102→     * @return BelongsTo\n   103→     * @author Daniel Beltrán\n   104→     */\n   105→    public function plan(): BelongsTo {\n   106→        return $this->belongsTo(Plan::class);\n   107→    }\n   108→\n   109→    /**\n   110→     * Relación de muchos a uno con planes_creditos.\n   111→     *\n   112→     * @return BelongsTo\n   113→     * @author Sergio Vargas\n   114→     * @author Daniel Beltrán\n   115→     * @author Jair Carvajal\n   116→     */\n   117→    public function planCredito(): BelongsTo {\n   118→        return $this->belongsTo(PlanCredito::class, 'plan_credito_id')->withDefault([]);\n   119→    }\n   120→\n   121→    /**\n   122→     * Relación de uno a varios con users.\n   123→     *\n   124→     * @return BelongsTo\n   125→     * @author José Manuel Jiménez\n   126→     */\n   127→    public function usuario(): BelongsTo {\n   128→        return $this->belongsTo(User::class);\n   129→    }\n   130→\n   131→    /**\n   132→     * Relación de muchos a uno con estados_planes.\n   133→     *\n   134→     * @return BelongsTo\n   135→     * @author Daniel Beltrán\n   136→     */\n   137→    public function estado(): BelongsTo {\n   138→        return $this->belongsTo(EstadoPlan::class);\n   139→    }\n   140→\n   141→    /**\n   142→     * Relación de uno a muchos con consumos.\n   143→     *\n   144→     * @return HasMany\n   145→     * @author Daniel Beltrán\n   146→     */\n   147→    public function consumos(): HasMany {\n   148→        return $this->hasMany(Consumo::class, 'empresa_plan_id');\n   149→    }\n   150→\n   151→    /**\n   152→     * Relación de uno a muchos con consumos de créditos.\n   153→     *\n   154→     * @return HasMany\n   155→     * @author Sergio Vargas\n   156→     * @author Daniel Beltrán\n   157→     */\n   158→    public function consumosCreditos(): HasMany {\n   159→        return $this->hasMany(ConsumoCredito::class, 'empresa_plan_id');\n   160→    }\n   161→\n   162→    /**\n   163→     * Relación de muchos a muchos con pruebas.\n   164→     *\n   165→     * @return BelongsToMany\n   166→     * @author Daniel Beltrán\n   167→     */\n   168→    public function pruebas(): BelongsToMany {\n   169→        return $this->belongsToMany(Prueba::class, 'empresas_planes_pruebas', 'empresa_plan_id', 'prueba_id')->withTimestamps();\n   170→    }\n   171→\n   172→    /**\n   173→     * Relación polimórfica de uno a muchos con archivos.\n   174→     *\n   175→     * @return MorphMany\n   176→     * @author Daniel Beltrán\n   177→     */\n   178→    public function archivos(): MorphMany {\n   179→        return $this->morphMany(Archivo::class, 'modelo', 'modelo', 'modelo_id');\n   180→    }\n   181→\n   182→    /**\n   183→     * Relación de muchos a muchos con funcionalidades.\n   184→     *\n   185→     * @return BelongsToMany\n   186→     * @author Daniel Beltrán\n   187→     */\n   188→    public function funcionalidades(): BelongsToMany {\n   189→        return $this->belongsToMany(Funcionalidad::class, 'empresas_planes_funcionalidades', 'empresa_plan_id', 'funcionalidad_id')->withTimestamps();\n   190→    }\n   191→}\n   192→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"69376631-9637-4ffe-a6cf-67847174990e","timestamp":"2026-01-21T15:05:39.501Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php","content":"<?php\n\nnamespace App\\Models\\Empresas;\n\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Usuarios\\User;\nuse App\\Models\\Planes\\Consumo;\nuse App\\Models\\Pruebas\\Prueba;\nuse OwenIt\\Auditing\\Auditable;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Models\\Planes\\EstadoPlan;\nuse App\\Models\\Planes\\PlanCredito;\nuse App\\Models\\Planes\\Funcionalidad;\nuse App\\Models\\Configuraciones\\Archivo;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Database\\Eloquent\\Relations\\MorphMany;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\nuse OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n\nclass EmpresaPlan extends Model implements AuditableContract\n{\n    use Auditable;\n\n    protected $table = 'empresas_planes';\n\n    protected $fillable = [\n        'empresa_id',\n        'plan_id',\n        'plan_credito_id',\n        'usuario_id',\n        'estado_id',\n        'unidades',\n        'cantidad_ofertas_laborales',\n        'cantidad_usuarios',\n        'cantidad_pruebas',\n        'creditos',\n        'fecha_inicio',\n        'fecha_vencimiento',\n        'precio',\n        'porcentaje_descuento',\n        'numero_factura',\n        'comentario',\n        'plan_original',\n        'renovando',\n        'por_facturar'\n    ];\n\n    protected $casts = [\n        'plan_credito_id'   => 'integer',\n        'creditos'          => 'integer',\n        'fecha_inicio'      => 'date:Y-m-d',\n        'fecha_vencimiento' => 'date:Y-m-d'\n    ];\n\n    protected $appends = [\n        'vigencia_dias',\n        'creditos_restantes'\n    ];\n\n    /**\n     * Obtener el atributo vigencia_dias.\n     *\n     * @return int\n     * @author Daniel Beltrán\n     */\n    public function getVigenciaDiasAttribute(): int {\n        $vigencia = 0;\n\n        if (!is_null($this->fecha_vencimiento) && !is_null($this->fecha_inicio)) {\n            $vigencia = $this->fecha_inicio->diffInDays($this->fecha_vencimiento);\n        }\n\n        return $vigencia;\n    }\n\n    /**\n     * Obtener el atributo creditos_restantes.\n     *\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getCreditosRestantesAttribute(): int {\n        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    }\n\n    /**\n     * Relación de muchos a uno con empresas.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function empresa(): BelongsTo {\n        return $this->belongsTo(Empresa::class);\n    }\n\n    /**\n     * Relación de muchos a uno con planes.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function plan(): BelongsTo {\n        return $this->belongsTo(Plan::class);\n    }\n\n    /**\n     * Relación de muchos a uno con planes_creditos.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planCredito(): BelongsTo {\n        return $this->belongsTo(PlanCredito::class, 'plan_credito_id')->withDefault([]);\n    }\n\n    /**\n     * Relación de uno a varios con users.\n     *\n     * @return BelongsTo\n     * @author José Manuel Jiménez\n     */\n    public function usuario(): BelongsTo {\n        return $this->belongsTo(User::class);\n    }\n\n    /**\n     * Relación de muchos a uno con estados_planes.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function estado(): BelongsTo {\n        return $this->belongsTo(EstadoPlan::class);\n    }\n\n    /**\n     * Relación de uno a muchos con consumos.\n     *\n     * @return HasMany\n     * @author Daniel Beltrán\n     */\n    public function consumos(): HasMany {\n        return $this->hasMany(Consumo::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de uno a muchos con consumos de créditos.\n     *\n     * @return HasMany\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function consumosCreditos(): HasMany {\n        return $this->hasMany(ConsumoCredito::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de muchos a muchos con pruebas.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function pruebas(): BelongsToMany {\n        return $this->belongsToMany(Prueba::class, 'empresas_planes_pruebas', 'empresa_plan_id', 'prueba_id')->withTimestamps();\n    }\n\n    /**\n     * Relación polimórfica de uno a muchos con archivos.\n     *\n     * @return MorphMany\n     * @author Daniel Beltrán\n     */\n    public function archivos(): MorphMany {\n        return $this->morphMany(Archivo::class, 'modelo', 'modelo', 'modelo_id');\n    }\n\n    /**\n     * Relación de muchos a muchos con funcionalidades.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function funcionalidades(): BelongsToMany {\n        return $this->belongsToMany(Funcionalidad::class, 'empresas_planes_funcionalidades', 'empresa_plan_id', 'funcionalidad_id')->withTimestamps();\n    }\n}\n","numLines":192,"startLine":1,"totalLines":192}},"sourceToolAssistantUUID":"954c3930-1f78-4344-914d-649000272e13"}
{"parentUuid":"3ded8a6f-c71a-438a-8ff4-e5c309962872","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Lm4RsHEK7n9SDvNQGt4qYZ","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Console\\Commands\\Empresas;\n     4→\n     5→use Exception;\n     6→use Carbon\\Carbon;\n     7→use App\\Models\\Planes\\Plan;\n     8→use Illuminate\\Http\\Request;\n     9→use Illuminate\\Console\\Command;\n    10→use Illuminate\\Support\\Facades\\DB;\n    11→use App\\Models\\Empresas\\EmpresaPlan;\n    12→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    13→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    14→\n    15→/**\n    16→ * Comando para gestionar la activación e inactivación de los planes de las empresas.\n    17→ *\n    18→ * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n    19→ * completa de los estados de los planes con sus descripciones.\n    20→ *\n    21→ * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n    22→ * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n    23→ *\n    24→ * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n    25→ * días fueron recomendados desde comercial.\n    26→ *\n    27→ * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n    28→ *\n    29→ * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n    30→ * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n    31→ * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n    32→ *\n    33→ * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n    34→ * una vez se sube el archivo, el plan pasa a estar activo.\n    35→ *\n    36→ * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n    37→ *\n    38→ * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n    39→ *\n    40→ * @package App\\Console\\Commands\\Empresas\n    41→ * @version 0.0.3\n    42→ * @author Daniel Beltrán\n    43→ * @author Fahibram Cárcamo\n    44→ */\n    45→class ActivarEInactivarPlanesCommand extends Command\n    46→{\n    47→    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n    48→\n    49→    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n    50→\n    51→    /**\n    52→     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n    53→     *\n    54→     * @var int\n    55→     * @author Fahibram Cárcamo\n    56→     */\n    57→    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n    58→\n    59→    /**\n    60→     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n    61→     *\n    62→     * @var int\n    63→     * @author Fahibram Cárcamo\n    64→     */\n    65→    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n    66→\n    67→    /**\n    68→     * Constructor.\n    69→     *\n    70→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n    71→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    72→     * @return void\n    73→     * @author Daniel Beltrán\n    74→     */\n    75→    public function __construct(\n    76→        private EmpresaPlanRepository $empresa_plan_repositorio,\n    77→        private EmpresaPlanService $empresa_plan_servicio\n    78→    ) {\n    79→        parent::__construct();\n    80→    }\n    81→\n    82→    /**\n    83→     * Activar e inactivar los planes de las empresas.\n    84→     *\n    85→     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n    86→     *\n    87→     * @return void\n    88→     * @author Daniel Beltrán\n    89→     * @author Fahibram Cárcamo\n    90→     */\n    91→    public function handle() {\n    92→        $empresa_id   = $this->argument('empresa_id');\n    93→        $fecha_actual = now()->startOfDay();\n    94→        $request      = new Request([\n    95→            'estados_ids'     => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n    96→            'ordenar_por'     => 'created_at',\n    97→            'ordenar_sentido' => 'ASC'\n    98→        ]);\n    99→\n   100→        if (!is_null($empresa_id)) {\n   101→            $request->merge(['empresa_id' => $empresa_id]);\n   102→        }\n   103→\n   104→        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n   105→        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n   106→\n   107→        try {\n   108→            DB::beginTransaction();\n   109→\n   110→            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n   111→                foreach ($planes as $plan) {\n   112→                    $empresa_id = $plan->empresa_id;\n   113→\n   114→                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n   115→                        if ($this->planVencido($plan)) {\n   116→                            // Desactivar el plan si ya ha vencido\n   117→                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n   118→                        } else {\n   119→                            $this->establecerPlanProximoAVencer($plan);\n   120→                            $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n   121→                        }\n   122→                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n   123→                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID && !is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n   124→                        // Verificar si ya existe un plan activo del mismo tipo de prueba.\n   125→                        $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   126→\n   127→                        if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n   128→                            continue;\n   129→                        }\n   130→\n   131→                        $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   132→                    }\n   133→                }\n   134→            }\n   135→\n   136→            DB::commit();\n   137→\n   138→            $this->info('Planes de empresas actualizados correctamente');\n   139→        } catch (Exception $error) {\n   140→            DB::rollBack();\n   141→            $this->error('Error al actualizar los planes de empresas');\n   142→        }\n   143→    }\n   144→\n   145→    /**\n   146→     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n   147→     *\n   148→     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n   149→     * @return bool\n   150→     * @author Fahibram Cárcamo\n   151→     */\n   152→    private function planVencido(EmpresaPlan $empresa_plan): bool {\n   153→        if (is_null($empresa_plan->fecha_vencimiento)) {\n   154→            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n   155→            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas) &&\n   156→                (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n   157→        } else {\n   158→            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n   159→            // tienen una fecha de inicio posterior a la actual).\n   160→            $fecha_actual = now()->startOfDay();\n   161→            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n   162→        }\n   163→    }\n   164→\n   165→    /**\n   166→     * Establecer las fechas de vigencia del próximo plan del cliente.\n   167→     *\n   168→     * @param int $empresa_id Id de la empresa.\n   169→     * @param int $tipo_prueba_id Id del tipo de prueba.\n   170→     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n   171→     * @return void\n   172→     * @author Daniel Beltrán\n   173→     * @author Fahibram Cárcamo\n   174→     */\n   175→    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n   176→        // Se busca el próximo plan\n   177→        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   178→\n   179→        // Se verifica si existe un próximo plan y si es ilimitado\n   180→        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n   181→            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n   182→                $plan_proximo->vigencia_dias,\n   183→                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n   184→            );\n   185→\n   186→            // Se establecen las fechas de vigencia del la suscripción al plan\n   187→            $this->empresa_plan_repositorio->actualizar(\n   188→                $plan_proximo->id,\n   189→                [\n   190→                    'fecha_inicio'      => $fechas['fecha_inicio'],\n   191→                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n   192→                ]\n   193→            );\n   194→        }\n   195→    }\n   196→\n   197→    /**\n   198→     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n   199→     *\n   200→     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n   201→     *\n   202→     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n   203→     * @return void\n   204→     * @author Fahibram Cárcamo\n   205→     */\n   206→    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n   207→        if (is_null($empresa_plan->fecha_vencimiento)) {\n   208→            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n   209→            $total_consumido            = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n   210→\n   211→            if (\n   212→                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles) &&\n   213→                $total_consumido < $total_consumos_disponibles\n   214→            ) {\n   215→                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n   216→            }\n   217→        } else {\n   218→            $fecha_actual      = now()->startOfDay();\n   219→            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n   220→\n   221→            if (\n   222→                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER &&\n   223→                intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n   224→            ) {\n   225→                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n   226→            }\n   227→        }\n   228→    }\n   229→}\n   230→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0b65256c-2217-4b7c-9bbd-5ec9eb643276","timestamp":"2026-01-21T15:05:39.501Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","content":"<?php\n\nnamespace App\\Console\\Commands\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Console\\Command;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\n/**\n * Comando para gestionar la activación e inactivación de los planes de las empresas.\n *\n * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n * completa de los estados de los planes con sus descripciones.\n *\n * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n *\n * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n * días fueron recomendados desde comercial.\n *\n * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n *\n * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n *\n * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n * una vez se sube el archivo, el plan pasa a estar activo.\n *\n * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n *\n * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n *\n * @package App\\Console\\Commands\\Empresas\n * @version 0.0.3\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nclass ActivarEInactivarPlanesCommand extends Command\n{\n    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n\n    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n\n    /**\n     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n     *\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n\n    /**\n     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n     *\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private EmpresaPlanRepository $empresa_plan_repositorio,\n        private EmpresaPlanService $empresa_plan_servicio\n    ) {\n        parent::__construct();\n    }\n\n    /**\n     * Activar e inactivar los planes de las empresas.\n     *\n     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n     *\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function handle() {\n        $empresa_id   = $this->argument('empresa_id');\n        $fecha_actual = now()->startOfDay();\n        $request      = new Request([\n            'estados_ids'     => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n            'ordenar_por'     => 'created_at',\n            'ordenar_sentido' => 'ASC'\n        ]);\n\n        if (!is_null($empresa_id)) {\n            $request->merge(['empresa_id' => $empresa_id]);\n        }\n\n        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n\n        try {\n            DB::beginTransaction();\n\n            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n                foreach ($planes as $plan) {\n                    $empresa_id = $plan->empresa_id;\n\n                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n                        } else {\n                            $this->establecerPlanProximoAVencer($plan);\n                            $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                        }\n                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID && !is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                        // Verificar si ya existe un plan activo del mismo tipo de prueba.\n                        $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                        if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                            continue;\n                        }\n\n                        $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                    }\n                }\n            }\n\n            DB::commit();\n\n            $this->info('Planes de empresas actualizados correctamente');\n        } catch (Exception $error) {\n            DB::rollBack();\n            $this->error('Error al actualizar los planes de empresas');\n        }\n    }\n\n    /**\n     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    private function planVencido(EmpresaPlan $empresa_plan): bool {\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas) &&\n                (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n        } else {\n            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n            // tienen una fecha de inicio posterior a la actual).\n            $fecha_actual = now()->startOfDay();\n            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n        }\n    }\n\n    /**\n     * Establecer las fechas de vigencia del próximo plan del cliente.\n     *\n     * @param int $empresa_id Id de la empresa.\n     * @param int $tipo_prueba_id Id del tipo de prueba.\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n                $plan_proximo->vigencia_dias,\n                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                [\n                    'fecha_inicio'      => $fechas['fecha_inicio'],\n                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n                ]\n            );\n        }\n    }\n\n    /**\n     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n     *\n     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n     *\n     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n            $total_consumido            = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n\n            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles) &&\n                $total_consumido < $total_consumos_disponibles\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        } else {\n            $fecha_actual      = now()->startOfDay();\n            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n\n            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER &&\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        }\n    }\n}\n","numLines":230,"startLine":1,"totalLines":230}},"sourceToolAssistantUUID":"3ded8a6f-c71a-438a-8ff4-e5c309962872"}
{"parentUuid":"dcc59cfe-4cd8-4cf5-bf2f-2435c01a6d51","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0163HoEmRD12kAL9J6qMHKAT","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Empresas;\n     4→\n     5→use Exception;\n     6→use Carbon\\Carbon;\n     7→use Illuminate\\Support\\Arr;\n     8→use App\\Traits\\ArchivoTrait;\n     9→use Illuminate\\Http\\Request;\n    10→use App\\Mail\\CrearUsuarioMail;\n    11→use Illuminate\\Http\\UploadedFile;\n    12→use App\\Http\\Services\\BaseService;\n    13→use Illuminate\\Support\\Collection;\n    14→use App\\Models\\Empresas\\EmpresaPlan;\n    15→use App\\Models\\Pruebas\\TipoPrueba;\n    16→use Illuminate\\Support\\Facades\\Notification;\n    17→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    18→use Illuminate\\Support\\Facades\\{Mail, Password};\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    21→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    22→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    23→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    24→use App\\Notifications\\SolicitudRenovacionPlanNotification;\n    25→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    26→use Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n    27→\n    28→/**\n    29→ * @property EmpresaPlanRepository $repositorio\n    30→ */\n    31→class EmpresaPlanService extends BaseService\n    32→{\n    33→    use ArchivoTrait;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n    39→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    40→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    41→     * @param PlanRepository $plan_repositorio Repositorio de planes.\n    42→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    43→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    44→     * @return void\n    45→     * @author Daniel Beltrán\n    46→     */\n    47→    public function __construct(\n    48→        EmpresaPlanRepository $repositorio,\n    49→        protected EmpresaRepository $empresa_repositorio,\n    50→        protected RolRepository $rol_repositorio,\n    51→        protected PlanRepository $plan_repositorio,\n    52→        protected PlanCreditoRepository $plan_credito_repositorio,\n    53→        protected ArchivoRepository $archivo_repositorio,\n    54→        protected UserRepository $usuario_repositorio\n    55→    ) {\n    56→        parent::__construct($repositorio);\n    57→    }\n    58→\n    59→    /**\n    60→     * Guardar un plan de empresa.\n    61→     *\n    62→     * @param Request $request Contenido de la petición.\n    63→     * @return EmpresaPlan\n    64→     * @author Sergio Vargas\n    65→     * @author Daniel Beltrán\n    66→     * @author Andres Morales\n    67→     * @author Jair Carvajal\n    68→     */\n    69→    public function guardar(Request $request): EmpresaPlan {\n    70→        $bandera_enviar_correo = false;\n    71→        $campos_excluidos      = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n    72→        $plan                  = $this->plan_repositorio->getUno($request->plan_id);\n    73→        $plan_activo           = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n    74→        $vigencia              = $plan->vigencia;\n    75→\n    76→        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n    77→            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n    78→\n    79→            if ($plan_credito) {\n    80→                $request->merge(['creditos' => $plan_credito->creditos]);\n    81→            }\n    82→        } elseif (!$request->filled('plan_credito_id')) {\n    83→            $request->merge([\n    84→                'plan_credito_id' => null,\n    85→                'creditos'        => null\n    86→            ]);\n    87→        }\n    88→\n    89→        if ($request->filled('vigencia')) {\n    90→            $vigencia = $request->vigencia;\n    91→        }\n    92→\n    93→        if (!is_null($plan_activo)) {\n    94→            if ($request->filled('id')) {\n    95→                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n    96→                if ($request->id === $plan_activo->id) {\n    97→                    goto omitir_calcular_vigencia;\n    98→                }\n    99→\n   100→                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n   101→                if ($vigencia == $request->vigencia) {\n   102→                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n   103→                    goto omitir_calcular_vigencia;\n   104→                }\n   105→            }\n   106→\n   107→            // Poner el nuevo plan como próximo\n   108→            $request->merge(['estado_id' => 3]);\n   109→\n   110→            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n   111→            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n   112→                // Agregar las nuevas fechas al nuevo plan\n   113→                $hoy          = now();\n   114→                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n   115→                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n   116→            }\n   117→        } else {\n   118→            $request->merge(['estado_id' => 1]);\n   119→\n   120→            // Validar si el plan seleccionado tiene vigencia\n   121→            if (!is_null($plan->vigencia)) {\n   122→                $request->merge($this->calcularFechasVigencia($vigencia));\n   123→            }\n   124→        }\n   125→\n   126→        omitir_calcular_vigencia:\n   127→\n   128→        if (!$request->filled('unidades')) {\n   129→            $request->merge(['unidades' => $plan->unidades]);\n   130→        } elseif ($request->unidades != $plan->unidades) {\n   131→            $request->merge(['plan_original' => false]);\n   132→        }\n   133→\n   134→        if (!$request->filled('cantidad_ofertas_laborales')) {\n   135→            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n   136→        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n   137→            $request->merge(['plan_original' => false]);\n   138→        }\n   139→\n   140→        if (!$request->filled('cantidad_usuarios')) {\n   141→            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n   142→        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n   143→            $request->merge(['plan_original' => false]);\n   144→        }\n   145→\n   146→        if (!$request->filled('cantidad_pruebas')) {\n   147→            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n   148→        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n   149→            $request->merge(['plan_original' => false]);\n   150→        }\n   151→\n   152→        // Comprobar si se modificaron las funcionalidades respecto al plan original\n   153→        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n   154→            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n   155→            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n   156→            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n   157→\n   158→            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n   159→                $request->merge(['plan_original' => false]);\n   160→            }\n   161→        }\n   162→\n   163→        if ($request->filled('id')) {\n   164→            // Eliminar la factura actual\n   165→            if ($request->hasFile('factura')) {\n   166→                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n   167→\n   168→                if (!is_null($archivo)) {\n   169→                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n   170→                    $this->archivo_repositorio->eliminar($archivo->id);\n   171→                }\n   172→            }\n   173→\n   174→            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n   175→        } else {\n   176→            $bandera_enviar_correo = true;\n   177→            $request->merge(['usuario_id' => auth()->user()->id]);\n   178→            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n   179→        }\n   180→\n   181→        if ($request->filled('pruebas')) {\n   182→            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n   183→        }\n   184→\n   185→        if ($request->filled('funcionalidades')) {\n   186→            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n   187→        }\n   188→\n   189→        // Guardar la factura\n   190→        if ($request->hasFile('factura')) {\n   191→            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n   192→        }\n   193→\n   194→        if ($bandera_enviar_correo) {\n   195→            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n   196→            $usuario      = $empresa->usuarios[0];\n   197→            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n   198→\n   199→            $titulo = 'Usuario principal de la empresa creado';\n   200→            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n   201→        }\n   202→\n   203→        return $plan_asignado;\n   204→    }\n   205→\n   206→    /**\n   207→     * Renovar el plan asignado.\n   208→     *\n   209→     * @param int $id ID del plan de la empresa que se quiere renovar.\n   210→     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n   211→     * @return EmpresaPlan Plan de la empresa renovado.\n   212→     * @author Daniel Beltrán\n   213→     */\n   214→    public function renovar(int $id): EmpresaPlan {\n   215→        $empresa_plan = $this->repositorio->getUno($id);\n   216→\n   217→        if ($empresa_plan->estado_id === 3) {\n   218→            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n   219→        }\n   220→\n   221→        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n   222→        $request->merge(['por_facturar' => true]);\n   223→\n   224→        if (in_array($empresa_plan->estado_id, [1, 4])) {\n   225→            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n   226→            $request->merge(['estado_id' => 3]);\n   227→        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n   228→            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n   229→            $request->merge(['estado_id' => 1]);\n   230→        }\n   231→\n   232→        $this->verificarYAsignarTiempo($empresa_plan, $request);\n   233→        $plan_renovado = $this->repositorio->crear($request->toArray());\n   234→\n   235→        if ($request->filled('pruebas')) {\n   236→            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n   237→        }\n   238→\n   239→        if ($request->filled('funcionalidades')) {\n   240→            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n   241→        }\n   242→\n   243→        return $plan_renovado;\n   244→    }\n   245→\n   246→    /**\n   247→     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n   248→     *\n   249→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   250→     * @param Request $request Contenido de la petición.\n   251→     * @return void\n   252→     * @author Daniel Beltrán\n   253→     */\n   254→    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n   255→        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n   256→            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n   257→        }\n   258→    }\n   259→\n   260→    /**\n   261→     * Calcular las fechas en las que el plan estará vigente.\n   262→     *\n   263→     * @param int $vigencia Cantidad de días de vigencia.\n   264→     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n   265→     * @return array Fechas de inicio y vencimiento.\n   266→     * @author Daniel Beltrán\n   267→     */\n   268→    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n   269→        $hoy          = now();\n   270→        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n   271→\n   272→        // Si es múltiplo de 3, entonces la vigencia es en meses\n   273→        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n   274→            $meses             = $vigencia / 30;\n   275→            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n   276→\n   277→            if ($fecha_inicio->day === 1) {\n   278→                $fecha_vencimiento->subDay();\n   279→            }\n   280→        } else {\n   281→            $vigencia          = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n   282→            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n   283→        }\n   284→\n   285→        return [\n   286→            'fecha_inicio'      => $fecha_inicio->format('Y-m-d'),\n   287→            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n   288→        ];\n   289→    }\n   290→\n   291→    /**\n   292→     * Facturar un plan de empresa.\n   293→     *\n   294→     * @param int $id ID del plan de empresa.\n   295→     * @param Request $request Contenido de la petición.\n   296→     * @return EmpresaPlan\n   297→     * @author Daniel Beltrán\n   298→     */\n   299→    public function facturar(int $id, Request $request): EmpresaPlan {\n   300→        $empresa_plan = $this->repositorio->getUno($id);\n   301→\n   302→        if ($request->filled('vigencia')) {\n   303→            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n   304→        }\n   305→\n   306→        $request->merge(['por_facturar' => false]);\n   307→\n   308→        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n   309→        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n   310→\n   311→        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n   312→        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n   313→    }\n   314→\n   315→    /**\n   316→     * Guardar factura.\n   317→     *\n   318→     * @param int $id ID del plan de empresa.\n   319→     * @param int $empresa_id ID de la empresa.\n   320→     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n   321→     * @return void\n   322→     * @author Daniel Beltrán\n   323→     */\n   324→    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n   325→        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n   326→        $this->generarDirectorios(\"app/{$ruta}\");\n   327→        $nombre_archivo = $this->generarNombreArchivo($archivo);\n   328→        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n   329→\n   330→        $this->archivo_repositorio->crear([\n   331→            'modelo'    => 'App\\Models\\Empresas\\EmpresaPlan',\n   332→            'modelo_id' => $id,\n   333→            'nombre'    => 'factura',\n   334→            'ruta'      => $ruta . '/' . $nombre_archivo\n   335→        ]);\n   336→    }\n   337→\n   338→    /**\n   339→     * Obtener el historial de recompras de una empresa por tipo de prueba.\n   340→     *\n   341→     * @param Request $request Contenido de la petición HTTP entrante.\n   342→     * @return Collection\n   343→     * @author Daniel Beltrán\n   344→     * @author Fahibram Cárcamo\n   345→     * @author Andres Morales\n   346→     * @author Andres Gonzalez\n   347→     */\n   348→    public function historialRecompras(Request $request): Collection {\n   349→        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n   350→        $request->merge([\n   351→            'con_conteo_consumos_agendas'           => true,\n   352→            'con_conteo_consumos_ofertas_laborales' => true\n   353→        ]);\n   354→\n   355→        return match ($rol_usuario->id) {\n   356→            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n   357→            RolRepository::ROL_PROPIETARIO_ID,\n   358→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   359→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   360→            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n   361→        };\n   362→    }\n   363→\n   364→    /**\n   365→     * Obtener el historial de compras de planes con creditos para una empresa.\n   366→     *\n   367→     * @param int $empresa_id ID de la empresa.\n   368→     * @param Request $request Contenido de la peticion.\n   369→     * @return Collection\n   370→     * @author Sergio Vargas\n   371→     */\n   372→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   373→        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n   374→\n   375→        return $historial->map(function (EmpresaPlan $plan) {\n   376→            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n   377→            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n   378→\n   379→            $plan->creditos_totales = $total_creditos;\n   380→            $plan->creditos_consumidos = $creditos_consumidos;\n   381→            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n   382→\n   383→            return $plan;\n   384→        });\n   385→    }\n   386→\n   387→    /**\n   388→     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n   389→     *\n   390→     * @param int $empresa_id ID de la empresa.\n   391→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   392→     * @return ?EmpresaPlan\n   393→     * @author Daniel Beltrán\n   394→     */\n   395→    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   396→        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n   397→            'empresa_id'             => $empresa_id,\n   398→            'tipo_prueba_id'         => $tipo_prueba_id,\n   399→            'excluir_estado_proximo' => true\n   400→        ]));\n   401→\n   402→        if (!is_null($plan)) {\n   403→            $plan_proximo       = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   404→            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n   405→        }\n   406→\n   407→        return $plan;\n   408→    }\n   409→\n   410→    /**\n   411→     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n   412→     *\n   413→     * @param int $id ID del plan de empresa.\n   414→     * @return ?EmpresaPlan\n   415→     * @author Daniel Beltrán\n   416→     */\n   417→    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n   418→        $plan               = $this->repositorio->getUno($id);\n   419→        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n   420→        return $plan;\n   421→    }\n   422→\n   423→    /**\n   424→     * Obtener el plan activo de la empresa por tipo de prueba.\n   425→     *\n   426→     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n   427→     * La propiedad se llama 'plan_proximo' y es un booleano.\n   428→     *\n   429→     * @param int $empresa_id ID de la empresa.\n   430→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   431→     * @return ?EmpresaPlan\n   432→     * @author Daniel Beltrán\n   433→     */\n   434→    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   435→        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   436→\n   437→        if (!is_null($plan)) {\n   438→            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n   439→        }\n   440→\n   441→        return $plan;\n   442→    }\n   443→\n   444→    /**\n   445→     * Solicitar la renovación de un plan específico de una empresa específica.\n   446→     *\n   447→     * @param Request $request Solicitud HTTP.\n   448→     * @return void\n   449→     * @author Fahibram Cárcamo\n   450→     */\n   451→    public function solicitarRenovacionPlan(Request $request) {\n   452→        $plan                = $this->plan_repositorio->getUno($request->plan_id);\n   453→        $empresa             = $this->empresa_repositorio->getUno($request->empresa_id);\n   454→        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n   455→\n   456→        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   457→            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n   458→            'con_roles_ids' => true\n   459→        ]));\n   460→\n   461→        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   462→            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n   463→            'empresa_id'    => $request->empresa_id,\n   464→            'con_roles_ids' => true\n   465→        ]));\n   466→\n   467→        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n   468→\n   469→        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n   470→    }\n   471→\n   472→    /**\n   473→     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n   474→     *\n   475→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   476→     * @return bool\n   477→     * @author Daniel Beltrán\n   478→     * @author Fahibram Cárcamo\n   479→     */\n   480→    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n   481→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   482→            return true;\n   483→        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n   484→            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n   485→                return true;\n   486→            }\n   487→        }\n   488→\n   489→        return false;\n   490→    }\n   491→\n   492→    /**\n   493→     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n   494→     *\n   495→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   496→     * @return bool\n   497→     * @author Daniel Beltrán\n   498→     * @author Fahibram Cárcamo\n   499→     */\n   500→    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   501→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   502→            return true;\n   503→        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n   504→            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n   505→                return true;\n   506→            }\n   507→        }\n   508→\n   509→        return false;\n   510→    }\n   511→\n   512→    /**\n   513→     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n   514→     *\n   515→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   516→     * @return bool\n   517→     * @author Fahibram Cárcamo\n   518→     */\n   519→    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n   520→        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n   521→    }\n   522→\n   523→    /**\n   524→     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n   525→     *\n   526→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   527→     * @return bool\n   528→     * @author Fahibram Cárcamo\n   529→     */\n   530→    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   531→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n   532→    }\n   533→\n   534→    /**\n   535→     * Verificar que la fecha de vencimiento del plan no haya pasado.\n   536→     *\n   537→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   538→     * @return bool\n   539→     * @author Andres Gonzalez\n   540→     */\n   541→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   542→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n   543→            return true;\n   544→        }\n   545→\n   546→        return false;\n   547→    }\n   548→\n   549→    /**\n   550→     * Verificar que el plan tenga vacantes disponibles.\n   551→     *\n   552→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   553→     * @return bool\n   554→     * @author Andres Gonzalez\n   555→     */\n   556→    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n   557→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n   558→    }\n   559→\n   560→    /**\n   561→     * Obtener creditos disponibles para un plan de empresa.\n   562→     *\n   563→     * @param int $empresa_plan_id ID del plan de empresa.\n   564→     * @return int\n   565→     * @author Sergio Vargas\n   566→     * @author Daniel Beltrán\n   567→     */\n   568→    public function creditosDisponibles(int $empresa_plan_id): int {\n   569→        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n   570→        return $empresa_plan?->creditos_restantes ?? 0;\n   571→    }\n   572→\n   573→    /**\n   574→     * Obtener creditos disponibles y plan asignado de una empresa.\n   575→     *\n   576→     * @param int $empresa_id ID de la empresa.\n   577→     * @param Request $request Contenido de la peticion.\n   578→     * @return array|null\n   579→     * @author Sergio Vargas\n   580→     */\n   581→    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n   582→        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n   583→            ? (int) $request->tipo_prueba_id\n   584→            : TipoPrueba::SELECCION_ID;\n   585→\n   586→        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   587→\n   588→        if (!$empresa_plan) {\n   589→            return null;\n   590→        }\n   591→\n   592→        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n   593→\n   594→        return [\n   595→            'empresa_id'           => $empresa_id,\n   596→            'empresa_plan_id'      => $empresa_plan->id,\n   597→            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n   598→            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n   599→            'plan_credito'         => $empresa_plan->planCredito ? [\n   600→                'id'       => $empresa_plan->planCredito->id,\n   601→                'nombre'   => $empresa_plan->planCredito->nombre,\n   602→                'creditos' => $empresa_plan->planCredito->creditos,\n   603→                'precio'   => $empresa_plan->planCredito->precio\n   604→            ] : null\n   605→        ];\n   606→    }\n   607→\n   608→    /**\n   609→     * Validar si hay creditos suficientes.\n   610→     *\n   611→     * @param int $empresa_plan_id ID del plan de empresa.\n   612→     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n   613→     * @return bool\n   614→     * @author Sergio Vargas\n   615→     * @author Daniel Beltrán\n   616→     */\n   617→    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n   618→        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n   619→    }\n   620→}\n   621→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6965e968-63c7-4639-92b9-0d71743f1b79","timestamp":"2026-01-21T15:05:39.694Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos      = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $plan                  = $this->plan_repositorio->getUno($request->plan_id);\n        $plan_activo           = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n        $vigencia              = $plan->vigencia;\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        } elseif (!$request->filled('plan_credito_id')) {\n            $request->merge([\n                'plan_credito_id' => null,\n                'creditos'        => null\n            ]);\n        }\n\n        if ($request->filled('vigencia')) {\n            $vigencia = $request->vigencia;\n        }\n\n        if (!is_null($plan_activo)) {\n            if ($request->filled('id')) {\n                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                if ($request->id === $plan_activo->id) {\n                    goto omitir_calcular_vigencia;\n                }\n\n                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                if ($vigencia == $request->vigencia) {\n                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                    goto omitir_calcular_vigencia;\n                }\n            }\n\n            // Poner el nuevo plan como próximo\n            $request->merge(['estado_id' => 3]);\n\n            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                // Agregar las nuevas fechas al nuevo plan\n                $hoy          = now();\n                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n            }\n        } else {\n            $request->merge(['estado_id' => 1]);\n\n            // Validar si el plan seleccionado tiene vigencia\n            if (!is_null($plan->vigencia)) {\n                $request->merge($this->calcularFechasVigencia($vigencia));\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$request->filled('unidades')) {\n            $request->merge(['unidades' => $plan->unidades]);\n        } elseif ($request->unidades != $plan->unidades) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_ofertas_laborales')) {\n            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_usuarios')) {\n            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_pruebas')) {\n            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        // Comprobar si se modificaron las funcionalidades respecto al plan original\n        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n\n            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                $request->merge(['plan_original' => false]);\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario      = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     *\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     *\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy          = now();\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses             = $vigencia / 30;\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia          = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio'      => $fecha_inicio->format('Y-m-d'),\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n        $this->generarDirectorios(\"app/{$ruta}\");\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo'    => 'App\\Models\\Empresas\\EmpresaPlan',\n            'modelo_id' => $id,\n            'nombre'    => 'factura',\n            'ruta'      => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n        $request->merge([\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n            $plan->creditos_consumidos = $creditos_consumidos;\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo       = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan               = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     *\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan                = $this->plan_repositorio->getUno($request->plan_id);\n        $empresa             = $this->empresa_repositorio->getUno($request->empresa_id);\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n            'empresa_id'    => $request->empresa_id,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","numLines":621,"startLine":1,"totalLines":621}},"sourceToolAssistantUUID":"dcc59cfe-4cd8-4cf5-bf2f-2435c01a6d51"}
{"parentUuid":"6965e968-63c7-4639-92b9-0d71743f1b79","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RkvafJBVP3BomGF9w64Lz2","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me examine the PlanCredito model and the repository to understand the credit plan structure better."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6549,"cache_creation_input_tokens":10092,"cache_read_input_tokens":17636,"cache_creation":{"ephemeral_5m_input_tokens":10092,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXLjJ7n67zuKxj2m6h1UW","type":"assistant","uuid":"6bd492f5-a276-4a1b-86ed-67b35dec1199","timestamp":"2026-01-21T15:05:43.356Z"}
{"parentUuid":"6bd492f5-a276-4a1b-86ed-67b35dec1199","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RkvafJBVP3BomGF9w64Lz2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FFkcf9J1DKiKW7yDYvedNA","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6549,"cache_creation_input_tokens":10092,"cache_read_input_tokens":17636,"cache_creation":{"ephemeral_5m_input_tokens":10092,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXLjJ7n67zuKxj2m6h1UW","type":"assistant","uuid":"b41cf16f-ceb7-426a-801a-3bba45ff4478","timestamp":"2026-01-21T15:05:44.496Z"}
{"parentUuid":"b41cf16f-ceb7-426a-801a-3bba45ff4478","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RkvafJBVP3BomGF9w64Lz2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UkveLjE3UzQkupdmsseWnT","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6549,"cache_creation_input_tokens":10092,"cache_read_input_tokens":17636,"cache_creation":{"ephemeral_5m_input_tokens":10092,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXLjJ7n67zuKxj2m6h1UW","type":"assistant","uuid":"bc12176b-b857-4378-ae75-8b3fe18fcff3","timestamp":"2026-01-21T15:05:45.057Z"}
{"parentUuid":"bc12176b-b857-4378-ae75-8b3fe18fcff3","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RkvafJBVP3BomGF9w64Lz2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JpPMEeNfDokQN9ZVsrtpaV","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6549,"cache_creation_input_tokens":10092,"cache_read_input_tokens":17636,"cache_creation":{"ephemeral_5m_input_tokens":10092,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXLjJ7n67zuKxj2m6h1UW","type":"assistant","uuid":"a0346c0b-c392-4721-8ba4-9da885abb412","timestamp":"2026-01-21T15:05:45.706Z"}
{"parentUuid":"b41cf16f-ceb7-426a-801a-3bba45ff4478","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FFkcf9J1DKiKW7yDYvedNA","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Planes;\n     4→\n     5→use OwenIt\\Auditing\\Auditable;\n     6→use App\\Models\\Empresas\\EmpresaPlan;\n     7→use Illuminate\\Database\\Eloquent\\Model;\n     8→use Illuminate\\Database\\Eloquent\\Builder;\n     9→use Illuminate\\Database\\Eloquent\\SoftDeletes;\n    10→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n    11→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    12→\n    13→class PlanCredito extends Model implements AuditableContract\n    14→{\n    15→    use Auditable, SoftDeletes;\n    16→\n    17→    protected $table = 'planes_creditos';\n    18→\n    19→    protected $fillable = [\n    20→        'nombre',\n    21→        'descripcion',\n    22→        'creditos',\n    23→        'precio',\n    24→        'porcentaje_descuento',\n    25→        'fecha_inicio_promocion',\n    26→        'fecha_fin_promocion',\n    27→        'activo'\n    28→    ];\n    29→\n    30→    protected $casts = [\n    31→        'creditos'               => 'integer',\n    32→        'precio'                 => 'decimal:2',\n    33→        'porcentaje_descuento'   => 'integer',\n    34→        'fecha_inicio_promocion' => 'date:Y-m-d',\n    35→        'fecha_fin_promocion'    => 'date:Y-m-d',\n    36→        'activo'                 => 'boolean'\n    37→    ];\n    38→\n    39→    protected $appends = [\n    40→        'precio_con_descuento'\n    41→    ];\n    42→\n    43→    /**\n    44→     * Filtrar registros activos.\n    45→     *\n    46→     * @param Builder $consulta Consulta.\n    47→     * @return Builder\n    48→     * @author Sergio Vargas\n    49→     * @author Daniel Beltrán\n    50→     */\n    51→    public function scopeActivos(Builder $consulta): Builder {\n    52→        return $consulta->where('activo', true);\n    53→    }\n    54→\n    55→    /**\n    56→     * Relación de uno a muchos con empresas_planes.\n    57→     *\n    58→     * @return HasMany\n    59→     * @author Sergio Vargas\n    60→     * @author Daniel Beltrán\n    61→     */\n    62→    public function empresasPlanes(): HasMany {\n    63→        return $this->hasMany(EmpresaPlan::class, 'plan_credito_id');\n    64→    }\n    65→\n    66→    /**\n    67→     * Obtener el precio con descuento aplicado.\n    68→     *\n    69→     * @return float\n    70→     * @author Sergio Vargas\n    71→     * @author Daniel Beltrán\n    72→     */\n    73→    public function getPrecioConDescuentoAttribute(): float {\n    74→        if (!$this->estaEnPromocion()) {\n    75→            return (float) $this->precio;\n    76→        }\n    77→\n    78→        $porcentaje = $this->porcentaje_descuento ?? 0;\n    79→        $descuento  = $this->precio * ($porcentaje / 100);\n    80→\n    81→        return (float) max(0, $this->precio - $descuento);\n    82→    }\n    83→\n    84→    /**\n    85→     * Verificar si el plan esta en promoción vigente.\n    86→     *\n    87→     * @return bool\n    88→     * @author Sergio Vargas\n    89→     * @author Daniel Beltrán\n    90→     */\n    91→    public function estaEnPromocion(): bool {\n    92→        if (!$this->porcentaje_descuento) {\n    93→            return false;\n    94→        }\n    95→\n    96→        $hoy = now()->startOfDay();\n    97→\n    98→        if ($this->fecha_inicio_promocion && $hoy->lt($this->fecha_inicio_promocion)) {\n    99→            return false;\n   100→        }\n   101→\n   102→        if ($this->fecha_fin_promocion && $hoy->gt($this->fecha_fin_promocion)) {\n   103→            return false;\n   104→        }\n   105→\n   106→        return true;\n   107→    }\n   108→}\n   109→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fbabe4df-1de5-45dd-9db7-05386630e95f","timestamp":"2026-01-21T15:05:48.660Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php","content":"<?php\n\nnamespace App\\Models\\Planes;\n\nuse OwenIt\\Auditing\\Auditable;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Builder;\nuse Illuminate\\Database\\Eloquent\\SoftDeletes;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\nuse OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n\nclass PlanCredito extends Model implements AuditableContract\n{\n    use Auditable, SoftDeletes;\n\n    protected $table = 'planes_creditos';\n\n    protected $fillable = [\n        'nombre',\n        'descripcion',\n        'creditos',\n        'precio',\n        'porcentaje_descuento',\n        'fecha_inicio_promocion',\n        'fecha_fin_promocion',\n        'activo'\n    ];\n\n    protected $casts = [\n        'creditos'               => 'integer',\n        'precio'                 => 'decimal:2',\n        'porcentaje_descuento'   => 'integer',\n        'fecha_inicio_promocion' => 'date:Y-m-d',\n        'fecha_fin_promocion'    => 'date:Y-m-d',\n        'activo'                 => 'boolean'\n    ];\n\n    protected $appends = [\n        'precio_con_descuento'\n    ];\n\n    /**\n     * Filtrar registros activos.\n     *\n     * @param Builder $consulta Consulta.\n     * @return Builder\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function scopeActivos(Builder $consulta): Builder {\n        return $consulta->where('activo', true);\n    }\n\n    /**\n     * Relación de uno a muchos con empresas_planes.\n     *\n     * @return HasMany\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function empresasPlanes(): HasMany {\n        return $this->hasMany(EmpresaPlan::class, 'plan_credito_id');\n    }\n\n    /**\n     * Obtener el precio con descuento aplicado.\n     *\n     * @return float\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getPrecioConDescuentoAttribute(): float {\n        if (!$this->estaEnPromocion()) {\n            return (float) $this->precio;\n        }\n\n        $porcentaje = $this->porcentaje_descuento ?? 0;\n        $descuento  = $this->precio * ($porcentaje / 100);\n\n        return (float) max(0, $this->precio - $descuento);\n    }\n\n    /**\n     * Verificar si el plan esta en promoción vigente.\n     *\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function estaEnPromocion(): bool {\n        if (!$this->porcentaje_descuento) {\n            return false;\n        }\n\n        $hoy = now()->startOfDay();\n\n        if ($this->fecha_inicio_promocion && $hoy->lt($this->fecha_inicio_promocion)) {\n            return false;\n        }\n\n        if ($this->fecha_fin_promocion && $hoy->gt($this->fecha_fin_promocion)) {\n            return false;\n        }\n\n        return true;\n    }\n}\n","numLines":109,"startLine":1,"totalLines":109}},"sourceToolAssistantUUID":"b41cf16f-ceb7-426a-801a-3bba45ff4478"}
{"parentUuid":"a0346c0b-c392-4721-8ba4-9da885abb412","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JpPMEeNfDokQN9ZVsrtpaV","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Planes;\n     4→\n     5→use OwenIt\\Auditing\\Auditable;\n     6→use App\\Models\\Empresas\\Empresa;\n     7→use App\\Models\\Pruebas\\TipoPrueba;\n     8→use Illuminate\\Database\\Eloquent\\Model;\n     9→use Illuminate\\Database\\Eloquent\\SoftDeletes;\n    10→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    11→use Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\n    12→use Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n    13→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    14→\n    15→class Plan extends Model implements AuditableContract\n    16→{\n    17→    use HasFactory, SoftDeletes, Auditable;\n    18→\n    19→    public const ESTADO_ACTIVO_ID     = 1;\n    20→    public const ESTADO_INACTIVO_ID   = 2;\n    21→    public const ESTADO_PROXIMO_ID    = 3;\n    22→    public const ESTADO_POR_VENCER_ID = 4;\n    23→    public const ESTADO_VENCIDO_ID    = 5;\n    24→\n    25→    protected $table = 'planes';\n    26→\n    27→    protected $fillable = [\n    28→        'tipo_prueba_id',\n    29→        'nombre',\n    30→        'descripcion',\n    31→        'unidades',\n    32→        'cantidad_ofertas_laborales',\n    33→        'vigencia',\n    34→        'cantidad_usuarios',\n    35→        'cantidad_pruebas',\n    36→        'precio',\n    37→        'en_promocion',\n    38→        'porcentaje_descuento',\n    39→        'fecha_inicio_promocion',\n    40→        'fecha_fin_promocion',\n    41→        'comentario',\n    42→        'activo'\n    43→    ];\n    44→\n    45→    protected $casts = [\n    46→        'created_at' => 'datetime:d/m/Y',\n    47→        'updated_at' => 'datetime:d/m/Y'\n    48→    ];\n    49→\n    50→    /**\n    51→     * Relación de muchos a uno con tipos_pruebas.\n    52→     *\n    53→     * @return BelongsTo\n    54→     * @author Daniel Beltrán\n    55→     */\n    56→    public function tipoPrueba(): BelongsTo {\n    57→        return $this->belongsTo(TipoPrueba::class);\n    58→    }\n    59→\n    60→    /**\n    61→     * Relación de muchos a muchos con funcionalidades.\n    62→     *\n    63→     * @return BelongsToMany\n    64→     * @author Daniel Beltrán\n    65→     */\n    66→    public function funcionalidades(): BelongsToMany {\n    67→        return $this->belongsToMany(Funcionalidad::class, 'funcionalidades_planes', 'plan_id', 'funcionalidad_id')->withTimestamps();\n    68→    }\n    69→\n    70→    /**\n    71→     * Relación de muchos a muchos con modulos.\n    72→     *\n    73→     * @return BelongsToMany\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function modulos(): BelongsToMany {\n    77→        return $this->belongsToMany(Modulo::class, 'modulos_planes', 'plan_id', 'modulo_id')->withTimestamps();\n    78→    }\n    79→\n    80→    /**\n    81→     * Relación de muchos a muchos con empresas.\n    82→     *\n    83→     * @return BelongsToMany\n    84→     * @author Daniel Beltrán\n    85→     */\n    86→    public function empresas(): BelongsToMany {\n    87→        return $this->belongsToMany(Empresa::class, 'empresas_planes', 'plan_id', 'empresa_id')\n    88→        ->withPivot(['unidades', 'fecha_vencimiento', 'precio'])\n    89→        ->withTimestamps();\n    90→    }\n    91→}\n    92→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3eadd041-732e-4975-9317-cea83015829f","timestamp":"2026-01-21T15:05:48.661Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php","content":"<?php\n\nnamespace App\\Models\\Planes;\n\nuse OwenIt\\Auditing\\Auditable;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\SoftDeletes;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\nuse OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n\nclass Plan extends Model implements AuditableContract\n{\n    use HasFactory, SoftDeletes, Auditable;\n\n    public const ESTADO_ACTIVO_ID     = 1;\n    public const ESTADO_INACTIVO_ID   = 2;\n    public const ESTADO_PROXIMO_ID    = 3;\n    public const ESTADO_POR_VENCER_ID = 4;\n    public const ESTADO_VENCIDO_ID    = 5;\n\n    protected $table = 'planes';\n\n    protected $fillable = [\n        'tipo_prueba_id',\n        'nombre',\n        'descripcion',\n        'unidades',\n        'cantidad_ofertas_laborales',\n        'vigencia',\n        'cantidad_usuarios',\n        'cantidad_pruebas',\n        'precio',\n        'en_promocion',\n        'porcentaje_descuento',\n        'fecha_inicio_promocion',\n        'fecha_fin_promocion',\n        'comentario',\n        'activo'\n    ];\n\n    protected $casts = [\n        'created_at' => 'datetime:d/m/Y',\n        'updated_at' => 'datetime:d/m/Y'\n    ];\n\n    /**\n     * Relación de muchos a uno con tipos_pruebas.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function tipoPrueba(): BelongsTo {\n        return $this->belongsTo(TipoPrueba::class);\n    }\n\n    /**\n     * Relación de muchos a muchos con funcionalidades.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function funcionalidades(): BelongsToMany {\n        return $this->belongsToMany(Funcionalidad::class, 'funcionalidades_planes', 'plan_id', 'funcionalidad_id')->withTimestamps();\n    }\n\n    /**\n     * Relación de muchos a muchos con modulos.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function modulos(): BelongsToMany {\n        return $this->belongsToMany(Modulo::class, 'modulos_planes', 'plan_id', 'modulo_id')->withTimestamps();\n    }\n\n    /**\n     * Relación de muchos a muchos con empresas.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function empresas(): BelongsToMany {\n        return $this->belongsToMany(Empresa::class, 'empresas_planes', 'plan_id', 'empresa_id')\n        ->withPivot(['unidades', 'fecha_vencimiento', 'precio'])\n        ->withTimestamps();\n    }\n}\n","numLines":92,"startLine":1,"totalLines":92}},"sourceToolAssistantUUID":"a0346c0b-c392-4721-8ba4-9da885abb412"}
{"parentUuid":"bc12176b-b857-4378-ae75-8b3fe18fcff3","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UkveLjE3UzQkupdmsseWnT","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\Empresas;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\Pruebas\\TipoPrueba;\n     7→use Illuminate\\Support\\Collection;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use App\\Http\\Repositories\\BaseRepository;\n    11→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    12→use App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n    13→\n    14→class EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n    15→{\n    16→    /**\n    17→     * Ids de los roles de tipo empresa.\n    18→     *\n    19→     * @var array\n    20→     * @author Fahibram Cárcamo\n    21→     */\n    22→    private const IDS_ROLES_TIPO_EMPRESA = [\n    23→        RolRepository::ROL_PROPIETARIO_ID,\n    24→        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n    25→        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n    26→        RolRepository::ROL_EVALUADOR_ID\n    27→    ];\n    28→\n    29→    private $consulta_conteo_total_usuarios_empresa_sucursales;\n    30→\n    31→    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n    32→\n    33→    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n    39→     * @return void\n    40→     * @author Daniel Beltrán\n    41→     * @author Fahibram Cárcamo\n    42→     */\n    43→    public function __construct(EmpresaPlan $modelo) {\n    44→        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n    45→            (\n    46→                SELECT COUNT(DISTINCT eu.usuario_id)\n    47→                FROM empresas_usuarios AS eu\n    48→                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n    49→                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n    50→                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n    51→            ) AS conteo_total_usuarios_empresa_sucursales\n    52→        ';\n    53→\n    54→        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n    55→            (\n    56→                SELECT COUNT(*)\n    57→                FROM consumos\n    58→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    59→                WHERE (\n    60→                    consumos.empresa_id = empresas_planes.empresa_id\n    61→                    OR suc.empresa_id = empresas_planes.empresa_id\n    62→                )\n    63→                AND consumos.agenda_id IS NOT NULL\n    64→            ) AS conteo_total_consumos_agendas_empresa_sucursales\n    65→        ';\n    66→\n    67→        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n    68→            (\n    69→                SELECT COUNT(*)\n    70→                FROM consumos\n    71→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    72→                WHERE (\n    73→                    consumos.empresa_id = empresas_planes.empresa_id\n    74→                    OR suc.empresa_id = empresas_planes.empresa_id\n    75→                )\n    76→                AND consumos.oferta_laboral_id IS NOT NULL\n    77→            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n    78→        ';\n    79→\n    80→        parent::__construct($modelo);\n    81→    }\n    82→\n    83→    /**\n    84→     * Obtener todos los planes de empresas.\n    85→     *\n    86→     * @param Request $request Contenido de la petición.\n    87→     * @return Collection\n    88→     * @author Daniel Beltrán\n    89→     * @author Fahibram Cárcamo\n    90→     * @author Jair Carvajal\n    91→     */\n    92→    public function getTodo(Request $request): Collection {\n    93→        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n    94→            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    95→        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n    96→            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n    97→        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n    98→            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    99→        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n   100→            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n   101→\n   102→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   103→        ->with([\n   104→            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n   105→            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   106→            'plan.tipoPrueba:id,nombre',\n   107→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   108→            'estado:id,nombre',\n   109→            'pruebas:id,nombre',\n   110→            'funcionalidades:id,nombre,predeterminado',\n   111→            'archivos' => function ($archivos) {\n   112→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   113→            }\n   114→        ])\n   115→        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   116→            $query->with([\n   117→                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   118→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   119→                        ->with(['empresa' => function ($empresa) {\n   120→                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n   121→                        }])\n   122→                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n   123→                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n   124→                },\n   125→                'consumos.agenda:id,prueba_id',\n   126→                'consumos.agenda.prueba:id,nombre,slug'\n   127→            ]);\n   128→        })\n   129→        ->when($con_conteo_consumos_agendas, function ($consulta) {\n   130→            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   131→        })\n   132→        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n   133→            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   134→        })\n   135→        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n   136→            $query->where('empresa_id', $request->empresa_id);\n   137→        })\n   138→        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n   139→            $query->whereHas('plan', function ($plan) use ($request) {\n   140→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   141→            });\n   142→        })\n   143→        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n   144→            $query->whereHas('plan', function ($plan) use ($request) {\n   145→                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n   146→            });\n   147→        })\n   148→        ->when($request->filled('plan_id'), function ($query) use ($request) {\n   149→            $query->where('plan_id', $request->plan_id);\n   150→        })\n   151→        ->when(\n   152→            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n   153→            function ($query) use ($request) {\n   154→                $query->whereIn($request->campo, $request->valores);\n   155→            }\n   156→        )\n   157→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   158→            $consulta->whereIn('estado_id', $request->estado_id);\n   159→        })\n   160→        ->when(\n   161→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   162→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   163→        )\n   164→        ->when(\n   165→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   166→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   167→        )\n   168→        ->when(\n   169→            $request->filled('fecha_vencimiento_desde'),\n   170→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   171→        )\n   172→        ->when(\n   173→            $request->filled('fecha_vencimiento_hasta'),\n   174→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   175→        )\n   176→        ->when(\n   177→            $request->filled('fecha_inicio_desde'),\n   178→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   179→        )\n   180→        ->when(\n   181→            $request->filled('fecha_inicio_hasta'),\n   182→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   183→        )\n   184→        ->orderBy('created_at', 'DESC')\n   185→        ->get();\n   186→    }\n   187→\n   188→    /**\n   189→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n   190→     *\n   191→     * @param Request $request Contenido de la petición HTTP entrante.\n   192→     * @return Collection\n   193→     * @author Fahibram Cárcamo\n   194→     * @author Jair Carvajal\n   195→     */\n   196→    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n   197→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   198→            ->addSelect([\n   199→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   200→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   201→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   202→            ])\n   203→            ->whereExists(function ($subconsulta) {\n   204→                $subconsulta->select(DB::raw(1))\n   205→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   206→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   207→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   208→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   209→            })\n   210→            ->with([\n   211→                'estado:id,nombre',\n   212→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   213→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n   214→            ])\n   215→            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n   216→            ->when(\n   217→                $request->filled('tipo_prueba_id'),\n   218→                function ($consulta) use ($request) {\n   219→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   220→                },\n   221→                function ($consulta) {\n   222→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   223→                        TipoPrueba::SELECCION_ID,\n   224→                        TipoPrueba::ORGANIZACIONAL_ID,\n   225→                        TipoPrueba::VOCACIONAL_ID\n   226→                    ]));\n   227→                }\n   228→            )\n   229→            ->get();\n   230→    }\n   231→\n   232→    /**\n   233→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n   234→     *\n   235→     * @param Request $request Contenido de la petición HTTP entrante.\n   236→     * @return Collection\n   237→     * @author Fahibram Cárcamo\n   238→     * @author Andres Gonzalez\n   239→     * @author Jair Carvajal\n   240→     */\n   241→    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n   242→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   243→            ->addSelect([\n   244→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   245→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   246→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   247→            ])\n   248→            ->whereExists(function ($sub_consulta) {\n   249→                $sub_consulta->select(DB::raw(1))\n   250→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   251→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   252→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   253→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   254→            })\n   255→            ->with([\n   256→                'estado:id,nombre',\n   257→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   258→                'plan.tipoPrueba:id,nombre',\n   259→                'pruebas:id,nombre,slug',\n   260→                'funcionalidades:id,nombre,predeterminado',\n   261→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n   262→                'consumos' => function ($consumos) {\n   263→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   264→                        ->with([\n   265→                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   266→                            'agenda:id,prueba_id',\n   267→                            'agenda.prueba:id,nombre,slug'\n   268→                        ]);\n   269→                }\n   270→            ])\n   271→            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   272→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   273→            })\n   274→            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   275→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n   276→            })\n   277→            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n   278→                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n   279→                    $sub_consulta->where('empresa_id', $request->empresa_id)\n   280→                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n   281→                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n   282→                        });\n   283→                });\n   284→            })\n   285→            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   286→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   287→            }, function ($consulta) {\n   288→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   289→                    TipoPrueba::SELECCION_ID,\n   290→                    TipoPrueba::ORGANIZACIONAL_ID,\n   291→                    TipoPrueba::VOCACIONAL_ID\n   292→                ]));\n   293→            })\n   294→            ->orderBy('created_at', 'DESC')\n   295→            ->get();\n   296→    }\n   297→\n   298→    /**\n   299→     * Obtener datos básicos de los planes de empresas.\n   300→     *\n   301→     * @param Request $request Contenido de la petición.\n   302→     * @return Collection\n   303→     * @author Daniel Beltrán\n   304→     * @author Fahibram Cárcamo\n   305→     * @author Jair Carvajal\n   306→     */\n   307→    public function getDatosBasicos(Request $request): Collection {\n   308→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   309→        ->with([\n   310→            'plan:id,tipo_prueba_id,nombre'\n   311→        ])\n   312→        ->withCount([\n   313→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   314→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n   315→        ])\n   316→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   317→            $consulta->where('empresa_id', $request->empresa_id);\n   318→        })\n   319→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   320→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   321→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   322→            });\n   323→        })\n   324→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   325→            $consulta->whereIn('estado_id', $request->estados_ids);\n   326→        })\n   327→        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n   328→            $sentido = $request->ordenar_sentido ?? 'ASC';\n   329→            $consulta->orderBy($request->ordenar_por, $sentido);\n   330→        })\n   331→        ->get();\n   332→    }\n   333→\n   334→    /**\n   335→     * Obtener un plan de empresa.\n   336→     *\n   337→     * @param int $id ID del plan de empresa.\n   338→     * @return EmpresaPlan|null\n   339→     * @author Daniel Beltrán\n   340→     * @author Jair Carvajal\n   341→     */\n   342→    public function getUno(int $id): ?EmpresaPlan {\n   343→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   344→        ->with([\n   345→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n   346→            'plan.tipoPrueba:id,nombre',\n   347→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   348→            'estado:id,nombre',\n   349→            'pruebas:id,nombre,slug',\n   350→            'funcionalidades:id,nombre,llave,valor',\n   351→            'archivos' => function ($archivos) {\n   352→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   353→            }\n   354→        ])\n   355→        ->find($id);\n   356→    }\n   357→\n   358→    /**\n   359→     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n   360→     *\n   361→     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n   362→     *\n   363→     * @param int $empresa_id ID de la empresa.\n   364→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   365→     * @return EmpresaPlan|null\n   366→     * @author Daniel Beltrán\n   367→     * @author Fahibram Cárcamo\n   368→     * @author José Manuel Jiménez\n   369→     * @author Andres Gonzalez\n   370→     * @author Sergio Vargas\n   371→     * @author Jair Carvajal\n   372→     */\n   373→    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   374→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   375→        ->with([\n   376→            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n   377→            'plan.tipoPrueba:id,nombre',\n   378→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   379→            'estado:id,nombre',\n   380→            'pruebas:id,nombre,slug',\n   381→            'usuario:id,nombres,apellidos',\n   382→            'archivos' => function ($archivos) {\n   383→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   384→                ->orderBy('created_at', 'DESC');\n   385→            }\n   386→        ])\n   387→        ->withCount([\n   388→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   389→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n   390→            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n   391→        ])\n   392→        ->where('empresa_id', $empresa_id)\n   393→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   394→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   395→        })\n   396→        ->whereIn('estado_id', [1, 4])\n   397→        ->first();\n   398→    }\n   399→\n   400→    /**\n   401→     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n   402→     *\n   403→     * @param int $empresa_id ID de la empresa.\n   404→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   405→     * @return EmpresaPlan|null\n   406→     * @author Daniel Beltrán\n   407→     * @author Jair Carvajal\n   408→     */\n   409→    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   410→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   411→        ->with([\n   412→            'plan:id,tipo_prueba_id,nombre',\n   413→            'plan.tipoPrueba:id,nombre',\n   414→            'estado:id,nombre',\n   415→            'pruebas:id,nombre',\n   416→            'archivos' => function ($archivos) {\n   417→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   418→                ->orderBy('created_at', 'DESC');\n   419→            }\n   420→        ])\n   421→        ->where([\n   422→            'empresa_id' => $empresa_id,\n   423→            'estado_id'  => 3\n   424→        ])\n   425→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   426→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   427→        })\n   428→        ->first();\n   429→    }\n   430→\n   431→    /**\n   432→     * Obtener el último plan asignado.\n   433→     *\n   434→     * @param Request $request Contenido de la petición.\n   435→     * @return EmpresaPlan|null\n   436→     * @author Daniel Beltrán\n   437→     * @author Jair Carvajal\n   438→     */\n   439→    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n   440→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   441→        ->with([\n   442→            'plan:id,tipo_prueba_id,nombre',\n   443→            'plan.tipoPrueba:id,nombre',\n   444→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   445→            'estado:id,nombre',\n   446→            'pruebas:id,nombre',\n   447→            'archivos' => function ($archivos) {\n   448→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   449→                ->orderBy('created_at', 'DESC');\n   450→            }\n   451→        ])\n   452→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   453→            $consulta->where('empresa_id', $request->empresa_id);\n   454→        })\n   455→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   456→            $consulta->where('estado_id', $request->estado_id);\n   457→        })\n   458→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   459→            $consulta->whereIn('estado_id', $request->estados_ids);\n   460→        })\n   461→        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   462→            $consulta->where('estado_id', '!=', 3);\n   463→        })\n   464→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   465→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   466→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   467→            });\n   468→        })\n   469→        ->orderBy('created_at', 'DESC')\n   470→        ->first();\n   471→    }\n   472→\n   473→    /**\n   474→     * Sincronizar pruebas.\n   475→     *\n   476→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   477→     * @param array $pruebas ID's de las pruebas.\n   478→     * @return void\n   479→     * @author Daniel Beltrán\n   480→     */\n   481→    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n   482→        $empresa_plan->pruebas()->sync($pruebas);\n   483→    }\n   484→\n   485→    /**\n   486→     * Sincronizar funcionalidades.\n   487→     *\n   488→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   489→     * @param array $funcionalidades ID's de las funcionalidades.\n   490→     * @return void\n   491→     * @author Daniel Beltrán\n   492→     */\n   493→    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n   494→        $empresa_plan->funcionalidades()->sync($funcionalidades);\n   495→    }\n   496→\n   497→    /**\n   498→     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n   499→     *\n   500→     * @param Request $request Contenido de la petición.\n   501→     * @return ?EmpresaPlan\n   502→     * @author Fahibram Cárcamo\n   503→     * @author Jair Carvajal\n   504→     */\n   505→    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n   506→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   507→        ->with([\n   508→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n   509→            'plan.tipoPrueba:id,nombre',\n   510→            'estado:id,nombre',\n   511→            'pruebas:id,nombre',\n   512→            'funcionalidades:id,nombre,llave,valor'\n   513→        ])\n   514→        ->when(\n   515→            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n   516→            function ($consulta) {\n   517→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   518→            }\n   519→        )\n   520→        ->when(\n   521→            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n   522→            function ($consulta) {\n   523→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   524→            }\n   525→        )\n   526→        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n   527→        ->first();\n   528→    }\n   529→\n   530→    /**\n   531→     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n   532→     *\n   533→     * @return Collection\n   534→     * @author Fahibram Cárcamo\n   535→     * @author Andres Gonzalez\n   536→     * @author José Manuel Jiménez\n   537→     * @author Jair Carvajal\n   538→     * @author Daniel Beltrán\n   539→     */\n   540→    public function datosConsumosEmpresas(Request $request): Collection {\n   541→        $roles_tipo_empresa_ids = [\n   542→            RolRepository::ROL_PROPIETARIO_ID,\n   543→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   544→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   545→            RolRepository::ROL_EVALUADOR_ID\n   546→        ];\n   547→\n   548→        $matriz_conteos = [\n   549→            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n   550→            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n   551→            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n   552→                'empresasUsuarios',\n   553→                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n   554→            )\n   555→        ];\n   556→\n   557→        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n   558→\n   559→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   560→            ->addSelect([\n   561→                DB::raw('\n   562→                    (\n   563→                        SELECT COUNT(DISTINCT eu.usuario_id)\n   564→                        FROM empresas_usuarios AS eu\n   565→                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n   566→                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n   567→                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n   568→                    ) AS conteo_total_usuarios_empresa_sucursales\n   569→                '),\n   570→                DB::raw('\n   571→                    (\n   572→                        SELECT COUNT(*)\n   573→                        FROM consumos\n   574→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   575→                        WHERE (\n   576→                            consumos.empresa_id = empresas_planes.empresa_id\n   577→                            OR suc.empresa_id = empresas_planes.empresa_id\n   578→                        )\n   579→                        AND consumos.agenda_id IS NOT NULL\n   580→                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n   581→                '),\n   582→                DB::raw('\n   583→                    (\n   584→                        SELECT COUNT(*)\n   585→                        FROM consumos\n   586→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   587→                        WHERE (\n   588→                            consumos.empresa_id = empresas_planes.empresa_id\n   589→                            OR suc.empresa_id = empresas_planes.empresa_id\n   590→                        )\n   591→                        AND consumos.oferta_laboral_id IS NOT NULL\n   592→                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n   593→                '),\n   594→            ])\n   595→            ->with([\n   596→                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n   597→                'plan.tipoPrueba:id,nombre',\n   598→                'pruebas:id,nombre,slug',\n   599→                'estado:id,nombre',\n   600→                'usuario:id,nombres,apellidos',\n   601→                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n   602→                    $consulta_empresa->select($campos_empresas)\n   603→                        ->whereNull('empresa_id')\n   604→                        ->withCount([\n   605→                            ...$matriz_conteos,\n   606→                            'sucursales as conteo_sucursales'\n   607→                        ])\n   608→                        ->with([\n   609→                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n   610→                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n   611→                            }\n   612→                        ]);\n   613→                }\n   614→            ])\n   615→            ->when(\n   616→                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n   617→                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n   618→            )\n   619→            ->whereNotIn('estado_id', [3, 8])\n   620→            ->when(\n   621→                $request->filled('prueba_id'),\n   622→                fn($consulta) => $consulta->whereHas(\n   623→                    'pruebas',\n   624→                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n   625→                )\n   626→            )\n   627→            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n   628→                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n   629→            })\n   630→            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n   631→                switch ($request->plan_por) {\n   632→                    case 'por unidades':\n   633→                        $consulta_plan_por->whereNotNull('unidades');\n   634→                        break;\n   635→\n   636→                    case 'por ofertas laborales':\n   637→                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n   638→                        break;\n   639→\n   640→                    case 'por tiempo':\n   641→                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n   642→                        break;\n   643→                }\n   644→            })\n   645→            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n   646→                $fecha_inicio = $request->fecha_vencimiento;\n   647→                $fecha_fin    = $request->fecha_vencimiento;\n   648→\n   649→                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n   650→                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n   651→                    $fecha_inicio = $fechas[0];\n   652→                    $fecha_fin    = $fechas[1];\n   653→                }\n   654→\n   655→                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n   656→            })\n   657→            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n   658→                $fecha_inicio = $request->fecha_inicio;\n   659→                $fecha_fin    = $request->fecha_inicio;\n   660→\n   661→                if (strpos($request->fecha_inicio, ' a ') !== false) {\n   662→                    $fechas       = explode(' a ', $request->fecha_inicio);\n   663→                    $fecha_inicio = $fechas[0];\n   664→                    $fecha_fin    = $fechas[1];\n   665→                }\n   666→\n   667→                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n   668→            })\n   669→            ->when(\n   670→                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   671→                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n   672→            )\n   673→            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n   674→                if ($request->tipo_activacion === 'compra') {\n   675→                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n   676→                        $subconsulta->select(DB::raw(1))\n   677→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   678→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   679→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   680→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   681→                    });\n   682→                } elseif ($request->tipo_activacion === 'recompra') {\n   683→                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n   684→                        $subconsulta->select(DB::raw(1))\n   685→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   686→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   687→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   688→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   689→                    });\n   690→                }\n   691→            })\n   692→            ->get();\n   693→    }\n   694→\n   695→    /**\n   696→     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n   697→     *\n   698→     * @param Request $request Contenido de la petición HTTP entrante.\n   699→     * @return Collection\n   700→     * @author Fahibram Cárcamo\n   701→     */\n   702→    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n   703→        return $this->modelo::select(\n   704→            'empresas_planes.id',\n   705→            'empresas_planes.empresa_id',\n   706→            'empresas_planes.plan_id',\n   707→            'empresas_planes.plan_credito_id',\n   708→            'empresas_planes.usuario_id',\n   709→            'empresas_planes.estado_id',\n   710→            'empresas_planes.unidades',\n   711→            'empresas_planes.cantidad_ofertas_laborales',\n   712→            'empresas_planes.cantidad_usuarios',\n   713→            'empresas_planes.cantidad_pruebas',\n   714→            'empresas_planes.creditos',\n   715→            'empresas_planes.fecha_inicio',\n   716→            'empresas_planes.fecha_vencimiento',\n   717→            'empresas_planes.precio',\n   718→            'empresas_planes.porcentaje_descuento',\n   719→            'empresas_planes.numero_factura',\n   720→            'empresas_planes.comentario',\n   721→            'empresas_planes.plan_original',\n   722→            'empresas_planes.renovando',\n   723→            'empresas_planes.por_facturar',\n   724→            'empresas_planes.created_at',\n   725→            'planes.id',\n   726→            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n   727→            'planes.nombre AS plan_nombre',\n   728→            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n   729→            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n   730→            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n   731→            'planes.unidades AS plan_unidades',\n   732→            'planes.vigencia AS plan_vigencia',\n   733→            'planes.precio AS plan_precio',\n   734→            'tipos_pruebas.id AS tipo_prueba_id',\n   735→            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n   736→            'estados_planes.id AS estado_plan_id',\n   737→            'estados_planes.nombre AS estado_plan_nombre',\n   738→            'users.id AS usuario_usuario_id',\n   739→            'users.nombres AS usuario_nombres',\n   740→            'users.apellidos AS usuario_apellidos',\n   741→            'empresas.id AS empresa_empresa_id',\n   742→            'empresas.empresa_id',\n   743→            'empresas.nombre_comercial AS empresa_nombre_comercial',\n   744→            'empresas.razon_social AS empresa_razon_social',\n   745→            'empresas.nombre_contacto',\n   746→            'empresas.celular_contacto',\n   747→            'empresas.email_contacto',\n   748→            'empresas.telefono_contacto',\n   749→            'empresas.extension_contacto',\n   750→            'empresas.nombre_tesorero',\n   751→            'empresas.celular_tesorero',\n   752→            'empresas.telefono_tesorero',\n   753→            'empresas.email_tesorero',\n   754→            DB::raw('\n   755→                (\n   756→                    SELECT COUNT(*)\n   757→                    FROM consumos\n   758→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n   759→                )\n   760→                AS conteo_consumos_agendas\n   761→            '),\n   762→            DB::raw('\n   763→                (\n   764→                    SELECT COUNT(*)\n   765→                    FROM consumos\n   766→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n   767→                )\n   768→                AS conteo_consumos_ofertas_laborales\n   769→            '),\n   770→            DB::raw('\n   771→                (\n   772→                    SELECT COUNT(*)\n   773→                    FROM empresas\n   774→                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n   775→                )\n   776→                AS conteo_sucursales\n   777→            '),\n   778→            DB::raw('\n   779→                (\n   780→                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n   781→                    FROM empresas AS sucursales\n   782→                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n   783→                )\n   784→                AS nombres_comerciales_sucursales\n   785→            ')\n   786→        )\n   787→        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n   788→        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n   789→        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n   790→        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n   791→        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n   792→        ->whereNull('empresas.empresa_id')\n   793→        ->when(\n   794→            $request->filled('plan_por'),\n   795→            function ($consulta) use ($request) {\n   796→                switch ($request->plan_por) {\n   797→                    case 'por unidades':\n   798→                        $consulta->whereNotNull('empresas_planes.unidades');\n   799→                        break;\n   800→\n   801→                    case 'por ofertas laborales':\n   802→                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n   803→                        break;\n   804→\n   805→                    case 'por tiempo':\n   806→                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n   807→                        break;\n   808→                }\n   809→            }\n   810→        )\n   811→        ->when(\n   812→            $request->filled('tipo_prueba_id'),\n   813→            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n   814→            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n   815→                TipoPrueba::SELECCION_ID,\n   816→                TipoPrueba::ORGANIZACIONAL_ID,\n   817→                TipoPrueba::VOCACIONAL_ID\n   818→            ])\n   819→        )\n   820→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n   821→        ->when(\n   822→            $request->filled('ejecutivo_id'),\n   823→            function ($consulta) use ($request) {\n   824→                $consulta->whereExists(function ($subconsulta) use ($request) {\n   825→                    $subconsulta->select(DB::raw(1))\n   826→                        ->from('empresas_usuarios')\n   827→                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n   828→                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n   829→                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n   830→                });\n   831→            }\n   832→        )\n   833→        ->when(\n   834→            $request->filled('fecha_vencimiento'),\n   835→            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n   836→        )\n   837→        ->when(\n   838→            $request->filled('fecha_inicio'),\n   839→            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n   840→        )\n   841→        ->when(\n   842→            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   843→            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n   844→        )\n   845→        ->get();\n   846→    }\n   847→\n   848→    /**\n   849→     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n   850→     *\n   851→     * @param int $empresa_id ID de la empresa.\n   852→     * @param Request $request Contenido de la peticion.\n   853→     * @return Collection\n   854→     * @author Sergio Vargas\n   855→     */\n   856→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   857→        return $this->modelo::select(\n   858→            'id',\n   859→            'empresa_id',\n   860→            'plan_credito_id',\n   861→            'estado_id',\n   862→            'creditos',\n   863→            'fecha_inicio',\n   864→            'fecha_vencimiento',\n   865→            'precio',\n   866→            'porcentaje_descuento',\n   867→            'numero_factura',\n   868→            'comentario',\n   869→            'created_at'\n   870→        )\n   871→        ->with([\n   872→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   873→            'estado:id,nombre',\n   874→            'archivos' => function ($archivos) {\n   875→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   876→                    ->orderBy('created_at', 'DESC');\n   877→            }\n   878→        ])\n   879→        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n   880→        ->where('empresa_id', $empresa_id)\n   881→        ->whereNotNull('plan_credito_id')\n   882→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n   883→        ->when(\n   884→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   885→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   886→        )\n   887→        ->when(\n   888→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   889→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   890→        )\n   891→        ->when(\n   892→            $request->filled('fecha_vencimiento_desde'),\n   893→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   894→        )\n   895→        ->when(\n   896→            $request->filled('fecha_vencimiento_hasta'),\n   897→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   898→        )\n   899→        ->when(\n   900→            $request->filled('fecha_inicio_desde'),\n   901→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   902→        )\n   903→        ->when(\n   904→            $request->filled('fecha_inicio_hasta'),\n   905→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   906→        )\n   907→        ->orderBy('created_at', 'DESC')\n   908→        ->get();\n   909→    }\n   910→}\n   911→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a37dc83b-fe81-4854-a74a-cd27a1774b36","timestamp":"2026-01-21T15:05:48.883Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","content":"<?php\n\nnamespace App\\Http\\Repositories\\Empresas;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Repositories\\BaseRepository;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n\nclass EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n{\n    /**\n     * Ids de los roles de tipo empresa.\n     *\n     * @var array\n     * @author Fahibram Cárcamo\n     */\n    private const IDS_ROLES_TIPO_EMPRESA = [\n        RolRepository::ROL_PROPIETARIO_ID,\n        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n        RolRepository::ROL_EVALUADOR_ID\n    ];\n\n    private $consulta_conteo_total_usuarios_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(EmpresaPlan $modelo) {\n        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n            (\n                SELECT COUNT(DISTINCT eu.usuario_id)\n                FROM empresas_usuarios AS eu\n                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n            ) AS conteo_total_usuarios_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.agenda_id IS NOT NULL\n            ) AS conteo_total_consumos_agendas_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.oferta_laboral_id IS NOT NULL\n            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n        ';\n\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener todos los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getTodo(Request $request): Collection {\n        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n            'empresa:id,empresa_id,nombre_comercial,razon_social',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,predeterminado',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n            $query->with([\n                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with(['empresa' => function ($empresa) {\n                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n                        }])\n                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n                },\n                'consumos.agenda:id,prueba_id',\n                'consumos.agenda.prueba:id,nombre,slug'\n            ]);\n        })\n        ->when($con_conteo_consumos_agendas, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n        })\n        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n            $query->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n            });\n        })\n        ->when($request->filled('plan_id'), function ($query) use ($request) {\n            $query->where('plan_id', $request->plan_id);\n        })\n        ->when(\n            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n            function ($query) use ($request) {\n                $query->whereIn($request->campo, $request->valores);\n            }\n        )\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estado_id);\n        })\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($subconsulta) {\n                $subconsulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n            ])\n            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n            ->when(\n                $request->filled('tipo_prueba_id'),\n                function ($consulta) use ($request) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n                },\n                function ($consulta) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                        TipoPrueba::SELECCION_ID,\n                        TipoPrueba::ORGANIZACIONAL_ID,\n                        TipoPrueba::VOCACIONAL_ID\n                    ]));\n                }\n            )\n            ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($sub_consulta) {\n                $sub_consulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'funcionalidades:id,nombre,predeterminado',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n                'consumos' => function ($consumos) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with([\n                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n                            'agenda:id,prueba_id',\n                            'agenda.prueba:id,nombre,slug'\n                        ]);\n                }\n            ])\n            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            })\n            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n            })\n            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n                    $sub_consulta->where('empresa_id', $request->empresa_id)\n                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n                        });\n                });\n            })\n            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n            }, function ($consulta) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                    TipoPrueba::SELECCION_ID,\n                    TipoPrueba::ORGANIZACIONAL_ID,\n                    TipoPrueba::VOCACIONAL_ID\n                ]));\n            })\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener datos básicos de los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getDatosBasicos(Request $request): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre'\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n            $sentido = $request->ordenar_sentido ?? 'ASC';\n            $consulta->orderBy($request->ordenar_por, $sentido);\n        })\n        ->get();\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'funcionalidades:id,nombre,llave,valor',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->find($id);\n    }\n\n    /**\n     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n     *\n     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author José Manuel Jiménez\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])\n        ->first();\n    }\n\n    /**\n     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener el último plan asignado.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->where('estado_id', $request->estado_id);\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n    }\n\n    /**\n     * Sincronizar pruebas.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $pruebas ID's de las pruebas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n        $empresa_plan->pruebas()->sync($pruebas);\n    }\n\n    /**\n     * Sincronizar funcionalidades.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $funcionalidades ID's de las funcionalidades.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n        $empresa_plan->funcionalidades()->sync($funcionalidades);\n    }\n\n    /**\n     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return ?EmpresaPlan\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,llave,valor'\n        ])\n        ->when(\n            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            }\n        )\n        ->when(\n            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n            }\n        )\n        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n        ->first();\n    }\n\n    /**\n     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n     *\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author José Manuel Jiménez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function datosConsumosEmpresas(Request $request): Collection {\n        $roles_tipo_empresa_ids = [\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID\n        ];\n\n        $matriz_conteos = [\n            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n                'empresasUsuarios',\n                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n            )\n        ];\n\n        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw('\n                    (\n                        SELECT COUNT(DISTINCT eu.usuario_id)\n                        FROM empresas_usuarios AS eu\n                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n                    ) AS conteo_total_usuarios_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.agenda_id IS NOT NULL\n                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.oferta_laboral_id IS NOT NULL\n                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n                '),\n            ])\n            ->with([\n                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n                    $consulta_empresa->select($campos_empresas)\n                        ->whereNull('empresa_id')\n                        ->withCount([\n                            ...$matriz_conteos,\n                            'sucursales as conteo_sucursales'\n                        ])\n                        ->with([\n                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n                            }\n                        ]);\n                }\n            ])\n            ->when(\n                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n            )\n            ->whereNotIn('estado_id', [3, 8])\n            ->when(\n                $request->filled('prueba_id'),\n                fn($consulta) => $consulta->whereHas(\n                    'pruebas',\n                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n                )\n            )\n            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n            })\n            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta_plan_por->whereNotNull('unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n                        break;\n                }\n            })\n            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_vencimiento;\n                $fecha_fin    = $request->fecha_vencimiento;\n\n                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_inicio;\n                $fecha_fin    = $request->fecha_inicio;\n\n                if (strpos($request->fecha_inicio, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_inicio);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when(\n                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n            )\n            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n                if ($request->tipo_activacion === 'compra') {\n                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                } elseif ($request->tipo_activacion === 'recompra') {\n                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                }\n            })\n            ->get();\n    }\n\n    /**\n     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     */\n    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n        return $this->modelo::select(\n            'empresas_planes.id',\n            'empresas_planes.empresa_id',\n            'empresas_planes.plan_id',\n            'empresas_planes.plan_credito_id',\n            'empresas_planes.usuario_id',\n            'empresas_planes.estado_id',\n            'empresas_planes.unidades',\n            'empresas_planes.cantidad_ofertas_laborales',\n            'empresas_planes.cantidad_usuarios',\n            'empresas_planes.cantidad_pruebas',\n            'empresas_planes.creditos',\n            'empresas_planes.fecha_inicio',\n            'empresas_planes.fecha_vencimiento',\n            'empresas_planes.precio',\n            'empresas_planes.porcentaje_descuento',\n            'empresas_planes.numero_factura',\n            'empresas_planes.comentario',\n            'empresas_planes.plan_original',\n            'empresas_planes.renovando',\n            'empresas_planes.por_facturar',\n            'empresas_planes.created_at',\n            'planes.id',\n            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n            'planes.nombre AS plan_nombre',\n            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n            'planes.unidades AS plan_unidades',\n            'planes.vigencia AS plan_vigencia',\n            'planes.precio AS plan_precio',\n            'tipos_pruebas.id AS tipo_prueba_id',\n            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n            'estados_planes.id AS estado_plan_id',\n            'estados_planes.nombre AS estado_plan_nombre',\n            'users.id AS usuario_usuario_id',\n            'users.nombres AS usuario_nombres',\n            'users.apellidos AS usuario_apellidos',\n            'empresas.id AS empresa_empresa_id',\n            'empresas.empresa_id',\n            'empresas.nombre_comercial AS empresa_nombre_comercial',\n            'empresas.razon_social AS empresa_razon_social',\n            'empresas.nombre_contacto',\n            'empresas.celular_contacto',\n            'empresas.email_contacto',\n            'empresas.telefono_contacto',\n            'empresas.extension_contacto',\n            'empresas.nombre_tesorero',\n            'empresas.celular_tesorero',\n            'empresas.telefono_tesorero',\n            'empresas.email_tesorero',\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n                )\n                AS conteo_consumos_agendas\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n                )\n                AS conteo_consumos_ofertas_laborales\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM empresas\n                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n                )\n                AS conteo_sucursales\n            '),\n            DB::raw('\n                (\n                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n                    FROM empresas AS sucursales\n                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n                )\n                AS nombres_comerciales_sucursales\n            ')\n        )\n        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n        ->whereNull('empresas.empresa_id')\n        ->when(\n            $request->filled('plan_por'),\n            function ($consulta) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta->whereNotNull('empresas_planes.unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n                        break;\n                }\n            }\n        )\n        ->when(\n            $request->filled('tipo_prueba_id'),\n            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n                TipoPrueba::SELECCION_ID,\n                TipoPrueba::ORGANIZACIONAL_ID,\n                TipoPrueba::VOCACIONAL_ID\n            ])\n        )\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n        ->when(\n            $request->filled('ejecutivo_id'),\n            function ($consulta) use ($request) {\n                $consulta->whereExists(function ($subconsulta) use ($request) {\n                    $subconsulta->select(DB::raw(1))\n                        ->from('empresas_usuarios')\n                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n                });\n            }\n        )\n        ->when(\n            $request->filled('fecha_vencimiento'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n        )\n        ->when(\n            $request->filled('fecha_inicio'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n        )\n        ->when(\n            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n        )\n        ->get();\n    }\n\n    /**\n     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        return $this->modelo::select(\n            'id',\n            'empresa_id',\n            'plan_credito_id',\n            'estado_id',\n            'creditos',\n            'fecha_inicio',\n            'fecha_vencimiento',\n            'precio',\n            'porcentaje_descuento',\n            'numero_factura',\n            'comentario',\n            'created_at'\n        )\n        ->with([\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                    ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n}\n","numLines":911,"startLine":1,"totalLines":911}},"sourceToolAssistantUUID":"bc12176b-b857-4378-ae75-8b3fe18fcff3"}
{"parentUuid":"a37dc83b-fe81-4854-a74a-cd27a1774b36","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_019y85bAjf1x8TDsUo2bMNpK","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me look at the ConsumoCredito model and how credits are consumed to better understand the credit consumption flow."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1293,"cache_creation_input_tokens":25191,"cache_read_input_tokens":27728,"cache_creation":{"ephemeral_5m_input_tokens":25191,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjJoAgH7gxRjUwuuZGo","type":"assistant","uuid":"486d63ec-dc7f-48a3-99a8-6df3cede3e86","timestamp":"2026-01-21T15:05:52.822Z"}
{"parentUuid":"486d63ec-dc7f-48a3-99a8-6df3cede3e86","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_019y85bAjf1x8TDsUo2bMNpK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01U4ssYykKbrbeoLcQpGvgMD","name":"Glob","input":{"pattern":"**/ConsumoCredito*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1293,"cache_creation_input_tokens":25191,"cache_read_input_tokens":27728,"cache_creation":{"ephemeral_5m_input_tokens":25191,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjJoAgH7gxRjUwuuZGo","type":"assistant","uuid":"a7168b9b-4d19-4321-831b-3c665b65b679","timestamp":"2026-01-21T15:05:53.315Z"}
{"parentUuid":"a7168b9b-4d19-4321-831b-3c665b65b679","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_019y85bAjf1x8TDsUo2bMNpK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0147VyPWnjMCCy8xRVz6ZnzA","name":"Grep","input":{"pattern":"creditos_restantes|ConsumoCredito","glob":"**/*.php","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1293,"cache_creation_input_tokens":25191,"cache_read_input_tokens":27728,"cache_creation":{"ephemeral_5m_input_tokens":25191,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjJoAgH7gxRjUwuuZGo","type":"assistant","uuid":"d12055a7-f9b2-42cd-a35f-433c36113aa8","timestamp":"2026-01-21T15:05:54.311Z"}
{"parentUuid":"d12055a7-f9b2-42cd-a35f-433c36113aa8","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0147VyPWnjMCCy8xRVz6ZnzA","type":"tool_result","content":"Found 12 files\napp\\Models\\IA\\ServicioIA.php\nresources\\views\\planes\\index.blade.php\napp\\Traits\\IATrait.php\napp\\Models\\IA\\ConsumoCredito.php\napp\\Models\\Empresas\\EmpresaPlan.php\napp\\Http\\Services\\IA\\ConsumoCreditoService.php\napp\\Http\\Services\\IA\\CreditoIAService.php\napp\\Http\\Services\\Empresas\\EmpresaPlanService.php\napp\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php\napp\\Http\\Controllers\\Empresas\\EmpresaPlanController.php\nstorage\\framework\\views\\842f8cd69a11ef7129e35b432fb6531e.php\nstorage\\framework\\views\\4bf8746c91650af33503b1e630ce2c06.php"}]},"uuid":"004171c8-5e7c-4f39-9f89-cfbd5e8fd5d6","timestamp":"2026-01-21T15:05:56.847Z","toolUseResult":{"mode":"files_with_matches","filenames":["app\\Models\\IA\\ServicioIA.php","resources\\views\\planes\\index.blade.php","app\\Traits\\IATrait.php","app\\Models\\IA\\ConsumoCredito.php","app\\Models\\Empresas\\EmpresaPlan.php","app\\Http\\Services\\IA\\ConsumoCreditoService.php","app\\Http\\Services\\IA\\CreditoIAService.php","app\\Http\\Services\\Empresas\\EmpresaPlanService.php","app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php","app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","storage\\framework\\views\\842f8cd69a11ef7129e35b432fb6531e.php","storage\\framework\\views\\4bf8746c91650af33503b1e630ce2c06.php"],"numFiles":12},"sourceToolAssistantUUID":"d12055a7-f9b2-42cd-a35f-433c36113aa8"}
{"parentUuid":"a7168b9b-4d19-4321-831b-3c665b65b679","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U4ssYykKbrbeoLcQpGvgMD","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php"}]},"uuid":"8cf4afcc-bf23-4715-9f8b-5cc2139458e1","timestamp":"2026-01-21T15:05:57.239Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php"],"durationMs":1027,"numFiles":3,"truncated":false},"sourceToolAssistantUUID":"a7168b9b-4d19-4321-831b-3c665b65b679"}
{"parentUuid":"8cf4afcc-bf23-4715-9f8b-5cc2139458e1","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EMQ115uyadQDY7fQX1GrSX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YLBFC7kmBujPSYNJY9wnA1","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":251,"cache_creation_input_tokens":1639,"cache_read_input_tokens":52919,"cache_creation":{"ephemeral_5m_input_tokens":1639,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXLjKPa8YZigmwMxy59Vf","type":"assistant","uuid":"e57cb113-8708-4540-b1d1-8c7647441e25","timestamp":"2026-01-21T15:06:00.003Z"}
{"parentUuid":"e57cb113-8708-4540-b1d1-8c7647441e25","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EMQ115uyadQDY7fQX1GrSX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MNraLFxHDK7uJeMEdx9YA7","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":251,"cache_creation_input_tokens":1639,"cache_read_input_tokens":52919,"cache_creation":{"ephemeral_5m_input_tokens":1639,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXLjKPa8YZigmwMxy59Vf","type":"assistant","uuid":"886346ce-25c6-4ce5-8bb5-2ed024ebbba9","timestamp":"2026-01-21T15:06:00.523Z"}
{"parentUuid":"e57cb113-8708-4540-b1d1-8c7647441e25","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YLBFC7kmBujPSYNJY9wnA1","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\IA;\n     4→\n     5→use App\\Models\\Usuarios\\User;\n     6→use App\\Models\\Agendas\\Agenda;\n     7→use App\\Models\\Empresas\\Empresa;\n     8→use App\\Models\\Vacantes\\Vacante;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use Illuminate\\Database\\Eloquent\\Model;\n    11→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    12→\n    13→class ConsumoCredito extends Model\n    14→{\n    15→    protected $table = 'consumos_creditos';\n    16→\n    17→    protected $fillable = [\n    18→        'usuario_id',\n    19→        'empresa_id',\n    20→        'empresa_plan_id',\n    21→        'agenda_id',\n    22→        'vacante_id',\n    23→        'servicio_ia_id',\n    24→        'creditos',\n    25→        'ruta_endpoint',\n    26→        'nombre_servicio',\n    27→        'modelo',\n    28→        'tokens_entrada',\n    29→        'tokens_salida',\n    30→        'tokens_totales',\n    31→        'caracteres_entrada',\n    32→        'costo_estimado_usd',\n    33→        'huella_peticion',\n    34→        'extracto_peticion',\n    35→        'extracto_respuesta',\n    36→        'estado',\n    37→        'latencia_ms',\n    38→        'mensaje_error'\n    39→    ];\n    40→\n    41→    protected $casts = [\n    42→        'usuario_id'         => 'integer',\n    43→        'empresa_id'         => 'integer',\n    44→        'empresa_plan_id'    => 'integer',\n    45→        'agenda_id'          => 'integer',\n    46→        'vacante_id'         => 'integer',\n    47→        'servicio_ia_id'     => 'integer',\n    48→        'creditos'           => 'integer',\n    49→        'tokens_entrada'     => 'integer',\n    50→        'tokens_salida'      => 'integer',\n    51→        'tokens_totales'     => 'integer',\n    52→        'caracteres_entrada' => 'integer',\n    53→        'costo_estimado_usd' => 'decimal:6',\n    54→        'latencia_ms'        => 'integer',\n    55→        'created_at'         => 'datetime'\n    56→    ];\n    57→\n    58→    public $timestamps = false;\n    59→\n    60→    /**\n    61→     * Relación de muchos a uno con users.\n    62→     *\n    63→     * @return BelongsTo\n    64→     * @author Sergio Vargas\n    65→     * @author Daniel Beltrán\n    66→     */\n    67→    public function usuario(): BelongsTo {\n    68→        return $this->belongsTo(User::class, 'usuario_id');\n    69→    }\n    70→\n    71→    /**\n    72→     * Relación de muchos a uno con empresas.\n    73→     *\n    74→     * @return BelongsTo\n    75→     * @author Sergio Vargas\n    76→     * @author Daniel Beltrán\n    77→     */\n    78→    public function empresa(): BelongsTo {\n    79→        return $this->belongsTo(Empresa::class);\n    80→    }\n    81→\n    82→    /**\n    83→     * Relación de muchos a uno con empresas_planes.\n    84→     *\n    85→     * @return BelongsTo\n    86→     * @author Sergio Vargas\n    87→     * @author Daniel Beltrán\n    88→     */\n    89→    public function empresaPlan(): BelongsTo {\n    90→        return $this->belongsTo(EmpresaPlan::class, 'empresa_plan_id');\n    91→    }\n    92→\n    93→    /**\n    94→     * Relación de muchos a uno con servicios_ia.\n    95→     *\n    96→     * @return BelongsTo\n    97→     * @author Sergio Vargas\n    98→     * @author Daniel Beltrán\n    99→     */\n   100→    public function servicioIA(): BelongsTo {\n   101→        return $this->belongsTo(ServicioIA::class, 'servicio_ia_id');\n   102→    }\n   103→\n   104→    /**\n   105→     * Relación de muchos a uno con agendas.\n   106→     *\n   107→     * @return BelongsTo\n   108→     * @author Sergio Vargas\n   109→     * @author Daniel Beltrán\n   110→     */\n   111→    public function agenda(): BelongsTo {\n   112→        return $this->belongsTo(Agenda::class);\n   113→    }\n   114→\n   115→    /**\n   116→     * Relación de muchos a uno con vacantes.\n   117→     *\n   118→     * @return BelongsTo\n   119→     * @author Sergio Vargas\n   120→     * @author Daniel Beltrán\n   121→     */\n   122→    public function vacante(): BelongsTo {\n   123→        return $this->belongsTo(Vacante::class);\n   124→    }\n   125→}\n   126→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2834eb59-e9d6-4c96-acfe-2fbcaf027812","timestamp":"2026-01-21T15:06:02.564Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php","content":"<?php\n\nnamespace App\\Models\\IA;\n\nuse App\\Models\\Usuarios\\User;\nuse App\\Models\\Agendas\\Agenda;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Models\\Vacantes\\Vacante;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n\nclass ConsumoCredito extends Model\n{\n    protected $table = 'consumos_creditos';\n\n    protected $fillable = [\n        'usuario_id',\n        'empresa_id',\n        'empresa_plan_id',\n        'agenda_id',\n        'vacante_id',\n        'servicio_ia_id',\n        'creditos',\n        'ruta_endpoint',\n        'nombre_servicio',\n        'modelo',\n        'tokens_entrada',\n        'tokens_salida',\n        'tokens_totales',\n        'caracteres_entrada',\n        'costo_estimado_usd',\n        'huella_peticion',\n        'extracto_peticion',\n        'extracto_respuesta',\n        'estado',\n        'latencia_ms',\n        'mensaje_error'\n    ];\n\n    protected $casts = [\n        'usuario_id'         => 'integer',\n        'empresa_id'         => 'integer',\n        'empresa_plan_id'    => 'integer',\n        'agenda_id'          => 'integer',\n        'vacante_id'         => 'integer',\n        'servicio_ia_id'     => 'integer',\n        'creditos'           => 'integer',\n        'tokens_entrada'     => 'integer',\n        'tokens_salida'      => 'integer',\n        'tokens_totales'     => 'integer',\n        'caracteres_entrada' => 'integer',\n        'costo_estimado_usd' => 'decimal:6',\n        'latencia_ms'        => 'integer',\n        'created_at'         => 'datetime'\n    ];\n\n    public $timestamps = false;\n\n    /**\n     * Relación de muchos a uno con users.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function usuario(): BelongsTo {\n        return $this->belongsTo(User::class, 'usuario_id');\n    }\n\n    /**\n     * Relación de muchos a uno con empresas.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function empresa(): BelongsTo {\n        return $this->belongsTo(Empresa::class);\n    }\n\n    /**\n     * Relación de muchos a uno con empresas_planes.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function empresaPlan(): BelongsTo {\n        return $this->belongsTo(EmpresaPlan::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de muchos a uno con servicios_ia.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function servicioIA(): BelongsTo {\n        return $this->belongsTo(ServicioIA::class, 'servicio_ia_id');\n    }\n\n    /**\n     * Relación de muchos a uno con agendas.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function agenda(): BelongsTo {\n        return $this->belongsTo(Agenda::class);\n    }\n\n    /**\n     * Relación de muchos a uno con vacantes.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function vacante(): BelongsTo {\n        return $this->belongsTo(Vacante::class);\n    }\n}\n","numLines":126,"startLine":1,"totalLines":126}},"sourceToolAssistantUUID":"e57cb113-8708-4540-b1d1-8c7647441e25"}
{"parentUuid":"886346ce-25c6-4ce5-8bb5-2ed024ebbba9","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MNraLFxHDK7uJeMEdx9YA7","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\IA;\n     4→\n     5→use Carbon\\Carbon;\n     6→use Illuminate\\Support\\Str;\n     7→use App\\Models\\IA\\ConsumoCredito;\n     8→use App\\Http\\Services\\BaseService;\n     9→use Illuminate\\Support\\Collection;\n    10→use App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n    11→\n    12→class ConsumoCreditoService extends BaseService\n    13→{\n    14→    /**\n    15→     * Constructor.\n    16→     *\n    17→     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n    18→     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n    19→     * @return void\n    20→     * @author Sergio Vargas\n    21→     * @author Daniel Beltrán\n    22→     */\n    23→    public function __construct(\n    24→        ConsumoCreditoRepository $repositorio,\n    25→        private readonly ServicioPrecioTokenService $precio_token_servicio\n    26→    ) {\n    27→        parent::__construct($repositorio);\n    28→    }\n    29→\n    30→    /**\n    31→     * Registra el consumo de tokens desde la respuesta de la API de IA.\n    32→     *\n    33→     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n    34→     *\n    35→     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n    36→     * @param array $respuesta_ia Respuesta completa de la API de IA.\n    37→     * @param ?int $usuario_id ID del usuario que realizó la petición.\n    38→     * @param ?int $empresa_id ID de la empresa del usuario.\n    39→     * @param array $contexto Array con agenda_id, vacante_id, etc.\n    40→     * @param ?string $payload_peticion JSON del payload enviado.\n    41→     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n    42→     * @return ?ConsumoCredito\n    43→     * @author Sergio Vargas\n    44→     * @author Daniel Beltrán\n    45→     */\n    46→    public function registrarConsumoDesdeRespuesta(\n    47→        string $ruta_endpoint,\n    48→        array $respuesta_ia,\n    49→        ?int $usuario_id = null,\n    50→        ?int $empresa_id = null,\n    51→        ?array $contexto = [],\n    52→        ?string $payload_peticion = null,\n    53→        ?int $latencia_ms = null\n    54→    ): ?ConsumoCredito {\n    55→        // Detectar si hay múltiples metadata de uso (formato nuevo)\n    56→        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n    57→        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n    58→        $ultimo_registro = null;\n    59→\n    60→        // Registrar Whisper si existe\n    61→        if ($uso_whisper) {\n    62→            $ultimo_registro = $this->registrarConsumoIndividual(\n    63→                ruta_endpoint: $ruta_endpoint . '.whisper',\n    64→                usage: $uso_whisper,\n    65→                respuesta_ia: $respuesta_ia,\n    66→                usuario_id: $usuario_id,\n    67→                empresa_id: $empresa_id,\n    68→                contexto: $contexto,\n    69→                payload_peticion: $payload_peticion,\n    70→                latencia_ms: $latencia_ms\n    71→            );\n    72→        }\n    73→\n    74→        // Registrar GPT si existe\n    75→        if ($uso_gpt) {\n    76→            $ultimo_registro = $this->registrarConsumoIndividual(\n    77→                ruta_endpoint: $ruta_endpoint . '.gpt',\n    78→                usage: $uso_gpt,\n    79→                respuesta_ia: $respuesta_ia,\n    80→                usuario_id: $usuario_id,\n    81→                empresa_id: $empresa_id,\n    82→                contexto: $contexto,\n    83→                payload_peticion: $payload_peticion,\n    84→                latencia_ms: $latencia_ms\n    85→            );\n    86→        }\n    87→\n    88→        // Fallback: Si solo hay \"usage\" (formato legacy)\n    89→        $usage_legacy = $respuesta_ia['usage'] ?? null;\n    90→\n    91→        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n    92→            $ultimo_registro = $this->registrarConsumoIndividual(\n    93→                ruta_endpoint: $ruta_endpoint,\n    94→                usage: $usage_legacy,\n    95→                respuesta_ia: $respuesta_ia,\n    96→                usuario_id: $usuario_id,\n    97→                empresa_id: $empresa_id,\n    98→                contexto: $contexto,\n    99→                payload_peticion: $payload_peticion,\n   100→                latencia_ms: $latencia_ms\n   101→            );\n   102→        }\n   103→\n   104→        return $ultimo_registro;\n   105→    }\n   106→\n   107→    /**\n   108→     * Registra un consumo individual de tokens desde una metadata de uso específica.\n   109→     *\n   110→     * @param string $ruta_endpoint Ruta del endpoint llamado.\n   111→     * @param array $usage Metadata de uso específica.\n   112→     * @param array $respuesta_ia Respuesta completa de la API de IA.\n   113→     * @param ?int $usuario_id ID del usuario que realizó la petición.\n   114→     * @param ?int $empresa_id ID de la empresa del usuario.\n   115→     * @param array $contexto Array con agenda_id, vacante_id, etc.\n   116→     * @param ?string $payload_peticion JSON del payload enviado.\n   117→     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n   118→     * @return ?ConsumoCredito\n   119→     * @author Sergio Vargas\n   120→     * @author Daniel Beltrán\n   121→     */\n   122→    private function registrarConsumoIndividual(\n   123→        string $ruta_endpoint,\n   124→        array $usage,\n   125→        array $respuesta_ia,\n   126→        ?int $usuario_id,\n   127→        ?int $empresa_id,\n   128→        array $contexto,\n   129→        ?string $payload_peticion,\n   130→        ?int $latencia_ms\n   131→    ): ?ConsumoCredito {\n   132→        $vacante_id = $contexto['vacante_id'] ?? null;\n   133→\n   134→        if (!$vacante_id && $payload_peticion) {\n   135→            $decoded = json_decode($payload_peticion, true);\n   136→\n   137→            if (is_array($decoded)) {\n   138→                $vacante_id = data_get($decoded, 'vacante_id')\n   139→                    ?? data_get($decoded, 'vacanteId')\n   140→                    ?? data_get($decoded, 'id')\n   141→                    ?? data_get($decoded, 'vacante.id');\n   142→\n   143→                if ($vacante_id && !is_numeric($vacante_id)) {\n   144→                    $vacante_id = null;\n   145→                } elseif (is_numeric($vacante_id)) {\n   146→                    $vacante_id = (int) $vacante_id;\n   147→                }\n   148→            }\n   149→        }\n   150→\n   151→        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n   152→        $modelo = $usage['model'] ?? 'desconocido';\n   153→\n   154→        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n   155→        $metadata_adicional = [];\n   156→\n   157→        if (isset($usage['audio_duration_minutes'])) {\n   158→            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n   159→        }\n   160→\n   161→        if (isset($usage['audio_duration_seconds'])) {\n   162→            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n   163→        }\n   164→\n   165→        // Calcular costo estimado (pasando metadata adicional para Whisper)\n   166→        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n   167→            $modelo,\n   168→            $usage['prompt_tokens'] ?? 0,\n   169→            $usage['completion_tokens'] ?? 0,\n   170→            $metadata_adicional ?: null\n   171→        );\n   172→\n   173→        // Generar huella digital\n   174→        $huella_peticion = null;\n   175→\n   176→        if ($payload_peticion) {\n   177→            $huella_peticion = hash('sha256', $payload_peticion);\n   178→        }\n   179→\n   180→        // Determinar estado de la respuesta\n   181→        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n   182→        $estado = 'exitoso';\n   183→\n   184→        if (isset($respuesta_ia['status_code'])) {\n   185→            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n   186→        } elseif (isset($respuesta_ia['error'])) {\n   187→            $estado = 'error';\n   188→        }\n   189→\n   190→        // Preparar datos\n   191→        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n   192→        $contenido_respuesta = $respuesta_ia['data']\n   193→            ?? $respuesta_ia['vacante']\n   194→            ?? $respuesta_ia['preguntas']\n   195→            ?? $respuesta_ia['pruebas']\n   196→            ?? $respuesta_ia['calificacion']\n   197→            ?? null;\n   198→\n   199→        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n   200→        if ($contenido_respuesta === null) {\n   201→            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n   202→        }\n   203→\n   204→        $datos = [\n   205→            'usuario_id'         => $usuario_id,\n   206→            'empresa_id'         => $empresa_id,\n   207→            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n   208→            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n   209→            'creditos'           => $contexto['creditos'] ?? 0,\n   210→            'ruta_endpoint'      => $ruta_endpoint,\n   211→            'nombre_servicio'    => $usage['service_name'] ?? null,\n   212→            'modelo'             => $modelo,\n   213→            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n   214→            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n   215→            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n   216→            'caracteres_entrada' => $usage['input_chars'] ?? null,\n   217→            'costo_estimado_usd' => $costo_estimado,\n   218→            'huella_peticion'    => $huella_peticion,\n   219→            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n   220→            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n   221→            'estado'             => $estado,\n   222→            'latencia_ms'        => $latencia_ms,\n   223→            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n   224→            'agenda_id'          => $contexto['agenda_id'] ?? null,\n   225→            'vacante_id'         => $vacante_id\n   226→        ];\n   227→\n   228→        return $this->repositorio->crear($datos);\n   229→    }\n   230→\n   231→    /**\n   232→     * Obtener historial de consumos de creditos por empresa.\n   233→     *\n   234→     * @param int $empresa_id ID de la empresa.\n   235→     * @param array $filtros Filtros de fecha.\n   236→     * @return Collection\n   237→     * @author Sergio Vargas\n   238→     */\n   239→    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n   240→        $desde = null;\n   241→        $hasta = null;\n   242→\n   243→        if (!empty($filtros['desde'])) {\n   244→            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n   245→        }\n   246→\n   247→        if (!empty($filtros['hasta'])) {\n   248→            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n   249→        }\n   250→\n   251→        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n   252→\n   253→        return $consumos->map(function (ConsumoCredito $consumo) {\n   254→            $servicio = $consumo->servicioIA?->nombre\n   255→                ?? $consumo->nombre_servicio\n   256→                ?? $consumo->ruta_endpoint;\n   257→\n   258→            return [\n   259→                'usuario'        => $consumo->usuario ? [\n   260→                    'id'              => $consumo->usuario->id,\n   261→                    'nombre_completo' => $consumo->usuario->nombre_completo\n   262→                ] : null,\n   263→                'servicio'       => $servicio,\n   264→                'creditos'       => $consumo->creditos ?? 0,\n   265→                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n   266→                'fecha_consumo'  => $consumo->created_at\n   267→            ];\n   268→        });\n   269→    }\n   270→}\n   271→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"644aa24f-3e01-425b-a99b-8e7520b71212","timestamp":"2026-01-21T15:06:02.565Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","content":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n\nclass ConsumoCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Registra el consumo de tokens desde la respuesta de la API de IA.\n     *\n     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function registrarConsumoDesdeRespuesta(\n        string $ruta_endpoint,\n        array $respuesta_ia,\n        ?int $usuario_id = null,\n        ?int $empresa_id = null,\n        ?array $contexto = [],\n        ?string $payload_peticion = null,\n        ?int $latencia_ms = null\n    ): ?ConsumoCredito {\n        // Detectar si hay múltiples metadata de uso (formato nuevo)\n        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n        $ultimo_registro = null;\n\n        // Registrar Whisper si existe\n        if ($uso_whisper) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.whisper',\n                usage: $uso_whisper,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Registrar GPT si existe\n        if ($uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.gpt',\n                usage: $uso_gpt,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Registra un consumo individual de tokens desde una metadata de uso específica.\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado.\n     * @param array $usage Metadata de uso específica.\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function registrarConsumoIndividual(\n        string $ruta_endpoint,\n        array $usage,\n        array $respuesta_ia,\n        ?int $usuario_id,\n        ?int $empresa_id,\n        array $contexto,\n        ?string $payload_peticion,\n        ?int $latencia_ms\n    ): ?ConsumoCredito {\n        $vacante_id = $contexto['vacante_id'] ?? null;\n\n        if (!$vacante_id && $payload_peticion) {\n            $decoded = json_decode($payload_peticion, true);\n\n            if (is_array($decoded)) {\n                $vacante_id = data_get($decoded, 'vacante_id')\n                    ?? data_get($decoded, 'vacanteId')\n                    ?? data_get($decoded, 'id')\n                    ?? data_get($decoded, 'vacante.id');\n\n                if ($vacante_id && !is_numeric($vacante_id)) {\n                    $vacante_id = null;\n                } elseif (is_numeric($vacante_id)) {\n                    $vacante_id = (int) $vacante_id;\n                }\n            }\n        }\n\n        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n        $modelo = $usage['model'] ?? 'desconocido';\n\n        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n        $metadata_adicional = [];\n\n        if (isset($usage['audio_duration_minutes'])) {\n            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n        }\n\n        if (isset($usage['audio_duration_seconds'])) {\n            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n        }\n\n        // Calcular costo estimado (pasando metadata adicional para Whisper)\n        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n            $modelo,\n            $usage['prompt_tokens'] ?? 0,\n            $usage['completion_tokens'] ?? 0,\n            $metadata_adicional ?: null\n        );\n\n        // Generar huella digital\n        $huella_peticion = null;\n\n        if ($payload_peticion) {\n            $huella_peticion = hash('sha256', $payload_peticion);\n        }\n\n        // Determinar estado de la respuesta\n        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n        $estado = 'exitoso';\n\n        if (isset($respuesta_ia['status_code'])) {\n            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n        } elseif (isset($respuesta_ia['error'])) {\n            $estado = 'error';\n        }\n\n        // Preparar datos\n        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n        $contenido_respuesta = $respuesta_ia['data']\n            ?? $respuesta_ia['vacante']\n            ?? $respuesta_ia['preguntas']\n            ?? $respuesta_ia['pruebas']\n            ?? $respuesta_ia['calificacion']\n            ?? null;\n\n        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n        if ($contenido_respuesta === null) {\n            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n        }\n\n        $datos = [\n            'usuario_id'         => $usuario_id,\n            'empresa_id'         => $empresa_id,\n            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n            'creditos'           => $contexto['creditos'] ?? 0,\n            'ruta_endpoint'      => $ruta_endpoint,\n            'nombre_servicio'    => $usage['service_name'] ?? null,\n            'modelo'             => $modelo,\n            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n            'caracteres_entrada' => $usage['input_chars'] ?? null,\n            'costo_estimado_usd' => $costo_estimado,\n            'huella_peticion'    => $huella_peticion,\n            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n            'estado'             => $estado,\n            'latencia_ms'        => $latencia_ms,\n            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n            'agenda_id'          => $contexto['agenda_id'] ?? null,\n            'vacante_id'         => $vacante_id\n        ];\n\n        return $this->repositorio->crear($datos);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param array $filtros Filtros de fecha.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n        $desde = null;\n        $hasta = null;\n\n        if (!empty($filtros['desde'])) {\n            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n        }\n\n        if (!empty($filtros['hasta'])) {\n            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n        }\n\n        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n\n        return $consumos->map(function (ConsumoCredito $consumo) {\n            $servicio = $consumo->servicioIA?->nombre\n                ?? $consumo->nombre_servicio\n                ?? $consumo->ruta_endpoint;\n\n            return [\n                'usuario'        => $consumo->usuario ? [\n                    'id'              => $consumo->usuario->id,\n                    'nombre_completo' => $consumo->usuario->nombre_completo\n                ] : null,\n                'servicio'       => $servicio,\n                'creditos'       => $consumo->creditos ?? 0,\n                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n                'fecha_consumo'  => $consumo->created_at\n            ];\n        });\n    }\n}\n","numLines":271,"startLine":1,"totalLines":271}},"sourceToolAssistantUUID":"886346ce-25c6-4ce5-8bb5-2ed024ebbba9"}
{"parentUuid":"644aa24f-3e01-425b-a99b-8e7520b71212","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_017rM3dwLKUGxu9gUpvyUiWC","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me examine how credit plans are used and if there's an existing method to get \"next\" credit plan."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":6327,"cache_read_input_tokens":54558,"cache_creation":{"ephemeral_5m_input_tokens":6327,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjKoT5QzLSwSQgtdABk","type":"assistant","uuid":"84d8f6cf-c3d7-4bc6-9a29-466bf1ecbffb","timestamp":"2026-01-21T15:06:06.160Z"}
{"parentUuid":"84d8f6cf-c3d7-4bc6-9a29-466bf1ecbffb","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_017rM3dwLKUGxu9gUpvyUiWC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Q3pKZDXqxNyiPUcbKRBdxY","name":"Grep","input":{"pattern":"plan_credito_id|planCredito","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":6327,"cache_read_input_tokens":54558,"cache_creation":{"ephemeral_5m_input_tokens":6327,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjKoT5QzLSwSQgtdABk","type":"assistant","uuid":"a487463e-ea6f-497b-8774-206f405eef40","timestamp":"2026-01-21T15:06:08.176Z"}
{"parentUuid":"a487463e-ea6f-497b-8774-206f405eef40","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_017rM3dwLKUGxu9gUpvyUiWC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01L368VQFToLc9iDAtQcXVnY","name":"Grep","input":{"pattern":"planProximoCreditos|planCreditoProximo","glob":"**/*.php","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":6327,"cache_read_input_tokens":54558,"cache_creation":{"ephemeral_5m_input_tokens":6327,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjKoT5QzLSwSQgtdABk","type":"assistant","uuid":"d1031e4d-2d3b-435f-959e-8d8ded191ecf","timestamp":"2026-01-21T15:06:09.023Z"}
{"parentUuid":"a487463e-ea6f-497b-8774-206f405eef40","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Q3pKZDXqxNyiPUcbKRBdxY","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:76:        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:77:            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:82:        } elseif (!$request->filled('plan_credito_id')) {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:84:                'plan_credito_id' => null,\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:376:            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:592:        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:599:            'plan_credito'         => $empresa_plan->planCredito ? [\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:600:                'id'       => $empresa_plan->planCredito->id,\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:601:                'nombre'   => $empresa_plan->planCredito->nombre,\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:602:                'creditos' => $empresa_plan->planCredito->creditos,\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:603:                'precio'   => $empresa_plan->planCredito->precio"}]},"uuid":"d2037f5f-5099-4728-a4e0-0b405171b5bb","timestamp":"2026-01-21T15:06:11.547Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:76:        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:77:            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:82:        } elseif (!$request->filled('plan_credito_id')) {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:84:                'plan_credito_id' => null,\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:376:            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:592:        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:599:            'plan_credito'         => $empresa_plan->planCredito ? [\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:600:                'id'       => $empresa_plan->planCredito->id,\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:601:                'nombre'   => $empresa_plan->planCredito->nombre,\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:602:                'creditos' => $empresa_plan->planCredito->creditos,\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:603:                'precio'   => $empresa_plan->planCredito->precio","numLines":11},"sourceToolAssistantUUID":"a487463e-ea6f-497b-8774-206f405eef40"}
{"parentUuid":"d1031e4d-2d3b-435f-959e-8d8ded191ecf","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01L368VQFToLc9iDAtQcXVnY","type":"tool_result","content":"No matches found"}]},"uuid":"b8cf9e62-4e2a-44b3-af10-2f1afc72ec31","timestamp":"2026-01-21T15:06:11.582Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0},"sourceToolAssistantUUID":"d1031e4d-2d3b-435f-959e-8d8ded191ecf"}
{"parentUuid":"b8cf9e62-4e2a-44b3-af10-2f1afc72ec31","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GcVBZcLJ1YPRXC6umutcDc","type":"message","role":"assistant","content":[{"type":"text","text":"Let me also check the database migration to understand the structure of the `empresas_planes` table and see if there are any constraints on `plan_id` for credit plans."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1023,"cache_read_input_tokens":60885,"cache_creation":{"ephemeral_5m_input_tokens":1023,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXLjLTKPZG9Zyu65KxvAc","type":"assistant","uuid":"24d6ba63-899b-406b-ac72-aea912df5d53","timestamp":"2026-01-21T15:06:15.170Z"}
{"parentUuid":"24d6ba63-899b-406b-ac72-aea912df5d53","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GcVBZcLJ1YPRXC6umutcDc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TMBock1zD6krvMmdq663ro","name":"Glob","input":{"pattern":"**/migrations/*empresas_planes*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1023,"cache_read_input_tokens":60885,"cache_creation":{"ephemeral_5m_input_tokens":1023,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXLjLTKPZG9Zyu65KxvAc","type":"assistant","uuid":"8c6bdae9-e92f-4921-b59c-3254e77c7ba4","timestamp":"2026-01-21T15:06:15.659Z"}
{"parentUuid":"8c6bdae9-e92f-4921-b59c-3254e77c7ba4","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GcVBZcLJ1YPRXC6umutcDc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UdBRh1qUoad5Vjw97pwYEJ","name":"Grep","input":{"pattern":"creditos|plan_credito","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1023,"cache_read_input_tokens":60885,"cache_creation":{"ephemeral_5m_input_tokens":1023,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXLjLTKPZG9Zyu65KxvAc","type":"assistant","uuid":"778a785c-80fb-4177-a5c0-013f3e0eaa10","timestamp":"2026-01-21T15:06:16.586Z"}
{"parentUuid":"778a785c-80fb-4177-a5c0-013f3e0eaa10","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UdBRh1qUoad5Vjw97pwYEJ","type":"tool_result","content":"Found 6 files\ndatabase\\migrations\\2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php\ndatabase\\migrations\\2026_01_02_000003_create_servicios_ia_table.php\ndatabase\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php\ndatabase\\migrations\\2026_01_02_000005_rename_consumos_tokens_openai_to_consumos_creditos_table.php\ndatabase\\migrations\\2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php\ndatabase\\migrations\\2026_01_02_000001_create_planes_creditos_table.php"}]},"uuid":"96a9d5f2-c967-40b7-b590-4e1a47c418a4","timestamp":"2026-01-21T15:06:19.207Z","toolUseResult":{"mode":"files_with_matches","filenames":["database\\migrations\\2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php","database\\migrations\\2026_01_02_000003_create_servicios_ia_table.php","database\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php","database\\migrations\\2026_01_02_000005_rename_consumos_tokens_openai_to_consumos_creditos_table.php","database\\migrations\\2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php","database\\migrations\\2026_01_02_000001_create_planes_creditos_table.php"],"numFiles":6},"sourceToolAssistantUUID":"778a785c-80fb-4177-a5c0-013f3e0eaa10"}
{"parentUuid":"8c6bdae9-e92f-4921-b59c-3254e77c7ba4","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TMBock1zD6krvMmdq663ro","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2024_03_06_164436_create_empresas_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2024_07_15_094318_create_empresas_planes_pruebas_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2024_09_02_164635_create_empresas_planes_funcionalidades_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php"}]},"uuid":"3a78b436-f1e8-4e80-af8c-590c60a5efbd","timestamp":"2026-01-21T15:06:19.561Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2024_03_06_164436_create_empresas_planes_table.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2024_07_15_094318_create_empresas_planes_pruebas_table.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2024_09_02_164635_create_empresas_planes_funcionalidades_table.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php"],"durationMs":1028,"numFiles":4,"truncated":false},"sourceToolAssistantUUID":"8c6bdae9-e92f-4921-b59c-3254e77c7ba4"}
{"parentUuid":"3a78b436-f1e8-4e80-af8c-590c60a5efbd","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_011swPkUq48N9rAMXqya5oes","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019nRLd8YTnzimY2NxhKt89q","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2024_03_06_164436_create_empresas_planes_table.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":228,"cache_creation_input_tokens":809,"cache_read_input_tokens":61908,"cache_creation":{"ephemeral_5m_input_tokens":809,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXLjM2zSY9CcvERHy4xwn","type":"assistant","uuid":"91a0937e-0bec-4ade-a53a-b6eed71eb290","timestamp":"2026-01-21T15:06:22.533Z"}
{"parentUuid":"91a0937e-0bec-4ade-a53a-b6eed71eb290","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_011swPkUq48N9rAMXqya5oes","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01J7aoHRVzPmxGEyrwMxqrmK","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":228,"cache_creation_input_tokens":809,"cache_read_input_tokens":61908,"cache_creation":{"ephemeral_5m_input_tokens":809,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXLjM2zSY9CcvERHy4xwn","type":"assistant","uuid":"d5dca28b-b8c0-4947-8fa8-f1b808aea2e1","timestamp":"2026-01-21T15:06:23.051Z"}
{"parentUuid":"91a0937e-0bec-4ade-a53a-b6eed71eb290","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019nRLd8YTnzimY2NxhKt89q","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Facades\\Schema;\n     4→use Illuminate\\Database\\Schema\\Blueprint;\n     5→use Illuminate\\Database\\Migrations\\Migration;\n     6→\n     7→return new class extends Migration\n     8→{\n     9→    /**\n    10→     * Run the migrations.\n    11→     */\n    12→    public function up(): void\n    13→    {\n    14→        Schema::create('empresas_planes', function (Blueprint $table) {\n    15→            $table->id();\n    16→            $table->foreignId('empresa_id')->comment('Empresa')->references('id')->on('empresas');\n    17→            $table->foreignId('plan_id')->comment('Plan')->references('id')->on('planes');\n    18→            $table->foreignId('estado_id')->comment('Estado')->references('id')->on('estados_planes');\n    19→            $table->integer('unidades')->nullable()->comment('Unidades de pruebas. Cuando el plan sea por tiempo, entonces este campo se utilizará como unidades máximas para política de uso justo');\n    20→            $table->integer('cantidad_ofertas_laborales')->nullable()->comment('Cantidad de ofertas laborales. Cuando el plan sea por tiempo, entonces este campo se utilizará como ofertas laborales máximas para política de uso justo');\n    21→            $table->integer('cantidad_usuarios')->comment('Cantidad de usuarios');\n    22→            $table->integer('cantidad_pruebas')->comment('Cantidad de pruebas (se refiere a pruebas como tal (Ten Disc, Ethikos, 360, etc...), no a unidades de pruebas)');\n    23→            $table->date('fecha_inicio')->nullable()->comment('Fecha de inicio');\n    24→            $table->date('fecha_vencimiento')->nullable()->comment('Fecha de vencimiento');\n    25→            $table->float('precio', 10, 2)->comment('Precio con descuento aplicado (en caso de que tenga descuento)');\n    26→            $table->smallInteger('porcentaje_descuento')->nullable()->comment('Porcentaje de descuento');\n    27→            $table->string('numero_factura', 50)->nullable()->comment('Número de factura');\n    28→            $table->text('comentario')->nullable()->comment('Comentario o detalle de uso');\n    29→            $table->boolean('plan_original')->default(true)->comment('Indica si se asignó el plan original o si se trata de una modificación del mismo');\n    30→            $table->boolean('renovando')->default(false)->comment('Indica si el plan está en proceso de renovación');\n    31→            $table->boolean('por_facturar')->default(false)->comment('Indica si el plan está en proceso de facturación');\n    32→            $table->timestamps();\n    33→\n    34→            $table->comment('Planes de las empresas');\n    35→        });\n    36→    }\n    37→\n    38→    /**\n    39→     * Reverse the migrations.\n    40→     */\n    41→    public function down(): void\n    42→    {\n    43→        Schema::dropIfExists('empresas_planes');\n    44→    }\n    45→};\n    46→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"9e480f3b-e982-4f1f-8e58-087323c49e0a","timestamp":"2026-01-21T15:06:25.124Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2024_03_06_164436_create_empresas_planes_table.php","content":"<?php\n\nuse Illuminate\\Support\\Facades\\Schema;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Database\\Migrations\\Migration;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        Schema::create('empresas_planes', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('empresa_id')->comment('Empresa')->references('id')->on('empresas');\n            $table->foreignId('plan_id')->comment('Plan')->references('id')->on('planes');\n            $table->foreignId('estado_id')->comment('Estado')->references('id')->on('estados_planes');\n            $table->integer('unidades')->nullable()->comment('Unidades de pruebas. Cuando el plan sea por tiempo, entonces este campo se utilizará como unidades máximas para política de uso justo');\n            $table->integer('cantidad_ofertas_laborales')->nullable()->comment('Cantidad de ofertas laborales. Cuando el plan sea por tiempo, entonces este campo se utilizará como ofertas laborales máximas para política de uso justo');\n            $table->integer('cantidad_usuarios')->comment('Cantidad de usuarios');\n            $table->integer('cantidad_pruebas')->comment('Cantidad de pruebas (se refiere a pruebas como tal (Ten Disc, Ethikos, 360, etc...), no a unidades de pruebas)');\n            $table->date('fecha_inicio')->nullable()->comment('Fecha de inicio');\n            $table->date('fecha_vencimiento')->nullable()->comment('Fecha de vencimiento');\n            $table->float('precio', 10, 2)->comment('Precio con descuento aplicado (en caso de que tenga descuento)');\n            $table->smallInteger('porcentaje_descuento')->nullable()->comment('Porcentaje de descuento');\n            $table->string('numero_factura', 50)->nullable()->comment('Número de factura');\n            $table->text('comentario')->nullable()->comment('Comentario o detalle de uso');\n            $table->boolean('plan_original')->default(true)->comment('Indica si se asignó el plan original o si se trata de una modificación del mismo');\n            $table->boolean('renovando')->default(false)->comment('Indica si el plan está en proceso de renovación');\n            $table->boolean('por_facturar')->default(false)->comment('Indica si el plan está en proceso de facturación');\n            $table->timestamps();\n\n            $table->comment('Planes de las empresas');\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::dropIfExists('empresas_planes');\n    }\n};\n","numLines":46,"startLine":1,"totalLines":46}},"sourceToolAssistantUUID":"91a0937e-0bec-4ade-a53a-b6eed71eb290"}
{"parentUuid":"d5dca28b-b8c0-4947-8fa8-f1b808aea2e1","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01J7aoHRVzPmxGEyrwMxqrmK","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Facades\\Schema;\n     4→use Illuminate\\Database\\Schema\\Blueprint;\n     5→use Illuminate\\Database\\Migrations\\Migration;\n     6→\n     7→return new class extends Migration\n     8→{\n     9→    /**\n    10→     * Run the migrations.\n    11→     */\n    12→    public function up(): void {\n    13→        Schema::table('empresas_planes', function (Blueprint $table) {\n    14→            $table->foreignId('plan_credito_id')->nullable()->constrained('planes_creditos')->nullOnDelete()->after('plan_id');\n    15→            $table->integer('creditos')->default(0)->after('cantidad_pruebas')->comment('Cantidad de créditos iniciales');\n    16→        });\n    17→    }\n    18→\n    19→    /**\n    20→     * Reverse the migrations.\n    21→     */\n    22→    public function down(): void {\n    23→        Schema::table('empresas_planes', function (Blueprint $table) {\n    24→            $table->dropConstrainedForeignId('plan_credito_id');\n    25→            $table->dropColumn('creditos');\n    26→        });\n    27→    }\n    28→};\n    29→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3907a26e-eb24-4580-9445-5b7ff33f9e7d","timestamp":"2026-01-21T15:06:25.124Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php","content":"<?php\n\nuse Illuminate\\Support\\Facades\\Schema;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Database\\Migrations\\Migration;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void {\n        Schema::table('empresas_planes', function (Blueprint $table) {\n            $table->foreignId('plan_credito_id')->nullable()->constrained('planes_creditos')->nullOnDelete()->after('plan_id');\n            $table->integer('creditos')->default(0)->after('cantidad_pruebas')->comment('Cantidad de créditos iniciales');\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void {\n        Schema::table('empresas_planes', function (Blueprint $table) {\n            $table->dropConstrainedForeignId('plan_credito_id');\n            $table->dropColumn('creditos');\n        });\n    }\n};\n","numLines":29,"startLine":1,"totalLines":29}},"sourceToolAssistantUUID":"d5dca28b-b8c0-4947-8fa8-f1b808aea2e1"}
{"parentUuid":"3907a26e-eb24-4580-9445-5b7ff33f9e7d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YVMtfw1a8awPhAYh3YgqJP","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a comprehensive understanding of the system. Let me examine how the plan states are used and if there are tests that I can reference."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1804,"cache_read_input_tokens":62717,"cache_creation":{"ephemeral_5m_input_tokens":1804,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLjMU8XnM6uHkzZZFnCB","type":"assistant","uuid":"d044a1a2-7ae8-4267-92b8-d09517b10b71","timestamp":"2026-01-21T15:06:28.677Z"}
{"parentUuid":"d044a1a2-7ae8-4267-92b8-d09517b10b71","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YVMtfw1a8awPhAYh3YgqJP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018875ueMRAvz5CqP74F2Bzt","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\EstadoPlan.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1804,"cache_read_input_tokens":62717,"cache_creation":{"ephemeral_5m_input_tokens":1804,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLjMU8XnM6uHkzZZFnCB","type":"assistant","uuid":"2b0b42c5-5bb0-47bd-9096-c1db7d5b90e2","timestamp":"2026-01-21T15:06:29.349Z"}
{"parentUuid":"2b0b42c5-5bb0-47bd-9096-c1db7d5b90e2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YVMtfw1a8awPhAYh3YgqJP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01V4mtLRxnZKiwnWmyz83FFq","name":"Grep","input":{"pattern":"esSoloPlanCreditos|esPlanMixto|tieneCreditos","glob":"**/*.php","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1804,"cache_read_input_tokens":62717,"cache_creation":{"ephemeral_5m_input_tokens":1804,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXLjMU8XnM6uHkzZZFnCB","type":"assistant","uuid":"3b3b917a-9d42-4527-a93b-96b27e563745","timestamp":"2026-01-21T15:06:30.317Z"}
{"parentUuid":"2b0b42c5-5bb0-47bd-9096-c1db7d5b90e2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018875ueMRAvz5CqP74F2Bzt","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Planes;\n     4→\n     5→use Illuminate\\Database\\Eloquent\\Model;\n     6→use Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\n     7→\n     8→class EstadoPlan extends Model\n     9→{\n    10→    use HasFactory;\n    11→\n    12→    protected $table = 'estados_planes';\n    13→\n    14→    protected $fillable = [\n    15→        'nombre'\n    16→    ];\n    17→}\n    18→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"835a0b54-3604-4360-aa09-bb6a4551adb3","timestamp":"2026-01-21T15:06:32.278Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\EstadoPlan.php","content":"<?php\n\nnamespace App\\Models\\Planes;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\n\nclass EstadoPlan extends Model\n{\n    use HasFactory;\n\n    protected $table = 'estados_planes';\n\n    protected $fillable = [\n        'nombre'\n    ];\n}\n","numLines":18,"startLine":1,"totalLines":18}},"sourceToolAssistantUUID":"2b0b42c5-5bb0-47bd-9096-c1db7d5b90e2"}
{"parentUuid":"3b3b917a-9d42-4527-a93b-96b27e563745","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01V4mtLRxnZKiwnWmyz83FFq","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:617:    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Usuarios\\CompletarDatosService.php:99:                $creditos_disponibles = $this->empresa_plan_servicio->tieneCreditosSuficientes($creditos['empresa_plan_id'], $servicio_ia->consume_creditos);"}]},"uuid":"e3cb89e7-9966-404f-b8cd-e361917eaefa","timestamp":"2026-01-21T15:06:32.846Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:617:    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Usuarios\\CompletarDatosService.php:99:                $creditos_disponibles = $this->empresa_plan_servicio->tieneCreditosSuficientes($creditos['empresa_plan_id'], $servicio_ia->consume_creditos);","numLines":2},"sourceToolAssistantUUID":"3b3b917a-9d42-4527-a93b-96b27e563745"}
{"parentUuid":"e3cb89e7-9966-404f-b8cd-e361917eaefa","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DVnrWhaEDysnPBoNDzP5Ts","type":"message","role":"assistant","content":[{"type":"text","text":"Let me now look at the existing tests to understand patterns used."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":935,"cache_read_input_tokens":64521,"cache_creation":{"ephemeral_5m_input_tokens":935,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXLjN2WSqVXVkNwUrpSvg","type":"assistant","uuid":"de208730-578d-4b38-afdb-a72293a52cc3","timestamp":"2026-01-21T15:06:35.770Z"}
{"parentUuid":"de208730-578d-4b38-afdb-a72293a52cc3","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DVnrWhaEDysnPBoNDzP5Ts","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XimkdDJHmW21zMUwy7dL96","name":"Glob","input":{"pattern":"**/tests/**/*EmpresaPlan*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":935,"cache_read_input_tokens":64521,"cache_creation":{"ephemeral_5m_input_tokens":935,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXLjN2WSqVXVkNwUrpSvg","type":"assistant","uuid":"7b418bd0-3095-4841-b047-09ba075965ef","timestamp":"2026-01-21T15:06:36.340Z"}
{"parentUuid":"7b418bd0-3095-4841-b047-09ba075965ef","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DVnrWhaEDysnPBoNDzP5Ts","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XhURLjU7pSugWpdVsXKki6","name":"Grep","input":{"pattern":"renovar|creditos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\tests","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":935,"cache_read_input_tokens":64521,"cache_creation":{"ephemeral_5m_input_tokens":935,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXLjN2WSqVXVkNwUrpSvg","type":"assistant","uuid":"b7e01cf3-298a-46e4-8fd9-1bcc3b37557c","timestamp":"2026-01-21T15:06:37.023Z"}
{"parentUuid":"b7e01cf3-298a-46e4-8fd9-1bcc3b37557c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XhURLjU7pSugWpdVsXKki6","type":"tool_result","content":"No files found"}]},"uuid":"d9ba99db-d1f7-4cf5-8baf-925bbed17e92","timestamp":"2026-01-21T15:06:39.539Z","toolUseResult":{"mode":"files_with_matches","filenames":[],"numFiles":0},"sourceToolAssistantUUID":"b7e01cf3-298a-46e4-8fd9-1bcc3b37557c"}
{"parentUuid":"7b418bd0-3095-4841-b047-09ba075965ef","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XimkdDJHmW21zMUwy7dL96","type":"tool_result","content":"No files found"}]},"uuid":"03e87f00-8dac-4279-9bba-1e1bbacd4c3e","timestamp":"2026-01-21T15:06:39.894Z","toolUseResult":{"filenames":[],"durationMs":972,"numFiles":0,"truncated":false},"sourceToolAssistantUUID":"7b418bd0-3095-4841-b047-09ba075965ef"}
{"parentUuid":"03e87f00-8dac-4279-9bba-1e1bbacd4c3e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"64dc3533-c7a3-4886-beae-4b461db17532","version":"2.1.12","gitBranch":"pre-main","agentId":"a77a41d","slug":"floofy-imagining-stearns","message":{"model":"claude-opus-4-5-20251101","id":"msg_01T2HxD5RV1cU57vdU8DHNJY","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have enough information to design a comprehensive implementation plan. Let me summarize my findings and create the plan.\n\n## Analysis Summary\n\n### Current State\n\n1. **Plan Types**:\n   - **Normal Plans**: Have `plan_id`, `unidades`, `fecha_inicio`, `fecha_vencimiento`\n   - **Credit Plans**: Have `plan_credito_id`, `creditos` (may or may not have dates or `plan_id`)\n\n2. **Key Issue with Current `renovar()` method**:\n   - Line 256 in `verificarYAsignarTiempo()` assumes `$empresa_plan->plan->vigencia` exists\n   - If a plan is credit-only (no `plan_id`), this will fail with null pointer\n   - The method doesn't handle credit-specific logic for renewal\n\n3. **Current Command Logic (`ActivarEInactivarPlanesCommand`)**:\n   - `planVencido()` checks if dates have passed OR if units/offers are exhausted\n   - Does NOT consider credit exhaustion as a vencimiento condition\n   - `establecerFechasVigenciaPlanProximo()` only works with date-based plans\n\n4. **Credit Consumption Model**:\n   - `creditos_restantes` = `creditos - sum(consumos_creditos.creditos)`\n   - Credits are tracked in `consumos_creditos` table\n   - Credits are associated with `empresa_plan_id`\n\n### Design Decisions for Implementation\n\n**Question 1: When should a credit plan expire?**\n- When `creditos_restantes == 0` (all credits consumed)\n\n**Question 2: How to handle renewal when the current plan has credits but the new one has no dates?**\n- Credit plans should be activated immediately when the current plan's credits are exhausted\n- No date-based activation for pure credit plans\n\n**Question 3: Should the activation command consider remaining credits?**\n- Yes, for credit-only plans, exhaustion of credits triggers vencimiento and activates the next credit plan\n\n**Question 4: What about hybrid plans (normal plan + credits)?**\n- A plan is hybrid when it has both `plan_id` AND `plan_credito_id`\n- Hybrid plans follow normal plan rules (dates/units) but also have credits\n- Credits in hybrid plans are consumed independently but don't affect plan expiration\n\n---\n\n## Implementation Plan\n\n### Phase 1: Model Layer Enhancements\n\n**File: `app/Models/Empresas/EmpresaPlan.php`**\n\nAdd helper methods to identify plan types:\n\n```php\n/**\n * Determinar si es un plan solo de creditos (sin plan base).\n */\npublic function esSoloPlanCreditos(): bool {\n    return !is_null($this->plan_credito_id) && is_null($this->plan_id);\n}\n\n/**\n * Determinar si es un plan hibrido (plan base + creditos).\n */\npublic function esPlanHibrido(): bool {\n    return !is_null($this->plan_id) && !is_null($this->plan_credito_id);\n}\n\n/**\n * Determinar si tiene creditos (solo o hibrido).\n */\npublic function tieneCreditos(): bool {\n    return !is_null($this->plan_credito_id) || $this->creditos > 0;\n}\n\n/**\n * Verificar si los creditos estan agotados.\n */\npublic function creditosAgotados(): bool {\n    if (!$this->tieneCreditos()) {\n        return false;\n    }\n    return $this->creditos_restantes <= 0;\n}\n```\n\n### Phase 2: Service Layer - Renewal Logic\n\n**File: `app/Http/Services/Empresas/EmpresaPlanService.php`**\n\nModify the `renovar()` method:\n\n```php\npublic function renovar(int $id): EmpresaPlan {\n    $empresa_plan = $this->repositorio->getUno($id);\n\n    if ($empresa_plan->estado_id === 3) {\n        throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n    }\n\n    // Excluir campos que no deben copiarse\n    $campos_excluidos = [\n        'id', 'renovando', 'por_facturar', 'plan', 'estado', \n        'vigencia_dias', 'creditos_restantes'\n    ];\n    \n    $request = new Request(Arr::except($empresa_plan->toArray(), $campos_excluidos));\n    $request->merge(['por_facturar' => true]);\n\n    // Determinar el estado del nuevo plan\n    if (in_array($empresa_plan->estado_id, [1, 4])) {\n        // Activo o por vencer -> estado proximo\n        $request->merge(['estado_id' => 3]);\n    } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n        // Inactivo o vencido -> estado activo\n        $request->merge(['estado_id' => 1]);\n    }\n\n    // Manejar renovacion segun tipo de plan\n    if ($empresa_plan->esSoloPlanCreditos()) {\n        // Plan solo de creditos: no necesita fechas de vigencia\n        $this->prepararRenovacionPlanCreditos($empresa_plan, $request);\n    } else {\n        // Plan normal o hibrido: calcular fechas de vigencia\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n    }\n\n    $plan_renovado = $this->repositorio->crear($request->toArray());\n\n    // Sincronizar relaciones si existen\n    if ($empresa_plan->pruebas->isNotEmpty()) {\n        $this->repositorio->sincronizarPruebas(\n            $plan_renovado, \n            $empresa_plan->pruebas->pluck('id')->toArray()\n        );\n    }\n\n    if ($empresa_plan->funcionalidades->isNotEmpty()) {\n        $this->repositorio->sincronizarFuncionalidades(\n            $plan_renovado, \n            $empresa_plan->funcionalidades->pluck('id')->toArray()\n        );\n    }\n\n    return $plan_renovado;\n}\n\n/**\n * Preparar la renovacion de un plan de creditos.\n */\nprotected function prepararRenovacionPlanCreditos(EmpresaPlan $empresa_plan, Request &$request): void {\n    // Para planes de solo creditos, no establecer fechas\n    $request->merge([\n        'fecha_inicio'      => null,\n        'fecha_vencimiento' => null\n    ]);\n    \n    // Si el plan de creditos original tiene un plan_credito_id, \n    // obtener los creditos del plan de creditos\n    if ($empresa_plan->plan_credito_id) {\n        $plan_credito = $this->plan_credito_repositorio->getUno($empresa_plan->plan_credito_id);\n        if ($plan_credito) {\n            $request->merge(['creditos' => $plan_credito->creditos]);\n        }\n    }\n}\n```\n\nModify `verificarYAsignarTiempo()` to handle edge cases:\n\n```php\npublic function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n    // Solo calcular fechas si el plan tiene fecha de vencimiento y un plan base con vigencia\n    if (!is_null($empresa_plan->fecha_inicio) \n        && !is_null($empresa_plan->fecha_vencimiento)\n        && !is_null($empresa_plan->plan)\n        && !is_null($empresa_plan->plan->vigencia)\n    ) {\n        $request->merge(\n            $this->calcularFechasVigencia(\n                $empresa_plan->plan->vigencia, \n                $empresa_plan->fecha_vencimiento->addDay()\n            )\n        );\n    }\n}\n```\n\n### Phase 3: Command Layer - Activation/Deactivation Logic\n\n**File: `app/Console/Commands/Empresas/ActivarEInactivarPlanesCommand.php`**\n\nModify `planVencido()` to handle credit plans:\n\n```php\nprivate function planVencido(EmpresaPlan $empresa_plan): bool {\n    // Caso 1: Plan solo de creditos\n    if ($empresa_plan->esSoloPlanCreditos()) {\n        return $empresa_plan->creditosAgotados();\n    }\n    \n    // Caso 2: Plan con fecha de vencimiento\n    if (!is_null($empresa_plan->fecha_vencimiento)) {\n        $fecha_actual = now()->startOfDay();\n        return $empresa_plan->fecha_inicio > $fecha_actual \n            || $empresa_plan->fecha_vencimiento < $fecha_actual;\n    }\n    \n    // Caso 3: Plan por unidades (sin fecha)\n    return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas) \n        && (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n}\n```\n\nAdd new method to handle credit plan activation:\n\n```php\nprivate function activarPlanCreditoProximo(int $empresa_id, int $tipo_prueba_id): void {\n    // Buscar plan de creditos proximo\n    $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos($empresa_id, $tipo_prueba_id);\n    \n    if (!is_null($plan_proximo)) {\n        $this->empresa_plan_repositorio->actualizar(\n            $plan_proximo->id, \n            ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n        );\n    }\n}\n```\n\nModify `establecerPlanProximoAVencer()` to handle credit plans:\n\n```php\nprivate function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n    // Para planes de solo creditos\n    if ($empresa_plan->esSoloPlanCreditos()) {\n        $total_creditos = $empresa_plan->creditos;\n        $creditos_consumidos = $total_creditos - $empresa_plan->creditos_restantes;\n        \n        if ($total_creditos > 0) {\n            $porcentaje_consumido = ($creditos_consumidos / $total_creditos) * 100;\n            \n            if ($porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER \n                && $empresa_plan->creditos_restantes > 0\n            ) {\n                $this->empresa_plan_repositorio->actualizar(\n                    $empresa_plan->id, \n                    ['estado_id' => Plan::ESTADO_POR_VENCER_ID]\n                );\n            }\n        }\n        return;\n    }\n    \n    // Logica existente para planes normales...\n    // (codigo actual sin cambios)\n}\n```\n\n### Phase 4: Repository Layer\n\n**File: `app/Http/Repositories/Empresas/EmpresaPlanRepository.php`**\n\nAdd new method for finding next credit plan:\n\n```php\n/**\n * Obtener el proximo plan de creditos de la empresa.\n *\n * @param int $empresa_id ID de la empresa.\n * @param int $tipo_prueba_id ID del tipo de prueba.\n * @return EmpresaPlan|null\n */\npublic function planProximoCreditos(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n    return $this->modelo::select(\n        'id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', \n        'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', \n        'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', \n        'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', \n        'plan_original', 'renovando', 'por_facturar', 'created_at'\n    )\n    ->with([\n        'plan:id,tipo_prueba_id,nombre',\n        'planCredito:id,nombre,creditos,precio',\n        'estado:id,nombre'\n    ])\n    ->where([\n        'empresa_id' => $empresa_id,\n        'estado_id'  => 3 // Estado proximo\n    ])\n    ->whereNotNull('plan_credito_id')\n    ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n        // Solo filtrar por tipo_prueba si hay plan_id\n        $query->where(function ($q) use ($tipo_prueba_id) {\n            $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n              ->orWhereNull('plan_id');\n        });\n    })\n    ->orderBy('created_at', 'ASC')\n    ->first();\n}\n\n/**\n * Obtener el plan de creditos activo de la empresa.\n *\n * @param int $empresa_id ID de la empresa.\n * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n * @return EmpresaPlan|null\n */\npublic function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n    return $this->modelo::select(\n        'id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id',\n        'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at'\n    )\n    ->with(['planCredito:id,nombre,creditos,precio'])\n    ->where('empresa_id', $empresa_id)\n    ->whereNotNull('plan_credito_id')\n    ->whereIn('estado_id', [1, 4]) // Activo o por vencer\n    ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n        $query->where(function ($q) use ($tipo_prueba_id) {\n            $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n              ->orWhereNull('plan_id');\n        });\n    })\n    ->first();\n}\n```\n\n### Phase 5: Update Command's `handle()` Method\n\nModify the main loop to include credit plan handling:\n\n```php\npublic function handle() {\n    $empresa_id   = $this->argument('empresa_id');\n    $fecha_actual = now()->startOfDay();\n    $request      = new Request([\n        'estados_ids'     => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n        'ordenar_por'     => 'created_at',\n        'ordenar_sentido' => 'ASC'\n    ]);\n\n    if (!is_null($empresa_id)) {\n        $request->merge(['empresa_id' => $empresa_id]);\n    }\n\n    // Obtener los planes de empresas y agruparlos por tipo de prueba.\n    $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n\n    try {\n        DB::beginTransaction();\n\n        foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n            foreach ($planes as $plan) {\n                $empresa_id = $plan->empresa_id;\n\n                if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                    if ($this->planVencido($plan)) {\n                        // Desactivar el plan si ya ha vencido\n                        $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n                        \n                        // Si es plan de creditos, activar el proximo plan de creditos\n                        if ($plan->esSoloPlanCreditos() || $plan->esPlanHibrido()) {\n                            $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n                        }\n                    } else {\n                        $this->establecerPlanProximoAVencer($plan);\n                        \n                        // Solo establecer fechas de vigencia para planes con fechas\n                        if (!$plan->esSoloPlanCreditos()) {\n                            $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                        }\n                    }\n                } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n                    // Para planes de creditos sin fecha, activar si no hay plan activo\n                    if ($plan->esSoloPlanCreditos()) {\n                        $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id, $tipo_prueba_id);\n                        \n                        if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                        }\n                    } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                        // Logica existente para planes con fecha\n                        $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                        if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                            continue;\n                        }\n\n                        $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                    }\n                }\n            }\n        }\n\n        DB::commit();\n        $this->info('Planes de empresas actualizados correctamente');\n    } catch (Exception $error) {\n        DB::rollBack();\n        $this->error('Error al actualizar los planes de empresas: ' . $error->getMessage());\n    }\n}\n```\n\n### Phase 6: Update `getDatosBasicos()` in Repository\n\nEnsure the query loads the `planCredito` relationship and calculates credits:\n\n```php\npublic function getDatosBasicos(Request $request): Collection {\n    return $this->modelo::select(\n        'id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', \n        'unidades', 'cantidad_ofertas_laborales', 'creditos', \n        'fecha_inicio', 'fecha_vencimiento', 'created_at'\n    )\n    ->with([\n        'plan:id,tipo_prueba_id,nombre',\n        'planCredito:id,nombre,creditos' // Agregar esta linea\n    ])\n    ->withCount([\n        'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n        'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n    ])\n    // ... resto del codigo existente\n}\n```\n\n---\n\n## Summary of Changes\n\n| File | Changes |\n|------|---------|\n| `EmpresaPlan.php` (Model) | Add `esSoloPlanCreditos()`, `esPlanHibrido()`, `tieneCreditos()`, `creditosAgotados()` |\n| `EmpresaPlanService.php` | Modify `renovar()`, `verificarYAsignarTiempo()`, add `prepararRenovacionPlanCreditos()` |\n| `EmpresaPlanRepository.php` | Add `planProximoCreditos()`, `planCreditosActivo()`, update `getDatosBasicos()` |\n| `ActivarEInactivarPlanesCommand.php` | Modify `planVencido()`, `establecerPlanProximoAVencer()`, `handle()`, add `activarPlanCreditoProximo()` |\n\n---\n\n### Critical Files for Implementation\n\n- **C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php** - Add helper methods for plan type detection\n- **C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php** - Modify renewal logic to handle credit plans\n- **C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php** - Add repository methods for credit plan queries\n- **C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php** - Update activation/deactivation logic for credit plans\n- **C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php** - Reference for state constants (ESTADO_ACTIVO_ID, etc.)"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":34,"cache_creation_input_tokens":244,"cache_read_input_tokens":65456,"cache_creation":{"ephemeral_5m_input_tokens":244,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXLjNY3DAPy9PseomDTU8","type":"assistant","uuid":"62b45d61-5958-4b54-8ddb-0273caa5db4f","timestamp":"2026-01-21T15:07:51.172Z"}
