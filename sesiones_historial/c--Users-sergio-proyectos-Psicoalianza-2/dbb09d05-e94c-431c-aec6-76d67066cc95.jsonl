{"type":"file-history-snapshot","messageId":"4d5bb573-a4a4-497b-91aa-e63f8223aca1","snapshot":{"messageId":"4d5bb573-a4a4-497b-91aa-e63f8223aca1","trackedFileBackups":{},"timestamp":"2026-02-16T16:43:28.334Z"},"isSnapshotUpdate":false}
{"parentUuid":"58d35dbd-681f-4635-9405-739e3ea5d0da","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"c01649eb-9ca2-4332-8f40-c3f4e89c1e76","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"user","message":{"role":"user","content":[{"type":"text","text":"[Request interrupted by user for tool use]"}]},"uuid":"57620147-e32e-4706-83e4-897910b70c69","timestamp":"2026-02-16T16:43:28.219Z"}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"user","message":{"role":"user","content":"Implement the following plan:\n\n# Fix: Error 500 al reagendar participantes (`empresa_id: undefined`)\n\n## Contexto\n\nAl hacer clic en \"Reagendar\" en el formulario `#formulario-reagendar`, se envía `empresa_id: undefined` en el payload POST a `/participantes-reagendar`. Esto causa un `TypeError` porque `ConfiguracionModeloService::obtenerConfiguracion()` espera un `int` como segundo argumento y recibe el string `\"undefined\"`.\n\n**Causa raíz:** La variable `dato_empresa` se inicializa como array vacío (`[]`) y solo se popula cuando se carga la tabla de participantes via DataTables. Si el flujo de usuario no pasa por esa carga, `dato_empresa.id` es `undefined`. Sin embargo, la variable global `PROCESO` ya contiene `empresa_id` y siempre está disponible.\n\n## Cambios\n\n### 1. Frontend - Usar `PROCESO.empresa_id` en lugar de `dato_empresa?.id`\n\n**`public/src/procesos/js/detalle.js` (linea 360):**\n```js\n// Antes:\nDATOS.append('empresa_id', dato_empresa?.id);\n\n// Después:\nDATOS.append('empresa_id', PROCESO.empresa_id);\n```\n\n**`public/js/procesos/detalle.js` (linea 1236):**\n```js\n// Antes:\nDATOS.append('empresa_id', dato_empresa.id);\n\n// Después:\nDATOS.append('empresa_id', PROCESO.empresa_id);\n```\n\n### 2. Backend - Agregar validacion de `empresa_id` en el FormRequest\n\n**`app/Http/Requests/Procesos/ReagendarParticipantesRequest.php`:**\n\nAgregar regla de validacion para `empresa_id`:\n```php\n'empresa_id' => 'required|integer',\n```\n\n### 3. Backend - Cast defensivo en el servicio\n\n**`app/Http/Services/Procesos/ProcesoService.php` (linea 666):**\n```php\n// Antes:\n$configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);\n\n// Después:\n$configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, (int) $request->empresa_id, 45);\n```\n\n## Archivos a modificar\n\n1. `public/src/procesos/js/detalle.js` - Linea 360\n2. `public/js/procesos/detalle.js` - Linea 1236\n3. `app/Http/Requests/Procesos/ReagendarParticipantesRequest.php` - Agregar regla\n4. `app/Http/Services/Procesos/ProcesoService.php` - Linea 666\n\n## Verificacion\n\n1. Abrir un proceso con participantes\n2. Seleccionar un participante y abrir el modal de reagendar\n3. Completar el formulario y hacer clic en \"Reagendar\"\n4. Verificar que el payload incluye `empresa_id` con un valor numerico valido\n5. Verificar que la respuesta es 200 y no 500\n\n\nIf you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: C:\\Users\\sergio\\.claude\\projects\\C--Users-sergio-proyectos-Psicoalianza-2\\c01649eb-9ca2-4332-8f40-c3f4e89c1e76.jsonl"},"uuid":"4d5bb573-a4a4-497b-91aa-e63f8223aca1","timestamp":"2026-02-16T16:43:28.217Z","planContent":"# Fix: Error 500 al reagendar participantes (`empresa_id: undefined`)\n\n## Contexto\n\nAl hacer clic en \"Reagendar\" en el formulario `#formulario-reagendar`, se envía `empresa_id: undefined` en el payload POST a `/participantes-reagendar`. Esto causa un `TypeError` porque `ConfiguracionModeloService::obtenerConfiguracion()` espera un `int` como segundo argumento y recibe el string `\"undefined\"`.\n\n**Causa raíz:** La variable `dato_empresa` se inicializa como array vacío (`[]`) y solo se popula cuando se carga la tabla de participantes via DataTables. Si el flujo de usuario no pasa por esa carga, `dato_empresa.id` es `undefined`. Sin embargo, la variable global `PROCESO` ya contiene `empresa_id` y siempre está disponible.\n\n## Cambios\n\n### 1. Frontend - Usar `PROCESO.empresa_id` en lugar de `dato_empresa?.id`\n\n**`public/src/procesos/js/detalle.js` (linea 360):**\n```js\n// Antes:\nDATOS.append('empresa_id', dato_empresa?.id);\n\n// Después:\nDATOS.append('empresa_id', PROCESO.empresa_id);\n```\n\n**`public/js/procesos/detalle.js` (linea 1236):**\n```js\n// Antes:\nDATOS.append('empresa_id', dato_empresa.id);\n\n// Después:\nDATOS.append('empresa_id', PROCESO.empresa_id);\n```\n\n### 2. Backend - Agregar validacion de `empresa_id` en el FormRequest\n\n**`app/Http/Requests/Procesos/ReagendarParticipantesRequest.php`:**\n\nAgregar regla de validacion para `empresa_id`:\n```php\n'empresa_id' => 'required|integer',\n```\n\n### 3. Backend - Cast defensivo en el servicio\n\n**`app/Http/Services/Procesos/ProcesoService.php` (linea 666):**\n```php\n// Antes:\n$configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);\n\n// Después:\n$configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, (int) $request->empresa_id, 45);\n```\n\n## Archivos a modificar\n\n1. `public/src/procesos/js/detalle.js` - Linea 360\n2. `public/js/procesos/detalle.js` - Linea 1236\n3. `app/Http/Requests/Procesos/ReagendarParticipantesRequest.php` - Agregar regla\n4. `app/Http/Services/Procesos/ProcesoService.php` - Linea 666\n\n## Verificacion\n\n1. Abrir un proceso con participantes\n2. Seleccionar un participante y abrir el modal de reagendar\n3. Completar el formulario y hacer clic en \"Reagendar\"\n4. Verificar que el payload incluye `empresa_id` con un valor numerico valido\n5. Verificar que la respuesta es 200 y no 500\n"}
{"parentUuid":"4d5bb573-a4a4-497b-91aa-e63f8223aca1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LhAEMvxTePVPN9B7AjCfj5","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9113,"cache_read_input_tokens":16753,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":9113},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5nYEnych57nCLfbVVm","type":"assistant","uuid":"2f0c1790-394e-4968-9e6f-2a42ccf851e1","timestamp":"2026-02-16T16:43:30.798Z"}
{"parentUuid":"2f0c1790-394e-4968-9e6f-2a42ccf851e1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LhAEMvxTePVPN9B7AjCfj5","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me implement the plan to fix the Error 500 when rescheduling participants. I need to modify 4 files. Let me read them first.","signature":"EqkCCkYICxgCKkBt+DUoyUV2skkow8PsxCrmc7ZFowiuVY49LcAMlovh74j+T9Avlevm7GzFKof9n2xUJ7WUBY6DWrSmpiI8OClBEgwS0mxvb+3NDyBTDIcaDCGpDhAotZYUyFzuKiIw9w4gjqTiXuKA8d3tIP1kQd1pHjdPUYa1zZOy+NLVzPLfBgclvBpqhhHZ3NW2MMXOKpABPZYga97juSA8++KRCmzc360r8f7R1chbIa0qq61sBe22FTopJuzFxRSgUKGMf0uE2+VOG0Gpge3P2ItTz8I5xIoP5+BX4aGZtOq+CYpl9RPNf41j2SCLpcBnTJEt4vQ3KQdR52XDfxD6QyuEDZ2nPwp4bFJKg/ftjiZeENxZVWQVDqAeMa1FG5Sc6BJEQgEmGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9113,"cache_read_input_tokens":16753,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":9113},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5nYEnych57nCLfbVVm","type":"assistant","uuid":"9b528f81-7b79-4765-a840-d688bed64eee","timestamp":"2026-02-16T16:43:31.606Z"}
{"parentUuid":"9b528f81-7b79-4765-a840-d688bed64eee","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LhAEMvxTePVPN9B7AjCfj5","type":"message","role":"assistant","content":[{"type":"text","text":"I'll implement the fix. Let me read all 4 files in parallel first."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9113,"cache_read_input_tokens":16753,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":9113},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5nYEnych57nCLfbVVm","type":"assistant","uuid":"643b1a21-f25f-4f4a-ad7a-2d28dc1a67ac","timestamp":"2026-02-16T16:43:32.318Z"}
{"parentUuid":"643b1a21-f25f-4f4a-ad7a-2d28dc1a67ac","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LhAEMvxTePVPN9B7AjCfj5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YT84srj5VCBtiHSkypyz7y","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\src\\procesos\\js\\detalle.js","offset":350,"limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9113,"cache_read_input_tokens":16753,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":9113},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5nYEnych57nCLfbVVm","type":"assistant","uuid":"5af1bea3-d563-4e6c-92fc-bdc4239c1483","timestamp":"2026-02-16T16:43:33.404Z"}
{"parentUuid":"5af1bea3-d563-4e6c-92fc-bdc4239c1483","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01YT84srj5VCBtiHSkypyz7y","toolUseID":"toolu_01YT84srj5VCBtiHSkypyz7y","timestamp":"2026-02-16T16:43:33.409Z","uuid":"502459c9-e315-4031-8ba7-201602e2283a"}
{"parentUuid":"5af1bea3-d563-4e6c-92fc-bdc4239c1483","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YT84srj5VCBtiHSkypyz7y","type":"tool_result","content":"   350→\n   351→    DATOS.append('capturar_camara', $('#capturar_camara_reenviar').prop('checked') ? 1 : 0);\n   352→    DATOS.append('capturar_video', $('#capturar_video_reenviar').prop('checked') ? 1 : 0);\n   353→\n   354→    if (ID !== null && participantes_seleccionados.length === 0) {\n   355→        participantes_seleccionados = [ID];\n   356→    }\n   357→\n   358→    DATOS.append('participantes', JSON.stringify(participantes_seleccionados));\n   359→    DATOS.append('pruebas', JSON.stringify($('#pruebas_reenviar').val()));\n   360→    DATOS.append('empresa_id', dato_empresa?.id);\n   361→\n   362→    await $.ajax({\n   363→        url        : `/participantes-reagendar`,\n   364→        type       : 'POST',\n   365→        data       : DATOS,\n   366→        contentType: false,\n   367→        processData: false\n   368→    }).done(function (respuesta) {\n   369→        limpiarFormularioReenviarAgendamiento();"}]},"uuid":"67952114-ecac-41a8-ae2a-8b98fd281a0d","timestamp":"2026-02-16T16:43:33.408Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\src\\procesos\\js\\detalle.js","content":"\n    DATOS.append('capturar_camara', $('#capturar_camara_reenviar').prop('checked') ? 1 : 0);\n    DATOS.append('capturar_video', $('#capturar_video_reenviar').prop('checked') ? 1 : 0);\n\n    if (ID !== null && participantes_seleccionados.length === 0) {\n        participantes_seleccionados = [ID];\n    }\n\n    DATOS.append('participantes', JSON.stringify(participantes_seleccionados));\n    DATOS.append('pruebas', JSON.stringify($('#pruebas_reenviar').val()));\n    DATOS.append('empresa_id', dato_empresa?.id);\n\n    await $.ajax({\n        url        : `/participantes-reagendar`,\n        type       : 'POST',\n        data       : DATOS,\n        contentType: false,\n        processData: false\n    }).done(function (respuesta) {\n        limpiarFormularioReenviarAgendamiento();","numLines":20,"startLine":350,"totalLines":700}},"sourceToolAssistantUUID":"5af1bea3-d563-4e6c-92fc-bdc4239c1483"}
{"parentUuid":"67952114-ecac-41a8-ae2a-8b98fd281a0d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LhAEMvxTePVPN9B7AjCfj5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0139AMwA4H1HyBADGEPzHRPw","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\procesos\\detalle.js","offset":1226,"limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9113,"cache_read_input_tokens":16753,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":9113},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5nYEnych57nCLfbVVm","type":"assistant","uuid":"1c60d527-f8f9-48dd-b431-7ff235654af9","timestamp":"2026-02-16T16:43:34.136Z"}
{"parentUuid":"1c60d527-f8f9-48dd-b431-7ff235654af9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_0139AMwA4H1HyBADGEPzHRPw","toolUseID":"toolu_0139AMwA4H1HyBADGEPzHRPw","timestamp":"2026-02-16T16:43:34.140Z","uuid":"ef9768f5-5bed-489b-85de-d6613f90c1cf"}
{"parentUuid":"1c60d527-f8f9-48dd-b431-7ff235654af9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0139AMwA4H1HyBADGEPzHRPw","type":"tool_result","content":"  1226→        window[nombre_tabla_participantes + '_seleccionados'] = [{id: ID}];\n  1227→    }\n  1228→\n  1229→    DATOS.append('participantes', JSON.stringify(window[nombre_tabla_participantes + '_seleccionados'].map(objeto => objeto.id)));\n  1230→    if (pruebas_seleccionadas.length === 0) {\n  1231→        $('.prueba_seleccionar_reenvio').addClass('invalid');\n  1232→        mostrarToast('danger', 'Debe seleccionar al menos una prueba.');\n  1233→        return;\n  1234→    }\n  1235→    DATOS.append('pruebas', JSON.stringify(pruebas_seleccionadas));\n  1236→    DATOS.append('empresa_id', dato_empresa.id);\n  1237→\n  1238→    await $.ajax({\n  1239→        url        : `/participantes-reagendar`,\n  1240→        type       : 'POST',\n  1241→        data       : DATOS,\n  1242→        contentType: false,\n  1243→        processData: false\n  1244→    }).done(function (respuesta) {\n  1245→        if ($('#participantes-tap').hasClass('active')) {"}]},"uuid":"75446163-e703-4262-b429-4320139db2e4","timestamp":"2026-02-16T16:43:34.139Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\procesos\\detalle.js","content":"        window[nombre_tabla_participantes + '_seleccionados'] = [{id: ID}];\n    }\n\n    DATOS.append('participantes', JSON.stringify(window[nombre_tabla_participantes + '_seleccionados'].map(objeto => objeto.id)));\n    if (pruebas_seleccionadas.length === 0) {\n        $('.prueba_seleccionar_reenvio').addClass('invalid');\n        mostrarToast('danger', 'Debe seleccionar al menos una prueba.');\n        return;\n    }\n    DATOS.append('pruebas', JSON.stringify(pruebas_seleccionadas));\n    DATOS.append('empresa_id', dato_empresa.id);\n\n    await $.ajax({\n        url        : `/participantes-reagendar`,\n        type       : 'POST',\n        data       : DATOS,\n        contentType: false,\n        processData: false\n    }).done(function (respuesta) {\n        if ($('#participantes-tap').hasClass('active')) {","numLines":20,"startLine":1226,"totalLines":2446}},"sourceToolAssistantUUID":"1c60d527-f8f9-48dd-b431-7ff235654af9"}
{"parentUuid":"75446163-e703-4262-b429-4320139db2e4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LhAEMvxTePVPN9B7AjCfj5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YGQ3dEJnAEWDPbfVo5U6Ki","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Requests\\Procesos\\ReagendarParticipantesRequest.php"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9113,"cache_read_input_tokens":16753,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":9113},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5nYEnych57nCLfbVVm","type":"assistant","uuid":"378aa76c-d426-4725-9633-912148cd811b","timestamp":"2026-02-16T16:43:34.687Z"}
{"parentUuid":"378aa76c-d426-4725-9633-912148cd811b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01YGQ3dEJnAEWDPbfVo5U6Ki","toolUseID":"toolu_01YGQ3dEJnAEWDPbfVo5U6Ki","timestamp":"2026-02-16T16:43:34.691Z","uuid":"a3511a9f-a3ef-4850-b496-dbdb80bcc97a"}
{"parentUuid":"378aa76c-d426-4725-9633-912148cd811b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YGQ3dEJnAEWDPbfVo5U6Ki","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Requests\\Procesos;\n     4→\n     5→use Illuminate\\Foundation\\Http\\FormRequest;\n     6→\n     7→class ReagendarParticipantesRequest extends FormRequest\n     8→{\n     9→    /**\n    10→     * Determine if the user is authorized to make this request.\n    11→     */\n    12→    public function authorize(): bool\n    13→    {\n    14→        return true;\n    15→    }\n    16→\n    17→    /**\n    18→     * Preparar datos para la validación.\n    19→     *\n    20→     * @return void\n    21→     * @author Daniel Beltrán\n    22→     */\n    23→    public function prepareForValidation(): void {\n    24→        $this->merge([\n    25→            'pruebas'       => json_decode($this->pruebas),\n    26→            'participantes' => json_decode($this->participantes)\n    27→        ]);\n    28→    }\n    29→\n    30→    /**\n    31→     * Get the validation rules that apply to the request.\n    32→     *\n    33→     * @return array<string, \\Illuminate\\Contracts\\Validation\\ValidationRule|array<mixed>|string>\n    34→     */\n    35→    public function rules(): array\n    36→    {\n    37→        $reglas = [\n    38→            'proceso_id'      => 'required|integer',\n    39→            'email'           => 'nullable|email|max:100',\n    40→            'pruebas'         => 'required|array|min:1',\n    41→            'pruebas.*'       => 'required|integer',\n    42→            'participantes'   => 'required|array|min:1',\n    43→            'participantes.*' => 'required|integer',\n    44→            'capturar_camara' => 'nullable|boolean',\n    45→            'capturar_video'  => 'nullable|boolean'\n    46→        ];\n    47→\n    48→        if (!isset($this->dias_vencimiento_agendas)) {\n    49→            $reglas['fecha_vencimiento_agendas'] = 'required|date';\n    50→        } elseif (!isset($this->fecha_vencimiento_agendas)) {\n    51→            $reglas['dias_vencimiento_agendas'] = 'required|integer|min:1';\n    52→        }\n    53→\n    54→        return $reglas;\n    55→    }\n    56→}\n    57→"}]},"uuid":"66fd82f4-7413-46e0-bee4-af4c61912b27","timestamp":"2026-02-16T16:43:34.691Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Requests\\Procesos\\ReagendarParticipantesRequest.php","content":"<?php\n\nnamespace App\\Http\\Requests\\Procesos;\n\nuse Illuminate\\Foundation\\Http\\FormRequest;\n\nclass ReagendarParticipantesRequest extends FormRequest\n{\n    /**\n     * Determine if the user is authorized to make this request.\n     */\n    public function authorize(): bool\n    {\n        return true;\n    }\n\n    /**\n     * Preparar datos para la validación.\n     *\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function prepareForValidation(): void {\n        $this->merge([\n            'pruebas'       => json_decode($this->pruebas),\n            'participantes' => json_decode($this->participantes)\n        ]);\n    }\n\n    /**\n     * Get the validation rules that apply to the request.\n     *\n     * @return array<string, \\Illuminate\\Contracts\\Validation\\ValidationRule|array<mixed>|string>\n     */\n    public function rules(): array\n    {\n        $reglas = [\n            'proceso_id'      => 'required|integer',\n            'email'           => 'nullable|email|max:100',\n            'pruebas'         => 'required|array|min:1',\n            'pruebas.*'       => 'required|integer',\n            'participantes'   => 'required|array|min:1',\n            'participantes.*' => 'required|integer',\n            'capturar_camara' => 'nullable|boolean',\n            'capturar_video'  => 'nullable|boolean'\n        ];\n\n        if (!isset($this->dias_vencimiento_agendas)) {\n            $reglas['fecha_vencimiento_agendas'] = 'required|date';\n        } elseif (!isset($this->fecha_vencimiento_agendas)) {\n            $reglas['dias_vencimiento_agendas'] = 'required|integer|min:1';\n        }\n\n        return $reglas;\n    }\n}\n","numLines":57,"startLine":1,"totalLines":57}},"sourceToolAssistantUUID":"378aa76c-d426-4725-9633-912148cd811b"}
{"parentUuid":"66fd82f4-7413-46e0-bee4-af4c61912b27","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LhAEMvxTePVPN9B7AjCfj5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017qSzmSTtgQQRqHzoLVW5Rz","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php","offset":656,"limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9113,"cache_read_input_tokens":16753,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":9113},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5nYEnych57nCLfbVVm","type":"assistant","uuid":"198ac551-dabd-4335-9475-5c46ba766eb3","timestamp":"2026-02-16T16:43:35.488Z"}
{"parentUuid":"198ac551-dabd-4335-9475-5c46ba766eb3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_017qSzmSTtgQQRqHzoLVW5Rz","toolUseID":"toolu_017qSzmSTtgQQRqHzoLVW5Rz","timestamp":"2026-02-16T16:43:35.496Z","uuid":"0c531df1-9bfd-4bbb-866b-a6c311d97c2f"}
{"parentUuid":"198ac551-dabd-4335-9475-5c46ba766eb3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017qSzmSTtgQQRqHzoLVW5Rz","type":"tool_result","content":"   656→\n   657→        $resultado = [\n   658→            'agendas_reagendadas'       => 0,\n   659→            'agendas_reprogramadas'     => 0,\n   660→            'agendas_omitidas'          => 0,\n   661→            'participantes_notificados' => 0,\n   662→            'limite_agendas'            => 0,\n   663→            'mensajes_limite'           => []\n   664→        ];\n   665→\n   666→        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);\n   667→\n   668→        foreach ($request->participantes as $participante_id) {\n   669→            $usuario                       = $this->usuario_repositorio->getUno($participante_id);\n   670→            $agendas_usuario_reagendadas   = 0;\n   671→            $agendas_usuario_reprogramadas = 0;\n   672→            $agendas_usuario_omitidas      = 0;\n   673→\n   674→            if ($request->filled('email')) {\n   675→                $usuario->email = $request->email;"}]},"uuid":"acb657ce-ba4a-41f2-ac84-3b0d78320c36","timestamp":"2026-02-16T16:43:35.495Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php","content":"\n        $resultado = [\n            'agendas_reagendadas'       => 0,\n            'agendas_reprogramadas'     => 0,\n            'agendas_omitidas'          => 0,\n            'participantes_notificados' => 0,\n            'limite_agendas'            => 0,\n            'mensajes_limite'           => []\n        ];\n\n        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);\n\n        foreach ($request->participantes as $participante_id) {\n            $usuario                       = $this->usuario_repositorio->getUno($participante_id);\n            $agendas_usuario_reagendadas   = 0;\n            $agendas_usuario_reprogramadas = 0;\n            $agendas_usuario_omitidas      = 0;\n\n            if ($request->filled('email')) {\n                $usuario->email = $request->email;","numLines":20,"startLine":656,"totalLines":1483}},"sourceToolAssistantUUID":"198ac551-dabd-4335-9475-5c46ba766eb3"}
{"parentUuid":"acb657ce-ba4a-41f2-ac84-3b0d78320c36","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LQFaCMcnxRwZaFRmtR3ZF6","type":"message","role":"assistant","content":[{"type":"text","text":"All files read. Now I'll apply all 4 changes in parallel."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2338,"cache_read_input_tokens":25866,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2338},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5o43RmRzNDVs6V5w9i","type":"assistant","uuid":"fb450901-50b6-4471-a653-6d48bad69c3c","timestamp":"2026-02-16T16:43:38.327Z"}
{"parentUuid":"fb450901-50b6-4471-a653-6d48bad69c3c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LQFaCMcnxRwZaFRmtR3ZF6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CsFpjvkQbwdA4DeDSMii6E","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\src\\procesos\\js\\detalle.js","old_string":"    DATOS.append('empresa_id', dato_empresa?.id);","new_string":"    DATOS.append('empresa_id', PROCESO.empresa_id);"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2338,"cache_read_input_tokens":25866,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2338},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5o43RmRzNDVs6V5w9i","type":"assistant","uuid":"2e1f9b66-b2e6-44e2-834b-f11b83ad3ce4","timestamp":"2026-02-16T16:43:39.384Z"}
{"type":"file-history-snapshot","messageId":"2e1f9b66-b2e6-44e2-834b-f11b83ad3ce4","snapshot":{"messageId":"4d5bb573-a4a4-497b-91aa-e63f8223aca1","trackedFileBackups":{"public\\src\\procesos\\js\\detalle.js":{"backupFileName":"5582b62cf6d471d9@v1","version":1,"backupTime":"2026-02-16T16:43:39.435Z"}},"timestamp":"2026-02-16T16:43:28.334Z"},"isSnapshotUpdate":true}
{"parentUuid":"2e1f9b66-b2e6-44e2-834b-f11b83ad3ce4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01CsFpjvkQbwdA4DeDSMii6E","toolUseID":"toolu_01CsFpjvkQbwdA4DeDSMii6E","timestamp":"2026-02-16T16:43:39.442Z","uuid":"493f48f1-0d30-459f-b902-68be84a182c1"}
{"parentUuid":"2e1f9b66-b2e6-44e2-834b-f11b83ad3ce4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CsFpjvkQbwdA4DeDSMii6E","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\src\\procesos\\js\\detalle.js has been updated successfully."}]},"uuid":"4974719f-3b29-473c-b29e-b9d81927e414","timestamp":"2026-02-16T16:43:39.441Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\src\\procesos\\js\\detalle.js","oldString":"    DATOS.append('empresa_id', dato_empresa?.id);","newString":"    DATOS.append('empresa_id', PROCESO.empresa_id);","originalFile":"let participantes_seleccionados = [];\n\n$(document).ready(function() {\n    cargarListadoParticipantes();\n    inicializarSelect2Asincrono('proceso_id', 'procesos-listado', 'nombre', { id: 'id', nombre: 'nombre'}, false, {\n        empresa_id: PROCESO.empresa_id,\n        excluir_id: PROCESO.id\n    });\n});\n\n/**\n * Cargar el listado de participantes del proceso.\n *\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n */\nasync function cargarListadoParticipantes() {\n    let participantes = await obtenerParticipantes();\n\n    $('#listado-participantes').html('');\n\n    participantes.forEach(participante => {\n        const NOMBRE_PARTICIPANTE = participante.nombre_completo.trim() === '' ? 'Nombre sin asignar' : participante.nombre_completo;\n        let dato_telefono         = '';\n        let tarjetas_pruebas      = '';\n        const DESCARTADO          = participante.etapa_usuario?.etapa_id === 11;\n        let opciones_tarjeta      = `\n            <button type=\"button\" class=\"btn btn-outline-primary btn-circle me-2\" title=\"Reenviar agendamiento\" onclick=\"abrirModalReenviarAgendamiento(${participante.id}, '${participante.email}')\">\n                <i class=\"bi bi-envelope-arrow-down\"></i>\n            </button>\n            <button type=\"button\" class=\"btn btn-outline-danger btn-circle me-2\" title=\"Descartar\" onclick=\"descartarParticipantes(${participante.id})\">\n                <i class=\"bi bi-person-x\"></i>\n            </button>\n        `;\n\n        let opciones_dropdown     = `\n            <a href=\"/procesos/1\" class=\"dropdown-item no-visited pointer py-2\">Compartir acceso</a>\n            <button type=\"button\" class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirDetalleParticipante(${participante.id})\">Ver detalle</button>\n            <button type=\"button\" class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirModalMoverDeProceso(${participante.id})\">Mover a otros procesos</button>\n            <button type=\"button\" class=\"dropdown-item no-visited pointer py-2 text-danger\" onclick=\"eliminarParticipante(${participante.id})\">Eliminar</button>\n        `;\n\n        if (DESCARTADO) {\n            opciones_tarjeta  = '';\n            opciones_dropdown = `\n                <button type=\"button\" class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirModalMoverDeProceso(${participante.id})\">Mover a otros procesos</button>\n                <button type=\"button\" class=\"dropdown-item no-visited pointer py-2 text-danger\" onclick=\"eliminarParticipante(${participante.id})\">Eliminar</button>\n            `;\n        }\n\n        if (![null, undefined, ''].includes(participante.telefono)) {\n            dato_telefono = `<span class=\"card-text\">\n                <i class=\"bi bi-telephone\"></i> ${participante.telefono}\n            </span>`;\n        }\n\n        participante.agendas.forEach(agenda => {\n            tarjetas_pruebas += `<div class=\"card d-inline-block tarjeta-prueba mt-2 me-2\" onmouseover=\"mostrarTooltip(this)\" onmouseout=\"ocultarTooltip(this)\">\n                <div class=\"card-body\">\n                    <img src=\"/imagenes/logos/pruebas/${agenda.prueba.slug}.png\" class=\"img-fluid\" alt=\"Logo de prueba\">\n\n                    <div class=\"d-inline-flex align-items-center\">\n                        <span class=\"text-body-3 ms-1\">${agenda.estado.nombre}</span>\n                    </div>\n                </div>\n\n                <div class=\"tooltip-x tooltip-x-bottom text-start\">\n                    <span class=\"d-block\">Agendamiento: ${agenda.fecha_inicio}</span>\n                    <span class=\"d-block\">Aplicación: ${agenda.fecha_procesamiento || ''}</span>\n                </div>\n            </div>`;\n        });\n\n        $('#listado-participantes').append(`\n            <div class=\"card mt-2\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-2\">\n                            <span class=\"badge bg-secondary w-100\">C - ${participante.id}</span>\n                            <input type=\"checkbox\" class=\"form-check-input\" id=\"participante-${participante.id}\" onclick=\"seleccionarParticipante(${participante.id})\">\n                        </div>\n\n                        <div class=\"col-10\">\n                            <h6 class=\"card-title d-inline-block\">${NOMBRE_PARTICIPANTE} • ${participante.edad} años</h6>\n                            <span class=\"card-text mx-2\">\n                                <i class=\"bi bi-envelope\"></i> ${participante.email}\n                            </span>\n                            ${dato_telefono}\n                            <div class=\"d-inline-block etiqueta-etapa\">${participante.etapa_usuario?.etapa.nombre}</div>\n                        </div>\n                    </div>\n\n                    <div class=\"row mt-2\">\n                        <div class=\"col-2\"></div>\n                        <div class=\"col-7\">${tarjetas_pruebas}</div>\n                        <div class=\"col-3 d-flex align-items-center justify-content-end\">\n                            ${opciones_tarjeta}\n\n                            <div class=\"dropdown btn btn-outline-primary btn-circle d-inline-flex align-items-center justify-content-center\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\">\n                                <i class=\"bi bi-three-dots dropdown-toggle text-blue-40 pointer\"></i>\n\n                                <div class=\"dropdown-menu\">\n                                    ${opciones_dropdown}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `);\n    });\n}\n\n/**\n * Obtener los participantes del proceso.\n *\n * @returns {Promise<Array<Object>>}\n * @author Daniel Beltrán\n */\nasync function obtenerParticipantes() {\n    let datos = [];\n\n    await $.ajax({\n        url : `/participantes-proceso/${PROCESO.id}`,\n        type: 'GET'\n    }).done(function (respuesta) {\n        datos = respuesta.data;\n    }).fail(function () {\n        console.log('Error');\n    });\n\n    return datos;\n}\n\n/**\n * Seleccionar un participante.\n *\n * @param {number} id ID del participante.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction seleccionarParticipante(id) {\n    if (participantes_seleccionados.find((item) => item === id)) {\n        participantes_seleccionados = participantes_seleccionados.filter((item) => item !== id);\n    } else {\n        participantes_seleccionados.push(id);\n        participantes_seleccionados = participantes_seleccionados.filter((item, index) => participantes_seleccionados.indexOf(item) === index);\n    }\n\n    habilitarBotonesAcciones();\n}\n\n/**\n * Descartar uno o más participantes.\n *\n * Si no se recibe el ID de algún participante en específico, se descartarán todos los participantes seleccionados.\n *\n * @param {number|null} id ID del participante.\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n */\nasync function descartarParticipantes(id = null) {\n    if (id !== null) {\n        participantes_seleccionados = [id];\n    }\n\n    await $.ajax({\n        url : `/participantes-descartar`,\n        type: 'POST',\n        data: {\n            _token       : $('input[name=\"_token\"]').val(),\n            id           : PROCESO.id,\n            participantes: participantes_seleccionados\n        }\n    }).done(function (respuesta) {\n        participantes_seleccionados = [];\n        habilitarBotonesAcciones();\n        mostrarToast('success', respuesta.message);\n        cargarListadoParticipantes();\n    }).fail(function () {\n        console.log('Error');\n    });\n}\n\n/**\n * Habilitar o deshabilitar los botones de acciones masivas.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction habilitarBotonesAcciones() {\n    const HABILITADO = participantes_seleccionados.length > 0;\n    $('#boton-descartar').prop('disabled', !HABILITADO);\n    $('#boton-mover-proceso').prop('disabled', !HABILITADO);\n    $('#boton-reenviar-agenda').prop('disabled', !HABILITADO);\n}\n\n/**\n * Mover participante de proceso.\n *\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n */\nasync function moverDeProceso() {\n    const DATOS = new FormData();\n    DATOS.append('_token', $('input[name=\"_token\"]').val());\n    DATOS.append('proceso_actual_id', PROCESO.id);\n    DATOS.append('proceso_destino_id', $('#proceso_id').val());\n    DATOS.append('participantes', JSON.stringify(participantes_seleccionados));\n    DATOS.append('mantener_en_proceso', ($('#mantener_en_proceso').prop('checked') ? 1 : 0));\n\n    // Agregar el campo de cantidad de días o fecha límite, según el caso\n    if ($('#es_fecha').prop('checked') == 1) {\n        DATOS.append('fecha_vencimiento_agendas', $('#fecha_vencimiento_agendas').val());\n        DATOS.delete('dias_vencimiento_agendas');\n    } else if ($('#es_dias').prop('checked') == 1) {\n        DATOS.append('dias_vencimiento_agendas', $('#dias_vencimiento_agendas').val());\n        DATOS.delete('fecha_vencimiento_agendas');\n    }\n\n    await $.ajax({\n        url : `/participantes-cambiar-proceso`,\n        type: 'POST',\n        data: DATOS,\n        processData: false,\n        contentType: false\n    }).done(function (respuesta) {\n        participantes_seleccionados = [];\n        $('#modal-mover-proceso').modal('hide');\n        $('#formulario-mover-proceso').trigger('reset');\n        habilitarBotonesAcciones();\n        mostrarToast('success', respuesta.message);\n        cargarListadoParticipantes();\n    }).fail(function (error) {\n        mostrarToast('danger', error.responseJSON.errors);\n    });\n}\n\n/**\n * Abrir el modal para mover de proceso.\n *\n * @param {number} id ID del participante.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction abrirModalMoverDeProceso(id) {\n    participantes_seleccionados = [id];\n    $('#modal-mover-proceso').modal('show');\n}\n\n/**\n * Eliminar un participante del proceso.\n *\n * @param {number} id ID del participante.\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n */\nfunction eliminarParticipante(id) {\n    Swal.fire({\n        title            : '¿Estás seguro?',\n        text             : 'El participante será eliminado permanentemente del proceso.',\n        icon             : 'danger',\n        showCancelButton : true,\n        confirmButtonText: 'Eliminar',\n        cancelButtonText : 'Cancelar'\n    }).then(async (resultado) => {\n        if (resultado.isConfirmed) {\n            await $.ajax({\n                url : `/participantes-eliminar/${PROCESO.id}/${id}`,\n                type: 'POST',\n                data: {\n                    _token : $('input[name=\"_token\"]').val(),\n                    _method: 'DELETE'\n                }\n            }).done(function (respuesta) {\n                mostrarToast('success', respuesta.message);\n                cargarListadoParticipantes();\n            }).fail(function () {\n                console.log('Error');\n            });\n        }\n    });\n}\n\n/**\n * Abrir modal para reenviar agendamiento.\n *\n * @param {number|null} id ID del participante.\n * @param {string|null} email Correo electrónico del participante.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction abrirModalReenviarAgendamiento(id = null, email = null) {\n    $('#email_reenviar').parent().removeClass('d-none');\n    $('#email_reenviar').parent().addClass('d-block');\n\n    if (![null, undefined, ''].includes(id)) {\n        $('#participante_id_reagendar').val(id);\n    }\n\n    if (![null, undefined, ''].includes(email)) {\n        $('#email_reenviar').val(email);\n    }\n\n    // Ocultar el campo de correo cuando se selecciona más de un participante\n    if (participantes_seleccionados.length > 1) {\n        $('#email_reenviar').parent().removeClass('d-block');\n        $('#email_reenviar').parent().addClass('d-none');\n    }\n\n    $('#modal-reagendar').modal('show');\n}\n\n/**\n * Reenviar agendamiento.\n *\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n * @author Sergio Vargas\n */\nasync function reenviarAgendamiento() {\n    const ID         = $('#participante_id_reagendar').val();\n    const FORMULARIO = $('#formulario-reagendar');\n\n    FORMULARIO.validate({\n        ignore: [] // No ignorar campos ocultos\n    });\n\n    if (!FORMULARIO.valid()) {\n        return;\n    }\n\n    const DATOS = new FormData(FORMULARIO[0]);\n\n    ['capturar_camara', 'capturar_video', 'vigencia_pruebas', 'pruebas', 'dias_vencimiento_agendas', 'fecha_vencimiento_agendas'].forEach(campo => {\n        DATOS.delete(campo);\n    });\n\n    DATOS.append('_token', $('input[name=\"_token\"]').val());\n    DATOS.append('proceso_id', PROCESO.id);\n\n    // Agregar el campo de cantidad de días o fecha límite, según el caso\n    if ($('#es_fecha1').prop('checked') == 1) {\n        DATOS.append('fecha_vencimiento_agendas', $('#fecha_vencimiento_agendas1').val());\n        DATOS.delete('dias_vencimiento_agendas');\n    } else if ($('#es_dias1').prop('checked') == 1) {\n        DATOS.append('dias_vencimiento_agendas', $('#dias_vencimiento_agendas1').val());\n        DATOS.delete('fecha_vencimiento_agendas');\n    }\n\n    DATOS.append('capturar_camara', $('#capturar_camara_reenviar').prop('checked') ? 1 : 0);\n    DATOS.append('capturar_video', $('#capturar_video_reenviar').prop('checked') ? 1 : 0);\n\n    if (ID !== null && participantes_seleccionados.length === 0) {\n        participantes_seleccionados = [ID];\n    }\n\n    DATOS.append('participantes', JSON.stringify(participantes_seleccionados));\n    DATOS.append('pruebas', JSON.stringify($('#pruebas_reenviar').val()));\n    DATOS.append('empresa_id', dato_empresa?.id);\n\n    await $.ajax({\n        url        : `/participantes-reagendar`,\n        type       : 'POST',\n        data       : DATOS,\n        contentType: false,\n        processData: false\n    }).done(function (respuesta) {\n        limpiarFormularioReenviarAgendamiento();\n        habilitarBotonesAcciones();\n        $('#modal-reagendar').modal('hide');\n\n        mostrarToast('success', respuesta.message);\n\n        if (respuesta.advertencias && respuesta.advertencias.length > 0) {\n            mostrarModalAdvertenciasReagendamiento(respuesta);\n        }\n\n        cargarListadoParticipantes();\n    }).fail(function (error) {\n        let msg = 'Error al reenviar agendamiento';\n        if (error && error.responseJSON) {\n            const e = error.responseJSON;\n            if (e.errors !== undefined && e.errors !== null) {\n                if (typeof e.errors === 'string') {\n                    msg = e.errors;\n                } else if (Array.isArray(e.errors)) {\n                    msg = e.errors.join(' ');\n                } else if (typeof e.errors === 'object') {\n                    try {\n                        const vals = Object.values(e.errors).map(v => Array.isArray(v) ? v.join(' ') : v);\n                        msg = vals.join(' ');\n                    } catch (_) {}\n                }\n            } else if (e.message) {\n                msg = e.message;\n            }\n        } else if (error && error.message) {\n            msg = error.message;\n        }\n        mostrarToast('danger', msg);\n    });\n}\n\n/**\n * Limpiar el formulario de reenviar agendamiento.\n *\n * @returns {void}\n * @author Daniel Beltrán\n * @author Sergio Vargas\n */\nfunction limpiarFormularioReenviarAgendamiento() {\n    participantes_seleccionados = [];\n    $('#email_reenviar').val(null);\n    $('#pruebas_reenviar').val([]).trigger('change');\n\n    if (PROCESO.dias_vencimiento_agendas) {\n        // CASO 1: El proceso usa días - mantener días\n        $('#es_fecha1').prop('checked', false).trigger('change');\n        $('#fecha_vencimiento_agendas1').val(null);\n        $('#es_dias1').prop('checked', true).trigger('change');\n        $('#dias_vencimiento_agendas1').val(PROCESO.dias_vencimiento_agendas);\n    } else if (PROCESO.fecha_vencimiento_agendas) {\n        // CASO 2: El proceso usa fecha específica\n        $('#es_dias1').prop('checked', false).trigger('change');\n        $('#dias_vencimiento_agendas1').val(null);\n        $('#es_fecha1').prop('checked', true).trigger('change');\n\n        // Verificar si la fecha del proceso es futura o pasada\n        const fecha_proceso = new Date(PROCESO.fecha_vencimiento_agendas);\n        const fecha_actual = new Date();\n\n        if (fecha_proceso > fecha_actual) {\n            // Fecha futura: usar la fecha del proceso\n            $('#fecha_vencimiento_agendas1').val(PROCESO.fecha_vencimiento_agendas);\n        } else {\n            // Fecha pasada: usar 1 día desde hoy\n            const fecha_futura = new Date();\n            fecha_futura.setDate(fecha_futura.getDate() + 1);\n            const fecha_futuraISO = fecha_futura.toISOString().slice(0, 16);\n            $('#fecha_vencimiento_agendas1').val(fecha_futuraISO);\n        }\n    }\n\n    $('#capturar_camara_reenviar').prop('checked', PROCESO.capturar_camara);\n    $('#capturar_video_reenviar').prop('checked', PROCESO.capturar_video);\n}\n\n/**\n * Abrir el detalle de un participante.\n *\n * @param {number} id ID del participante.\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n */\nasync function abrirDetalleParticipante(id) {\n    $('#detalle-participante').html('');\n\n    let usuario = await obtenerParticipante(id);\n    let informacion_procesos = '';\n\n    usuario.procesos.forEach(proceso => {\n        informacion_procesos += `<div class=\"row mt-2\">\n            <div class=\"col-6\">\n                <div class=\"input-container\">\n                    <input\n                        type=\"text\"\n                        placeholder=\"\"\n                        class=\"rounded-2 text-body-2\"\n                        value=\"${proceso.nombre}\"\n                        disabled\n                    >\n                    <label class=\"text-body-2 label-flotante\">Proceso</label>\n                </div>\n            </div>\n\n            <div class=\"col-6\">\n                <div class=\"input-container\">\n                    <input\n                        type=\"text\"\n                        placeholder=\"\"\n                        class=\"rounded-2 text-body-2\"\n                        value=\"${proceso.empresa.razon_social}\"\n                        disabled\n                    >\n                    <label class=\"text-body-2 label-flotante\">Empresa</label>\n                </div>\n            </div>\n\n            <div class=\"col-6\">\n                <div class=\"input-container\">\n                    <input\n                        type=\"text\"\n                        placeholder=\"\"\n                        class=\"rounded-2 text-body-2\"\n                        value=\"${proceso.agendas[0]?.fecha_inicio}\"\n                        disabled\n                    >\n                    <label class=\"text-body-2 label-flotante\">Fecha de agendamiento</label>\n                </div>\n            </div>\n\n            <div class=\"col-6\">\n                <div class=\"input-container\">\n                    <input\n                        type=\"text\"\n                        placeholder=\"\"\n                        class=\"rounded-2 text-body-2\"\n                        value=\"${proceso.etapa_usuario.nombre}\"\n                        disabled\n                    >\n                    <label class=\"text-body-2 label-flotante\">Etapa</label>\n                </div>\n            </div>\n        </div><hr>`;\n    });\n\n    $('#detalle-participante').html(`\n        <div class=\"row\">\n            <div class=\"col-12\">\n                <h5 class=\"card-title\">${usuario.nombre_completo} - ${usuario.edad} años</h5>\n                <p class=\"card-text\">\n                    ${usuario.ciudad?.nombre}, ${usuario.ciudad?.departamento.pais.nombre}\n                </p>\n                <span class=\"d-block\">Último agendamiento: ${usuario.ultimo_agendamiento?.fecha_inicio}</span>\n                <span class=\"d-block\">Última aplicación: ${usuario.ultima_aplicacion?.fecha_procesamiento || ''}</span>\n            </div>\n        </div>\n\n        <div class=\"row mt-3\">\n            <div class=\"col-12 mb-3\">\n                <h6 class=\"card-title\">Datos personales</h6>\n            </div>\n\n            <div class=\"col-6\">\n                <div class=\"input-container\">\n                    <input\n                        type=\"text\"\n                        placeholder=\"\"\n                        class=\"rounded-2 text-body-2\"\n                        value=\"${usuario.telefono || ''}\"\n                        disabled\n                    >\n                    <label class=\"text-body-2 label-flotante\">Número de teléfono</label>\n                </div>\n\n                <div class=\"input-container\">\n                    <input\n                        type=\"text\"\n                        placeholder=\"\"\n                        class=\"rounded-2 text-body-2\"\n                        value=\"${usuario.dato_adicional?.nivel_educativo}\"\n                        disabled\n                    >\n                    <label class=\"text-body-2 label-flotante\">Nivel educativo</label>\n                </div>\n\n                <div class=\"input-container\">\n                    <input\n                        type=\"text\"\n                        placeholder=\"\"\n                        class=\"rounded-2 text-body-2\"\n                        value=\"${usuario.dato_adicional?.estado_academico}\"\n                        disabled\n                    >\n                    <label class=\"text-body-2 label-flotante\">Estado acádemico</label>\n                </div>\n            </div>\n\n            <div class=\"col-6\">\n                <div class=\"input-container\">\n                    <input\n                        type=\"text\"\n                        placeholder=\"\"\n                        class=\"rounded-2 text-body-2\"\n                        value=\"${usuario.email}\"\n                        disabled\n                    >\n                    <label class=\"text-body-2 label-flotante\">Correo electrónico</label>\n                </div>\n\n                <div class=\"input-container\">\n                    <input\n                        type=\"text\"\n                        placeholder=\"\"\n                        class=\"rounded-2 text-body-2\"\n                        value=\"${usuario.dato_adicional?.area_estudio?.nombre}\"\n                        disabled\n                    >\n                    <label class=\"text-body-2 label-flotante\">Área de estudio</label>\n                </div>\n            </div>\n        </div>\n\n        <div class=\"row mt-2\">\n            <div class=\"col-12 mb-3\">\n                <h6 class=\"card-title\">\n                    Procesos activos <span class=\"badge bg-secondary\">${usuario.procesos.length}</span>\n                </h6>\n            </div>\n\n            ${informacion_procesos}\n        </div>\n    `);\n\n    $('#modal-detalle-participante').modal('show');\n}\n\n/**\n * Obtener la información de un participante.\n *\n * @param {number} id ID del participante.\n * @returns {Promise<Object>}\n * @author Daniel Beltrán\n */\nasync function obtenerParticipante(id) {\n    let datos = {};\n\n    await $.ajax({\n        url : `/participante/${id}`,\n        type: 'GET'\n    }).done(function (respuesta) {\n        datos = respuesta.data;\n    }).fail(function (error) {\n        console.error(error);\n    });\n    return datos;\n}\n\n/**\n * Mostrar modal con advertencias detalladas de reagendamiento.\n *\n * @param {object} respuesta - Respuesta del servidor con detalles y advertencias\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction mostrarModalAdvertenciasReagendamiento(respuesta) {\n    let contenido_advertencias = '';\n\n    if (respuesta.advertencias && respuesta.advertencias.length > 0) {\n        contenido_advertencias = '<div class=\"alert alert-warning\"><ul class=\"mb-0\" style=\"list-style: none; padding-left: 0;\">';\n\n        respuesta.advertencias.forEach(function(advertencia) {\n            contenido_advertencias += '<li style=\"margin-bottom: 8px;\">' + advertencia + '</li>';\n        });\n\n        contenido_advertencias += '</ul></div>';\n    }\n\n    let contenido_detalles = '';\n    if (respuesta.detalles) {\n        contenido_detalles = `\n            <div class=\"row mt-3\">\n                <div class=\"col-md-4\">\n                    <div class=\"text-center\">\n                        <h5 class=\"text-success\">${respuesta.detalles.agendas_reagendadas}</h5>\n                        <small class=\"text-muted\">Agendas reagendadas</small>\n                    </div>\n                </div>\n                <div class=\"col-md-4\">\n                    <div class=\"text-center\">\n                        <h5 class=\"text-warning\">${respuesta.detalles.agendas_omitidas}</h5>\n                        <small class=\"text-muted\">Agendas omitidas</small>\n                    </div>\n                </div>\n                <div class=\"col-md-4\">\n                    <div class=\"text-center\">\n                        <h5 class=\"text-info\">${respuesta.detalles.participantes_notificados}</h5>\n                        <small class=\"text-muted\">Participantes notificados</small>\n                    </div>\n                </div>\n            </div>\n        `;\n    }\n\n    Swal.fire({\n        title: '<i class=\"fas fa-exclamation-triangle text-warning\"></i> Información del Reagendamiento',\n        html: `\n            <div class=\"text-left\">\n                <p><strong>Se completó el proceso de reagendamiento con algunas limitaciones:</strong></p>\n                ${contenido_advertencias}\n                ${contenido_detalles}\n                <div class=\"mt-3\">\n                    <small class=\"text-muted\">\n                        <i class=\"fas fa-info-circle\"></i>\n                        Las agendas que han alcanzado el límite máximo de ${respuesta.detalles.limite_agendas} reagendamientos no pueden ser reagendadas nuevamente.\n                    </small>\n                </div>\n            </div>\n        `,\n        icon: 'warning',\n        confirmButtonText: 'Entendido',\n        confirmButtonColor: '#3085d6',\n        width: '600px',\n        customClass: {\n            htmlContainer: 'text-left'\n        }\n    });\n}\n","structuredPatch":[{"oldStart":357,"oldLines":7,"newStart":357,"newLines":7,"lines":[" ","     DATOS.append('participantes', JSON.stringify(participantes_seleccionados));","     DATOS.append('pruebas', JSON.stringify($('#pruebas_reenviar').val()));","-    DATOS.append('empresa_id', dato_empresa?.id);","+    DATOS.append('empresa_id', PROCESO.empresa_id);"," ","     await $.ajax({","         url        : `/participantes-reagendar`,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"2e1f9b66-b2e6-44e2-834b-f11b83ad3ce4"}
{"parentUuid":"4974719f-3b29-473c-b29e-b9d81927e414","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LQFaCMcnxRwZaFRmtR3ZF6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01S4UrM8AXsBeegJnZB3X5PF","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\procesos\\detalle.js","old_string":"    DATOS.append('empresa_id', dato_empresa.id);","new_string":"    DATOS.append('empresa_id', PROCESO.empresa_id);"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2338,"cache_read_input_tokens":25866,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2338},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5o43RmRzNDVs6V5w9i","type":"assistant","uuid":"bc918ff0-26ec-4bce-8965-0decac6e0dc5","timestamp":"2026-02-16T16:43:40.375Z"}
{"type":"file-history-snapshot","messageId":"bc918ff0-26ec-4bce-8965-0decac6e0dc5","snapshot":{"messageId":"4d5bb573-a4a4-497b-91aa-e63f8223aca1","trackedFileBackups":{"public\\src\\procesos\\js\\detalle.js":{"backupFileName":"5582b62cf6d471d9@v1","version":1,"backupTime":"2026-02-16T16:43:39.435Z"},"public\\js\\procesos\\detalle.js":{"backupFileName":"51bf0f4dcd300f98@v1","version":1,"backupTime":"2026-02-16T16:43:40.438Z"}},"timestamp":"2026-02-16T16:43:28.334Z"},"isSnapshotUpdate":true}
{"parentUuid":"bc918ff0-26ec-4bce-8965-0decac6e0dc5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01S4UrM8AXsBeegJnZB3X5PF","toolUseID":"toolu_01S4UrM8AXsBeegJnZB3X5PF","timestamp":"2026-02-16T16:43:40.446Z","uuid":"ae2c1eb4-459b-4053-a604-fd992fd66405"}
{"parentUuid":"bc918ff0-26ec-4bce-8965-0decac6e0dc5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01S4UrM8AXsBeegJnZB3X5PF","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\procesos\\detalle.js has been updated successfully."}]},"uuid":"6258961a-c40d-4d58-81c7-50fe4075aa95","timestamp":"2026-02-16T16:43:40.445Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\procesos\\detalle.js","oldString":"    DATOS.append('empresa_id', dato_empresa.id);","newString":"    DATOS.append('empresa_id', PROCESO.empresa_id);","originalFile":"var nombre_tabla_participantes = 'tabla_participantes';\nwindow[nombre_tabla_participantes + '_ids'] = [];\nwindow[nombre_tabla_participantes + '_seleccionados'] = [];\nwindow[nombre_tabla_participantes + '_filtros'] = [];\n\nvar nombre_tabla_resultados = 'tabla_resultados';\nwindow[nombre_tabla_resultados + '_ids'] = [];\nwindow[nombre_tabla_resultados + '_seleccionados'] = [];\nwindow[nombre_tabla_resultados + '_filtros'] = [];\nvar pruebas_seleccionadas = [];\nlet nombre_tabla_seleccionada_generar_ia = null;\nvar dato_empresa = [];\n\n/**\n * Obtener el ID de etapa del candidato de forma consistente.\n *\n * @param {object} dato Datos del candidato.\n * @param {string} tipo Tipo de vista ('tabla', 'detalle', etc.).\n * @returns {number|null} ID de la etapa o null.\n * @author Sergio Vargas\n */\nfunction obtenerEtapaId(dato, tipo) {\n    // Priorizar etapasUsuarios (cargado desde backend)\n    if (dato?.etapas_usuarios && dato.etapas_usuarios.length > 0) {\n        return dato.etapas_usuarios[0].etapa?.id || dato.etapas_usuarios[0].etapa_id;\n    }\n\n    // Fallback a etapa_usuario si existe\n    if (dato?.etapa_usuario?.etapa?.id) {\n        return dato.etapa_usuario.etapa.id;\n    }\n\n    // Fallback a etapa_entrada si existe\n    if (dato?.etapa_entrada) {\n        return dato.etapa_entrada;\n    }\n\n    return null;\n}\n\n/**\n * Determinar qué botones de acción mostrar según el estado del candidato.\n *\n * @param {number|null} etapa_id ID de la etapa actual.\n * @param {object} dato Datos del candidato.\n * @returns {object} Objeto con flags de qué botones mostrar.\n * @author Sergio Vargas\n * @author Daniel Beltrán\n */\nfunction determinarBotonesAccion(etapa_id, dato) {\n    // Solo mostrar botones si el proceso NO tiene vacante asociada\n    if (PROCESO.vacante_id !== null) {\n        return {\n            mostrarSeleccionar: false,\n            mostrarDescartar: false,\n            mostrarRevertir: false\n        };\n    }\n\n    const ETAPA_EN_PRUEBAS = 9;\n    const ETAPA_SELECCIONADO = 10;\n    const ETAPA_DESCARTADO = 11;\n\n    // Verificar si todas las agendas están finalizadas\n    const TODAS_PRUEBAS_FINALIZADAS = dato.agendas && dato.agendas.every(agenda => agenda.estado.id === 3);\n\n    // Verificar si ya se completaron las vacantes\n    const VACANTES_COMPLETAS = (PROCESO.seleccionados_count ?? 0) >= (PROCESO.cantidad_vacantes ?? 1);\n\n    return {\n        // Seleccionar: Solo si terminó pruebas, no está seleccionado ni descartado, Y hay vacantes disponibles\n        mostrarSeleccionar: TODAS_PRUEBAS_FINALIZADAS && etapa_id !== ETAPA_SELECCIONADO && etapa_id !== ETAPA_DESCARTADO && !VACANTES_COMPLETAS,\n\n        // Descartar: Solo si NO está descartado\n        mostrarDescartar: etapa_id !== ETAPA_DESCARTADO,\n\n        // Revertir: Solo si SÍ está descartado\n        mostrarRevertir: etapa_id === ETAPA_DESCARTADO\n    };\n}\n\n$(document).ready(function() {\n    encabezadoDetalle(PROCESO);\n\n    $(document).on('click', '.copiar-elemento',function () {\n        let texto = $(this).data('texto');\n        navigator.clipboard.writeText(texto).then(function() {\n            mostrarToast('success', 'Información copiada al portapapeles');\n        }).catch(function(err) {\n            mostrarToast('danger', 'Error al copiar en el portapapeles.');\n        });\n        if ($(this).data('direccion')) {\n            window.open($(this).data('direccion'), '_blank');\n        }\n    });\n\n    $(document).on('click', '#participantes-tap', function () { actualizarDatatables(nombre_tabla_participantes); });\n\n    $(document).on('click', '#resultados-tap', function () {\n        actualizarDatatables(nombre_tabla_resultados);\n        mostrarEncuestaConsultaResultados();\n    });\n\n    $('#modal-historial-acciones').on('hidden.bs.modal', function () {\n        if ($('#participantes-tap').hasClass('active')) {\n            actualizarDatatables(nombre_tabla_participantes);\n        }\n        if ($('#resultados-tap').hasClass('active')) {\n            actualizarDatatables(nombre_tabla_resultados);\n        }\n    });\n\n    $(\".prueba_seleccionar_reenvio\").click(function () {\n        let id = $(this).data(\"id\");\n        $('.prueba_seleccionar_reenvio').removeClass('invalid');\n        if ($(this).hasClass(\"selected\")) {\n            $(this).removeClass(\"selected\");\n            pruebas_seleccionadas = pruebas_seleccionadas.filter(item => item !== id);\n        } else {\n            $(this).addClass(\"selected\");\n            pruebas_seleccionadas.push(id);\n        }\n        $(\"#total-seleccionadas\").text(pruebas_seleccionadas.length);\n    });\n\n    $('#modal-vidograbaciones').on('hidden.bs.modal', function () {\n        // Pausar y limpiar el reproductor de video\n        const reproductor = document.getElementById('reproductor');\n        if (reproductor) {\n            reproductor.pause();\n            reproductor.src = '';\n        }\n        // Limpiar la lista de videos\n        $('#lista-videos').empty();\n        $('#reproduciendo-parte').text('1');\n    });\n\n    $(document).on('change', `#filtro_mas_recientes_${nombre_tabla_participantes}`, function() {\n        actualizarDatatables(nombre_tabla_participantes);\n    });\n    $(document).on('change', `#filtro_mas_recientes_${nombre_tabla_resultados}`, function() {\n        actualizarDatatables(nombre_tabla_resultados);\n    });\n});\n\n$(`#${nombre_tabla_participantes}`).DataTable({\n    ...configuracion_tablas,\n    scrollY: false,\n    ajax: {\n        url : `/participantes-proceso/${PROCESO.id}`,\n        data: function (datos) {\n            datos.recientes = $(`#filtro_mas_recientes_${nombre_tabla_participantes}`).val();\n            if (window[nombre_tabla_participantes + '_filtros'][`filtro_etapas_${nombre_tabla_participantes}`]) {\n                datos.etapa_id = window[nombre_tabla_participantes + '_filtros'][`filtro_etapas_${nombre_tabla_participantes}`];\n            }\n            if (window[nombre_tabla_participantes + '_filtros'][`filtro_estado_pruebas_${nombre_tabla_participantes}`]) {\n                datos.estado_agenda_id = window[nombre_tabla_participantes + '_filtros'][`filtro_estado_pruebas_${nombre_tabla_participantes}`];\n            }\n            if (typeof window[nombre_tabla_participantes + '_filtros'][`filtro_fecha_agendamiento_${nombre_tabla_participantes}`] === 'string') {\n                let partesFecha = window[nombre_tabla_participantes + '_filtros'][`filtro_fecha_agendamiento_${nombre_tabla_participantes}`].split(' a ');\n                if (partesFecha[0]) datos.fecha_inicio_desde = partesFecha[0];\n                if (partesFecha[1]) datos.fecha_inicio_hasta = partesFecha[1];\n            }\n            if (typeof window[nombre_tabla_participantes + '_filtros'][`filtro_fecha_aplicacion_${nombre_tabla_participantes}`] === 'string') {\n                let partesFecha = window[nombre_tabla_participantes + '_filtros'][`filtro_fecha_aplicacion_${nombre_tabla_participantes}`].split(' a ');\n                if (partesFecha[0]) datos.fecha_procesamiento_desde = partesFecha[0];\n                if (partesFecha[1]) datos.fecha_procesamiento_hasta = partesFecha[1];\n            }\n        },\n        dataSrc: function (json) {\n            dato_empresa = json.empresa;\n            return Object.values(json.data);\n        }\n    },\n    columns: [\n        {\n            data: null,\n            orderable: false,\n            render: (dato) => {\n                return `\n                    <div class=\"card\">\n                        <div class=\"card-body\">\n                            ${crearInformacionParticipante(dato, nombre_tabla_participantes)}\n                            <div class=\"row mt-3\">\n                                <div class=\"col-12\">\n                                    <div class=\"accordion\" id=\"accordion${dato.id}\">\n                                        <div class=\"accordion-item\">\n                                            <h2 class=\"accordion-header\">\n                                                <button class=\"accordion-button shadow-none text-body-1 collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapse${dato.id}\" aria-expanded=\"false\" aria-controls=\"collapse${dato.id}\">\n                                                    Pruebas finalizadas (${dato.agendas ? dato.agendas.filter(agenda => agenda.estado.id === 3).length : 0}/${dato?.agendas?.length ?? 0})\n                                                </button>\n                                            </h2>\n                                            <div id=\"collapse${dato.id}\" class=\"accordion-collapse collapse\" data-bs-parent=\"#accordion${dato.id}\">\n                                                <div class=\"accordion-body\">\n                                                    ${crearTablaAgendas(dato, nombre_tabla_participantes, 'tabla')}\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                `;\n            },\n        },\n    ],\n    drawCallback: function(settings) {\n        window[nombre_tabla_participantes + '_ids'] = $(`#${nombre_tabla_participantes}`).DataTable().data().toArray();\n        inicializarTooltips();\n        setTimeout(function() {\n            $('[data-bs-toggle=\"tooltip\"]').tooltip();\n        }, 100);\n    },\n    initComplete: function(settings, json) {\n        window[nombre_tabla_participantes + '_ids'] = $(`#${nombre_tabla_participantes}`).DataTable().data().toArray();\n        $(`[aria-describedby=\"${nombre_tabla_participantes}_info\"] .thead-componente`).hide();\n        if ($(`.componentes-botones-adicionales-${nombre_tabla_participantes}`).length === 0) {\n            $(`.row.justify-content-end.tabla-componente-${nombre_tabla_participantes}`).append(renderizarBotonesAcciones(nombre_tabla_participantes));\n        }\n        cargarDataTablas();\n        inicializarTooltips();\n        $('[data-bs-toggle=\"tooltip\"]').tooltip();\n\n        validarAgendasExpiradas(PROCESO.id);\n    }\n});\n\n$(`#${nombre_tabla_resultados}`).DataTable({\n    ...configuracion_tablas,\n    scrollY: false,\n    ajax: {\n        url : `/participantes-proceso/${PROCESO.id}`,\n        data: function (datos) {\n            datos.recientes = $(`#filtro_mas_recientes_${nombre_tabla_resultados}`).val();\n            if (window[nombre_tabla_resultados + '_filtros'][`filtro_nivel_adecuacion_${nombre_tabla_resultados}`]) {\n                datos.indice_talento_nivel = window[nombre_tabla_resultados + '_filtros'][`filtro_nivel_adecuacion_${nombre_tabla_resultados}`];\n            }\n        },\n        dataSrc: function (json) {\n            return Object.values(json.data);\n        }\n    },\n    columns: [\n        {\n            data: null,\n            orderable: false,\n            render: (dato) => {\n                return `\n                    <div class=\"card\">\n                        <div class=\"card-body\">\n                            ${crearInformacionParticipante(dato, nombre_tabla_resultados)}\n                            <div class=\"row mt-3\">\n                                <div class=\"col-12\">\n                                    <div class=\"accordion\" id=\"acorderonResultados_${dato.id}\">\n                                        <div class=\"accordion-item\">\n                                            <h2 class=\"accordion-header\">\n                                                <button class=\"accordion-button shadow-none text-body-1 collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapsePruebas${dato.id}\" aria-expanded=\"false\" aria-controls=\"collapsePruebas${dato.id}\">\n                                                    <div class=\"row w-100 pe-3\">\n                                                        <div class=\"col-auto px-1 my-auto\">\n                                                            Pruebas psicométricas\n                                                        </div>\n                                                        <div class=\"col-auto my-auto ms-auto d-flex\" id=\"indice-talento_${dato.id}_${dato.documento}\">\n                                                            <span class=\"text-label-1 my-auto me-2\">Índice de talento</span>\n                                                            ${(dato.indice_talento > 0) ?\n                                                                crearTag({ texto: dato .indice_talento + '%', class: 'px-2 mx-2 my-auto text-center text-label-1 tag-filled-' + calcularColorIndiceTalento(dato.indice_talento)})\n                                                            :\n                                                                crearTag({ texto: 'Faltan resultados', class: 'px-2 mx-2 my-auto text-center text-label-1 tag-filled-gray disabled'})\n                                                            }\n                                                            <div ${crearTooltip({ placement: `bottom`, content: 'Descargar reportes', toggle: `popover`,})} class=\"btn py-2 btn-outline-primary bg-transparent btn-circle\" data-nombre-tabla=\"${nombre_tabla_resultados}_${dato.documento}\" id=\"boton-descargar-reportes_${nombre_tabla_resultados}_${dato.documento}\" >\n                                                                <i class=\"bi bi-download\"></i>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                </button>\n                                            </h2>\n                                            <div id=\"collapsePruebas${dato.id}\" class=\"accordion-collapse collapse\" data-bs-parent=\"#acorderonResultados${dato.id}\">\n                                                <div class=\"accordion-body\">\n                                                    ${crearTablaAgendas(dato, `${nombre_tabla_resultados}_${dato.documento}`, 'tabla')}\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                `;\n            },\n        },\n    ],\n    drawCallback: function(settings) {\n        window[nombre_tabla_resultados + '_ids'] = $(`#${nombre_tabla_resultados}`).DataTable().data().toArray();\n        inicializarTooltips();\n        setTimeout(function() {\n            $('[data-bs-toggle=\"tooltip\"]').tooltip();\n        }, 100);\n    },\n    initComplete: function(settings, json) {\n        window[nombre_tabla_resultados + '_ids'] = $(`#${nombre_tabla_resultados}`).DataTable().data().toArray();\n        $(`[aria-describedby=\"${nombre_tabla_resultados}_info\"] .thead-componente`).hide();\n        if ($(`.componentes-botones-adicionales-${nombre_tabla_resultados}`).length === 0) {\n            $(`.row.justify-content-end.tabla-componente-${nombre_tabla_resultados}`).append(renderizarBotonesAcciones(nombre_tabla_resultados));\n        }\n        cargarDataTablas();\n        inicializarTooltips();\n        $('[data-bs-toggle=\"tooltip\"]').tooltip();\n    }\n});\n\n/**\n * Renderiza los botones de acciones masivas para la tabla especificada.\n *\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {string} HTML con los botones de acciones.\n * @author Andres Morales\n * @author Andres Gonzalez\n * @author Sergio vargas\n */\nfunction renderizarBotonesAcciones(nombre_tabla) {\n    return `\n        <div class=\"col-12 componentes-botones-adicionales-${nombre_tabla}\">\n            <div class=\"row\">\n                <div class=\"col-auto me-5 px-3\">\n                    ${crearCheckbox({\n                        id: `checkbox-seleccionar-todos-${nombre_tabla}`,\n                        onchange: `seleccionarTodos(this.checked, '${nombre_tabla}');`,\n                        label: `<span id=\"${nombre_tabla}-seleccionados-total\">Seleccionado: 0</span>`,\n                    })}\n                </div>\n                <div class=\"col-auto px-1\">\n                    ${crearBoton({\n                        id: `boton-reenviar-agenda_${nombre_tabla}`,\n                        clases: 'btn-outline-primary',\n                        texto: '<i class=\"bi bi-arrow-repeat text-body-1 me-2\"></i> Reenviar agendamiento',\n                        disabled: true,\n                        onclick: 'abrirModalReenviarAgendamiento({masivo:true})'\n                    })}\n                </div>\n                <div class=\"col-auto px-1\">\n                    ${crearBoton({\n                        id: `boton-mover-proceso_${nombre_tabla}`,\n                        clases: 'btn-outline-primary',\n                        texto: '<i class=\"bi bi-box-arrow-up-right text-body-1 me-2\"></i> Enviar a otro proceso',\n                        disabled: true,\n                        onclick: `abrirModalMoverDeProceso({masivo:true}, '${nombre_tabla}')`\n                    })}\n                </div>\n                <div class=\"col-auto px-1\">\n                    ${crearBoton({\n                        id: `boton-reporte-comparativo_${nombre_tabla}`,\n                        clases: 'btn-outline-primary',\n                        texto: '<i class=\"bi bi-people text-body-1 me-2\"></i> Comparar candidatos',\n                        disabled: true,\n                        onclick: `descargarReporteComprartivo('${nombre_tabla}')`\n                    })}\n                </div>\n                ${PROCESO.vacante_id === null ? `\n                    <div class=\"col-auto px-1\">\n                        ${crearBoton({\n                            id: `boton-descartar_${nombre_tabla}`,\n                            clases: 'btn-outline-danger',\n                            texto: '<i class=\"bi bi-person-fill-x text-body-1 me-2\"></i> Descartar',\n                            disabled: true,\n                            onclick: `descartarParticipantes(null, '${nombre_tabla}')`\n                        })}\n                    </div>\n                ` : ''}\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Renderiza el encabezado del detalle.\n *\n * @param {object} dato Objeto con la información del proceso.\n * @returns {void}\n * @author Andres Morales\n * @author Andres Gonzalez\n * @author Daniel Beltrán\n */\nfunction encabezadoDetalle(dato) {\n    let dias_restantes = false;\n    if (dato.fecha_cierre != null) {\n        let fecha_cierre = new Date(dato.fecha_cierre);\n        let fecha_actual = new Date();\n\n        // Normalizar fechas a medianoche para comparación exacta de días\n        fecha_cierre.setHours(23, 59, 59, 999);\n        fecha_actual.setHours(0, 0, 0, 0);\n\n        dias_restantes = Math.floor((fecha_cierre - fecha_actual) / (1000 * 60 * 60 * 24));\n    }\n    let html = `\n        <div class=\"row my-3 px-7\">\n            <div class=\"col\">\n                <div class=\"row mb-3\">\n                    <div class=\"col-auto\"><span class=\"text-headline-4 fw-bold text-gray-10 me-1\">${dato.id}</span> - <span class=\"text-headline-4 fw-bold text-gray-10 ms-1\">${dato.nombre}</span></div>\n                </div>\n                <div class=\"row mb-3\">\n                    <div class=\"col-auto text-label-2 d-flex px-1\">\n                        <div class=\"my-auto mx-1\"><i class=\"bi bi-briefcase text-body-2 my-auto\"></i></div>\n                        <div class=\"my-auto mx-1\">Vacantes:</div>\n                        <div class=\"my-auto mx-1\">${dato.cantidad_vacantes}</div>\n                    </div>\n                    <div class=\"col-auto text-label-2 d-flex px-1\">\n                        <div class=\"my-auto mx-1\"><i class=\"bi bi-clock text-body-2 my-auto\"></i></div>\n                        <div class=\"my-auto mx-1 ${ (dias_restantes !== false && dias_restantes <= 3) ? 'text-red-cta' : ''}\">${ (dias_restantes !== false) ? dias_restantes + ' días restantes' : 'Ilimitado'}</div>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-auto\">\n                <div class=\"row\">\n                    <div class=\"col-auto my-auto px-1\">\n                        ${ESTADOS_PROCESOS[dato.estado_id]}\n                    </div>\n                    <div class=\"col-auto my-auto px-1 d-none\">\n                        <div class=\"dropdown\">\n                            <div class=\"dropdown-toggle\" type=\"button\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\">\n                                ${PRIORIDAD_PROCESOS[dato.prioridad_id]}\n                            </div>\n                            <ul class=\"dropdown-menu\">\n                                <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited\"><i class=\"text-blue-cta bi bi-chevron-down me-2\"></i>Baja</button></li>\n                                <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited\"><i class=\"text-yellow-cta bi bi-dash-lg me-2\"></i>Media</button></li>\n                                <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited\"><i class=\"text-orange-cta bi bi-chevron-up me-2\"></i>Alta</button></li>\n                                <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited\"><i class=\"text-red-cta bi bi-chevron-double-up me-2\"></i>Urgente</button></li>\n                                <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited\"><i class=\"bi bi me-6\"></i>Sin prioridad</button></li>\n                            </ul>\n                        </div>\n                    </div>\n                    ${dato.vacante_id === null ? `\n                        <div class=\"col-auto px-1 my-auto\">\n                            ${crearBoton({\n                                clases: 'btn-outline-primary btn-circle d-flex justify-content-center',\n                                texto: '<i class=\"bi bi-pencil-fill\"></i>',\n                                tooltip: `${crearTooltip({ placement: 'bottom', content: 'Editar proceso', toggle: 'popover'})}`,\n                                url: `/procesos/${dato.id}/edit`,\n                            })}\n                        </div>\n                        <div class=\"col-auto px-1 my-auto dropdown\">\n                            ${crearBoton({\n                                id: `btn-agregar-participantes-detalle-${dato.id}`,\n                                clases: 'btn-outline-primary btn-circle d-flex justify-content-center dropdown-toggle',\n                                texto: '<i class=\"bi bi-person-add my-auto\"></i>',\n                                title: 'Agregar participantes',\n                                data: [\n                                    {texto: 'bs-toggle', value: 'dropdown'},\n                                    {texto: 'bs-auto-close', value: 'outside'}\n                                ]\n                            })}\n                            <div class=\"dropdown-menu\">\n                                ${crearBoton({\n                                    clases: 'dropdown-item no-visited pointer py-2',\n                                    texto: '<i class=\"bi bi-person-add me-2\"></i>Un participante',\n                                    onclick: `abrirModalAgregarParticipantes(${dato.id})`\n                                })}\n                                ${crearBoton({\n                                    clases: 'dropdown-item no-visited pointer py-2',\n                                    texto: '<i class=\"bi bi-file-earmark-arrow-up me-2\"></i>Carga masiva',\n                                    onclick: `abrirModalAgendamientoMasivo(${dato.id})`\n                                })}\n                            </div>\n                        </div>\n                    ` : ''}\n                    <div class=\"col-auto px-1 my-auto d-none\">\n                        ${crearBoton({\n                            clases: 'btn-outline-primary btn-circle',\n                            texto: '<i class=\"bi bi-clock-history\"></i>',\n                            tooltip: `${crearTooltip({ placement: `bottom`, content: 'Historial acciones', toggle: `popover`,})}`,\n                            onclick: `renderizarTablaHistorial()`,\n                        })}\n                    </div>\n                    <div class=\"col-auto px-1 my-auto\">\n                        ${crearBoton({\n                            clases: 'btn-outline-primary btn-circle',\n                            texto: '<i class=\"bi bi-share\"></i>',\n                            tooltip: `${crearTooltip({ placement: `bottom`, content: 'Compartir resultados', toggle: `popover`,})}`,\n                            onclick: `abrirModalCompartirProceso(${PROCESO.id})`,\n                        })}\n                    </div>\n                    <div class=\"col-auto px-1 my-auto\">\n                        ${crearBoton({\n                            id: 'abrir-modal-historial-compartido',\n                            clases: 'btn-outline-primary btn-circle',\n                            texto: '<i class=\"bi bi-hourglass-split\"></i>',\n                            tooltip: `${crearTooltip({ placement: `bottom`, content: 'Historial compartido', toggle: `popover`,})}`,\n                            onclick: `abrirModalHistorialCompartido()`,\n                        })}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n\n    $('#encabezado_detalle').html(html);\n    inicializarTooltips();\n\n    // FIXME: Aparece un error en consola al utilizar el dropdown asociado, eso altera su funcionamiento (el problema está en utilizar inicializarTooltips() en muchos lados de este archivo)\n    $('[id^=\"btn-agregar-participantes-detalle-\"]').each(function() {\n        if (!this.hasAttribute('data-bs-toggle-tooltip-initialized')) {\n            new bootstrap.Tooltip(this, {\n                trigger  : 'hover',\n                placement: 'bottom'\n            });\n            this.setAttribute('data-bs-toggle-tooltip-initialized', 'true');\n        }\n    });\n}\n\n/**\n * Renderiza la informacion del participante.\n *\n * @param {object} dato Objeto con la información del participante.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @param {string} tipo Tipo de renderizado ('tabla' o 'detalle').\n * @returns {void}\n * @author Andres Morales\n * @author Andres Gonzalez\n * @author José Manuel Jiménez\n * @author Esperanza Olivo\n * @author Sergio Vargas\n */\nfunction crearInformacionParticipante(dato, nombre_tabla, tipo = 'tabla') {\n    let checked = false;\n\n    if (window[nombre_tabla + '_seleccionados'].some(item => item.id == dato.id)) {\n        checked = true;\n    }\n    // Indice de talento visual\n    let indice_talento = dato.indice_talento ?? 0;\n    let border_color = '';\n    let badge_estilo = '';\n    if (indice_talento >= 10 && indice_talento <= 40) {\n        border_color = 'borde-indice-talento-rojo';\n        badge_estilo = 'badge-indice-talento-rojo';\n    } else if (indice_talento >= 41 && indice_talento <= 70) {\n        border_color = 'borde-indice-talento-amarillo';\n        badge_estilo = 'badge-indice-talento-amarillo';\n    } else if (indice_talento >= 71 && indice_talento <= 100) {\n        border_color = 'borde-indice-talento-verde';\n        badge_estilo = 'badge-indice-talento-verde';\n    }\n\n    return `\n        <div class=\"row px-5\">\n            <div class=\"col-auto my-auto px-0\">\n                ${crearCheckbox({\n                    value:dato?.id,\n                    checked: checked,\n                    onchange: `seleccionarElemento(this.value, this.checked, '${nombre_tabla}', '${tipo}');`,\n                })}\n            </div>\n            <div class=\"col-11 col-md-1 my-auto px-1\">\n                <div class=\"position-relative\">\n                    <img class=\"imagen-participante mx-auto d-block ${border_color} ${tipo === 'tabla' ? 'cursor-pointer' : ''}\" src=\"${'/usuarios-imagen/' + dato.id}\" ${tipo === 'tabla' ? `onclick=\"abrirDetalleParticipante(${dato?.id}, ${dato?.etapa_usuario?.id})\"` : ''}>\n                    ${indice_talento > 0 ? `\n                        <span class=\"position-absolute top-100 start-50 translate-middle badge rounded-pill px-2 ${badge_estilo}\" style=\"font-size:0.85em;\">\n                            ${indice_talento}\n                        </span>\n                    ` : ''}\n                </div>\n                <p class=\"text-label-2 mb-0 mt-3 text-center text-wrap\">\n                    ${dato.ciudad_id ? `${dato.ciudad?.nombre}, ${dato.ciudad?.departamento?.pais?.nombre}` : ''}\n                </p>\n            </div>\n            <div class=\"col-12 col-md\">\n                <div class=\"row\">\n                    ${(tipo === 'tabla') ? `\n                        <div class=\"col-auto pe-0 my-auto text-headline-5\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-headline-5 h-fit-content py-1',\n                                texto: `<span class=\"text-decoration-underline text-headline-5 text-dark\">ID ${dato?.id} - ${dato?.nombre_completo ?? 'N/A'}</span>`,\n                                tooltip: `${crearTooltip({ placement: `top`, content: 'Ver candidato', toggle: `popover`,})}`,\n                                onclick: `abrirDetalleParticipante(${dato?.id}, ${dato?.etapa_usuario?.id})`,\n                            })}\n                        </div>\n                    ` : `\n                        <div class=\"col-auto pe-3 my-auto text-headline-5\"><span class=\"text-dark\">ID ${dato?.id} - ${dato?.nombre_completo || 'N/A'}</span></div>\n                    `}\n                    ${((tipo !== 'detalle') ? dato.fecha_nacimiento != null : dato.edad != '0') ? `\n                        <div class=\"col-auto my-auto text-label-2 border-start border-black\">${(tipo !== 'detalle') ? obtenerEdad(dato.fecha_nacimiento ?? null) : dato.edad} años</div>\n                    ` : ``}\n                </div>\n                <div class=\"row ps-4\">\n                    ${(tipo === 'detalle') ? `\n                        <div class=\"d-flex flex-row mt-1\">\n                            <p class=\"text-label-2 mb-0 me-3\">Etapa: ${dato?.etapa_usuario?.nombre}</p>\n                            <p class=\"text-label-2 mb-0 me-3\">Activo en: ${dato.procesos_activos.length} procesos</p>\n                        </div>\n                    ` : ``}\n                    <div class=\"d-flex flex-row mt-1\">\n                        <p class=\"text-label-2 mb-0 me-3 d-inline-flex align-items-center\"><i class=\"bi bi-envelope text-body-2 me-2\"></i>${dato?.email ?? 'N/A'}</p>\n                        <p class=\"text-label-2 mb-0 me-3 d-inline-flex align-items-center\"><i class=\"bi bi-telephone text-body-2 me-2\"></i>${dato?.telefono ?? 'N/A'}</p>\n                        <p class=\"text-label-2 mb-0 me-3 d-inline-flex align-items-center\"><i class=\"bi bi-card-heading text-body-2 me-2\"></i>${dato?.documento ?? 'N/A'}</p>\n                    </div>\n                    ${(tipo === 'detalle') ? `\n                        <div class=\"d-flex flex-row mt-1\">\n                            <p class=\"text-label-2 mb-0 me-3 d-inline-flex align-items-center\"><i class=\"bi bi-mortarboard text-body-2 me-2\"></i>${dato.dato_adicional?.area_estudio?.nombre ?? 'N/A'}</p>\n                                <p class=\"text-label-2 mb-0 me-3 d-inline-flex align-items-center\"><i class=\"bi bi-file-earmark text-body-2 me-2\"></i>${dato.dato_adicional?.estado_academico ?? 'N/A'}</p>\n                        </div>\n                    ` : ``}\n                </div>\n            </div>\n            <div class=\"col-12 col-md-auto\">\n                <div class=\"row d-flex justify-content-end\">\n                    <div class=\"col-auto my-auto\">\n                        ${(() => {\n                            const etapa_id = obtenerEtapaId(dato, tipo);\n                            if (etapa_id && ESTADO_PARTICIPANTES[etapa_id]) {\n                                return ESTADO_PARTICIPANTES[etapa_id];\n                            }\n                            // Mostrar tag genérico si no hay estado específico\n                            const nombre_etapa = dato?.etapas_usuarios?.[0]?.etapa?.nombre ||\n                                               dato?.etapa_usuario?.etapa?.nombre ||\n                                               'Sin estado';\n                            return crearTag({\n                                texto: nombre_etapa,\n                                class: 'px-4 text-center text-label-1 tag-tonal-gray'\n                            });\n                        })()}\n                    </div>\n                    ${(tipo === 'detalle') ? `\n                        <div class=\"col-auto px-1 my-auto\">\n                            ${crearBoton({\n                                clases: 'btn-outline-primary btn-circle d-flex justify-content-center',\n                                texto: '<i class=\"bi bi-share my-auto\"></i>',\n                                tooltip: `${crearTooltip({ placement: 'bottom', content: 'Compartir resultados', toggle: 'popover'})}`,\n                                onclick: `abrirModalCompartirProceso(${dato.proceso.id}, ${dato.id})`\n                            })}\n                        </div>\n                    ` : ''}\n                    ${(() => {\n                        const etapa_id = obtenerEtapaId(dato, tipo);\n                        const botones = determinarBotonesAccion(etapa_id, dato);\n                        let html = '';\n\n                        // Botón Seleccionar\n                        if (botones.mostrarSeleccionar) {\n                            html += `\n                                <div class=\"col-auto px-1 my-auto\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-primary btn-circle d-flex justify-content-center',\n                                        texto: '<i class=\"bi bi-check-lg my-auto\"></i>',\n                                        tooltip: `${crearTooltip({ placement: 'bottom', content: 'Seleccionar participante', toggle: 'popover'})}`,\n                                        onclick: `seleccionarParticipante(${PROCESO.id}, ${dato.id})`,\n                                    })}\n                                </div>\n                            `;\n                        }\n\n                        // Botón Descartar\n                        if (botones.mostrarDescartar) {\n                            html += `\n                                <div class=\"col-auto px-1 my-auto\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-danger btn-circle d-flex justify-content-center',\n                                        texto: '<i class=\"bi bi-person-fill-x my-auto\"></i>',\n                                        tooltip: `${crearTooltip({ placement: 'bottom', content: 'Descartar participante', toggle: 'popover'})}`,\n                                        onclick: `descartarParticipantes(${dato.id}, '${nombre_tabla}')`,\n                                    })}\n                                </div>\n                            `;\n                        }\n\n                        // Botón Revertir Descarte\n                        if (botones.mostrarRevertir) {\n                            html += `\n                                <div class=\"col-auto px-1 my-auto\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-success btn-circle d-flex justify-content-center',\n                                        texto: '<i class=\"bi bi-person-fill-exclamation my-auto\"></i>',\n                                        tooltip: `${crearTooltip({ placement: 'bottom', content: 'Revertir descarte', toggle: 'popover'})}`,\n                                        onclick: `descartarParticipantes(${dato.id}, '${nombre_tabla}', true)`,\n                                    })}\n                                </div>\n                            `;\n                        }\n\n                        return html;\n                    })()}\n                    <div class=\"col-auto px-1 my-auto dropdown\">\n                        ${crearBoton({\n                            clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                            texto: '<i class=\"bi bi-three-dots\"></i>',\n                            adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"',\n                        })}\n                        <div class=\"dropdown-menu mt-2\">\n                            ${(tipo === 'detalle') ? `\n                                <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited no-visited\" onclick=\"abrirModalReenviarAgendamiento({id: '${dato.id}', nombre: '${dato.nombre_completo}', email: '${dato.email}', modal: true})\">\n                                    <span class=\"\">Reenviar agendamiento</span>\n                                </button></li>\n                            ` : `\n                                ${(tipo === 'tabla') ? `\n                                    <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited no-visited\" onclick=\"abrirDetalleParticipante(${dato?.id}, ${dato?.etapa_usuario?.id})\">\n                                        <span class=\"\">Ver detalle del candidato</span>\n                                    </button></li>\n                                    <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited no-visited\" onclick=\"abrirModalReenviarAgendamiento({id: '${dato.id}', nombre: '${dato.nombre_completo}', email: '${dato.email}', modal: true})\">\n                                        <span class=\"\">Reenviar agendamiento</span>\n                                    </button></li>\n                                ` : ``}\n                            `}\n\n                            ${(tipo === 'tabla') ? `\n                                <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited no-visited\" onclick=\"modalCompartirAcceso({id: '${dato.id}', nombre: '${dato.nombre_completo}', email: '${dato.email}'})\">\n                                    <span class=\"\">Compartir acceso</span>\n                                </button></li>\n                            ` : ``}\n                            <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited no-visited\" onclick=\"abrirModalMoverDeProceso({id: '${dato.id}', nombre: '${dato.nombre_completo}', email: '${dato.email}', masivo:false}, '${nombre_tabla}')\">\n                                <span class=\"\">Enviar a otros procesos</span>\n                            </button></li>\n                            <li><button type=\"button\" class=\"dropdown-item text-decoration-none no-visited no-visited\" onclick=\"eliminarParticipante(${dato.id})\">\n                                <span class=\"text-danger\">Eliminar</span>\n                            </button></li>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row mt-7 d-flex justify-content-end\">\n                    <div class=\"col-auto\">\n                        <span class=\"text-label-1 d-inline-flex align-items-center\"><i class=\"bi bi-calendar4 text-body-1 me-2\"></i>Agendamiento: ${formatearFecha((tipo === 'tabla') ? dato?.agendas?.[0]?.fecha_inicio : dato?.proceso?.agendas?.[0]?.fecha_inicio)}</span>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Renderiza la tabla de agendas.\n *\n * @param {object} dato Objeto con la información del participante.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @param {string} tipo Tipo de renderizado ('tabla' o 'detalle').\n * @returns {void}\n * @author Andres Morales\n * @author Andres Gonzalez\n * @author Esperanza Olivo\n */\nfunction crearTablaAgendas(dato, nombre_tabla, tipo = 'tabla') {\n    return `\n        <div class=\"table-responsive\">\n            <table class=\"table\" id=\"${nombre_tabla}\">\n                <thead class=\"table-light border-top border-bottom\">\n                    <tr class=\"heigth-cabecera\">\n                         ${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ? `<th class=\"text-body-3 align-content-center text-center\">\n                            ${crearCheckbox({\n                                id: `checkbox-seleccionar-todos-${nombre_tabla}`,\n                                onchange: `seleccionarTodos(this.checked, '${nombre_tabla}');`,\n                            })}\n                        </th>` :  ``}\n                         <th class=\"text-body-3 align-content-center ${(tipo === 'detalle') ? `text-center` :  `text-start ps-10`}\">Prueba</th>\n                         ${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ? `<th class=\"text-body-3 align-content-center text-center\">Peso</th>` :  ``}\n                         <th class=\"text-body-3 align-content-center text-center\">Fecha de aplicación</th>\n                         <th class=\"text-body-3 align-content-center text-center\">${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ? `Puntuacion` :  ``}</th>\n                         <th class=\"text-body-3 align-content-center text-center\">Estado</th>\n                         ${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ? `<th class=\"text-body-3 align-content-center text-center\">Reporte</th>` :  ``}\n                         ${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ? `<th class=\"text-body-3 align-content-center text-center\">Grabación</th>` :  ``}\n                         ${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ? `<th class=\"text-body-3 align-content-center text-center\">Acciones</th>` :  ``}\n                    </tr>\n                </thead>\n                <tbody>\n                    ${((tipo === 'tabla') ? dato.agendas : dato.proceso.agendas || []).map(agenda => `\n                        <tr class=\"border-bottom-1\">\n                            ${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ? `<td class=\"text-center\">\n                                ${(() => {\n                                    if (!window[nombre_tabla + '_ids']) {\n                                        window[nombre_tabla + '_ids'] = [];\n                                    }\n                                    if (!window[nombre_tabla + '_seleccionados']) {\n                                        window[nombre_tabla + '_seleccionados'] = [];\n                                    }\n\n                                    window[nombre_tabla + '_ids'].push(agenda);\n                                    let checked = false;\n                                    if (window[nombre_tabla + '_seleccionados'].some(item => item.id == dato.id)) {\n                                        checked = true;\n                                    }\n\n                                    return crearCheckbox({\n                                        value: agenda?.id,\n                                        checked: checked,\n                                        onchange: `seleccionarElemento(this.value, this.checked, '${nombre_tabla}', '${tipo}');`,\n                                    });\n                                })()}\n                            </td>` :  ``}\n                            <td class=\"align-content-center ${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ? `text-center` :  `text-start ps-5`}\">\n                                <div class=\"row\">\n                                    <div class=\"col-auto my-auto\">\n                                        <img src=\"/imagenes/logos/pruebas/${agenda.prueba.slug}.png\"\n                                             class=\"rounded-circle cursor-pointer\"\n                                             width=\"40\"\n                                             height=\"40\"\n                                             alt=\"${agenda.prueba.nombre}\"\n                                             onclick=\"copiarIdAgenda(${agenda.id})\"\n                                             ${crearTooltip({placement: `top`, content: `ID Agenda: ${agenda.id}<br>Clic para copiar`, toggle: `popover`, html: true})}\n                                             style=\"cursor: pointer;\">\n                                    </div>\n                                    <div class=\"col my-auto text-start\">\n                                        <p class=\"pb-0 mb-0\">${agenda.prueba.nombre ?? ''}</p>\n                                        <p class=\"pb-0 mb-0\">Perfil: ${agenda.perfil.nombre ?? ''}</p>\n                                    </div>\n                                </div>\n                            </td>\n                            ${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ? `<td class=\"align-content-center text-center\">${agenda.prueba.procesos_pruebas[0].porcentaje + '%' }</td>` :  ``}\n                            <td class=\"align-content-center text-center\">${convertirFecha(agenda.fecha_procesamiento)}</td>\n                            ${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ?\n                                `<td class=\"align-content-center text-center\">\n                                    ${\n                                        (agenda.ajuste == null && [4, 5].includes(agenda.estado_id))\n                                            ? `${crearBoton({\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-arrow-repeat text-headline-5\"></i>',\n                                                tooltip: `${crearTooltip({placement: `top`,content: `Reenviar agendamiendo`,toggle: `popover`,})}`,\n                                                onclick: `abrirModalReenviarAgendamiento({id: '${dato.id}', nombre: '${dato.nombre_completo}', email: '${dato.email}',  id_prueba: '${agenda.prueba.id}',  modal: false})`,\n                                            })}`\n                                            : (agenda.estado_id === 3 ? `${agenda.ajuste ?? ''}` : ``)\n                                    }\n                                </td>`\n                                : ([4, 5].includes(agenda.estado_id)) ? `<td class=\"align-content-center text-center\">\n                                    ${crearBoton({\n                                        clases: 'btn-text-primary btn-circle p-2',\n                                        texto: '<i class=\"bi bi-arrow-repeat text-headline-5\"></i>',\n                                        tooltip: `${crearTooltip({placement: `top`,content: `Reenviar agendamiendo`,toggle: `popover`,})}`,\n                                        onclick: `abrirModalReenviarAgendamiento({id: '${dato.id}', nombre: '${dato.nombre_completo}', email: '${dato.email}', id_prueba: '${agenda.prueba.id}', modal: false})`,\n                                    })}\n                                </td>` : `<td class=\"align-content-center text-center\"></td>`\n                            }\n                            <td class=\"align-content-center text-center\">\n                                ${crearTagEstadoAgenda(agenda)}\n                            </td>\n                            ${(tipo === 'detalle' || nombre_tabla.includes(nombre_tabla_resultados)) ? `\n                                <td class=\"text-center\">\n                                    ${(agenda.estado_id == 3) ? crearBoton({\n                                            clases: 'btn-text-primary btn-circle p-2',\n                                            texto: '<i class=\"bi bi-file-earmark-arrow-down-fill text-headline-5\"></i>',\n                                            tooltip: `${crearTooltip({placement: `top`,content: `Ver reporte`,toggle: `popover`,})}`,\n                                            url: `/reporte-agenda/${agenda.id}`,\n                                            target: '_blank'\n                                    }) : ''}\n                                </td>\n                                <td class=\"text-center\">\n                                    ${(agenda.estado_id == 3) ? crearBoton({\n                                        clases: 'btn-text-primary btn-circle p-2',\n                                        texto: '<i class=\"bi bi-play-btn-fill text-headline-5\"></i>',\n                                        tooltip: `${crearTooltip({placement: `top`,content: `Ver grabación`,toggle: `popover`,})}`,\n                                        onclick: `abrirModalVideograbacion('${agenda.id}')`\n                                    }) : ''}\n                                </td>\n                                <td class=\"text-center\">\n                                    ${(agenda.estado_id === 1) ? crearBoton({\n                                        clases: 'btn-text-danger btn-circle p-2',\n                                        texto: '<i class=\"bi bi-trash text-headline-5\"></i>',\n                                        tooltip: `${crearTooltip({placement: `top`,content: `Eliminar agenda`,toggle: `popover`,})}`,\n                                        onclick: `eliminarAgenda(${agenda.id}, '${nombre_tabla}')`\n                                    }) : ''}\n                                    ${(agenda.estado_id === 3) ? crearBoton({\n                                        clases: 'btn-text-warning btn-circle p-2 ms-1',\n                                        texto: '<i class=\"bi bi-arrow-clockwise text-headline-5\"></i>',\n                                        tooltip: `${crearTooltip({placement: `top`,content: `Reprocesar agenda`,toggle: `popover`,})}`,\n                                        onclick: `reprocesarAgenda(${agenda.id}, '${nombre_tabla}')`\n                                    }) : ''}\n                                </td>\n                            ` : ''}\n                        </tr>\n                    `).join('')}\n                </tbody>\n            </table>\n        </div>\n    `;\n}\n\n/**\n * Abrir el documento del reporte comparativo en una pestaña nueva.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Sergio Vargas\n */\nfunction descargarReporteComprartivo(nombre_tabla = nombre_tabla_participantes) {\n    let _token = encodeURIComponent($('input[name=\"_token\"]').val());\n    let proceso_id = encodeURIComponent(PROCESO.id);\n    let evaluados_ids = window[nombre_tabla + '_seleccionados'].map(evaluado => {\n        return `evaluados_ids${encodeURIComponent('[]')}=${encodeURIComponent(evaluado.id)}`;\n    }).join('&');\n\n    window.open(\n        `/reportes-generar-comparativo?_token=${_token}&proceso_id=${proceso_id}&${evaluados_ids}`,\n        '_blank'\n    );\n}\n\n/**\n * Eliminar una agenda con confirmación.\n *\n * @param {number} agenda_id ID de la agenda\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction eliminarAgenda(agenda_id, nombre_tabla) {\n    Swal.fire({\n        title: '¿Estás seguro?',\n        text: \"Esta acción eliminará permanentemente la agenda. No se puede deshacer.\",\n        icon: 'warning',\n        showCancelButton: true,\n        confirmButtonColor: '#d33',\n        cancelButtonColor: '#3085d6',\n        confirmButtonText: 'Sí, eliminar',\n        cancelButtonText: 'Cancelar'\n    }).then((result) => {\n        if (result.isConfirmed) {\n            $.ajax({\n                url: `/agendas/${agenda_id}`,\n                type: 'DELETE',\n                data: {\n                    _token: $('input[name=\"_token\"]').val()\n                },\n                success: function(respuesta) {\n                    mostrarToast('success', respuesta.message || 'Agenda eliminada correctamente.');\n\n                    if ($('#modal-detalle-participante').hasClass('show')) {\n                        let participante_id = $('#modal-detalle-participante').data('participante-id');\n                        let etapa_id = $('#modal-detalle-participante').data('etapa-id') || 0;\n                        if (participante_id) {\n                            abrirDetalleParticipante(participante_id, etapa_id);\n                        }\n                    }\n\n                    if (typeof actualizarDatatables === 'function') {\n                        actualizarDatatables(nombre_tabla_participantes);\n                        if (typeof nombre_tabla_resultados !== 'undefined') {\n                            actualizarDatatables(nombre_tabla_resultados);\n                        }\n                    }\n                },\n                error: function(xhr) {\n                    let mensaje = 'Error al eliminar la agenda.';\n                    if (xhr.responseJSON && xhr.responseJSON.message) {\n                        mensaje = xhr.responseJSON.message;\n                    }\n                    mostrarToast('danger', mensaje);\n                }\n            });\n        }\n    });\n}\n\n/**\n * Reprocesar una agenda finalizada.\n *\n * @param {number} agenda_id ID de la agenda\n * @param {string} nombre_tabla Nombre de la tabla\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction reprocesarAgenda(agenda_id, nombre_tabla) {\n    Swal.fire({\n        title: '¿Reprocesar agenda?',\n        text: \"Esta acción volverá a procesar los resultados de la agenda.\",\n        icon: 'question',\n        showCancelButton: true,\n        showDenyButton: true,\n        confirmButtonColor: '#3085d6',\n        denyButtonColor: '#28a745',\n        cancelButtonColor: '#6c757d',\n        confirmButtonText: 'Solo reprocesar',\n        denyButtonText: 'Reprocesar y enviar correo',\n        cancelButtonText: 'Cancelar'\n    }).then((result) => {\n        if (result.isConfirmed || result.isDenied) {\n            const enviar_correo = result.isDenied;\n\n            $.ajax({\n                url: `/agendas-reprocesar/${agenda_id}`,\n                type: 'POST',\n                data: {\n                    enviar_notificacion_correo: enviar_correo,\n                    _token: $('meta[name=\"csrf-token\"]').attr('content')\n                },\n                success: function(respuesta) {\n                    if (respuesta.message) {\n                        mostrarToast('success', respuesta.message);\n                        if (nombre_tabla) {\n                            actualizarDatatables(nombre_tabla);\n                            actualizarDatatables(nombre_tabla_resultados);\n                        }\n                    }\n                },\n                error: function(xhr) {\n                    let mensaje = 'Error al reprocesar la agenda.';\n                    if (xhr.responseJSON && xhr.responseJSON.message) {\n                        mensaje = xhr.responseJSON.message;\n                    }\n                    mostrarToast('danger', mensaje);\n                }\n            });\n        }\n    });\n}\n\n/**\n * Copiar ID de agenda al portapapeles.\n *\n * @param {number} agenda_id ID de la agenda\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction copiarIdAgenda(agenda_id) {\n    if (navigator.clipboard && window.isSecureContext) {\n        // Método moderno para navegadores compatibles con Clipboard API\n        navigator.clipboard.writeText(agenda_id.toString()).then(() => {\n            mostrarToast('success', `ID de agenda ${agenda_id} copiado al portapapeles`);\n        }).catch(() => {\n            // Fallback si falla la API moderna\n            copiarTextoFallback(agenda_id.toString());\n        });\n    } else {\n        // Fallback para navegadores antiguos\n        copiarTextoFallback(agenda_id.toString());\n    }\n}\n\n/**\n * Función fallback para copiar texto en navegadores que no soportan Clipboard API.\n *\n * @param {string} texto Texto a copiar\n * @returns {void}\n * @author Claude Code\n */\nfunction copiarTextoFallback(texto) {\n    const textArea = document.createElement('textarea');\n    textArea.value = texto;\n    textArea.style.position = 'fixed';\n    textArea.style.opacity = '0';\n    document.body.appendChild(textArea);\n    textArea.focus();\n    textArea.select();\n\n    try {\n        const exitoso = document.execCommand('copy');\n        if (exitoso) {\n            mostrarToast('success', `ID de agenda ${texto} copiado al portapapeles`);\n        } else {\n            mostrarToast('warning', 'No se pudo copiar el ID. Selecciona y copia manualmente.');\n        }\n    } catch (error) {\n        mostrarToast('danger', 'Error al copiar el ID de agenda.');\n    }\n\n    document.body.removeChild(textArea);\n}\n\n/**\n * Función global para aplicar filtros dropdown - redirige a la función específica de cada tabla.\n *\n * @param {string} filtro ID del elemento html del filtro\n * @param {Object} filtros Filtros aplicados\n * @returns {void}\n * @author Andres Morales\n */\nfunction aplicarFiltrosDropdown(filtro, filtros) {\n    if (filtro === `filtro_${nombre_tabla_participantes}`) {\n        window[nombre_tabla_participantes + '_filtros'] = filtros;\n        actualizarDatatables(nombre_tabla_participantes);\n    } else if (filtro === `filtro_${nombre_tabla_resultados}`) {\n        window[nombre_tabla_resultados + '_filtros'] = filtros;\n        actualizarDatatables(nombre_tabla_resultados);\n    }\n}\n\n/**\n * Seleccionar o deseleccionar todos los participantes.\n *\n * @param {boolean} checked Chequear o deschequear.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Andres Morales\n */\nasync function seleccionarTodos(checked, nombre_tabla) {\n    window[nombre_tabla + '_seleccionados'] = [];\n    if (checked) {\n        for (let i = 0; i < window[nombre_tabla + '_ids'].length; i++) {\n            window[nombre_tabla + '_seleccionados'].push(window[nombre_tabla + '_ids'][i]);\n        }\n    }\n    if ($(`#${nombre_tabla}`).hasClass('dataTable')) {\n        actualizarDatatables(nombre_tabla);\n    } else {\n        $(`#${nombre_tabla}`).find('input[type=\"checkbox\"]').prop('checked', checked);\n    }\n    validarSeleccionados(nombre_tabla);\n}\n\n/**\n * Selecciona o deselecciona un participante\n *\n * @param {int} id_entrante Id seleccionado.\n * @param {boolean} checked Chequear o deschequear.\n * @param {string} nombre_tabla Nombre de la tabla.\n * @param {string} tipo Tipo de renderizado ('tabla' o 'detalle').\n * @returns {void}\n * @author Andres Morales\n */\nfunction seleccionarElemento(id_entrante, checked, nombre_tabla, tipo = 'tabla') {\n    if (checked) {\n        if (!window[nombre_tabla + '_seleccionados'].some(item => item.id == id_entrante)) {\n            let objeto = window[nombre_tabla + '_ids'].find(item => item.id == id_entrante);\n            if (objeto) {\n                window[nombre_tabla + '_seleccionados'].push(objeto);\n            }\n        }\n    } else {\n        window[nombre_tabla + '_seleccionados'] = window[nombre_tabla + '_seleccionados'].filter(item => item.id != id_entrante);\n    }\n    validarSeleccionados(nombre_tabla);\n    if ($(`#${nombre_tabla}`).hasClass('dataTable')) {\n        if (tipo === 'detalle') {\n            actualizarDatatables(nombre_tabla);\n        }\n    }\n}\n\n/**\n * Validar los participantes seleccionados.\n *\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Andres Morales\n * @author Andres Gonzalez\n */\nfunction validarSeleccionados(nombre_tabla) {\n    if (window[nombre_tabla + '_seleccionados'].length == 0) {\n        $(`#descargar-excel_${nombre_tabla}`).html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`);\n        $(`#checkbox-seleccionar-todos-${nombre_tabla}`).prop('indeterminate', false);\n        $(`#checkbox-seleccionar-todos-${nombre_tabla}`).prop('checked', false);\n    } else if (window[nombre_tabla + '_seleccionados'].length == window[nombre_tabla + '_ids'].length) {\n        $(`#descargar-excel_${nombre_tabla}`).html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n        $(`#checkbox-seleccionar-todos-${nombre_tabla}`).prop('indeterminate', false);\n        $(`#checkbox-seleccionar-todos-${nombre_tabla}`).prop('checked', true);\n    } else {\n        $(`#descargar-excel_${nombre_tabla}`).html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n        $(`#checkbox-seleccionar-todos-${nombre_tabla}`).prop('indeterminate', true);\n    }\n    habilitarBotonesAcciones(nombre_tabla);\n    $(`#${nombre_tabla}-seleccionados-total`).text('Seleccionado: ' + window[nombre_tabla + '_seleccionados'].length);\n}\n\n/**\n * Habilitar o deshabilitar los botones de acciones masivas.\n *\n * @param {string} nombre_tabla Nombre de la tabla.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Andres Morales\n * @author Sergio Vargas\n */\nfunction habilitarBotonesAcciones(nombre_tabla) {\n    const HABILITADO = window[nombre_tabla + '_seleccionados'].length > 0;\n\n    var hay_descartados = false;\n    if (HABILITADO) {\n        hay_descartados = window[nombre_tabla + '_seleccionados'].some(function(participante) {\n            return participante.etapa_usuario && participante.etapa_usuario.etapa_id === 11;\n        });\n    }\n\n    var hay_agendas_reenviables = false;\n    if (HABILITADO) {\n        hay_agendas_reenviables = window[nombre_tabla + '_seleccionados'].some(function(participante) {\n            return !(participante.etapa_usuario && participante.etapa_usuario.etapa_id === 11) && !(participante.etapa_usuario && participante.etapa_usuario.etapa_id === 10);\n        });\n    }\n\n    var todos_tienen_agendas_finalizadas = false;\n    if (HABILITADO) {\n        todos_tienen_agendas_finalizadas = window[nombre_tabla + '_seleccionados'].every(function(participante) {\n            return participante.agendas &&\n                   participante.agendas.length > 0 &&\n                   participante.agendas.some(agenda => agenda.estado.id === 3);\n        });\n    }\n\n    $(`#boton-descartar_${nombre_tabla}`).prop('disabled', !HABILITADO || hay_descartados);\n    $(`#boton-mover-proceso_${nombre_tabla}`).prop('disabled', !HABILITADO);\n    $(`#boton-reenviar-agenda_${nombre_tabla}`).prop('disabled', !HABILITADO || !hay_agendas_reenviables);\n    $(`#boton-ia_${nombre_tabla}`).prop('disabled', !HABILITADO);\n    $(`#boton-reporte-comparativo_${nombre_tabla}`).prop('disabled',\n        window[nombre_tabla + '_seleccionados'].length < 2 || !todos_tienen_agendas_finalizadas);\n}\n\n/**\n * Reenviar agendamiento.\n *\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n * @author Andres Morales\n * @author Sergio Vargas\n * @author Jair Carvajal\n */\nasync function reenviarAgendamiento() {\n    const ID         = $('#participante_id_reagendar').val();\n    const FORMULARIO = $('#formulario-reagendar');\n    const DATOS = new FormData(FORMULARIO[0]);\n\n    ['capturar_camara', 'capturar_video', 'vigencia_pruebas', 'pruebas', 'dias_vencimiento_agendas', 'fecha_vencimiento_agendas'].forEach(campo => {\n        DATOS.delete(campo);\n    });\n\n    DATOS.append('_token', $('input[name=\"_token\"]').val());\n    DATOS.append('proceso_id', PROCESO.id);\n\n    // Agregar el campo de cantidad de días o fecha límite, según el caso\n    if ($('#modal-reagendar #es_fecha').prop('checked') == 1) {\n        DATOS.append('fecha_vencimiento_agendas',($('#modal-reagendar #fecha_vencimiento_agendas').val()).replace(\" \", \"T\"));\n        if (!$('#modal-reagendar #fecha_vencimiento_agendas').val()) { mostrarToast('danger', 'Debe ingresar una fecha de vencimiento.');return; }\n    } else if ($('#modal-reagendar #es_dias').prop('checked') == 1) {\n        DATOS.append('dias_vencimiento_agendas', $('#modal-reagendar #dias_vencimiento_agendas').val());\n        if (!$('#modal-reagendar #dias_vencimiento_agendas').val()) { mostrarToast('danger', 'Debe ingresar cantidad de dias.');return; }\n    }\n\n    DATOS.append('capturar_camara', $('#capturar_camara_reenviar').prop('checked') ? 1 : 0);\n    DATOS.append('capturar_video', $('#capturar_video_reenviar').prop('checked') ? 1 : 0);\n\n    if (ID !== null && window[nombre_tabla_participantes + '_seleccionados'].length === 0) {\n        window[nombre_tabla_participantes + '_seleccionados'] = [{id: ID}];\n    }\n\n    DATOS.append('participantes', JSON.stringify(window[nombre_tabla_participantes + '_seleccionados'].map(objeto => objeto.id)));\n    if (pruebas_seleccionadas.length === 0) {\n        $('.prueba_seleccionar_reenvio').addClass('invalid');\n        mostrarToast('danger', 'Debe seleccionar al menos una prueba.');\n        return;\n    }\n    DATOS.append('pruebas', JSON.stringify(pruebas_seleccionadas));\n    DATOS.append('empresa_id', dato_empresa.id);\n\n    await $.ajax({\n        url        : `/participantes-reagendar`,\n        type       : 'POST',\n        data       : DATOS,\n        contentType: false,\n        processData: false\n    }).done(function (respuesta) {\n        if ($('#participantes-tap').hasClass('active')) {\n            window[nombre_tabla_participantes + '_seleccionados'] = [];\n            actualizarDatatables(nombre_tabla_participantes);\n            validarSeleccionados(nombre_tabla_participantes);\n        }\n        if ($('#resultados-tap').hasClass('active')) {\n            window[nombre_tabla_resultados + '_seleccionados'] = [];\n            actualizarDatatables(nombre_tabla_resultados);\n            validarSeleccionados(nombre_tabla_resultados);\n        }\n\n        $('#modal-reagendar').modal('hide');\n\n        mostrarToast('success', respuesta.message);\n\n        if (respuesta.advertencias && respuesta.advertencias.length > 0) {\n            mostrarModalAdvertenciasReagendamiento(respuesta);\n        }\n\n    }).fail(function (error) {\n        let msg = 'Error al reenviar agendamiento';\n        if (error && error.responseJSON) {\n            const e = error.responseJSON;\n            if (e.errors !== undefined && e.errors !== null) {\n                if (typeof e.errors === 'string') {\n                    msg = e.errors;\n                } else if (Array.isArray(e.errors)) {\n                    msg = e.errors.join(' ');\n                } else if (typeof e.errors === 'object') {\n                    try {\n                        const vals = Object.values(e.errors).map(v => Array.isArray(v) ? v.join(' ') : v);\n                        msg = vals.join(' ');\n                    } catch (_) {}\n                }\n            } else if (e.message) {\n                msg = e.message;\n            }\n        }\n        mostrarToast('danger', msg);\n    });\n}\n\n/**\n * Abrir modal para reenviar agendamiento.\n *\n * @param {array} informacion array con la información del participante.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Andres Morales\n * @author Sergio Vargas\n * @author Esperanza Olivo\n */\nfunction abrirModalReenviarAgendamiento(informacion) {\n    if (!informacion.masivo) {\n        pruebas_seleccionadas = [];\n    }\n\n    $('.prueba_seleccionar_reenvio').removeClass('selected invalid');\n\n    if (informacion.id_prueba) {\n        const PRUEBA_SELECCIONADA = $(`.prueba_seleccionar_reenvio[data-id=\"${informacion.id_prueba}\"]`);\n\n        if (PRUEBA_SELECCIONADA.length) {\n            PRUEBA_SELECCIONADA.addClass('active');\n            PRUEBA_SELECCIONADA.addClass('selected');\n            pruebas_seleccionadas.push(informacion.id_prueba);\n        }\n    }\n\n    $(\"#total-seleccionadas\").text(pruebas_seleccionadas.length);\n\n    $('#email_reenviar').val('');\n\n    $('#detalle-reagendar_unitario').show();\n\n    if (informacion.modal) {\n        $('#modal-detalle-participante').modal('hide');\n    }\n\n    if (informacion.id && informacion.nombre) {$('#modal-reagendar #nombre_persona_mover').html(`ID ${informacion.id} - ${informacion.nombre}`);}\n\n    if (![null, undefined, ''].includes(informacion.id)) {\n        $('#participante_id_reagendar').val(informacion.id);\n    }\n\n    if (![null, undefined, ''].includes(informacion.email)) {\n        $('#email_reenviar').val(informacion.email);\n    }\n\n    if (window[nombre_tabla_participantes + '_seleccionados'].length > 1) {\n        $('#detalle-reagendar_unitario').hide();\n    }\n\n    if (PROCESO.dias_vencimiento_agendas) {\n        // CASO 1: El proceso usa días - mantener días\n        $('#modal-reagendar #es_fecha').prop('checked', false).trigger('change');\n        $('#modal-reagendar #fecha_vencimiento_agendas').val(null);\n        $('#modal-reagendar #es_dias').prop('checked', true).trigger('change');\n        $('#modal-reagendar #dias_vencimiento_agendas').val(PROCESO.dias_vencimiento_agendas);\n    } else if (PROCESO.fecha_vencimiento_agendas) {\n        // CASO 2: El proceso usa fecha específica\n        $('#modal-reagendar #es_dias').prop('checked', false).trigger('change');\n        $('#modal-reagendar #dias_vencimiento_agendas').val(null);\n        $('#modal-reagendar #es_fecha').prop('checked', true).trigger('change');\n\n        // Verificar si la fecha del proceso es futura o pasada\n        const fecha_proceso = new Date(PROCESO.fecha_vencimiento_agendas);\n        const fecha_actual = new Date();\n\n        if (fecha_proceso > fecha_actual) {\n            // Fecha futura: usar la fecha del proceso\n            $('#modal-reagendar #fecha_vencimiento_agendas').val(PROCESO.fecha_vencimiento_agendas);\n        } else {\n            // Fecha pasada: usar 1 día desde hoy\n            const fecha_futura = new Date();\n            fecha_futura.setDate(fecha_futura.getDate() + 1);\n            const fecha_futuraISO = fecha_futura.toISOString().slice(0, 16);\n            $('#modal-reagendar #fecha_vencimiento_agendas').val(fecha_futuraISO);\n        }\n    }\n\n    $('#modal-reagendar').modal('show');\n    $(document).find('[role=\"tooltip\"]').remove();\n}\n\n/**\n * Eliminar un participante del proceso.\n *\n * @param {number} id ID del participante.\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n * @author Andres Morales\n */\nfunction eliminarParticipante(id) {\n    Swal.fire({\n        showCloseButton: true,\n        closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n        showConfirmButton: false,\n        showDenyButton: false,\n        showCancelButton: false,\n        html: `\n            <div class=\"row w-100 mx-0 mt-2\">\n                <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">¿Estás seguro?</div>\n                <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">El participante será eliminado permanentemente del proceso.</div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-outline-primary w-100 justify-content-center',\n                        texto: 'Cancelar',\n                        onclick:`Swal.close();`\n                    })}\n                </div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-danger w-100 justify-content-center',\n                        texto: 'Eliminar',\n                        onclick:`Swal.clickConfirm();`\n                    })}\n                </div>\n            </div>\n        `,\n    }).then(async (result) => {\n        if (result.isConfirmed) {\n            await $.ajax({\n                url : `/participantes-eliminar/${PROCESO.id}/${id}`,\n                type: 'POST',\n                data: {\n                    _token : $('input[name=\"_token\"]').val(),\n                    _method: 'DELETE'\n                }\n            }).done(function (respuesta) {\n                mostrarToast('success', respuesta.message);\n                actualizarDatatables(nombre_tabla_participantes);\n            }).fail(function (error) {\n                mostrarToast('danger', 'No se puede eliminar un participante con agendas finalizadas.');\n            });\n        }\n    });\n}\n\n/**\n * Descartar uno o más participantes.\n *\n * Si no se recibe el ID de algún participante en específico, se descartarán todos los participantes seleccionados.\n *\n * @param {number|null} id ID del participante.\n * @param {string} nombre_tabla Nombre de la tabla de participantes.\n * @param {boolean} revertir Indica si se debe revertir el descarte.\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n * @author Andres Morales\n */\nasync function descartarParticipantes(id, nombre_tabla, revertir = false) {\n    Swal.fire({\n        showCloseButton: true,\n        closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n        showConfirmButton: false,\n        showDenyButton: false,\n        showCancelButton: false,\n        html: `\n            <div class=\"row w-100 mx-0 mt-2\">\n                <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">¿Estás seguro?</div>\n                <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">${revertir ? 'El participante volvera al proceso de pruebas' : 'El participante será descartado permanentemente del proceso.'}</div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-outline-primary w-100 justify-content-center',\n                        texto: 'Cancelar',\n                        onclick:`Swal.close();`\n                    })}\n                </div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: `${revertir ? 'btn-warning' : 'btn-danger'} w-100 justify-content-center`,\n                        texto: `${revertir ? 'Revertir Descarte' : 'Descartar'}`,\n                        onclick:`Swal.clickConfirm();`\n                    })}\n                </div>\n            </div>\n        `,\n    }).then(async (result) => {\n        if (result.isConfirmed) {\n            let participantes_seleccionados = [];\n            if (id !== null) {\n                participantes_seleccionados = [id];\n            } else {\n                participantes_seleccionados = window[nombre_tabla + '_seleccionados'].map(objeto => objeto.id);\n            }\n\n            await $.ajax({\n                url : `/participantes-descartar`,\n                type: 'POST',\n                data: {\n                    _token       : $('input[name=\"_token\"]').val(),\n                    id           : PROCESO.id,\n                    participantes: participantes_seleccionados\n                }\n            }).done(function (respuesta) {\n                window[nombre_tabla + '_seleccionados'] = [];\n                habilitarBotonesAcciones(nombre_tabla);\n                mostrarToast('success', respuesta.message);\n                actualizarDatatables(nombre_tabla);\n                if ($('#modal-detalle-participante').hasClass('show')) {\n                    $('#modal-detalle-participante').modal('hide');\n                }\n            }).fail(function () {\n                mostrarToast('danger', 'Error al descartar el participante.');\n            });\n        }\n    });\n}\n\n/**\n * Obtener la información de un participante.\n *\n * @param {number} id ID del participante.\n * @returns {Promise<Object>}\n * @author Daniel Beltrán\n * @author Andres Morales\n */\nasync function obtenerParticipante(id) {\n    let datos = {};\n\n    await $.ajax({\n        url : `/procesos-detalles-participante`,\n        data: {\n            _token: $('input[name=\"_token\"]').val(),\n            proceso_id: PROCESO.id,\n            participante_id: id\n        },\n        type: 'GET'\n    }).done(function (respuesta) {\n        datos = respuesta.data;\n        dato_empresa = respuesta.empresa;\n    }).fail(function (error) {\n        mostrarToast('danger', error.responseJSON?.message || 'Error al abrir el detalle del participante.');\n    });\n\n    return datos;\n}\n\n/**\n * Abrir el detalle de un participante.\n *\n * @param {number} id ID del participante.\n * @param {number} etapa Etapa del usuario\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n * @author Jair Carvajal\n * @author Andres Morales\n * @author Esperanza Olivo\n */\nasync function abrirDetalleParticipante(id, etapa = 0) {\n    $('#detalle-participante').empty('');\n    let datos = await obtenerParticipante(id);\n    if (!datos) { return; }\n    let usuario = datos.participante;\n    usuario.procesos_activos = datos.procesos_activos;\n    usuario.proceso = datos.proceso;\n    usuario.etapa_entrada = etapa;\n    usuario.empresa = datos.empresa;\n    usuario.etapa_usuario = datos.etapa_usuario;\n\n    $('#detalle-participante').append(`\n        <div class=\"card mb-4\">\n            <div class=\"card-body\">\n                ${crearInformacionParticipante(usuario, nombre_tabla_participantes, 'detalle')}\n            </div>\n        </div>\n        ${crearTabsHorizontal({\n            id: 'detalle-candidato',\n            tabs: [\n                {\n                    id: 'informacion',\n                    titulo: `Información`,\n                    contenido: `\n                        ${informacionProcesos(usuario)}\n                    `,\n                    activo: true,\n                },\n                {\n                    id: 'resultados-2',\n                    titulo: `Resultados`,\n                    contenido: `\n                        <div class=\"btn-descargar-detalle-tabla d-none\">\n                            ${crearBoton({\n                                clases: 'btn-outline-primary ms-2',\n                                texto: `<i class=\"bi bi-download text-body-1 me-3 my-auto\"></i> Descargar reportes`,\n                            })}\n                        </div>\n                        <div class=\"row\">\n                            ${contenidoResultados(usuario, 'modal')}\n                        </div>\n                    `,\n                },\n            ]\n        })}\n\n    `);\n\n    $('#modal-detalle-participante').data('participante-id', id);\n    $('#modal-detalle-participante').data('etapa-id', etapa);\n    $('#modal-detalle-participante').modal('show');\n    $(document).find('[role=\"tooltip\"]').remove();\n    obtenerIndiceTalento(usuario.proceso.id, usuario.id, usuario.documento, 'modal');\n    inicializarTooltips();\n    $('[data-bs-toggle=\"tooltip\"]').tooltip();\n    mostrarEncuestaConsultaResultados();\n}\n\n/**\n * Obtiene el índice de talento del participante\n *\n * @param {int} proceso_id ID del proceso\n * @param {int} usuario_id ID del usuario\n * @param {string} documento Documento del usuario\n * @param {string} tipo Tipo de visualización ('tabla' o 'detalle')\n * @returns {void}\n * @author Andres Morales\n */\nasync function obtenerIndiceTalento(proceso_id, usuario_id, documento, tipo = 'tabla') {\n    await $.ajax({\n        url: `/procesos-indice-talento/${proceso_id}/${usuario_id}`,\n        type: 'GET',\n        data: {\n            _token: $('input[name=\"_token\"]').val(),\n        }\n    }).done(function(respuesta) {\n        let indice_talento = respuesta.data.indice_talento;\n        if (indice_talento > 0) {\n            indice_talento = crearTag({ texto: indice_talento + '%', class: 'px-2 text-center text-label-1 tag-filled-' + calcularColorIndiceTalento(indice_talento)});\n        } else {\n            indice_talento = crearTag({ texto: 'Faltan resultados', class: 'px-2 text-center text-label-1 tag-filled-gray disabled'});\n        }\n        $(`#indice-talento_${tipo}_${documento}`).html(`\n            <span class=\"text-label-1 my-auto me-2\">Índice de talento</span>\n            ${indice_talento}\n        `);\n    }).fail(function() {\n        $(`#indice-talento_${tipo}_${documento}`).html(`\n            <span class=\"text-label-1 my-auto me-2\">Índice de talento</span>\n            ${crearTag({ texto: 'Faltan resultados', class: 'px-2 text-center text-label-1 tag-filled-gray disabled'})}\n        `);\n    });;\n}\n\n\n/**\n * Crea la información de los procesos activos del usuario.\n *\n * @param {Object} usuario Datos del usuario.\n * @returns {string} HTML con la información de los procesos activos.\n * @author Andres Morales\n */\nfunction informacionProcesos(usuario) {\n    let informacion_procesos = `\n        <div class=\"card my-5\">\n            <div class=\"card-body\">\n                <div class=\"d-flex align-items-center mb-5\">\n                    <h5 class=\"mb-0\">Procesos activos</h5>\n                    <span class=\"badge rounded-3 bg-gray-80 text-dark px-3 py-2 ms-2\">${usuario.procesos_activos.length}</span>\n                </div>\n    `;\n\n    usuario.procesos_activos.forEach(proceso => {\n        informacion_procesos += `\n            <div class=\"card mb-3\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"mb-1 text-body-2\">Empresa: ${proceso.empresa.razon_social}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <h6 class=\"d-inline text-headline-5 text-decoration-underline\">${proceso.nombre}</h6>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            ${ESTADOS_PROCESOS[proceso.estado_id]}\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto text-label-1\">\n                            <p class=\"d-inline-flex align-items-centers text-lavbel-1 mb-0\">\n                                <i class=\"bi bi-calendar4 me-2 text-headline-5\"></i> Agendamiento: ${formatearFecha(proceso.agendas[0]?.fecha_inicio)}\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n\n    informacion_procesos += `</div></div>`;\n    return informacion_procesos;\n}\n\n/**\n * Crea la información de los resultados de las pruebas del participante.\n *\n * @param {Object} usuario Datos del participante.\n * @param {string} tap Pestaña de visualización datatable o modal.\n * @returns {string} HTML con la información de los resultados de las pruebas.\n * @author Andres Morales\n */\nfunction contenidoResultados(usuario, tap) {\n    return `\n         <div class=\"col-12 mt-5\">\n            <div class=\"accordion\" id=\"acorderonResultados${tap}\">\n                <div class=\"accordion-item\">\n                    <h2 class=\"accordion-header\">\n                        <button class=\"accordion-button shadow-none text-body-1\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapsePruebas${tap}\" aria-expanded=\"true\" aria-controls=\"collapsePruebas${tap}\">\n                            <div class=\"row w-100 pe-3\">\n                                <div class=\"col-auto px-1 my-auto\">\n                                    Pruebas psicométricas\n                                </div>\n                                <div class=\"col-auto my-auto ms-auto d-flex\" id=\"indice-talento_${tap}_${usuario.documento}\">\n                                    <span class=\"text-label-1 my-auto me-2\">Índice de talento</span>\n                                </div>\n                                <div ${crearTooltip({ placement: `bottom`, content: 'Descargar reportes', toggle: `popover`,})} class=\"btn py-2 btn-outline-primary bg-transparent btn-circle me-3\" data-nombre-tabla=\"tabla_detalle_acordeon_${usuario.documento}\" id=\"boton-descargar-reportes_tabla_detalle_acordeon_${usuario.documento}\">\n                                    <i class=\"bi bi-download\"></i>\n                                </div>\n                            </div>\n                        </button>\n                    </h2>\n                    <div id=\"collapsePruebas${tap}\" class=\"accordion-collapse collapse show\" data-bs-parent=\"#acorderonResultados${tap}\">\n                        <div class=\"accordion-body\">\n                            ${crearTablaAgendas(usuario, `tabla_detalle_acordeon_${usuario.documento}`, 'detalle')}\n                        </div>\n                    </div>\n                </div>\n                <div class=\"accordion-item d-none\">\n                    <h2 class=\"accordion-header\">\n                        <button class=\"accordion-button shadow-none text-body-1 collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseEntrevista${tap}\" aria-expanded=\"false\" aria-controls=\"collapseEntrevista${tap}\">\n                            <div class=\"row w-100 pe-3\">\n                                <div class=\"col-auto px-1 my-auto\">\n                                    Entrevista final\n                                </div>\n                                <div class=\"col-auto my-auto ms-auto d-flex\">\n                                    <span class=\"text-label-1 my-auto -bottom-3 me-2\">Índice de talento</span>\n                                    ${crearTag({ texto: '89%', class: 'px-2 text-center text-label-1 tag-filled-green'})}\n                                </div>\n                            </div>\n                        </button>\n                    </h2>\n                    <div id=\"collapseEntrevista${tap}\" class=\"accordion-collapse collapse\" data-bs-parent=\"#acorderonResultados${tap}\">\n                        <div class=\"accordion-body\">\n                            <div class=\"d-flex align-items-center\">\n                                <img src=\"/imagenes/plantilla/image-user.png\" width=\"72px\" height=\"72px\" class=\"rounded-circle me-3\" alt=\"Entrevistador\">\n                                <div>\n                                    <p class=\"mb-0 text-body-2 text-gray-30\"><span class=\"text-gray-10\">Entrevistador:</span> Dana Rodríguez</p>\n                                    <p class=\"mb-0 text-body-2 text-gray-30\"><span class=\"text-gray-10\">Formato:</span> Diseñadores UX</p>\n                                    <p class=\"mb-0 text-body-2 text-gray-30\"><span class=\"text-gray-10\">Fecha y hora:</span> 11/Dic/2024 - 10:15 AM</p>\n                                </div>\n                            </div>\n                            <div class=\"border rounded p-3 mt-3\">\n                                <h6 class=\"text-primary mb-6\"><i class=\"bi bi-link-45deg\"></i> Formato de entrevista</h6>\n                                <div class=\"row\">\n                                    <div class=\"col-md-4 mb-3\">\n                                        <p class=\"mb-0 text-body-2 text-gray-10\">Nacionalidad:</p>\n                                        <p class=\"mb-0 text-body-2 text-gray-30\">Colombiana</p>\n                                    </div>\n                                    <div class=\"col-md-4 mb-3\">\n                                        <p class=\"mb-0 text-body-2 text-gray-10\">Documento:</p>\n                                        <p class=\"mb-0 text-body-2 text-gray-30\">CC - 18282371231</p>\n                                    </div>\n                                    <div class=\"col-md-4 mb-3\">\n                                        <p class=\"mb-0 text-body-2 text-gray-10\">Fecha Exp:</p>\n                                        <p class=\"mb-0 text-body-2 text-gray-30\">30-Nov-2014</p>\n                                    </div>\n                                    <div class=\"col-md-4 mb-3\">\n                                        <p class=\"mb-0 text-body-2 text-gray-10\">Estado civil:</p>\n                                        <p class=\"mb-0 text-body-2 text-gray-30\">Soltero/a</p>\n                                    </div>\n                                    <div class=\"col-md-4 mb-3\">\n                                        <p class=\"mb-0 text-body-2 text-gray-10\">Número de hijos:</p>\n                                        <p class=\"mb-0 text-body-2 text-gray-30\">1</p>\n                                    </div>\n                                    <div class=\"col-md-4 mb-3\">\n                                        <p class=\"mb-0 text-body-2 text-gray-10\">Edad hijos:</p>\n                                        <p class=\"mb-0 text-body-2 text-gray-30\">2 años</p>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"mt-3\">\n                                <label class=\"text-body-2 mb-3\">Pregunta 1</label>\n                                <div class=\"col-12 px-1\">\n                                    ${crearInput({\n                                        autocomplete: 'off',\n                                        id: 'pregunta_1',\n                                        name: 'pregunta_1',\n                                        type: 'texto',\n                                        value: '¿Cuál fue tu mayor logro en tu puesto anterior?',\n                                        maxlength: 150,\n                                        class: 'clase-personalizada',\n                                        label: 'Pregunta',\n                                    })}\n                                </div>\n                            </div>\n                            <div class=\"mt-3\">\n                                <label class=\"text-body-2 mb-3\">Pregunta 2</label>\n                                <div class=\"col-12 px-1\">\n                                    ${crearInput({\n                                        autocomplete: 'off',\n                                        id: 'pregunta_2',\n                                        name: 'pregunta_2',\n                                        type: 'texto',\n                                        value: '¿Qué herramientas o tecnologías dominas que crees que son clave para este puesto?',\n                                        maxlength: 150,\n                                        class: 'clase-personalizada',\n                                        label: 'Pregunta',\n                                    })}\n                                </div>\n                            </div>\n                            <div class=\"mt-3\">\n                                <label class=\"text-body-2 mb-3\">Adicionales</label>\n                                <div class=\"col-12 px-1\">\n                                    ${crearTextarea({\n                                        autocomplete: 'off',\n                                        id: 'notas_entrevistador',\n                                        name: 'notas_entrevistador',\n                                        value: 'Notas del entrevistador',\n                                        maxlength: 150,\n                                        class: 'clase-personalizada',\n                                        label: '',\n                                    })}\n                                </div>\n                            </div>\n                            <div class=\"mt-3 row\">\n                                <div class=\"col-auto px-1\"><span class=\"ms-2 my-auto text-body-2\">Asistencia a la entrevista</span> <span class=\"badge bg-gray-80 px-3 py-2 text-label-1 text-gray-30\">Sí</span></div>\n                                <div class=\"col-auto px-1 ms-auto d-flex justify-content-end\">\n                                    <span class=\"me-2 mt-2 text-body-2\">Puntuación obtenida</span>\n                                    <span class=\"col-4\">\n                                        ${crearInput({\n                                            autocomplete: 'off',\n                                            id: 'puntaje',\n                                            name: 'puntaje',\n                                            type: 'text',\n                                            value: 'Ej. 100%',\n                                            maxlength: 150,\n                                            class: 'clase-personalizada',\n                                            label: 'Puntuacion',\n                                        })}\n                                    <span>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n    `;\n}\n\n/**\n * Descargar reporte detallado de resultados del proceso en Excel.\n *\n * Genera un archivo Excel con múltiples hojas que incluyen resumen de participantes\n * y resultados detallados por prueba con factores, dimensiones y conceptos.\n * Si hay participantes seleccionados, solo incluye esos; caso contrario incluye todos.\n *\n * @param {string} nombre_tabla Nombre de la tabla de participantes.\n * @returns {void}\n * @author Andres Morales\n * @author Sergio Vargas\n */\nfunction descargarExcelParticipantes(nombre_tabla) {\n    descargarExcel(\n        'procesos-reporte-resultados-excel',\n        'descarga-detallada-resultados-seleccion',\n        true,\n        window[nombre_tabla + '_seleccionados'].length > 0\n            ? { proceso_id: PROCESO.id, ids_usuarios: window[nombre_tabla + '_seleccionados'].map(item => item.id) }\n            : { proceso_id: PROCESO.id }\n    );\n}\n\n/**\n * Revocar el acceso a una ruta.\n *\n * @param {int} firma_ruta_id Id de la firma de la ruta.\n * @returns {Promise<void>}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function revocarAccesoRuta(firma_ruta_id) {\n    Swal.fire({\n        showCloseButton: true,\n        closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n        showConfirmButton: false,\n        showDenyButton: false,\n        showCancelButton: false,\n        html: `\n            <div class=\"row w-100 mx-0 mt-2\">\n                <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">¿Estás seguro?</div>\n                <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">Revocaras el acceso permanentemente del proceso compartido.</div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-outline-primary w-100 justify-content-center',\n                        texto: 'Cancelar',\n                        onclick:`Swal.close();`\n                    })}\n                </div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-danger w-100 justify-content-center',\n                        texto: 'Revocar acceso',\n                        onclick:`Swal.clickConfirm();`\n                    })}\n                </div>\n            </div>\n        `,\n    }).then(async (result) => {\n        if (result.isConfirmed) {\n            await $.ajax({\n                type: 'POST',\n                url: `/firmas-rutas-revocar-acceso/${firma_ruta_id}`,\n                data: { _token: $('meta[name=\"csrf-token\"]').attr('content') }\n            }).then((respuesta) => {\n                actualizarDatatables(`tabla-historial-compartido`);\n                mostrarToast('success', 'Acceso revocado correctamente');\n            }).catch((error) => {\n                mostrarToast('danger', 'Error al revocar el acceso');\n            });\n        }\n    });\n}\n\n/**\n * Abrir el modal de videograbación y mostrar los videos asociados a la agenda.\n *\n * @param {number} agenda_id ID de la agenda.\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirModalVideograbacion(agenda_id) {\n    $.ajax({\n        url: `/archivos`,\n        data: {\n            modelo_id: agenda_id,\n            modelo: \"App\\\\Models\\\\Agendas\\\\Agenda\",\n            nombre: 'video'\n        },\n        type: 'GET',\n        success: function (respuesta) {\n            let videos = respuesta.data;\n            $('#reproduciendo-parte').text('1');\n            $('#reproductor').attr('src', '');\n            $('#lista-videos').empty();\n            if (videos.length == 0) {\n                $('#sin-videos').removeClass('d-none');\n                $('#videos').addClass('d-none');\n            } else {\n                $('#sin-videos').addClass('d-none');\n                $('#videos').removeClass('d-none');\n            }\n            for (let i = 0; i < videos.length; i++) {\n                if (i == 0) {\n                    $('#reproductor').prop('src', '/archivos-abrir/' + videos[i].id);\n                }\n                $('#lista-videos').append(`\n                    <div class=\"w-100 text-label-1 fw-semibold text-gray-10\" onclick=\"reproducirVideo(${videos[i].id}, ${i + 1});\">\n                        Parte ${i + 1}:\n                        <video class=\"w-100 rounded-3 pointer\">\n                            <source src=\"/archivos-abrir/${videos[i].id}\" type=\"video/mp4\">\n                            Tu navegador no soporta el elemento de video.\n                        </video>\n                    </div>\n                `);\n            }\n            $('#modal-detalle-participante').modal('hide');\n            $('#modal-vidograbaciones').modal('show');\n        },\n        error: function (error) {\n            mostrarToast('danger', 'Error al cargar la videograbación.');\n        }\n    });\n}\n\n/**\n * Reproducir un video específico en el reproductor.\n *\n * @param {number} video_id ID del video a reproducir.\n * @param {number} parte Parte del video que se está reproduciendo.\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction reproducirVideo(video_id, parte) {\n    $('#reproductor').prop('src', '/archivos-abrir/' + video_id);\n    $('#reproductor')[0].play();\n    $('#reproduciendo-parte').text(parte);\n}\n\n/**\n * Renderiza los historiales en data tables.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction abrirModalHistorialCompartido() {\n    var nombre_tabla = 'tabla-historial-compartido';\n    destruirTablaExistente(nombre_tabla);\n    $(`#${nombre_tabla}`).DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [10, 25, 50, 100, 200],\n            [10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 320px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/firmas-rutas-por-proceso/${PROCESO.id}`,\n            data: function (datos) {\n            },\n            dataSrc: function (json) {\n                return Object.values(json.data);\n            }\n        },\n        columns: [\n            {\n                data: 'email_destinatario',\n                title: `Email del destinatario`,\n                orderable : false\n            },\n            {\n                data: 'created_at',\n                title: `Fecha de envio`,\n                orderable : false,\n                render: (dato) => formatearFecha(dato)\n            },\n            {\n                data: 'fecha_hora_expiracion',\n                title: `Fecha de expiración`,\n                orderable : false,\n                render: (dato) => formatearFecha(dato)\n            },\n            {\n                data: 'estado',\n                title: 'Estado',\n                orderable : false,\n                render: (dato) => titleCase(dato)\n            },\n            {\n                data: null,\n                title: `Acciones`,\n                orderable : false,\n                render: (dato) => {\n                    return `\n                        <div class=\"text-center\">\n                            ${(dato.estado === 'activo') ?\n                                crearBoton({\n                                    id: `boton-revocar-acceso-${dato.id}`,\n                                    adicional: `data-value=\"${dato.id}\"`,\n                                    clases: 'btn-danger',\n                                    texto: 'Revocar acceso',\n                                    onclick: `revocarAccesoRuta(${dato.id})`\n                                })\n                            : ''}\n                        </div>\n                    `;\n                }\n            },\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n    $('[data-bs-toggle=\"tooltip\"]').tooltip();\n        },\n        initComplete: function(settings, json) {\n            $('#modal-historial-compartido').modal('show');\n            cargarDataTablas();\n            $(document).find('[role=\"tooltip\"]').remove();\n            inicializarTooltips();\n    $('[data-bs-toggle=\"tooltip\"]').tooltip();\n        }\n    });\n}\n\n/**\n * Compartir los resultados del aplicante en el proceso a la lista de direcciones de correo electrónico de los destinatarios.\n *\n * @param {number} proceso_id Id del proceso.\n * @param {number} usuario_id Id del usuario aplicante.\n * @returns {void}\n * @author Andres Morales\n */\nasync function seleccionarParticipante(proceso_id, usuario_id) {\n    Swal.fire({\n        showCloseButton: true,\n        closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n        showConfirmButton: false,\n        showDenyButton: false,\n        showCancelButton: false,\n        html: `\n            <div class=\"row w-100 mx-0 mt-2\">\n                <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">¿Estás seguro?</div>\n                <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">El participante será seleccionado en el proceso.</div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-outline-primary w-100 justify-content-center',\n                        texto: 'Cancelar',\n                        onclick:`Swal.close();`\n                    })}\n                </div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-success w-100 justify-content-center',\n                        texto: 'Seleccionar',\n                        onclick:`Swal.clickConfirm();`\n                    })}\n                </div>\n            </div>\n        `,\n    }).then(async (result) => {\n        if (result.isConfirmed) {\n            await $.ajax({\n                url: '/participante-seleccionar',\n                type: 'POST',\n                data: {\n                    _token: $('input[name=\"_token\"]').val(),\n                    proceso_id: proceso_id,\n                    participante_id: usuario_id,\n                }\n            }).done(function (respuesta) {\n                mostrarToast('success', respuesta.message);\n                if (respuesta.estado_proceso == true) {\n                    // Recarga la pagina para cambiar el estado del proceso\n                    location.reload();\n                }\n                if ($('#participantes-tap').hasClass('active')) {\n                    actualizarDatatables(nombre_tabla_participantes);\n                } else if ($('#resultados-tap').hasClass('active')) {\n                    actualizarDatatables(nombre_tabla_resultados);\n                }\n                if ($('#modal-detalle-participante').hasClass('show')) {\n                    $('#modal-detalle-participante').modal('hide');\n                }\n            }).fail(function (error) {\n                mostrarToast('danger', error.responseJSON.message || 'Error al seleccionar el participante');\n            });\n        }\n    });\n}\n\n// Event listener para el botón de descarga masiva de reportes\n$(document).on('click', '[id*=\"boton-descargar-reportes\"]', function() {\n    let boton_id = $(this).attr('id');\n    let agendas_ids = [];\n    let nombre_tabla = boton_id.replace('boton-descargar-reportes_', '');\n    let elementos_seleccionados = window[nombre_tabla + '_seleccionados'] || [];\n    let elementos_totales = window[nombre_tabla + '_ids'] || [];\n\n    if (elementos_seleccionados.length === 0) {\n        agendas_ids = elementos_totales.map(item => item.id);\n    } else {\n        agendas_ids = elementos_seleccionados.map(item => item.id);\n    }\n\n    // Elimina los ids repetidos\n    agendas_ids = [...new Set(agendas_ids)];\n\n    Swal.fire({\n        showCloseButton: true,\n        closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n        showConfirmButton: false,\n        showDenyButton: false,\n        showCancelButton: false,\n        html: `\n            <div class=\"row w-100 mx-0 mt-2\">\n                <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">Descargar reportes</div>\n                <div class=\"col-12 mt-3 text-start text-body-2 fw-normal\">\n                    ¿Está seguro que desea descargar ${agendas_ids.length} reporte${agendas_ids.length > 1 ? 's' : ''} en un archivo ZIP?\n                    <br><small class=\"text-gray-30\">Este proceso puede tardar algunos minutos dependiendo de la cantidad de reportes.</small>\n                </div>\n                <div class=\"col-6 mt-4 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-outline-primary w-100 justify-content-center',\n                        texto: 'Cancelar',\n                        onclick: 'Swal.close();'\n                    })}\n                </div>\n                <div class=\"col-6 mt-4 mb-2\">\n                    ${crearBoton({\n                        id: 'btn-confirmar-descarga-zip',\n                        clases: 'btn-primary w-100 justify-content-center',\n                        texto: 'Descargar',\n                        onclick: 'Swal.clickConfirm();'\n                    })}\n                </div>\n            </div>\n        `,\n    }).then((result) => {\n        if (result.isConfirmed) {\n            descargarReportesZip(agendas_ids);\n        }\n    });\n});\n\n/**\n * Descargar múltiples reportes en formato ZIP.\n *\n * @param {Array} agendas_ids Array de IDs de agendas.\n * @author Sergio Vargas\n */\nasync function descargarReportesZip(agendas_ids) {\n    Swal.fire({\n        title: 'Generando reportes...',\n        html: `\n            <div class=\"d-flex justify-content-center align-items-center my-4\">\n                <div class=\"spinner-border text-primary me-3\" role=\"status\">\n                    <span class=\"visually-hidden\">Cargando...</span>\n                </div>\n                <span class=\"text-body-2\">Procesando ${agendas_ids.length} reporte${agendas_ids.length > 1 ? 's' : ''}. Por favor espere...</span>\n            </div>\n        `,\n        allowOutsideClick: false,\n        allowEscapeKey: false,\n        showConfirmButton: false\n    });\n\n    try {\n        let form = $('<form>', {\n            method: 'POST',\n            action: '/reportes-agendas-zip'\n        });\n\n        form.append($('<input>', {\n            type: 'hidden',\n            name: '_token',\n            value: $('input[name=\"_token\"]').val()\n        }));\n\n        agendas_ids.forEach(function(agendaId) {\n            form.append($('<input>', {\n                type: 'hidden',\n                name: 'agendas_ids[]',\n                value: agendaId\n            }));\n        });\n\n        $('body').append(form);\n        form.submit();\n\n        setTimeout(function() {\n            form.remove();\n            Swal.close();\n            mostrarToast('success', 'Descarga iniciada. El archivo se descargará automáticamente.');\n        }, 1000);\n\n    } catch (error) {\n        Swal.close();\n        mostrarToast('danger', 'Error al iniciar la descarga. Inténtelo nuevamente.');\n    }\n}\n\n/**\n * Calcular el color del índice de talento.\n *\n * @param {number} indice_talento - Índice de talento (número entre 10 y 100).\n * @returns {string} Color del índice.\n * @author Andres Gonzalez\n */\nfunction calcularColorIndiceTalento(indice_talento) {\n    let color_indice_talento = \"\";\n    if (indice_talento >= 10 && indice_talento <= 40) {\n        color_indice_talento = 'red';\n    } else if (indice_talento >= 41 && indice_talento <= 70) {\n        color_indice_talento = 'yellow';\n    } else if (indice_talento >= 71 && indice_talento <= 100) {\n        color_indice_talento = 'green';\n    }\n    return color_indice_talento;\n}\n\n/**\n * Mostrar modal con advertencias detalladas de reagendamiento.\n *\n * @param {object} respuesta - Respuesta del servidor con detalles y advertencias\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction mostrarModalAdvertenciasReagendamiento(respuesta) {\n    let contenido_advertencias = '';\n\n    if (respuesta.advertencias && respuesta.advertencias.length > 0) {\n        contenido_advertencias = '<div class=\"alert alert-warning\"><ul class=\"mb-0\" style=\"list-style: none; padding-left: 0;\">';\n\n        respuesta.advertencias.forEach(function(advertencia) {\n            contenido_advertencias += '<li style=\"margin-bottom: 8px;\">' + advertencia + '</li>';\n        });\n\n        contenido_advertencias += '</ul></div>';\n    }\n\n    let contenido_detalles = '';\n    if (respuesta.detalles) {\n        contenido_detalles = `\n            <div class=\"row mt-3\">\n                <div class=\"col-md-4\">\n                    <div class=\"text-center\">\n                        <h5 class=\"text-success\">${respuesta.detalles.agendas_reagendadas}</h5>\n                        <small class=\"text-muted\">Agendas reagendadas</small>\n                    </div>\n                </div>\n                <div class=\"col-md-4\">\n                    <div class=\"text-center\">\n                        <h5 class=\"text-warning\">${respuesta.detalles.agendas_omitidas}</h5>\n                        <small class=\"text-muted\">Agendas omitidas</small>\n                    </div>\n                </div>\n                <div class=\"col-md-4\">\n                    <div class=\"text-center\">\n                        <h5 class=\"text-info\">${respuesta.detalles.participantes_notificados}</h5>\n                        <small class=\"text-muted\">Participantes notificados</small>\n                    </div>\n                </div>\n            </div>\n        `;\n    }\n\n    Swal.fire({\n        title: '<i class=\"fas fa-exclamation-triangle text-warning\"></i> Información del Reagendamiento',\n        html: `\n            <div class=\"text-left\">\n                <p><strong>Se completó el proceso de reagendamiento con algunas limitaciones:</strong></p>\n                ${contenido_advertencias}\n                ${contenido_detalles}\n                <div class=\"mt-3\">\n                    <small class=\"text-muted\">\n                        <i class=\"fas fa-info-circle\"></i>\n                        Las agendas que han alcanzado el límite máximo de ${respuesta.detalles.limite_agendas} reagendamientos no pueden ser reagendadas nuevamente.\n                    </small>\n                </div>\n            </div>\n        `,\n        icon: 'warning',\n        confirmButtonText: 'Entendido',\n        confirmButtonColor: '#3085d6',\n        width: '600px',\n        customClass: {\n            htmlContainer: 'text-left'\n        }\n    });\n}\n\n/**\n * Función para abrir el modal para generar comparativa con la IA.\n *\n * @param {string} nombre_tabla_seleccionada Nombre de la tabla que se quiere generar con IA.\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirModalCompararCandidatosIA(nombre_tabla_seleccionada) {\n    nombre_tabla_seleccionada_generar_ia = nombre_tabla_seleccionada;\n    $('#modal-comparar-candidatos-ia').modal('show');\n}\n\n/**\n * Función para consultar la comparativa con IA.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction consultarComparativoIA() {\n    let pregunta_especifica = $('#pregunta_especifica').val().trim();\n    let seleccionados_ia = window[nombre_tabla_seleccionada_generar_ia + '_seleccionados'];\n    let candidatos = [];\n    $.each(seleccionados_ia, function(index, participante) {\n        let agendas = participante.agendas || [];\n        let ids_agendas = agendas.map(agenda => agenda.id);\n        let ids_agendas_no_finalizadas = agendas.filter(agenda => agenda.estado_id != 3).map(agenda => agenda.id);\n        if (ids_agendas_no_finalizadas.length > 0) {\n            mostrarToast('danger', 'El candidato ' + participante.nombre_completo + ' tiene agendas no finalizadas y no será tenido en cuenta para la comparación con IA.');\n        } else {\n            candidatos.push({\n                nombre: participante.nombre_completo,\n                agendas: ids_agendas,\n                comentarios: 'null'\n            });\n        }\n    });\n    if (candidatos.length < 2) {\n        mostrarToast('warning', 'Debe seleccionar al menos 2 candidatos con todas sus agendas finalizadas para comparar.');\n        return;\n    }\n    if (pregunta_especifica) {\n        $('#boton-generar-comparativa-ia').html(`<i class=\"spinner-border spinner-border-sm me-2\"></i>Generando...`).attr('disabled', true);\n        $.ajax({\n            url: `/procesos-mejores-candidatos`,\n            data: {\n                _token: $('input[name=\"_token\"]').val(),\n                vacante_id: PROCESO.id,\n                vacante: PROCESO.nombre,\n                pregunta_especifica: pregunta_especifica,\n                candidatos: candidatos\n            },\n            type: 'POST',\n            success: function (respuesta) {\n                mostrarRespuestaComparativoIA(respuesta);\n                $('#boton-generar-comparativa-ia').html(`<img class=\"me-3\" src=\"/iconos/icono_ia.svg\"> Generar comparativa con IA`).attr('disabled', false);\n            },\n            error: function (error) {\n                mostrarToast('danger', 'Error al generar datos con IA.');\n                $('#boton-generar-comparativa-ia').html(`<img class=\"me-3\" src=\"/iconos/icono_ia.svg\"> Generar comparativa con IA`).attr('disabled', false);\n            }\n        });\n    } else {\n        mostrarToast('warning', 'Debe ingresar una pregunta específica para comparar.');\n    }\n}\n\n/**\n * Función para mostrar el resultado generado por la IA.\n *\n * @param {object} respuesta Datos generados por la IA.\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarRespuestaComparativoIA(respuesta) {\n    $('#modal-comparar-candidatos-ia').modal('hide');\n    $('#respuesta-candidatos-ia').empty();\n    $.each(respuesta.data.top_3.candidatos_rankeados, function(index, partidipante) {\n        $('#respuesta-candidatos-ia').append(`\n            <div class=\"col-12 text-headline-4 fw-semibold mb-2\">\n                ${index + 1} ${partidipante.candidato}\n            </div>\n            <div class=\"col-12 mb-7\">\n                ${partidipante.justificacion}\n            </div>\n        `);\n    });\n    $('#modal-respuesta-candidatos-ia').modal('show');\n}\n\n/**\n * Validar y actualizar agendas expiradas de un proceso.\n *\n * @param {number} proceso_id ID del proceso a validar.\n * @author Sergio Vargas\n */\nfunction validarAgendasExpiradas(proceso_id) {\n    $.ajax({\n        url: `/procesos-validar-agendas-expiradas/${proceso_id}`,\n        type: 'POST',\n        headers: {\n            'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n        },\n        success: function(respuesta) {\n            if (respuesta.success && respuesta.data.agendas_actualizadas > 0) {\n                actualizarDatatables(nombre_tabla_participantes);\n                actualizarDatatables(nombre_tabla_resultados);\n            }\n        },\n        error: function(xhr, status, error) {\n            console.error('Error al validar agendas expiradas:', error);\n        }\n    });\n}\n","structuredPatch":[{"oldStart":1233,"oldLines":7,"newStart":1233,"newLines":7,"lines":["         return;","     }","     DATOS.append('pruebas', JSON.stringify(pruebas_seleccionadas));","-    DATOS.append('empresa_id', dato_empresa.id);","+    DATOS.append('empresa_id', PROCESO.empresa_id);"," ","     await $.ajax({","         url        : `/participantes-reagendar`,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"bc918ff0-26ec-4bce-8965-0decac6e0dc5"}
{"parentUuid":"6258961a-c40d-4d58-81c7-50fe4075aa95","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LQFaCMcnxRwZaFRmtR3ZF6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XqwNrGHtRn7LVmJuRhHPCZ","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Requests\\Procesos\\ReagendarParticipantesRequest.php","old_string":"            'proceso_id'      => 'required|integer',\n            'email'           => 'nullable|email|max:100',","new_string":"            'proceso_id'      => 'required|integer',\n            'empresa_id'      => 'required|integer',\n            'email'           => 'nullable|email|max:100',"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2338,"cache_read_input_tokens":25866,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2338},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5o43RmRzNDVs6V5w9i","type":"assistant","uuid":"0b065e4f-9ab1-46b4-8954-093d684298f3","timestamp":"2026-02-16T16:43:42.084Z"}
{"type":"file-history-snapshot","messageId":"0b065e4f-9ab1-46b4-8954-093d684298f3","snapshot":{"messageId":"4d5bb573-a4a4-497b-91aa-e63f8223aca1","trackedFileBackups":{"public\\src\\procesos\\js\\detalle.js":{"backupFileName":"5582b62cf6d471d9@v1","version":1,"backupTime":"2026-02-16T16:43:39.435Z"},"public\\js\\procesos\\detalle.js":{"backupFileName":"51bf0f4dcd300f98@v1","version":1,"backupTime":"2026-02-16T16:43:40.438Z"},"app\\Http\\Requests\\Procesos\\ReagendarParticipantesRequest.php":{"backupFileName":"a69c52be39b04006@v1","version":1,"backupTime":"2026-02-16T16:43:42.140Z"}},"timestamp":"2026-02-16T16:43:28.334Z"},"isSnapshotUpdate":true}
{"parentUuid":"0b065e4f-9ab1-46b4-8954-093d684298f3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01XqwNrGHtRn7LVmJuRhHPCZ","toolUseID":"toolu_01XqwNrGHtRn7LVmJuRhHPCZ","timestamp":"2026-02-16T16:43:42.145Z","uuid":"4c868133-95d1-45c9-992c-d8f15ec089b8"}
{"parentUuid":"0b065e4f-9ab1-46b4-8954-093d684298f3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XqwNrGHtRn7LVmJuRhHPCZ","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Requests\\Procesos\\ReagendarParticipantesRequest.php has been updated successfully."}]},"uuid":"c63d27b4-f93f-4090-8e30-2e75ceac4dc0","timestamp":"2026-02-16T16:43:42.145Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Requests\\Procesos\\ReagendarParticipantesRequest.php","oldString":"            'proceso_id'      => 'required|integer',\n            'email'           => 'nullable|email|max:100',","newString":"            'proceso_id'      => 'required|integer',\n            'empresa_id'      => 'required|integer',\n            'email'           => 'nullable|email|max:100',","originalFile":"<?php\n\nnamespace App\\Http\\Requests\\Procesos;\n\nuse Illuminate\\Foundation\\Http\\FormRequest;\n\nclass ReagendarParticipantesRequest extends FormRequest\n{\n    /**\n     * Determine if the user is authorized to make this request.\n     */\n    public function authorize(): bool\n    {\n        return true;\n    }\n\n    /**\n     * Preparar datos para la validación.\n     *\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function prepareForValidation(): void {\n        $this->merge([\n            'pruebas'       => json_decode($this->pruebas),\n            'participantes' => json_decode($this->participantes)\n        ]);\n    }\n\n    /**\n     * Get the validation rules that apply to the request.\n     *\n     * @return array<string, \\Illuminate\\Contracts\\Validation\\ValidationRule|array<mixed>|string>\n     */\n    public function rules(): array\n    {\n        $reglas = [\n            'proceso_id'      => 'required|integer',\n            'email'           => 'nullable|email|max:100',\n            'pruebas'         => 'required|array|min:1',\n            'pruebas.*'       => 'required|integer',\n            'participantes'   => 'required|array|min:1',\n            'participantes.*' => 'required|integer',\n            'capturar_camara' => 'nullable|boolean',\n            'capturar_video'  => 'nullable|boolean'\n        ];\n\n        if (!isset($this->dias_vencimiento_agendas)) {\n            $reglas['fecha_vencimiento_agendas'] = 'required|date';\n        } elseif (!isset($this->fecha_vencimiento_agendas)) {\n            $reglas['dias_vencimiento_agendas'] = 'required|integer|min:1';\n        }\n\n        return $reglas;\n    }\n}\n","structuredPatch":[{"oldStart":36,"oldLines":6,"newStart":36,"newLines":7,"lines":["     {","         $reglas = [","             'proceso_id'      => 'required|integer',","+            'empresa_id'      => 'required|integer',","             'email'           => 'nullable|email|max:100',","             'pruebas'         => 'required|array|min:1',","             'pruebas.*'       => 'required|integer',"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"0b065e4f-9ab1-46b4-8954-093d684298f3"}
{"parentUuid":"c63d27b4-f93f-4090-8e30-2e75ceac4dc0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_01LQFaCMcnxRwZaFRmtR3ZF6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019zv58vPyJ2bPD2ieu4xoGZ","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php","old_string":"        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);","new_string":"        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, (int) $request->empresa_id, 45);"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2338,"cache_read_input_tokens":25866,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2338},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5o43RmRzNDVs6V5w9i","type":"assistant","uuid":"dfdd088b-b996-4385-b863-9666798947d7","timestamp":"2026-02-16T16:43:43.441Z"}
{"type":"file-history-snapshot","messageId":"dfdd088b-b996-4385-b863-9666798947d7","snapshot":{"messageId":"4d5bb573-a4a4-497b-91aa-e63f8223aca1","trackedFileBackups":{"public\\src\\procesos\\js\\detalle.js":{"backupFileName":"5582b62cf6d471d9@v1","version":1,"backupTime":"2026-02-16T16:43:39.435Z"},"public\\js\\procesos\\detalle.js":{"backupFileName":"51bf0f4dcd300f98@v1","version":1,"backupTime":"2026-02-16T16:43:40.438Z"},"app\\Http\\Requests\\Procesos\\ReagendarParticipantesRequest.php":{"backupFileName":"a69c52be39b04006@v1","version":1,"backupTime":"2026-02-16T16:43:42.140Z"},"app\\Http\\Services\\Procesos\\ProcesoService.php":{"backupFileName":"4b3d26c34ea55f54@v1","version":1,"backupTime":"2026-02-16T16:43:43.458Z"}},"timestamp":"2026-02-16T16:43:28.334Z"},"isSnapshotUpdate":true}
{"parentUuid":"dfdd088b-b996-4385-b863-9666798947d7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_019zv58vPyJ2bPD2ieu4xoGZ","toolUseID":"toolu_019zv58vPyJ2bPD2ieu4xoGZ","timestamp":"2026-02-16T16:43:43.465Z","uuid":"1f349ab0-be84-4eb8-a169-cf26a4d06850"}
{"parentUuid":"dfdd088b-b996-4385-b863-9666798947d7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019zv58vPyJ2bPD2ieu4xoGZ","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php has been updated successfully."}]},"uuid":"e31d8c83-cd13-4250-baf6-bb5b01694354","timestamp":"2026-02-16T16:43:43.464Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php","oldString":"        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);","newString":"        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, (int) $request->empresa_id, 45);","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Procesos;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse GuzzleHttp\\Client;\nuse App\\Traits\\IATrait;\nuse App\\Traits\\FechaTrait;\nuse Illuminate\\Support\\Arr;\nuse Illuminate\\Support\\Str;\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Agendas\\Agenda;\nuse App\\Models\\Pruebas\\Prueba;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Http\\Services\\BaseService;\nuse App\\Mail\\CompartirProcesoMail;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Agendas\\EstadoAgenda;\nuse App\\Models\\OfertasLaborales\\Etapa;\nuse App\\Traits\\Pruebas\\IQFactorialTrait;\nuse GuzzleHttp\\Exception\\GuzzleException;\nuse GuzzleHttp\\Exception\\RequestException;\nuse App\\Http\\Services\\Usuarios\\UserService;\nuse App\\Http\\Services\\Agendas\\AgendaService;\nuse App\\Mail\\CompartirResultadosProcesoMail;\nuse Illuminate\\Support\\Facades\\{Auth, Mail};\nuse App\\Mail\\DescartarParticipanteProcesoMail;\nuse App\\Mail\\NotificarSeleccionParticipanteMail;\nuse App\\Models\\Procesos\\{EstadoProceso,Proceso};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\nuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\nuse App\\Http\\Repositories\\Agendas\\ResultadoAgendaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Services\\OfertasLaborales\\OfertaLaboralService;\nuse App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\nuse App\\Http\\Repositories\\OfertasLaborales\\EtapaUsuarioRepository;\nuse App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\nuse App\\Http\\Repositories\\Procesos\\{ProcesoPruebaRepository,ProcesoRepository};\n\n/**\n * @property ProcesoRepository $repositorio\n */\nclass ProcesoService extends BaseService\n{\n    use FechaTrait, IATrait, IQFactorialTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param ProcesoRepository $repositorio Repositorio de procesos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param UserService $usuario_servicio Servicio de usuarios.\n     * @param AgendaService $agenda_servicio Servicio de agendas.\n     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n     * @param EtapaUsuarioRepository $etapa_usuario_repositorio Repositorio de etapas de usuarios.\n     * @param ProcesoPruebaRepository $proceso_prueba_repositorio Repositorio de pruebas de procesos.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param OfertaLaboralService $oferta_laboral_servicio Servicio de ofertas laborales.\n     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n     * @param ResultadoAgendaRepository $resultado_agenda_repositorio Repositorio de resultados de agendas.\n     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n     * @param PruebaRepository prueba_repositorio Repositorio de pruebas.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function __construct(\n        ProcesoRepository $repositorio,\n        protected UserRepository $usuario_repositorio,\n        protected UserService $usuario_servicio,\n        protected AgendaService $agenda_servicio,\n        protected AgendaRepository $agenda_repositorio,\n        protected EtapaUsuarioRepository $etapa_usuario_repositorio,\n        protected ProcesoPruebaRepository $proceso_prueba_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected OfertaLaboralService $oferta_laboral_servicio,\n        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n        protected ResultadoAgendaRepository $resultado_agenda_repositorio,\n        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n        protected PruebaRepository $prueba_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar proceso.\n     *\n     * @param Request $request Contenido de la petición.\n     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalización del proceso.\n     * @throws Exception Si la fecha de finalización del proceso es anterior a la fecha de las agendas existentes.\n     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n     * @return Proceso\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): Proceso {\n        $campos_excluidos = ['_token', '_method', 'id', 'pruebas', 'titulo_mensaje', 'descripcion_mensaje', 'participantes'];\n        $fecha_limite     = $this->calcularFechaCierreAgendas($request);\n\n        if (!is_null($fecha_limite)) {\n            $this->validarFechas($fecha_limite, $request->fecha_cierre, $request->id);\n        }\n\n        // Guardar solo una de las dos opciones de vencimiento de agendas\n        if ($request->filled('dias_vencimiento_agendas')) {\n            $request->merge(['fecha_vencimiento_agendas' => null]);\n        } elseif ($request->filled('fecha_vencimiento_agendas')) {\n            $request->merge(['dias_vencimiento_agendas' => null]);\n        }\n\n        if ($request->filled('id')) {\n            $proceso = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n\n            // Actualizar agendas con estado AGENDADA (1) cuando se modifiquen los campos de captura\n            if ($request->filled('capturar_camara') || $request->filled('capturar_video')) {\n                $this->actualizarCamposCapturarEnAgendas(\n                    $request->id,\n                    $request->capturar_camara ?? false,\n                    $request->capturar_video ?? false\n                );\n            }\n        } else {\n            $usuario = Auth::user();\n\n            $request->merge([\n                'empresa_id'   => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id,\n                'usuario_id'   => $usuario->id,\n                'estado_id'    => EstadoProceso::PENDIENTE_ID,\n                'fecha_inicio' => Carbon::now()\n            ]);\n\n            $proceso = $this->repositorio->crear($request->except($campos_excluidos));\n\n            $proceso->refresh();\n        }\n\n        // Calcular la fecha límite\n        $pruebas = [];\n\n        foreach ($request->pruebas as $prueba) {\n            $pruebas[$prueba['id']] = [\n                'perfil_id'    => $prueba['perfil_id'],\n                'porcentaje'   => $prueba['porcentaje'],\n                'fecha_limite' => $fecha_limite\n            ];\n        }\n\n        $this->repositorio->sincronizarPruebas($proceso, $pruebas);\n\n        if ($request->filled('participantes') && count($request->participantes) > 0) {\n            $request->merge(['fecha_limite' => $fecha_limite]);\n            $this->guardarParticipantes($proceso, $request);\n            $this->repositorio->actualizar($proceso->id, ['estado_id' => 2]);\n        }\n\n        return $proceso;\n    }\n\n    /**\n     * Guardar participantes.\n     *\n     * @param Proceso $proceso Proceso.\n     * @param Request $request Contenido de la petición.\n     * @throws Exception Si la dirección de correo electrónico de nuevo participante ya fue tomada por otro usuario.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function guardarParticipantes(Proceso $proceso, Request $request): void {\n        $participantes = [];\n\n        foreach ($request->participantes as $participante) {\n            $usuario                     = $this->agenda_servicio->guardarParticipante($proceso, $participante, $request, true, true);\n            $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n        }\n\n        // Agregar los participantes a la etapa inicial\n        $this->asociarEtapasUsuarios($proceso, $participantes);\n\n        // Asignar la etapa inicial de la oferta laboral a los participantes (cuando el proceso es de una oferta laboral)\n        if (!is_null($proceso->oferta_laboral_id)) {\n            foreach ($participantes as $usuario_id => $item) {\n                $this->oferta_laboral_servicio->postularAplicante($proceso->oferta_laboral_id, null, $usuario_id);\n            }\n        }\n    }\n\n    /**\n     * Duplicar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petición.\n     * @return Proceso\n     * @author Daniel Beltrán\n     * @author Sergio Vargas\n     * @author Andres Gonzalez\n     */\n    public function duplicar(int $id, Request $request): Proceso {\n        $proceso             = $this->repositorio->getUno($id);\n        $datos               = Arr::only($proceso->toArray(), ['empresa_id', 'evaluador_id', 'nombre', 'fecha_inicio', 'fecha_cierre', 'cantidad_vacantes', 'intentos_permitidos', 'capturar_camara', 'capturar_video', 'mostrar_logo_aplicante', 'dias_vencimiento_agendas', 'fecha_vencimiento_agendas']);\n        $datos['nombre']     = $request->filled('nombre') ? $request->nombre : $proceso->nombre . ' (Copia)';\n        $datos['usuario_id'] = Auth::id();\n        $datos['estado_id']  = EstadoProceso::PENDIENTE_ID;\n        $datos['vacante_id'] = $request->filled('vacante_id') ? $request->vacante_id : null;\n\n        $proceso_nuevo = $this->repositorio->crear($datos);\n        $pruebas       = [];\n\n        foreach ($proceso->pruebas as $prueba) {\n            $pruebas[$prueba->id] = [\n                'perfil_id'    => $prueba->pivot->perfil_id,\n                'porcentaje'   => $prueba->pivot->porcentaje,\n                'fecha_limite' => $prueba->pivot->fecha_limite\n            ];\n        }\n\n        $this->repositorio->sincronizarPruebas($proceso_nuevo, $pruebas);\n\n        return $this->repositorio->getUno($proceso_nuevo->id);\n    }\n\n    /**\n     * Suspender proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return Proceso\n     * @author Daniel Beltrán\n     */\n    public function suspender(int $id): Proceso {\n        $this->repositorio->actualizar($id, ['estado_id' => 5]);\n\n        // Inactivar las agendas\n        $agendas     = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $id]));\n        $agendas_ids = $agendas->pluck('id')->toArray();\n        $this->agenda_repositorio->actualizarVarios($agendas_ids, ['activo' => false]);\n\n        return $this->repositorio->getUno($id);\n    }\n\n    /**\n     * Activar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return Proceso\n     * @author Daniel Beltrán\n     */\n    public function activar(int $id): Proceso {\n        $proceso = $this->repositorio->getUno($id);\n        $agendas = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $proceso->id]));\n\n        foreach ($agendas as $agenda) {\n            // Expirar agendas vencidas\n            if ($agenda->fecha_cierre < now()) {\n                $this->agenda_repositorio->actualizar($agenda->id, ['estado_id' => 4, 'activo' => true]);\n                continue;\n            }\n\n            // Activar las agendas\n            $this->agenda_repositorio->actualizar($agenda->id, ['activo' => true]);\n        }\n\n        $this->repositorio->actualizar($proceso->id, ['estado_id' => (count($agendas) > 0 ? 2 : 1)]);\n\n        return $proceso->fresh();\n    }\n\n    /**\n     * Eliminar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @throws Exception Cuando el proceso tiene agendas asociadas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function eliminar(int $id): void {\n        $agendas = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $id]));\n\n        if (count($agendas) > 0) {\n            throw new Exception('No se puede eliminar un proceso con agendas asociadas.', 400);\n        }\n\n        $this->repositorio->eliminar($id);\n    }\n\n    /**\n     * Descartar participantes.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     */\n    public function descartarParticipantes(Request $request): void {\n        $proceso       = $this->repositorio->getUno($request->id);\n        $participantes = [];\n\n        foreach ($request->participantes as $participante_id) {\n            $usuario = $this->usuario_repositorio->getUno($participante_id);\n\n            // Obtener la etapa actual del participante\n            $etapa_actual = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n                'usuario_id' => $usuario->id,\n                'proceso_id' => $proceso->id\n            ]));\n\n            // Determinar la nueva etapa basada en la etapa actual\n            if ($etapa_actual && $etapa_actual->etapa_id == Etapa::DESCARTADO_PROCESO_ID) {\n                // Si ya está descartado, cambiar a en pruebas\n                $nueva_etapa_id              = Etapa::EN_PRUEBAS_ID;\n                $participantes[$usuario->id] = ['etapa_id' => $nueva_etapa_id];\n                $es_descartado = false;\n\n                // Eliminar de procesos_seleccionados (por si estaba seleccionado)\n                $proceso->seleccionados()->detach($usuario->id);\n            } else {\n                // Si no está descartado, descartarlo\n                $nueva_etapa_id              = Etapa::DESCARTADO_PROCESO_ID;\n                $participantes[$usuario->id] = ['etapa_id' => $nueva_etapa_id];\n                $es_descartado = true;\n\n                // Eliminar participante de procesos_seleccionados\n                $proceso->seleccionados()->detach($usuario->id);\n            }\n\n            // Enviar correo\n            Mail::queue(new DescartarParticipanteProcesoMail($usuario, $proceso, $es_descartado));\n\n            // Actualizar la etapa del participante\n            $this->etapa_usuario_repositorio->actualizar($etapa_actual->id, ['etapa_id' => $nueva_etapa_id]);\n        }\n    }\n\n    /**\n     * Seleccionar un participante en un proceso.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return bool\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     * @author Fahibram Cárcamo\n     */\n    public function seleccionarParticipante(Request $request): bool {\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n        $usuario = $this->usuario_repositorio->getUno($request->participante_id);\n\n        // Validar que no se hayan completado las vacantes del proceso\n        if ($proceso->seleccionados_count >= $proceso->cantidad_vacantes) {\n            throw new Exception('No se puede seleccionar al participante porque ya se han completado todas las vacantes del proceso.');\n        }\n\n        // Validar que todas las agendas del participante en este proceso estén finalizadas\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id'  => $proceso->id,\n            'evaluado_id' => $usuario->id\n        ]));\n\n        $agendas_no_finalizadas = $agendas->filter(function ($agenda) {\n            return $agenda->estado_id !== EstadoAgenda::FINALIZADA_ID;\n        });\n\n        if ($agendas_no_finalizadas->isNotEmpty()) {\n            throw new Exception('No se puede seleccionar el participante porque tiene agendas pendientes sin finalizar');\n        }\n\n        // Cambiar la etapa del participante a \"Seleccionados\"\n        $etapa = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n            'usuario_id' => $usuario->id,\n            'proceso_id' => $proceso->id\n        ]));\n\n        if ($etapa) {\n            $this->etapa_usuario_repositorio->actualizar($etapa->id, ['etapa_id' => Etapa::SELECCIONADOS_ID]);\n        }\n\n        // Obtener el índice de talento del participante\n        $indice_talento_resultado = $this->repositorio->obtenerIndiceTalento($proceso->id, $usuario->id);\n        $indice_talento           = $indice_talento_resultado->indice_talento ?? 0;\n\n        // Agregar el participante a la tabla procesos_seleccionados si no existe\n        if (!$this->repositorio->estaSeleccionado($proceso->id, $usuario->id)) {\n            $this->repositorio->agregarSeleccionado($proceso->id, $usuario->id, [\n                'indice_talento' => $indice_talento\n            ]);\n        }\n\n        // Envía el mensaje de correo electrónico de notificación de selección al participante.\n        Mail::to($usuario->email)->queue(new NotificarSeleccionParticipanteMail($usuario, $proceso));\n\n        // Valida si ya se seleccionaron todos los usuarios para el proceso y cierra el proceso\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n\n        if ($proceso->seleccionados_count == $proceso->cantidad_vacantes) {\n            $proceso_cerrado = true;\n            $this->repositorio->actualizar($request->proceso_id, ['estado_id' => EstadoProceso::CERRADO_ID]);\n        }\n\n        return $proceso_cerrado ?? false;\n    }\n\n    /**\n     * Mover participantes de un proceso a otro.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function moverDeProceso(Request $request): void {\n        $proceso_actual   = $this->repositorio->getUno($request->proceso_actual_id);\n        $proceso_destino  = $this->repositorio->getUno($request->proceso_destino_id);\n        $pruebas_actuales = $proceso_actual->pruebas->pluck('id')->toArray();\n        $pruebas_destino  = $proceso_destino->pruebas->pluck('id')->toArray();\n        $fecha_limite     = $this->calcularFechaCierreAgendas($request);\n        $this->validarFechas($fecha_limite, $proceso_destino->fecha_cierre, $proceso_destino->id);\n\n        // Validar si se agrega el participante al nuevo proceso manteniendo también sus\n        // agendamientos en el proceso actual.\n        if (filter_var($request->mantener_en_proceso, FILTER_VALIDATE_BOOLEAN)) {\n            $participantes = [];\n\n            foreach ($request->participantes as $participante_id) {\n                $usuario = $this->usuario_repositorio->getUno($participante_id);\n\n                foreach ($pruebas_destino as $prueba_id) {\n                    // Validar que el participante no tenga una agenda de la misma prueba en el\n                    // proceso destino.\n                    $agendas_participante_proceso_actual = $this->agenda_repositorio->getTodo(new Request([\n                        'proceso_id'  => $proceso_destino->id,\n                        'evaluado_id' => $usuario->id,\n                        'prueba_id'   => $prueba_id\n                    ]));\n\n                    if (count($agendas_participante_proceso_actual) > 0) {\n                        continue;\n                    }\n\n                    $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n                        'proceso_id' => $proceso_destino->id,\n                        'prueba_id'  => $prueba_id\n                    ]));\n\n                    $this->agenda_servicio->agendar($proceso_destino, $usuario, $prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n                    $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n                }\n\n                // Enviar correo de notificación\n                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso_destino);\n            }\n\n            // Agregar la etapa a los participantes\n            $this->asociarEtapasUsuarios($proceso_destino, $participantes);\n        } else {\n            $participantes = [];\n\n            foreach ($request->participantes as $participante_id) {\n                $usuario                     = $this->usuario_repositorio->getUno($participante_id);\n                $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n\n                // Obtener las agendas del participante en el proceso actual\n                $agendas_participante_proceso_actual = $this->agenda_repositorio->getTodo(new Request([\n                    'proceso_id'  => $proceso_actual->id,\n                    'evaluado_id' => $usuario->id\n                ]));\n\n                foreach ($agendas_participante_proceso_actual as $agenda_participante_proceso_actual) {\n                    if (in_array($agenda_participante_proceso_actual->prueba_id, $pruebas_destino)) {\n                        // Si la prueba de la agenda del proceso actual existe en el proceso de\n                        // destino se modifica la agenda para que esté relacionada con el proceso de\n                        // destino, con su empresa y con su perfil asociado.\n                        $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n                            'proceso_id' => $proceso_destino->id,\n                            'prueba_id'  => $agenda_participante_proceso_actual->prueba_id\n                        ]));\n\n                        if (!is_null($proceso_prueba_destino)) {\n                            $this->agenda_repositorio->actualizar($agenda_participante_proceso_actual->id, [\n                                'empresa_id'      => $proceso_destino->empresa_id,\n                                'proceso_id'      => $proceso_destino->id,\n                                'perfil_id'       => $proceso_prueba_destino->perfil_id,\n                                'fecha_cierre'    => $fecha_limite,\n                                'capturar_camara' => $proceso_destino->capturar_camara,\n                                'capturar_video'  => $proceso_destino->capturar_video\n                            ]);\n\n                            // Si la agenda está invalidada se crea una nueva en el proceso nuevo\n                            if ($agenda_participante_proceso_actual->estado_id == EstadoAgenda::INVALIDADA_ID) {\n                                $this->agenda_servicio->agendar($proceso_destino, $usuario, $proceso_prueba_destino->prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n                            }\n                        }\n                    } else {\n                        // Si no es así solamente se relaciona la agenda con el proceso de destino y\n                        // con su empresa.\n                        $this->agenda_repositorio->actualizar($agenda_participante_proceso_actual->id, [\n                            'empresa_id'   => $proceso_destino->empresa_id,\n                            'proceso_id'   => $proceso_destino->id,\n                            'fecha_cierre' => $fecha_limite\n                        ]);\n                    }\n                }\n\n                // Crear las agendas en el nuevo proceso, validando que no se dupliquen\n                foreach ($pruebas_destino as $prueba_id) {\n                    $existe_agenda = $this->agenda_repositorio->getUnoAvanzado(new Request([\n                        'proceso_id'  => $proceso_destino->id,\n                        'prueba_id'   => $prueba_id,\n                        'evaluado_id' => $usuario->id\n                    ]));\n\n                    if (!$existe_agenda) {\n                        $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n                            'proceso_id' => $proceso_destino->id,\n                            'prueba_id'  => $prueba_id\n                        ]));\n\n                        $this->agenda_servicio->agendar($proceso_destino, $usuario, $prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n                    }\n                }\n\n                // Enviar correo de notificación\n                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso_destino);\n            }\n\n            // Actualizar las etapas de los participantes\n            $this->repositorio->disociarEtapasUsuarios($proceso_actual, array_keys($participantes));\n            $this->asociarEtapasUsuarios($proceso_destino, $participantes);\n        }\n    }\n\n    /**\n     * Eliminar un participante de un proceso.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param int $usuario_id ID del usuario.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function eliminarParticipante(int $proceso_id, int $usuario_id): void {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        $this->repositorio->disociarEtapasUsuarios($proceso, [$usuario_id]);\n        $this->agenda_repositorio->eliminarAvanzado(new Request([\n            'proceso_id'  => $proceso_id,\n            'evaluado_id' => $usuario_id\n        ]), true);\n\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'empresa_id'  => $proceso->empresa_id,\n            'evaluado_id' => $usuario_id\n        ]));\n\n        // Si no existen agendas para la misma empresa, entonces se elimina el usuario como candidato de esa empresa\n        if (count($agendas) == 0) {\n            $this->empresa_usuario_repositorio->eliminarPorEmpresaUsuarioRol(new Request([\n                'empresa_id' => $proceso->empresa_id,\n                'usuario_id' => $usuario_id,\n                'rol_id'     => $this->rol_repositorio::ROL_EVALUADO_ID\n            ]));\n        }\n    }\n\n    /**\n     * Agregar participantes al proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petición.\n     * @throws Exception Si la dirección de correo electrónico de nuevo participante ya fue tomada por otro usuario.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function agregarParticipantes(int $id, Request $request): void {\n        $proceso              = $this->repositorio->getUno($id);\n        $fecha_cierre_agendas = $this->calcularFechaCierreAgendas($request);\n        $this->validarFechas($fecha_cierre_agendas, $proceso->fecha_cierre, $id);\n        $request->merge([\n            'fecha_limite'    => $fecha_cierre_agendas,\n            'capturar_camara' => $proceso->capturar_camara,\n            'capturar_video'  => $proceso->capturar_video\n        ]);\n\n        // Guardar participantes\n        $this->guardarParticipantes($proceso, $request);\n        $this->repositorio->actualizar($proceso->id, ['estado_id' => EstadoProceso::ACTIVO_ID]);\n    }\n\n    /**\n     * Validar las fechas de cierre del proceso y sus agendas.\n     *\n     * @param string $fecha_cierre_agendas Fecha de cierre de agendas.\n     * @param string|null $fecha_cierre_proceso Fecha de cierre del proceso.\n     * @param int|null $id ID del proceso.\n     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalización del proceso.\n     * @throws Exception Si la fecha de finalización del proceso es anterior a la fecha de las agendas existentes.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function validarFechas(string $fecha_cierre_agendas, ?string $fecha_cierre_proceso = null, ?int $id = null): void {\n        $fecha_cierre_agendas = Carbon::createFromDate($fecha_cierre_agendas);\n\n        if ($fecha_cierre_agendas < now()) {\n            throw new Exception('La fecha de vencimiento de las agendas no puede ser anterior a la fecha actual.', 400);\n        }\n\n        if (!is_null($fecha_cierre_proceso)) {\n            // Validar que la fecha de vencimiento de las agendas no sea posterior a la fecha de cierre del proceso\n            if ($fecha_cierre_agendas > $fecha_cierre_proceso) {\n                throw new Exception('La fecha de vencimiento de las agendas no puede ser posterior a la fecha de finalización del proceso.', 400);\n            }\n\n            // Validar que la fecha de cierre del proceso no sea anterior a la fecha de las agendas existentes\n            if (!is_null($id) && $this->agenda_repositorio->existenAgendasPosterioresAlCierreDelProceso($id, $fecha_cierre_proceso)) {\n                throw new Exception('La fecha de finalización del proceso no puede ser anterior a la fecha de las agendas existentes.', 400);\n            }\n        }\n    }\n\n    /**\n     * Reagendar participantes.\n     *\n     * @param Request $request Contenido de la petición.\n     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalización del proceso.\n     * @throws Exception Si la fecha de finalización del proceso es anterior a la fecha de las agendas existentes.\n     * @return array Información sobre el reagendamiento realizado.\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function reagendarParticipantes(Request $request): array {\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n\n        // Validar la configuración de captura de cámara y vídeo\n        if ($request->filled('capturar_camara') && filter_var($request->capturar_camara, FILTER_VALIDATE_BOOLEAN) && !$proceso->capturar_camara) {\n            $request->merge(['capturar_camara' => false]);\n        }\n\n        if ($request->filled('capturar_video') && filter_var($request->capturar_video, FILTER_VALIDATE_BOOLEAN) && !$proceso->capturar_video) {\n            $request->merge(['capturar_video' => false]);\n        }\n\n        $request->merge(['fecha_cierre' => $this->calcularFechaCierreAgendas($request)]);\n        $this->validarFechas($request->fecha_cierre, $proceso->fecha_cierre, $proceso->id);\n\n        $resultado = [\n            'agendas_reagendadas'       => 0,\n            'agendas_reprogramadas'     => 0,\n            'agendas_omitidas'          => 0,\n            'participantes_notificados' => 0,\n            'limite_agendas'            => 0,\n            'mensajes_limite'           => []\n        ];\n\n        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);\n\n        foreach ($request->participantes as $participante_id) {\n            $usuario                       = $this->usuario_repositorio->getUno($participante_id);\n            $agendas_usuario_reagendadas   = 0;\n            $agendas_usuario_reprogramadas = 0;\n            $agendas_usuario_omitidas      = 0;\n\n            if ($request->filled('email')) {\n                $usuario->email = $request->email;\n            }\n\n            foreach ($request->pruebas as $prueba_id) {\n                // Obtener agendas en estado agendadas, iniciadas o expiradas para esta prueba específica\n                $agendas_activas = $this->agenda_repositorio->getTodo(new Request([\n                    'proceso_id'  => $proceso->id,\n                    'evaluado_id' => $participante_id,\n                    'prueba_id'   => $prueba_id,\n                    'estados_ids' => [EstadoAgenda::AGENDADA_ID, EstadoAgenda::INICIADA_ID, EstadoAgenda::EXPIRADA_ID]\n                ]));\n\n                if ($agendas_activas->isNotEmpty()) {\n                    // Si ya existe una agenda AGENDADA, INICIADA o EXPIRADA, solo actualizar la primera\n                    $agenda_activa = $agendas_activas->first();\n\n                    // Cuando la agenda tiene estado expirada, se resetea todo y se devuelve a estado sin iniciar\n                    if ($agenda_activa->estado_id === EstadoAgenda::EXPIRADA_ID) {\n                        $this->agenda_servicio->restablecerAgenda($agenda_activa->id);\n                    }\n\n                    $this->agenda_repositorio->actualizar($agenda_activa->id, Arr::only($request->all(), ['estado_id', 'fecha_cierre', 'capturar_camara', 'capturar_video']));\n                    $agendas_usuario_reprogramadas++;\n                } else {\n                    // Si no existe agenda activa, buscar la agenda principal más reciente para reagendar\n                    $agenda_principal = $this->agenda_repositorio->getTodo(new Request([\n                        'proceso_id'             => $proceso->id,\n                        'evaluado_id'            => $participante_id,\n                        'prueba_id'              => $prueba_id,\n                        'solo_principales'       => true,\n                        'contar_reagendamientos' => true\n                    ]))->first();\n\n                    if (!$agenda_principal) {\n                        continue; // Si no existe agenda para esta prueba, continuar con la siguiente\n                    }\n                    // Se agrega 1 conteo más porque el límite de reagendamientos es el límite de pruebas - Hablado con yhey 25/09/2025\n                    $agenda_principal->reagendamientos++;\n                    $resultado['limite_agendas'] = intval($configuracion->valor);\n\n                    // Validar límite máximo de 3 reagendamientos\n                    if ($agenda_principal->reagendamientos >= intval($configuracion->valor)) {\n                        $agendas_usuario_omitidas++;\n\n                        $resultado['mensajes_limite'][] = [\n                            'participante'    => $usuario->nombre_completo,\n                            'prueba'          => $agenda_principal->prueba->nombre ?? 'Prueba sin nombre',\n                            'reagendamientos' => $agenda_principal->reagendamientos\n                        ];\n\n                        continue;\n                    }\n\n                    // Crear nueva agenda (reagendamiento)\n                    $datos                    = Arr::only($agenda_principal->toArray(), ['empresa_id', 'proceso_id', 'prueba_id', 'baremo_id', 'perfil_id', 'evaluador_id', 'evaluado_id', 'cargo_id', 'clasificacion_id', 'ajuste']);\n                    $datos['agenda_id']       = $agenda_principal->id;\n                    $datos['estado_id']       = EstadoAgenda::AGENDADA_ID;\n                    $datos['fecha_inicio']    = now();\n                    $datos['fecha_cierre']    = $request->fecha_cierre;\n                    $datos['capturar_camara'] = $request->capturar_camara ?? false;\n                    $datos['capturar_video']  = $request->capturar_video ?? false;\n                    $this->agenda_repositorio->crear($datos);\n\n                    $agendas_usuario_reagendadas++;\n                }\n            }\n\n            $resultado['agendas_reagendadas']   += $agendas_usuario_reagendadas;\n            $resultado['agendas_reprogramadas'] += $agendas_usuario_reprogramadas;\n            $resultado['agendas_omitidas']      += $agendas_usuario_omitidas;\n\n            // Enviar correo de notificación si se reagendó o reprogramó al menos una agenda para este usuario\n            if ($agendas_usuario_reagendadas > 0 || $agendas_usuario_reprogramadas > 0) {\n                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso, $proceso->mostrar_logo_aplicante);\n                $resultado['participantes_notificados']++;\n            }\n        }\n\n        return $resultado;\n    }\n\n    /**\n     * Asociar etapas de usuarios al proceso.\n     *\n     * Si el usuario ya tiene una etapa asociada al proceso, entonces no se guardará el registro.\n     *\n     * @param Proceso $proceso Proceso.\n     * @param array $usuarios ID's de los usuarios con sus etapas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function asociarEtapasUsuarios(Proceso $proceso, array $usuarios): void {\n        foreach (array_keys($usuarios) as $usuario_id) {\n            $existe = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n                'usuario_id' => $usuario_id,\n                'proceso_id' => $proceso->id\n            ]));\n\n            if ($existe) {\n                unset($usuarios[$usuario_id]);\n            }\n        }\n\n        $this->repositorio->asociarEtapasUsuarios($proceso, $usuarios);\n    }\n\n    /**\n     * Envíar el mensaje de correo electrónico que contiene el link del proceso a todos los destinatarios.\n     *\n     * @param Request $request Contenido de la petición HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function compartirProceso(Request $request): void {\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n\n        foreach ($request->emails_destinatarios as $email_destinatario) {\n            Mail::to($email_destinatario)\n                ->queue(new CompartirProcesoMail(\n                    $proceso,\n                    trim(strtolower($email_destinatario)),\n                    $request->fecha_hora_expiracion,\n                    $request->contenido\n                ));\n        }\n    }\n\n    /**\n     * Envíar el mensaje de correo electrónico que contiene el link de los resultados de un usuario aplicante en un proceso a todos los destinatarios.\n     *\n     * @param Request $request Contenido de la petición HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function compartirResultadosProcesoAplicante(Request $request): void {\n        foreach ($request->emails_destinatarios as $email_destinatario) {\n            Mail::to($email_destinatario)\n                ->queue(new CompartirResultadosProcesoMail(\n                    $this->repositorio->getUno($request->proceso_id),\n                    $this->usuario_repositorio->getUno($request->aplicante_id),\n                    trim(strtolower($email_destinatario)),\n                    $request->fecha_hora_expiracion,\n                    $request->contenido\n                ));\n        }\n    }\n\n    /**\n     * Obtener las pruebas que tiene que realizar el aplicante, agrupadas por proceso.\n     *\n     * Se filtran los resultados de tal manera que obtenga únicamente los que tienen agendas\n     * pendientes por completar.\n     *\n     * Se modificó esta función para retornar no solamente las pruebas de los usuarios con rol\n     * aplicante si no tambien los que tienen rol de tipo empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function obtenerPruebasAplicante(Request $request): Collection {\n        $orden_pruebas = [\n            Prueba::IQ_FACTORIAL_ID,\n            Prueba::TEN_DISC_PLUS_ID,\n            Prueba::TEN_DISC_ID,\n            Prueba::POTENCIAL_COMERCIAL_ID,\n            Prueba::PRUEBA_ESTATAL_ID,\n            Prueba::ETHIKOS_ID,\n            Prueba::ETHIKOS_RIESGOS_ID,\n            Prueba::VYP_ID\n        ];\n\n        $procesos = $this->repositorio->obtenerPruebasAplicante($request)\n            ->filter(function ($proceso) {\n                $agendas_completadas = $proceso->agendas->filter(function ($agenda) {\n                    return in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n                });\n\n                return $agendas_completadas->count() !== $proceso->agendas->count();\n            })\n            ->each(function ($proceso) use ($orden_pruebas) { // Ordenar las agendas según la prueba a la que pertenezcan\n                $agendas_pendientes = $proceso->agendas->filter(function ($agenda) {\n                    return !in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n                });\n\n                $agendas_ordenadas = $agendas_pendientes->sortBy(function ($agenda) use ($orden_pruebas) {\n                    $posicion = array_search($agenda->prueba_id, $orden_pruebas);\n                    return !$posicion ? $posicion : 999;\n                })->values();\n\n                // Se asigna de esta forma, ya que, de no hacerlo, nunca se asigna el valor modificado a la relación\n                $proceso->setRelation('agendas', $agendas_ordenadas);\n            })\n            ->filter(function ($proceso) {\n                return $proceso->agendas->isNotEmpty();\n            });\n\n        return $procesos;\n    }\n\n    /**\n     * Obtener pruebas completadas del aplicante (agendas finalizadas o expiradas).\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function obtenerPruebasAplicanteCompletadas(Request $request): Collection {\n        $orden_pruebas = [\n            Prueba::IQ_FACTORIAL_ID,\n            Prueba::TEN_DISC_PLUS_ID,\n            Prueba::TEN_DISC_ID,\n            Prueba::POTENCIAL_COMERCIAL_ID,\n            Prueba::PRUEBA_ESTATAL_ID,\n            Prueba::ETHIKOS_ID,\n            Prueba::ETHIKOS_RIESGOS_ID,\n            Prueba::VYP_ID\n        ];\n\n        // Agregar el parámetro para incluir procesos cerrados\n        $request->merge(['incluir_procesos_cerrados' => true]);\n\n        $procesos = $this->repositorio->obtenerPruebasAplicante($request)\n            ->each(function ($proceso) use ($orden_pruebas) { // Filtrar y ordenar solo agendas completadas\n                // Filtrar solo agendas completadas (finalizadas o expiradas)\n                $agendas_completadas = $proceso->agendas->filter(function ($agenda) {\n                    return in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n                });\n\n                $agendas_ordenadas = $agendas_completadas->sortBy(function ($agenda) use ($orden_pruebas) {\n                    $posicion = array_search($agenda->prueba_id, $orden_pruebas);\n                    return !$posicion ? $posicion : 999;\n                })->values();\n\n                // Calcular IQ para agendas de IQ Factorial finalizadas\n                $agendas_ordenadas = $agendas_ordenadas->map(function ($agenda) {\n                    if ($agenda->prueba_id == Prueba::IQ_FACTORIAL_ID && $agenda->estado_id == Agenda::ESTADO_FINALIZADA_ID) {\n                        // Cargar la relación dimension.factor si no está cargada\n                        if (!$agenda->resultados->first()?->relationLoaded('dimension')) {\n                            $agenda->load('resultados.dimension.factor');\n                        }\n\n                        // Agrupar resultados por factor_id y obtener todas las dimensiones\n                        $resultados_por_factor = $agenda->resultados->groupBy(function ($resultado) {\n                            return $resultado->dimension->factor_id ?? null;\n                        })->filter(fn($grupo, $llave) => !is_null($llave));\n\n                        $dimensiones = $resultados_por_factor->flatten()->values();\n\n                        if ($dimensiones->count() > 0 && $resultados_por_factor->count() > 0) {\n                            $agenda->iq = round($this->calcularIQ($dimensiones->toArray(), $resultados_por_factor->count()));\n                        }\n                    }\n\n                    return $agenda;\n                });\n\n                // Se asigna de esta forma, ya que, de no hacerlo, nunca se asigna el valor modificado a la relación\n                $proceso->setRelation('agendas', $agendas_ordenadas);\n            })\n            ->filter(function ($proceso) {\n                // Solo incluir procesos que tengan al menos una agenda completada\n                return $proceso->agendas->isNotEmpty();\n            });\n\n        return $procesos;\n    }\n\n    /**\n     * Obtener resultados de las agendas finalizadas de un proceso para exportar a Excel.\n     *\n     * Genera un array con la información de cada participante incluyendo datos personales,\n     * puntajes de factores y dimensiones, y conceptos de recomendación basados en rangos.\n     *\n     * @param int $proceso_id Id del proceso.\n     * @param array $evaluados_ids Array de IDs de evaluados a filtrar (opcional).\n     * @param bool $reporte_comparativo Indica si es para reporte comparativo (opcional).\n     * @return array Array con resultados agrupados por prueba con estructura:\n     *               ['prueba_id' => ['nombre_prueba' => string, 'resultados' => array]]\n     * @author Sergio Vargas\n     * @author Andres Morales\n     */\n    public function resultadosProcesoAgendas(int $proceso_id, array $evaluados_ids = [], bool $reporte_comparativo = false): array {\n        $resultados                       = [];\n        $datos_resultados_proceso_agendas = $this->agenda_repositorio->obtenerDatosResultadosProcesoAgendas($proceso_id, $evaluados_ids);\n\n        if (count($datos_resultados_proceso_agendas) === 0) {\n            return [];\n        }\n\n        foreach ($datos_resultados_proceso_agendas as $datos_agenda) {\n            if (!array_key_exists($datos_agenda->prueba_id, $resultados)) {\n                $resultados[$datos_agenda->prueba_id] = [\n                    'nombre_prueba'      => $datos_agenda->prueba->nombre,\n                    'nombre_prueba_slug' => Str::slug($datos_agenda->prueba->nombre),\n                    'resultados'         => []\n                ];\n            }\n\n            $ajuste        = $datos_agenda->ajuste ?? 0;\n            $concepto      = $this->calcularConcepto($ajuste);\n            $nombre_perfil = $datos_agenda->perfil ? $datos_agenda->perfil->nombre : '';\n\n            $campos = $reporte_comparativo ? ['id_agenda', 'nombre', 'documento', 'perfil', 'correo', 'ajuste', 'concepto'] : ['ID Agenda', 'Nombre', 'Documento', 'Perfil', 'Correo', 'Ajuste', 'Concepto'];\n\n            $valores = [\n                $datos_agenda->id,\n                $datos_agenda->evaluado->nombres . ' ' . $datos_agenda->evaluado->apellidos,\n                $datos_agenda->evaluado->documento ?? '',\n                $nombre_perfil,\n                $datos_agenda->evaluado->email ?? '',\n                round($ajuste, 2),\n                $concepto\n            ];\n\n            $nueva_fila_prueba = array_combine($campos, $valores);\n\n            if ($datos_agenda->perfil) {\n                foreach ($datos_agenda->perfil->factoresPerfiles as $factor_perfil) {\n                    $factor         = $factor_perfil->factor;\n                    $puntaje_factor = $this->calcularPuntajeFactorPerfil($factor_perfil, $datos_agenda);\n\n                    if ($reporte_comparativo) {\n                        $factor_data = [\n                            'nombre'      => $factor->nombre,\n                            'nombre_slug' => Str::slug($factor->nombre),\n                            'value'       => round($puntaje_factor, 2),\n                            'type'        => 'factor',\n                            'dimensiones' => []\n                        ];\n\n                        foreach ($factor_perfil->dimensionesFactoresPerfiles as $dimension_factor_perfil) {\n                            $dimension                    = $dimension_factor_perfil->dimension;\n                            $resultado                    = $datos_agenda->resultados->where('dimension_id', $dimension->id)->first();\n                            $factor_data['dimensiones'][] = [\n                                'nombre'      => $dimension->nombre,\n                                'nombre_slug' => Str::slug($dimension->nombre),\n                                'value'       => $resultado ? round($resultado->puntaje_transformado, 2) : '',\n                                'type'        => 'dimension'\n                            ];\n                        }\n\n                        $nueva_fila_prueba['factores'][] = $factor_data;\n                    } else {\n                        $nueva_fila_prueba[$factor->nombre] = [\n                            'value' => round($puntaje_factor, 2),\n                            'type'  => 'factor'\n                        ];\n\n                        foreach ($factor_perfil->dimensionesFactoresPerfiles as $dimension_factor_perfil) {\n                            $dimension                             = $dimension_factor_perfil->dimension;\n                            $resultado                             = $datos_agenda->resultados->where('dimension_id', $dimension->id)->first();\n                            $nueva_fila_prueba[$dimension->nombre] = [\n                                'value' => $resultado ? round($resultado->puntaje_transformado, 2) : '',\n                                'type'  => 'dimension'\n                            ];\n                        }\n                    }\n                }\n            }\n\n            $resultados[$datos_agenda->prueba_id]['resultados'][] = $nueva_fila_prueba;\n        }\n\n        return $resultados;\n    }\n\n    /**\n     * Generar datos de resumen de participantes para exportación Excel.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param array $evaluados_ids Array de IDs de evaluados a filtrar (opcional).\n     * @return array Array con datos de resumen por participante.\n     * @author Sergio Vargas\n     */\n    public function generarResumenParticipantes(int $proceso_id, array $evaluados_ids = []): array {\n        $todas_las_agendas        = $this->agenda_repositorio->obtenerAgendasParaResumenParticipantes($proceso_id, $evaluados_ids);\n        $proceso                  = $this->repositorio->getUno($proceso_id);\n        $resumen_participantes    = [];\n        $agendas_por_participante = $todas_las_agendas->groupBy('evaluado_id');\n\n        $resultados_detallados = $this->resultadosProcesoAgendas($proceso_id, $evaluados_ids);\n\n        foreach ($agendas_por_participante as $evaluado_id => $agendas_participante) {\n            $primer_agenda = $agendas_participante->first();\n            $evaluado      = $primer_agenda->evaluado;\n\n            $total_asignadas   = $agendas_participante->count();\n            $finalizadas       = $agendas_participante->where('estado_id', Agenda::ESTADO_FINALIZADA_ID);\n            $total_finalizadas = $finalizadas->count();\n\n            $porcentaje = $total_asignadas > 0 ? round(($total_finalizadas / $total_asignadas) * 100, 1) : 0;\n\n            $nombres_pruebas_finalizadas = $finalizadas->map(function ($agenda) {\n                return $agenda->prueba->nombre ?? 'Prueba sin nombre';\n            })->unique()->implode(', ');\n\n            $ultima_finalizacion = $finalizadas->max('fecha_procesamiento') ?? $finalizadas->max('updated_at');\n\n            $indice_talento         = $this->repositorio->obtenerIndiceTalento($proceso_id, $evaluado_id);\n            $indice_talento_valor   = $indice_talento->indice_talento ?? 0;\n            $indice_talento_display = $indice_talento_valor;\n\n            if ($indice_talento_valor == -2) {\n                $indice_talento_display = 'Pruebas pendientes';\n            } elseif ($indice_talento_valor == -1) {\n                $indice_talento_display = 'Procesamiento pendiente';\n            }\n\n            $concepto = '';\n\n            if (is_numeric($indice_talento_valor)) {\n                $concepto = $this->calcularConcepto($indice_talento_valor);\n            }\n\n            $fila_participante = [\n                'nombre'         => $evaluado->nombre_completo,\n                'documento'      => $evaluado->documento ?? '',\n                'correo'         => $evaluado->email ?? '',\n                'edad'           => $evaluado->edad,\n                'proceso'        => $proceso->nombre ?? '',\n                'indice_talento' => $indice_talento_display,\n                'concepto'       => $concepto\n            ];\n\n            foreach ($resultados_detallados as $prueba_id => $datos_prueba) {\n                $nombre_prueba = $datos_prueba['nombre_prueba'];\n                $ajuste_prueba = '';\n\n                foreach ($datos_prueba['resultados'] as $resultado) {\n                    $nombre_participante    = $resultado['Nombre'];\n                    $documento_participante = $resultado['Documento'];\n\n                    if ($evaluado->nombre_completo === $nombre_participante || $evaluado->documento === $documento_participante) {\n                        $ajuste_prueba = $resultado['Ajuste'];\n                        break;\n                    }\n                }\n\n                $fila_participante[$nombre_prueba] = $ajuste_prueba;\n            }\n\n            $resumen_participantes[] = $fila_participante;\n        }\n\n        return $resumen_participantes;\n    }\n\n    /**\n     * Calcular concepto de recomendación basado en el puntaje de ajuste.\n     *\n     * Determina el nivel de recomendación de un candidato según su puntaje de ajuste:\n     * - 0-60: No recomendado\n     * - 60-76: Recomendado con sugerencias\n     * - 76-100: Recomendado\n     *\n     * @param float $ajuste Puntaje de ajuste del candidato (0-100).\n     * @return string Concepto de recomendación correspondiente.\n     * @author Sergio Vargas\n     */\n    private function calcularConcepto(float $ajuste): string {\n        if ($ajuste >= 0 && $ajuste < 60) {\n            return 'No recomendado';\n        } elseif ($ajuste >= 60 && $ajuste < 76) {\n            return 'Recomendado con sugerencias';\n        } elseif ($ajuste >= 76 && $ajuste <= 100) {\n            return 'Recomendado';\n        }\n\n        return 'Sin evaluar';\n    }\n\n    /**\n     * Calcular puntaje de un factor basado en los pesos de sus dimensiones.\n     *\n     * Utiliza la configuración de pesos del perfil asignado a la agenda para calcular\n     * el puntaje ponderado del factor. Cada dimensión contribuye al puntaje final\n     * según su peso configurado en el perfil.\n     *\n     * @param object $factor Factor a calcular.\n     * @param object $agenda Agenda con los resultados y perfil asignado.\n     * @return float Puntaje calculado del factor, 0.0 si no hay configuración o datos.\n     * @author Sergio Vargas\n     */\n    private function calcularPuntajeFactor($factor, $agenda): float {\n        if (!$agenda->perfil_id) {\n            return 0.0;\n        }\n\n        $factor_perfil = $factor->factoresPerfiles->where('perfil_id', $agenda->perfil_id)->first();\n\n        if (!$factor_perfil) {\n            return 0.0;\n        }\n\n        $dimensiones_factor_perfil = $factor_perfil->dimensionesFactoresPerfiles ?? collect();\n        $puntaje_total             = 0.0;\n        $peso_total                = 0.0;\n\n        foreach ($factor->dimensiones as $dimension) {\n            $resultado = $agenda->resultados->where('dimension_id', $dimension->id)->first();\n\n            if ($resultado) {\n                $dimension_factor_perfil = $dimensiones_factor_perfil->where('dimension_id', $dimension->id)->first();\n                $peso                    = $dimension_factor_perfil ? $dimension_factor_perfil->peso : 0;\n\n                $puntaje_total += $resultado->puntaje_transformado * $peso;\n                $peso_total    += $peso;\n            }\n        }\n\n        return $peso_total > 0 ? $puntaje_total / $peso_total : 0.0;\n    }\n\n    /**\n     * Calcular el puntaje de un factor específico usando el FactorPerfil directamente.\n     *\n     * @param object $factor_perfil FactorPerfil con dimensiones cargadas.\n     * @param object $agenda Agenda con los resultados.\n     * @return float Puntaje calculado del factor.\n     * @author Sergio Vargas\n     */\n    private function calcularPuntajeFactorPerfil($factor_perfil, $agenda): float {\n        $dimensiones_factor_perfil = $factor_perfil->dimensionesFactoresPerfiles;\n        $puntaje_total             = 0.0;\n        $peso_total                = 0.0;\n\n        foreach ($dimensiones_factor_perfil as $dimension_factor_perfil) {\n            $resultado = $agenda->resultados->where('dimension_id', $dimension_factor_perfil->dimension_id)->first();\n\n            if ($resultado) {\n                $peso = $dimension_factor_perfil->peso;\n                $puntaje_total += $resultado->puntaje_transformado * $peso;\n                $peso_total    += $peso;\n            }\n        }\n\n        return $peso_total > 0 ? $puntaje_total / $peso_total : 0.0;\n    }\n\n    /**\n     * Actualizar campos de captura de cámara y video en agendas con estado AGENDADA.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param bool $capturar_camara Configuración para capturar cámara.\n     * @param bool $capturar_video Configuración para capturar video.\n     * @return void\n     * @author Andres Morales\n     */\n    private function actualizarCamposCapturarEnAgendas(int $proceso_id, bool $capturar_camara, bool $capturar_video): void {\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id' => $proceso_id,\n            'estado_id'  => EstadoAgenda::AGENDADA_ID\n        ]));\n\n        if ($agendas->count() > 0) {\n            $agendas_ids = $agendas->pluck('id')->toArray();\n            $this->agenda_repositorio->actualizarVarios($agendas_ids, [\n                'capturar_camara' => $capturar_camara,\n                'capturar_video'  => $capturar_video\n            ]);\n        }\n    }\n\n    /**\n     * Obtener un top 3 de los mejores candidatos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @throws Exception|GuzzleException Cuando la IA no genera el listado.\n     * @throws RequestException Cuando ocurre un error de conexión con el servicio de IA.\n     * @return array\n     * @author Andres Gonzalez\n     * @author Fahibram Cárcamo\n     */\n    public function generarMejoresCandidatosIA(Request $request): array {\n        $pruebas = $this->prueba_repositorio->getDatosBasicos(new Request(['activo' => true]));\n        $pruebas = $pruebas->map(function ($prueba) {\n            return $prueba->only(['nombre', 'descripcion']);\n        });\n\n        $candidatos = [];\n\n        foreach ($request->candidatos as $candidato) {\n            $resultados_agendas = $this->resultado_agenda_repositorio->getTodo(new Request(['agendas_ids' => $candidato['agendas']]));\n\n            $resultados_agendas_procesados = $resultados_agendas->map(function ($item) {\n                return [\n                    'competencia'         => $item->dimension->nombre,\n                    'puntaje_competencia' => $item->puntaje_transformado,\n                    'prueba_competencia'  => $item->agenda->prueba->nombre\n                ];\n            })->toArray();\n\n            $candidatos[] = [\n                'nombre'      => $candidato['nombre'],\n                'puntajes'    => $resultados_agendas_procesados,\n                'comentarios' => $candidato['comentarios'] ?? []\n            ];\n        }\n\n        $cliente = new Client([\n            'timeout' => 120,\n            'headers' => [\n                'Content-Type' => 'application/json',\n                'Accept'       => 'application/json'\n            ]\n        ]);\n\n        $tiempo_inicio = microtime(true);\n        $payload_peticion = json_encode([\n            'vacante'             => trim($request->vacante),\n            'pregunta_especifica' => trim($request->pregunta_especifica),\n            'candidatos'          => $candidatos,\n            'pruebas'             => $pruebas\n        ]);\n\n        try {\n            $respuesta = $cliente->post(env('FASTAPI_BASE_URL', 'http://localhost:8001') . '/mejores-candidatos/', [\n                'json' => [\n                    'vacante'             => trim($request->vacante),\n                    'pregunta_especifica' => trim($request->pregunta_especifica),\n                    'candidatos'          => $candidatos,\n                    'pruebas'             => $pruebas\n                ]\n            ]);\n\n            $respuesta_ia = json_decode($respuesta->getBody()->getContents(), true);\n        } catch (RequestException $error) {\n            $mensaje_error = 'Error de conexión con el servicio de IA';\n\n            if ($error->hasResponse()) {\n                $respuesta_error = json_decode($error->getResponse()->getBody()->getContents(), true);\n                $mensaje_error   = 'Error en el servicio de IA: ' . ($respuesta_error['detail'] ?? 'Error desconocido');\n            }\n\n            throw new Exception($mensaje_error);\n        }\n\n        if (!$respuesta_ia) {\n            throw new Exception('Respuesta inválida del servicio de IA');\n        }\n\n        // Normalizar estructura y extraer usage desde top_3 si viene anidado\n        $usage = $respuesta_ia['usage'] ?? null;\n        if (! $usage && isset($respuesta_ia['top_3']) && is_array($respuesta_ia['top_3'])) {\n            $usage = $respuesta_ia['top_3']['usage'] ?? null;\n            if ($usage) {\n                $respuesta_ia['usage'] = $usage;\n            }\n            if (! isset($respuesta_ia['data']) && isset($respuesta_ia['top_3']['data'])) {\n                $respuesta_ia['data'] = $respuesta_ia['top_3']['data'];\n            }\n        }\n\n        if (! $usage) {\n        }\n\n        $this->registrarConsumoTokens(\n            ruta_endpoint: 'mejores-candidatos',\n            respuesta_ia: $respuesta_ia,\n            payload_peticion: $payload_peticion,\n            latencia_ms: (int) ((microtime(true) - $tiempo_inicio) * 1000),\n            contexto: [\n                'vacante_id' => $request->vacante_id ?? null\n            ]\n        );\n\n        return $respuesta_ia ?? [];\n    }\n\n    /**\n     * Construir respuesta para reagendamientos según los resultados.\n     *\n     * @param array $resultados Resultados de los reagendamientos.\n     * @return array\n     * @author Daniel Beltrán\n     */\n    public function construirRespuestaReagendamientos(array $resultados): array {\n        $mensaje              = '';\n        $operaciones_exitosas = $resultados['agendas_reagendadas'] + $resultados['agendas_reprogramadas'];\n\n        if ($operaciones_exitosas > 0) {\n            $partes_mensaje = [];\n\n            if ($resultados['agendas_reagendadas'] > 0) {\n                $partes_mensaje[] = $resultados['agendas_reagendadas'] . ' agenda(s) reagendada(s)';\n            }\n\n            if ($resultados['agendas_reprogramadas'] > 0) {\n                $partes_mensaje[] = $resultados['agendas_reprogramadas'] . ' agenda(s) reprogramada(s)';\n            }\n\n            $mensaje = 'Operaciones realizadas correctamente. ' . implode(' y ', $partes_mensaje);\n\n            if ($resultados['participantes_notificados'] > 0) {\n                $mensaje .= ' y ' . $resultados['participantes_notificados'] . ' participante(s) notificado(s)';\n            }\n\n            $mensaje .= '.';\n        }\n\n        // Agregar información sobre agendas omitidas por límite\n        $mensajes_limite = [];\n\n        if ($resultados['agendas_omitidas'] > 0) {\n            $mensajes_limite[] = $resultados['agendas_omitidas'] . ' agenda(s) no se reagendaron por haber alcanzado el límite máximo de ' . $resultados['limite_agendas'] . ' reagendamientos.';\n\n            foreach ($resultados['mensajes_limite'] as $detalle) {\n                $mensajes_limite[] = \"• {$detalle['participante']} - {$detalle['prueba']}: {$detalle['reagendamientos']} reagendamientos previos.\";\n            }\n        }\n\n        if ($operaciones_exitosas === 0) {\n            if ($resultados['agendas_omitidas'] > 0) {\n                $mensaje = 'No se pudo reagendar ninguna agenda debido a que todas han alcanzado el límite máximo de ' . $resultados['limite_agendas'] . ' reagendamientos.';\n            } else {\n                $mensaje = 'No se encontraron agendas para reagendar o reprogramar.';\n            }\n        }\n\n        $respuesta = [\n            'message'  => $mensaje,\n            'detalles' => [\n                'limite_agendas'            => $resultados['limite_agendas'],\n                'agendas_reagendadas'       => $resultados['agendas_reagendadas'],\n                'agendas_reprogramadas'     => $resultados['agendas_reprogramadas'],\n                'agendas_omitidas'          => $resultados['agendas_omitidas'],\n                'participantes_notificados' => $resultados['participantes_notificados']\n            ]\n        ];\n\n        if (!empty($mensajes_limite)) {\n            $respuesta['advertencias'] = $mensajes_limite;\n        }\n\n        return $respuesta;\n    }\n\n    /**\n     * Archivar o desarchivar un proceso.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return array\n     * @author Andres Morales\n     */\n    public function archivarProceso(int $proceso_id): array {\n        $proceso             = $this->repositorio->getUno($proceso_id);\n        $nuevo_estado_activo = !$proceso->activo;\n        $this->repositorio->actualizar($proceso_id, ['activo' => $nuevo_estado_activo]);\n\n        return [\n            'message' => $nuevo_estado_activo\n                ? 'Proceso activado correctamente'\n                : 'Proceso archivado correctamente'\n        ];\n    }\n\n    /**\n     * Actualizar el estado de un proceso basado en el estado de sus agendas.\n     *\n     * Lógica de actualización:\n     * - Si todas las agendas están en estado terminal (FINALIZADA, EXPIRADA, INVALIDADA) → COMPLETADO\n     * - Si hay al menos una agenda activa (AGENDADA, INICIADA, SIN_PAGO) → ACTIVO\n     * - No actualiza procesos en estado CERRADO o SUSPENDIDO (estados protegidos)\n     * - No actualiza procesos sin agendas\n     *\n     * Estados terminales: FINALIZADA (3), EXPIRADA (4), INVALIDADA (5)\n     * Estados activos: AGENDADA (1), INICIADA (2), SIN_PAGO (6)\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return void\n     * @author Sergio Vargas\n     */\n    public function actualizarEstadoPorAgendas(int $proceso_id): void\n    {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        if (!$proceso) {\n            return;\n        }\n\n        if (in_array($proceso->estado_id, [EstadoProceso::CERRADO_ID, EstadoProceso::SUSPENDIDO_ID])) {\n            return;\n        }\n\n        $estadisticas = $this->repositorio->obtenerEstadisticasAgendas($proceso_id);\n\n        if ($estadisticas->total_agendas === 0) {\n            return;\n        }\n\n        $nuevo_estado_id = null;\n\n        if ($estadisticas->agendas_activas === 0 && $estadisticas->agendas_terminadas > 0) {\n            $nuevo_estado_id = EstadoProceso::COMPLETADO_ID;\n        } elseif ($estadisticas->agendas_activas > 0) {\n            $nuevo_estado_id = EstadoProceso::ACTIVO_ID;\n        }\n\n        if ($nuevo_estado_id !== null && $proceso->estado_id !== $nuevo_estado_id) {\n            $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);\n        }\n    }\n}\n","structuredPatch":[{"oldStart":663,"oldLines":7,"newStart":663,"newLines":7,"lines":["             'mensajes_limite'           => []","         ];"," ","-        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);","+        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, (int) $request->empresa_id, 45);"," ","         foreach ($request->participantes as $participante_id) {","             $usuario                       = $this->usuario_repositorio->getUno($participante_id);"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"dfdd088b-b996-4385-b863-9666798947d7"}
{"parentUuid":"e31d8c83-cd13-4250-baf6-bb5b01694354","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"dbb09d05-e94c-431c-aec6-76d67066cc95","version":"2.1.39","gitBranch":"main","slug":"cuddly-pondering-bubble","message":{"model":"claude-opus-4-6","id":"msg_019LiEGqb8AWzAMdGWagCP2C","type":"message","role":"assistant","content":[{"type":"text","text":"All 4 changes applied. Here's a summary:\n\n1. **`public/src/procesos/js/detalle.js:360`** — Changed `dato_empresa?.id` to `PROCESO.empresa_id`\n2. **`public/js/procesos/detalle.js:1236`** — Changed `dato_empresa.id` to `PROCESO.empresa_id`\n3. **`ReagendarParticipantesRequest.php`** — Added `'empresa_id' => 'required|integer'` validation rule\n4. **`ProcesoService.php:666`** — Added `(int)` cast to `$request->empresa_id`\n\nThe fix addresses the bug at three layers:\n- **Frontend**: Uses `PROCESO.empresa_id` which is always available, instead of `dato_empresa.id` which depends on DataTables loading first\n- **Validation**: Rejects requests where `empresa_id` is missing or non-integer (returns 422 instead of 500)\n- **Service**: Defensive cast ensures the value is always an `int` as expected by `obtenerConfiguracion()`"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1130,"cache_read_input_tokens":28204,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1130},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYC5oeBG3uo6VPweFF4rs","type":"assistant","uuid":"6d987f6c-d5c8-44ba-bd65-124fb2516cb5","timestamp":"2026-02-16T16:43:50.205Z"}
