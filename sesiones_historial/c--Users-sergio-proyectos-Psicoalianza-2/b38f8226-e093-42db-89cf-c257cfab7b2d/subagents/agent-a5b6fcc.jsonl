{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes."},"uuid":"aea91574-9db9-41cd-bb5d-16d8deb633bf","timestamp":"2026-01-25T01:45:44.171Z"}
{"parentUuid":"aea91574-9db9-41cd-bb5d-16d8deb633bf","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01HmRP2GZN5t3KwEmC2ki21T","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a buscar la información sobre cómo se cargan los planes en la vista \"planes-clientes\". Permíteme explorar el código de rutas, controladores y las consultas relacionadas."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15108,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15108,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXTFXmGD6nvLtqSjCW3ae","type":"assistant","uuid":"82ef362c-bb44-4550-ada4-56436640af34","timestamp":"2026-01-25T01:45:45.969Z"}
{"parentUuid":"82ef362c-bb44-4550-ada4-56436640af34","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01HmRP2GZN5t3KwEmC2ki21T","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UU67HiTLRdJYyzszzaHhxt","name":"Bash","input":{"command":"find \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" -name \"web.php\" -type f | head -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15108,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15108,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXTFXmGD6nvLtqSjCW3ae","type":"assistant","uuid":"83515fc7-968b-4375-948b-af2b1169720d","timestamp":"2026-01-25T01:45:46.498Z"}
{"parentUuid":"83515fc7-968b-4375-948b-af2b1169720d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"progress","data":{"type":"bash_progress","output":"","fullOutput":"","elapsedTimeSeconds":2,"totalLines":0},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_01UU67HiTLRdJYyzszzaHhxt","uuid":"02c09d5e-389a-4d46-9e44-31e062ea0734","timestamp":"2026-01-25T01:45:50.465Z"}
{"parentUuid":"02c09d5e-389a-4d46-9e44-31e062ea0734","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"progress","data":{"type":"bash_progress","output":"","fullOutput":"","elapsedTimeSeconds":3,"totalLines":0},"toolUseID":"bash-progress-1","parentToolUseID":"toolu_01UU67HiTLRdJYyzszzaHhxt","uuid":"f2a14554-f5e7-4599-96ac-bd77603330cd","timestamp":"2026-01-25T01:45:51.466Z"}
{"parentUuid":"83515fc7-968b-4375-948b-af2b1169720d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UU67HiTLRdJYyzszzaHhxt","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2/routes/web.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/laravel/passport/routes/web.php","is_error":false}]},"uuid":"01fe8612-6755-4227-b025-c81a176f3e68","timestamp":"2026-01-25T01:45:51.786Z","sourceToolAssistantUUID":"83515fc7-968b-4375-948b-af2b1169720d"}
{"parentUuid":"01fe8612-6755-4227-b025-c81a176f3e68","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01KyjPakBfE4JzGA6K2Xq1Ub","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a buscar la ruta \"planes-clientes\" en web.php:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":479,"cache_read_input_tokens":15108,"cache_creation":{"ephemeral_5m_input_tokens":479,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFYJrVb518RauTrsbj4","type":"assistant","uuid":"4752fc0c-cfdb-4f2d-ac27-69be39faef12","timestamp":"2026-01-25T01:45:54.850Z"}
{"parentUuid":"4752fc0c-cfdb-4f2d-ac27-69be39faef12","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01KyjPakBfE4JzGA6K2Xq1Ub","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GBchWp3tHFNpnFBUsuoLvC","name":"Grep","input":{"pattern":"planes-clientes|planes/clientes","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":479,"cache_read_input_tokens":15108,"cache_creation":{"ephemeral_5m_input_tokens":479,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFYJrVb518RauTrsbj4","type":"assistant","uuid":"8618a574-fb69-4401-8a69-75b0c5d2444d","timestamp":"2026-01-25T01:45:57.639Z"}
{"parentUuid":"8618a574-fb69-4401-8a69-75b0c5d2444d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GBchWp3tHFNpnFBUsuoLvC","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:216:                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');"}]},"uuid":"7c62ab51-bc1d-4941-b276-d3f54d4c459d","timestamp":"2026-01-25T01:45:59.328Z","sourceToolAssistantUUID":"8618a574-fb69-4401-8a69-75b0c5d2444d"}
{"parentUuid":"7c62ab51-bc1d-4941-b276-d3f54d4c459d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_014Yp51eRZ2kfB7jyWdLwBJk","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora voy a buscar el controlador de Planes y el método `planesClientes`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":239,"cache_read_input_tokens":15587,"cache_creation":{"ephemeral_5m_input_tokens":239,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFYs3kEoxjspqkh83oA","type":"assistant","uuid":"30b69247-2865-4859-9f81-93f9b5b1cf64","timestamp":"2026-01-25T01:46:01.296Z"}
{"parentUuid":"30b69247-2865-4859-9f81-93f9b5b1cf64","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_014Yp51eRZ2kfB7jyWdLwBJk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013DXyQxtWoePxwMprtxsgfJ","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":239,"cache_read_input_tokens":15587,"cache_creation":{"ephemeral_5m_input_tokens":239,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFYs3kEoxjspqkh83oA","type":"assistant","uuid":"029b8103-e160-45d8-9f0a-0553175338fb","timestamp":"2026-01-25T01:46:01.339Z"}
{"parentUuid":"029b8103-e160-45d8-9f0a-0553175338fb","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013DXyQxtWoePxwMprtxsgfJ","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"527dc18c-ec2e-4181-a921-e174f84029a5","timestamp":"2026-01-25T01:46:02.398Z","sourceToolAssistantUUID":"029b8103-e160-45d8-9f0a-0553175338fb"}
{"parentUuid":"527dc18c-ec2e-4181-a921-e174f84029a5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01G4DrEqoyYJSrYJQ7r3KDuy","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente. Encontré el método `planesClientes()`. Ahora necesito ver cómo funciona `EmpresaPlanService` específicamente el método `obtenerPlanActivo` y `obtenerUltimoPorTipo`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5350,"cache_read_input_tokens":15826,"cache_creation":{"ephemeral_5m_input_tokens":5350,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFZ7BJamQi7rXsynMHC","type":"assistant","uuid":"150cf198-d883-4bcd-b76e-977edd1622a8","timestamp":"2026-01-25T01:46:04.825Z"}
{"parentUuid":"150cf198-d883-4bcd-b76e-977edd1622a8","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01G4DrEqoyYJSrYJQ7r3KDuy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LLHWZMAMeHcANM55seEdc8","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5350,"cache_read_input_tokens":15826,"cache_creation":{"ephemeral_5m_input_tokens":5350,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFZ7BJamQi7rXsynMHC","type":"assistant","uuid":"dd2fcb8d-2963-459b-a04e-4537e9747e41","timestamp":"2026-01-25T01:46:05.504Z"}
{"parentUuid":"dd2fcb8d-2963-459b-a04e-4537e9747e41","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01G4DrEqoyYJSrYJQ7r3KDuy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CZBizeznamMmE2XrEgAHDU","name":"Glob","input":{"pattern":"app/Http/Repositories/Empresas/**/*Repository.php","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5350,"cache_read_input_tokens":15826,"cache_creation":{"ephemeral_5m_input_tokens":5350,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFZ7BJamQi7rXsynMHC","type":"assistant","uuid":"ae4d9267-c354-4d8d-a046-7fd4c29ad80d","timestamp":"2026-01-25T01:46:05.947Z"}
{"parentUuid":"dd2fcb8d-2963-459b-a04e-4537e9747e41","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LLHWZMAMeHcANM55seEdc8","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Empresas;\n     4→\n     5→use Exception;\n     6→use Carbon\\Carbon;\n     7→use App\\Models\\Planes\\Plan;\n     8→use Illuminate\\Support\\Arr;\n     9→use App\\Traits\\ArchivoTrait;\n    10→use Illuminate\\Http\\Request;\n    11→use App\\Mail\\CrearUsuarioMail;\n    12→use Illuminate\\Http\\UploadedFile;\n    13→use App\\Http\\Services\\BaseService;\n    14→use App\\Models\\Pruebas\\TipoPrueba;\n    15→use Illuminate\\Support\\Collection;\n    16→use App\\Models\\Empresas\\EmpresaPlan;\n    17→use Illuminate\\Support\\Facades\\Notification;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use Illuminate\\Support\\Facades\\{Mail, Password};\n    20→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    23→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    24→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    25→use App\\Notifications\\SolicitudRenovacionPlanNotification;\n    26→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    27→use Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n    28→\n    29→/**\n    30→ * @property EmpresaPlanRepository $repositorio\n    31→ */\n    32→class EmpresaPlanService extends BaseService\n    33→{\n    34→    use ArchivoTrait;\n    35→\n    36→    /**\n    37→     * Constructor.\n    38→     *\n    39→     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n    40→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    41→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    42→     * @param PlanRepository $plan_repositorio Repositorio de planes.\n    43→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    44→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    45→     * @return void\n    46→     * @author Daniel Beltrán\n    47→     */\n    48→    public function __construct(\n    49→        EmpresaPlanRepository $repositorio,\n    50→        protected EmpresaRepository $empresa_repositorio,\n    51→        protected RolRepository $rol_repositorio,\n    52→        protected PlanRepository $plan_repositorio,\n    53→        protected PlanCreditoRepository $plan_credito_repositorio,\n    54→        protected ArchivoRepository $archivo_repositorio,\n    55→        protected UserRepository $usuario_repositorio\n    56→    ) {\n    57→        parent::__construct($repositorio);\n    58→    }\n    59→\n    60→    /**\n    61→     * Guardar un plan de empresa.\n    62→     *\n    63→     * @param Request $request Contenido de la petición.\n    64→     * @return EmpresaPlan\n    65→     * @author Sergio Vargas\n    66→     * @author Daniel Beltrán\n    67→     * @author Andres Morales\n    68→     * @author Jair Carvajal\n    69→     * @author Andres Gonzalez\n    70→     */\n    71→    public function guardar(Request $request): EmpresaPlan {\n    72→        $tiene_plan_seleccion = $request->filled('plan_id');\n    73→        $tiene_plan_creditos  = $request->filled('plan_credito_id');\n    74→        $plan_asignado        = null;\n    75→\n    76→        // Si tiene plan de selección, crear/actualizar ese plan\n    77→        if ($tiene_plan_seleccion) {\n    78→            $plan_asignado = $this->guardarPlanSeleccion($request);\n    79→        }\n    80→\n    81→        // Si tiene plan de créditos, crear ese plan por separado\n    82→        if ($tiene_plan_creditos) {\n    83→            $plan_creditos = $this->guardarPlanCreditos($request);\n    84→\n    85→            // Si no había plan de selección, retornar el de créditos\n    86→            if (!$tiene_plan_seleccion) {\n    87→                $plan_asignado = $plan_creditos;\n    88→            }\n    89→        }\n    90→\n    91→        return $plan_asignado;\n    92→    }\n    93→\n    94→    /**\n    95→     * Guardar un plan de selección.\n    96→     *\n    97→     * @param Request $request Contenido de la petición.\n    98→     * @return EmpresaPlan\n    99→     * @author Andres Gonzalez\n   100→     */\n   101→    protected function guardarPlanSeleccion(Request $request): EmpresaPlan {\n   102→        $enviar_correo    = false;\n   103→        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades', 'precio_creditos', 'porcentaje_descuento_creditos', 'plan_credito_id', 'creditos'];\n   104→        $plan             = $this->plan_repositorio->getUno($request->plan_id);\n   105→        $plan_activo      = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n   106→        $vigencia         = $plan->vigencia;\n   107→\n   108→        if ($request->filled('vigencia')) {\n   109→            $vigencia = $request->vigencia;\n   110→        }\n   111→\n   112→        if (!is_null($plan_activo)) {\n   113→            if ($request->filled('id')) {\n   114→                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n   115→                if ($request->id === $plan_activo->id) {\n   116→                    goto omitir_calcular_vigencia_seleccion;\n   117→                }\n   118→\n   119→                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n   120→                if ($vigencia == $request->vigencia) {\n   121→                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n   122→                    goto omitir_calcular_vigencia_seleccion;\n   123→                }\n   124→            }\n   125→\n   126→            // Poner el nuevo plan como proximo\n   127→            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n   128→\n   129→            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n   130→            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n   131→                // Agregar las nuevas fechas al nuevo plan\n   132→                $hoy          = now();\n   133→                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n   134→                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n   135→            }\n   136→        } else {\n   137→            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   138→\n   139→            // Validar si el plan seleccionado tiene vigencia\n   140→            if (!is_null($plan->vigencia)) {\n   141→                $request->merge($this->calcularFechasVigencia($vigencia));\n   142→            }\n   143→        }\n   144→\n   145→        omitir_calcular_vigencia_seleccion:\n   146→\n   147→        if (!$request->filled('unidades')) {\n   148→            $request->merge(['unidades' => $plan->unidades]);\n   149→        } elseif ($request->unidades != $plan->unidades) {\n   150→            $request->merge(['plan_original' => false]);\n   151→        }\n   152→\n   153→        if (!$request->filled('cantidad_ofertas_laborales')) {\n   154→            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n   155→        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n   156→            $request->merge(['plan_original' => false]);\n   157→        }\n   158→\n   159→        if (!$request->filled('cantidad_usuarios')) {\n   160→            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n   161→        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n   162→            $request->merge(['plan_original' => false]);\n   163→        }\n   164→\n   165→        if (!$request->filled('cantidad_pruebas')) {\n   166→            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n   167→        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n   168→            $request->merge(['plan_original' => false]);\n   169→        }\n   170→\n   171→        // Comprobar si se modificaron las funcionalidades respecto al plan original\n   172→        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n   173→            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n   174→            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n   175→            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n   176→\n   177→            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n   178→                $request->merge(['plan_original' => false]);\n   179→            }\n   180→        }\n   181→\n   182→        if ($request->filled('id')) {\n   183→            // Eliminar la factura actual\n   184→            if ($request->hasFile('factura')) {\n   185→                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n   186→\n   187→                if (!is_null($archivo)) {\n   188→                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n   189→                    $this->archivo_repositorio->eliminar($archivo->id);\n   190→                }\n   191→            }\n   192→\n   193→            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n   194→        } else {\n   195→            $enviar_correo = true;\n   196→            $request->merge(['usuario_id' => auth()->user()->id]);\n   197→            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n   198→        }\n   199→\n   200→        if ($request->filled('pruebas')) {\n   201→            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n   202→        }\n   203→\n   204→        if ($request->filled('funcionalidades')) {\n   205→            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n   206→        }\n   207→\n   208→        if ($request->hasFile('factura')) {\n   209→            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n   210→        }\n   211→\n   212→        if ($enviar_correo) {\n   213→            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n   214→            $usuario      = $empresa->usuarios[0];\n   215→            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n   216→            $titulo       = 'Usuario principal de la empresa creado';\n   217→            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n   218→        }\n   219→\n   220→        return $plan_asignado;\n   221→    }\n   222→\n   223→    /**\n   224→     * Guardar un plan de créditos.\n   225→     *\n   226→     * @param Request $request Contenido de la petición.\n   227→     * @return EmpresaPlan\n   228→     * @author Andres Gonzalez\n   229→     */\n   230→    protected function guardarPlanCreditos(Request $request): EmpresaPlan {\n   231→        $enviar_correo = false;\n   232→        $plan_credito  = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n   233→        $plan_activo   = $this->repositorio->planCreditosActivo($request->empresa_id);\n   234→\n   235→        // Preparar datos para el plan de créditos\n   236→        $datos_creditos = [\n   237→            'empresa_id'            => $request->empresa_id,\n   238→            'plan_id'               => null,\n   239→            'plan_credito_id'       => $request->plan_credito_id,\n   240→            'creditos'              => $plan_credito->creditos ?? 0,\n   241→            'precio'                => $request->precio_creditos ?? $plan_credito->precio ?? null,\n   242→            'porcentaje_descuento'  => $request->porcentaje_descuento_creditos ?? null,\n   243→            'numero_factura'        => $request->numero_factura,\n   244→            'comentario'            => $request->comentario,\n   245→            'fecha_inicio'          => null,\n   246→            'fecha_vencimiento'     => null,\n   247→            'usuario_id'            => auth()->user()->id,\n   248→        ];\n   249→\n   250→        // Si es edición de un plan de créditos existente\n   251→        if ($request->filled('id')) {\n   252→            // Eliminar la factura actual si se sube una nueva\n   253→            if ($request->hasFile('factura')) {\n   254→                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n   255→\n   256→                if (!is_null($archivo)) {\n   257→                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n   258→                    $this->archivo_repositorio->eliminar($archivo->id);\n   259→                }\n   260→            }\n   261→\n   262→            $plan_asignado = $this->repositorio->actualizar($request->id, $datos_creditos);\n   263→        } else {\n   264→            // Determinar estado para nuevo plan\n   265→            if (!is_null($plan_activo) && $plan_activo->id != $request->id) {\n   266→                $datos_creditos['estado_id'] = Plan::ESTADO_PROXIMO_ID;\n   267→            } else {\n   268→                $datos_creditos['estado_id'] = Plan::ESTADO_ACTIVO_ID;\n   269→            }\n   270→\n   271→            $enviar_correo = true;\n   272→            $plan_asignado = $this->repositorio->crear($datos_creditos);\n   273→        }\n   274→\n   275→        if ($request->hasFile('factura')) {\n   276→            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n   277→        }\n   278→\n   279→        return $plan_asignado;\n   280→    }\n   281→\n   282→    /**\n   283→     * Renovar el plan asignado.\n   284→     *\n   285→     * @param int $id ID del plan de la empresa que se quiere renovar.\n   286→     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n   287→     * @return EmpresaPlan Plan de la empresa renovado.\n   288→     * @author Daniel Beltrán\n   289→     */\n   290→    public function renovar(int $id): EmpresaPlan {\n   291→        $empresa_plan = $this->repositorio->getUno($id);\n   292→\n   293→        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n   294→            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n   295→        }\n   296→\n   297→        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n   298→\n   299→        $request->merge(['por_facturar' => true]);\n   300→\n   301→        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n   302→            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n   303→            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n   304→        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {\n   305→            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n   306→            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   307→        }\n   308→\n   309→        $this->verificarYAsignarTiempo($empresa_plan, $request);\n   310→\n   311→        $plan_renovado = $this->repositorio->crear($request->toArray());\n   312→\n   313→        if ($request->filled('pruebas')) {\n   314→            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n   315→        }\n   316→\n   317→        if ($request->filled('funcionalidades')) {\n   318→            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n   319→        }\n   320→\n   321→        return $plan_renovado;\n   322→    }\n   323→\n   324→    /**\n   325→     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n   326→     *\n   327→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   328→     * @param Request $request Contenido de la petición.\n   329→     * @return void\n   330→     * @author Daniel Beltrán\n   331→     */\n   332→    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n   333→        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n   334→            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n   335→        }\n   336→    }\n   337→\n   338→    /**\n   339→     * Calcular las fechas en las que el plan estará vigente.\n   340→     *\n   341→     * @param int $vigencia Cantidad de días de vigencia.\n   342→     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n   343→     * @return array Fechas de inicio y vencimiento.\n   344→     * @author Daniel Beltrán\n   345→     */\n   346→    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n   347→        $hoy = now();\n   348→\n   349→        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n   350→\n   351→        // Si es múltiplo de 3, entonces la vigencia es en meses\n   352→\n   353→        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n   354→            $meses = $vigencia / 30;\n   355→\n   356→            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n   357→\n   358→            if ($fecha_inicio->day === 1) {\n   359→                $fecha_vencimiento->subDay();\n   360→            }\n   361→        } else {\n   362→            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n   363→\n   364→            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n   365→        }\n   366→\n   367→        return [\n   368→            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n   369→\n   370→            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n   371→        ];\n   372→    }\n   373→\n   374→    /**\n   375→     * Facturar un plan de empresa.\n   376→     *\n   377→     * @param int $id ID del plan de empresa.\n   378→     * @param Request $request Contenido de la petición.\n   379→     * @return EmpresaPlan\n   380→     * @author Daniel Beltrán\n   381→     */\n   382→    public function facturar(int $id, Request $request): EmpresaPlan {\n   383→        $empresa_plan = $this->repositorio->getUno($id);\n   384→\n   385→        if ($request->filled('vigencia')) {\n   386→            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n   387→        }\n   388→\n   389→        $request->merge(['por_facturar' => false]);\n   390→\n   391→        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n   392→\n   393→        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n   394→\n   395→        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n   396→\n   397→        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n   398→    }\n   399→\n   400→    /**\n   401→     * Guardar factura.\n   402→     *\n   403→     * @param int $id ID del plan de empresa.\n   404→     * @param int $empresa_id ID de la empresa.\n   405→     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n   406→     * @return void\n   407→     * @author Daniel Beltrán\n   408→     */\n   409→    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n   410→        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n   411→\n   412→        $this->generarDirectorios(\"app/{$ruta}\");\n   413→\n   414→        $nombre_archivo = $this->generarNombreArchivo($archivo);\n   415→\n   416→        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n   417→\n   418→        $this->archivo_repositorio->crear([\n   419→            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n   420→\n   421→            'modelo_id' => $id,\n   422→\n   423→            'nombre' => 'factura',\n   424→\n   425→            'ruta' => $ruta . '/' . $nombre_archivo\n   426→        ]);\n   427→    }\n   428→\n   429→    /**\n   430→     * Obtener el historial de recompras de una empresa por tipo de prueba.\n   431→     *\n   432→     * @param Request $request Contenido de la petición HTTP entrante.\n   433→     * @return Collection\n   434→     * @author Daniel Beltrán\n   435→     * @author Fahibram Cárcamo\n   436→     * @author Andres Morales\n   437→     * @author Andres Gonzalez\n   438→     */\n   439→    public function historialRecompras(Request $request): Collection {\n   440→        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n   441→\n   442→        $request->merge([\n   443→            'con_conteo_consumos_agendas'           => true,\n   444→            'con_conteo_consumos_ofertas_laborales' => true\n   445→        ]);\n   446→\n   447→        return match ($rol_usuario->id) {\n   448→            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n   449→\n   450→            RolRepository::ROL_PROPIETARIO_ID,\n   451→\n   452→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   453→\n   454→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   455→\n   456→            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n   457→        };\n   458→    }\n   459→\n   460→    /**\n   461→     * Obtener el historial de compras de planes con creditos para una empresa.\n   462→     *\n   463→     * @param int $empresa_id ID de la empresa.\n   464→     * @param Request $request Contenido de la peticion.\n   465→     * @return Collection\n   466→     * @author Sergio Vargas\n   467→     */\n   468→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   469→        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n   470→\n   471→        return $historial->map(function (EmpresaPlan $plan) {\n   472→            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n   473→\n   474→            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n   475→\n   476→            $plan->creditos_totales = $total_creditos;\n   477→\n   478→            $plan->creditos_consumidos = $creditos_consumidos;\n   479→\n   480→            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n   481→\n   482→            return $plan;\n   483→        });\n   484→    }\n   485→\n   486→    /**\n   487→     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n   488→     *\n   489→     * @param int $empresa_id ID de la empresa.\n   490→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   491→     * @return ?EmpresaPlan\n   492→     * @author Daniel Beltrán\n   493→     */\n   494→    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   495→        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n   496→            'empresa_id'             => $empresa_id,\n   497→            'tipo_prueba_id'         => $tipo_prueba_id,\n   498→            'excluir_estado_proximo' => true\n   499→        ]));\n   500→\n   501→        if (!is_null($plan)) {\n   502→            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   503→\n   504→            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n   505→        }\n   506→\n   507→        return $plan;\n   508→    }\n   509→\n   510→    /**\n   511→     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n   512→     *\n   513→     * @param int $id ID del plan de empresa.\n   514→     * @return ?EmpresaPlan\n   515→     * @author Daniel Beltrán\n   516→     */\n   517→    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n   518→        $plan               = $this->repositorio->getUno($id);\n   519→        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n   520→\n   521→        return $plan;\n   522→    }\n   523→\n   524→    /**\n   525→     * Obtener el plan activo de la empresa por tipo de prueba.\n   526→     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n   527→     * La propiedad se llama 'plan_proximo' y es un booleano.\n   528→     *\n   529→     * @param int $empresa_id ID de la empresa.\n   530→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   531→     * @return ?EmpresaPlan\n   532→     * @author Daniel Beltrán\n   533→     */\n   534→    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   535→        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   536→\n   537→        if (!is_null($plan)) {\n   538→            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n   539→        }\n   540→\n   541→        return $plan;\n   542→    }\n   543→\n   544→    /**\n   545→     * Solicitar la renovación de un plan específico de una empresa específica.\n   546→     *\n   547→     * @param Request $request Solicitud HTTP.\n   548→     * @return void\n   549→     * @author Fahibram Cárcamo\n   550→     * @author Andres González\n   551→     */\n   552→    public function solicitarRenovacionPlan(Request $request) {\n   553→        $tipo_plan = $request->tipo_plan ?? 'plan';\n   554→\n   555→        if ($tipo_plan === 'plan_credito') {\n   556→            $plan = $this->plan_credito_repositorio->getUno($request->plan_id);\n   557→        } else {\n   558→            $plan = $this->plan_repositorio->getUno($request->plan_id);\n   559→        }\n   560→\n   561→        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n   562→        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n   563→\n   564→        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   565→            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n   566→            'con_roles_ids' => true\n   567→        ]));\n   568→\n   569→        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   570→            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n   571→            'empresa_id'    => $request->empresa_id,\n   572→            'con_roles_ids' => true\n   573→        ]));\n   574→\n   575→        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n   576→        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n   577→    }\n   578→\n   579→    /**\n   580→     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n   581→     *\n   582→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   583→     * @return bool\n   584→     * @author Daniel Beltrán\n   585→     * @author Fahibram Cárcamo\n   586→     */\n   587→    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n   588→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   589→            return true;\n   590→        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n   591→            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n   592→                return true;\n   593→            }\n   594→        }\n   595→\n   596→        return false;\n   597→    }\n   598→\n   599→    /**\n   600→     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n   601→     *\n   602→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   603→     * @return bool\n   604→     * @author Daniel Beltrán\n   605→     * @author Fahibram Cárcamo\n   606→     */\n   607→    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   608→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   609→            return true;\n   610→        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n   611→            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n   612→                return true;\n   613→            }\n   614→        }\n   615→\n   616→        return false;\n   617→    }\n   618→\n   619→    /**\n   620→     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n   621→     *\n   622→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   623→     * @return bool\n   624→     * @author Fahibram Cárcamo\n   625→     */\n   626→    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n   627→        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n   628→    }\n   629→\n   630→    /**\n   631→     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n   632→     *\n   633→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   634→     * @return bool\n   635→     * @author Fahibram Cárcamo\n   636→     */\n   637→    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   638→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n   639→    }\n   640→\n   641→    /**\n   642→     * Verificar que la fecha de vencimiento del plan no haya pasado.\n   643→     *\n   644→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   645→     * @return bool\n   646→     * @author Andres Gonzalez\n   647→     */\n   648→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   649→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n   650→            return true;\n   651→        }\n   652→\n   653→        return false;\n   654→    }\n   655→\n   656→    /**\n   657→     * Verificar que el plan tenga vacantes disponibles.\n   658→     *\n   659→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   660→     * @return bool\n   661→     * @author Andres Gonzalez\n   662→     */\n   663→    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n   664→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n   665→    }\n   666→\n   667→    /**\n   668→     * Obtener creditos disponibles para un plan de empresa.\n   669→     *\n   670→     * @param int $empresa_plan_id ID del plan de empresa.\n   671→     * @return int\n   672→     * @author Sergio Vargas\n   673→     * @author Daniel Beltrán\n   674→     */\n   675→    public function creditosDisponibles(int $empresa_plan_id): int {\n   676→        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n   677→\n   678→        return $empresa_plan?->creditos_restantes ?? 0;\n   679→    }\n   680→\n   681→    /**\n   682→     * Obtener creditos disponibles y plan asignado de una empresa.\n   683→     *\n   684→     * @param int $empresa_id ID de la empresa.\n   685→     * @param Request $request Contenido de la peticion.\n   686→     * @return array|null\n   687→     * @author Sergio Vargas\n   688→     * @author José Manuel Jiménez\n   689→     */\n   690→    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n   691→        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n   692→            ? (int) $request->tipo_prueba_id\n   693→            : TipoPrueba::SELECCION_ID;\n   694→\n   695→        $empresa_plan = $this->repositorio->planCreditosActivo($empresa_id);\n   696→\n   697→        if (!$empresa_plan) {\n   698→            return null;\n   699→        }\n   700→\n   701→        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n   702→\n   703→        return [\n   704→            'empresa_id'           => $empresa_id,\n   705→            'empresa_plan_id'      => $empresa_plan->id,\n   706→            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n   707→            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n   708→            'plan_credito'         => $empresa_plan->planCredito ? [\n   709→                'id'       => $empresa_plan->planCredito->id,\n   710→                'nombre'   => $empresa_plan->planCredito->nombre,\n   711→                'creditos' => $empresa_plan->planCredito->creditos,\n   712→                'precio'   => $empresa_plan->planCredito->precio\n   713→            ] : null,\n   714→            'estado'               => $empresa_plan->estado ? [\n   715→                'id'     => $empresa_plan->estado->id,\n   716→                'nombre' => $empresa_plan->estado->nombre,\n   717→            ] : null\n   718→        ];\n   719→    }\n   720→\n   721→    /**\n   722→     * Validar si hay creditos suficientes.\n   723→     *\n   724→     * @param int $empresa_plan_id ID del plan de empresa.\n   725→     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n   726→     * @return bool\n   727→     * @author Sergio Vargas\n   728→     * @author Daniel Beltrán\n   729→     */\n   730→    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n   731→        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n   732→    }\n   733→}\n   734→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"438f7de7-e013-43b8-b86d-fa91086b90cf","timestamp":"2026-01-25T01:46:07.993Z","sourceToolAssistantUUID":"dd2fcb8d-2963-459b-a04e-4537e9747e41"}
{"parentUuid":"ae4d9267-c354-4d8d-a046-7fd4c29ad80d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CZBizeznamMmE2XrEgAHDU","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\AreaRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\CargoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaEnlaceCreacionRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanFuncionalidadRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\MigracionEmpresaRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\MotivadorRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\PortalEmpleoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\PremioDestacadoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\SectorRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\TamanoEmpresaRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php"}]},"uuid":"60b623e8-d0ca-4cca-a379-075971e28a69","timestamp":"2026-01-25T01:46:08.648Z","sourceToolAssistantUUID":"ae4d9267-c354-4d8d-a046-7fd4c29ad80d"}
{"parentUuid":"60b623e8-d0ca-4cca-a379-075971e28a69","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Kv2SowikQfqoaJYe47BX3x","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora necesito ver la consulta específica en el repositorio `EmpresaPlanRepository` para los métodos `planActivo` y `ultimoPlanAsignado`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":12342,"cache_read_input_tokens":21176,"cache_creation":{"ephemeral_5m_input_tokens":12342,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFZZNu5DN1DrwUusQcP","type":"assistant","uuid":"dfdfd3ad-bf53-4f71-a179-04350b65b06e","timestamp":"2026-01-25T01:46:12.279Z"}
{"parentUuid":"dfdfd3ad-bf53-4f71-a179-04350b65b06e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Kv2SowikQfqoaJYe47BX3x","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01URbGQyqQzkbSW4ZGnasngB","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":12342,"cache_read_input_tokens":21176,"cache_creation":{"ephemeral_5m_input_tokens":12342,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFZZNu5DN1DrwUusQcP","type":"assistant","uuid":"fff162dd-5812-42e2-bc21-a5b1c556a722","timestamp":"2026-01-25T01:46:12.436Z"}
{"parentUuid":"fff162dd-5812-42e2-bc21-a5b1c556a722","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01URbGQyqQzkbSW4ZGnasngB","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\Empresas;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\Pruebas\\TipoPrueba;\n     7→use Illuminate\\Support\\Collection;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use App\\Http\\Repositories\\BaseRepository;\n    11→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    12→use App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n    13→\n    14→class EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n    15→{\n    16→    /**\n    17→     * Ids de los roles de tipo empresa.\n    18→     *\n    19→     * @var array\n    20→     * @author Fahibram Cárcamo\n    21→     */\n    22→    private const IDS_ROLES_TIPO_EMPRESA = [\n    23→        RolRepository::ROL_PROPIETARIO_ID,\n    24→        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n    25→        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n    26→        RolRepository::ROL_EVALUADOR_ID\n    27→    ];\n    28→\n    29→    private $consulta_conteo_total_usuarios_empresa_sucursales;\n    30→\n    31→    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n    32→\n    33→    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n    39→     * @return void\n    40→     * @author Daniel Beltrán\n    41→     * @author Fahibram Cárcamo\n    42→     */\n    43→    public function __construct(EmpresaPlan $modelo) {\n    44→        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n    45→            (\n    46→                SELECT COUNT(DISTINCT eu.usuario_id)\n    47→                FROM empresas_usuarios AS eu\n    48→                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n    49→                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n    50→                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n    51→            ) AS conteo_total_usuarios_empresa_sucursales\n    52→        ';\n    53→\n    54→        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n    55→            (\n    56→                SELECT COUNT(*)\n    57→                FROM consumos\n    58→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    59→                WHERE (\n    60→                    consumos.empresa_id = empresas_planes.empresa_id\n    61→                    OR suc.empresa_id = empresas_planes.empresa_id\n    62→                )\n    63→                AND consumos.agenda_id IS NOT NULL\n    64→            ) AS conteo_total_consumos_agendas_empresa_sucursales\n    65→        ';\n    66→\n    67→        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n    68→            (\n    69→                SELECT COUNT(*)\n    70→                FROM consumos\n    71→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    72→                WHERE (\n    73→                    consumos.empresa_id = empresas_planes.empresa_id\n    74→                    OR suc.empresa_id = empresas_planes.empresa_id\n    75→                )\n    76→                AND consumos.oferta_laboral_id IS NOT NULL\n    77→            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n    78→        ';\n    79→\n    80→        parent::__construct($modelo);\n    81→    }\n    82→\n    83→    /**\n    84→     * Obtener todos los planes de empresas.\n    85→     *\n    86→     * @param Request $request Contenido de la petición.\n    87→     * @return Collection\n    88→     * @author Daniel Beltrán\n    89→     * @author Fahibram Cárcamo\n    90→     * @author Jair Carvajal\n    91→     * @author Andres Gonzalez\n    92→     */\n    93→    public function getTodo(Request $request): Collection {\n    94→        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n    95→            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    96→        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n    97→            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n    98→        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n    99→            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n   100→        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n   101→            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n   102→        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n   103→            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n   104→\n   105→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   106→        ->with([\n   107→            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n   108→            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   109→            'plan.tipoPrueba:id,nombre',\n   110→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   111→            'estado:id,nombre',\n   112→            'pruebas:id,nombre',\n   113→            'funcionalidades:id,nombre,predeterminado',\n   114→            'archivos' => function ($archivos) {\n   115→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   116→            }\n   117→        ])\n   118→        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   119→            $query->with([\n   120→                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   121→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   122→                        ->with(['empresa' => function ($empresa) {\n   123→                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n   124→                        }])\n   125→                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n   126→                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n   127→                },\n   128→                'consumos.agenda:id,prueba_id',\n   129→                'consumos.agenda.prueba:id,nombre,slug'\n   130→            ]);\n   131→        })\n   132→        ->when($con_conteo_consumos_agendas, function ($consulta) {\n   133→            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   134→        })\n   135→        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n   136→            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   137→        })\n   138→        ->when($con_conteo_consumos_creditos, function ($consulta) {\n   139→            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n   140→        })\n   141→        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n   142→            $query->where('empresa_id', $request->empresa_id);\n   143→        })\n   144→        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n   145→            $query->whereHas('plan', function ($plan) use ($request) {\n   146→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   147→            });\n   148→        })\n   149→        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n   150→            $query->whereHas('plan', function ($plan) use ($request) {\n   151→                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n   152→            });\n   153→        })\n   154→        ->when($request->filled('plan_id'), function ($query) use ($request) {\n   155→            $query->where('plan_id', $request->plan_id);\n   156→        })\n   157→        ->when(\n   158→            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n   159→            function ($query) use ($request) {\n   160→                $query->whereIn($request->campo, $request->valores);\n   161→            }\n   162→        )\n   163→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   164→            $consulta->whereIn('estado_id', $request->estado_id);\n   165→        })\n   166→        ->when(\n   167→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   168→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   169→        )\n   170→        ->when(\n   171→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   172→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   173→        )\n   174→        ->when(\n   175→            $request->filled('fecha_vencimiento_desde'),\n   176→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   177→        )\n   178→        ->when(\n   179→            $request->filled('fecha_vencimiento_hasta'),\n   180→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   181→        )\n   182→        ->when(\n   183→            $request->filled('fecha_inicio_desde'),\n   184→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   185→        )\n   186→        ->when(\n   187→            $request->filled('fecha_inicio_hasta'),\n   188→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   189→        )\n   190→        ->orderBy('created_at', 'DESC')\n   191→        ->get();\n   192→    }\n   193→\n   194→    /**\n   195→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n   196→     *\n   197→     * @param Request $request Contenido de la petición HTTP entrante.\n   198→     * @return Collection\n   199→     * @author Fahibram Cárcamo\n   200→     * @author Jair Carvajal\n   201→     */\n   202→    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n   203→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   204→            ->addSelect([\n   205→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   206→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   207→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   208→            ])\n   209→            ->whereExists(function ($subconsulta) {\n   210→                $subconsulta->select(DB::raw(1))\n   211→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   212→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   213→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   214→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   215→            })\n   216→            ->with([\n   217→                'estado:id,nombre',\n   218→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   219→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n   220→            ])\n   221→            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n   222→            ->when(\n   223→                $request->filled('tipo_prueba_id'),\n   224→                function ($consulta) use ($request) {\n   225→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   226→                },\n   227→                function ($consulta) {\n   228→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   229→                        TipoPrueba::SELECCION_ID,\n   230→                        TipoPrueba::ORGANIZACIONAL_ID,\n   231→                        TipoPrueba::VOCACIONAL_ID\n   232→                    ]));\n   233→                }\n   234→            )\n   235→            ->get();\n   236→    }\n   237→\n   238→    /**\n   239→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n   240→     *\n   241→     * @param Request $request Contenido de la petición HTTP entrante.\n   242→     * @return Collection\n   243→     * @author Fahibram Cárcamo\n   244→     * @author Andres Gonzalez\n   245→     * @author Jair Carvajal\n   246→     */\n   247→    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n   248→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   249→            ->addSelect([\n   250→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   251→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   252→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   253→            ])\n   254→            ->whereExists(function ($sub_consulta) {\n   255→                $sub_consulta->select(DB::raw(1))\n   256→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   257→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   258→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   259→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   260→            })\n   261→            ->with([\n   262→                'estado:id,nombre',\n   263→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   264→                'plan.tipoPrueba:id,nombre',\n   265→                'pruebas:id,nombre,slug',\n   266→                'funcionalidades:id,nombre,predeterminado',\n   267→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n   268→                'consumos' => function ($consumos) {\n   269→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   270→                        ->with([\n   271→                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   272→                            'agenda:id,prueba_id',\n   273→                            'agenda.prueba:id,nombre,slug'\n   274→                        ]);\n   275→                }\n   276→            ])\n   277→            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   278→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   279→            })\n   280→            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   281→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n   282→            })\n   283→            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n   284→                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n   285→                    $sub_consulta->where('empresa_id', $request->empresa_id)\n   286→                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n   287→                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n   288→                        });\n   289→                });\n   290→            })\n   291→            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   292→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   293→            }, function ($consulta) {\n   294→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   295→                    TipoPrueba::SELECCION_ID,\n   296→                    TipoPrueba::ORGANIZACIONAL_ID,\n   297→                    TipoPrueba::VOCACIONAL_ID\n   298→                ]));\n   299→            })\n   300→            ->orderBy('created_at', 'DESC')\n   301→            ->get();\n   302→    }\n   303→\n   304→    /**\n   305→     * Obtener datos básicos de los planes de empresas.\n   306→     *\n   307→     * @param Request $request Contenido de la petición.\n   308→     * @return Collection\n   309→     * @author Daniel Beltrán\n   310→     * @author Fahibram Cárcamo\n   311→     * @author Jair Carvajal\n   312→     * @author Sergio Vargas\n   313→     */\n   314→    public function getDatosBasicos(Request $request): Collection {\n   315→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   316→        ->with([\n   317→            'plan:id,tipo_prueba_id,nombre',\n   318→            'planCredito:id,nombre,creditos',\n   319→            'consumosCreditos'\n   320→        ])\n   321→        ->withCount([\n   322→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   323→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n   324→        ])\n   325→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   326→            $consulta->where('empresa_id', $request->empresa_id);\n   327→        })\n   328→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   329→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   330→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   331→            });\n   332→        })\n   333→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   334→            $consulta->whereIn('estado_id', $request->estados_ids);\n   335→        })\n   336→        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n   337→            $sentido = $request->ordenar_sentido ?? 'ASC';\n   338→            $consulta->orderBy($request->ordenar_por, $sentido);\n   339→        })\n   340→        ->get();\n   341→    }\n   342→\n   343→    /**\n   344→     * Obtener el proximo plan de creditos de la empresa.\n   345→     *\n   346→     * @param int $empresa_id ID de la empresa.\n   347→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   348→     * @return EmpresaPlan|null\n   349→     * @author Sergio Vargas\n   350→     */\n   351→    public function planProximoCreditos(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   352→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   353→        ->with(['planCredito:id,nombre,creditos,precio'])\n   354→        ->where([\n   355→            'empresa_id' => $empresa_id,\n   356→            'estado_id'  => 3\n   357→        ])\n   358→        ->whereNotNull('plan_credito_id')\n   359→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   360→            $query->where(function ($q) use ($tipo_prueba_id) {\n   361→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   362→                  ->orWhereNull('plan_id');\n   363→            });\n   364→        })\n   365→        ->orderBy('created_at', 'ASC')\n   366→        ->first();\n   367→    }\n   368→\n   369→    /**\n   370→     * Obtener el plan de creditos activo de la empresa.\n   371→     *\n   372→     * @param int $empresa_id ID de la empresa.\n   373→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   374→     * @return EmpresaPlan|null\n   375→     * @author Sergio Vargas\n   376→     */\n   377→    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   378→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   379→        ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n   380→        ->where('empresa_id', $empresa_id)\n   381→        ->whereNotNull('plan_credito_id')\n   382→        ->whereIn('estado_id', [1, 4])\n   383→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   384→            $query->where(function ($q) use ($tipo_prueba_id) {\n   385→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   386→                  ->orWhereNull('plan_id');\n   387→            });\n   388→        })\n   389→        ->first();\n   390→    }\n   391→\n   392→    /**\n   393→     * Obtener un plan de empresa.\n   394→     *\n   395→     * @param int $id ID del plan de empresa.\n   396→     * @return EmpresaPlan|null\n   397→     * @author Daniel Beltrán\n   398→     * @author Jair Carvajal\n   399→     */\n   400→    public function getUno(int $id): ?EmpresaPlan {\n   401→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   402→        ->with([\n   403→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n   404→            'plan.tipoPrueba:id,nombre',\n   405→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   406→            'estado:id,nombre',\n   407→            'pruebas:id,nombre,slug',\n   408→            'funcionalidades:id,nombre,llave,valor',\n   409→            'archivos' => function ($archivos) {\n   410→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   411→            }\n   412→        ])\n   413→        ->find($id);\n   414→    }\n   415→\n   416→    /**\n   417→     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n   418→     *\n   419→     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n   420→     *\n   421→     * @param int $empresa_id ID de la empresa.\n   422→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   423→     * @return EmpresaPlan|null\n   424→     * @author Daniel Beltrán\n   425→     * @author Fahibram Cárcamo\n   426→     * @author José Manuel Jiménez\n   427→     * @author Andres Gonzalez\n   428→     * @author Sergio Vargas\n   429→     * @author Jair Carvajal\n   430→     */\n   431→    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   432→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   433→        ->with([\n   434→            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n   435→            'plan.tipoPrueba:id,nombre',\n   436→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   437→            'estado:id,nombre',\n   438→            'pruebas:id,nombre,slug',\n   439→            'usuario:id,nombres,apellidos',\n   440→            'archivos' => function ($archivos) {\n   441→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   442→                ->orderBy('created_at', 'DESC');\n   443→            }\n   444→        ])\n   445→        ->withCount([\n   446→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   447→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n   448→            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n   449→        ])\n   450→        ->where('empresa_id', $empresa_id)\n   451→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   452→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   453→        })\n   454→        ->whereIn('estado_id', [1, 4])\n   455→        ->first();\n   456→    }\n   457→\n   458→    /**\n   459→     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n   460→     *\n   461→     * @param int $empresa_id ID de la empresa.\n   462→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   463→     * @return EmpresaPlan|null\n   464→     * @author Daniel Beltrán\n   465→     * @author Jair Carvajal\n   466→     */\n   467→    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   468→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   469→        ->with([\n   470→            'plan:id,tipo_prueba_id,nombre',\n   471→            'plan.tipoPrueba:id,nombre',\n   472→            'estado:id,nombre',\n   473→            'pruebas:id,nombre',\n   474→            'archivos' => function ($archivos) {\n   475→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   476→                ->orderBy('created_at', 'DESC');\n   477→            }\n   478→        ])\n   479→        ->where([\n   480→            'empresa_id' => $empresa_id,\n   481→            'estado_id'  => 3\n   482→        ])\n   483→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   484→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   485→        })\n   486→        ->first();\n   487→    }\n   488→\n   489→    /**\n   490→     * Obtener el último plan asignado.\n   491→     *\n   492→     * @param Request $request Contenido de la petición.\n   493→     * @return EmpresaPlan|null\n   494→     * @author Daniel Beltrán\n   495→     * @author Jair Carvajal\n   496→     */\n   497→    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n   498→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   499→        ->with([\n   500→            'plan:id,tipo_prueba_id,nombre',\n   501→            'plan.tipoPrueba:id,nombre',\n   502→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   503→            'estado:id,nombre',\n   504→            'pruebas:id,nombre',\n   505→            'archivos' => function ($archivos) {\n   506→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   507→                ->orderBy('created_at', 'DESC');\n   508→            }\n   509→        ])\n   510→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   511→            $consulta->where('empresa_id', $request->empresa_id);\n   512→        })\n   513→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   514→            $consulta->where('estado_id', $request->estado_id);\n   515→        })\n   516→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   517→            $consulta->whereIn('estado_id', $request->estados_ids);\n   518→        })\n   519→        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   520→            $consulta->where('estado_id', '!=', 3);\n   521→        })\n   522→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   523→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   524→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   525→            });\n   526→        })\n   527→        ->orderBy('created_at', 'DESC')\n   528→        ->first();\n   529→    }\n   530→\n   531→    /**\n   532→     * Sincronizar pruebas.\n   533→     *\n   534→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   535→     * @param array $pruebas ID's de las pruebas.\n   536→     * @return void\n   537→     * @author Daniel Beltrán\n   538→     */\n   539→    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n   540→        $empresa_plan->pruebas()->sync($pruebas);\n   541→    }\n   542→\n   543→    /**\n   544→     * Sincronizar funcionalidades.\n   545→     *\n   546→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   547→     * @param array $funcionalidades ID's de las funcionalidades.\n   548→     * @return void\n   549→     * @author Daniel Beltrán\n   550→     */\n   551→    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n   552→        $empresa_plan->funcionalidades()->sync($funcionalidades);\n   553→    }\n   554→\n   555→    /**\n   556→     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n   557→     *\n   558→     * @param Request $request Contenido de la petición.\n   559→     * @return ?EmpresaPlan\n   560→     * @author Fahibram Cárcamo\n   561→     * @author Jair Carvajal\n   562→     */\n   563→    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n   564→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   565→        ->with([\n   566→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n   567→            'plan.tipoPrueba:id,nombre',\n   568→            'estado:id,nombre',\n   569→            'pruebas:id,nombre',\n   570→            'funcionalidades:id,nombre,llave,valor'\n   571→        ])\n   572→        ->when(\n   573→            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n   574→            function ($consulta) {\n   575→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   576→            }\n   577→        )\n   578→        ->when(\n   579→            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n   580→            function ($consulta) {\n   581→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   582→            }\n   583→        )\n   584→        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n   585→        ->first();\n   586→    }\n   587→\n   588→    /**\n   589→     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n   590→     *\n   591→     * @return Collection\n   592→     * @author Fahibram Cárcamo\n   593→     * @author Andres Gonzalez\n   594→     * @author José Manuel Jiménez\n   595→     * @author Jair Carvajal\n   596→     * @author Daniel Beltrán\n   597→     */\n   598→    public function datosConsumosEmpresas(Request $request): Collection {\n   599→        $roles_tipo_empresa_ids = [\n   600→            RolRepository::ROL_PROPIETARIO_ID,\n   601→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   602→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   603→            RolRepository::ROL_EVALUADOR_ID\n   604→        ];\n   605→\n   606→        $matriz_conteos = [\n   607→            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n   608→            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n   609→            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n   610→                'empresasUsuarios',\n   611→                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n   612→            )\n   613→        ];\n   614→\n   615→        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n   616→\n   617→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   618→            ->addSelect([\n   619→                DB::raw('\n   620→                    (\n   621→                        SELECT COUNT(DISTINCT eu.usuario_id)\n   622→                        FROM empresas_usuarios AS eu\n   623→                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n   624→                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n   625→                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n   626→                    ) AS conteo_total_usuarios_empresa_sucursales\n   627→                '),\n   628→                DB::raw('\n   629→                    (\n   630→                        SELECT COUNT(*)\n   631→                        FROM consumos\n   632→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   633→                        WHERE (\n   634→                            consumos.empresa_id = empresas_planes.empresa_id\n   635→                            OR suc.empresa_id = empresas_planes.empresa_id\n   636→                        )\n   637→                        AND consumos.agenda_id IS NOT NULL\n   638→                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n   639→                '),\n   640→                DB::raw('\n   641→                    (\n   642→                        SELECT COUNT(*)\n   643→                        FROM consumos\n   644→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   645→                        WHERE (\n   646→                            consumos.empresa_id = empresas_planes.empresa_id\n   647→                            OR suc.empresa_id = empresas_planes.empresa_id\n   648→                        )\n   649→                        AND consumos.oferta_laboral_id IS NOT NULL\n   650→                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n   651→                '),\n   652→            ])\n   653→            ->with([\n   654→                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n   655→                'plan.tipoPrueba:id,nombre',\n   656→                'pruebas:id,nombre,slug',\n   657→                'estado:id,nombre',\n   658→                'usuario:id,nombres,apellidos',\n   659→                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n   660→                    $consulta_empresa->select($campos_empresas)\n   661→                        ->whereNull('empresa_id')\n   662→                        ->withCount([\n   663→                            ...$matriz_conteos,\n   664→                            'sucursales as conteo_sucursales'\n   665→                        ])\n   666→                        ->with([\n   667→                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n   668→                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n   669→                            }\n   670→                        ]);\n   671→                }\n   672→            ])\n   673→            ->when(\n   674→                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n   675→                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n   676→            )\n   677→            ->whereNotIn('estado_id', [3, 8])\n   678→            ->when(\n   679→                $request->filled('prueba_id'),\n   680→                fn($consulta) => $consulta->whereHas(\n   681→                    'pruebas',\n   682→                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n   683→                )\n   684→            )\n   685→            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n   686→                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n   687→            })\n   688→            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n   689→                switch ($request->plan_por) {\n   690→                    case 'por unidades':\n   691→                        $consulta_plan_por->whereNotNull('unidades');\n   692→                        break;\n   693→\n   694→                    case 'por ofertas laborales':\n   695→                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n   696→                        break;\n   697→\n   698→                    case 'por tiempo':\n   699→                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n   700→                        break;\n   701→                }\n   702→            })\n   703→            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n   704→                $fecha_inicio = $request->fecha_vencimiento;\n   705→                $fecha_fin    = $request->fecha_vencimiento;\n   706→\n   707→                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n   708→                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n   709→                    $fecha_inicio = $fechas[0];\n   710→                    $fecha_fin    = $fechas[1];\n   711→                }\n   712→\n   713→                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n   714→            })\n   715→            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n   716→                $fecha_inicio = $request->fecha_inicio;\n   717→                $fecha_fin    = $request->fecha_inicio;\n   718→\n   719→                if (strpos($request->fecha_inicio, ' a ') !== false) {\n   720→                    $fechas       = explode(' a ', $request->fecha_inicio);\n   721→                    $fecha_inicio = $fechas[0];\n   722→                    $fecha_fin    = $fechas[1];\n   723→                }\n   724→\n   725→                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n   726→            })\n   727→            ->when(\n   728→                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   729→                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n   730→            )\n   731→            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n   732→                if ($request->tipo_activacion === 'compra') {\n   733→                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n   734→                        $subconsulta->select(DB::raw(1))\n   735→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   736→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   737→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   738→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   739→                    });\n   740→                } elseif ($request->tipo_activacion === 'recompra') {\n   741→                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n   742→                        $subconsulta->select(DB::raw(1))\n   743→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   744→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   745→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   746→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   747→                    });\n   748→                }\n   749→            })\n   750→            ->get();\n   751→    }\n   752→\n   753→    /**\n   754→     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n   755→     *\n   756→     * @param Request $request Contenido de la petición HTTP entrante.\n   757→     * @return Collection\n   758→     * @author Fahibram Cárcamo\n   759→     */\n   760→    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n   761→        return $this->modelo::select(\n   762→            'empresas_planes.id',\n   763→            'empresas_planes.empresa_id',\n   764→            'empresas_planes.plan_id',\n   765→            'empresas_planes.plan_credito_id',\n   766→            'empresas_planes.usuario_id',\n   767→            'empresas_planes.estado_id',\n   768→            'empresas_planes.unidades',\n   769→            'empresas_planes.cantidad_ofertas_laborales',\n   770→            'empresas_planes.cantidad_usuarios',\n   771→            'empresas_planes.cantidad_pruebas',\n   772→            'empresas_planes.creditos',\n   773→            'empresas_planes.fecha_inicio',\n   774→            'empresas_planes.fecha_vencimiento',\n   775→            'empresas_planes.precio',\n   776→            'empresas_planes.porcentaje_descuento',\n   777→            'empresas_planes.numero_factura',\n   778→            'empresas_planes.comentario',\n   779→            'empresas_planes.plan_original',\n   780→            'empresas_planes.renovando',\n   781→            'empresas_planes.por_facturar',\n   782→            'empresas_planes.created_at',\n   783→            'planes.id',\n   784→            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n   785→            'planes.nombre AS plan_nombre',\n   786→            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n   787→            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n   788→            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n   789→            'planes.unidades AS plan_unidades',\n   790→            'planes.vigencia AS plan_vigencia',\n   791→            'planes.precio AS plan_precio',\n   792→            'tipos_pruebas.id AS tipo_prueba_id',\n   793→            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n   794→            'estados_planes.id AS estado_plan_id',\n   795→            'estados_planes.nombre AS estado_plan_nombre',\n   796→            'users.id AS usuario_usuario_id',\n   797→            'users.nombres AS usuario_nombres',\n   798→            'users.apellidos AS usuario_apellidos',\n   799→            'empresas.id AS empresa_empresa_id',\n   800→            'empresas.empresa_id',\n   801→            'empresas.nombre_comercial AS empresa_nombre_comercial',\n   802→            'empresas.razon_social AS empresa_razon_social',\n   803→            'empresas.nombre_contacto',\n   804→            'empresas.celular_contacto',\n   805→            'empresas.email_contacto',\n   806→            'empresas.telefono_contacto',\n   807→            'empresas.extension_contacto',\n   808→            'empresas.nombre_tesorero',\n   809→            'empresas.celular_tesorero',\n   810→            'empresas.telefono_tesorero',\n   811→            'empresas.email_tesorero',\n   812→            DB::raw('\n   813→                (\n   814→                    SELECT COUNT(*)\n   815→                    FROM consumos\n   816→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n   817→                )\n   818→                AS conteo_consumos_agendas\n   819→            '),\n   820→            DB::raw('\n   821→                (\n   822→                    SELECT COUNT(*)\n   823→                    FROM consumos\n   824→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n   825→                )\n   826→                AS conteo_consumos_ofertas_laborales\n   827→            '),\n   828→            DB::raw('\n   829→                (\n   830→                    SELECT COUNT(*)\n   831→                    FROM empresas\n   832→                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n   833→                )\n   834→                AS conteo_sucursales\n   835→            '),\n   836→            DB::raw('\n   837→                (\n   838→                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n   839→                    FROM empresas AS sucursales\n   840→                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n   841→                )\n   842→                AS nombres_comerciales_sucursales\n   843→            ')\n   844→        )\n   845→        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n   846→        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n   847→        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n   848→        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n   849→        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n   850→        ->whereNull('empresas.empresa_id')\n   851→        ->when(\n   852→            $request->filled('plan_por'),\n   853→            function ($consulta) use ($request) {\n   854→                switch ($request->plan_por) {\n   855→                    case 'por unidades':\n   856→                        $consulta->whereNotNull('empresas_planes.unidades');\n   857→                        break;\n   858→\n   859→                    case 'por ofertas laborales':\n   860→                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n   861→                        break;\n   862→\n   863→                    case 'por tiempo':\n   864→                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n   865→                        break;\n   866→                }\n   867→            }\n   868→        )\n   869→        ->when(\n   870→            $request->filled('tipo_prueba_id'),\n   871→            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n   872→            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n   873→                TipoPrueba::SELECCION_ID,\n   874→                TipoPrueba::ORGANIZACIONAL_ID,\n   875→                TipoPrueba::VOCACIONAL_ID\n   876→            ])\n   877→        )\n   878→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n   879→        ->when(\n   880→            $request->filled('ejecutivo_id'),\n   881→            function ($consulta) use ($request) {\n   882→                $consulta->whereExists(function ($subconsulta) use ($request) {\n   883→                    $subconsulta->select(DB::raw(1))\n   884→                        ->from('empresas_usuarios')\n   885→                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n   886→                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n   887→                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n   888→                });\n   889→            }\n   890→        )\n   891→        ->when(\n   892→            $request->filled('fecha_vencimiento'),\n   893→            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n   894→        )\n   895→        ->when(\n   896→            $request->filled('fecha_inicio'),\n   897→            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n   898→        )\n   899→        ->when(\n   900→            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   901→            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n   902→        )\n   903→        ->get();\n   904→    }\n   905→\n   906→    /**\n   907→     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n   908→     *\n   909→     * @param int $empresa_id ID de la empresa.\n   910→     * @param Request $request Contenido de la peticion.\n   911→     * @return Collection\n   912→     * @author Sergio Vargas\n   913→     */\n   914→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   915→        return $this->modelo::select(\n   916→            'id',\n   917→            'empresa_id',\n   918→            'plan_credito_id',\n   919→            'estado_id',\n   920→            'creditos',\n   921→            'fecha_inicio',\n   922→            'fecha_vencimiento',\n   923→            'precio',\n   924→            'porcentaje_descuento',\n   925→            'numero_factura',\n   926→            'comentario',\n   927→            'created_at'\n   928→        )\n   929→        ->with([\n   930→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   931→            'estado:id,nombre',\n   932→            'archivos' => function ($archivos) {\n   933→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   934→                    ->orderBy('created_at', 'DESC');\n   935→            }\n   936→        ])\n   937→        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n   938→        ->where('empresa_id', $empresa_id)\n   939→        ->whereNotNull('plan_credito_id')\n   940→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n   941→        ->when(\n   942→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   943→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   944→        )\n   945→        ->when(\n   946→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   947→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   948→        )\n   949→        ->when(\n   950→            $request->filled('fecha_vencimiento_desde'),\n   951→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   952→        )\n   953→        ->when(\n   954→            $request->filled('fecha_vencimiento_hasta'),\n   955→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   956→        )\n   957→        ->when(\n   958→            $request->filled('fecha_inicio_desde'),\n   959→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   960→        )\n   961→        ->when(\n   962→            $request->filled('fecha_inicio_hasta'),\n   963→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   964→        )\n   965→        ->orderBy('created_at', 'DESC')\n   966→        ->get();\n   967→    }\n   968→}\n   969→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1232d72c-d4b2-4382-ba73-62fa4666f6a4","timestamp":"2026-01-25T01:46:13.822Z","sourceToolAssistantUUID":"fff162dd-5812-42e2-bc21-a5b1c556a722"}
{"parentUuid":"1232d72c-d4b2-4382-ba73-62fa4666f6a4","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PoqFEcXniod19Qtx1ayVix","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente. Ahora tengo toda la información. Permíteme hacer una búsqueda comparativa en el controlador/servicio de empresas para ver si hay otra forma de cargar planes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":18006,"cache_read_input_tokens":33518,"cache_creation":{"ephemeral_5m_input_tokens":18006,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFZwTgY2MW8raeP92up","type":"assistant","uuid":"2ac260a5-6de6-4b85-a6d1-56f9f79c5707","timestamp":"2026-01-25T01:46:16.677Z"}
{"parentUuid":"2ac260a5-6de6-4b85-a6d1-56f9f79c5707","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PoqFEcXniod19Qtx1ayVix","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JycRbnxUSU1BvR7hz8RUjW","name":"Bash","input":{"command":"grep -r \"obtenerPlanActivo\\|obtenerUltimoPorTipo\" \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\" --include=\"*.php\" | head -30"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":18006,"cache_read_input_tokens":33518,"cache_creation":{"ephemeral_5m_input_tokens":18006,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFZwTgY2MW8raeP92up","type":"assistant","uuid":"048c565b-8d49-4d1f-9212-3e67bd5ead44","timestamp":"2026-01-25T01:46:17.481Z"}
{"parentUuid":"048c565b-8d49-4d1f-9212-3e67bd5ead44","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JycRbnxUSU1BvR7hz8RUjW","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Controllers/Planes/PlanController.php:            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Controllers/Planes/PlanController.php:                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Services/Empresas/EmpresaPlanService.php:    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Services/Empresas/EmpresaPlanService.php:    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Services/Empresas/EmpresaService.php:                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Services/Empresas/EmpresaService.php:                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);","is_error":false}]},"uuid":"86cbb971-ed8c-4860-b750-41c25f9c94d0","timestamp":"2026-01-25T01:46:18.740Z","sourceToolAssistantUUID":"048c565b-8d49-4d1f-9212-3e67bd5ead44"}
{"parentUuid":"86cbb971-ed8c-4860-b750-41c25f9c94d0","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QC5zf7DEaXiGQKeQ1BFrqA","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora voy a ver el contexto en EmpresaService para comparar:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":624,"cache_read_input_tokens":51524,"cache_creation":{"ephemeral_5m_input_tokens":624,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFaJ7ek8C8H9FT2KVNS","type":"assistant","uuid":"0cc3c568-8cc0-47f1-ae1c-10f542ddee6f","timestamp":"2026-01-25T01:46:20.130Z"}
{"parentUuid":"0cc3c568-8cc0-47f1-ae1c-10f542ddee6f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QC5zf7DEaXiGQKeQ1BFrqA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AE1gCFT9LdAqKnGw4nm9qE","name":"Grep","input":{"pattern":"obtenerPlanActivo|obtenerUltimoPorTipo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","output_mode":"content","context":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":624,"cache_read_input_tokens":51524,"cache_creation":{"ephemeral_5m_input_tokens":624,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFaJ7ek8C8H9FT2KVNS","type":"assistant","uuid":"ec986eea-fc3d-450b-b7a5-f43692f99079","timestamp":"2026-01-25T01:46:20.813Z"}
{"parentUuid":"ec986eea-fc3d-450b-b7a5-f43692f99079","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>InputValidationError: Grep failed due to the following issue:\nAn unexpected parameter `context` was provided</tool_use_error>","is_error":true,"tool_use_id":"toolu_01AE1gCFT9LdAqKnGw4nm9qE"}]},"uuid":"39a7a3b7-9390-498c-9699-10ad6d177ebf","timestamp":"2026-01-25T01:46:20.858Z","toolUseResult":"InputValidationError: [\n  {\n    \"code\": \"unrecognized_keys\",\n    \"keys\": [\n      \"context\"\n    ],\n    \"path\": [],\n    \"message\": \"Unrecognized key: \\\"context\\\"\"\n  }\n]","sourceToolAssistantUUID":"ec986eea-fc3d-450b-b7a5-f43692f99079"}
{"parentUuid":"39a7a3b7-9390-498c-9699-10ad6d177ebf","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01LKnSyi55AZBZA6vHvT4kV6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01R1DUDRPMbG69WYSCswGv7W","name":"Grep","input":{"pattern":"obtenerPlanActivo|obtenerUltimoPorTipo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","output_mode":"content","-B":10,"-A":10}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":514,"cache_read_input_tokens":52148,"cache_creation":{"ephemeral_5m_input_tokens":514,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXTFaTDLempTfFPvXkSE1","type":"assistant","uuid":"3e55d78d-29ca-4bba-a8b9-28dfb77afab1","timestamp":"2026-01-25T01:46:23.037Z"}
{"parentUuid":"3e55d78d-29ca-4bba-a8b9-28dfb77afab1","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01R1DUDRPMbG69WYSCswGv7W","type":"tool_result","content":"101-     * @author Jair Carvajal\n102-     */\n103-    public function getUno(int $id): ?Empresa {\n104-        $empresa = $this->repositorio->getUnoBasico($id);\n105-\n106-        if (!is_null($empresa)) {\n107-            $planes        = [];\n108-            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n109-\n110-            foreach ($tipos_pruebas as $tipo_prueba) {\n111:                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n112:                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n113-\n114-                if (!is_null($plan)) {\n115-                    array_push($planes, $plan);\n116-                }\n117-            }\n118-\n119-            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n120-                'empresa_id'         => $id,\n121-                'con_relaciones'     => true,\n122-                'validar_relaciones' => true,"}]},"uuid":"5ac05fc0-ca38-4b40-9e76-95dba62f0534","timestamp":"2026-01-25T01:46:24.925Z","sourceToolAssistantUUID":"3e55d78d-29ca-4bba-a8b9-28dfb77afab1"}
{"parentUuid":"5ac05fc0-ca38-4b40-9e76-95dba62f0534","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"b38f8226-e093-42db-89cf-c257cfab7b2d","version":"2.1.16","gitBranch":"pre-main","agentId":"a5b6fcc","slug":"sorted-spinning-crane","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01NofspuPnBS2W1GDoGzz6Q1","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora voy a crear un reporte completo con el análisis de las consultas. Déjame crear un documento de resumen:\n\n## Resumen de Hallazgos: Cómo se cargan los planes en \"/planes-clientes\"\n\nHe encontrado exactamente cómo funciona el sistema para cargar todos los planes correctamente. Aquí está el análisis completo:\n\n### 1. **RUTA EN ROUTES/WEB.PHP**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php`\n\n```\nLínea 216: $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n```\n\n### 2. **CONTROLADOR: PlanController**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php`\n\n**Método: `planesClientes()` (líneas 356-395)**\n\n```php\npublic function planesClientes(): View {\n    $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n    $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n    $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n    $empresas   = clone $sucursales;\n    $empresas->push($empresa);\n    $empresas_ids = array_column($empresas->toArray(), 'id');\n\n    $planes        = [];\n    $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n    // AQUÍ ESTÁ LA CLAVE - ITERA POR CADA TIPO DE PRUEBA\n    foreach ($tipos_pruebas as $tipo_prueba) {\n        $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n            ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n\n        if (!is_null($plan)) {\n            array_push($planes, $plan);\n        }\n    }\n\n    $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n        new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n        $empresa\n    );\n\n    return view('empresa.paginas.planes.planes')->with([\n        'empresa'          => $empresa,\n        'usuario_id'       => Auth::id(),\n        'sucursales'       => $empresas,\n        'planes'           => $planes,  // <-- AQUÍ SE PASAN LOS PLANES A LA VISTA\n        // ... más datos\n    ]);\n}\n```\n\n### 3. **SERVICIO: EmpresaPlanService**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php`\n\n**Método 1: `obtenerPlanActivo()` (líneas 534-542)**\n\n```php\npublic function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n    $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n    if (!is_null($plan)) {\n        $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n    }\n\n    return $plan;\n}\n```\n\n**Método 2: `obtenerUltimoPorTipo()` (líneas 494-508)**\n\n```php\npublic function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n    $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n        'empresa_id'             => $empresa_id,\n        'tipo_prueba_id'         => $tipo_prueba_id,\n        'excluir_estado_proximo' => true\n    ]));\n\n    if (!is_null($plan)) {\n        $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n        $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n    }\n\n    return $plan;\n}\n```\n\n### 4. **REPOSITORIO: EmpresaPlanRepository - LAS CONSULTAS CLAVE**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php`\n\n#### **Consulta A: `planActivo()` (líneas 431-456)**\n```php\npublic function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n    return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', ...)\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])  // <-- ESTADOS: 1 = ACTIVO, 4 = POR_VENCER\n        ->first();\n}\n```\n\n#### **Consulta B: `ultimoPlanAsignado()` (líneas 497-529)**\n```php\npublic function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n    return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', ...)\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);  // <-- EXCLUYE ESTADO 3 (PROXIMO)\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n}\n```\n\n### 5. **LA DIFERENCIA CRÍTICA - POR QUÉ AQUÍ SÍ SE MUESTRAN TODOS**\n\nEl método `planesClientes()` muestra **todos los planes correctamente (3 de créditos + 1 de selección)** porque:\n\n1. **Itera por CADA tipo de prueba** (línea 367):\n   ```php\n   foreach ($tipos_pruebas as $tipo_prueba) {\n       $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n           ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n       \n       if (!is_null($plan)) {\n           array_push($planes, $plan);\n       }\n   }\n   ```\n\n2. **Busca en dos formas secuenciales**:\n   - **Primera búsqueda**: `obtenerPlanActivo()` - busca planes con estado 1 (ACTIVO) o 4 (POR_VENCER)\n   - **Segunda búsqueda (fallback)**: `obtenerUltimoPorTipo()` - busca el ÚLTIMO plan que NO sea estado 3 (PRÓXIMO)\n\n3. **Las consultas incluyen AMBOS tipos de planes**:\n   - Planes de **selección** (contienen `plan_id`)\n   - Planes de **créditos** (contienen `plan_credito_id`)\n\n### 6. **COMPARACIÓN CON OTROS LUGARES**\n\nEl mismo patrón se usa en `EmpresaService::getUno()` (líneas 111-112), que también carga todos los planes correctamente:\n\n```php\nforeach ($tipos_pruebas as $tipo_prueba) {\n    $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n        ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n    if (!is_null($plan)) {\n        array_push($planes, $plan);\n    }\n}\n```\n\n### 7. **CONDICIONES DE FILTRADO EN LAS CONSULTAS**\n\n**En `planActivo()` (línea 454)**:\n```php\n->whereIn('estado_id', [1, 4])  // ACTIVO, POR_VENCER\n```\n\n**En `ultimoPlanAsignado()` (línea 520)**:\n```php\n->where('estado_id', '!=', 3)  // Excluye PRÓXIMO\n```\n\nEsto significa que obtiene planes en estados: 1, 2, 4, 5, 6 (cualquiera excepto PRÓXIMO = 3)\n\n---\n\n## CONCLUSIÓN\n\nLa vista **\"/planes-clientes\" muestra todos los planes correctamente** porque:\n\n1. Itera explícitamente sobre **cada tipo de prueba** en la base de datos\n2. Para cada tipo, busca primero un plan **ACTIVO**, luego el **ÚLTIMO PLAN** de ese tipo\n3. Las consultas del repositorio están diseñadas para traer:\n   - Planes de **selección** (con plan_id)\n   - Planes de **créditos** (con plan_credito_id)\n4. Ambas consultas usan lógica de `whereHas` que no discrimina entre tipos de planes\n\n**Si hay otros lugares donde NO se muestran todos los planes, probablemente es porque:**\n- No iteran por cada tipo de prueba\n- Filtran por un `plan_id` o `plan_credito_id` específico\n- Usan una consulta diferente sin el fallback de `obtenerUltimoPorTipo()`"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":534,"cache_read_input_tokens":52662,"cache_creation":{"ephemeral_5m_input_tokens":534,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTFakZNciJeFZAwToUvE","type":"assistant","uuid":"e9a915ce-1c23-4faf-b4c6-0ff04755bddf","timestamp":"2026-01-25T01:46:47.193Z"}
