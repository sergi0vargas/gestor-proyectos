{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":"I need to understand the empresas-migracion feature flow in this Laravel project. Specifically:\n\n1. Find the controller handling routes under `/empresas-migracion` (buscar, validar-tamano, iniciar)\n2. Find the service and repository classes involved in the migration\n3. Find any queued jobs related to migration (look for Job classes, dispatch(), queue)\n4. Look at how the `old_db` database connection is configured and used\n5. Pay special attention to the `iniciar` method - trace the full flow from controller to the actual migration execution\n\nSearch in:\n- app/Http/Controllers/ for migration-related controllers\n- app/Http/Services/ for migration services\n- app/Http/Repositories/ for migration repositories\n- app/Jobs/ for migration jobs\n- config/database.php for the old_db connection config\n- routes/ for empresas-migracion routes\n\nBe very thorough - I need to understand why the old_db connection works during HTTP requests (buscar, validar-tamano) but fails during the actual migration execution."},"uuid":"6ec7328d-92a9-4f53-9728-eff9adf2e336","timestamp":"2026-02-16T21:29:59.316Z"}
{"parentUuid":"6ec7328d-92a9-4f53-9728-eff9adf2e336","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KvtkkLgRAHt4B81MFLrrBW","type":"message","role":"assistant","content":[{"type":"text","text":"I'll systematically trace the full migration feature flow. Let me search all relevant files in parallel."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6061,"cache_read_input_tokens":9150,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6061},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTdkQbUnc11z8FRrCi6","type":"assistant","uuid":"22df2c1c-4b3f-4d76-9ee8-f9ca6ff9546e","timestamp":"2026-02-16T21:30:01.092Z"}
{"parentUuid":"22df2c1c-4b3f-4d76-9ee8-f9ca6ff9546e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KvtkkLgRAHt4B81MFLrrBW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SCF7iZKgba9J3uo8wewPTJ","name":"Glob","input":{"pattern":"**/Controllers/**/*igra*"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6061,"cache_read_input_tokens":9150,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6061},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTdkQbUnc11z8FRrCi6","type":"assistant","uuid":"510e6856-5bf5-4d0f-8a26-5d2d910ee251","timestamp":"2026-02-16T21:30:01.670Z"}
{"parentUuid":"510e6856-5bf5-4d0f-8a26-5d2d910ee251","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KvtkkLgRAHt4B81MFLrrBW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011i6sTmwtax5n86bKD7knhr","name":"Glob","input":{"pattern":"**/Services/**/*igra*"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6061,"cache_read_input_tokens":9150,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6061},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTdkQbUnc11z8FRrCi6","type":"assistant","uuid":"8b8c006e-5d93-45f3-8b6c-3a6edc9c6a70","timestamp":"2026-02-16T21:30:01.881Z"}
{"parentUuid":"8b8c006e-5d93-45f3-8b6c-3a6edc9c6a70","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KvtkkLgRAHt4B81MFLrrBW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KbcjDDDqEgBGFqC3uye7aa","name":"Glob","input":{"pattern":"**/Repositories/**/*igra*"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6061,"cache_read_input_tokens":9150,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6061},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTdkQbUnc11z8FRrCi6","type":"assistant","uuid":"69ffabe2-83c8-453f-b3fb-0f81bd7f86ba","timestamp":"2026-02-16T21:30:02.162Z"}
{"parentUuid":"69ffabe2-83c8-453f-b3fb-0f81bd7f86ba","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KvtkkLgRAHt4B81MFLrrBW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Cgbc5xjNiAJsJs4VVWu4GU","name":"Glob","input":{"pattern":"**/Jobs/**/*igra*"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6061,"cache_read_input_tokens":9150,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6061},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTdkQbUnc11z8FRrCi6","type":"assistant","uuid":"1296874d-8c01-4c8c-8496-2d9e8f4ccb01","timestamp":"2026-02-16T21:30:02.504Z"}
{"parentUuid":"1296874d-8c01-4c8c-8496-2d9e8f4ccb01","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Glob","command":"callback"},"parentToolUseID":"toolu_01SCF7iZKgba9J3uo8wewPTJ","toolUseID":"toolu_01SCF7iZKgba9J3uo8wewPTJ","timestamp":"2026-02-16T21:30:02.791Z","uuid":"82514865-bff9-4d81-96f2-5495a234439d"}
{"parentUuid":"510e6856-5bf5-4d0f-8a26-5d2d910ee251","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SCF7iZKgba9J3uo8wewPTJ","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\MigracionEmpresaController.php"}]},"uuid":"18f1e8be-0d1c-4492-948a-39ba36653a7b","timestamp":"2026-02-16T21:30:02.790Z","sourceToolAssistantUUID":"510e6856-5bf5-4d0f-8a26-5d2d910ee251"}
{"parentUuid":"18f1e8be-0d1c-4492-948a-39ba36653a7b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Glob","command":"callback"},"parentToolUseID":"toolu_011i6sTmwtax5n86bKD7knhr","toolUseID":"toolu_011i6sTmwtax5n86bKD7knhr","timestamp":"2026-02-16T21:30:02.982Z","uuid":"9d517bd4-e872-41aa-86ea-cc649d5b88a2"}
{"parentUuid":"8b8c006e-5d93-45f3-8b6c-3a6edc9c6a70","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011i6sTmwtax5n86bKD7knhr","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\MigracionEmpresaService.php"}]},"uuid":"660d9802-b9e7-4abc-b347-1eb3813dfa8c","timestamp":"2026-02-16T21:30:02.981Z","sourceToolAssistantUUID":"8b8c006e-5d93-45f3-8b6c-3a6edc9c6a70"}
{"parentUuid":"660d9802-b9e7-4abc-b347-1eb3813dfa8c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Glob","command":"callback"},"parentToolUseID":"toolu_01KbcjDDDqEgBGFqC3uye7aa","toolUseID":"toolu_01KbcjDDDqEgBGFqC3uye7aa","timestamp":"2026-02-16T21:30:03.193Z","uuid":"bf233c18-f8d1-4fe1-95e1-256651a25888"}
{"parentUuid":"69ffabe2-83c8-453f-b3fb-0f81bd7f86ba","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KbcjDDDqEgBGFqC3uye7aa","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\MigracionEmpresaRepository.php"}]},"uuid":"1247ff90-d44f-422a-8130-50869ac6841f","timestamp":"2026-02-16T21:30:03.191Z","sourceToolAssistantUUID":"69ffabe2-83c8-453f-b3fb-0f81bd7f86ba"}
{"parentUuid":"1247ff90-d44f-422a-8130-50869ac6841f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Glob","command":"callback"},"parentToolUseID":"toolu_01Cgbc5xjNiAJsJs4VVWu4GU","toolUseID":"toolu_01Cgbc5xjNiAJsJs4VVWu4GU","timestamp":"2026-02-16T21:30:03.595Z","uuid":"e8f91bb2-3e01-463e-aaa8-abe702c915a3"}
{"parentUuid":"1296874d-8c01-4c8c-8496-2d9e8f4ccb01","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Cgbc5xjNiAJsJs4VVWu4GU","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Jobs\\Migraciones\\MigrarEmpresasSucursalesUsuariosJob.php"}]},"uuid":"292e077d-e3a8-41ed-915f-3b8c201bb67f","timestamp":"2026-02-16T21:30:03.593Z","sourceToolAssistantUUID":"1296874d-8c01-4c8c-8496-2d9e8f4ccb01"}
{"parentUuid":"292e077d-e3a8-41ed-915f-3b8c201bb67f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KvtkkLgRAHt4B81MFLrrBW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B51eGuwRLvbopSHXUQah6L","name":"Grep","input":{"pattern":"empresas-migracion","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","output_mode":"content"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6061,"cache_read_input_tokens":9150,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6061},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTdkQbUnc11z8FRrCi6","type":"assistant","uuid":"8cd58bfd-311b-4915-b98e-3ab133665a39","timestamp":"2026-02-16T21:30:03.821Z"}
{"parentUuid":"8cd58bfd-311b-4915-b98e-3ab133665a39","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01B51eGuwRLvbopSHXUQah6L","toolUseID":"toolu_01B51eGuwRLvbopSHXUQah6L","timestamp":"2026-02-16T21:30:04.696Z","uuid":"c16ff7fa-61fd-4245-b10f-52b9e7f2bf7b"}
{"parentUuid":"8cd58bfd-311b-4915-b98e-3ab133665a39","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B51eGuwRLvbopSHXUQah6L","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:230:            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:231:            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:232:            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:233:            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');"}]},"uuid":"4c89c57f-cae7-4b7e-a5e4-95711cc64abf","timestamp":"2026-02-16T21:30:04.690Z","sourceToolAssistantUUID":"8cd58bfd-311b-4915-b98e-3ab133665a39"}
{"parentUuid":"4c89c57f-cae7-4b7e-a5e4-95711cc64abf","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FLwNp7UJKN3E2jLmfUEdTu","type":"message","role":"assistant","content":[{"type":"text","text":"Good. Now let me read all the core files in parallel."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1150,"cache_read_input_tokens":15211,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1150},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTe9PTjvk2EwMEBTD4s","type":"assistant","uuid":"887dd619-15f6-4402-96e1-c595e62ec046","timestamp":"2026-02-16T21:30:06.290Z"}
{"parentUuid":"887dd619-15f6-4402-96e1-c595e62ec046","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FLwNp7UJKN3E2jLmfUEdTu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015kwBT1j1raCEU2yzSudqoT","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\MigracionEmpresaController.php"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1150,"cache_read_input_tokens":15211,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1150},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTe9PTjvk2EwMEBTD4s","type":"assistant","uuid":"11b5c692-2cb7-4a13-b190-966144ec3215","timestamp":"2026-02-16T21:30:06.815Z"}
{"parentUuid":"11b5c692-2cb7-4a13-b190-966144ec3215","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_015kwBT1j1raCEU2yzSudqoT","toolUseID":"toolu_015kwBT1j1raCEU2yzSudqoT","timestamp":"2026-02-16T21:30:06.966Z","uuid":"00211641-26b1-43e9-a851-70887ad22bba"}
{"parentUuid":"11b5c692-2cb7-4a13-b190-966144ec3215","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015kwBT1j1raCEU2yzSudqoT","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Empresas;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use Illuminate\\Http\\JsonResponse;\n    10→use Illuminate\\Support\\Facades\\DB;\n    11→use App\\Http\\Controllers\\Controller;\n    12→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    13→use App\\Http\\Services\\Empresas\\MigracionEmpresaService;\n    14→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    15→use App\\Http\\Repositories\\Empresas\\MigracionEmpresaRepository;\n    16→\n    17→class MigracionEmpresaController extends Controller\n    18→{\n    19→    use SesionTrait;\n    20→\n    21→    /**\n    22→     * Constructor del controlador de migración de empresas\n    23→     *\n    24→     * Inicializa las dependencias necesarias para las operaciones de migración\n    25→     * y configura los middlewares de autenticación y autorización requeridos.\n    26→     *\n    27→     * @param MigracionEmpresaService $servicio_migracion Servicio para lógica de negocio de migraciones\n    28→     * @param MigracionEmpresaRepository $repositorio_migracion Repositorio para acceso a datos de migración\n    29→     * @param EmpresaRepository $repositorio_empresa Repositorio para operaciones con empresas\n    30→     * @param RutaRepository $repositorio_ruta Repositorio para gestión de rutas del menú\n    31→     * @author Sergio Vargas\n    32→     */\n    33→    public function __construct(\n    34→        private MigracionEmpresaService $servicio_migracion,\n    35→        private MigracionEmpresaRepository $repositorio_migracion,\n    36→        private EmpresaRepository $repositorio_empresa,\n    37→        private RutaRepository $repositorio_ruta\n    38→    ) {\n    39→        $this->middleware('auth');\n    40→        $this->middleware('can:empresas');\n    41→    }\n    42→\n    43→    /**\n    44→     * Muestra la pantalla principal de migración de empresas\n    45→     *\n    46→     * @return View Vista principal del módulo de migración\n    47→     * @author Sergio Vargas\n    48→     */\n    49→    public function index(): View {\n    50→        return view('empresas.migracion.index')->with([\n    51→            'rutas_menu' => $this->repositorio_ruta->getTodo(new Request(['rutas_principales' => true]))\n    52→        ]);\n    53→    }\n    54→\n    55→    /**\n    56→     * Busca empresas por nombre o ID en la base de datos legacy\n    57→     *\n    58→     * Realiza una búsqueda de empresas en la base de datos legacy basándose en\n    59→     * el término proporcionado, que puede ser un ID, nombre de empresa o documento.\n    60→     * Valida que el término de búsqueda sea proporcionado antes de realizar la consulta.\n    61→     *\n    62→     * @param Request $request Petición HTTP que debe contener el parámetro 'termino'\n    63→     * @throws Exception Si hay errores en la conexión a la base de datos legacy\n    64→     * @return JsonResponse Respuesta JSON con los datos de la empresa encontrada o error si no existe\n    65→     * @author Sergio Vargas\n    66→     */\n    67→    public function buscarEmpresa(Request $request): JsonResponse {\n    68→        $codigo    = 200;\n    69→        $respuesta = ['message' => 'Empresa encontrada en base de datos antigua'];\n    70→\n    71→        try {\n    72→            $termino_busqueda = $request->get('termino');\n    73→\n    74→            if (empty($termino_busqueda)) {\n    75→                $codigo    = 400;\n    76→                $respuesta = [\n    77→                    'message' => 'Término de búsqueda requerido',\n    78→                    'errors'  => 'Debe proporcionar un término de búsqueda'\n    79→                ];\n    80→                return new JsonResponse($respuesta, $codigo);\n    81→            }\n    82→\n    83→            $empresa = $this->repositorio_migracion->buscarEmpresaPorNombreOId($termino_busqueda);\n    84→\n    85→            if ($empresa) {\n    86→                $respuesta['data'] = $empresa;\n    87→            } else {\n    88→                $codigo    = 404;\n    89→                $respuesta = [\n    90→                    'message' => 'Empresa no encontrada',\n    91→                    'errors'  => 'No se encontró una empresa con el término proporcionado en la base de datos antigua'\n    92→                ];\n    93→            }\n    94→        } catch (Exception $error) {\n    95→            $codigo    = 400;\n    96→            $respuesta = [\n    97→                'message' => 'Error al buscar empresa en base de datos antigua',\n    98→                'errors'  => $error->getMessage()\n    99→            ];\n   100→        }\n   101→\n   102→        return new JsonResponse($respuesta, $codigo);\n   103→    }\n   104→\n   105→    /**\n   106→     * Valida el tamaño de la empresa y calcula el tiempo de mantenimiento\n   107→     *\n   108→     * Analiza el volumen de datos de una empresa en la base de datos legacy para\n   109→     * determinar su tamaño, categoría, tiempo estimado de migración y si puede ser\n   110→     * migrada automáticamente. Incluye validación de migraciones existentes.\n   111→     *\n   112→     * @param Request $request Petición HTTP que debe contener el parámetro 'empresa_id'\n   113→     * @throws Exception Si hay errores en la validación o consulta a la base de datos legacy\n   114→     * @return JsonResponse Respuesta JSON con información del tamaño, evaluación de migración y tiempo de mantenimiento\n   115→     * @author Sergio Vargas\n   116→     */\n   117→    public function validarTamanoEmpresa(Request $request): JsonResponse {\n   118→        $codigo    = 200;\n   119→        $respuesta = ['message' => 'Validación completada'];\n   120→\n   121→        try {\n   122→            $empresa_legacy_id = $request->get('empresa_id');\n   123→            $validacion        = $this->servicio_migracion->validarTamanoEmpresa($empresa_legacy_id);\n   124→\n   125→            $respuesta['data'] = $validacion;\n   126→        } catch (Exception $error) {\n   127→            $codigo    = 400;\n   128→            $respuesta = [\n   129→                'message' => 'Error al validar tamaño de empresa',\n   130→                'errors'  => $error->getMessage()\n   131→            ];\n   132→        }\n   133→\n   134→        return new JsonResponse($respuesta, $codigo);\n   135→    }\n   136→\n   137→    /**\n   138→     * Inicia el proceso de migración de la empresa\n   139→     *\n   140→     * Programa e inicia el proceso de migración de una empresa desde la base de datos\n   141→     * legacy a la nueva plataforma. Incluye validaciones previas, marcado de empresa\n   142→     * en mantenimiento y creación del registro de migración con ventana de tiempo.\n   143→     * El proceso utiliza transacciones para garantizar consistencia.\n   144→     *\n   145→     * @param Request $request Petición HTTP que debe contener el parámetro 'empresa_id'\n   146→     * @throws Exception Si la empresa no puede ser migrada o ya existe una migración activa\n   147→     * @return JsonResponse Respuesta JSON con el resultado de la migración iniciada, incluyendo ventana de tiempo y estado\n   148→     * @author Sergio Vargas\n   149→     */\n   150→    public function iniciarMigracion(Request $request): JsonResponse {\n   151→        $codigo    = 200;\n   152→        $respuesta = ['message' => 'Migración iniciada exitosamente'];\n   153→\n   154→        try {\n   155→            DB::beginTransaction();\n   156→\n   157→            $empresa_legacy_id = $request->get('empresa_id');\n   158→            $resultado         = $this->servicio_migracion->iniciarMigracion($empresa_legacy_id);\n   159→\n   160→            DB::commit();\n   161→\n   162→            $respuesta['data'] = $resultado;\n   163→        } catch (Exception $error) {\n   164→            DB::rollBack();\n   165→\n   166→            $codigo    = 400;\n   167→            $respuesta = [\n   168→                'message' => 'Error al iniciar migración',\n   169→                'errors'  => $error->getMessage()\n   170→            ];\n   171→        }\n   172→\n   173→        return new JsonResponse($respuesta, $codigo);\n   174→    }\n   175→\n   176→    /**\n   177→     * Listar migraciones con filtros opcionales\n   178→     *\n   179→     * Retorna una lista de migraciones con información detallada para\n   180→     * mostrar en interfaces de administración y permitir gestión.\n   181→     *\n   182→     * @param Request $request Petición HTTP con filtros opcionales (estado, fechas)\n   183→     * @return JsonResponse Respuesta JSON con la lista de migraciones\n   184→     * @author Sergio Vargas\n   185→     */\n   186→    public function listarMigraciones(Request $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = ['message' => 'Lista de migraciones obtenida exitosamente'];\n   189→\n   190→        try {\n   191→            $filtros = [\n   192→                'estado'      => $request->get('estado'),\n   193→                'fecha_desde' => $request->get('fecha_desde'),\n   194→                'fecha_hasta' => $request->get('fecha_hasta')\n   195→            ];\n   196→\n   197→            $migraciones = $this->repositorio_migracion->obtenerMigracionesConDetalles($filtros);\n   198→\n   199→            $respuesta['data'] = $migraciones->map(function ($migracion) {\n   200→                return [\n   201→                    'id'                => $migracion->id,\n   202→                    'empresa_id_old'    => $migracion->empresa_id_old,\n   203→                    'empresa_id_new'    => $migracion->empresa_id_new,\n   204→                    'estado'            => $migracion->estado,\n   205→                    'ventana_inicio'    => $migracion->ventana_inicio,\n   206→                    'ventana_fin'       => $migracion->ventana_fin,\n   207→                    'fecha_inicio_real' => $migracion->fecha_inicio_real,\n   208→                    'fecha_fin_real'    => $migracion->fecha_fin_real,\n   209→                    'observaciones'     => $migracion->observaciones,\n   210→                    'puede_reintentar'  => in_array($migracion->estado, ['error', 'cancelada']),\n   211→                    'puede_cancelar'    => in_array($migracion->estado, ['pendiente', 'en_progreso']),\n   212→                    'usuario'           => $migracion->usuario ? [\n   213→                        'id'        => $migracion->usuario->id,\n   214→                        'nombres'   => $migracion->usuario->nombres,\n   215→                        'apellidos' => $migracion->usuario->apellidos,\n   216→                        'email'     => $migracion->usuario->email\n   217→                    ] : null,\n   218→                    'empresa' => $migracion->empresa ? [\n   219→                        'id'           => $migracion->empresa->id,\n   220→                        'razon_social' => $migracion->empresa->razon_social,\n   221→                        'documento'    => $migracion->empresa->documento\n   222→                    ] : null,\n   223→                    'created_at' => $migracion->created_at,\n   224→                    'updated_at' => $migracion->updated_at\n   225→                ];\n   226→            });\n   227→        } catch (Exception $error) {\n   228→            $codigo    = 400;\n   229→            $respuesta = [\n   230→                'message' => 'Error al obtener lista de migraciones',\n   231→                'errors'  => $error->getMessage()\n   232→            ];\n   233→        }\n   234→\n   235→        return new JsonResponse($respuesta, $codigo);\n   236→    }\n   237→\n   238→    /**\n   239→     * Reintentar una migración fallida o cancelada\n   240→     *\n   241→     * Permite volver a ejecutar una migración que falló previamente.\n   242→     * Realiza validaciones, limpieza de datos parciales y crea una nueva migración.\n   243→     *\n   244→     * @param Request $request Petición HTTP que debe contener el parámetro 'migracion_id'\n   245→     * @throws Exception Si la migración no puede ser reintentada\n   246→     * @return JsonResponse Respuesta JSON con el resultado del reintento de migración\n   247→     * @author Sergio Vargas\n   248→     */\n   249→    public function reintentarMigracion(Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $respuesta = ['message' => 'Migración reintentada exitosamente'];\n   252→\n   253→        try {\n   254→            DB::beginTransaction();\n   255→\n   256→            $migracion_id = $request->get('migracion_id');\n   257→            $resultado    = $this->servicio_migracion->reintentarMigracion($migracion_id);\n   258→\n   259→            DB::commit();\n   260→\n   261→            $respuesta['data'] = $resultado;\n   262→        } catch (Exception $error) {\n   263→            DB::rollBack();\n   264→\n   265→            $codigo    = 400;\n   266→            $respuesta = [\n   267→                'message' => 'Error al reintentar migración',\n   268→                'errors'  => $error->getMessage()\n   269→            ];\n   270→        }\n   271→\n   272→        return new JsonResponse($respuesta, $codigo);\n   273→    }\n   274→\n   275→    /**\n   276→     * Cancelar una migración en progreso o pendiente\n   277→     *\n   278→     * Permite cancelar una migración activa, reactivando la empresa en la\n   279→     * base de datos legacy y marcando la migración como cancelada.\n   280→     *\n   281→     * @param Request $request Petición HTTP que debe contener el parámetro 'migracion_id'\n   282→     * @throws Exception Si la migración no puede ser cancelada\n   283→     * @return JsonResponse Respuesta JSON con el resultado de la cancelación\n   284→     * @author Sergio Vargas\n   285→     */\n   286→    public function cancelarMigracion(Request $request): JsonResponse {\n   287→        $codigo    = 200;\n   288→        $respuesta = ['message' => 'Migración cancelada exitosamente'];\n   289→\n   290→        try {\n   291→            DB::beginTransaction();\n   292→\n   293→            $migracion_id = $request->get('migracion_id');\n   294→            $resultado    = $this->servicio_migracion->cancelarMigracion($migracion_id);\n   295→\n   296→            DB::commit();\n   297→\n   298→            $respuesta['data'] = $resultado;\n   299→        } catch (Exception $error) {\n   300→            DB::rollBack();\n   301→\n   302→            $codigo    = 400;\n   303→            $respuesta = [\n   304→                'message' => 'Error al cancelar migración',\n   305→                'errors'  => $error->getMessage()\n   306→            ];\n   307→        }\n   308→\n   309→        return new JsonResponse($respuesta, $codigo);\n   310→    }\n   311→}\n   312→"}]},"uuid":"377e3d6c-dd80-4b40-b867-97a84ad33590","timestamp":"2026-02-16T21:30:06.966Z","sourceToolAssistantUUID":"11b5c692-2cb7-4a13-b190-966144ec3215"}
{"parentUuid":"377e3d6c-dd80-4b40-b867-97a84ad33590","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FLwNp7UJKN3E2jLmfUEdTu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DwQQqLvA8jsFD44oibK9Ks","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\MigracionEmpresaService.php"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1150,"cache_read_input_tokens":15211,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1150},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTe9PTjvk2EwMEBTD4s","type":"assistant","uuid":"6187bc85-f4d8-4437-b5c6-f6fa752703f4","timestamp":"2026-02-16T21:30:07.256Z"}
{"parentUuid":"6187bc85-f4d8-4437-b5c6-f6fa752703f4","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01DwQQqLvA8jsFD44oibK9Ks","toolUseID":"toolu_01DwQQqLvA8jsFD44oibK9Ks","timestamp":"2026-02-16T21:30:07.386Z","uuid":"97498294-dde5-42b3-8126-d3e7b18505ef"}
{"parentUuid":"6187bc85-f4d8-4437-b5c6-f6fa752703f4","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DwQQqLvA8jsFD44oibK9Ks","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Empresas;\n     4→\n     5→use Log;\n     6→use Exception;\n     7→use App\\Http\\Services\\BaseService;\n     8→use App\\Models\\Empresas\\MigracionEmpresa;\n     9→use App\\Jobs\\Migraciones\\MigrarEmpresasSucursalesUsuariosJob;\n    10→use App\\Http\\Repositories\\Empresas\\MigracionEmpresaRepository;\n    11→\n    12→class MigracionEmpresaService extends BaseService\n    13→{\n    14→    /**\n    15→     * Constructor del servicio de migración de empresas\n    16→     *\n    17→     * @param MigracionEmpresaRepository $repositorio_migracion Repositorio para operaciones de migración\n    18→     * @author Sergio Vargas\n    19→     */\n    20→    public function __construct(MigracionEmpresaRepository $repositorio_migracion) {\n    21→        parent::__construct($repositorio_migracion);\n    22→    }\n    23→\n    24→    /**\n    25→     * Valida el tamaño de la empresa y calcula el tiempo de mantenimiento\n    26→     *\n    27→     * Analiza el volumen de datos de una empresa en la base de datos legacy para\n    28→     * determinar su tamaño, categoría, tiempo estimado de migración y si puede ser\n    29→     * migrada automáticamente. Incluye validación de migraciones existentes y\n    30→     * cálculo de tiempo de mantenimiento basado en métricas reales.\n    31→     *\n    32→     * @param int $empresa_legacy_id ID de la empresa en la base de datos legacy a validar\n    33→     * @throws Exception Si hay errores en la consulta a la base de datos legacy\n    34→     * @return array Información completa del tamaño, evaluación, tiempo de mantenimiento y estado de validación\n    35→     * @author Sergio Vargas\n    36→     */\n    37→    public function validarTamanoEmpresa(int $empresa_legacy_id): array {\n    38→        $informacion_tamano   = $this->repositorio->obtenerTamanoEmpresa($empresa_legacy_id);\n    39→        $migracion_existente  = $this->repositorio->verificarMigracionExistente($empresa_legacy_id);\n    40→        $tiempo_mantenimiento = $this->calcularTiempoMantenimiento($informacion_tamano);\n    41→\n    42→        return [\n    43→            'tamano_info'          => $informacion_tamano,\n    44→            'tiempo_mantenimiento' => $tiempo_mantenimiento,\n    45→            'puede_migrar'         => $this->validarSiPuedeMigrar($informacion_tamano) && !$migracion_existente,\n    46→            'migracion_existente'  => $migracion_existente,\n    47→            'estado_migracion'     => $migracion_existente ? $migracion_existente->estado : null\n    48→        ];\n    49→    }\n    50→\n    51→    /**\n    52→     * Inicia el proceso de migración de la empresa\n    53→     *\n    54→     * Programa e inicia el proceso de migración de una empresa desde la base de datos\n    55→     * legacy a la nueva plataforma. Realiza validaciones previas, marca la empresa\n    56→     * en mantenimiento en la base de datos legacy, crea el registro de migración\n    57→     * con ventana de tiempo programada y maneja rollback automático en caso de error.\n    58→     *\n    59→     * @param int $empresa_legacy_id ID de la empresa en la base de datos legacy a migrar\n    60→     * @throws Exception Si la empresa no puede ser migrada, ya existe una migración activa o falla la inactivación\n    61→     * @return array Información completa de la migración creada incluyendo ventanas de tiempo y datos técnicos\n    62→     * @author Sergio Vargas\n    63→     */\n    64→    public function iniciarMigracion(int $empresa_legacy_id): array {\n    65→        $migracion_existente = $this->repositorio->verificarMigracionExistente($empresa_legacy_id);\n    66→\n    67→        if ($migracion_existente) {\n    68→            throw new Exception('Ya existe una migración para esta empresa con estado: ' . $migracion_existente->estado);\n    69→        }\n    70→\n    71→        $validacion = $this->validarTamanoEmpresa($empresa_legacy_id);\n    72→\n    73→        if (!$validacion['puede_migrar']) {\n    74→            throw new Exception('La empresa no puede ser migrada en este momento');\n    75→        }\n    76→\n    77→        // Inactivar empresa en base de datos legacy antes de iniciar migración\n    78→        $inactivacion_exitosa = $this->repositorio->inactivarEmpresaEnBaseDatosVieja($empresa_legacy_id);\n    79→\n    80→        if (!$inactivacion_exitosa) {\n    81→            throw new Exception('No se pudo marcar la empresa como en mantenimiento en la base de datos legacy');\n    82→        }\n    83→\n    84→        try {\n    85→            $informacion_tamano     = $validacion['tamano_info'];\n    86→            $tiempo_mantenimiento   = $validacion['tiempo_mantenimiento'];\n    87→            $categoria_empresa      = $informacion_tamano['evaluacion']['categoria'];\n    88→            $tiempo_cliente_minutos = $this->obtenerTiempoClienteEnMinutos($categoria_empresa);\n    89→\n    90→            $ventana_inicio = now()->addHours(2);\n    91→            $ventana_fin    = $ventana_inicio->copy()->addMinutes($tiempo_cliente_minutos);\n    92→\n    93→            $migracion = MigracionEmpresa::create([\n    94→                'empresa_id_old'  => $empresa_legacy_id,\n    95→                'empresa_id_new'  => null,\n    96→                'ventana_inicio'  => $ventana_inicio,\n    97→                'ventana_fin'     => $ventana_fin,\n    98→                'estado'          => MigracionEmpresa::ESTADO_PENDIENTE,\n    99→                'observaciones'   => 'Migración programada automáticamente. Empresa marcada en mantenimiento.',\n   100→                'datos_migracion' => [\n   101→                    'tamano_info'        => $informacion_tamano,\n   102→                    'tiempo_estimado'    => $tiempo_mantenimiento,\n   103→                    'fecha_programacion' => now()->toDateTimeString(),\n   104→                    'empresa_inactivada' => true\n   105→                ],\n   106→                'migrado_por' => auth()->id() ?? null\n   107→            ]);\n   108→\n   109→            /**\n   110→             * Dispara el Job que realiza la migración de los datos de la empresa, sus sucursales y los usuarios asociados a cada una, este Job se ejecuta de\n   111→             * forma asincrónica, es decir, se encola.\n   112→             *\n   113→             * @author Fahibram Cárcamo\n   114→             */\n   115→            MigrarEmpresasSucursalesUsuariosJob::dispatch($empresa_legacy_id);\n   116→\n   117→            return [\n   118→                'migracion_id'       => $migracion->id,\n   119→                'empresa_id'         => $empresa_legacy_id,\n   120→                'empresa_nombre'     => $informacion_tamano['empresa_nombre'] ?? 'Sin nombre',\n   121→                'estado'             => $migracion->estado,\n   122→                'ventana_inicio'     => $migracion->ventana_inicio,\n   123→                'ventana_fin'        => $migracion->ventana_fin,\n   124→                'tiempo_estimado'    => $tiempo_mantenimiento,\n   125→                'tiempo_cliente'     => $this->formatearTiempoCliente($categoria_empresa, $tiempo_cliente_minutos),\n   126→                'observaciones'      => $migracion->observaciones,\n   127→                'empresa_inactivada' => true\n   128→            ];\n   129→        } catch (Exception $e) {\n   130→            // En caso de error, reactivar la empresa en la base de datos legacy\n   131→            $this->repositorio->reactivarEmpresaEnBaseDatosVieja($empresa_legacy_id);\n   132→            throw $e;\n   133→        }\n   134→    }\n   135→\n   136→    /**\n   137→     * Calcula el tiempo estimado de mantenimiento basado en el tamaño de la empresa\n   138→     *\n   139→     * Determina el tiempo técnico interno necesario para completar la migración\n   140→     * basándose en métricas reales de la empresa: número de registros totales,\n   141→     * cantidad de usuarios activos y complejidad de datos. Incluye tiempo base\n   142→     * más cálculos proporcionales por volumen de datos.\n   143→     *\n   144→     * @param array $informacion_tamano Información completa del tamaño de la empresa obtenida del repositorio\n   145→     * @return array Desglose detallado del tiempo de mantenimiento calculado con tiempos parciales y total\n   146→     * @author Sergio Vargas\n   147→     */\n   148→    private function calcularTiempoMantenimiento(array $informacion_tamano): array {\n   149→        $total_registros = $informacion_tamano['total_registros'] ?? 0;\n   150→        $total_usuarios  = $informacion_tamano['total_usuarios'] ?? 0;\n   151→\n   152→        $tiempo_base          = 15;\n   153→        $tiempo_por_registros = ceil($total_registros / 1000);\n   154→        $tiempo_por_usuarios  = ceil($total_usuarios / 10) * 2;\n   155→        $tiempo_total         = $tiempo_base + $tiempo_por_registros + $tiempo_por_usuarios;\n   156→\n   157→        return [\n   158→            'tiempo_base'             => $tiempo_base,\n   159→            'tiempo_por_registros'    => $tiempo_por_registros,\n   160→            'tiempo_por_usuarios'     => $tiempo_por_usuarios,\n   161→            'tiempo_total_minutos'    => $tiempo_total,\n   162→            'tiempo_total_formateado' => $this->formatearTiempo($tiempo_total)\n   163→        ];\n   164→    }\n   165→\n   166→    /**\n   167→     * Valida si la empresa puede ser migrada basándose en límites establecidos\n   168→     *\n   169→     * Determina si una empresa es candidata para migración automática evaluando\n   170→     * si cumple con los límites máximos permitidos para registros y usuarios.\n   171→     * Estas validaciones previenen sobrecargas del sistema durante la migración.\n   172→     *\n   173→     * @param array $informacion_tamano Información del tamaño de la empresa obtenida del análisis\n   174→     * @return bool True si puede ser migrada automáticamente, False si requiere revisión manual\n   175→     * @author Sergio Vargas\n   176→     */\n   177→    private function validarSiPuedeMigrar(array $informacion_tamano): bool {\n   178→        $total_registros = $informacion_tamano['total_registros'] ?? 0;\n   179→        $total_usuarios  = $informacion_tamano['total_usuarios'] ?? 0;\n   180→\n   181→        $maximo_registros = 1000000;\n   182→        $maximo_usuarios  = 100000;\n   183→\n   184→        return $total_registros <= $maximo_registros && $total_usuarios <= $maximo_usuarios;\n   185→    }\n   186→\n   187→    /**\n   188→     * Formatea el tiempo en minutos a formato legible\n   189→     *\n   190→     * Convierte un tiempo expresado en minutos a un formato de texto legible\n   191→     * que incluye horas y minutos según corresponda. Utiliza pluralización\n   192→     * correcta en español para una mejor presentación al usuario.\n   193→     *\n   194→     * @param int $minutos_totales Tiempo en minutos a formatear\n   195→     * @return string Tiempo formateado en formato legible (ej: \"2 horas y 30 minutos\")\n   196→     * @author Sergio Vargas\n   197→     */\n   198→    private function formatearTiempo(int $minutos_totales): string {\n   199→        if ($minutos_totales < 60) {\n   200→            return $minutos_totales . ' minutos';\n   201→        }\n   202→\n   203→        $horas_calculadas  = floor($minutos_totales / 60);\n   204→        $minutos_restantes = $minutos_totales % 60;\n   205→\n   206→        $resultado = $horas_calculadas . ' hora' . ($horas_calculadas > 1 ? 's' : '');\n   207→\n   208→        if ($minutos_restantes > 0) {\n   209→            $resultado .= ' y ' . $minutos_restantes . ' minutos';\n   210→        }\n   211→\n   212→        return $resultado;\n   213→    }\n   214→\n   215→    /**\n   216→     * Obtiene el tiempo de mantenimiento para el cliente en minutos basado en la categoría\n   217→     *\n   218→     * Define los tiempos de mantenimiento comunicados al cliente según la categoría\n   219→     * de la empresa. Estos son tiempos conservadores que incluyen margen de seguridad\n   220→     * para garantizar que la migración se complete dentro del tiempo prometido.\n   221→     *\n   222→     * @param string $categoria_empresa Categoría de la empresa (pequeña, mediana, grande, muy_grande)\n   223→     * @return int Tiempo de mantenimiento en minutos para comunicar al cliente\n   224→     * @author Sergio Vargas\n   225→     */\n   226→    private function obtenerTiempoClienteEnMinutos(string $categoria_empresa): int {\n   227→        $tiempos_cliente = [\n   228→            'pequeña'    => 4 * 60,\n   229→            'mediana'    => 24 * 60,\n   230→            'grande'     => 48 * 60,\n   231→            'muy_grande' => 48 * 60\n   232→        ];\n   233→\n   234→        return $tiempos_cliente[$categoria_empresa] ?? 24 * 60;\n   235→    }\n   236→\n   237→    /**\n   238→     * Formatea el tiempo del cliente para mostrar de manera legible\n   239→     *\n   240→     * Convierte la categoría de empresa a un texto legible del tiempo de mantenimiento\n   241→     * que se comunicará al cliente. Proporciona estimaciones conservadoras y fáciles\n   242→     * de entender para la planificación del cliente.\n   243→     *\n   244→     * @param string $categoria_empresa Categoría de la empresa\n   245→     * @param int $minutos_calculados Tiempo en minutos (no utilizado, se mantiene para compatibilidad)\n   246→     * @return string Tiempo formateado en texto legible para mostrar al cliente\n   247→     * @author Sergio Vargas\n   248→     */\n   249→    private function formatearTiempoCliente(string $categoria_empresa, int $minutos_calculados): string {\n   250→        $tiempos_formateados = [\n   251→            'pequeña'    => '4 horas',\n   252→            'mediana'    => '1 día',\n   253→            'grande'     => '2 días',\n   254→            'muy_grande' => '2 días'\n   255→        ];\n   256→\n   257→        return $tiempos_formateados[$categoria_empresa] ?? '1 día';\n   258→    }\n   259→\n   260→    /**\n   261→     * Reintentar una migración fallida o cancelada\n   262→     *\n   263→     * Permite volver a ejecutar una migración que falló previamente. Realiza:\n   264→     * - Validación de que la migración existe y está en estado de error o cancelada\n   265→     * - Reactivación de la empresa en la base de datos legacy\n   266→     * - Limpieza de datos parciales si es necesario\n   267→     * - Creación de una nueva migración o actualización de la existente\n   268→     *\n   269→     * @param int $migracion_id ID de la migración a reintentar\n   270→     * @throws Exception Si la migración no puede ser reintentada\n   271→     * @return array Información de la migración reintentada\n   272→     * @author Sergio Vargas\n   273→     */\n   274→    public function reintentarMigracion(int $migracion_id): array {\n   275→        $migracion = MigracionEmpresa::find($migracion_id);\n   276→\n   277→        if (!$migracion) {\n   278→            throw new Exception('La migración especificada no existe');\n   279→        }\n   280→\n   281→        if (!in_array($migracion->estado, [MigracionEmpresa::ESTADO_ERROR, MigracionEmpresa::ESTADO_CANCELADA])) {\n   282→            throw new Exception('Solo se pueden reintentar migraciones con estado de error o canceladas. Estado actual: ' . $migracion->estado);\n   283→        }\n   284→\n   285→        $empresa_legacy_id = $migracion->empresa_id_old;\n   286→\n   287→        // Verificar que la empresa aún no haya sido migrada exitosamente\n   288→        $migracion_exitosa = $this->repositorio->verificarMigracionExistente($empresa_legacy_id);\n   289→        if ($migracion_exitosa && $migracion_exitosa->estado === MigracionEmpresa::ESTADO_COMPLETADA) {\n   290→            throw new Exception('La empresa ya fue migrada exitosamente en otra migración');\n   291→        }\n   292→\n   293→        try {\n   294→            // Marcar la migración actual como cancelada si no lo está\n   295→            if ($migracion->estado !== MigracionEmpresa::ESTADO_CANCELADA) {\n   296→                $migracion->update([\n   297→                    'estado' => MigracionEmpresa::ESTADO_CANCELADA,\n   298→                    'observaciones' => ($migracion->observaciones ?? '') . '. Cancelada para reintentar migración.'\n   299→                ]);\n   300→            }\n   301→\n   302→            // Reactivar empresa en base de datos legacy por si estaba en mantenimiento\n   303→            $this->repositorio->reactivarEmpresaEnBaseDatosVieja($empresa_legacy_id);\n   304→\n   305→            // Limpiar posibles datos parciales de la migración anterior\n   306→            $this->limpiarDatosMigracionParcial($migracion);\n   307→\n   308→            // Iniciar una nueva migración\n   309→            return $this->iniciarMigracion($empresa_legacy_id);\n   310→\n   311→        } catch (Exception $e) {\n   312→            throw new Exception('Error al reintentar migración: ' . $e->getMessage());\n   313→        }\n   314→    }\n   315→\n   316→    /**\n   317→     * Cancelar una migración en progreso\n   318→     *\n   319→     * Permite cancelar una migración que está en progreso o pendiente.\n   320→     * Reactiva la empresa en la base de datos legacy y marca la migración como cancelada.\n   321→     *\n   322→     * @param int $migracion_id ID de la migración a cancelar\n   323→     * @throws Exception Si la migración no puede ser cancelada\n   324→     * @return array Información de la migración cancelada\n   325→     * @author Sergio Vargas\n   326→     */\n   327→    public function cancelarMigracion(int $migracion_id): array {\n   328→        $migracion = MigracionEmpresa::find($migracion_id);\n   329→\n   330→        if (!$migracion) {\n   331→            throw new Exception('La migración especificada no existe');\n   332→        }\n   333→\n   334→        if (!in_array($migracion->estado, [MigracionEmpresa::ESTADO_PENDIENTE, MigracionEmpresa::ESTADO_EN_PROGRESO])) {\n   335→            throw new Exception('Solo se pueden cancelar migraciones pendientes o en progreso. Estado actual: ' . $migracion->estado);\n   336→        }\n   337→\n   338→        try {\n   339→            // Reactivar empresa en base de datos legacy\n   340→            $reactivacion_exitosa = $this->repositorio->reactivarEmpresaEnBaseDatosVieja($migracion->empresa_id_old);\n   341→\n   342→            // Marcar migración como cancelada\n   343→            $migracion->update([\n   344→                'estado' => MigracionEmpresa::ESTADO_CANCELADA,\n   345→                'fecha_fin_real' => now(),\n   346→                'observaciones' => ($migracion->observaciones ?? '') . '. Migración cancelada manualmente.'\n   347→            ]);\n   348→\n   349→            return [\n   350→                'migracion_id' => $migracion->id,\n   351→                'empresa_id' => $migracion->empresa_id_old,\n   352→                'estado' => $migracion->estado,\n   353→                'empresa_reactivada' => $reactivacion_exitosa,\n   354→                'fecha_cancelacion' => $migracion->fecha_fin_real,\n   355→                'observaciones' => $migracion->observaciones\n   356→            ];\n   357→\n   358→        } catch (Exception $e) {\n   359→            throw new Exception('Error al cancelar migración: ' . $e->getMessage());\n   360→        }\n   361→    }\n   362→\n   363→    /**\n   364→     * Limpiar datos parciales de una migración fallida\n   365→     *\n   366→     * Elimina datos que pudieron haberse creado parcialmente durante una migración\n   367→     * fallida para evitar conflictos en el reintento.\n   368→     *\n   369→     * @param MigracionEmpresa $migracion Migración fallida\n   370→     * @return void\n   371→     * @author Sergio Vargas\n   372→     */\n   373→    private function limpiarDatosMigracionParcial(MigracionEmpresa $migracion): void {\n   374→        // Si se creó una empresa nueva pero la migración falló, eliminarla\n   375→        if ($migracion->empresa_id_new) {\n   376→            // Aquí se podría implementar lógica para eliminar la empresa creada parcialmente\n   377→            // Por ahora solo registramos que hay una empresa que podría necesitar limpieza\n   378→            Log::warning(\"Migración {$migracion->id} tiene empresa_id_new: {$migracion->empresa_id_new}. Podría requerir limpieza manual.\");\n   379→        }\n   380→    }\n   381→}\n   382→"}]},"uuid":"582fe0a8-05e0-4b25-899e-29d2e3480481","timestamp":"2026-02-16T21:30:07.386Z","sourceToolAssistantUUID":"6187bc85-f4d8-4437-b5c6-f6fa752703f4"}
{"parentUuid":"582fe0a8-05e0-4b25-899e-29d2e3480481","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FLwNp7UJKN3E2jLmfUEdTu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Rpbe9AWjhq1oBKLjdEaWmQ","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\MigracionEmpresaRepository.php"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1150,"cache_read_input_tokens":15211,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1150},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTe9PTjvk2EwMEBTD4s","type":"assistant","uuid":"5d480ab9-e46f-4bb6-9e8b-ec8de37602e9","timestamp":"2026-02-16T21:30:07.811Z"}
{"parentUuid":"5d480ab9-e46f-4bb6-9e8b-ec8de37602e9","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01Rpbe9AWjhq1oBKLjdEaWmQ","toolUseID":"toolu_01Rpbe9AWjhq1oBKLjdEaWmQ","timestamp":"2026-02-16T21:30:08.100Z","uuid":"11b117a7-37e1-4e14-9032-e3171daf01de"}
{"parentUuid":"5d480ab9-e46f-4bb6-9e8b-ec8de37602e9","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Rpbe9AWjhq1oBKLjdEaWmQ","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\Empresas;\n     4→\n     5→use Log;\n     6→use Exception;\n     7→use Illuminate\\Support\\Collection;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Http\\Repositories\\BaseRepository;\n    10→use App\\Models\\Empresas\\MigracionEmpresa;\n    11→\n    12→/**\n    13→ * Repositorio para manejo de migraciones de empresas desde base de datos legacy\n    14→ *\n    15→ * Gestiona todas las operaciones relacionadas con la migración de datos de empresas\n    16→ * desde la base de datos legacy hacia la nueva estructura de PsicoAlianza.\n    17→ * Incluye funcionalidades de búsqueda, validación de tamaño, estimación de tiempos\n    18→ * y control de estado de empresas durante el proceso de migración.\n    19→ *\n    20→ * @version 1.0\n    21→ * @author SergilloElPillo\n    22→ * @since 1991\n    23→ */\n    24→class MigracionEmpresaRepository extends BaseRepository\n    25→{\n    26→    /**\n    27→     * Constructor del repositorio de migración de empresas\n    28→     *\n    29→     * Inicializa el repositorio con el modelo base de Empresa para operaciones\n    30→     * de herencia del repositorio base, aunque las operaciones principales\n    31→     * de este repositorio se realizan contra la base de datos legacy.\n    32→     *\n    33→     * @param MigracionEmpresa $modelo_base Modelo Eloquent de migración de empresa para operaciones base del repositorio\n    34→     * @author Sergio Vargas\n    35→     */\n    36→    public function __construct(MigracionEmpresa $modelo_base) {\n    37→        parent::__construct($modelo_base);\n    38→    }\n    39→\n    40→    /**\n    41→     * Busca una empresa por nombre o ID en la base de datos legacy\n    42→     *\n    43→     * Realiza una búsqueda flexible que permite encontrar empresas por:\n    44→     * - ID exacto de empresa\n    45→     * - Razón social (búsqueda parcial con LIKE)\n    46→     * - Número de identificación/documento (búsqueda parcial con LIKE)\n    47→     *\n    48→     * La búsqueda incluye información de ciudad asociada y formatea los datos\n    49→     * para compatibilidad con la estructura esperada por el sistema nuevo.\n    50→     *\n    51→     * @param string $termino_busqueda Término de búsqueda (ID, nombre o documento)\n    52→     * @throws Exception Si hay errores en la conexión a la base de datos legacy\n    53→     * @return array|null Datos completos de la empresa encontrada o null si no existe\n    54→     * @author Sergio Vargas\n    55→     */\n    56→    public function buscarEmpresaPorNombreOId(string $termino_busqueda): ?array {\n    57→        try {\n    58→            // Verificar conexión\n    59→            $connection = DB::connection('old_db');\n    60→\n    61→            // Buscar en la base de datos legacy priorizando búsqueda exacta por ID\n    62→            $resultado = $connection->select(\"\n    63→                SELECT\n    64→                    e.id_empresa AS id,\n    65→                    e.razon_social,\n    66→                    e.identificacion,\n    67→                    e.telefono,\n    68→                    c.ciudad AS ciudad_nombre\n    69→                FROM\n    70→                    empresa e\n    71→                    LEFT JOIN ciudad c ON e.id_ciudad = c.id_ciudad\n    72→                WHERE \n    73→                    e.id_empresa = ? OR\n    74→                    e.razon_social LIKE ? OR \n    75→                    e.identificacion LIKE ?\n    76→                ORDER BY \n    77→                    CASE \n    78→                        WHEN e.id_empresa = ? THEN 1\n    79→                        WHEN e.identificacion = ? THEN 2\n    80→                        WHEN e.razon_social = ? THEN 3\n    81→                        ELSE 4\n    82→                    END,\n    83→                    e.id_empresa DESC\n    84→                LIMIT 1\n    85→            \", [\n    86→                $termino_busqueda,\n    87→                \"%{$termino_busqueda}%\",\n    88→                \"%{$termino_busqueda}%\",\n    89→                $termino_busqueda,\n    90→                $termino_busqueda,\n    91→                $termino_busqueda\n    92→            ]);\n    93→\n    94→            if (empty($resultado)) {\n    95→                return null;\n    96→            }\n    97→\n    98→            // Convertir el resultado a array asociativo\n    99→            $empresa = (array) $resultado[0];\n   100→\n   101→            // Formatear los datos para que coincidan con la estructura esperada\n   102→            return [\n   103→                'id'               => $empresa['id'],\n   104→                'razon_social'     => $empresa['razon_social'],\n   105→                'nombre_comercial' => $empresa['razon_social'], // Usando razon_social como nombre_comercial\n   106→                'documento'        => $empresa['identificacion'],\n   107→                'telefono'         => $empresa['telefono'],\n   108→                'ciudad'           => [\n   109→                    'nombre' => $empresa['ciudad_nombre']\n   110→                ],\n   111→                'sector' => [\n   112→                    'nombre' => 'No definido'\n   113→                ],\n   114→                'tamanoEmpresa' => [\n   115→                    'nombre' => 'No definido'\n   116→                ]\n   117→            ];\n   118→        } catch (Exception $e) {\n   119→            Log::error(\"Error en búsqueda de empresa: \" . $e->getMessage());\n   120→            Log::error(\"Stack trace: \" . $e->getTraceAsString());\n   121→            return null;\n   122→        }\n   123→    }\n   124→\n   125→    /**\n   126→     * Buscar empresa por ID exacto en la base de datos legacy\n   127→     *\n   128→     * Busca una empresa específica por su ID exacto en la base de datos legacy\n   129→     * para garantizar que se obtienen los datos correctos.\n   130→     *\n   131→     * @param int $empresa_legacy_id ID exacto de la empresa en la base de datos legacy\n   132→     * @return array|null Datos completos de la empresa encontrada o null si no existe\n   133→     * @author Sergio Vargas\n   134→     */\n   135→    public function buscarEmpresaPorIdExacto(int $empresa_legacy_id): ?array {\n   136→        try {\n   137→            $connection = DB::connection('old_db');\n   138→\n   139→            $resultado = $connection->select(\"\n   140→                SELECT\n   141→                    e.id_empresa AS id,\n   142→                    e.razon_social,\n   143→                    e.identificacion,\n   144→                    e.telefono,\n   145→                    c.ciudad AS ciudad_nombre\n   146→                FROM\n   147→                    empresa e\n   148→                    LEFT JOIN ciudad c ON e.id_ciudad = c.id_ciudad\n   149→                WHERE \n   150→                    e.id_empresa = ?\n   151→            \", [$empresa_legacy_id]);\n   152→\n   153→            if (empty($resultado)) {\n   154→                return null;\n   155→            }\n   156→\n   157→            $empresa = (array) $resultado[0];\n   158→\n   159→            return [\n   160→                'id'               => $empresa['id'],\n   161→                'razon_social'     => $empresa['razon_social'],\n   162→                'nombre_comercial' => $empresa['razon_social'],\n   163→                'documento'        => $empresa['identificacion'],\n   164→                'telefono'         => $empresa['telefono'],\n   165→                'ciudad'           => [\n   166→                    'nombre' => $empresa['ciudad_nombre']\n   167→                ],\n   168→                'sector' => [\n   169→                    'nombre' => 'No definido'\n   170→                ],\n   171→                'tamanoEmpresa' => [\n   172→                    'nombre' => 'No definido'\n   173→                ]\n   174→            ];\n   175→        } catch (Exception $e) {\n   176→            Log::error(\"Error al buscar empresa por ID exacto {$empresa_legacy_id}: \" . $e->getMessage());\n   177→            return null;\n   178→        }\n   179→    }\n   180→\n   181→    /**\n   182→     * Obtiene información detallada del tamaño de la empresa para migración\n   183→     *\n   184→     * Analiza el volumen de datos de una empresa en la base de datos legacy\n   185→     * ejecutando consultas específicas para determinar:\n   186→     * - Número total de registros por tabla\n   187→     * - Tamaño estimado en MB\n   188→     * - Conteos de usuarios, procesos y agendas activas\n   189→     * - Evaluación de complejidad de migración\n   190→     * - Categorización automática basada en volúmenes de datos\n   191→     *\n   192→     * @param int $empresa_legacy_id ID de la empresa en la base de datos legacy\n   193→     * @return array Información completa del tamaño, evaluación de migración y datos técnicos\n   194→     * @author Sergio Vargas\n   195→     */\n   196→    public function obtenerTamanoEmpresa(int $empresa_legacy_id): array {\n   197→        Log::info('Iniciando análisis de tamaño de empresa', ['empresa_id' => $empresa_legacy_id]);\n   198→        \n   199→        // Obtener información básica de la empresa desde la base de datos legacy usando ID exacto\n   200→        $empresa = $this->buscarEmpresaPorIdExacto($empresa_legacy_id);\n   201→\n   202→        if (!$empresa) {\n   203→            return [];\n   204→        }\n   205→\n   206→        // Ejecutar la consulta SQL específica contra la base de datos legacy\n   207→        $tablas_tamano = $this->ejecutarConsultaTamanoEmpresa($empresa_legacy_id);\n   208→\n   209→        // Procesar resultados\n   210→        $total_filas     = $tablas_tamano->sum('filas_empresa');\n   211→        $total_megabytes = $tablas_tamano->sum('mb_estimados');\n   212→        $total_tablas    = $tablas_tamano->count();\n   213→\n   214→        // Obtener conteos específicos desde la base de datos legacy\n   215→        $conteos_legacy = $this->obtenerConteosEmpresaLegacy($empresa_legacy_id);\n   216→        $total_usuarios = $conteos_legacy['usuarios'];\n   217→\n   218→        // Determinar tamaño y complejidad basado en los datos reales\n   219→        $evaluacion = $this->evaluarTamanoEmpresa($total_filas, $total_usuarios, $total_megabytes);\n   220→        \n   221→        // Obtener lista de usuarios que serán migrados\n   222→        $usuarios_para_migrar = $this->obtenerUsuariosParaMigracion($empresa_legacy_id);\n   223→        \n   224→        Log::info('Análisis de tamaño completado', [\n   225→            'empresa_id' => $empresa_legacy_id,\n   226→            'total_registros' => $total_filas,\n   227→            'total_usuarios' => $total_usuarios,\n   228→            'categoria' => $evaluacion['categoria'],\n   229→            'puede_migrar' => $evaluacion['candidata_automatica'],\n   230→            'usuarios_encontrados' => count($usuarios_para_migrar)\n   231→        ]);\n   232→        \n   233→        return [\n   234→            'empresa_id'     => $empresa_legacy_id,\n   235→            'empresa_nombre' => $empresa['razon_social'] ?? $empresa['nombre_comercial'],\n   236→            'conteos_legacy' => $conteos_legacy,\n   237→            'datos_legacy'   => [\n   238→                'total_registros' => $total_filas,\n   239→                'total_mb'        => $total_megabytes,\n   240→                'total_tablas'    => $total_tablas,\n   241→                'detalle_tablas'  => $tablas_tamano->toArray()\n   242→            ],\n   243→            'total_registros' => $total_filas,\n   244→            'total_usuarios'  => $total_usuarios,\n   245→            'evaluacion'      => $evaluacion,\n   246→            'tamano_empresa'  => $empresa['tamanoEmpresa']['nombre'] ?? 'No definido',\n   247→            'usuarios_migrar' => $usuarios_para_migrar\n   248→        ];\n   249→    }\n   250→\n   251→    /**\n   252→     * Ejecuta la consulta SQL específica para obtener el tamaño de empresa\n   253→     *\n   254→     * Realiza una consulta compleja que analiza las principales tablas de la base\n   255→     * de datos legacy (empresa, usuario, es_procesos, es_agenda) para calcular:\n   256→     * - Número de filas por empresa en cada tabla\n   257→     * - Tamaño total de cada tabla en MB\n   258→     * - Estimación de espacio que ocupará la empresa tras migración\n   259→     * - Filtros específicos para usuarios activos y agendas relevantes\n   260→     *\n   261→     * @param int $empresa_legacy_id ID de la empresa en la base de datos legacy a analizar\n   262→     * @return Collection Colección con datos detallados de tamaño por tabla\n   263→     * @author Sergio Vargas\n   264→     */\n   265→    private function ejecutarConsultaTamanoEmpresa(int $empresa_legacy_id): Collection {\n   266→        try {\n   267→            // Ejecutar la consulta SQL específica adaptada para Laravel\n   268→            $resultado = DB::connection('old_db')->select(\"\n   269→                SELECT \n   270→                    tabla,\n   271→                    filas_empresa,\n   272→                    total_rows,\n   273→                    mb_tabla,\n   274→                    mb_estimados\n   275→                FROM (\n   276→                    -- Tablas con id_empresa directamente\n   277→                    SELECT \n   278→                        'empresa' AS tabla,\n   279→                        COUNT(*) AS filas_empresa,\n   280→                        (SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'empresa') AS total_rows,\n   281→                        (SELECT ROUND((data_length+index_length)/1024/1024,2) FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'empresa') AS mb_tabla,\n   282→                        ROUND(IF((SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'empresa')=0,0,\n   283→                                (SELECT (data_length+index_length) FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'empresa')/(SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'empresa'))\n   284→                             * COUNT(*) / 1024 / 1024, 2) AS mb_estimados\n   285→                    FROM empresa WHERE id_empresa = ?\n   286→                    \n   287→                    UNION ALL\n   288→                    \n   289→                    SELECT \n   290→                        'usuario' AS tabla,\n   291→                        COUNT(*) AS filas_empresa,\n   292→                        (SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'usuario') AS total_rows,\n   293→                        (SELECT ROUND((data_length+index_length)/1024/1024,2) FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'usuario') AS mb_tabla,\n   294→                        ROUND(IF((SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'usuario')=0,0,\n   295→                                (SELECT (data_length+index_length) FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'usuario')/(SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'usuario'))\n   296→                             * COUNT(*) / 1024 / 1024, 2) AS mb_estimados\n   297→                    FROM usuario WHERE id_empresa = ? AND id_estado = 1\n   298→                    \n   299→                    UNION ALL\n   300→                    \n   301→                    SELECT \n   302→                        'es_procesos' AS tabla,\n   303→                        COUNT(*) AS filas_empresa,\n   304→                        (SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'es_procesos') AS total_rows,\n   305→                        (SELECT ROUND((data_length+index_length)/1024/1024,2) FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'es_procesos') AS mb_tabla,\n   306→                        ROUND(IF((SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'es_procesos')=0,0,\n   307→                                (SELECT (data_length+index_length) FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'es_procesos')/(SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'es_procesos'))\n   308→                             * COUNT(*) / 1024 / 1024, 2) AS mb_estimados\n   309→                    FROM es_procesos WHERE id_empresa = ?\n   310→                    \n   311→                    UNION ALL\n   312→                    \n   313→                    SELECT \n   314→                        'es_agenda' AS tabla,\n   315→                        COUNT(*) AS filas_empresa,\n   316→                        (SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'es_agenda') AS total_rows,\n   317→                        (SELECT ROUND((data_length+index_length)/1024/1024,2) FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'es_agenda') AS mb_tabla,\n   318→                        ROUND(IF((SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'es_agenda')=0,0,\n   319→                                (SELECT (data_length+index_length) FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'es_agenda')/(SELECT table_rows FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'es_agenda'))\n   320→                             * COUNT(*) / 1024 / 1024, 2) AS mb_estimados\n   321→                    FROM es_agenda a \n   322→                    JOIN es_procesos p ON p.id_proceso = a.id_proceso \n   323→                    WHERE p.id_empresa = ? AND (\n   324→                        a.id_estado_agenda = 4 OR \n   325→                        (a.id_estado_agenda = 1 AND \n   326→                         a.fecha_inicio IS NOT NULL AND \n   327→                         a.fecha_fin IS NOT NULL AND\n   328→                         ABS(DATEDIFF(CURDATE(), a.fecha_inicio)) <= 10 AND\n   329→                         ABS(DATEDIFF(CURDATE(), a.fecha_fin)) <= 10)\n   330→                    )\n   331→                    \n   332→                ) AS resultado\n   333→                ORDER BY mb_estimados DESC\n   334→            \", [$empresa_legacy_id, $empresa_legacy_id, $empresa_legacy_id, $empresa_legacy_id]);\n   335→\n   336→            return collect($resultado);\n   337→        } catch (Exception $e) {\n   338→            // Si falla la consulta legacy, retornar datos básicos\n   339→            return collect([\n   340→                [\n   341→                    'tabla'         => 'error_consulta',\n   342→                    'filas_empresa' => 0,\n   343→                    'total_rows'    => 0,\n   344→                    'mb_tabla'      => 0,\n   345→                    'mb_estimados'  => 0,\n   346→                    'error'         => $e->getMessage()\n   347→                ]\n   348→            ]);\n   349→        }\n   350→    }\n   351→\n   352→    /**\n   353→     * Obtiene conteos específicos de la empresa desde la base de datos legacy\n   354→     *\n   355→     * Realiza conteos directos de los elementos principales de una empresa:\n   356→     * - Usuarios activos (estados 1 y 2)\n   357→     * - Procesos de evaluación creados\n   358→     * - Agendas completadas o próximas a ejecutarse\n   359→     *\n   360→     * Estos conteos son fundamentales para la categorización de la empresa\n   361→     * y el cálculo de tiempos de migración.\n   362→     *\n   363→     * @param int $empresa_legacy_id ID de la empresa en la base de datos legacy\n   364→     * @return array Array asociativo con conteos detallados por tipo de elemento\n   365→     * @author Sergio Vargas\n   366→     */\n   367→    private function obtenerConteosEmpresaLegacy(int $empresa_legacy_id): array {\n   368→        Log::info('Obteniendo conteos de empresa legacy', ['empresa_id' => $empresa_legacy_id]);\n   369→        \n   370→        try {\n   371→            $conteos = DB::connection('old_db')->select(\"\n   372→                SELECT \n   373→                    'usuarios' as tipo,\n   374→                    COUNT(*) as cantidad\n   375→                FROM usuario \n   376→                WHERE id_empresa = ? AND id_estado = 1\n   377→                \n   378→                UNION ALL\n   379→                \n   380→                SELECT \n   381→                    'procesos' as tipo,\n   382→                    COUNT(*) as cantidad\n   383→                FROM es_procesos \n   384→                WHERE id_empresa = ?\n   385→                \n   386→                UNION ALL\n   387→                \n   388→                SELECT \n   389→                    'agendas' as tipo,\n   390→                    COUNT(*) as cantidad\n   391→                FROM es_agenda a \n   392→                JOIN es_procesos p ON p.id_proceso = a.id_proceso \n   393→                WHERE p.id_empresa = ? AND (\n   394→                    a.id_estado_agenda = 4 OR \n   395→                    (a.id_estado_agenda = 1 AND \n   396→                     a.fecha_inicio IS NOT NULL AND \n   397→                     a.fecha_fin IS NOT NULL AND\n   398→                     ABS(DATEDIFF(CURDATE(), a.fecha_inicio)) <= 10 AND\n   399→                     ABS(DATEDIFF(CURDATE(), a.fecha_fin)) <= 10)\n   400→                )\n   401→            \", [$empresa_legacy_id, $empresa_legacy_id, $empresa_legacy_id]);\n   402→\n   403→            // Convertir a array asociativo\n   404→            $resultado = [\n   405→                'usuarios' => 0,\n   406→                'procesos' => 0,\n   407→                'agendas'  => 0\n   408→            ];\n   409→\n   410→            foreach ($conteos as $conteo) {\n   411→                $resultado[$conteo->tipo] = $conteo->cantidad;\n   412→            }\n   413→            \n   414→            Log::info('Conteos obtenidos de empresa legacy', [\n   415→                'empresa_id' => $empresa_legacy_id,\n   416→                'conteos' => $resultado\n   417→            ]);\n   418→\n   419→            return $resultado;\n   420→        } catch (Exception $e) {\n   421→            // Si falla la consulta, retornar conteos en 0\n   422→            return [\n   423→                'usuarios' => 0,\n   424→                'procesos' => 0,\n   425→                'agendas'  => 0\n   426→            ];\n   427→        }\n   428→    }\n   429→\n   430→    /**\n   431→     * Obtiene lista de empresas candidatas para migración\n   432→     *\n   433→     * Busca empresas activas en la nueva base de datos que podrían ser\n   434→     * candidatas para procesos de migración. Permite filtrado avanzado por:\n   435→     * - Sector económico\n   436→     * - Tamaño de empresa\n   437→     * - Ciudad\n   438→     * - Límite de resultados\n   439→     *\n   440→     * Esta funcionalidad es útil para reportes y análisis de migraciones masivas.\n   441→     *\n   442→     * @param array $filtros_busqueda Filtros opcionales para la búsqueda avanzada\n   443→     * @return Collection Colección de empresas candidatas con sus relaciones cargadas\n   444→     * @author Sergio Vargas\n   445→     */\n   446→    public function obtenerEmpresasCandidatasParaMigracion(array $filtros_busqueda = []): Collection {\n   447→        $query = $this->modelo\n   448→            ->where('activo', true)\n   449→            ->with(['ciudad', 'sector', 'tamanoEmpresa']);\n   450→\n   451→        // Aplicar filtros opcionales\n   452→        if (!empty($filtros_busqueda['sector_id'])) {\n   453→            $query->where('sector_id', $filtros_busqueda['sector_id']);\n   454→        }\n   455→\n   456→        if (!empty($filtros_busqueda['tamano_empresa_id'])) {\n   457→            $query->where('tamano_empresa_id', $filtros_busqueda['tamano_empresa_id']);\n   458→        }\n   459→\n   460→        if (!empty($filtros_busqueda['ciudad_id'])) {\n   461→            $query->where('ciudad_id', $filtros_busqueda['ciudad_id']);\n   462→        }\n   463→\n   464→        if (!empty($filtros_busqueda['limite'])) {\n   465→            $query->limit($filtros_busqueda['limite']);\n   466→        }\n   467→\n   468→        return $query->get();\n   469→    }\n   470→\n   471→    /**\n   472→     * Evalúa el tamaño y complejidad de migración de una empresa\n   473→     *\n   474→     * Categoriza las empresas según su tamaño y complejidad de migración:\n   475→     * - Pequeña: ≤5K registros, ≤50 usuarios, ≤100MB\n   476→     * - Mediana: ≤50K registros, ≤200 usuarios, ≤1GB\n   477→     * - Grande: ≤500K registros, ≤1K usuarios, ≤5GB\n   478→     * - Muy grande: >500K registros, >1K usuarios, >5GB\n   479→     *\n   480→     * La evaluación incluye recomendaciones de migración y cálculos de prioridad.\n   481→     *\n   482→     * @param int $total_registros_empresa Número total de registros de la empresa\n   483→     * @param int $total_usuarios_activos Número total de usuarios activos\n   484→     * @param float $total_megabytes_datos Tamaño total estimado en megabytes\n   485→     * @return array Evaluación completa con categoría, complejidad, prioridad y observaciones\n   486→     * @author Sergio Vargas\n   487→     */\n   488→    private function evaluarTamanoEmpresa(int $total_registros_empresa, int $total_usuarios_activos, float $total_megabytes_datos): array {\n   489→        // Definir categorías de tamaño basadas en datos reales\n   490→        if ($total_registros_empresa <= 5000 && $total_usuarios_activos <= 50 && $total_megabytes_datos <= 100) {\n   491→            $categoria_empresa     = 'pequeña';\n   492→            $complejidad_migracion = 'baja';\n   493→            $prioridad_proceso     = 'alta';\n   494→        } elseif ($total_registros_empresa <= 50000 && $total_usuarios_activos <= 200 && $total_megabytes_datos <= 1000) {\n   495→            $categoria_empresa     = 'mediana';\n   496→            $complejidad_migracion = 'media';\n   497→            $prioridad_proceso     = 'media';\n   498→        } elseif ($total_registros_empresa <= 500000 && $total_usuarios_activos <= 1000 && $total_megabytes_datos <= 5000) {\n   499→            $categoria_empresa     = 'grande';\n   500→            $complejidad_migracion = 'alta';\n   501→            $prioridad_proceso     = 'baja';\n   502→        } else {\n   503→            $categoria_empresa     = 'muy_grande';\n   504→            $complejidad_migracion = 'muy_alta';\n   505→            $prioridad_proceso     = 'muy_baja';\n   506→        }\n   507→\n   508→        // Determinar si es candidata para migración automática\n   509→        $candidata_automatica = $total_registros_empresa <= 200000 && $total_usuarios_activos <= 100 && $total_megabytes_datos <= 500;\n   510→\n   511→        return [\n   512→            'categoria'            => $categoria_empresa,\n   513→            'complejidad'          => $complejidad_migracion,\n   514→            'prioridad'            => $prioridad_proceso,\n   515→            'candidata_automatica' => $candidata_automatica,\n   516→            'requiere_revision'    => !$candidata_automatica,\n   517→            'observaciones'        => $this->generarObservacionesEvaluacion($categoria_empresa, $total_registros_empresa, $total_usuarios_activos, $total_megabytes_datos)\n   518→        ];\n   519→    }\n   520→\n   521→    /**\n   522→     * Genera observaciones para la evaluación de migración\n   523→     *\n   524→     * Crea recomendaciones específicas basadas en la categoría de la empresa\n   525→     * y sus métricas de tamaño. Las observaciones incluyen:\n   526→     * - Tipo de migración recomendada\n   527→     * - Tiempo de mantenimiento estimado\n   528→     * - Necesidades especiales de coordinación\n   529→     * - Alertas por volumen de datos o usuarios\n   530→     * - Requerimientos técnicos especiales\n   531→     *\n   532→     * @param string $categoria_empresa Categoría de tamaño de la empresa\n   533→     * @param int $total_registros_empresa Número total de registros\n   534→     * @param int $total_usuarios_activos Número total de usuarios activos\n   535→     * @param float $total_megabytes_datos Tamaño total en megabytes\n   536→     * @return string Observaciones detalladas concatenadas como texto legible\n   537→     * @author Sergio Vargas\n   538→     */\n   539→    private function generarObservacionesEvaluacion(string $categoria_empresa, int $total_registros_empresa, int $total_usuarios_activos, float $total_megabytes_datos): string {\n   540→        $observaciones = [];\n   541→\n   542→        switch ($categoria_empresa) {\n   543→            case 'pequeña':\n   544→                $observaciones[] = 'Empresa ideal para migración automática';\n   545→                $observaciones[] = 'Tiempo de mantenimiento mínimo requerido';\n   546→                break;\n   547→\n   548→            case 'mediana':\n   549→                $observaciones[] = 'Empresa candidata para migración programada';\n   550→                $observaciones[] = 'Requiere ventana de mantenimiento planificada';\n   551→                break;\n   552→\n   553→            case 'grande':\n   554→                $observaciones[] = 'Empresa requiere migración especializada';\n   555→                $observaciones[] = 'Necesita coordinación previa con el cliente';\n   556→                break;\n   557→\n   558→            case 'muy_grande':\n   559→                $observaciones[] = 'Empresa requiere migración por etapas';\n   560→                $observaciones[] = 'Necesita análisis detallado antes de proceder';\n   561→                break;\n   562→        }\n   563→\n   564→        if ($total_usuarios_activos > 100) {\n   565→            $observaciones[] = 'Alto número de usuarios requiere notificación previa';\n   566→        }\n   567→\n   568→        if ($total_megabytes_datos > 1000) {\n   569→            $observaciones[] = 'Volumen de datos (' . number_format($total_megabytes_datos, 2) . ' MB) requiere backup completo';\n   570→        }\n   571→\n   572→        if ($total_registros_empresa > 100000) {\n   573→            $observaciones[] = 'Gran cantidad de registros (' . number_format($total_registros_empresa) . ') requiere migración por lotes';\n   574→        }\n   575→\n   576→        return implode('. ', $observaciones);\n   577→    }\n   578→\n   579→    /**\n   580→     * Inactiva una empresa en la base de datos legacy estableciendo en_mantenimiento = 1\n   581→     *\n   582→     * Marca la empresa como en mantenimiento en la base de datos legacy para\n   583→     * prevenir acceso de usuarios durante el proceso de migración. Esta operación:\n   584→     * - Actualiza el campo 'en_mantenimiento' a 1\n   585→     * - Registra logs detallados de la operación\n   586→     * - Verifica que la actualización fue exitosa\n   587→     * - Maneja errores de conexión y transacciones\n   588→     *\n   589→     * @param int $empresa_legacy_id ID de la empresa en la base de datos legacy\n   590→     * @throws Exception Si hay errores en la conexión a la base de datos legacy\n   591→     * @return bool true si la empresa fue marcada exitosamente, false en caso contrario\n   592→     * @author Sergio Vargas\n   593→     */\n   594→    public function inactivarEmpresaEnBaseDatosVieja(int $empresa_legacy_id): bool {\n   595→        try {\n   596→            $conexion_legacy = DB::connection('old_db');\n   597→\n   598→            // Primero verificar el estado actual de la empresa\n   599→            $empresa_actual = $conexion_legacy->selectOne(\"\n   600→                SELECT en_mantenimiento \n   601→                FROM empresa \n   602→                WHERE id_empresa = ?\n   603→            \", [$empresa_legacy_id]);\n   604→\n   605→            if (!$empresa_actual) {\n   606→                Log::warning(\"No se encontró la empresa {$empresa_legacy_id} en la base de datos legacy\");\n   607→                return false;\n   608→            }\n   609→\n   610→            // Si ya está en mantenimiento, considerar como éxito\n   611→            if ($empresa_actual->en_mantenimiento == 1) {\n   612→                Log::info(\"Empresa {$empresa_legacy_id} ya estaba marcada en mantenimiento en base de datos legacy\");\n   613→                return true;\n   614→            }\n   615→\n   616→            // Actualizar a mantenimiento\n   617→            $resultado_actualizacion = $conexion_legacy->update(\"\n   618→                UPDATE empresa \n   619→                SET en_mantenimiento = 1 \n   620→                WHERE id_empresa = ?\n   621→            \", [$empresa_legacy_id]);\n   622→\n   623→            if ($resultado_actualizacion > 0) {\n   624→                Log::info(\"Empresa {$empresa_legacy_id} marcada en mantenimiento en base de datos legacy\");\n   625→                return true;\n   626→            } else {\n   627→                Log::warning(\"No se pudo actualizar el estado de mantenimiento para empresa {$empresa_legacy_id}\");\n   628→                return false;\n   629→            }\n   630→        } catch (Exception $e) {\n   631→            Log::error(\"Error al inactivar empresa {$empresa_legacy_id} en base de datos legacy: \" . $e->getMessage());\n   632→            Log::error(\"Stack trace: \" . $e->getTraceAsString());\n   633→            return false;\n   634→        }\n   635→    }\n   636→\n   637→    /**\n   638→     * Reactiva una empresa en la base de datos legacy estableciendo en_mantenimiento = 0\n   639→     *\n   640→     * Quita el estado de mantenimiento de la empresa en la base de datos legacy.\n   641→     * Se ejecuta en dos escenarios principales:\n   642→     * - Rollback: cuando la migración falla y se necesita restaurar acceso inmediatamente\n   643→     * - Finalización: cuando la migración es exitosa y se confirma funcionamiento correcto\n   644→     *\n   645→     * Esta operación es crítica para la continuidad del servicio.\n   646→     *\n   647→     * @param int $empresa_legacy_id ID de la empresa en la base de datos legacy\n   648→     * @throws Exception Si hay errores en la conexión a la base de datos legacy\n   649→     * @return bool true si la empresa fue reactivada exitosamente, false en caso contrario\n   650→     * @author Sergio Vargas\n   651→     */\n   652→    public function reactivarEmpresaEnBaseDatosVieja(int $empresa_legacy_id): bool {\n   653→        try {\n   654→            $conexion_legacy = DB::connection('old_db');\n   655→\n   656→            $resultado_actualizacion = $conexion_legacy->update(\"\n   657→                UPDATE empresa \n   658→                SET en_mantenimiento = 0 \n   659→                WHERE id_empresa = ?\n   660→            \", [$empresa_legacy_id]);\n   661→\n   662→            if ($resultado_actualizacion > 0) {\n   663→                Log::info(\"Empresa {$empresa_legacy_id} reactivada en base de datos legacy\");\n   664→                return true;\n   665→            } else {\n   666→                Log::warning(\"No se encontró la empresa {$empresa_legacy_id} en la base de datos legacy\");\n   667→                return false;\n   668→            }\n   669→        } catch (Exception $e) {\n   670→            Log::error(\"Error al reactivar empresa {$empresa_legacy_id} en base de datos legacy: \" . $e->getMessage());\n   671→            Log::error(\"Stack trace: \" . $e->getTraceAsString());\n   672→            return false;\n   673→        }\n   674→    }\n   675→\n   676→    /**\n   677→     * Verifica si ya existe una migración activa para la empresa\n   678→     *\n   679→     * Busca en la base de datos si existe una migración previa para la empresa\n   680→     * que esté en estados activos (pendiente, en progreso o completada).\n   681→     * Incluye información del usuario que realizó la migración para auditoría.\n   682→     * Esta consulta es fundamental para prevenir migraciones duplicadas.\n   683→     *\n   684→     * @param int $empresa_legacy_id ID de la empresa en la base de datos legacy a verificar\n   685→     * @return MigracionEmpresa|null Migración existente con datos del usuario o null si no existe\n   686→     * @author Sergio Vargas\n   687→     */\n   688→    public function verificarMigracionExistente(int $empresa_legacy_id): ?MigracionEmpresa {\n   689→        return MigracionEmpresa::where('empresa_id_old', $empresa_legacy_id)\n   690→            ->whereIn('estado', [\n   691→                MigracionEmpresa::ESTADO_PENDIENTE,\n   692→                MigracionEmpresa::ESTADO_EN_PROGRESO,\n   693→                MigracionEmpresa::ESTADO_COMPLETADA\n   694→            ])\n   695→            ->with('usuario')\n   696→            ->first();\n   697→    }\n   698→\n   699→    /**\n   700→     * Retornar la migración de una empresa que está en proceso según su id en la base de datos antigua.\n   701→     *\n   702→     * @param int $empresa_antigua_id Id de la empresa en la base de datos antigua.\n   703→     * @param string $estado Estado de la migración.\n   704→     * @return MigracionEmpresa|null\n   705→     * @author Fahibram Cárcamo\n   706→     */\n   707→    public function getPorEmpresaAntiguaEstado(int $empresa_antigua_id, string $estado): MigracionEmpresa|null {\n   708→        return $this->modelo::select('id', 'empresa_id_old', 'empresa_id_new', 'ventana_inicio', 'ventana_fin', 'estado', 'observaciones', 'datos_migracion', 'errores', 'fecha_inicio_real', 'fecha_fin_real', 'migrado_por', 'created_at', 'updated_at')\n   709→            ->where('empresa_id_old', $empresa_antigua_id)\n   710→            ->where('estado', $estado)\n   711→            ->first();\n   712→    }\n   713→\n   714→    /**\n   715→     * Obtener todas las migraciones con información de empresa y usuario\n   716→     *\n   717→     * Retorna una lista paginada de migraciones con sus relaciones cargadas\n   718→     * para mostrar en interfaces de administración.\n   719→     *\n   720→     * @param array $filtros Filtros opcionales (estado, fecha, etc.)\n   721→     * @return Collection\n   722→     * @author Sergio Vargas\n   723→     */\n   724→    public function obtenerMigracionesConDetalles(array $filtros = []): Collection {\n   725→        $query = $this->modelo::select('id', 'empresa_id_old', 'empresa_id_new', 'ventana_inicio', 'ventana_fin', 'estado', 'observaciones', 'fecha_inicio_real', 'fecha_fin_real', 'migrado_por', 'created_at', 'updated_at')\n   726→            ->with(['usuario:id,nombres,apellidos,email', 'empresa:id,razon_social,documento']);\n   727→\n   728→        if (!empty($filtros['estado'])) {\n   729→            $query->where('estado', $filtros['estado']);\n   730→        }\n   731→\n   732→        if (!empty($filtros['fecha_desde'])) {\n   733→            $query->where('created_at', '>=', $filtros['fecha_desde']);\n   734→        }\n   735→\n   736→        if (!empty($filtros['fecha_hasta'])) {\n   737→            $query->where('created_at', '<=', $filtros['fecha_hasta']);\n   738→        }\n   739→\n   740→        return $query->orderBy('created_at', 'desc')->get();\n   741→    }\n   742→\n   743→    /**\n   744→     * Verificar si una empresa puede ser migrada nuevamente\n   745→     *\n   746→     * Evalúa si una empresa puede ser sujeta a un nuevo proceso de migración\n   747→     * basándose en el estado de migraciones previas.\n   748→     *\n   749→     * @param int $empresa_legacy_id ID de la empresa en la base de datos legacy\n   750→     * @return bool True si puede ser migrada, false si no\n   751→     * @author Sergio Vargas\n   752→     */\n   753→    public function puedeSerMigradaNuevamente(int $empresa_legacy_id): bool {\n   754→        $migracion_exitosa = $this->modelo::where('empresa_id_old', $empresa_legacy_id)\n   755→            ->where('estado', MigracionEmpresa::ESTADO_COMPLETADA)\n   756→            ->exists();\n   757→\n   758→        $migracion_activa = $this->modelo::where('empresa_id_old', $empresa_legacy_id)\n   759→            ->whereIn('estado', [\n   760→                MigracionEmpresa::ESTADO_PENDIENTE,\n   761→                MigracionEmpresa::ESTADO_EN_PROGRESO\n   762→            ])\n   763→            ->exists();\n   764→\n   765→        return !$migracion_exitosa && !$migracion_activa;\n   766→    }\n   767→    \n   768→    /**\n   769→     * Obtiene la lista de usuarios que serán migrados para una empresa\n   770→     *\n   771→     * Consulta la base de datos legacy para obtener información detallada de todos\n   772→     * los usuarios que cumplen los criterios de migración (estado activo y roles válidos).\n   773→     * Esta información se usa para mostrar al usuario exactamente quiénes serán migrados.\n   774→     *\n   775→     * @param int $empresa_legacy_id ID de la empresa en la base de datos legacy\n   776→     * @return array Lista de usuarios con información básica para mostrar en la interfaz\n   777→     * @author Sergio Vargas\n   778→     */\n   779→    public function obtenerUsuariosParaMigracion(int $empresa_legacy_id): array {\n   780→        try {\n   781→            Log::info('Obteniendo lista de usuarios para migración', ['empresa_id' => $empresa_legacy_id]);\n   782→            \n   783→            // Usar la misma consulta que usa el Job para garantizar consistencia\n   784→            $usuarios = DB::connection('old_db')->select(\"\n   785→                SELECT \n   786→                    usuario.id_usuario,\n   787→                    usuario.id_rol_usuario,\n   788→                    usuario.id_estado,\n   789→                    informacion_general.documento,\n   790→                    informacion_general.primer_nombre,\n   791→                    informacion_general.segundo_nombre,\n   792→                    informacion_general.primer_apellido,\n   793→                    informacion_general.segundo_apellido,\n   794→                    informacion_general.email,\n   795→                    usuario.username\n   796→                FROM usuario \n   797→                JOIN informacion_general ON usuario.id_informacion_general = informacion_general.id_informacion_general\n   798→                WHERE usuario.id_empresa = ? \n   799→                  AND usuario.id_rol_usuario IN (2, 3, 5)\n   800→                  AND usuario.id_estado = 1\n   801→                ORDER BY informacion_general.primer_nombre, informacion_general.primer_apellido\n   802→            \", [$empresa_legacy_id]);\n   803→            \n   804→            // Formatear datos para la interfaz\n   805→            $usuarios_formateados = array_map(function($usuario) {\n   806→                $nombres = trim(($usuario->primer_nombre ?? '') . ' ' . ($usuario->segundo_nombre ?? ''));\n   807→                $apellidos = trim(($usuario->primer_apellido ?? '') . ' ' . ($usuario->segundo_apellido ?? ''));\n   808→                \n   809→                // Mapear roles para mostrar texto legible\n   810→                $rol_texto = match($usuario->id_rol_usuario) {\n   811→                    2 => 'Administrador General',\n   812→                    3 => 'Administrador Sucursal', \n   813→                    5 => 'Evaluador',\n   814→                    default => 'Desconocido'\n   815→                };\n   816→                \n   817→                return [\n   818→                    'id' => $usuario->id_usuario,\n   819→                    'documento' => $usuario->documento,\n   820→                    'nombres' => $nombres,\n   821→                    'apellidos' => $apellidos,\n   822→                    'nombre_completo' => trim($nombres . ' ' . $apellidos),\n   823→                    'email' => $usuario->email,\n   824→                    'username' => $usuario->username,\n   825→                    'rol_id' => $usuario->id_rol_usuario,\n   826→                    'rol_texto' => $rol_texto,\n   827→                    'estado' => $usuario->id_estado\n   828→                ];\n   829→            }, $usuarios);\n   830→            \n   831→            Log::info('Lista de usuarios obtenida', [\n   832→                'empresa_id' => $empresa_legacy_id,\n   833→                'total_usuarios' => count($usuarios_formateados)\n   834→            ]);\n   835→            \n   836→            return $usuarios_formateados;\n   837→            \n   838→        } catch (Exception $e) {\n   839→            Log::error('Error al obtener usuarios para migración', [\n   840→                'empresa_id' => $empresa_legacy_id,\n   841→                'error' => $e->getMessage()\n   842→            ]);\n   843→            return [];\n   844→        }\n   845→    }\n   846→}\n   847→"}]},"uuid":"2721adab-9fd5-473f-a2d5-a8f43d14bcfe","timestamp":"2026-02-16T21:30:08.100Z","sourceToolAssistantUUID":"5d480ab9-e46f-4bb6-9e8b-ec8de37602e9"}
{"parentUuid":"2721adab-9fd5-473f-a2d5-a8f43d14bcfe","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FLwNp7UJKN3E2jLmfUEdTu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QUN4yhTm6exH9vAZQVzpFj","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Jobs\\Migraciones\\MigrarEmpresasSucursalesUsuariosJob.php"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1150,"cache_read_input_tokens":15211,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1150},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTe9PTjvk2EwMEBTD4s","type":"assistant","uuid":"4b268f0c-ed35-4f86-b890-49dded455d93","timestamp":"2026-02-16T21:30:08.315Z"}
{"parentUuid":"4b268f0c-ed35-4f86-b890-49dded455d93","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01QUN4yhTm6exH9vAZQVzpFj","toolUseID":"toolu_01QUN4yhTm6exH9vAZQVzpFj","timestamp":"2026-02-16T21:30:08.612Z","uuid":"7b3babd3-a08a-4a37-87cd-4afee4fa8d69"}
{"parentUuid":"4b268f0c-ed35-4f86-b890-49dded455d93","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QUN4yhTm6exH9vAZQVzpFj","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Jobs\\Migraciones;\n     4→\n     5→use Exception;\n     6→use Illuminate\\Support\\Str;\n     7→use Illuminate\\Http\\Request;\n     8→use App\\Models\\Empresas\\Empresa;\n     9→use Illuminate\\Support\\Facades\\DB;\n    10→use Illuminate\\Support\\Facades\\Log;\n    11→use Illuminate\\Support\\Facades\\Hash;\n    12→use Illuminate\\Support\\Facades\\Http;\n    13→use App\\Models\\Configuraciones\\Archivo;\n    14→use App\\Models\\Empresas\\EmpresaUsuario;\n    15→use App\\Models\\Usuarios\\User as Usuario;\n    16→use App\\Models\\Empresas\\MigracionEmpresa;\n    17→use Spatie\\Permission\\Models\\Role as Rol;\n    18→use Illuminate\\Foundation\\Queue\\Queueable;\n    19→use Illuminate\\Contracts\\Queue\\ShouldQueue;\n    20→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    23→use App\\Http\\Services\\Configuraciones\\ArchivoService;\n    24→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n    26→use App\\Http\\Repositories\\Empresas\\MigracionEmpresaRepository;\n    27→use App\\Jobs\\Configuraciones\\CrearPlantillasPorDefectoEmpresaJob;\n    28→\n    29→class MigrarEmpresasSucursalesUsuariosJob implements ShouldQueue\n    30→{\n    31→    use Queueable;\n    32→\n    33→    private $migracion_empresa_repositorio;\n    34→\n    35→    private $empresa_usuario_repositorio;\n    36→\n    37→    private $migracion_empresa_id;\n    38→\n    39→    private $empresa_repositorio;\n    40→\n    41→    private $usuario_repositorio;\n    42→\n    43→    private $rol_repositorio;\n    44→\n    45→    private ArchivoService $archivo_servicio;\n    46→\n    47→    private ArchivoRepository $archivo_repositorio;\n    48→\n    49→    private static array $primeros_admin_general_por_empresa = [];\n    50→\n    51→    /**\n    52→     * Constructor.\n    53→     *\n    54→     * @param int $empresa_antigua_id Id de la empresa en la base de datos antigua.\n    55→     * @author Fahibram Cárcamo\n    56→     */\n    57→    public function __construct(protected int $empresa_antigua_id) {\n    58→        $this->migracion_empresa_repositorio = new MigracionEmpresaRepository(new MigracionEmpresa());\n    59→        $this->empresa_usuario_repositorio   = new EmpresaUsuarioRepository(new EmpresaUsuario());\n    60→        $this->empresa_repositorio           = new EmpresaRepository(new Empresa());\n    61→        $this->usuario_repositorio           = new UserRepository(new Usuario());\n    62→        $this->rol_repositorio               = new RolRepository(new Rol());\n    63→\n    64→        // Servicios para gestionar archivos (logos)\n    65→        $this->archivo_repositorio = new ArchivoRepository(new Archivo());\n    66→        $this->archivo_servicio    = new ArchivoService($this->archivo_repositorio);\n    67→\n    68→        $migracion_empresa = $this->migracion_empresa_repositorio\n    69→            ->getPorEmpresaAntiguaEstado($empresa_antigua_id, MigracionEmpresa::ESTADO_PENDIENTE);\n    70→\n    71→        $this->migracion_empresa_id = $migracion_empresa->id ?? null;\n    72→    }\n    73→\n    74→    /**\n    75→     * Ejecutar el job de migración de empresa, sus sucursales y usuarios.\n    76→     *\n    77→     * Cambia el estado de la migración, migra la empresa principal, migra\n    78→     * sus sucursales y al finalizar deja registro del resultado. En caso\n    79→     * de error, revierte la transacción y registra detalles del fallo.\n    80→     *\n    81→     * @return void\n    82→     * @author Fahibram Cárcamo\n    83→     */\n    84→    public function handle(): void {\n    85→        try {\n    86→            if (is_null($this->migracion_empresa_id)) {\n    87→                return;\n    88→            }\n    89→\n    90→            DB::beginTransaction();\n    91→\n    92→            // Cambia el estado de la migración de la empresa a \"en progreso\".\n    93→            $this->migracion_empresa_repositorio->actualizar($this->migracion_empresa_id, [\n    94→                'fecha_inicio_real' => now(),\n    95→                'estado'            => MigracionEmpresa::ESTADO_EN_PROGRESO\n    96→            ]);\n    97→\n    98→            $empresa_antigua = DB::connection('old_db')\n    99→                ->table('empresa')\n   100→                ->where('id_empresa', $this->empresa_antigua_id)\n   101→                ->first();\n   102→\n   103→            // Si la empresa no existe en la base de datos antígua se lanza la exceción.\n   104→            if (is_null($empresa_antigua)) {\n   105→                $mensaje_error = \"La empresa con id {$this->empresa_antigua_id} no se encuentra en la base de datos antigua.\";\n   106→                Log::error($mensaje_error);\n   107→                throw new Exception($mensaje_error);\n   108→            }\n   109→            \n   110→            Log::info('Empresa antigua encontrada', [\n   111→                'empresa_id' => $empresa_antigua->id_empresa,\n   112→                'identificacion' => $empresa_antigua->identificacion,\n   113→                'razon_social' => $empresa_antigua->razon_social\n   114→            ]);\n   115→\n   116→            $nueva_empresa = $this->migrarEmpresa($empresa_antigua);\n   117→\n   118→            $this->migrarSucursales($empresa_antigua, $nueva_empresa);\n   119→\n   120→            DB::commit();\n   121→\n   122→            // Cambia el estado de la migración de la empresa a \"completada\".\n   123→            $this->migracion_empresa_repositorio->actualizar($this->migracion_empresa_id, [\n   124→                'fecha_fin_real' => now(),\n   125→                'estado'         => MigracionEmpresa::ESTADO_COMPLETADA,\n   126→                'empresa_id_new' => $nueva_empresa->id\n   127→            ]);\n   128→        } catch (Exception $excepcion) {\n   129→            DB::rollBack();\n   130→\n   131→            Log::error('Error durante la migración de empresa', [\n   132→                'empresa_antigua_id' => $this->empresa_antigua_id,\n   133→                'migracion_empresa_id' => $this->migracion_empresa_id,\n   134→                'mensaje' => $excepcion->getMessage(),\n   135→                'archivo' => $excepcion->getFile(),\n   136→                'linea' => $excepcion->getLine(),\n   137→                'trace' => $excepcion->getTraceAsString()\n   138→            ]);\n   139→\n   140→            // Cambia el estado de la migración de la empresa a \"error\".\n   141→            $this->migracion_empresa_repositorio->actualizar($this->migracion_empresa_id, [\n   142→                'fecha_fin_real' => now(),\n   143→                'estado'         => MigracionEmpresa::ESTADO_ERROR,\n   144→                'errores'        => [\n   145→                    'mensaje' => $excepcion->getMessage(),\n   146→                    'archivo' => $excepcion->getFile(),\n   147→                    'linea'   => $excepcion->getLine(),\n   148→                    'fecha'   => now()->toDateTimeString()\n   149→                ]\n   150→            ]);\n   151→        }\n   152→    }\n   153→\n   154→    /**\n   155→     * Migrar una empresa principal desde la base de datos antigua hacia la nueva base de datos.\n   156→     *\n   157→     * Si ya existe una empresa en la nueva base de datos con el mismo número de documento de la\n   158→     * empresa de la base de datos se retorna la empresa existente, si no es así, retorna la nueva\n   159→     * empresa creada.\n   160→     *\n   161→     * @param object $empresa_antigua Objeto de la empresa antigua.\n   162→     * @throws Exception Cuando ocurre algún error en la migración.\n   163→     * @return Empresa|null Empresa migrada o null si ya existe.\n   164→     * @author Fahibram Cárcamo\n   165→     */\n   166→    private function migrarEmpresa(object $empresa_antigua): Empresa|null {\n   167→        $empresa_existente = DB::connection('mysql')\n   168→            ->table('empresas')\n   169→            ->where('documento', $empresa_antigua->identificacion)\n   170→            ->first();\n   171→\n   172→        if (!is_null($empresa_existente)) {\n   173→            $empresa = $this->empresa_repositorio->getUno($empresa_existente->id);\n   174→            // Asegurar logo (importar de plataforma vieja o generar temporal)\n   175→            $this->asegurarLogoEmpresa($empresa, (int) $empresa_antigua->id_empresa);\n   176→            return $empresa;\n   177→        }\n   178→\n   179→        $datos_empresa_antigua = $this->mapearCamposEmpresaAntigua($empresa_antigua);\n   180→        $nueva_empresa         = $this->empresa_repositorio->crearSiNoExiste($datos_empresa_antigua);\n   181→\n   182→        // Asegurar logo (importar de plataforma vieja o generar temporal)\n   183→        $this->asegurarLogoEmpresa($nueva_empresa, (int) $empresa_antigua->id_empresa);\n   184→\n   185→        // Crear plantillas por defecto para la nueva empresa\n   186→        CrearPlantillasPorDefectoEmpresaJob::dispatch($nueva_empresa->id);\n   187→\n   188→        $this->migrarUsuariosEmpresa($empresa_antigua, $nueva_empresa);\n   189→\n   190→        // Solo migrar ejecutivo si existe y está activo (id_estado = 1)\n   191→        $nuevo_usuario_ejecutivo_empresa = !is_null($empresa_antigua->ejecutivo_id)\n   192→            ? $this->migrarEjecutivoEmpresa($empresa_antigua->ejecutivo_id, $nueva_empresa)\n   193→            : null;\n   194→\n   195→        if (!is_null($nuevo_usuario_ejecutivo_empresa)) {\n   196→            $this->empresa_repositorio->actualizar($nueva_empresa->id, ['ejecutivo_id' => $nuevo_usuario_ejecutivo_empresa->id]);\n   197→            $nueva_empresa->refresh();\n   198→        }\n   199→\n   200→        // Asignar usuario comercial (ID 3) a todas las empresas nuevas\n   201→        $this->asignarUsuarioComercial($nueva_empresa);\n   202→\n   203→        return $nueva_empresa;\n   204→    }\n   205→\n   206→    /**\n   207→     * Migrar las sucursales (empresas hijas) de una empresa padre desde la base de datos antigua\n   208→     * hacia la nueva base de datos.\n   209→     *\n   210→     * @param object $empresa_padre_antigua Empresa padre de la base de datos antigua.\n   211→     * @param object $nueva_empresa Empresa padre de la nueva base de datos.\n   212→     * @throws Exception Cuando ocurre algún error en la migración.\n   213→     * @return void\n   214→     * @author Fahibram Cárcamo\n   215→     */\n   216→    private function migrarSucursales(object $empresa_padre_antigua, object $nueva_empresa): void {\n   217→        $sucursales_empresa_antigua = DB::connection('old_db')\n   218→            ->table('empresa')\n   219→            ->where('id_empresa_padre', $empresa_padre_antigua->id_empresa)\n   220→            ->get();\n   221→\n   222→        foreach ($sucursales_empresa_antigua as $sucursal_empresa_antigua) {\n   223→            $sucursal_existente = $this->empresa_repositorio->getUnoAvanzado(new Request(['documento' => $sucursal_empresa_antigua->identificacion]));\n   224→\n   225→            if (!is_null($sucursal_existente)) {\n   226→                $nueva_sucursal = $sucursal_existente; // Usar la sucursal existente\n   227→                // Asegurar logo (importar de plataforma vieja o generar temporal)\n   228→                $this->asegurarLogoEmpresa($nueva_sucursal, (int) $sucursal_empresa_antigua->id_empresa);\n   229→            } else {\n   230→                // Crear nueva sucursal\n   231→                DB::connection('old_db')\n   232→                    ->table('empresa')\n   233→                    ->where(\"id_empresa\", $sucursal_empresa_antigua->id_empresa)\n   234→                    ->update(['en_mantenimiento' => 1]);\n   235→\n   236→                $datos_sucursal_empresa_antigua               = $this->mapearCamposEmpresaAntigua($sucursal_empresa_antigua);\n   237→                $datos_sucursal_empresa_antigua['empresa_id'] = $nueva_empresa->id;\n   238→                $nueva_sucursal                               = $this->empresa_repositorio->crearSiNoExiste($datos_sucursal_empresa_antigua);\n   239→\n   240→                // Asegurar logo (importar de plataforma vieja o generar temporal)\n   241→                $this->asegurarLogoEmpresa($nueva_sucursal, (int) $sucursal_empresa_antigua->id_empresa);\n   242→\n   243→                // Crear plantillas por defecto para la nueva sucursal\n   244→                CrearPlantillasPorDefectoEmpresaJob::dispatch($nueva_sucursal->id);\n   245→            }\n   246→\n   247→            $this->migrarUsuariosEmpresa($sucursal_empresa_antigua, $nueva_sucursal);\n   248→\n   249→            // Solo migrar ejecutivo si existe y está activo (id_estado = 1)\n   250→            $nuevo_usuario_ejecutivo_sucursal = !is_null($sucursal_empresa_antigua->ejecutivo_id)\n   251→                ? $this->migrarEjecutivoEmpresa($sucursal_empresa_antigua->ejecutivo_id, $nueva_sucursal)\n   252→                : null;\n   253→\n   254→            if (!is_null($nuevo_usuario_ejecutivo_sucursal)) {\n   255→                $this->empresa_repositorio->actualizar($nueva_sucursal->id, ['ejecutivo_id' => $nuevo_usuario_ejecutivo_sucursal->id]);\n   256→                $nueva_sucursal->refresh();\n   257→            }\n   258→\n   259→            // Asignar usuario comercial (ID 3) a todas las sucursales también\n   260→            $this->asignarUsuarioComercial($nueva_sucursal);\n   261→        }\n   262→    }\n   263→\n   264→    /**\n   265→     * Migrar los usuarios relacionados con una empresa desde la base de datos antigua hacia la\n   266→     * nueva base de datos.\n   267→     *\n   268→     * @param object $empresa_antigua Empresa de la base de datos antigua.\n   269→     * @param object $nueva_empresa Empresa de la nueva base de datos.\n   270→     * @throws Exception Cuando ocurre algún error en la migración.\n   271→     * @return void\n   272→     * @author Fahibram Cárcamo\n   273→     * @author Sergio Vargas\n   274→     */\n   275→    private function migrarUsuariosEmpresa(object $empresa_antigua, object $nueva_empresa): void {\n   276→        Log::info('Iniciando migración de usuarios para empresa', [\n   277→            'empresa_antigua_id' => $empresa_antigua->id_empresa,\n   278→            'nueva_empresa_id' => $nueva_empresa->id,\n   279→            'empresa_documento' => $empresa_antigua->identificacion\n   280→        ]);\n   281→        $usuarios_antiguos = DB::connection('old_db')\n   282→            ->table('usuario')\n   283→            ->select(\n   284→                'usuario.id_usuario AS id_usuario',\n   285→                'usuario.id_rol_usuario AS id_rol_usuario',\n   286→                'usuario.id_empresa AS id_empresa_usuario',\n   287→                'usuario.id_informacion_general AS id_informacion_general_usuario',\n   288→                'usuario.remember_token AS remember_token_usuario',\n   289→                'usuario.id_estado AS id_estado',\n   290→                'usuario.universidades AS universidades_usuario',\n   291→                'usuario.username AS username_usuario',\n   292→                'usuario.password AS password_usuario',\n   293→                'usuario.codigo_autorizacion AS codigo_autorizacion_usuario',\n   294→                'usuario.vencimiento_codigo_autorizacion AS vencimiento_codigo_autorizacion_usuario',\n   295→                'usuario.api_token AS api_token_usuario',\n   296→                'usuario.session_id AS session_id_usuario',\n   297→                'usuario.updated_at AS updated_at_usuario',\n   298→                'usuario.created_at AS created_at_usuario',\n   299→                'usuario.auth_token AS auth_token_usuario',\n   300→                'usuario.date_token_expire AS date_token_expire_usuario',\n   301→                'usuario.ultima_fecha_login AS ultima_fecha_login_usuario',\n   302→                'usuario.log_actualizacion AS usuario_log_actualizacion',\n   303→                'usuario.antecedentes_disponibles AS antecedentes_disponibles_usuario',\n   304→                'informacion_general.id_informacion_general AS id_informacion_general',\n   305→                'informacion_general.id_ciudad AS id_ciudad_usuario',\n   306→                'informacion_general.id_tipo_documento AS id_tipo_documento_usuario',\n   307→                'informacion_general.documento AS documento_usuario',\n   308→                'informacion_general.primer_nombre AS primer_nombre_usuario',\n   309→                'informacion_general.segundo_nombre AS segundo_nombre_usuario',\n   310→                'informacion_general.primer_apellido AS primer_apellido_usuario',\n   311→                'informacion_general.segundo_apellido AS segundo_apellido_usuario',\n   312→                'informacion_general.email AS email_usuario',\n   313→                'informacion_general.genero AS genero_usuario',\n   314→                'informacion_general.fecha_nacimiento AS fecha_nacimiento_usuario',\n   315→                'informacion_general.created_at AS created_at',\n   316→                'informacion_general.updated_at AS updated_at',\n   317→                'informacion_general.auto_evaluacion AS auto_evaluacion_usuario',\n   318→                'informacion_general.log_actualizacion AS log_actualizacion_usuario'\n   319→            )\n   320→            ->join('informacion_general', 'usuario.id_informacion_general', '=', 'informacion_general.id_informacion_general')\n   321→            ->where('usuario.id_empresa', $empresa_antigua->id_empresa)\n   322→            ->whereIn('usuario.id_rol_usuario', [2, 3, 5])\n   323→            ->where('usuario.id_estado', 1)\n   324→            ->distinct()\n   325→            ->get();\n   326→\n   327→        // Log detallado de usuarios a migrar con toda su información\n   328→        $usuarios_detalle = $usuarios_antiguos->map(function($usuario) {\n   329→            return [\n   330→                'id_usuario' => $usuario->id_usuario,\n   331→                'documento' => $usuario->documento_usuario,\n   332→                'email' => $usuario->email_usuario,\n   333→                'nombres' => trim(($usuario->primer_nombre_usuario ?? '') . ' ' . ($usuario->segundo_nombre_usuario ?? '')),\n   334→                'apellidos' => trim(($usuario->primer_apellido_usuario ?? '') . ' ' . ($usuario->segundo_apellido_usuario ?? '')),\n   335→                'id_rol_usuario' => $usuario->id_rol_usuario,\n   336→                'id_estado' => $usuario->id_estado,\n   337→                'username' => $usuario->username_usuario\n   338→            ];\n   339→        })->toArray();\n   340→        \n   341→        Log::info('Lista completa de usuarios encontrados para migrar', [\n   342→            'empresa_antigua_id' => $empresa_antigua->id_empresa,\n   343→            'total_usuarios' => $usuarios_antiguos->count(),\n   344→            'usuarios_detalle' => $usuarios_detalle\n   345→        ]);\n   346→\n   347→        foreach ($usuarios_antiguos as $usuario_antiguo) {\n   348→            try {\n   349→                Log::info('Procesando usuario individual', [\n   350→                    'usuario_id' => $usuario_antiguo->id_usuario,\n   351→                    'documento' => $usuario_antiguo->documento_usuario,\n   352→                    'email' => $usuario_antiguo->email_usuario,\n   353→                    'rol_antiguo' => $usuario_antiguo->id_rol_usuario,\n   354→                    'estado' => $usuario_antiguo->id_estado\n   355→                ]);\n   356→            // Verificar si el usuario existe por documento\n   357→            $usuario_existente = DB::connection('mysql')\n   358→                ->table('users')\n   359→                ->where('documento', $usuario_antiguo->documento_usuario)\n   360→                ->first();\n   361→                \n   362→            // Si no se encuentra por documento, buscar por email\n   363→            if (is_null($usuario_existente)) {\n   364→                $usuario_existente = DB::connection('mysql')\n   365→                    ->table('users')\n   366→                    ->where('email', $usuario_antiguo->email_usuario)\n   367→                    ->first();\n   368→            }\n   369→                \n   370→            Log::info('Resultado de búsqueda de usuario existente', [\n   371→                'documento_buscado' => $usuario_antiguo->documento_usuario,\n   372→                'email_buscado' => $usuario_antiguo->email_usuario,\n   373→                'usuario_encontrado' => !is_null($usuario_existente),\n   374→                'usuario_encontrado_id' => $usuario_existente->id ?? null,\n   375→                'usuario_encontrado_documento' => $usuario_existente->documento ?? null,\n   376→                'usuario_encontrado_email' => $usuario_existente->email ?? null\n   377→            ]);\n   378→\n   379→            $token_migracion = Str::random(30);\n   380→            $nuevo_usuario   = null;\n   381→\n   382→            if (is_null($usuario_existente)) {\n   383→                try {\n   384→                    Log::info('Creando nuevo usuario', ['documento' => $usuario_antiguo->documento_usuario]);\n   385→                    \n   386→                    $datos_usuario_antiguo = $this->mapearCamposUsuario($usuario_antiguo, $token_migracion);\n   387→                    $nuevo_usuario         = $this->usuario_repositorio->crear($datos_usuario_antiguo);\n   388→                    \n   389→                    Log::info('Usuario creado exitosamente', [\n   390→                        'nuevo_usuario_id' => $nuevo_usuario->id,\n   391→                        'documento' => $usuario_antiguo->documento_usuario\n   392→                    ]);\n   393→\n   394→                    $rol_mapeado = $this->mapearRolConPropietario($usuario_antiguo, $nueva_empresa->id);\n   395→\n   396→                    $this->empresa_usuario_repositorio->crearSiNoExiste([\n   397→                        'usuario_id' => $nuevo_usuario->id,\n   398→                        'empresa_id' => $nueva_empresa->id,\n   399→                        'rol_id'     => $rol_mapeado\n   400→                    ]);\n   401→\n   402→                    if (!is_null($rol_mapeado)) {\n   403→                        // Activar rol solo para usuarios administrativos (no evaluados)\n   404→                        $activar_rol = in_array($rol_mapeado, [\n   405→                            RolRepository::ROL_PROPIETARIO_ID,            // 4\n   406→                            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,  // 6\n   407→                            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID  // 7\n   408→                        ]);\n   409→                        $this->rol_repositorio->asignarRolUsuarioSiNoExiste($nuevo_usuario->id, $rol_mapeado, $activar_rol);\n   410→                    }\n   411→                } catch (\\Illuminate\\Database\\QueryException $e) {\n   412→                    // Si es error de duplicado por email, buscar el usuario existente\n   413→                    if ($e->getCode() === '23000' && str_contains($e->getMessage(), 'users_email_unique')) {\n   414→                        Log::info('Usuario ya existe (detectado durante creación)', [\n   415→                            'email' => $usuario_antiguo->email_usuario,\n   416→                            'documento' => $usuario_antiguo->documento_usuario\n   417→                        ]);\n   418→                        \n   419→                        // Buscar el usuario existente por email\n   420→                        $usuario_existente = DB::connection('mysql')\n   421→                            ->table('users')\n   422→                            ->where('email', $usuario_antiguo->email_usuario)\n   423→                            ->first();\n   424→                            \n   425→                        if (!is_null($usuario_existente)) {\n   426→                            $nuevo_usuario = $this->usuario_repositorio->getUno($usuario_existente->id);\n   427→                            \n   428→                            // Agregar a la tabla empresas_usuarios\n   429→                            $rol_mapeado = $this->mapearRolConPropietario($usuario_antiguo, $nueva_empresa->id);\n   430→                            \n   431→                            $this->empresa_usuario_repositorio->crearSiNoExiste([\n   432→                                'usuario_id' => $usuario_existente->id,\n   433→                                'empresa_id' => $nueva_empresa->id,\n   434→                                'rol_id'     => $rol_mapeado\n   435→                            ]);\n   436→\n   437→                            if (!is_null($rol_mapeado)) {\n   438→                                // Activar rol solo para usuarios administrativos\n   439→                                $activar_rol = in_array($rol_mapeado, [\n   440→                                    RolRepository::ROL_PROPIETARIO_ID,            // 4\n   441→                                    RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,  // 6\n   442→                                    RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID  // 7\n   443→                                ]);\n   444→                                $this->rol_repositorio->asignarRolUsuarioSiNoExiste($usuario_existente->id, $rol_mapeado, $activar_rol);\n   445→                            }\n   446→\n   447→                            // Actualizar token de plataforma vieja si no lo tiene\n   448→                            if (empty($usuario_existente->token_plataforma_vieja)) {\n   449→                                $this->usuario_repositorio->actualizar($usuario_existente->id, [\n   450→                                    'token_plataforma_vieja' => $token_migracion\n   451→                                ]);\n   452→                            } else {\n   453→                                $token_migracion = $usuario_existente->token_plataforma_vieja;\n   454→                            }\n   455→                        } else {\n   456→                            // Si no se encuentra el usuario, relanzar la excepción original\n   457→                            throw $e;\n   458→                        }\n   459→                    } else {\n   460→                        // Si es otro tipo de error, relanzar\n   461→                        throw $e;\n   462→                    }\n   463→                }\n   464→            } else {\n   465→                Log::info('Usuario ya existe en nueva plataforma', [\n   466→                    'usuario_existente_id' => $usuario_existente->id,\n   467→                    'documento_antiguo' => $usuario_antiguo->documento_usuario,\n   468→                    'email_antiguo' => $usuario_antiguo->email_usuario,\n   469→                    'documento_existente' => $usuario_existente->documento,\n   470→                    'email_existente' => $usuario_existente->email\n   471→                ]);\n   472→                \n   473→                /**\n   474→                 * ⚠️ Advertencia: Se asume que el usuario existente, relacionado con la nueva\n   475→                 * empresa, esta relacionado con la empresa por medio de un solo rol.\n   476→                 *\n   477→                 * @author Fahibram Cárcamo\n   478→                 */\n   479→                $empresa_usuario = $this->empresa_usuario_repositorio->getUnoAvanzado(new Request([\n   480→                    'usuario_id' => $usuario_existente->id,\n   481→                    'empresa_id' => $nueva_empresa->id\n   482→                ]));\n   483→\n   484→                // Si no existe relación empresa-usuario, usar el rol mapeado del usuario antiguo\n   485→                $rol_a_usar = $empresa_usuario?->rol_id ?? $this->mapearRolConPropietario($usuario_antiguo, $nueva_empresa->id);\n   486→\n   487→                $this->empresa_usuario_repositorio->crearSiNoExiste([\n   488→                    'usuario_id' => $usuario_existente->id,\n   489→                    'empresa_id' => $nueva_empresa->id,\n   490→                    'rol_id'     => $rol_a_usar\n   491→                ]);\n   492→\n   493→                if (!is_null($rol_a_usar)) {\n   494→                    // Activar rol solo para usuarios administrativos\n   495→                    $activar_rol = in_array($rol_a_usar, [\n   496→                        RolRepository::ROL_PROPIETARIO_ID,            // 4\n   497→                        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,  // 6\n   498→                        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID  // 7\n   499→                    ]);\n   500→                    $this->rol_repositorio->asignarRolUsuarioSiNoExiste($usuario_existente->id, $rol_a_usar, $activar_rol);\n   501→                }\n   502→\n   503→                if (empty($usuario_existente->token_plataforma_vieja)) {\n   504→                    $this->usuario_repositorio->actualizar($usuario_existente->id, [\n   505→                        'token_plataforma_vieja' => $token_migracion\n   506→                    ]);\n   507→                } else {\n   508→                    $token_migracion = $usuario_existente->token_plataforma_vieja;\n   509→                }\n   510→\n   511→                $nuevo_usuario = $this->usuario_repositorio->getUno($usuario_existente->id);\n   512→            }\n   513→\n   514→            /**\n   515→             * Cuando se migran los datos de un usuario desde la plataforma antigua hacia la nueva\n   516→             * se establece los valores de los campos *auth_token* y *date_token_expire* en el\n   517→             * registro del usuario de la base de datos antigua para permitirle al usuario que\n   518→             * acceder a su sesión en esta plataforma de manera instantanea.\n   519→             *\n   520→             * Esto solo aplica para los usuarios **administradores de empresa** y **administradores\n   521→             * de sucursales**.\n   522→             *\n   523→             * IMPORTANTE: Se usa el mismo token que se guardó en la nueva plataforma para garantizar consistencia.\n   524→             *\n   525→             * @author Fahibram Cárcamo\n   526→             * @author Sergio Vargas\n   527→             */\n   528→            // TODOS los usuarios migrados deben tener token de acceso (sin importar el rol)\n   529→            if (true) {\n   530→                Log::info('Actualizando token en plataforma antigua', [\n   531→                    'usuario_id' => $usuario_antiguo->id_usuario,\n   532→                    'token_migracion' => $token_migracion\n   533→                ]);\n   534→                \n   535→                DB::connection('old_db')\n   536→                    ->table('usuario')\n   537→                    ->where(\"id_usuario\", $usuario_antiguo->id_usuario)\n   538→                    ->update([\n   539→                        'auth_token'        => $token_migracion,\n   540→                        'date_token_expire' => now()->addYears(5)\n   541→                    ]);\n   542→                    \n   543→                Log::info('Token actualizado exitosamente en plataforma antigua', [\n   544→                    'usuario_id' => $usuario_antiguo->id_usuario\n   545→                ]);\n   546→            }\n   547→            \n   548→                Log::info('Usuario procesado completamente', [\n   549→                    'usuario_id' => $usuario_antiguo->id_usuario,\n   550→                    'documento' => $usuario_antiguo->documento_usuario\n   551→                ]);\n   552→            } catch (Exception $e) {\n   553→                Log::error('Error procesando usuario individual', [\n   554→                    'usuario_id' => $usuario_antiguo->id_usuario,\n   555→                    'documento' => $usuario_antiguo->documento_usuario,\n   556→                    'email' => $usuario_antiguo->email_usuario,\n   557→                    'error' => $e->getMessage(),\n   558→                    'archivo' => $e->getFile(),\n   559→                    'linea' => $e->getLine(),\n   560→                    'trace' => $e->getTraceAsString()\n   561→                ]);\n   562→                \n   563→                // Re-lanzar la excepción para que falle toda la migración\n   564→                throw $e;\n   565→            }\n   566→        }\n   567→        \n   568→        Log::info('Migración de usuarios completada', [\n   569→            'empresa_antigua_id' => $empresa_antigua->id_empresa,\n   570→            'nueva_empresa_id' => $nueva_empresa->id,\n   571→            'total_procesados' => $usuarios_antiguos->count()\n   572→        ]);\n   573→    }\n   574→\n   575→    /**\n   576→     * Migrar el usuario con rol ejecutivo de cuenta de una empresa recien migrada.\n   577→     *\n   578→     * @param int $usuario_ejecutivo_antiguo_id Id del usuario ejecutivo de cuenta.\n   579→     * @param object $nueva_empresa Nueva empresa migrada.\n   580→     * @return object|null\n   581→     * @author Fahibram Cárcamo\n   582→     */\n   583→    private function migrarEjecutivoEmpresa(int $usuario_ejecutivo_antiguo_id, object $nueva_empresa): object|null {\n   584→        Log::info('Iniciando migración de ejecutivo de empresa', [\n   585→            'ejecutivo_id' => $usuario_ejecutivo_antiguo_id,\n   586→            'empresa_id' => $nueva_empresa->id\n   587→        ]);\n   588→        \n   589→        $usuario_ejecutivo_antiguo = DB::connection('old_db')\n   590→            ->table('usuario')\n   591→            ->select(\n   592→                'usuario.id_usuario AS id_usuario',\n   593→                'usuario.id_rol_usuario AS id_rol_usuario',\n   594→                'usuario.id_empresa AS id_empresa_usuario',\n   595→                'usuario.id_informacion_general AS id_informacion_general_usuario',\n   596→                'usuario.remember_token AS remember_token_usuario',\n   597→                'usuario.id_estado AS id_estado',\n   598→                'usuario.universidades AS universidades_usuario',\n   599→                'usuario.username AS username_usuario',\n   600→                'usuario.password AS password_usuario',\n   601→                'usuario.codigo_autorizacion AS codigo_autorizacion_usuario',\n   602→                'usuario.vencimiento_codigo_autorizacion AS vencimiento_codigo_autorizacion_usuario',\n   603→                'usuario.api_token AS api_token_usuario',\n   604→                'usuario.session_id AS session_id_usuario',\n   605→                'usuario.updated_at AS updated_at_usuario',\n   606→                'usuario.created_at AS created_at_usuario',\n   607→                'usuario.auth_token AS auth_token_usuario',\n   608→                'usuario.date_token_expire AS date_token_expire_usuario',\n   609→                'usuario.ultima_fecha_login AS ultima_fecha_login_usuario',\n   610→                'usuario.log_actualizacion AS usuario_log_actualizacion',\n   611→                'usuario.antecedentes_disponibles AS antecedentes_disponibles_usuario',\n   612→                'informacion_general.id_informacion_general AS id_informacion_general',\n   613→                'informacion_general.id_ciudad AS id_ciudad_usuario',\n   614→                'informacion_general.id_tipo_documento AS id_tipo_documento_usuario',\n   615→                'informacion_general.documento AS documento_usuario',\n   616→                'informacion_general.primer_nombre AS primer_nombre_usuario',\n   617→                'informacion_general.segundo_nombre AS segundo_nombre_usuario',\n   618→                'informacion_general.primer_apellido AS primer_apellido_usuario',\n   619→                'informacion_general.segundo_apellido AS segundo_apellido_usuario',\n   620→                'informacion_general.email AS email_usuario',\n   621→                'informacion_general.genero AS genero_usuario',\n   622→                'informacion_general.fecha_nacimiento AS fecha_nacimiento_usuario',\n   623→                'informacion_general.created_at AS created_at',\n   624→                'informacion_general.updated_at AS updated_at',\n   625→                'informacion_general.auto_evaluacion AS auto_evaluacion_usuario',\n   626→                'informacion_general.log_actualizacion AS log_actualizacion_usuario'\n   627→            )\n   628→            ->join('informacion_general', 'usuario.id_informacion_general', '=', 'informacion_general.id_informacion_general')\n   629→            ->where('usuario.id_usuario', $usuario_ejecutivo_antiguo_id)\n   630→            ->where('usuario.id_estado', 1)\n   631→            ->first();\n   632→\n   633→        if (is_null($usuario_ejecutivo_antiguo)) {\n   634→            Log::warning('Usuario ejecutivo no encontrado o inactivo', [\n   635→                'ejecutivo_id' => $usuario_ejecutivo_antiguo_id\n   636→            ]);\n   637→            return null;\n   638→        }\n   639→        \n   640→        Log::info('Usuario ejecutivo encontrado', [\n   641→            'ejecutivo_id' => $usuario_ejecutivo_antiguo_id,\n   642→            'documento' => $usuario_ejecutivo_antiguo->documento_usuario,\n   643→            'email' => $usuario_ejecutivo_antiguo->email_usuario\n   644→        ]);\n   645→\n   646→        // Verificar si el usuario ejecutivo ya existe por documento\n   647→        $usuario_ejecutivo_existente = DB::connection('mysql')\n   648→            ->table('users')\n   649→            ->where('documento', $usuario_ejecutivo_antiguo->documento_usuario)\n   650→            ->first();\n   651→            \n   652→        // Si no se encuentra por documento, buscar por email\n   653→        if (is_null($usuario_ejecutivo_existente)) {\n   654→            $usuario_ejecutivo_existente = DB::connection('mysql')\n   655→                ->table('users')\n   656→                ->where('email', $usuario_ejecutivo_antiguo->email_usuario)\n   657→                ->first();\n   658→        }\n   659→            \n   660→        Log::info('Resultado de búsqueda de usuario ejecutivo existente', [\n   661→            'documento_buscado' => $usuario_ejecutivo_antiguo->documento_usuario,\n   662→            'email_buscado' => $usuario_ejecutivo_antiguo->email_usuario,\n   663→            'usuario_encontrado' => !is_null($usuario_ejecutivo_existente),\n   664→            'usuario_encontrado_id' => $usuario_ejecutivo_existente->id ?? null,\n   665→            'usuario_encontrado_documento' => $usuario_ejecutivo_existente->documento ?? null,\n   666→            'usuario_ejecutivo_existente_email' => $usuario_ejecutivo_existente->email ?? null\n   667→        ]);\n   668→\n   669→        // Generar un único token para usar en ambas plataformas\n   670→        $token_migracion_ejecutivo = Str::random(30);\n   671→\n   672→        if (is_null($usuario_ejecutivo_existente)) {\n   673→            try {\n   674→                $datos_usuario_ejecutivo_antiguo = $this->mapearCamposUsuario($usuario_ejecutivo_antiguo, $token_migracion_ejecutivo);\n   675→                $nuevo_usuario_ejecutivo         = $this->usuario_repositorio->crear($datos_usuario_ejecutivo_antiguo);\n   676→            } catch (\\Illuminate\\Database\\QueryException $e) {\n   677→                // Si es error de duplicado por email, buscar el usuario existente\n   678→                if ($e->getCode() === '23000' && str_contains($e->getMessage(), 'users_email_unique')) {\n   679→                    Log::info('Usuario ejecutivo ya existe (detectado durante creación)', [\n   680→                        'email' => $usuario_ejecutivo_antiguo->email_usuario,\n   681→                        'documento' => $usuario_ejecutivo_antiguo->documento_usuario\n   682→                    ]);\n   683→                    \n   684→                    // Buscar el usuario existente por email\n   685→                    $usuario_ejecutivo_existente = DB::connection('mysql')\n   686→                        ->table('users')\n   687→                        ->where('email', $usuario_ejecutivo_antiguo->email_usuario)\n   688→                        ->first();\n   689→                        \n   690→                    if (!is_null($usuario_ejecutivo_existente)) {\n   691→                        $nuevo_usuario_ejecutivo = $this->usuario_repositorio->getUno($usuario_ejecutivo_existente->id);\n   692→                        \n   693→                        // Actualizar token de plataforma vieja si no lo tiene\n   694→                        if (empty($usuario_ejecutivo_existente->token_plataforma_vieja)) {\n   695→                            $this->usuario_repositorio->actualizar($usuario_ejecutivo_existente->id, [\n   696→                                'token_plataforma_vieja' => $token_migracion_ejecutivo\n   697→                            ]);\n   698→                        } else {\n   699→                            $token_migracion_ejecutivo = $usuario_ejecutivo_existente->token_plataforma_vieja;\n   700→                        }\n   701→                    } else {\n   702→                        // Si no se encuentra el usuario, relanzar la excepción original\n   703→                        throw $e;\n   704→                    }\n   705→                } else {\n   706→                    // Si es otro tipo de error, relanzar\n   707→                    throw $e;\n   708→                }\n   709→            }\n   710→        } else {\n   711→            $nuevo_usuario_ejecutivo = $this->usuario_repositorio->getUno($usuario_ejecutivo_existente->id);\n   712→\n   713→            // Asignar token de plataforma vieja si no lo tiene o usar el token existente\n   714→            if (empty($usuario_ejecutivo_existente->token_plataforma_vieja)) {\n   715→                $this->usuario_repositorio->actualizar($usuario_ejecutivo_existente->id, [\n   716→                    'token_plataforma_vieja' => $token_migracion_ejecutivo\n   717→                ]);\n   718→                $nuevo_usuario_ejecutivo->refresh();\n   719→            } else {\n   720→                // Si ya tiene token, usar el existente para mantener consistencia\n   721→                $token_migracion_ejecutivo = $usuario_ejecutivo_existente->token_plataforma_vieja;\n   722→            }\n   723→        }\n   724→\n   725→        $rol_id = $this->rol_repositorio->mapearIdRol($usuario_ejecutivo_antiguo->id_rol_usuario);\n   726→\n   727→        // Si no se puede mapear el rol, usar un rol por defecto (Ejecutivo de Cuenta)\n   728→        if (is_null($rol_id)) {\n   729→            $rol_id = 5; // Ejecutivo de Cuenta\n   730→        }\n   731→\n   732→        $this->empresa_usuario_repositorio->crearSiNoExiste([\n   733→            'usuario_id' => $nuevo_usuario_ejecutivo->id,\n   734→            'empresa_id' => $nueva_empresa->id,\n   735→            'rol_id'     => $rol_id\n   736→        ]);\n   737→\n   738→        // Actualizar auth_token en plataforma vieja para ejecutivos también\n   739→        // Usar el mismo token para mantener consistencia\n   740→        DB::connection('old_db')\n   741→            ->table('usuario')\n   742→            ->where(\"id_usuario\", $usuario_ejecutivo_antiguo->id_usuario)\n   743→            ->update([\n   744→                'auth_token'        => $token_migracion_ejecutivo,\n   745→                'date_token_expire' => now()->addYears(5)\n   746→            ]);\n   747→\n   748→        Log::info('Migración de ejecutivo completada exitosamente', [\n   749→            'ejecutivo_id' => $usuario_ejecutivo_antiguo_id,\n   750→            'nuevo_usuario_id' => $nuevo_usuario_ejecutivo->id,\n   751→            'documento' => $usuario_ejecutivo_antiguo->documento_usuario\n   752→        ]);\n   753→        \n   754→        return $nuevo_usuario_ejecutivo;\n   755→    }\n   756→\n   757→    /**\n   758→     * Mapear los campos de la tabla \"empresa\" de la base de datos antigua para que coincida con los\n   759→     * campos de la tabla \"empresas\" de la nueva base de datos.\n   760→     *\n   761→     * @param object $empresa_antigua Datos de la empresa antigua.\n   762→     * @return array\n   763→     * @author Fahibram Cárcamo\n   764→     */\n   765→    private function mapearCamposEmpresaAntigua(object $empresa_antigua): array {\n   766→        return [\n   767→            'ciudad_id'                 => $this->mapearCiudadEmpresa($empresa_antigua),\n   768→            'sector_id'                 => 1,\n   769→            'tamano_empresa_id'         => 1,\n   770→            'razon_social'              => $empresa_antigua->razon_social,\n   771→            'nombre_comercial'          => $empresa_antigua->razon_social,\n   772→            'documento'                 => $empresa_antigua->identificacion,\n   773→            'direccion'                 => $empresa_antigua->direccion,\n   774→            'telefono'                  => $empresa_antigua->telefono,\n   775→            'es_persona_juridica'       => true,\n   776→            'documento_representante'   => '',\n   777→            'nombre_representante'      => '',\n   778→            'email_representante'       => '',\n   779→            'nombre_tesorero'           => '',\n   780→            'email_tesorero'            => '',\n   781→            'nombre_contacto'           => $empresa_antigua->contacto_nombre ?? '',\n   782→            'email_contacto'            => '',\n   783→            'celular_contacto'          => $empresa_antigua->contacto_telefono ?? null,\n   784→            'telefono_contacto'         => $empresa_antigua->contacto_telefono ?? null,\n   785→            'notificacion_vencimientos' => $empresa_antigua->notificacion_vencimiento ?? true,\n   786→            'creado_administrador'      => true,\n   787→            'activo'                    => true,\n   788→            'created_at'                => $empresa_antigua->created_at ?? now(),\n   789→            'updated_at'                => $empresa_antigua->updated_at ?? now()\n   790→        ];\n   791→    }\n   792→\n   793→    /**\n   794→     * Mapear la ciudad de una empresa desde la base de datos legacy a la nueva base de datos\n   795→     *\n   796→     * @param object $empresa_antigua Datos de la empresa antigua\n   797→     * @return int ID de ciudad válido en la nueva base de datos\n   798→     * @author Sergio Vargas\n   799→     */\n   800→    private function mapearCiudadEmpresa(object $empresa_antigua): int {\n   801→        // Si no tiene ciudad asignada, usar ciudad predeterminada\n   802→        if (!isset($empresa_antigua->id_ciudad) || is_null($empresa_antigua->id_ciudad)) {\n   803→            return $this->obtenerCiudadPredeterminada();\n   804→        }\n   805→\n   806→        // Intentar mapear la ciudad\n   807→        $ciudad_mapeada = $this->usuario_repositorio->mapearIdCiudad($empresa_antigua->id_ciudad);\n   808→\n   809→        if (is_null($ciudad_mapeada)) {\n   810→            return $this->obtenerCiudadPredeterminada();\n   811→        }\n   812→\n   813→        return $ciudad_mapeada;\n   814→    }\n   815→\n   816→    /**\n   817→     * Obtener una ciudad predeterminada válida para empresas sin ciudad\n   818→     *\n   819→     * @return int ID de ciudad válido\n   820→     * @author Sergio Vargas\n   821→     */\n   822→    private function obtenerCiudadPredeterminada(): int {\n   823→        // Buscar Bogotá primero\n   824→        $bogota = DB::connection('mysql')->table('ciudades')\n   825→            ->where('nombre', 'like', '%Bogotá%')\n   826→            ->orWhere('nombre', 'like', '%Bogota%')\n   827→            ->first();\n   828→\n   829→        if ($bogota) {\n   830→            return $bogota->id;\n   831→        }\n   832→\n   833→        // Si no encuentra Bogotá, usar la primera ciudad disponible\n   834→        $primera_ciudad = DB::connection('mysql')->table('ciudades')\n   835→            ->orderBy('id')\n   836→            ->first();\n   837→\n   838→        if ($primera_ciudad) {\n   839→            return $primera_ciudad->id;\n   840→        }\n   841→\n   842→        // Si no hay ciudades, esto es un problema mayor\n   843→        throw new Exception('No se encontraron ciudades válidas en la base de datos para usar como predeterminada');\n   844→    }\n   845→\n   846→    /**\n   847→     * Mapear los campos de la tabla \"usuario\" de la base de datos antigua para que coincidan con\n   848→     * los campos de la tabla \"usuarios\" de la nueva base de datos.\n   849→     *\n   850→     * @param object $usuario_antiguo Datos del usuario antiguo.\n   851→     * @param string $token_migracion Token de migración único para usar en ambas plataformas.\n   852→     * @return array\n   853→     * @author Fahibram Cárcamo\n   854→     * @author Sergio Vargas\n   855→     */\n   856→    private function mapearCamposUsuario(object $usuario_antiguo, string $token_migracion): array {\n   857→        Log::info('Mapeando campos de usuario', [\n   858→            'usuario_id' => $usuario_antiguo->id_usuario,\n   859→            'documento' => $usuario_antiguo->documento_usuario,\n   860→            'email' => $usuario_antiguo->email_usuario\n   861→        ]);\n   862→        \n   863→        try {\n   864→            $datos_mapeados = [\n   865→            'tipo_documento_id' => $this->usuario_repositorio->mapearIdTipoDocumento($usuario_antiguo->id_tipo_documento_usuario),\n   866→            'genero_id'         => is_string($usuario_antiguo->genero_usuario)\n   867→                ? $this->usuario_repositorio->mapearIdGenero($usuario_antiguo->genero_usuario)\n   868→                : null,\n   869→            'ciudad_id' => is_int($usuario_antiguo->id_ciudad_usuario)\n   870→                ? $this->usuario_repositorio->mapearIdCiudad($usuario_antiguo->id_ciudad_usuario)\n   871→                : null,\n   872→            'estado_id' => $usuario_antiguo->id_estado ?? 1,\n   873→            'nombres'   => trim(\n   874→                ($usuario_antiguo->primer_nombre_usuario ?? '') . ' ' . ($usuario_antiguo->segundo_nombre_usuario ?? '')\n   875→            ),\n   876→            'apellidos' => trim(\n   877→                ($usuario_antiguo->primer_apellido_usuario ?? '') . ' ' . ($usuario_antiguo->segundo_apellido_usuario ?? '')\n   878→            ),\n   879→            'username'                        => $usuario_antiguo->username_usuario ?? null,\n   880→            'documento'                       => $usuario_antiguo->documento_usuario,\n   881→            'email'                           => $usuario_antiguo->email_usuario,\n   882→            'fecha_nacimiento'                => $usuario_antiguo->fecha_nacimiento_usuario ?? null,\n   883→            'password'                        => Hash::make(base64_decode($usuario_antiguo->password_usuario)),\n   884→            'codigo_autorizacion'             => $usuario_antiguo->codigo_autorizacion_usuario ?? null,\n   885→            'vencimiento_codigo_autorizacion' => $usuario_antiguo->vencimiento_codigo_autorizacion ?? null,\n   886→            'token_autenticacion'             => $usuario_antiguo->auth_token_usuario ?? null,\n   887→            'fecha_expiracion_token'          => $usuario_antiguo->date_token_expire_usuario ?? null,\n   888→            'datos_completados'               => 1,\n   889→            'usuario_migrado'                 => 1,\n   890→            'token_plataforma_vieja'          => $token_migracion,\n   891→            'intentos_codigo'                 => 0,\n   892→            'remember_token'                  => $usuario_antiguo->remember_token_usuario ?? null,\n   893→            'created_at'                      => $usuario_antiguo->created_at_usuario ?? now(),\n   894→            'updated_at'                      => $usuario_antiguo->updated_at_usuario ?? now()\n   895→            ];\n   896→        \n   897→            Log::info('Campos de usuario mapeados exitosamente', [\n   898→                'usuario_id' => $usuario_antiguo->id_usuario,\n   899→                'campos_mapeados' => array_keys($datos_mapeados)\n   900→            ]);\n   901→        \n   902→            return $datos_mapeados;\n   903→        \n   904→        } catch (Exception $e) {\n   905→            Log::error('Error al mapear campos de usuario', [\n   906→                'usuario_id' => $usuario_antiguo->id_usuario,\n   907→                'error' => $e->getMessage(),\n   908→                'trace' => $e->getTraceAsString()\n   909→            ]);\n   910→            throw $e;\n   911→        }\n   912→    }\n   913→\n   914→    /**\n   915→     * Asegurar logo de empresa (importar de plataforma vieja o generar fallback).\n   916→     *\n   917→     * Si la empresa no tiene un archivo con nombre 'logo', intenta descargar\n   918→     * el JPG desde la plataforma vieja usando la URL\n   919→     * {URL_PLATAFORMA_VIEJA}/images/empresas/{id_viejo}.jpg. Si la descarga\n   920→     * falla o no se encuentra, genera un SVG con iniciales y lo guarda como\n   921→     * logo temporal.\n   922→     *\n   923→     * @param Empresa $empresa Empresa recién creada o existente.\n   924→     * @param int|null $empresa_antigua_id Id de la empresa en la plataforma vieja (para buscar el JPG).\n   925→     * @return void\n   926→     * @author Sergio Vargas\n   927→     */\n   928→    private function asegurarLogoEmpresa(Empresa $empresa, ?int $empresa_antigua_id = null): void {\n   929→        $modelo = 'App\\\\Models\\\\Empresas\\\\Empresa';\n   930→        $logo   = $this->archivo_repositorio->obtenerPorModelo($modelo, $empresa->id, 'logo');\n   931→\n   932→        if (!is_null($logo)) {\n   933→            return;\n   934→        }\n   935→\n   936→        // Intentar importar desde plataforma vieja si existe base_url y el id antiguo\n   937→        if (!is_null($empresa_antigua_id)) {\n   938→            $base64Legacy = $this->intentarImportarLogoDesdeLegacy($empresa_antigua_id);\n   939→\n   940→            if (!is_null($base64Legacy)) {\n   941→                $this->archivo_servicio->guardarVariosBase64($modelo, $empresa->id, ['logo' => $base64Legacy], 'empresas');\n   942→                return;\n   943→            }\n   944→        }\n   945→\n   946→        // Fallback: generar SVG con iniciales\n   947→        $svg    = $this->generarAvatarEmpresaSVG($empresa->nombre_comercial ?: $empresa->razon_social, (string) ($empresa->documento ?: $empresa->id));\n   948→        $base64 = 'data:image/svg+xml;base64,' . base64_encode($svg);\n   949→        $this->archivo_servicio->guardarVariosBase64($modelo, $empresa->id, ['logo' => $base64], 'empresas');\n   950→    }\n   951→\n   952→    /**\n   953→     * Descargar logo desde la plataforma vieja.\n   954→     *\n   955→     * Construye la URL: {URL_PLATAFORMA_VIEJA}/images/empresas/{id}.jpg y\n   956→     * realiza una petición HTTP. Si es exitosa, retorna el contenido como\n   957→     * data-URI base64 con mime image/jpeg. Si falla, retorna null.\n   958→     *\n   959→     * @param int $empresa_antigua_id Id entero de la empresa en la plataforma vieja.\n   960→     * @return string|null Data-URI base64 del JPG o null si no se pudo descargar.\n   961→     * @author Sergio Vargas\n   962→     */\n   963→    private function intentarImportarLogoDesdeLegacy(int $empresa_antigua_id): ?string {\n   964→        $base = (string) env('URL_PLATAFORMA_VIEJA', '');\n   965→        $base = trim($base);\n   966→\n   967→        if ($base === '') {\n   968→            return null;\n   969→        }\n   970→\n   971→        $base = rtrim($base, '/');\n   972→        $url  = $base . '/images/empresas/' . $empresa_antigua_id . '.jpg';\n   973→\n   974→        try {\n   975→            $resp = Http::timeout(10)->get($url);\n   976→\n   977→            if ($resp->successful() && strlen($resp->body()) > 0) {\n   978→                // Siempre JPG según especificación\n   979→                return 'data:image/jpeg;base64,' . base64_encode($resp->body());\n   980→            }\n   981→        } catch (\\Throwable $e) {\n   982→            Log::warning('No fue posible importar logo legacy', [\n   983→                'old_empresa_id' => $empresa_antigua_id,\n   984→                'error'          => $e->getMessage(),\n   985→            ]);\n   986→        }\n   987→\n   988→        return null;\n   989→    }\n   990→\n   991→    /**\n   992→     * Generar SVG circular con iniciales de la empresa (fallback).\n   993→     *\n   994→     * @param string $razon_social Nombre de la empresa para extraer iniciales.\n   995→     * @param string $semilla Valor determinístico para color (documento o id).\n   996→     * @return string SVG como texto (no codificado).\n   997→     * @author Sergio Vargas\n   998→     */\n   999→    private function generarAvatarEmpresaSVG(string $razon_social, string $semilla = ''): string {\n  1000→        $iniciales = $this->obtenerInicialesEmpresa($razon_social);\n  1001→        $paleta    = [\n  1002→            '#1abc9c', '#2ecc71', '#3498db', '#9b59b6', '#16a085',\n  1003→            '#27ae60', '#2980b9', '#8e44ad', '#e67e22', '#e74c3c',\n  1004→            '#d35400', '#c0392b', '#2c3e50', '#7f8c8d', '#34495e'\n  1005→        ];\n  1006→        $indice = 0;\n  1007→\n  1008→        if ($semilla !== '') {\n  1009→            $hash = 0;\n  1010→\n  1011→            for ($i = 0, $l = strlen($semilla); $i < $l; $i++) {\n  1012→                $hash = ord($semilla[$i]) + (($hash << 5) - $hash);\n  1013→            }\n  1014→            $indice = abs($hash) % count($paleta);\n  1015→        }\n  1016→        $bg = $paleta[$indice];\n  1017→\n  1018→        return <<<SVG\n  1019→            <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n  1020→            <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"256\" height=\"256\" viewBox=\"0 0 128 128\">\n  1021→            <defs>\n  1022→                <clipPath id=\"clipCircle\">\n  1023→                <circle cx=\"64\" cy=\"64\" r=\"64\" />\n  1024→                </clipPath>\n  1025→            </defs>\n  1026→            <rect width=\"128\" height=\"128\" fill=\"{$bg}\" />\n  1027→            <g clip-path=\"url(#clipCircle)\">\n  1028→                <rect width=\"128\" height=\"128\" fill=\"{$bg}\" />\n  1029→            </g>\n  1030→            <text x=\"50%\" y=\"50%\" dy=\".65em\" text-anchor=\"middle\" alignment-baseline=\"bottom\" dominant-baseline=\"bottom\"\n  1031→                    font-family=\"Arial, Helvetica, sans-serif\" font-size=\"56\" fill=\"#ffffff\"\n  1032→                    font-weight=\"700\">{$iniciales}</text>\n  1033→            <circle cx=\"64\" cy=\"64\" r=\"63\" fill=\"none\" stroke=\"rgba(255,255,255,0.25)\" stroke-width=\"2\" />\n  1034→            </svg>\n  1035→        SVG;\n  1036→    }\n  1037→\n  1038→    /**\n  1039→     * Obtener hasta dos iniciales de la razón social.\n  1040→     *\n  1041→     * Omite conectores comunes (de, del, la, el, y, e, the, and) al escoger la\n  1042→     * segunda inicial. Si no hay caracteres válidos, retorna 'E'.\n  1043→     *\n  1044→     * @param string $razon_social Razón social o nombre comercial.\n  1045→     * @return string Iniciales en mayúsculas (1 o 2 caracteres).\n  1046→     * @author Sergio Vargas\n  1047→     */\n  1048→    private function obtenerInicialesEmpresa(string $razon_social): string {\n  1049→        $razon_social = trim(preg_replace('/\\s+/', ' ', $razon_social));\n  1050→\n  1051→        if ($razon_social === '') {\n  1052→            return 'E';\n  1053→        }\n  1054→        $partes = explode(' ', $razon_social);\n  1055→        $i1     = mb_strtoupper(mb_substr($partes[0] ?? '', 0, 1));\n  1056→        $i2     = '';\n  1057→        // Buscar la siguiente palabra significativa (omitir conectores comunes)\n  1058→        $omitidos = ['de', 'del', 'la', 'el', 'y', 'e', 'the', 'and'];\n  1059→\n  1060→        for ($k = 1; $k < count($partes); $k++) {\n  1061→            $pal = mb_strtolower($partes[$k]);\n  1062→\n  1063→            if (!in_array($pal, $omitidos) && $pal !== '') {\n  1064→                $i2 = mb_strtoupper(mb_substr($partes[$k], 0, 1));\n  1065→                break;\n  1066→            }\n  1067→        }\n  1068→        $iniciales = $i1 . $i2;\n  1069→        return $iniciales !== '' ? $iniciales : 'E';\n  1070→    }\n  1071→\n  1072→    /**\n  1073→     * Mapear rol de usuario antiguo considerando que el primer Administrador General se convierte en Propietario.\n  1074→     *\n  1075→     * @param object $usuario_antiguo Datos del usuario antiguo.\n  1076→     * @param int $empresa_id ID de la nueva empresa.\n  1077→     * @return int|null\n  1078→     * @author Sergio Vargas\n  1079→     */\n  1080→    private function mapearRolConPropietario(object $usuario_antiguo, int $empresa_id): int|null {\n  1081→        $rol_mapeado = $this->rol_repositorio->mapearIdRol($usuario_antiguo->id_rol_usuario);\n  1082→        \n  1083→        // Si es Administrador General (rol 6), verificar si debe ser el propietario\n  1084→        if ($rol_mapeado === RolRepository::ROL_ADMINISTRADOR_GENERAL_ID) {\n  1085→            $clave_empresa = \"empresa_{$empresa_id}\";\n  1086→            \n  1087→            // Si es el primer Administrador General de esta empresa, convertirlo en Propietario\n  1088→            if (!isset(self::$primeros_admin_general_por_empresa[$clave_empresa])) {\n  1089→                self::$primeros_admin_general_por_empresa[$clave_empresa] = true;\n  1090→                return RolRepository::ROL_PROPIETARIO_ID; // 4\n  1091→            }\n  1092→        }\n  1093→        \n  1094→        return $rol_mapeado;\n  1095→    }\n  1096→\n  1097→    /**\n  1098→     * Asignar usuario comercial (ID 3) a la empresa migrada.\n  1099→     * \n  1100→     * @param object $empresa Empresa a la que se asignará el usuario comercial.\n  1101→     * @return void\n  1102→     * @author Sergio Vargas\n  1103→     */\n  1104→    private function asignarUsuarioComercial(object $empresa): void {\n  1105→        try {\n  1106→            Log::info('Asignando usuario comercial a empresa', [\n  1107→                'empresa_id' => $empresa->id,\n  1108→                'documento' => $empresa->documento\n  1109→            ]);\n  1110→\n  1111→            // Verificar si el usuario comercial (ID 3) existe\n  1112→            $usuario_comercial = $this->usuario_repositorio->getUno(3);\n  1113→            \n  1114→            if (is_null($usuario_comercial)) {\n  1115→                Log::warning('Usuario comercial con ID 3 no existe', [\n  1116→                    'empresa_id' => $empresa->id\n  1117→                ]);\n  1118→                return;\n  1119→            }\n  1120→\n  1121→            // Crear relación empresa-usuario comercial si no existe\n  1122→            $this->empresa_usuario_repositorio->crearSiNoExiste([\n  1123→                'usuario_id' => 3,\n  1124→                'empresa_id' => $empresa->id,\n  1125→                'rol_id'     => 5 // Ejecutivo de Cuenta\n  1126→            ]);\n  1127→\n  1128→            // Asignar rol de Ejecutivo de Cuenta al usuario comercial si no lo tiene\n  1129→            $this->rol_repositorio->asignarRolUsuarioSiNoExiste(3, 5, true);\n  1130→\n  1131→            Log::info('Usuario comercial asignado exitosamente', [\n  1132→                'usuario_comercial_id' => 3,\n  1133→                'empresa_id' => $empresa->id,\n  1134→                'rol_id' => 5\n  1135→            ]);\n  1136→        } catch (Exception $e) {\n  1137→            Log::error('Error al asignar usuario comercial', [\n  1138→                'empresa_id' => $empresa->id,\n  1139→                'error' => $e->getMessage()\n  1140→            ]);\n  1141→            \n  1142→            // No relanzar la excepción para que no falle la migración completa\n  1143→            // Solo registrar el error en el log\n  1144→        }\n  1145→    }\n  1146→}\n  1147→"}]},"uuid":"91d0da7b-263c-48fe-a8bd-a4ed41e67ce8","timestamp":"2026-02-16T21:30:08.611Z","sourceToolAssistantUUID":"4b268f0c-ed35-4f86-b890-49dded455d93"}
{"parentUuid":"91d0da7b-263c-48fe-a8bd-a4ed41e67ce8","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01FLwNp7UJKN3E2jLmfUEdTu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HKe16STnV28oVC3aJC4F7C","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\config\\database.php"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1150,"cache_read_input_tokens":15211,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1150},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTe9PTjvk2EwMEBTD4s","type":"assistant","uuid":"f8af6cf4-0164-415b-8ae3-e7d1937a947f","timestamp":"2026-02-16T21:30:08.827Z"}
{"parentUuid":"f8af6cf4-0164-415b-8ae3-e7d1937a947f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01HKe16STnV28oVC3aJC4F7C","toolUseID":"toolu_01HKe16STnV28oVC3aJC4F7C","timestamp":"2026-02-16T21:30:08.933Z","uuid":"c3076885-3454-4f9d-9544-0b0ed6a99965"}
{"parentUuid":"f8af6cf4-0164-415b-8ae3-e7d1937a947f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HKe16STnV28oVC3aJC4F7C","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Str;\n     4→\n     5→$localhost        = '127.0.0.1';\n     6→$puerto_localhost = '3306';\n     7→\n     8→return [\n     9→    /*\n    10→    |--------------------------------------------------------------------------\n    11→    | Default Database Connection Name\n    12→    |--------------------------------------------------------------------------\n    13→    |\n    14→    | Here you may specify which of the database connections below you wish\n    15→    | to use as your default connection for all database work. Of course\n    16→    | you may use many connections at once using the Database library.\n    17→    |\n    18→    */\n    19→\n    20→    'default' => env('DB_CONNECTION', 'mysql'),\n    21→\n    22→    /*\n    23→    |--------------------------------------------------------------------------\n    24→    | Database Connections\n    25→    |--------------------------------------------------------------------------\n    26→    |\n    27→    | Here are each of the database connections setup for your application.\n    28→    | Of course, examples of configuring each database platform that is\n    29→    | supported by Laravel is shown below to make development simple.\n    30→    |\n    31→    |\n    32→    | All database work in Laravel is done through the PHP PDO facilities\n    33→    | so make sure you have the driver for your particular database of\n    34→    | choice installed on your machine before you begin development.\n    35→    |\n    36→    */\n    37→\n    38→    'connections' => [\n    39→        'sqlite' => [\n    40→            'driver'                  => 'sqlite',\n    41→            'url'                     => env('DATABASE_URL'),\n    42→            'database'                => env('DB_DATABASE', database_path('database.sqlite')),\n    43→            'prefix'                  => '',\n    44→            'foreign_key_constraints' => env('DB_FOREIGN_KEYS', true),\n    45→        ],\n    46→\n    47→        'mysql' => [\n    48→            'driver'         => 'mysql',\n    49→            'url'            => env('DATABASE_URL'),\n    50→            'host'           => env('DB_HOST', $localhost),\n    51→            'port'           => env('DB_PORT', $puerto_localhost),\n    52→            'database'       => env('DB_DATABASE', 'forge'),\n    53→            'username'       => env('DB_USERNAME', 'forge'),\n    54→            'password'       => env('DB_PASSWORD', ''),\n    55→            'unix_socket'    => env('DB_SOCKET', ''),\n    56→            // Split de lectura/escritura:\n    57→            'read' => [\n    58→                // Soporta array de hosts: ['replica1', 'replica2', ...]\n    59→                'host' => [ env('DB_HOST_READ') ],\n    60→            ],\n    61→            'write' => [\n    62→                'host' => [ env('DB_HOST_WRITE') ],\n    63→            ],\n    64→            // Importante para evitar lecturas “stale” justo después de escribir:\n    65→            'sticky' => true,\n    66→\n    67→            'charset'        => 'utf8mb4',\n    68→            'collation'      => 'utf8mb4_unicode_ci',\n    69→            'prefix'         => '',\n    70→            'prefix_indexes' => true,\n    71→            'strict'         => false,\n    72→            'engine'         => null,\n    73→            'options'        => extension_loaded('pdo_mysql') ? array_filter([\n    74→                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),\n    75→            ]) : [],\n    76→        ],\n    77→\n    78→        'old_db' => [\n    79→            'driver'         => env('OLD_DB_CONNECTION'),\n    80→            'url'            => env('OLD_DATABASE_URL'),\n    81→            'host'           => env('OLD_DB_HOST', $localhost),\n    82→            'port'           => env('OLD_DB_PORT', $puerto_localhost),\n    83→            'database'       => env('OLD_DB_DATABASE', 'forge'),\n    84→            'username'       => env('OLD_DB_USERNAME', 'forge'),\n    85→            'password'       => env('OLD_DB_PASSWORD', ''),\n    86→            'unix_socket'    => env('OLD_DB_SOCKET', ''),\n    87→            'charset'        => 'utf8mb4',\n    88→            'collation'      => 'utf8mb4_unicode_ci',\n    89→            'prefix'         => '',\n    90→            'prefix_indexes' => true,\n    91→            'strict'         => false,\n    92→            'engine'         => null,\n    93→            'options'        => extension_loaded('pdo_mysql') ? array_filter([\n    94→                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),\n    95→            ]) : [],\n    96→        ],\n    97→\n    98→        'testing' => [\n    99→            'driver'         => 'mysql',\n   100→            'url'            => env('TEST_DATABASE_URL'),\n   101→            'host'           => env('TEST_DB_HOST', $localhost),\n   102→            'port'           => env('TEST_DB_PORT', $puerto_localhost),\n   103→            'database'       => env('TEST_DB_DATABASE', ':psicotest:'),\n   104→            'username'       => env('TEST_DB_USERNAME', 'root'),\n   105→            'password'       => env('TEST_DB_PASSWORD', ''),\n   106→            'unix_socket'    => env('TEST_DB_SOCKET', ''),\n   107→            'charset'        => 'utf8mb4',\n   108→            'collation'      => 'utf8mb4_unicode_ci',\n   109→            'prefix'         => '',\n   110→            'prefix_indexes' => true,\n   111→            'strict'         => false,\n   112→            'engine'         => null,\n   113→            'options'        => extension_loaded('pdo_mysql') ? array_filter([\n   114→                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),\n   115→            ]) : [],\n   116→        ],\n   117→\n   118→        'pgsql' => [\n   119→            'driver'         => 'pgsql',\n   120→            'url'            => env('DATABASE_URL'),\n   121→            'host'           => env('DB_HOST', $localhost),\n   122→            'port'           => env('DB_PORT', '5432'),\n   123→            'database'       => env('DB_DATABASE', 'forge'),\n   124→            'username'       => env('DB_USERNAME', 'forge'),\n   125→            'password'       => env('DB_PASSWORD', ''),\n   126→            'charset'        => 'utf8',\n   127→            'prefix'         => '',\n   128→            'prefix_indexes' => true,\n   129→            'search_path'    => 'public',\n   130→            'sslmode'        => 'prefer',\n   131→        ],\n   132→\n   133→        'sqlsrv' => [\n   134→            'driver'         => 'sqlsrv',\n   135→            'url'            => env('DATABASE_URL'),\n   136→            'host'           => env('DB_HOST', 'localhost'),\n   137→            'port'           => env('DB_PORT', '1433'),\n   138→            'database'       => env('DB_DATABASE', 'forge'),\n   139→            'username'       => env('DB_USERNAME', 'forge'),\n   140→            'password'       => env('DB_PASSWORD', ''),\n   141→            'charset'        => 'utf8',\n   142→            'prefix'         => '',\n   143→            'prefix_indexes' => true,\n   144→            // 'encrypt' => env('DB_ENCRYPT', 'yes'),\n   145→            // 'trust_server_certificate' => env('DB_TRUST_SERVER_CERTIFICATE', 'false'),\n   146→        ],\n   147→    ],\n   148→\n   149→    /*\n   150→    |--------------------------------------------------------------------------\n   151→    | Migration Repository Table\n   152→    |--------------------------------------------------------------------------\n   153→    |\n   154→    | This table keeps track of all the migrations that have already run for\n   155→    | your application. Using this information, we can determine which of\n   156→    | the migrations on disk haven't actually been run in the database.\n   157→    |\n   158→    */\n   159→\n   160→    'migrations' => 'migrations',\n   161→\n   162→    /*\n   163→    |--------------------------------------------------------------------------\n   164→    | Redis Databases\n   165→    |--------------------------------------------------------------------------\n   166→    |\n   167→    | Redis is an open source, fast, and advanced key-value store that also\n   168→    | provides a richer body of commands than a typical key-value system\n   169→    | such as APC or Memcached. Laravel makes it easy to dig right in.\n   170→    |\n   171→    */\n   172→\n   173→    'redis' => [\n   174→        'client' => env('REDIS_CLIENT', 'phpredis'),\n   175→\n   176→        'options' => [\n   177→            'cluster' => env('REDIS_CLUSTER', 'redis'),\n   178→            'prefix'  => env('REDIS_PREFIX', Str::slug(env('APP_NAME', 'laravel'), '_') . '_database_'),\n   179→        ],\n   180→\n   181→        'default' => [\n   182→            'url'      => env('REDIS_URL'),\n   183→            'host'     => env('REDIS_HOST', $localhost),\n   184→            'username' => env('REDIS_USERNAME'),\n   185→            'password' => env('REDIS_PASSWORD'),\n   186→            'port'     => env('REDIS_PORT', '6379'),\n   187→            'database' => env('REDIS_DB', '0'),\n   188→        ],\n   189→\n   190→        'cache' => [\n   191→            'url'      => env('REDIS_URL'),\n   192→            'host'     => env('REDIS_HOST', $localhost),\n   193→            'username' => env('REDIS_USERNAME'),\n   194→            'password' => env('REDIS_PASSWORD'),\n   195→            'port'     => env('REDIS_PORT', '6379'),\n   196→            'database' => env('REDIS_CACHE_DB', '1'),\n   197→        ],\n   198→    ],\n   199→];\n   200→"}]},"uuid":"aad875c2-eee5-4604-a377-27bcbfc0d00a","timestamp":"2026-02-16T21:30:08.932Z","sourceToolAssistantUUID":"f8af6cf4-0164-415b-8ae3-e7d1937a947f"}
{"parentUuid":"aad875c2-eee5-4604-a377-27bcbfc0d00a","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01WkY9YeqxSH73Hw3ojGA25W","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the queue configuration and the `.env` file for queue driver details, and also look at the `queue.php` config:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":46373,"cache_read_input_tokens":16361,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":46373},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTeTZbZVFSdmKuRvJPd","type":"assistant","uuid":"e989a344-b705-49f6-91ad-6ad57d86e8cd","timestamp":"2026-02-16T21:30:11.313Z"}
{"parentUuid":"e989a344-b705-49f6-91ad-6ad57d86e8cd","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01WkY9YeqxSH73Hw3ojGA25W","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N8W1HLQZBdg7SdHXitWUgz","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\config\\queue.php"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":46373,"cache_read_input_tokens":16361,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":46373},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTeTZbZVFSdmKuRvJPd","type":"assistant","uuid":"1ecedb08-015e-4432-aa14-84b5e46a65c7","timestamp":"2026-02-16T21:30:12.354Z"}
{"parentUuid":"1ecedb08-015e-4432-aa14-84b5e46a65c7","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01N8W1HLQZBdg7SdHXitWUgz","toolUseID":"toolu_01N8W1HLQZBdg7SdHXitWUgz","timestamp":"2026-02-16T21:30:12.455Z","uuid":"13395668-e93a-4de1-8ca4-d51aa15f5e3b"}
{"parentUuid":"1ecedb08-015e-4432-aa14-84b5e46a65c7","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N8W1HLQZBdg7SdHXitWUgz","type":"tool_result","content":"     1→<?php\n     2→\n     3→return [\n     4→\n     5→    /*\n     6→    |--------------------------------------------------------------------------\n     7→    | Default Queue Connection Name\n     8→    |--------------------------------------------------------------------------\n     9→    |\n    10→    | Laravel's queue API supports an assortment of back-ends via a single\n    11→    | API, giving you convenient access to each back-end using the same\n    12→    | syntax for every one. Here you may define a default connection.\n    13→    |\n    14→    */\n    15→\n    16→    'default' => env('QUEUE_CONNECTION', 'sync'),\n    17→\n    18→    /*\n    19→    |--------------------------------------------------------------------------\n    20→    | Queue Connections\n    21→    |--------------------------------------------------------------------------\n    22→    |\n    23→    | Here you may configure the connection information for each server that\n    24→    | is used by your application. A default configuration has been added\n    25→    | for each back-end shipped with Laravel. You are free to add more.\n    26→    |\n    27→    | Drivers: \"sync\", \"database\", \"beanstalkd\", \"sqs\", \"redis\", \"null\"\n    28→    |\n    29→    */\n    30→\n    31→    'connections' => [\n    32→\n    33→        'sync' => [\n    34→            'driver' => 'sync',\n    35→        ],\n    36→\n    37→        'database' => [\n    38→            'driver' => 'database',\n    39→            'table' => 'jobs',\n    40→            'queue' => 'default',\n    41→            'retry_after' => 90,\n    42→            'after_commit' => false,\n    43→        ],\n    44→\n    45→        'beanstalkd' => [\n    46→            'driver' => 'beanstalkd',\n    47→            'host' => 'localhost',\n    48→            'queue' => 'default',\n    49→            'retry_after' => 90,\n    50→            'block_for' => 0,\n    51→            'after_commit' => false,\n    52→        ],\n    53→\n    54→        'sqs' => [\n    55→            'driver' => 'sqs',\n    56→            'key' => env('AWS_ACCESS_KEY_ID'),\n    57→            'secret' => env('AWS_SECRET_ACCESS_KEY'),\n    58→            'prefix' => env('SQS_PREFIX', 'https://sqs.us-east-1.amazonaws.com/your-account-id'),\n    59→            'queue' => env('SQS_QUEUE', 'default'),\n    60→            'suffix' => env('SQS_SUFFIX'),\n    61→            'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),\n    62→            'after_commit' => false,\n    63→        ],\n    64→\n    65→        'redis' => [\n    66→            'driver' => 'redis',\n    67→            'connection' => 'default',\n    68→            'queue' => env('REDIS_QUEUE', 'default'),\n    69→            'retry_after' => 90,\n    70→            'block_for' => null,\n    71→            'after_commit' => false,\n    72→        ],\n    73→\n    74→    ],\n    75→\n    76→    /*\n    77→    |--------------------------------------------------------------------------\n    78→    | Job Batching\n    79→    |--------------------------------------------------------------------------\n    80→    |\n    81→    | The following options configure the database and table that store job\n    82→    | batching information. These options can be updated to any database\n    83→    | connection and table which has been defined by your application.\n    84→    |\n    85→    */\n    86→\n    87→    'batching' => [\n    88→        'database' => env('DB_CONNECTION', 'mysql'),\n    89→        'table' => 'job_batches',\n    90→    ],\n    91→\n    92→    /*\n    93→    |--------------------------------------------------------------------------\n    94→    | Failed Queue Jobs\n    95→    |--------------------------------------------------------------------------\n    96→    |\n    97→    | These options configure the behavior of failed queue job logging so you\n    98→    | can control which database and table are used to store the jobs that\n    99→    | have failed. You may change them to any database / table you wish.\n   100→    |\n   101→    */\n   102→\n   103→    'failed' => [\n   104→        'driver' => env('QUEUE_FAILED_DRIVER', 'database-uuids'),\n   105→        'database' => env('DB_CONNECTION', 'mysql'),\n   106→        'table' => 'failed_jobs',\n   107→    ],\n   108→\n   109→];\n   110→"}]},"uuid":"48f42508-af01-4bfe-bec2-aa8599e54c52","timestamp":"2026-02-16T21:30:12.454Z","sourceToolAssistantUUID":"1ecedb08-015e-4432-aa14-84b5e46a65c7"}
{"parentUuid":"48f42508-af01-4bfe-bec2-aa8599e54c52","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01WkY9YeqxSH73Hw3ojGA25W","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Tnr844SAm7vUP7QDV9HdwE","name":"Glob","input":{"pattern":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\.env"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":46373,"cache_read_input_tokens":16361,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":46373},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTeTZbZVFSdmKuRvJPd","type":"assistant","uuid":"aa0eb652-7bd5-4b3f-9f80-bcdb140ba0a0","timestamp":"2026-02-16T21:30:12.815Z"}
{"parentUuid":"aa0eb652-7bd5-4b3f-9f80-bcdb140ba0a0","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Glob","command":"callback"},"parentToolUseID":"toolu_01Tnr844SAm7vUP7QDV9HdwE","toolUseID":"toolu_01Tnr844SAm7vUP7QDV9HdwE","timestamp":"2026-02-16T21:30:13.919Z","uuid":"471b6510-4778-47ed-8db8-b67626f6cd38"}
{"parentUuid":"aa0eb652-7bd5-4b3f-9f80-bcdb140ba0a0","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Tnr844SAm7vUP7QDV9HdwE","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\fastapi_model\\.env\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\.env"}]},"uuid":"d4a30865-2763-4cb1-96b9-9230dc025fdf","timestamp":"2026-02-16T21:30:13.918Z","sourceToolAssistantUUID":"aa0eb652-7bd5-4b3f-9f80-bcdb140ba0a0"}
{"parentUuid":"d4a30865-2763-4cb1-96b9-9230dc025fdf","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01WkY9YeqxSH73Hw3ojGA25W","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AfrK611iJQBU7QRePAHnJv","name":"Grep","input":{"pattern":"OLD_DB|QUEUE_CONNECTION|QUEUE_DRIVER","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","glob":".env.example","output_mode":"content"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":46373,"cache_read_input_tokens":16361,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":46373},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTeTZbZVFSdmKuRvJPd","type":"assistant","uuid":"cdc5a780-08a5-4921-b302-a9494bc7c3c6","timestamp":"2026-02-16T21:30:14.147Z"}
{"parentUuid":"cdc5a780-08a5-4921-b302-a9494bc7c3c6","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01AfrK611iJQBU7QRePAHnJv","toolUseID":"toolu_01AfrK611iJQBU7QRePAHnJv","timestamp":"2026-02-16T21:30:14.915Z","uuid":"e8df359d-a3ed-4040-aef6-61e2f3e47d42"}
{"parentUuid":"cdc5a780-08a5-4921-b302-a9494bc7c3c6","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AfrK611iJQBU7QRePAHnJv","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\.env.example:20:OLD_DB_CONNECTION=mysql\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\.env.example:21:OLD_DB_HOST=127.0.0.1\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\.env.example:22:OLD_DB_PORT=3306\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\.env.example:23:OLD_DB_DATABASE=psicoalianza-dump\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\.env.example:24:OLD_DB_USERNAME=root\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\.env.example:25:OLD_DB_PASSWORD=\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\.env.example:30:QUEUE_CONNECTION=database"}]},"uuid":"c12a6ca0-4691-4a59-8459-ec904748e26e","timestamp":"2026-02-16T21:30:14.914Z","sourceToolAssistantUUID":"cdc5a780-08a5-4921-b302-a9494bc7c3c6"}
{"parentUuid":"c12a6ca0-4691-4a59-8459-ec904748e26e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019rCT5yM4A6ngyRCMYwLiop","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have the complete picture. Let me check the actual `.env` file (just the OLD_DB and QUEUE lines) to confirm production/dev values, plus verify if the Job serializes its constructor properly:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1908,"cache_read_input_tokens":62734,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1908},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTeu8EuVPquRW42Hn8S","type":"assistant","uuid":"5f401533-7a1c-4776-8416-e729dbcd23fb","timestamp":"2026-02-16T21:30:17.783Z"}
{"parentUuid":"5f401533-7a1c-4776-8416-e729dbcd23fb","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019rCT5yM4A6ngyRCMYwLiop","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018fDjqxmhfTChK1df9qjhrY","name":"Grep","input":{"pattern":"OLD_DB|QUEUE_CONNECTION","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\.env","output_mode":"content"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1908,"cache_read_input_tokens":62734,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1908},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTeu8EuVPquRW42Hn8S","type":"assistant","uuid":"64ff21fa-74cd-4b58-aec6-0bb42510f11b","timestamp":"2026-02-16T21:30:18.638Z"}
{"parentUuid":"64ff21fa-74cd-4b58-aec6-0bb42510f11b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_018fDjqxmhfTChK1df9qjhrY","toolUseID":"toolu_018fDjqxmhfTChK1df9qjhrY","timestamp":"2026-02-16T21:30:19.417Z","uuid":"def9859b-c091-4754-b173-a80219a8e01d"}
{"parentUuid":"64ff21fa-74cd-4b58-aec6-0bb42510f11b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018fDjqxmhfTChK1df9qjhrY","type":"tool_result","content":"20:OLD_DB_CONNECTION=mysql\n21:OLD_DB_HOST=127.0.0.1\n22:OLD_DB_PORT=3306\n23:OLD_DB_DATABASE=psicoalianza-dump\n24:OLD_DB_USERNAME=root\n25:OLD_DB_PASSWORD=\n30:QUEUE_CONNECTION=database"}]},"uuid":"fcad9b51-8774-4f34-a6fb-1828d902f2ca","timestamp":"2026-02-16T21:30:19.417Z","sourceToolAssistantUUID":"64ff21fa-74cd-4b58-aec6-0bb42510f11b"}
{"parentUuid":"fcad9b51-8774-4f34-a6fb-1828d902f2ca","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_019rCT5yM4A6ngyRCMYwLiop","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FXm5V64Txs2fdvYWPtNPnh","name":"Grep","input":{"pattern":"SerializesModels|Dispatchable|InteractsWithQueue","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Jobs\\Migraciones\\MigrarEmpresasSucursalesUsuariosJob.php","output_mode":"content"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1908,"cache_read_input_tokens":62734,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1908},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTeu8EuVPquRW42Hn8S","type":"assistant","uuid":"dd9347a3-06a1-4be0-abec-bef6c193f88d","timestamp":"2026-02-16T21:30:20.160Z"}
{"parentUuid":"dd9347a3-06a1-4be0-abec-bef6c193f88d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01FXm5V64Txs2fdvYWPtNPnh","toolUseID":"toolu_01FXm5V64Txs2fdvYWPtNPnh","timestamp":"2026-02-16T21:30:20.914Z","uuid":"6ad4fd55-95ea-4446-9c59-7b0bbe1e9845"}
{"parentUuid":"dd9347a3-06a1-4be0-abec-bef6c193f88d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FXm5V64Txs2fdvYWPtNPnh","type":"tool_result","content":"No matches found"}]},"uuid":"475a0a40-7a4f-43aa-9837-f51c61bd7f37","timestamp":"2026-02-16T21:30:20.913Z","sourceToolAssistantUUID":"dd9347a3-06a1-4be0-abec-bef6c193f88d"}
{"parentUuid":"475a0a40-7a4f-43aa-9837-f51c61bd7f37","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"11cbcb24-4c7a-41d7-bb3c-01fd9daec431","version":"2.1.39","gitBranch":"main","agentId":"aa5e092","slug":"playful-sparking-milner","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014DFgpFtLbzu5RzJ6cEWqUh","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have everything I need to give a thorough analysis. Here is the complete breakdown:\n\n---\n\n## Full Flow Analysis: `empresas-migracion`\n\n### 1. Routes (`routes/web.php`, lines 230-233)\n\n```php\n$ruta->get('empresas-migracion',                   'Empresas\\MigracionEmpresaController@index');\n$ruta->post('empresas-migracion/buscar',            'Empresas\\MigracionEmpresaController@buscarEmpresa');\n$ruta->post('empresas-migracion/validar-tamano',    'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n$ruta->post('empresas-migracion/iniciar',           'Empresas\\MigracionEmpresaController@iniciarMigracion');\n```\n\nAll routes are protected by `auth` and `can:empresas` middleware.\n\n---\n\n### 2. Controller\n**File:** `app/Http/Controllers/Empresas/MigracionEmpresaController.php`\n\nThree key actions:\n\n- **`buscarEmpresa`** - Reads `termino` from request, delegates directly to `$repositorio_migracion->buscarEmpresaPorNombreOId()`. No transaction, no service layer. Pure repository call.\n- **`validarTamanoEmpresa`** - Delegates to `$servicio_migracion->validarTamanoEmpresa($empresa_legacy_id)`.\n- **`iniciarMigracion`** - Wraps everything in `DB::beginTransaction()` / `DB::commit()` / `DB::rollBack()` on the **default** (`mysql`) connection, then calls `$servicio_migracion->iniciarMigracion($empresa_legacy_id)`.\n\n---\n\n### 3. Service\n**File:** `app/Http/Services/Empresas/MigracionEmpresaService.php`\n\n**`iniciarMigracion()` full flow:**\n\n1. Calls `$this->repositorio->verificarMigracionExistente($empresa_legacy_id)` - checks `migracion_empresas` table (new DB).\n2. Calls `$this->validarTamanoEmpresa()` which internally calls `obtenerTamanoEmpresa()` on the repository (hits `old_db`).\n3. Calls `$this->repositorio->inactivarEmpresaEnBaseDatosVieja($empresa_legacy_id)` - runs `UPDATE empresa SET en_mantenimiento = 1` on `old_db`.\n4. Creates `MigracionEmpresa::create([...])` - writes to `migracion_empresas` in new DB, with `estado = 'pendiente'`.\n5. **Dispatches the Job:** `MigrarEmpresasSucursalesUsuariosJob::dispatch($empresa_legacy_id)`.\n6. Returns a summary array back to the controller.\n7. **On any exception inside the `try`:** calls `$this->repositorio->reactivarEmpresaEnBaseDatosVieja($empresa_legacy_id)` to undo the `en_mantenimiento = 1`, then re-throws.\n\n---\n\n### 4. Repository\n**File:** `app/Http/Repositories/Empresas/MigracionEmpresaRepository.php`\n\nAll `old_db` access is done via `DB::connection('old_db')`. Key methods:\n\n| Method | Connection | Operation |\n|---|---|---|\n| `buscarEmpresaPorNombreOId()` | `old_db` | SELECT from `empresa`, JOIN `ciudad` |\n| `buscarEmpresaPorIdExacto()` | `old_db` | SELECT from `empresa` |\n| `ejecutarConsultaTamanoEmpresa()` | `old_db` | Complex UNION SELECT across `empresa`, `usuario`, `es_procesos`, `es_agenda` |\n| `obtenerConteosEmpresaLegacy()` | `old_db` | UNION SELECT COUNT across same tables |\n| `obtenerUsuariosParaMigracion()` | `old_db` | SELECT with JOIN `informacion_general` |\n| `inactivarEmpresaEnBaseDatosVieja()` | `old_db` | UPDATE `empresa SET en_mantenimiento = 1` |\n| `reactivarEmpresaEnBaseDatosVieja()` | `old_db` | UPDATE `empresa SET en_mantenimiento = 0` |\n| `verificarMigracionExistente()` | new DB (via Eloquent on `MigracionEmpresa` model) | SELECT from `migracion_empresas` |\n\n---\n\n### 5. Queued Job\n**File:** `app/Jobs/Migraciones/MigrarEmpresasSucursalesUsuariosJob.php`\n\nImplements `ShouldQueue`, uses `Queueable` trait — but **does NOT use `Dispatchable`, `InteractsWithQueue`, or `SerializesModels`** traits. Those are normally bundled by default but were not added here.\n\n**Constructor** (runs at `dispatch()` time, in the HTTP request process):\n- Instantiates all repositories and services directly via `new` (not dependency injection).\n- Immediately queries the DB: calls `$this->migracion_empresa_repositorio->getPorEmpresaAntiguaEstado($empresa_antigua_id, 'pendiente')` and stores the resulting `migracion_empresa_id`.\n\n**`handle()` method** (runs in the queue worker process, NOT in the HTTP request):\n1. Opens `DB::beginTransaction()` (on default `mysql` connection).\n2. Updates migration record to `estado = 'en_progreso'`.\n3. Queries `old_db`: `DB::connection('old_db')->table('empresa')->where('id_empresa', ...)->first()`.\n4. Calls `migrarEmpresa()` → reads/writes `old_db` and `mysql`.\n5. Calls `migrarSucursales()` → reads/writes `old_db` and `mysql`.\n6. Commits the transaction.\n7. Updates migration record to `estado = 'completada'`.\n8. On any exception: `DB::rollBack()`, updates migration record to `estado = 'error'` with error details.\n\n---\n\n### 6. `old_db` Configuration\n**File:** `config/database.php` (lines 78-96)\n\n```php\n'old_db' => [\n    'driver'   => env('OLD_DB_CONNECTION'),\n    'host'     => env('OLD_DB_HOST', '127.0.0.1'),\n    'port'     => env('OLD_DB_PORT', '3306'),\n    'database' => env('OLD_DB_DATABASE', 'forge'),\n    'username' => env('OLD_DB_USERNAME', 'forge'),\n    'password' => env('OLD_DB_PASSWORD', ''),\n    'charset'  => 'utf8mb4',\n    // ...\n],\n```\n\nActual `.env` values (confirmed):\n```\nOLD_DB_CONNECTION=mysql\nOLD_DB_HOST=127.0.0.1\nOLD_DB_PORT=3306\nOLD_DB_DATABASE=psicoalianza-dump\nOLD_DB_USERNAME=root\nOLD_DB_PASSWORD=\nQUEUE_CONNECTION=database\n```\n\nThe default `mysql` connection has a **read/write split** configured (`DB_HOST_READ` / `DB_HOST_WRITE`). The `old_db` connection does NOT have this split — it is a plain single-host connection.\n\n---\n\n### 7. The Root Cause: Why `old_db` Works in HTTP but Fails in the Queue Worker\n\nThis is the critical finding. The queue connection is `database` (not `sync`), meaning jobs run in a **separate worker process** (`php artisan queue:work`). Here is what differs between the HTTP request context and the queue worker context:\n\n**Symptom:** `buscarEmpresa` and `validarTamano` (HTTP requests) work fine with `old_db`. The `iniciarMigracion` Job fails when executing in the queue worker.\n\n**Most likely causes, from most to least probable:**\n\n#### Cause A: `.env` is not loaded in the queue worker (most common)\nThe queue worker reads the `.env` at startup and **caches it**. If the `.env` was modified after the worker started, or if the worker was started before `OLD_DB_*` vars were added, the worker process has a stale or missing config. Running `php artisan queue:restart` is required after any `.env` change.\n\n#### Cause B: The `old_db` driver key is empty/wrong\nIn `config/database.php`, the `old_db` driver is `env('OLD_DB_CONNECTION')` with **no default fallback** (unlike `mysql` which defaults to `'mysql'`). If `OLD_DB_CONNECTION` is not set in the worker environment, the driver becomes `null`, causing a connection failure. In the HTTP request, if the config is cached or bootstrapped fresh each request it may see the variable; the long-running worker may not.\n\n#### Cause C: `DB::beginTransaction()` cross-connection interference\nThe controller wraps `iniciarMigracion()` in a `DB::beginTransaction()` on the default `mysql` connection. Inside the service, `inactivarEmpresaEnBaseDatosVieja()` opens a **separate** `DB::connection('old_db')` and runs an `UPDATE`. This `old_db` update is **outside the controller's transaction**, so it is committed immediately. If the controller's transaction then rolls back (due to a downstream error), the `en_mantenimiento = 1` update on `old_db` is **already committed** and the rollback handler in the service (`reactivarEmpresaEnBaseDatosVieja`) must execute successfully to undo it. If that second `old_db` call also fails, the legacy DB is left in maintenance mode permanently.\n\n#### Cause D: The Job constructor queries the DB at dispatch time\nThe `__construct` immediately calls `getPorEmpresaAntiguaEstado($empresa_antigua_id, 'pendiente')`. This runs **inside the HTTP request** (at dispatch time). The result (`migracion_empresa_id`) is serialized into the job payload. When the worker deserializes the Job and runs `handle()`, it has the stored ID but re-instantiates repositories via `new` (not from a serialized instance). This is fine, but if the query in the constructor fails (e.g., at dispatch time the record hasn't been committed yet because the controller's `DB::beginTransaction()` hasn't committed), `$migracion_empresa_id` would be `null` and `handle()` would silently return on line 86: `if (is_null($this->migracion_empresa_id)) { return; }`.\n\n**The dispatch happens BEFORE `DB::commit()`** — trace in the service:\n```php\n// Line 93 in Service:\n$migracion = MigracionEmpresa::create([...]); // INSERT inside open transaction\n// ...\nMigrarEmpresasSucursalesUsuariosJob::dispatch($empresa_antigua_id); // dispatches here\n// returns to controller\n// Controller calls DB::commit()  ← COMMIT happens AFTER dispatch\n```\n\nThe Job constructor immediately queries for the migration record with `estado = 'pendiente'`. Since the controller's transaction hasn't committed yet at dispatch time, the `MigracionEmpresa` record **may not be visible** to the Job's constructor query (depending on isolation level). This means `migracion_empresa_id` is `null`, and `handle()` silently does nothing.\n\n**This is the most concrete bug:** The `MigracionEmpresa::create()` happens inside an open `DB::beginTransaction()` in the controller, `dispatch()` is called next (which immediately runs the constructor query on the same uncommitted data), and `DB::commit()` only fires back in the controller after the service method returns. The job gets a `null` ID and silently exits.\n\n---\n\n### Summary of Files\n\n| Role | File |\n|---|---|\n| Routes | `routes/web.php` lines 230-233 |\n| Controller | `app/Http/Controllers/Empresas/MigracionEmpresaController.php` |\n| Service | `app/Http/Services/Empresas/MigracionEmpresaService.php` |\n| Repository | `app/Http/Repositories/Empresas/MigracionEmpresaRepository.php` |\n| Job | `app/Jobs/Migraciones/MigrarEmpresasSucursalesUsuariosJob.php` |\n| DB Config | `config/database.php` (lines 78-96 for `old_db`) |\n| Queue Config | `config/queue.php` (default: `database` driver) |"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":714,"cache_read_input_tokens":64642,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":714},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYCTfLpKu6BNQXNoQb6Md","type":"assistant","uuid":"cadad2be-047a-4d3d-b220-c4634c6446a6","timestamp":"2026-02-16T21:31:16.378Z"}
