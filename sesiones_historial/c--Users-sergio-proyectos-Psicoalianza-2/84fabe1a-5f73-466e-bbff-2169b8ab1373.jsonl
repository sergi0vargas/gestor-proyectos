{"type":"file-history-snapshot","messageId":"45492e3c-82e4-48c1-a07d-28b33087fddb","snapshot":{"messageId":"45492e3c-82e4-48c1-a07d-28b33087fddb","trackedFileBackups":{},"timestamp":"2026-01-22T19:34:10.786Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","type":"user","message":{"role":"user","content":"@app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php Corrige espacio, saltos de linea inecesarios. y corre pint sobre este archivo"},"uuid":"45492e3c-82e4-48c1-a07d-28b33087fddb","timestamp":"2026-01-22T19:34:10.773Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"45492e3c-82e4-48c1-a07d-28b33087fddb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que corrija los espacios y saltos de línea innecesarios en el archivo ActivarEInactivarPlanesCommand.php y luego ejecute Laravel Pint sobre él.\n\nVoy a revisar el archivo que ya leí y identificar los problemas de formato:\n\n1. Hay líneas en blanco innecesarias entre declaraciones\n2. Hay espacios en blanco al final de algunas líneas\n3. Hay saltos de línea innecesarios dentro de condiciones\n\nDéjame identificar los problemas específicos:\n\n1. Línea 93-94: Comentario seguido de línea en blanco antes del código\n2. Línea 105-107: Comentario dentro del if con línea en blanco\n3. Línea 120-121: Comentario con línea en blanco\n4. Línea 129-131: Comentario con línea en blanco\n5. Línea 190-191: Comentario con línea en blanco\n6. Línea 193-195: Comentario con línea en blanco\n7. Línea 201-203: Comentario con línea en blanco\n8. Línea 232-235: Condición con saltos de línea innecesarios\n9. Línea 252-255: Condición con saltos de línea innecesarios\n10. Línea 264-267: Condición con saltos de línea innecesarios\n\nTambién veo que hay líneas vacías después de comentarios que deberían eliminarse.\n\nVoy a hacer las ediciones necesarias y luego correr pint.","signature":"EswKCkYICxgCKkCJegB1ONMRndFZMVfGqfSdOgs6zcS8bgd55G47NN4GHHb/E8hLfobQzSPUu7XJM7t66UWZhNYlI1KT7dDvmltBEgxLjQjVhGx7MqzGoDcaDChJYTITyKiKYdQghCIweW9CyvdhofzFwaWFS2jCq7onDpbu+DfHAWeYDNo9n75oXa89UFvd+kmJjp3ml/FTKrMJiYlenv3xfiAjb8xmTMEZebPmx4IizBARv9wpS6ko4aMLixbLG7m95fJ236aYGfJnoF2+WA2Gvh1YnKlK63sNlof2uqDIL//bH0D8ZTTlEHD3SlSxJMM4Kp8Dzth6KFJsOXLzb8whW9WZjRcuIWem1hA+DoXUCEv7cQtgKCxRKEDdsiaGJ5Qs6lflz5c0/5ohRhXI6wpNPhVgCJulADqso4hCMXmr46Jh62AgzsS/Fhfwk7/W9yZ+fYdC/H9en4SJixL/7I1qukVnKFoWZXw6NC6KbbpzaHjqaO3+U4IIu1QEVFKFOJCp19NCyWd8aSuH2CXBvTss4Rs/N14ASTRoBF2wIVgVIKXZ0UZIVhLEil5zVwvfRKVvOWbGiNsRqDGzfRTOk+3K8QcSZp7UmzylKQWQw4BlOPRJYVBFyu4PVcZxnsAaZEdJXMT66+O81a8pHEHXV6KXnU8icZxItRy1NDLNR+DvTOTrc/sAM2hJqJXkLfEAM/huWta1NwZy40OurVrS3IP/VnXJlqGML7OfDuNgwDUTT0brVKW5Ne0dCdmx77LrVhYy4mP1B2uCNfeGwj2/i1oYTpJBBSXPGLVleXz3UEgtpa7cRRLWPyOP/PL5kAb8jlxB/T/6A59epP1oXm6gvoRbmjQoI/OkGmNsKeuIMLro2ZbBoROiZxcYoN5USvVqK0M4OgLy6EmLZdiHcSMlUHIaoDjwFwHcw9R4BUpk8d8o3Z6+jMyk9YyPlE93qMl4JoWf6BQ828EwDziagp2tKsRp7XEl1TtkdaRh+N8CWhV4/EgOjcaRkCtoP3GPeVYUVCcbX4CpPoVHXUpXNzXBiCpvnzcameTadtQWwqVGaM1/4agMhS37edPJZw2nS596vo0s9XfB/BY6xsHhDR761Pu+WDp6bLHUWfv6eGT4VNC1OHfnDxZrCDZMpngkna3HL1i+n/x47gICxxUqrr1j0spHLzPhqiLjlttqTcKe855cIcScPySyfCy11QA+V8RgOmvQLlaVwZFtljf822TkfrUGGS6ZbfIa/FwxAvP3kpTdkJzxLIq9Mavsum4Nd0hFAjPlhczNOFGcub0cnES8JQ53yJgmLgc2iSwnfXzdGqrPhFTFN4UsIgmscR0C2nQnMX0wkIzlWFOPLIRza8vm7wh2z01KNgdXQn6QAXoAC6IkTxpYfdWSLuqLFw2f/Y0UdRN9HbWJTiDNDR2gTqMuAVe6NGyRkLqEHYH/rxyBtjxHKeD0/oCRVu5lY9rhFSWnmbLI3R3+78t5gRhiO5F75iltGct8YJsja20zVYlwao8MF2uuHeC8rq0Kqy7XlfpUa7s7pxuD2E7ithqgy54Jt9z66u59CXx9wiNfspNKkE3JcfBdMg4Q6ojTiG6C5hO9MN4NfZYMhq/YHxZmR0p0nBihaxB9fXgQMAlhX8MV0YhM0ybOicjzSLcnFc3SRtYDCjkngokubgDeXUvrwO/gE6XRAO0Z3pVaUyj8Za3bfBgYSOHJHH2d4xIXQarPhSlxFJgj+DOX/Ra66wuMNu8sYc6eoPA3UcppMeA52jgDOCzmE9YR7YkxQr9pHTdI4c3KhLrvtQZc6pnE52G9sjyPGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"5a45421c-88f9-4dcd-8f2c-b7ea7bcefe9e","timestamp":"2026-01-22T19:34:19.016Z"}
{"parentUuid":"5a45421c-88f9-4dcd-8f2c-b7ea7bcefe9e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a corregir los espacios y saltos de línea innecesarios en el archivo."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"f92ca3c4-4d76-4b66-843e-fed8b05b0f4c","timestamp":"2026-01-22T19:34:19.326Z"}
{"parentUuid":"f92ca3c4-4d76-4b66-843e-fed8b05b0f4c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SohQdFymkASt11FKiG6FhU","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","old_string":"        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');","new_string":"        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"b8580b02-32c5-4af7-9022-d8c616d7b164","timestamp":"2026-01-22T19:34:22.451Z"}
{"parentUuid":"b8580b02-32c5-4af7-9022-d8c616d7b164","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013MWgg3ZFPXHe7243mKa3qz","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","old_string":"                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);","new_string":"                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"f62f4479-c407-4918-b3c1-bc00da7e895e","timestamp":"2026-01-22T19:34:25.507Z"}
{"parentUuid":"f62f4479-c407-4918-b3c1-bc00da7e895e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019Nj1BBG7J1gCWC94rBs6W3","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","old_string":"                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {","new_string":"                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"aec27fd0-6671-464c-bb98-52a07bbe89e9","timestamp":"2026-01-22T19:34:27.818Z"}
{"parentUuid":"aec27fd0-6671-464c-bb98-52a07bbe89e9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01H5KPHPx5wGraDMUGv5jzPj","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","old_string":"                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);","new_string":"                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"390eb8af-7318-49d2-9097-a78f70ab8e88","timestamp":"2026-01-22T19:34:30.096Z"}
{"parentUuid":"390eb8af-7318-49d2-9097-a78f70ab8e88","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019P67PpvXS9LxV4qHJNsBzK","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","old_string":"    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {","new_string":"    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"5ac95e9b-aa69-44e0-8489-865e6ff3671b","timestamp":"2026-01-22T19:34:33.924Z"}
{"parentUuid":"5ac95e9b-aa69-44e0-8489-865e6ff3671b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013HQbsf3jk6KNEY4Z2KJCbm","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","old_string":"            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n\n            $this->empresa_plan_repositorio->actualizar(","new_string":"            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n            $this->empresa_plan_repositorio->actualizar("}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"c0021b42-c57b-45f9-a46f-e24089bec177","timestamp":"2026-01-22T19:34:35.578Z"}
{"parentUuid":"c0021b42-c57b-45f9-a46f-e24089bec177","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SGM6EuikAnQbcb7vi3Woaf","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","old_string":"                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n\n                    && $empresa_plan->creditos_restantes > 0\n                ) {","new_string":"                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n                    && $empresa_plan->creditos_restantes > 0\n                ) {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"ac008e05-5756-44f9-ba5a-454dbaa0e445","timestamp":"2026-01-22T19:34:37.772Z"}
{"parentUuid":"ac008e05-5756-44f9-ba5a-454dbaa0e445","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QTzpaUfDf8ckmoQEstzrfe","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","old_string":"            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n\n                && $total_consumido < $total_consumos_disponibles\n            ) {","new_string":"            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n                && $total_consumido < $total_consumos_disponibles\n            ) {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"cff8d9b6-7ca9-4733-be28-3b056bf6fb85","timestamp":"2026-01-22T19:34:40.000Z"}
{"parentUuid":"cff8d9b6-7ca9-4733-be28-3b056bf6fb85","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Srz8c3pms6xwWMHzbHjcQ8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QZuhJicv7MgcPd1xBPDmdT","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","old_string":"            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {","new_string":"            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":29839,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29839,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNyaZitC21vt5msjycEZ","type":"assistant","uuid":"57b34aeb-fc3e-41b2-a021-436dc44bd52e","timestamp":"2026-01-22T19:34:42.248Z"}
{"type":"file-history-snapshot","messageId":"b8580b02-32c5-4af7-9022-d8c616d7b164","snapshot":{"messageId":"45492e3c-82e4-48c1-a07d-28b33087fddb","trackedFileBackups":{"app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php":{"backupFileName":"b4706ac638207036@v1","version":1,"backupTime":"2026-01-22T19:34:49.737Z"}},"timestamp":"2026-01-22T19:34:10.786Z"},"isSnapshotUpdate":true}
{"parentUuid":"b8580b02-32c5-4af7-9022-d8c616d7b164","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SohQdFymkASt11FKiG6FhU","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php has been updated successfully."}]},"uuid":"3127dfad-da1d-4f11-b231-b0c2a9830b69","timestamp":"2026-01-22T19:34:49.735Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","oldString":"        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');","newString":"        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');","originalFile":"<?php\n\nnamespace App\\Console\\Commands\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Console\\Command;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\n/**\n * Comando para gestionar la activación e inactivación de los planes de las empresas.\n * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n * completa de los estados de los planes con sus descripciones.\n *\n * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n * días fueron recomendados desde comercial.\n * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n * una vez se sube el archivo, el plan pasa a estar activo.\n * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n *\n * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n *\n * @package App\\Console\\Commands\\Empresas\n * @version 0.0.3\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nclass ActivarEInactivarPlanesCommand extends Command\n{\n    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n\n    /**\n     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n\n    /**\n     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private EmpresaPlanRepository $empresa_plan_repositorio,\n        private EmpresaPlanService $empresa_plan_servicio\n    ) {\n        parent::__construct();\n    }\n\n    /**\n     * Activar e inactivar los planes de las empresas.\n     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function handle() {\n        $empresa_id = $this->argument('empresa_id');\n        $fecha_actual = now()->startOfDay();\n        $request = new Request([\n            'estados_ids' => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n            'ordenar_por' => 'created_at',\n            'ordenar_sentido' => 'ASC'\n        ]);\n\n        if (!is_null($empresa_id)) {\n            $request->merge(['empresa_id' => $empresa_id]);\n        }\n\n        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n\n        try {\n            DB::beginTransaction();\n\n            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n                foreach ($planes as $plan) {\n                    $empresa_id = $plan->empresa_id;\n\n                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n\n                            if ($plan->tieneCreditos()) {\n                                $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n                            }\n                        } else {\n                            $this->establecerPlanProximoAVencer($plan);\n\n                            if (!$plan->esSoloPlanCreditos()) {\n                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                            }\n                        }\n\n                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n                        if ($plan->esSoloPlanCreditos()) {\n                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n\n                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                            }\n                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                                continue;\n                            }\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                        }\n                    }\n                }\n            }\n\n            DB::commit();\n\n            $this->info('Planes de empresas actualizados correctamente');\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $this->error('Error al actualizar los planes de empresas');\n        }\n    }\n\n    /**\n     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return bool\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function planVencido(EmpresaPlan $empresa_plan): bool {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            return $empresa_plan->creditosAgotados();\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas)\n                && (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n        } else {\n            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n            // tienen una fecha de inicio posterior a la actual).\n            $fecha_actual = now()->startOfDay();\n            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n        }\n    }\n\n    /**\n     * Establecer las fechas de vigencia del próximo plan del cliente.\n     *\n     * @param int $empresa_id Id de la empresa.\n     * @param int $tipo_prueba_id Id del tipo de prueba.\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n                $plan_proximo->vigencia_dias,\n                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                [\n                    'fecha_inicio' => $fechas['fecha_inicio'],\n                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n                ]\n            );\n        }\n    }\n\n    /**\n     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n     *\n     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            $total_creditos = $empresa_plan->creditos;\n\n            if ($total_creditos > 0) {\n                $creditos_consumidos = $total_creditos - $empresa_plan->creditos_restantes;\n\n                $porcentaje_consumido = ($creditos_consumidos / $total_creditos) * 100;\n\n                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n\n                    && $empresa_plan->creditos_restantes > 0\n                ) {\n                    $this->empresa_plan_repositorio->actualizar(\n                        $empresa_plan->id,\n                        ['estado_id' => Plan::ESTADO_POR_VENCER_ID]\n                    );\n                }\n            }\n\n            return;\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n\n            $total_consumido = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n\n            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n\n                && $total_consumido < $total_consumos_disponibles\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        } else {\n            $fecha_actual = now()->startOfDay();\n\n            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n\n            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        }\n    }\n\n    /**\n     * Activar el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     *\n     * @param int|null $tipo_prueba_id ID del tipo de prueba.\n     *\n     * @return void\n     *\n     * @author Sergio Vargas\n     */\n    private function activarPlanCreditoProximo(int $empresa_id, ?int $tipo_prueba_id): void {\n        $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan_proximo)) {\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n            );\n        }\n    }\n}\n","structuredPatch":[{"oldStart":91,"oldLines":7,"newStart":91,"newLines":6,"lines":["         }"," ","         // Obtener los planes de empresas y agruparlos por tipo de prueba.","-","         $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');"," ","         try {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"b8580b02-32c5-4af7-9022-d8c616d7b164"}
{"parentUuid":"f62f4479-c407-4918-b3c1-bc00da7e895e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013MWgg3ZFPXHe7243mKa3qz","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php has been updated successfully."}]},"uuid":"27b1a2f0-ebc5-46e6-bca8-d525e81bdfc1","timestamp":"2026-01-22T19:34:50.651Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","oldString":"                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);","newString":"                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);","originalFile":"<?php\n\nnamespace App\\Console\\Commands\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Console\\Command;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\n/**\n * Comando para gestionar la activación e inactivación de los planes de las empresas.\n * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n * completa de los estados de los planes con sus descripciones.\n *\n * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n * días fueron recomendados desde comercial.\n * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n * una vez se sube el archivo, el plan pasa a estar activo.\n * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n *\n * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n *\n * @package App\\Console\\Commands\\Empresas\n * @version 0.0.3\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nclass ActivarEInactivarPlanesCommand extends Command\n{\n    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n\n    /**\n     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n\n    /**\n     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private EmpresaPlanRepository $empresa_plan_repositorio,\n        private EmpresaPlanService $empresa_plan_servicio\n    ) {\n        parent::__construct();\n    }\n\n    /**\n     * Activar e inactivar los planes de las empresas.\n     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function handle() {\n        $empresa_id = $this->argument('empresa_id');\n        $fecha_actual = now()->startOfDay();\n        $request = new Request([\n            'estados_ids' => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n            'ordenar_por' => 'created_at',\n            'ordenar_sentido' => 'ASC'\n        ]);\n\n        if (!is_null($empresa_id)) {\n            $request->merge(['empresa_id' => $empresa_id]);\n        }\n\n        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n\n        try {\n            DB::beginTransaction();\n\n            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n                foreach ($planes as $plan) {\n                    $empresa_id = $plan->empresa_id;\n\n                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n\n                            if ($plan->tieneCreditos()) {\n                                $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n                            }\n                        } else {\n                            $this->establecerPlanProximoAVencer($plan);\n\n                            if (!$plan->esSoloPlanCreditos()) {\n                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                            }\n                        }\n\n                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n                        if ($plan->esSoloPlanCreditos()) {\n                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n\n                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                            }\n                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                                continue;\n                            }\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                        }\n                    }\n                }\n            }\n\n            DB::commit();\n\n            $this->info('Planes de empresas actualizados correctamente');\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $this->error('Error al actualizar los planes de empresas');\n        }\n    }\n\n    /**\n     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return bool\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function planVencido(EmpresaPlan $empresa_plan): bool {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            return $empresa_plan->creditosAgotados();\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas)\n                && (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n        } else {\n            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n            // tienen una fecha de inicio posterior a la actual).\n            $fecha_actual = now()->startOfDay();\n            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n        }\n    }\n\n    /**\n     * Establecer las fechas de vigencia del próximo plan del cliente.\n     *\n     * @param int $empresa_id Id de la empresa.\n     * @param int $tipo_prueba_id Id del tipo de prueba.\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n                $plan_proximo->vigencia_dias,\n                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                [\n                    'fecha_inicio' => $fechas['fecha_inicio'],\n                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n                ]\n            );\n        }\n    }\n\n    /**\n     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n     *\n     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            $total_creditos = $empresa_plan->creditos;\n\n            if ($total_creditos > 0) {\n                $creditos_consumidos = $total_creditos - $empresa_plan->creditos_restantes;\n\n                $porcentaje_consumido = ($creditos_consumidos / $total_creditos) * 100;\n\n                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n\n                    && $empresa_plan->creditos_restantes > 0\n                ) {\n                    $this->empresa_plan_repositorio->actualizar(\n                        $empresa_plan->id,\n                        ['estado_id' => Plan::ESTADO_POR_VENCER_ID]\n                    );\n                }\n            }\n\n            return;\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n\n            $total_consumido = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n\n            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n\n                && $total_consumido < $total_consumos_disponibles\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        } else {\n            $fecha_actual = now()->startOfDay();\n\n            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n\n            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        }\n    }\n\n    /**\n     * Activar el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     *\n     * @param int|null $tipo_prueba_id ID del tipo de prueba.\n     *\n     * @return void\n     *\n     * @author Sergio Vargas\n     */\n    private function activarPlanCreditoProximo(int $empresa_id, ?int $tipo_prueba_id): void {\n        $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan_proximo)) {\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n            );\n        }\n    }\n}\n","structuredPatch":[{"oldStart":103,"oldLines":7,"newStart":103,"newLines":6,"lines":["                     if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {","                         if ($this->planVencido($plan)) {","                             // Desactivar el plan si ya ha vencido","-","                             $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);"," ","                             if ($plan->tieneCreditos()) {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"f62f4479-c407-4918-b3c1-bc00da7e895e"}
{"parentUuid":"aec27fd0-6671-464c-bb98-52a07bbe89e9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>String to replace not found in file.\nString:                         // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {</tool_use_error>","is_error":true,"tool_use_id":"toolu_019Nj1BBG7J1gCWC94rBs6W3"}]},"uuid":"97abd6ed-860d-461f-a97b-8fa3d2dc4ab4","timestamp":"2026-01-22T19:34:50.775Z","toolUseResult":"Error: String to replace not found in file.\nString:                         // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {","sourceToolAssistantUUID":"aec27fd0-6671-464c-bb98-52a07bbe89e9"}
{"parentUuid":"390eb8af-7318-49d2-9097-a78f70ab8e88","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01H5KPHPx5wGraDMUGv5jzPj","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php has been updated successfully."}]},"uuid":"ff99d13a-2d01-4064-8e7e-68d93dbc7162","timestamp":"2026-01-22T19:34:51.623Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","oldString":"                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);","newString":"                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);","originalFile":"<?php\n\nnamespace App\\Console\\Commands\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Console\\Command;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\n/**\n * Comando para gestionar la activación e inactivación de los planes de las empresas.\n * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n * completa de los estados de los planes con sus descripciones.\n *\n * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n * días fueron recomendados desde comercial.\n * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n * una vez se sube el archivo, el plan pasa a estar activo.\n * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n *\n * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n *\n * @package App\\Console\\Commands\\Empresas\n * @version 0.0.3\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nclass ActivarEInactivarPlanesCommand extends Command\n{\n    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n\n    /**\n     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n\n    /**\n     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private EmpresaPlanRepository $empresa_plan_repositorio,\n        private EmpresaPlanService $empresa_plan_servicio\n    ) {\n        parent::__construct();\n    }\n\n    /**\n     * Activar e inactivar los planes de las empresas.\n     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function handle() {\n        $empresa_id = $this->argument('empresa_id');\n        $fecha_actual = now()->startOfDay();\n        $request = new Request([\n            'estados_ids' => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n            'ordenar_por' => 'created_at',\n            'ordenar_sentido' => 'ASC'\n        ]);\n\n        if (!is_null($empresa_id)) {\n            $request->merge(['empresa_id' => $empresa_id]);\n        }\n\n        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n\n        try {\n            DB::beginTransaction();\n\n            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n                foreach ($planes as $plan) {\n                    $empresa_id = $plan->empresa_id;\n\n                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n\n                            if ($plan->tieneCreditos()) {\n                                $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n                            }\n                        } else {\n                            $this->establecerPlanProximoAVencer($plan);\n\n                            if (!$plan->esSoloPlanCreditos()) {\n                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                            }\n                        }\n\n                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n                        if ($plan->esSoloPlanCreditos()) {\n                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n\n                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                            }\n                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                                continue;\n                            }\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                        }\n                    }\n                }\n            }\n\n            DB::commit();\n\n            $this->info('Planes de empresas actualizados correctamente');\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $this->error('Error al actualizar los planes de empresas');\n        }\n    }\n\n    /**\n     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return bool\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function planVencido(EmpresaPlan $empresa_plan): bool {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            return $empresa_plan->creditosAgotados();\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas)\n                && (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n        } else {\n            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n            // tienen una fecha de inicio posterior a la actual).\n            $fecha_actual = now()->startOfDay();\n            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n        }\n    }\n\n    /**\n     * Establecer las fechas de vigencia del próximo plan del cliente.\n     *\n     * @param int $empresa_id Id de la empresa.\n     * @param int $tipo_prueba_id Id del tipo de prueba.\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n                $plan_proximo->vigencia_dias,\n                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                [\n                    'fecha_inicio' => $fechas['fecha_inicio'],\n                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n                ]\n            );\n        }\n    }\n\n    /**\n     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n     *\n     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            $total_creditos = $empresa_plan->creditos;\n\n            if ($total_creditos > 0) {\n                $creditos_consumidos = $total_creditos - $empresa_plan->creditos_restantes;\n\n                $porcentaje_consumido = ($creditos_consumidos / $total_creditos) * 100;\n\n                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n\n                    && $empresa_plan->creditos_restantes > 0\n                ) {\n                    $this->empresa_plan_repositorio->actualizar(\n                        $empresa_plan->id,\n                        ['estado_id' => Plan::ESTADO_POR_VENCER_ID]\n                    );\n                }\n            }\n\n            return;\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n\n            $total_consumido = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n\n            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n\n                && $total_consumido < $total_consumos_disponibles\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        } else {\n            $fecha_actual = now()->startOfDay();\n\n            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n\n            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        }\n    }\n\n    /**\n     * Activar el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     *\n     * @param int|null $tipo_prueba_id ID del tipo de prueba.\n     *\n     * @return void\n     *\n     * @author Sergio Vargas\n     */\n    private function activarPlanCreditoProximo(int $empresa_id, ?int $tipo_prueba_id): void {\n        $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan_proximo)) {\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n            );\n        }\n    }\n}\n","structuredPatch":[{"oldStart":126,"oldLines":7,"newStart":126,"newLines":6,"lines":["                             }","                         } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {","                             // Verificar si ya existe un plan activo del mismo tipo de prueba.","-","                             $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);"," ","                             if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"390eb8af-7318-49d2-9097-a78f70ab8e88"}
{"parentUuid":"5ac95e9b-aa69-44e0-8489-865e6ff3671b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019P67PpvXS9LxV4qHJNsBzK","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php has been updated successfully."}]},"uuid":"e0451e53-a96a-4809-a1f8-895c4838e378","timestamp":"2026-01-22T19:34:52.484Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","oldString":"    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {","newString":"    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {","originalFile":"<?php\n\nnamespace App\\Console\\Commands\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Console\\Command;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\n/**\n * Comando para gestionar la activación e inactivación de los planes de las empresas.\n * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n * completa de los estados de los planes con sus descripciones.\n *\n * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n * días fueron recomendados desde comercial.\n * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n * una vez se sube el archivo, el plan pasa a estar activo.\n * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n *\n * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n *\n * @package App\\Console\\Commands\\Empresas\n * @version 0.0.3\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nclass ActivarEInactivarPlanesCommand extends Command\n{\n    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n\n    /**\n     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n\n    /**\n     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private EmpresaPlanRepository $empresa_plan_repositorio,\n        private EmpresaPlanService $empresa_plan_servicio\n    ) {\n        parent::__construct();\n    }\n\n    /**\n     * Activar e inactivar los planes de las empresas.\n     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function handle() {\n        $empresa_id = $this->argument('empresa_id');\n        $fecha_actual = now()->startOfDay();\n        $request = new Request([\n            'estados_ids' => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n            'ordenar_por' => 'created_at',\n            'ordenar_sentido' => 'ASC'\n        ]);\n\n        if (!is_null($empresa_id)) {\n            $request->merge(['empresa_id' => $empresa_id]);\n        }\n\n        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n\n        try {\n            DB::beginTransaction();\n\n            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n                foreach ($planes as $plan) {\n                    $empresa_id = $plan->empresa_id;\n\n                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n\n                            if ($plan->tieneCreditos()) {\n                                $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n                            }\n                        } else {\n                            $this->establecerPlanProximoAVencer($plan);\n\n                            if (!$plan->esSoloPlanCreditos()) {\n                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                            }\n                        }\n\n                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n                        if ($plan->esSoloPlanCreditos()) {\n                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n\n                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                            }\n                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                                continue;\n                            }\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                        }\n                    }\n                }\n            }\n\n            DB::commit();\n\n            $this->info('Planes de empresas actualizados correctamente');\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $this->error('Error al actualizar los planes de empresas');\n        }\n    }\n\n    /**\n     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return bool\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function planVencido(EmpresaPlan $empresa_plan): bool {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            return $empresa_plan->creditosAgotados();\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas)\n                && (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n        } else {\n            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n            // tienen una fecha de inicio posterior a la actual).\n            $fecha_actual = now()->startOfDay();\n            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n        }\n    }\n\n    /**\n     * Establecer las fechas de vigencia del próximo plan del cliente.\n     *\n     * @param int $empresa_id Id de la empresa.\n     * @param int $tipo_prueba_id Id del tipo de prueba.\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n                $plan_proximo->vigencia_dias,\n                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                [\n                    'fecha_inicio' => $fechas['fecha_inicio'],\n                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n                ]\n            );\n        }\n    }\n\n    /**\n     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n     *\n     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            $total_creditos = $empresa_plan->creditos;\n\n            if ($total_creditos > 0) {\n                $creditos_consumidos = $total_creditos - $empresa_plan->creditos_restantes;\n\n                $porcentaje_consumido = ($creditos_consumidos / $total_creditos) * 100;\n\n                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n\n                    && $empresa_plan->creditos_restantes > 0\n                ) {\n                    $this->empresa_plan_repositorio->actualizar(\n                        $empresa_plan->id,\n                        ['estado_id' => Plan::ESTADO_POR_VENCER_ID]\n                    );\n                }\n            }\n\n            return;\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n\n            $total_consumido = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n\n            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n\n                && $total_consumido < $total_consumos_disponibles\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        } else {\n            $fecha_actual = now()->startOfDay();\n\n            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n\n            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        }\n    }\n\n    /**\n     * Activar el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     *\n     * @param int|null $tipo_prueba_id ID del tipo de prueba.\n     *\n     * @return void\n     *\n     * @author Sergio Vargas\n     */\n    private function activarPlanCreditoProximo(int $empresa_id, ?int $tipo_prueba_id): void {\n        $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan_proximo)) {\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n            );\n        }\n    }\n}\n","structuredPatch":[{"oldStart":185,"oldLines":11,"newStart":185,"newLines":9,"lines":["      */","     private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {","         // Se busca el próximo plan","-","         $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);"," ","         // Se verifica si existe un próximo plan y si es ilimitado","-","         if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {","             $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(","                 $plan_proximo->vigencia_dias,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"5ac95e9b-aa69-44e0-8489-865e6ff3671b"}
{"parentUuid":"c0021b42-c57b-45f9-a46f-e24089bec177","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013HQbsf3jk6KNEY4Z2KJCbm","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php has been updated successfully."}]},"uuid":"189a3dfd-549e-4043-b412-314fa6be56fb","timestamp":"2026-01-22T19:34:53.419Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","oldString":"            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n\n            $this->empresa_plan_repositorio->actualizar(","newString":"            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n            $this->empresa_plan_repositorio->actualizar(","originalFile":"<?php\n\nnamespace App\\Console\\Commands\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Console\\Command;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\n/**\n * Comando para gestionar la activación e inactivación de los planes de las empresas.\n * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n * completa de los estados de los planes con sus descripciones.\n *\n * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n * días fueron recomendados desde comercial.\n * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n * una vez se sube el archivo, el plan pasa a estar activo.\n * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n *\n * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n *\n * @package App\\Console\\Commands\\Empresas\n * @version 0.0.3\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nclass ActivarEInactivarPlanesCommand extends Command\n{\n    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n\n    /**\n     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n\n    /**\n     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private EmpresaPlanRepository $empresa_plan_repositorio,\n        private EmpresaPlanService $empresa_plan_servicio\n    ) {\n        parent::__construct();\n    }\n\n    /**\n     * Activar e inactivar los planes de las empresas.\n     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function handle() {\n        $empresa_id = $this->argument('empresa_id');\n        $fecha_actual = now()->startOfDay();\n        $request = new Request([\n            'estados_ids' => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n            'ordenar_por' => 'created_at',\n            'ordenar_sentido' => 'ASC'\n        ]);\n\n        if (!is_null($empresa_id)) {\n            $request->merge(['empresa_id' => $empresa_id]);\n        }\n\n        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n\n        try {\n            DB::beginTransaction();\n\n            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n                foreach ($planes as $plan) {\n                    $empresa_id = $plan->empresa_id;\n\n                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n\n                            if ($plan->tieneCreditos()) {\n                                $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n                            }\n                        } else {\n                            $this->establecerPlanProximoAVencer($plan);\n\n                            if (!$plan->esSoloPlanCreditos()) {\n                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                            }\n                        }\n\n                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n                        if ($plan->esSoloPlanCreditos()) {\n                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n\n                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                            }\n                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                                continue;\n                            }\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                        }\n                    }\n                }\n            }\n\n            DB::commit();\n\n            $this->info('Planes de empresas actualizados correctamente');\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $this->error('Error al actualizar los planes de empresas');\n        }\n    }\n\n    /**\n     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return bool\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function planVencido(EmpresaPlan $empresa_plan): bool {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            return $empresa_plan->creditosAgotados();\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas)\n                && (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n        } else {\n            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n            // tienen una fecha de inicio posterior a la actual).\n            $fecha_actual = now()->startOfDay();\n            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n        }\n    }\n\n    /**\n     * Establecer las fechas de vigencia del próximo plan del cliente.\n     *\n     * @param int $empresa_id Id de la empresa.\n     * @param int $tipo_prueba_id Id del tipo de prueba.\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n                $plan_proximo->vigencia_dias,\n                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                [\n                    'fecha_inicio' => $fechas['fecha_inicio'],\n                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n                ]\n            );\n        }\n    }\n\n    /**\n     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n     *\n     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            $total_creditos = $empresa_plan->creditos;\n\n            if ($total_creditos > 0) {\n                $creditos_consumidos = $total_creditos - $empresa_plan->creditos_restantes;\n\n                $porcentaje_consumido = ($creditos_consumidos / $total_creditos) * 100;\n\n                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n\n                    && $empresa_plan->creditos_restantes > 0\n                ) {\n                    $this->empresa_plan_repositorio->actualizar(\n                        $empresa_plan->id,\n                        ['estado_id' => Plan::ESTADO_POR_VENCER_ID]\n                    );\n                }\n            }\n\n            return;\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n\n            $total_consumido = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n\n            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n\n                && $total_consumido < $total_consumos_disponibles\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        } else {\n            $fecha_actual = now()->startOfDay();\n\n            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n\n            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        }\n    }\n\n    /**\n     * Activar el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     *\n     * @param int|null $tipo_prueba_id ID del tipo de prueba.\n     *\n     * @return void\n     *\n     * @author Sergio Vargas\n     */\n    private function activarPlanCreditoProximo(int $empresa_id, ?int $tipo_prueba_id): void {\n        $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan_proximo)) {\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n            );\n        }\n    }\n}\n","structuredPatch":[{"oldStart":195,"oldLines":7,"newStart":195,"newLines":6,"lines":["             );"," ","             // Se establecen las fechas de vigencia del la suscripción al plan","-","             $this->empresa_plan_repositorio->actualizar(","                 $plan_proximo->id,","                 ["]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"c0021b42-c57b-45f9-a46f-e24089bec177"}
{"parentUuid":"ac008e05-5756-44f9-ba5a-454dbaa0e445","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SGM6EuikAnQbcb7vi3Woaf","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php has been updated successfully."}]},"uuid":"4afe2851-77c6-43eb-a687-3ab48a52104f","timestamp":"2026-01-22T19:34:54.605Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","oldString":"                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n\n                    && $empresa_plan->creditos_restantes > 0\n                ) {","newString":"                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n                    && $empresa_plan->creditos_restantes > 0\n                ) {","originalFile":"<?php\n\nnamespace App\\Console\\Commands\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Console\\Command;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\n/**\n * Comando para gestionar la activación e inactivación de los planes de las empresas.\n * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n * completa de los estados de los planes con sus descripciones.\n *\n * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n * días fueron recomendados desde comercial.\n * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n * una vez se sube el archivo, el plan pasa a estar activo.\n * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n *\n * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n *\n * @package App\\Console\\Commands\\Empresas\n * @version 0.0.3\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nclass ActivarEInactivarPlanesCommand extends Command\n{\n    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n\n    /**\n     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n\n    /**\n     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private EmpresaPlanRepository $empresa_plan_repositorio,\n        private EmpresaPlanService $empresa_plan_servicio\n    ) {\n        parent::__construct();\n    }\n\n    /**\n     * Activar e inactivar los planes de las empresas.\n     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function handle() {\n        $empresa_id = $this->argument('empresa_id');\n        $fecha_actual = now()->startOfDay();\n        $request = new Request([\n            'estados_ids' => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n            'ordenar_por' => 'created_at',\n            'ordenar_sentido' => 'ASC'\n        ]);\n\n        if (!is_null($empresa_id)) {\n            $request->merge(['empresa_id' => $empresa_id]);\n        }\n\n        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n\n        try {\n            DB::beginTransaction();\n\n            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n                foreach ($planes as $plan) {\n                    $empresa_id = $plan->empresa_id;\n\n                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n\n                            if ($plan->tieneCreditos()) {\n                                $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n                            }\n                        } else {\n                            $this->establecerPlanProximoAVencer($plan);\n\n                            if (!$plan->esSoloPlanCreditos()) {\n                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                            }\n                        }\n\n                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n                        if ($plan->esSoloPlanCreditos()) {\n                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n\n                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                            }\n                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                                continue;\n                            }\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                        }\n                    }\n                }\n            }\n\n            DB::commit();\n\n            $this->info('Planes de empresas actualizados correctamente');\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $this->error('Error al actualizar los planes de empresas');\n        }\n    }\n\n    /**\n     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return bool\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function planVencido(EmpresaPlan $empresa_plan): bool {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            return $empresa_plan->creditosAgotados();\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas)\n                && (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n        } else {\n            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n            // tienen una fecha de inicio posterior a la actual).\n            $fecha_actual = now()->startOfDay();\n            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n        }\n    }\n\n    /**\n     * Establecer las fechas de vigencia del próximo plan del cliente.\n     *\n     * @param int $empresa_id Id de la empresa.\n     * @param int $tipo_prueba_id Id del tipo de prueba.\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n                $plan_proximo->vigencia_dias,\n                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                [\n                    'fecha_inicio' => $fechas['fecha_inicio'],\n                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n                ]\n            );\n        }\n    }\n\n    /**\n     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n     *\n     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            $total_creditos = $empresa_plan->creditos;\n\n            if ($total_creditos > 0) {\n                $creditos_consumidos = $total_creditos - $empresa_plan->creditos_restantes;\n\n                $porcentaje_consumido = ($creditos_consumidos / $total_creditos) * 100;\n\n                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n\n                    && $empresa_plan->creditos_restantes > 0\n                ) {\n                    $this->empresa_plan_repositorio->actualizar(\n                        $empresa_plan->id,\n                        ['estado_id' => Plan::ESTADO_POR_VENCER_ID]\n                    );\n                }\n            }\n\n            return;\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n\n            $total_consumido = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n\n            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n\n                && $total_consumido < $total_consumos_disponibles\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        } else {\n            $fecha_actual = now()->startOfDay();\n\n            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n\n            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        }\n    }\n\n    /**\n     * Activar el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     *\n     * @param int|null $tipo_prueba_id ID del tipo de prueba.\n     *\n     * @return void\n     *\n     * @author Sergio Vargas\n     */\n    private function activarPlanCreditoProximo(int $empresa_id, ?int $tipo_prueba_id): void {\n        $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan_proximo)) {\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n            );\n        }\n    }\n}\n","structuredPatch":[{"oldStart":225,"oldLines":7,"newStart":225,"newLines":6,"lines":[" ","                 if (","                     $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER","-","                     && $empresa_plan->creditos_restantes > 0","                 ) {","                     $this->empresa_plan_repositorio->actualizar("]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"ac008e05-5756-44f9-ba5a-454dbaa0e445"}
{"parentUuid":"cff8d9b6-7ca9-4733-be28-3b056bf6fb85","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QTzpaUfDf8ckmoQEstzrfe","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php has been updated successfully."}]},"uuid":"ac52c98d-b537-43ff-a6d5-7d1717952125","timestamp":"2026-01-22T19:34:55.631Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","oldString":"            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n\n                && $total_consumido < $total_consumos_disponibles\n            ) {","newString":"            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n                && $total_consumido < $total_consumos_disponibles\n            ) {","originalFile":"<?php\n\nnamespace App\\Console\\Commands\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Console\\Command;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\n/**\n * Comando para gestionar la activación e inactivación de los planes de las empresas.\n * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n * completa de los estados de los planes con sus descripciones.\n *\n * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n * días fueron recomendados desde comercial.\n * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n * una vez se sube el archivo, el plan pasa a estar activo.\n * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n *\n * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n *\n * @package App\\Console\\Commands\\Empresas\n * @version 0.0.3\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nclass ActivarEInactivarPlanesCommand extends Command\n{\n    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n\n    /**\n     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n\n    /**\n     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private EmpresaPlanRepository $empresa_plan_repositorio,\n        private EmpresaPlanService $empresa_plan_servicio\n    ) {\n        parent::__construct();\n    }\n\n    /**\n     * Activar e inactivar los planes de las empresas.\n     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function handle() {\n        $empresa_id = $this->argument('empresa_id');\n        $fecha_actual = now()->startOfDay();\n        $request = new Request([\n            'estados_ids' => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n            'ordenar_por' => 'created_at',\n            'ordenar_sentido' => 'ASC'\n        ]);\n\n        if (!is_null($empresa_id)) {\n            $request->merge(['empresa_id' => $empresa_id]);\n        }\n\n        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n\n        try {\n            DB::beginTransaction();\n\n            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n                foreach ($planes as $plan) {\n                    $empresa_id = $plan->empresa_id;\n\n                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n\n                            if ($plan->tieneCreditos()) {\n                                $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n                            }\n                        } else {\n                            $this->establecerPlanProximoAVencer($plan);\n\n                            if (!$plan->esSoloPlanCreditos()) {\n                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                            }\n                        }\n\n                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n                        if ($plan->esSoloPlanCreditos()) {\n                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n\n                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                            }\n                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                                continue;\n                            }\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                        }\n                    }\n                }\n            }\n\n            DB::commit();\n\n            $this->info('Planes de empresas actualizados correctamente');\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $this->error('Error al actualizar los planes de empresas');\n        }\n    }\n\n    /**\n     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return bool\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function planVencido(EmpresaPlan $empresa_plan): bool {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            return $empresa_plan->creditosAgotados();\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas)\n                && (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n        } else {\n            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n            // tienen una fecha de inicio posterior a la actual).\n            $fecha_actual = now()->startOfDay();\n            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n        }\n    }\n\n    /**\n     * Establecer las fechas de vigencia del próximo plan del cliente.\n     *\n     * @param int $empresa_id Id de la empresa.\n     * @param int $tipo_prueba_id Id del tipo de prueba.\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n                $plan_proximo->vigencia_dias,\n                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                [\n                    'fecha_inicio' => $fechas['fecha_inicio'],\n                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n                ]\n            );\n        }\n    }\n\n    /**\n     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n     *\n     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            $total_creditos = $empresa_plan->creditos;\n\n            if ($total_creditos > 0) {\n                $creditos_consumidos = $total_creditos - $empresa_plan->creditos_restantes;\n\n                $porcentaje_consumido = ($creditos_consumidos / $total_creditos) * 100;\n\n                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n                    && $empresa_plan->creditos_restantes > 0\n                ) {\n                    $this->empresa_plan_repositorio->actualizar(\n                        $empresa_plan->id,\n                        ['estado_id' => Plan::ESTADO_POR_VENCER_ID]\n                    );\n                }\n            }\n\n            return;\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n\n            $total_consumido = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n\n            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n\n                && $total_consumido < $total_consumos_disponibles\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        } else {\n            $fecha_actual = now()->startOfDay();\n\n            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n\n            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        }\n    }\n\n    /**\n     * Activar el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     *\n     * @param int|null $tipo_prueba_id ID del tipo de prueba.\n     *\n     * @return void\n     *\n     * @author Sergio Vargas\n     */\n    private function activarPlanCreditoProximo(int $empresa_id, ?int $tipo_prueba_id): void {\n        $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan_proximo)) {\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n            );\n        }\n    }\n}\n","structuredPatch":[{"oldStart":244,"oldLines":7,"newStart":244,"newLines":6,"lines":[" ","             if (","                 $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)","-","                 && $total_consumido < $total_consumos_disponibles","             ) {","                 $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"cff8d9b6-7ca9-4733-be28-3b056bf6fb85"}
{"parentUuid":"57b34aeb-fc3e-41b2-a021-436dc44bd52e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QZuhJicv7MgcPd1xBPDmdT","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php has been updated successfully."}]},"uuid":"4c9d51d5-808a-4d9f-a987-bcef50f410a3","timestamp":"2026-01-22T19:34:56.686Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","oldString":"            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {","newString":"            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {","originalFile":"<?php\n\nnamespace App\\Console\\Commands\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Console\\Command;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\n/**\n * Comando para gestionar la activación e inactivación de los planes de las empresas.\n * Este comando solamente gestiona los estados ACTIVO, PRÓXIMO A VENCER y VENCIDO de las suscripciones a los planes por parte de las empresas. Esta es la lista\n * completa de los estados de los planes con sus descripciones.\n *\n * **ACTIVO**: Cuando se asigna un plan para la empresa o se renueva un plan, estos planes deben ir con una factura adjunta, una vez se adjunta la factura, se\n * envía una notificación de activación al correo del cliente, el estado se debe mostrar cuando se envía esa notificación al cliente.\n * **PRÓXIMO A VENCER**: Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de su plan (unidades, ofertas), los\n * días fueron recomendados desde comercial.\n * **VENCIDO**: Un plan está vencido cuando ha llegado al consumo de la última unidad o ha consumido su último día de disponibilidad.\n * **EN RENOVACIÓN**: Un plan está en renovación cuando la empresa decide adquirir el producto nuevamente, cuando esto sucede se envía un formulario de\n * actualización de datos, el usuario lo diligencia, cuando el formulario es compartido y aún no se obtiene su diligenciamiento está en renovación, una vez se\n * completan los datos y se envían, el plan pasa a un estado PENDIENTE DE FACTURACIÓN.\n * **PENDIENTE DE FACTURACIÓN**: Un plan está pendiente de facturación cuando está pendiente de cargar el archivo que soporte la compra del plan para activarlo,\n * una vez se sube el archivo, el plan pasa a estar activo.\n * **INACTIVO**: Para empresas morosas que tardan con los pagos y su plan debe ser inactivado porque no se realiza ninguna negociación al respecto.\n *\n * Fuente: https://www.figma.com/board/3W9mEAUDp4UQDKnqsiScAi/Super-Administrador---Arquitectura?node-id=4-5813&t=mIk7ZALQ3zQtdjYR-1\n *\n * @package App\\Console\\Commands\\Empresas\n * @version 0.0.3\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nclass ActivarEInactivarPlanesCommand extends Command\n{\n    protected $signature = 'planes:activar-inactivar {empresa_id?}';\n    protected $description = 'Verificar los planes de las empresas para inactivar los que están vencidos y activar los que entran en vigencia';\n\n    /**\n     * Número de días antes del vencimiento de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER = 20;\n\n    /**\n     * Porcentaje de consumo de la suscripción a un plan para que se considere próximo a vencer.\n     * @var int\n     * @author Fahibram Cárcamo\n     */\n    public const PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER = 90;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private EmpresaPlanRepository $empresa_plan_repositorio,\n        private EmpresaPlanService $empresa_plan_servicio\n    ) {\n        parent::__construct();\n    }\n\n    /**\n     * Activar e inactivar los planes de las empresas.\n     * Los planes que son por tiempo se activan e inactivan según la fecha de inicio y vencimiento, y el estado en el que se encuentren.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function handle() {\n        $empresa_id = $this->argument('empresa_id');\n        $fecha_actual = now()->startOfDay();\n        $request = new Request([\n            'estados_ids' => [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_PROXIMO_ID, Plan::ESTADO_POR_VENCER_ID],\n            'ordenar_por' => 'created_at',\n            'ordenar_sentido' => 'ASC'\n        ]);\n\n        if (!is_null($empresa_id)) {\n            $request->merge(['empresa_id' => $empresa_id]);\n        }\n\n        // Obtener los planes de empresas y agruparlos por tipo de prueba.\n        $empresas_planes = $this->empresa_plan_repositorio->getDatosBasicos($request)->groupBy('plan.tipo_prueba_id');\n\n        try {\n            DB::beginTransaction();\n\n            foreach ($empresas_planes as $tipo_prueba_id => $planes) {\n                foreach ($planes as $plan) {\n                    $empresa_id = $plan->empresa_id;\n\n                    if (in_array($plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n                        if ($this->planVencido($plan)) {\n                            // Desactivar el plan si ya ha vencido\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n\n                            if ($plan->tieneCreditos()) {\n                                $this->activarPlanCreditoProximo($empresa_id, $tipo_prueba_id);\n                            }\n                        } else {\n                            $this->establecerPlanProximoAVencer($plan);\n\n                            if (!$plan->esSoloPlanCreditos()) {\n                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                            }\n                        }\n\n                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n                        if ($plan->esSoloPlanCreditos()) {\n                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n\n                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                            }\n                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                                continue;\n                            }\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                        }\n                    }\n                }\n            }\n\n            DB::commit();\n\n            $this->info('Planes de empresas actualizados correctamente');\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $this->error('Error al actualizar los planes de empresas');\n        }\n    }\n\n    /**\n     * Retornar true si la suscripción a un plan dada por parámetro ha vencido, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return bool\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function planVencido(EmpresaPlan $empresa_plan): bool {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            return $empresa_plan->creditosAgotados();\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            // El cliente (empresa) ya ha consumido todas las unidades y ofertas laborales que había adquirido con el plan.\n            return (is_null($empresa_plan->unidades) || $empresa_plan->unidades <= $empresa_plan->consumos_agendas)\n                && (is_null($empresa_plan->cantidad_ofertas_laborales) || $empresa_plan->cantidad_ofertas_laborales <= $empresa_plan->consumos_ofertas_laborales);\n        } else {\n            // El plan se ha vencido (por seguridad se agregó una validación que también marca como vencidos los planes activos los cuales\n            // tienen una fecha de inicio posterior a la actual).\n            $fecha_actual = now()->startOfDay();\n            return $empresa_plan->fecha_inicio > $fecha_actual || $empresa_plan->fecha_vencimiento < $fecha_actual;\n        }\n    }\n\n    /**\n     * Establecer las fechas de vigencia del próximo plan del cliente.\n     *\n     * @param int $empresa_id Id de la empresa.\n     * @param int $tipo_prueba_id Id del tipo de prueba.\n     * @param EmpresaPlan $empresa_plan Suscripción al plan, registro de la tabla empresas_planes.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    private function establecerFechasVigenciaPlanProximo(int $empresa_id, int $tipo_prueba_id, EmpresaPlan $empresa_plan): void {\n        // Se busca el próximo plan\n        $plan_proximo = $this->empresa_plan_repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n        // Se verifica si existe un próximo plan y si es ilimitado\n        if (!is_null($plan_proximo) && !is_null($plan_proximo->fecha_inicio)) {\n            $fechas = $this->empresa_plan_servicio->calcularFechasVigencia(\n                $plan_proximo->vigencia_dias,\n                is_null($empresa_plan->fecha_vencimiento) ? now()->addDay() : $empresa_plan->fecha_vencimiento\n            );\n\n            // Se establecen las fechas de vigencia del la suscripción al plan\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                [\n                    'fecha_inicio' => $fechas['fecha_inicio'],\n                    'fecha_vencimiento' => $fechas['fecha_vencimiento']\n                ]\n            );\n        }\n    }\n\n    /**\n     * Establecer una suscripción a un plan dada por parámetro como próxima a vencer si es el caso.\n     *\n     * Un plan está próximo a vencer cuándo le quedan 20 días para su vencimiento o ha consumido el 90% de sus unidades (agendas y ofertas laborales).\n     * @param EmpresaPlan $empresa_plan Suscripción de plan.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Sergio Vargas\n     */\n    private function establecerPlanProximoAVencer(EmpresaPlan $empresa_plan): void {\n        if ($empresa_plan->esSoloPlanCreditos()) {\n            $total_creditos = $empresa_plan->creditos;\n\n            if ($total_creditos > 0) {\n                $creditos_consumidos = $total_creditos - $empresa_plan->creditos_restantes;\n\n                $porcentaje_consumido = ($creditos_consumidos / $total_creditos) * 100;\n\n                if (\n                    $porcentaje_consumido >= self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER\n                    && $empresa_plan->creditos_restantes > 0\n                ) {\n                    $this->empresa_plan_repositorio->actualizar(\n                        $empresa_plan->id,\n                        ['estado_id' => Plan::ESTADO_POR_VENCER_ID]\n                    );\n                }\n            }\n\n            return;\n        }\n\n        if (is_null($empresa_plan->fecha_vencimiento)) {\n            $total_consumos_disponibles = intval($empresa_plan->unidades) + intval($empresa_plan->cantidad_ofertas_laborales);\n\n            $total_consumido = intval($empresa_plan->consumos_agendas) + intval($empresa_plan->consumos_ofertas_laborales);\n\n            if (\n                $total_consumido >= intval((self::PORCENTAJE_CONSUMOS_DISPIBLES_PLAN_PROXIMO_A_VENCER / 100) * $total_consumos_disponibles)\n                && $total_consumido < $total_consumos_disponibles\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        } else {\n            $fecha_actual = now()->startOfDay();\n\n            $fecha_vencimiento = Carbon::parse($empresa_plan->fecha_vencimiento)->startOfDay();\n\n            if (\n                intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER\n\n                && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0\n            ) {\n                $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n            }\n        }\n    }\n\n    /**\n     * Activar el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     *\n     * @param int|null $tipo_prueba_id ID del tipo de prueba.\n     *\n     * @return void\n     *\n     * @author Sergio Vargas\n     */\n    private function activarPlanCreditoProximo(int $empresa_id, ?int $tipo_prueba_id): void {\n        $plan_proximo = $this->empresa_plan_repositorio->planProximoCreditos($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan_proximo)) {\n            $this->empresa_plan_repositorio->actualizar(\n                $plan_proximo->id,\n                ['estado_id' => Plan::ESTADO_ACTIVO_ID]\n            );\n        }\n    }\n}\n","structuredPatch":[{"oldStart":255,"oldLines":7,"newStart":255,"newLines":6,"lines":[" ","             if (","                 intval($fecha_actual->diffInDays($fecha_vencimiento)) <= self::DIAS_RESTANTES_PLAN_PROXIMO_A_VENCER","-","                 && intval($fecha_actual->diffInDays($fecha_vencimiento)) >= 0","             ) {","                 $this->empresa_plan_repositorio->actualizar($empresa_plan->id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"57b34aeb-fc3e-41b2-a021-436dc44bd52e"}
{"parentUuid":"4c9d51d5-808a-4d9f-a987-bcef50f410a3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FsGf5uNTg9CrSFavCdVwm4","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Casi todas las ediciones se aplicaron correctamente. Una falló porque el contenido ya no coincidía exactamente. Déjame leer el archivo actualizado para ver el estado actual y corregir lo que falte, y luego correr pint.","signature":"EoYDCkYICxgCKkAf0GS+6tDjP+fMV6we2aaumFpEEL8ameZpxFd1JTzX12XwJxO7gdFaiTdw6JJzmsCtH7wKLS0cu6kn2iZ1v/qeEgwtLPRBicCcmJvPa/QaDNwADrpGCvNb5SmYsiIw0v5jRe6RWygqc6vYOvRfl9C08uTN+KoRLhCEMKpk0NM9vwvHlr0qlJOJ67UZYdfrKu0BeB78ku0Kf4YLWQ1ptzHko9A5mZGkIzyPhdlN4qhC5ky/fl57//VReXwTl0w7RCVbMzar3pRdzyuF7zdLSrdg1pLc2wPI26RbAYGYEkbVhcmACCKu1dGCUdTl0QQEaEZfcXL4yCUMvttlMeJox8Qi39XtJzWLgQmNjcNc8QmY/xuipkn6wAJOzu9lyDIgV/9Ydl4EnZRbz8/T5bgbv+j72ewEA1j0fkoLqV5EbLQr2/CoYSH1OJRByAzFjeY27JMRSCBWpKNwAcR+VD3UpNMx35c2hJIj1Onro0IhGv0Ze3GdU8gLi2CRzmef9qBWGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3823,"cache_read_input_tokens":29839,"cache_creation":{"ephemeral_5m_input_tokens":3823,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNydy5A9pPfanSBTveUi","type":"assistant","uuid":"d89de056-12e5-46be-9513-b555db64db8e","timestamp":"2026-01-22T19:35:00.625Z"}
{"parentUuid":"d89de056-12e5-46be-9513-b555db64db8e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FsGf5uNTg9CrSFavCdVwm4","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a leer el archivo para verificar el estado y corregir lo que falta."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3823,"cache_read_input_tokens":29839,"cache_creation":{"ephemeral_5m_input_tokens":3823,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNydy5A9pPfanSBTveUi","type":"assistant","uuid":"fe6489ac-5b18-4d03-adb7-f3e9fef4ca93","timestamp":"2026-01-22T19:35:01.055Z"}
{"parentUuid":"fe6489ac-5b18-4d03-adb7-f3e9fef4ca93","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FsGf5uNTg9CrSFavCdVwm4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018Pap8r7TAPYB756R2aZ42U","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","offset":110,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3823,"cache_read_input_tokens":29839,"cache_creation":{"ephemeral_5m_input_tokens":3823,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNydy5A9pPfanSBTveUi","type":"assistant","uuid":"2c2dfa5e-b861-401b-8e2d-aabf4abca96c","timestamp":"2026-01-22T19:35:01.848Z"}
{"parentUuid":"2c2dfa5e-b861-401b-8e2d-aabf4abca96c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018Pap8r7TAPYB756R2aZ42U","type":"tool_result","content":"   110→                            }\n   111→                        } else {\n   112→                            $this->establecerPlanProximoAVencer($plan);\n   113→\n   114→                            if (!$plan->esSoloPlanCreditos()) {\n   115→                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n   116→                            }\n   117→                        }\n   118→\n   119→                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n   120→                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n   121→                        if ($plan->esSoloPlanCreditos()) {\n   122→                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n   123→\n   124→                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n   125→                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   126→                            }\n   127→                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n   128→                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n   129→                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   130→\n   131→                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n   132→                                continue;\n   133→                            }\n   134→\n   135→                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   136→                        }\n   137→                    }\n   138→                }\n   139→            }\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"cd6b80f1-cf63-4a1f-aada-d0daeeaa9099","timestamp":"2026-01-22T19:35:02.712Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php","content":"                            }\n                        } else {\n                            $this->establecerPlanProximoAVencer($plan);\n\n                            if (!$plan->esSoloPlanCreditos()) {\n                                $this->establecerFechasVigenciaPlanProximo($empresa_id, $tipo_prueba_id, $plan);\n                            }\n                        }\n\n                        // Activar planes que entran en vigencia, siempre y cuando no exista un plan activo del mismo tipo de prueba.\n                    } elseif ($plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n                        if ($plan->esSoloPlanCreditos()) {\n                            $plan_activo = $this->empresa_plan_repositorio->planCreditosActivo($empresa_id);\n\n                            if (is_null($plan_activo) || $plan_activo->creditosAgotados()) {\n                                $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                            }\n                        } elseif (!is_null($plan->fecha_inicio) && $plan->fecha_inicio == $fecha_actual) {\n                            // Verificar si ya existe un plan activo del mismo tipo de prueba.\n                            $plan_activo = $this->empresa_plan_repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n                            if (!is_null($plan_activo) && !$this->planVencido($plan_activo)) {\n                                continue;\n                            }\n\n                            $this->empresa_plan_repositorio->actualizar($plan->id, ['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n                        }\n                    }\n                }\n            }","numLines":30,"startLine":110,"totalLines":287}},"sourceToolAssistantUUID":"2c2dfa5e-b861-401b-8e2d-aabf4abca96c"}
{"parentUuid":"cd6b80f1-cf63-4a1f-aada-d0daeeaa9099","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GyNe4jM1afbeVi88mby3Bt","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Veo que el comentario en la línea 119 ya no tiene la línea en blanco extra, parece que ya fue corregido o nunca la tuvo de esa manera. El archivo se ve bien en esa sección. Ahora voy a ejecutar pint sobre el archivo.","signature":"EoQDCkYICxgCKkBX0O5pTWeZp+FxIqY/NA5MGfvK/ofBbz1I08SxbEZUcmUQGzrA3J00Z6EJ0vFKfCN04wHP85IhDi4kCoY6D6d1Egwnl3tpRUKktYYEpSkaDPlkG9JzT4Td0JQscyIwK3ZtxnhuZRc6jFkb7wPWq23HS/L1HndQMzTxr9UAfo3St0VwAP8RAZYlcsp8LzU/KusBBF4I7Y6XA6yTGi4fuqk5K1jJmnH0Rsz6ml9H3j3dqJw983BEboxbrPORM9pEXahcDqg0WjTyT0nUnvvBJqDqg17DHQANUNu1UgMIu6+gtxbHayVNeRVkR9CZrrg8B/ybi7Q6ZtBqlgvCwbn98YFB6AM27g/E7zHDENyxwXdx5hvnmoHAl7T1OdSFkmm3OOTs7aDmyZK+EwCt58D807bHmroJw1gxEz+LLbBcApjNEywi66AwjRZbebJJMJWO3wmtvcLVQbSlETd83ytzsobAwEb1NZ3mc5QurutgVJwpniqhWoptFt04c/7+GhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":852,"cache_read_input_tokens":33662,"cache_creation":{"ephemeral_5m_input_tokens":852,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNyeQStReGjNdQH5LwBg","type":"assistant","uuid":"627f7189-9495-4516-ace5-7e70046b326c","timestamp":"2026-01-22T19:35:06.748Z"}
{"parentUuid":"627f7189-9495-4516-ace5-7e70046b326c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GyNe4jM1afbeVi88mby3Bt","type":"message","role":"assistant","content":[{"type":"text","text":"El archivo se ve bien. Ahora ejecuto Laravel Pint."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":852,"cache_read_input_tokens":33662,"cache_creation":{"ephemeral_5m_input_tokens":852,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNyeQStReGjNdQH5LwBg","type":"assistant","uuid":"988ce788-3c82-47eb-bb72-a51036f6c3d1","timestamp":"2026-01-22T19:35:07.333Z"}
{"parentUuid":"988ce788-3c82-47eb-bb72-a51036f6c3d1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GyNe4jM1afbeVi88mby3Bt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Sj4YLRCP6hthSuFvvA4HPK","name":"Bash","input":{"command":"cd C:/Users/sergio/proyectos/Psicoalianza-2 && vendor/bin/pint app/Console/Commands/Empresas/ActivarEInactivarPlanesCommand.php","description":"Ejecutar Laravel Pint en el archivo del comando"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":852,"cache_read_input_tokens":33662,"cache_creation":{"ephemeral_5m_input_tokens":852,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNyeQStReGjNdQH5LwBg","type":"assistant","uuid":"8050e9be-aae1-4739-84a4-2c946e2b4e09","timestamp":"2026-01-22T19:35:08.406Z"}
{"parentUuid":"8050e9be-aae1-4739-84a4-2c946e2b4e09","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Sj4YLRCP6hthSuFvvA4HPK","type":"tool_result","content":"  \u001b[32;1m✓\u001b[39;22m\n\n  \u001b[90m────────────────────────────────────────────────────────────────────────────────────────────────────────────────\u001b[39m \u001b[90mPER\u001b[39m  \n  \u001b[90;42;1m  FIXED  \u001b[39;49;22m \u001b[90m..............................................................................\u001b[39m 1 file, 1 style issue fixed  \r\n  \u001b[32;1m✓\u001b[39;22m app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php \u001b[90mclass_attributes_separation, braces, braces_posi…\u001b[39m","is_error":false}]},"uuid":"4dbe2418-af79-4f3b-8a7d-f3c467943f96","timestamp":"2026-01-22T19:35:21.587Z","toolUseResult":{"stdout":"  \u001b[32;1m✓\u001b[39;22m\n\n  \u001b[90m────────────────────────────────────────────────────────────────────────────────────────────────────────────────\u001b[39m \u001b[90mPER\u001b[39m  \n  \u001b[90;42;1m  FIXED  \u001b[39;49;22m \u001b[90m..............................................................................\u001b[39m 1 file, 1 style issue fixed  \r\n  \u001b[32;1m✓\u001b[39;22m app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php \u001b[90mclass_attributes_separation, braces, braces_posi…\u001b[39m\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"8050e9be-aae1-4739-84a4-2c946e2b4e09"}
{"parentUuid":"4dbe2418-af79-4f3b-8a7d-f3c467943f96","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CbMKV2mw3Eq5mdP4ZEEeAN","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Pint corrigió 1 archivo con 1 problema de estilo. Voy a mostrar el resultado final del archivo para que el usuario pueda ver los cambios.","signature":"ErMCCkYICxgCKkALLz1Mg6hRPG44wwgQ+iBV0g+XJVHymU3HQsnA2yCSG0HKQplJSZk9d4ESxEH7opEq0FgaP+1qAdIALvyiLHHPEgyBOyidUbFZA18hka0aDIOOFXqmiGzB4WFnFSIwvHY4c6FAYFeKx33ccaYuZhPQNFJF4KSTjeg1jumemvjDsqKug4C5gwXF/8SODCO6KpoBwuTRSyKmLKXOA2CLRmbQJWaH/VXcFgvAdxjK3ghZVnG4KeFK792IfYva5wze3KGgdu79uuc2WoQk5vxSlpUUeFwUe2S0DQcwxLH8uUnzkydxxOlZ59tbm9qLOwVViEhb0eb2oPiHq7JQepLPuKK3nT6ybn9VVcWKST2dcjUIC3prxFBX05bK7aS7RiSC2j/FtKA/fOVvHwHdzhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":399,"cache_read_input_tokens":34514,"cache_creation":{"ephemeral_5m_input_tokens":399,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNyfnpKKuQmBCseY8uk5","type":"assistant","uuid":"76e53dea-5834-4a26-a9bd-423dc6b10692","timestamp":"2026-01-22T19:35:24.588Z"}
{"parentUuid":"76e53dea-5834-4a26-a9bd-423dc6b10692","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CbMKV2mw3Eq5mdP4ZEEeAN","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Se corrigieron los saltos de línea innecesarios y Pint aplicó correcciones adicionales de estilo (`class_attributes_separation`, `braces`, `braces_position`). El archivo ha sido formateado correctamente."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":399,"cache_read_input_tokens":34514,"cache_creation":{"ephemeral_5m_input_tokens":399,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNyfnpKKuQmBCseY8uk5","type":"assistant","uuid":"6949beff-563d-4932-88b1-8e3078d9d536","timestamp":"2026-01-22T19:35:25.570Z"}
{"parentUuid":"6949beff-563d-4932-88b1-8e3078d9d536","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"system","subtype":"turn_duration","durationMs":58987,"timestamp":"2026-01-22T19:35:25.699Z","uuid":"2c255fca-a5c3-4cb4-a3c7-cf29e2d060b1","isMeta":false}
{"type":"file-history-snapshot","messageId":"dea2cbad-7333-4dde-a337-7b258f9d286e","snapshot":{"messageId":"dea2cbad-7333-4dde-a337-7b258f9d286e","trackedFileBackups":{"app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php":{"backupFileName":"b4706ac638207036@v2","version":2,"backupTime":"2026-01-22T19:45:29.008Z"}},"timestamp":"2026-01-22T19:45:28.966Z"},"isSnapshotUpdate":false}
{"parentUuid":"2c255fca-a5c3-4cb4-a3c7-cf29e2d060b1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":"@public/js/empresa/planes/planes.js ahora sobre este"},"uuid":"dea2cbad-7333-4dde-a337-7b258f9d286e","timestamp":"2026-01-22T19:45:28.945Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"dea2cbad-7333-4dde-a337-7b258f9d286e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_016WwpozVrNjWHw4tS54JBzm","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que corrija los espacios y saltos de línea innecesarios en el archivo planes.js. Voy a revisar el archivo y encontrar los problemas:\n\n1. Línea 344-345: Hay dos líneas en blanco consecutivas\n2. Línea 375-376: Hay dos líneas en blanco consecutivas\n\nEsos son los principales problemas de saltos de línea innecesarios que veo. Voy a corregirlos.","signature":"EpQECkYICxgCKkAmZs/48gWAprWzxrJhDPJuKYjUjMmpHTICYNVzgPywQnhhCseKC3yR6QiAC6XQPjveUKLxr69xCl+co6ltv3MxEgxCjVpT4KN9f+JRGm0aDAiooPyAFCuWervZ5yIwg1OJiQGVk2lvXEocSn7hoJEHD6Insq0WF5058BiwxScKJjXc4LblaKNaAWDR4vXPKvsC6F6lTPoHASuoWJWXiCCwFRFsJPgAiv36OXTaix9afKVGKX9RcowAm+qQhwj/rTLUJqp/glVQ3GTR8UT8dX8DX3mItyrGaPSrg1tdJ2c5cOLpucZmErHPl0z1a+XnOCZeZfS5g4HRHhsb3GYlRAOC6lfowQ+XCWl/RAUZAH3yx7wTiuPFKZqWuhTMMHxfSeYpH2BPnN/Gb0TiEQSkLoCi7xXA46Nd3xrA2Ygp1pA6sUL0Z2fDmc5SdAUT30o4Nbe3CX3SC+xqszsLY/FfqrUdDsTvnatcXub0gludHxo0LpNHvGqNJ65AHmZf2nwmvzP2wdS64+zgWU5bqFhB1CqfD9bo4lGLAaJ7q60f8zxbOJMx57fgHJgSLhrhE6/ci+YW3tNRClOBzZa/Ri0iMNiJ6yWIA9E9WmZZGgWA0GaVNraHgA4q5h9FO6c4ceMkyr2WmY9Z8t0L/Ul5WPzHGmsHVWywYaX4rGSI8QSkkIXRVF+i9DuFYxxXIPKXgBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":43604,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":43604,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNzSZZr35QyCXK2mWyaX","type":"assistant","uuid":"4793ee2f-5c81-4063-b0aa-889412367bdb","timestamp":"2026-01-22T19:45:34.202Z"}
{"parentUuid":"4793ee2f-5c81-4063-b0aa-889412367bdb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_016WwpozVrNjWHw4tS54JBzm","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a corregir los saltos de línea innecesarios en el archivo JavaScript."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":43604,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":43604,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNzSZZr35QyCXK2mWyaX","type":"assistant","uuid":"d65658eb-0d5a-476a-95b9-806d43b19c69","timestamp":"2026-01-22T19:45:34.585Z"}
{"parentUuid":"d65658eb-0d5a-476a-95b9-806d43b19c69","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_016WwpozVrNjWHw4tS54JBzm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WnmjLNsw5ojy1wVwVDCu47","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","old_string":"    }).join('');\n}\n\n\n/**\n * Agrupar los consumos de un plan por empresa.","new_string":"    }).join('');\n}\n\n/**\n * Agrupar los consumos de un plan por empresa."}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":43604,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":43604,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNzSZZr35QyCXK2mWyaX","type":"assistant","uuid":"3aa28b21-93d5-4d10-8114-1ac25a8715c8","timestamp":"2026-01-22T19:45:36.782Z"}
{"parentUuid":"3aa28b21-93d5-4d10-8114-1ac25a8715c8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_016WwpozVrNjWHw4tS54JBzm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013ZjmwZA3spZAqGArf6aecA","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","old_string":"    return Array.from(consumos_empresas.values());\n}\n\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.","new_string":"    return Array.from(consumos_empresas.values());\n}\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas."}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":43604,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":43604,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNzSZZr35QyCXK2mWyaX","type":"assistant","uuid":"40896b61-e27d-45ab-933c-c126efec90ce","timestamp":"2026-01-22T19:45:37.929Z"}
{"type":"file-history-snapshot","messageId":"3aa28b21-93d5-4d10-8114-1ac25a8715c8","snapshot":{"messageId":"dea2cbad-7333-4dde-a337-7b258f9d286e","trackedFileBackups":{"app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php":{"backupFileName":"b4706ac638207036@v2","version":2,"backupTime":"2026-01-22T19:45:29.008Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"115edace5e384ff2@v1","version":1,"backupTime":"2026-01-22T19:45:38.780Z"}},"timestamp":"2026-01-22T19:45:28.966Z"},"isSnapshotUpdate":true}
{"parentUuid":"3aa28b21-93d5-4d10-8114-1ac25a8715c8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WnmjLNsw5ojy1wVwVDCu47","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js has been updated successfully."}]},"uuid":"a9befd05-991a-4e57-bc02-1804905d73c9","timestamp":"2026-01-22T19:45:38.778Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","oldString":"    }).join('');\n}\n\n\n/**\n * Agrupar los consumos de un plan por empresa.","newString":"    }).join('');\n}\n\n/**\n * Agrupar los consumos de un plan por empresa.","originalFile":"let empresa_id = $('#input_empresa_id').val();\nlet usuario_id = $('#input_usuario_id').val();\nlet empresas_planes = [];\nlet usuarios_ids = [];\nlet sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nusuarios_ids = usuarios.map(usuario => usuario.id);\nlet total_usuarios = usuarios_ids.length;\n\nconst ESTADOS_PLANES = {\n    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n};\n\nconst ICONOS_PLANES_TIPO = {\n    'Selección': 'bi-person-bounding-box',\n    'Organizacional': 'bi-diagram-3-fill',\n    'Vocacional': 'bi-mortarboard-fill',\n};\n\n/**\n * Obtiene la data para mostrar en la tabla de planes de la empresa.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n*/\nasync function traerDatos() {\n    try {\n        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n        empresas_planes = respuesta.data.empresas_planes;\n    } catch (error) {\n        console.error(error);\n    }\n}\ntraerDatos();\n\n/**\n * Crea el componente html de los planes de la empresa\n *\n * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Jair Carvajal\n */\nfunction listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    let contenidoHTML = empresas_planes.map(empresa_plan => {\n        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n\n        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n        if (!plan) {\n            return '';\n        }\n        let suscripcion_ilimitada = !!fecha_vencimiento;\n\n        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n            ? empresa_plan.fecha_inicio\n            : (new Date()).toString();\n\n        let dias_restantes = suscripcion_ilimitada\n            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n            : null;\n\n        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n\n        return `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ${empresa_plan.plan_credito ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 0, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Ver detalle consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumosCreditos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ` : ''}\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.\n * @param {number} total Valor total del consumo.\n * @param {boolean} un_text Booleano para mostrar o no el texto.\n * @returns {string} HTML del progress bar.\n * @author Andres Morales\n */\nfunction crearProgressBarTemplate(label, icono, valor, total, un_text) {\n    return `\n        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono ? `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>` : ''}${label}${un_text ? '</p>' : ''}\n        ${crearProgressBar({\n            label: `${valor}/${total ?? 0}`,\n            height: '8px',\n            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n        })}\n    `;\n}\n\n/**\n * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n *\n * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {string}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    if (!empresa_plan.plan) {\n        return '';\n    }\n    return sucursales.map(sucursal => {\n        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n\n        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n        let plan = empresa_plan.plan;\n\n        return `\n            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n                <td class=\"py-0 my-0\">\n                    <div class=\"card border-0\">\n                        <div class=\"card-body py-2 px-10\">\n                            <div class=\"row\">\n                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n                                    ${sucursal.nombre_comercial}\n                                </div>\n                                <div class=\"col my-auto\">\n                                    <div class=\"card bg-white border-0\">\n                                        <div class=\"card-body py-2\">\n                                            <div class=\"row\">\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Unidades',\n                                                            'box',\n                                                            total_agendas_consumidas_sucursal,\n                                                            plan.unidades,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Vacantes',\n                                                            'briefcase',\n                                                            total_ofertas_laborales_consumidas_sucursal,\n                                                            plan.cantidad_ofertas_laborales,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Usuarios',\n                                                            'person',\n                                                            total_usuarios_sucursal,\n                                                            plan.cantidad_usuarios,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        `;\n    }).join('');\n}\n\n\n/**\n * Agrupar los consumos de un plan por empresa.\n *\n * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n * @returns {array}\n * @author Andres Morales\n */\nfunction obtenerConsumos(empresa_plan_consumos) {\n    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n\n    let consumos_empresas = new Map();\n\n    empresa_plan_consumos.forEach(consumo => {\n        let empresa = consumo.empresa;\n        if (!consumos_empresas.has(empresa.id)) {\n            empresa.consumos = [];\n            consumos_empresas.set(empresa.id, empresa);\n        }\n        consumos_empresas.get(empresa.id).consumos.push(consumo);\n    });\n\n    sucursales.forEach(sucursal => {\n        if (!consumos_empresas.has(sucursal.id)) {\n            consumos_empresas.set(sucursal.id, sucursal);\n        }\n    });\n\n    return Array.from(consumos_empresas.values());\n}\n\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n *\n * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n * @returns {number}\n * @author Andres Morales\n */\nfunction obtenerTotalUsuarios(empresa = null) {\n    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n    let usuarios_ids_temporal = new Set();\n    usuarios_temporal.forEach(usuario => {\n        if (usuarios_ids.includes(usuario.id)) {\n            usuarios_ids_temporal.add(usuario.id);\n        }\n    });\n    return usuarios_ids_temporal.size;\n}\n\n/**\n * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n *\n * @param {string} id Id del elemento a mostar u ocultar.\n * @param {string} elemento Elemento padre del menú de acciones.\n * @returns {void}\n * @author Andres Morales\n */\nfunction toggleSucursalesList(id, elemento) {\n    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n}\n\n/**\n * Realizar la consulta HTTP para solicitar la renovación de un plan.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function solicitarRenovacionPlan() {\n    $('#modal-solicitar-renovacion').modal('hide');\n    let plan_id = $('#id-plan-solicitar-renovacion').val();\n    await $.ajax({\n        type: 'POST',\n        url : '/solicitud-renovacion-plan',\n        data: {\n            plan_id,\n            empresa_id,\n            usuario_id,\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then(respuesta => {\n        $('#nombre-plan-solicitar-renovacion').text('');\n        $('#id-plan-solicitar-renovacion').val('');\n        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n    });\n}\n\n/**\n * Abrir el modal de confirmación de solicitud de renovación de un plan.\n *\n * @param {number} plan_id Id del plan.\n * @param {string} nombre_plan Nombre del plan.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan) {\n    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n    $('#id-plan-solicitar-renovacion').val(plan_id);\n    $('#modal-solicitar-renovacion').modal('show');\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id){\n    if (factura_id) {\n        await $.ajax({\n            type: 'GET',\n            url: `archivos-abrir/${factura_id}`,\n            xhrFields: {responseType: 'blob'},\n        })\n            .then(respuesta => {\n                let ruta_factura = window.URL.createObjectURL(respuesta);\n                window.open(ruta_factura, '_blank');\n            })\n            .catch((error) => {\n                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n            });\n    } else {\n        mostrarToast('danger', 'No se encontró la factura');\n    }\n}\n","structuredPatch":[{"oldStart":342,"oldLines":7,"newStart":342,"newLines":6,"lines":["     }).join('');"," }"," ","-"," /**","  * Agrupar los consumos de un plan por empresa.","  *"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"3aa28b21-93d5-4d10-8114-1ac25a8715c8"}
{"parentUuid":"40896b61-e27d-45ab-933c-c126efec90ce","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013ZjmwZA3spZAqGArf6aecA","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js has been updated successfully."}]},"uuid":"ad6f4bf6-83ff-4726-af93-d78f07285b62","timestamp":"2026-01-22T19:45:39.690Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","oldString":"    return Array.from(consumos_empresas.values());\n}\n\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.","newString":"    return Array.from(consumos_empresas.values());\n}\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.","originalFile":"let empresa_id = $('#input_empresa_id').val();\nlet usuario_id = $('#input_usuario_id').val();\nlet empresas_planes = [];\nlet usuarios_ids = [];\nlet sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nusuarios_ids = usuarios.map(usuario => usuario.id);\nlet total_usuarios = usuarios_ids.length;\n\nconst ESTADOS_PLANES = {\n    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n};\n\nconst ICONOS_PLANES_TIPO = {\n    'Selección': 'bi-person-bounding-box',\n    'Organizacional': 'bi-diagram-3-fill',\n    'Vocacional': 'bi-mortarboard-fill',\n};\n\n/**\n * Obtiene la data para mostrar en la tabla de planes de la empresa.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n*/\nasync function traerDatos() {\n    try {\n        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n        empresas_planes = respuesta.data.empresas_planes;\n    } catch (error) {\n        console.error(error);\n    }\n}\ntraerDatos();\n\n/**\n * Crea el componente html de los planes de la empresa\n *\n * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Jair Carvajal\n */\nfunction listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    let contenidoHTML = empresas_planes.map(empresa_plan => {\n        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n\n        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n        if (!plan) {\n            return '';\n        }\n        let suscripcion_ilimitada = !!fecha_vencimiento;\n\n        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n            ? empresa_plan.fecha_inicio\n            : (new Date()).toString();\n\n        let dias_restantes = suscripcion_ilimitada\n            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n            : null;\n\n        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n\n        return `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ${empresa_plan.plan_credito ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 0, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Ver detalle consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumosCreditos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ` : ''}\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.\n * @param {number} total Valor total del consumo.\n * @param {boolean} un_text Booleano para mostrar o no el texto.\n * @returns {string} HTML del progress bar.\n * @author Andres Morales\n */\nfunction crearProgressBarTemplate(label, icono, valor, total, un_text) {\n    return `\n        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono ? `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>` : ''}${label}${un_text ? '</p>' : ''}\n        ${crearProgressBar({\n            label: `${valor}/${total ?? 0}`,\n            height: '8px',\n            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n        })}\n    `;\n}\n\n/**\n * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n *\n * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {string}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    if (!empresa_plan.plan) {\n        return '';\n    }\n    return sucursales.map(sucursal => {\n        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n\n        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n        let plan = empresa_plan.plan;\n\n        return `\n            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n                <td class=\"py-0 my-0\">\n                    <div class=\"card border-0\">\n                        <div class=\"card-body py-2 px-10\">\n                            <div class=\"row\">\n                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n                                    ${sucursal.nombre_comercial}\n                                </div>\n                                <div class=\"col my-auto\">\n                                    <div class=\"card bg-white border-0\">\n                                        <div class=\"card-body py-2\">\n                                            <div class=\"row\">\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Unidades',\n                                                            'box',\n                                                            total_agendas_consumidas_sucursal,\n                                                            plan.unidades,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Vacantes',\n                                                            'briefcase',\n                                                            total_ofertas_laborales_consumidas_sucursal,\n                                                            plan.cantidad_ofertas_laborales,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Usuarios',\n                                                            'person',\n                                                            total_usuarios_sucursal,\n                                                            plan.cantidad_usuarios,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        `;\n    }).join('');\n}\n\n/**\n * Agrupar los consumos de un plan por empresa.\n *\n * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n * @returns {array}\n * @author Andres Morales\n */\nfunction obtenerConsumos(empresa_plan_consumos) {\n    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n\n    let consumos_empresas = new Map();\n\n    empresa_plan_consumos.forEach(consumo => {\n        let empresa = consumo.empresa;\n        if (!consumos_empresas.has(empresa.id)) {\n            empresa.consumos = [];\n            consumos_empresas.set(empresa.id, empresa);\n        }\n        consumos_empresas.get(empresa.id).consumos.push(consumo);\n    });\n\n    sucursales.forEach(sucursal => {\n        if (!consumos_empresas.has(sucursal.id)) {\n            consumos_empresas.set(sucursal.id, sucursal);\n        }\n    });\n\n    return Array.from(consumos_empresas.values());\n}\n\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n *\n * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n * @returns {number}\n * @author Andres Morales\n */\nfunction obtenerTotalUsuarios(empresa = null) {\n    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n    let usuarios_ids_temporal = new Set();\n    usuarios_temporal.forEach(usuario => {\n        if (usuarios_ids.includes(usuario.id)) {\n            usuarios_ids_temporal.add(usuario.id);\n        }\n    });\n    return usuarios_ids_temporal.size;\n}\n\n/**\n * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n *\n * @param {string} id Id del elemento a mostar u ocultar.\n * @param {string} elemento Elemento padre del menú de acciones.\n * @returns {void}\n * @author Andres Morales\n */\nfunction toggleSucursalesList(id, elemento) {\n    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n}\n\n/**\n * Realizar la consulta HTTP para solicitar la renovación de un plan.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function solicitarRenovacionPlan() {\n    $('#modal-solicitar-renovacion').modal('hide');\n    let plan_id = $('#id-plan-solicitar-renovacion').val();\n    await $.ajax({\n        type: 'POST',\n        url : '/solicitud-renovacion-plan',\n        data: {\n            plan_id,\n            empresa_id,\n            usuario_id,\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then(respuesta => {\n        $('#nombre-plan-solicitar-renovacion').text('');\n        $('#id-plan-solicitar-renovacion').val('');\n        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n    });\n}\n\n/**\n * Abrir el modal de confirmación de solicitud de renovación de un plan.\n *\n * @param {number} plan_id Id del plan.\n * @param {string} nombre_plan Nombre del plan.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan) {\n    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n    $('#id-plan-solicitar-renovacion').val(plan_id);\n    $('#modal-solicitar-renovacion').modal('show');\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id){\n    if (factura_id) {\n        await $.ajax({\n            type: 'GET',\n            url: `archivos-abrir/${factura_id}`,\n            xhrFields: {responseType: 'blob'},\n        })\n            .then(respuesta => {\n                let ruta_factura = window.URL.createObjectURL(respuesta);\n                window.open(ruta_factura, '_blank');\n            })\n            .catch((error) => {\n                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n            });\n    } else {\n        mostrarToast('danger', 'No se encontró la factura');\n    }\n}\n","structuredPatch":[{"oldStart":372,"oldLines":7,"newStart":372,"newLines":6,"lines":["     return Array.from(consumos_empresas.values());"," }"," ","-"," /**","  * Retornar la suma total de usuarios de una empresa o de todas las empresas.","  *"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"40896b61-e27d-45ab-933c-c126efec90ce"}
{"parentUuid":"ad6f4bf6-83ff-4726-af93-d78f07285b62","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JHcCVcQQ8k6mDs1qqLZz7G","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Se corrigieron los dos lugares donde había líneas en blanco duplicadas. El archivo JavaScript no tiene un linter como Pint, pero las correcciones de formato se aplicaron correctamente.","signature":"EuMCCkYICxgCKkCox5rLUKJOqaoAfRuHv93gcoGWFDg8YLxgsx50GO00Oy6nm2JQZKscPMa/1lGL9uMjpwa8eyL/yOdhVzzZ/qgKEgzY8F4qE0sS1/F4BD8aDLoOP33iHjl2dfFeuCIwKLrpu65B7CFhYo1aSLNQDzwdjATZAHovBS88LKWJ16OliS78P3GtLfEycML478mbKsoBgUQK2cJ/10TBoioshsfQn8WvbQjfIkjmJozCsWcdEMpqr4fJm1nAHq7Dxfs2WzW79gh3XocRht3lbqvzy55i+ZHJoIoItu2DkUi+5WhAbYslaTQSgRBzhKMA9dZs6OXLTQCULQRQ/KIzszQnyNnKvTryWR2VzQnwsnR2WkVqTg+xBYwVbw4rGYgJB4EE1GdY7qySMisii7brROTJek2fM0W9GkohCOTdKzFkHDSeWt1JJCk04SkGWup07yUl+vlWLlTLxInqYLQxEBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":669,"cache_read_input_tokens":43604,"cache_creation":{"ephemeral_5m_input_tokens":669,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXNzTN9XqxWfS3eZ4ptTv","type":"assistant","uuid":"0c97ccd4-b6b2-4b5a-aaa2-1257c06d318b","timestamp":"2026-01-22T19:45:43.112Z"}
{"parentUuid":"0c97ccd4-b6b2-4b5a-aaa2-1257c06d318b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JHcCVcQQ8k6mDs1qqLZz7G","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Se eliminaron los saltos de línea duplicados (líneas 344-345 y 375-376). El archivo JavaScript no tiene un linter equivalente a Pint, pero los problemas de formato fueron corregidos."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":669,"cache_read_input_tokens":43604,"cache_creation":{"ephemeral_5m_input_tokens":669,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXNzTN9XqxWfS3eZ4ptTv","type":"assistant","uuid":"7876c9f7-d87d-408d-b6b6-4621b5669c49","timestamp":"2026-01-22T19:45:43.940Z"}
{"type":"file-history-snapshot","messageId":"6d5fe662-2501-4f03-ac1d-87d1b922c3c3","snapshot":{"messageId":"6d5fe662-2501-4f03-ac1d-87d1b922c3c3","trackedFileBackups":{"app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php":{"backupFileName":"b4706ac638207036@v2","version":2,"backupTime":"2026-01-22T19:45:29.008Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"115edace5e384ff2@v2","version":2,"backupTime":"2026-01-22T20:13:17.509Z"}},"timestamp":"2026-01-22T20:13:17.507Z"},"isSnapshotUpdate":false}
{"parentUuid":"7876c9f7-d87d-408d-b6b6-4621b5669c49","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":"en @app\\Http\\Services\\Empresas\\EmpresaPlanService.php"},"uuid":"6d5fe662-2501-4f03-ac1d-87d1b922c3c3","timestamp":"2026-01-22T20:13:17.482Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"6d5fe662-2501-4f03-ac1d-87d1b922c3c3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"type":"text","text":"[Request interrupted by user]"}]},"uuid":"171657d0-9a49-4704-96e1-4b2d254db49e","timestamp":"2026-01-22T20:13:17.654Z"}
{"type":"file-history-snapshot","messageId":"8cd8037f-c69b-43c2-ac0c-aaf63d6083cb","snapshot":{"messageId":"8cd8037f-c69b-43c2-ac0c-aaf63d6083cb","trackedFileBackups":{"app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php":{"backupFileName":"b4706ac638207036@v2","version":2,"backupTime":"2026-01-22T19:45:29.008Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"115edace5e384ff2@v2","version":2,"backupTime":"2026-01-22T20:13:17.509Z"}},"timestamp":"2026-01-22T20:14:14.049Z"},"isSnapshotUpdate":false}
{"parentUuid":"171657d0-9a49-4704-96e1-4b2d254db49e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":"en @app\\Http\\Services\\Empresas\\EmpresaPlanService.php los numeros en estados por ej: ['estado_id' => 3] por las constantes de estados"},"uuid":"8cd8037f-c69b-43c2-ac0c-aaf63d6083cb","timestamp":"2026-01-22T20:14:14.025Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"8cd8037f-c69b-43c2-ac0c-aaf63d6083cb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018r6X3ZKqoWGsrLxgutW28G","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que reemplace los números mágicos de estados (como `['estado_id' => 3]`) por las constantes de estados definidas en el modelo Plan. Necesito revisar qué constantes existen para los estados.\n\nDel archivo ActivarEInactivarPlanesCommand.php que leí anteriormente, vi que se usan constantes como:\n- Plan::ESTADO_ACTIVO_ID\n- Plan::ESTADO_PROXIMO_ID\n- Plan::ESTADO_POR_VENCER_ID\n- Plan::ESTADO_VENCIDO_ID\n\nBasándome en el código y los comentarios:\n- Estado 1 = ACTIVO (Plan::ESTADO_ACTIVO_ID)\n- Estado 2 = INACTIVO \n- Estado 3 = PRÓXIMO (Plan::ESTADO_PROXIMO_ID)\n- Estado 4 = POR VENCER (Plan::ESTADO_POR_VENCER_ID)\n- Estado 5 = VENCIDO (Plan::ESTADO_VENCIDO_ID)\n\nVoy a buscar en el archivo las ocurrencias de números de estado y reemplazarlas por las constantes.\n\nEn EmpresaPlanService.php veo:\n- Línea 120: `['estado_id' => 3]` - PRÓXIMO\n- Línea 130: `['estado_id' => 1]` - ACTIVO\n- Línea 144: `['estado_id' => 3]` - PRÓXIMO\n- Línea 146: `['estado_id' => 1]` - ACTIVO\n- Línea 240: `$empresa_plan->estado_id === 3` - PRÓXIMO\n- Línea 248: `in_array($empresa_plan->estado_id, [1, 4])` - ACTIVO, POR_VENCER\n\n\n- Línea 251: `['estado_id' => 3]` - PRÓXIMO\n- Línea 252: `in_array($empresa_plan->estado_id, [2, 5])` - INACTIVO, VENCIDO\n- Línea 255: `['estado_id' => 1]` - ACTIVO\n\nDebo verificar que el modelo Plan contenga todas estas constantes antes de proceder con los reemplazos.","signature":"EqIMCkYICxgCKkB4+OzC9VdurtOmOvu//8yjeZN57my/U3ZL3QJ+JeD4+mv0Y4QugJcOAJNfmHVIqR+yxs03oJrWgAdiGTa9ulw3EgxYojvDxKlEUmfxFU8aDOFAYjM5zQ0idIA5zyIwNhsqtDl2F9NHvma7Rw5hphHi24Yl/UBaliKn0yBIyBYkpO/c3LSS/9V44Wxx6SA0KokLbzLMYv+DsJHAnTlToLOeRTv7z4M3bh7DlvQpsc9F2VzEoVJIz7++bX+3cMBkqOM5bZonZTLrXddorIK9UVQLtsF/TUK1WXy6/CbkibkPPiK+YABKBsCZE10brWAqm0cDwg41u3DOtNMNESMKzOTqx/+LOfMu7ZJHgwM/AsTeEFH0EKkWgg/BZPavYAswN8CmFYOjDR/cb/P8qHLAJV9A6C6PDe5FwcZr81EIzO30C3rJviavj55tt2+34dIAjCoqevbNiAbpQal1H1RSV8Dmt8bXWHimn27pbJkYtWeMYr77r7nJeFsVw10JJloNMvJ5i26ycHcPwqKgZy5Su6/ax3FjJO3Nnt+oTaC+Lu8EzSVYqzgQ6vdJN0QkHOPGp9U/t+hAU0lQY9tlNs+6SnGAgr3ZrXdjQIaXBI0IC1UfQXNNF95zsKwooRMkoPfsHWYNYqwpKRg7c2Wc/B1GbyCeOnEIcMyFx+WB/ciwRhBQQeHpkBGzN8SD2ZXxBTMFSmjlrwH5zFQA0JbMep1igkKBLau8wcwfSmYm28o5TSwtzJlpnmR/e+p1wQJOV1V8FGjX3IJItkZEIYvcxfxY8tthNNvVVOXIrYZko72Pt4e+dcpig63BHvfqmyNaLLQVRP8i+9UqnlMsRKmFd/CJSUgAXrCat5w8Gjm9dbBduE1duPo1X6XxRZHcOMzDUDuMM7Lj3ni4sUJXOZLPxUnb+P+TduvZPPQIkTMZ9NmpWDeupdFpkGB1ofhTyC0+ZivFARxsUMQFXvzcrsW6W6Kyzibj1W9Fg0AkYJaxnaO9rP2RKfSSfCiyOLMbF7i4xqw2O8nkz+ahLPdYSxWp2lD6dqID+MAdY34u5wnU52duG6PUxg2fBW60D0ptUvxFWShnGwKYE/ef9XNqUAuuSjwqqidA4tu2vyCIoPfcm7/5RUKjKFt4v+oA9gW39kuZCzZUN/PokRNzUShx/TTtqAu1FD6dGDMHKDQNxnktS8S0yVkZj5guPdCreyx1rRV6DVAvIvmvESdisJQvkhttA+rnfWfj3vJpCi8BTcqLeF2cuCoVAEfx9mCgzg4sQwwCm5ciqImrKnA/YQ7C2nloC2mK1rDr0OM6W5m0CV0DIzWL/rZPWu9PudBGadlFKfR6kedfsUjcABqagJxvIYIFeO59PJxG86zNjbM89q4yObfN5mxap0aIP/wnGYKg4bQc5KVqmBA3UEPdsODyDUPwJngG9EI7uFj6noskS3XSe/B77xjXNfWP4HltkY4WEF857XAvthBBjEWVT2EG8ccPxP6+eCJaToCxhMPdWJOJqUcxAT83bnh/oWzmv1LHoX+6jYNgfenJGzpS5KtVcbhyhLvkYAcrtloo619qnRmw2bugtqrOOhci/YKXczpfSWGM7ssHhHhYziu/rjHcArQiIi7eIZOL0jLsPc+nt6F7l6zDSMGaHVsXhnMficKE3E3BzanIT+xpnBqxujCfJT5ZjcwahjmlA81X0tJ34N5FqpkMveQe0fW8TN/j+hykjVbdeXjfOlU6MjnbxXF5v6UsRc3PSjJQayLynC0mylBtc/0IIs8/2kIBT/gyglOV+R6pLmd0r+bF46EdM3ejhdMasEu3thYBWx2PwHTm7SCh9hyR9y/mesrfSBCiBE4sOArWPIbQYGcP2fbm9R0mJy67qf1uVfmb809qnURkqlts3k5zok4aGY1qbEE87sGQ4+2NeIJJD7vsyJp9cLr1RQm5J5qi6F2FdhEnvgv5bkZeyVx5zrZJPSNp6U9/0xlvsTXPu+RsrnOI00FBlTKT1l7PnqwzJgmpZrJyjSQ5F2NdlwsecAFUYZNTHVHqMWEEv3BTcLWiK0B50dpHWqcTE4gW1Cq7ekZWwVQrulGyn337gRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":55939,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":55939,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2dipWS3yDEsnGW4QUb","type":"assistant","uuid":"f4fcb0d8-4f49-4d33-bfee-ac94afd47120","timestamp":"2026-01-22T20:14:26.111Z"}
{"parentUuid":"f4fcb0d8-4f49-4d33-bfee-ac94afd47120","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018r6X3ZKqoWGsrLxgutW28G","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a reemplazar los números mágicos de estados por las constantes del modelo Plan."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":55939,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":55939,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2dipWS3yDEsnGW4QUb","type":"assistant","uuid":"1dd97404-e6ce-49a2-b00a-a4d91fa14545","timestamp":"2026-01-22T20:14:26.126Z"}
{"parentUuid":"1dd97404-e6ce-49a2-b00a-a4d91fa14545","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018r6X3ZKqoWGsrLxgutW28G","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018M4R3jsqKFLZdzLrymntYp","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"use App\\Http\\Services\\BaseService;\nuse App\\Models\\Pruebas\\TipoPrueba;","new_string":"use App\\Http\\Services\\BaseService;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Pruebas\\TipoPrueba;"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":55939,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":55939,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2dipWS3yDEsnGW4QUb","type":"assistant","uuid":"9b65e43e-f48b-4678-b529-c093d2e5093f","timestamp":"2026-01-22T20:14:26.830Z"}
{"parentUuid":"9b65e43e-f48b-4678-b529-c093d2e5093f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018r6X3ZKqoWGsrLxgutW28G","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018Uxfdu9RYnQpouamydFrq3","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"                // Poner el nuevo plan como proximo\n                $request->merge(['estado_id' => 3]);","new_string":"                // Poner el nuevo plan como proximo\n                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":55939,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":55939,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2dipWS3yDEsnGW4QUb","type":"assistant","uuid":"4e56bb2b-c067-4ffd-9303-318e28ae3fcc","timestamp":"2026-01-22T20:14:28.402Z"}
{"parentUuid":"4e56bb2b-c067-4ffd-9303-318e28ae3fcc","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018r6X3ZKqoWGsrLxgutW28G","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018XReqebzd6red6QkgCKYrm","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"            } else {\n                $request->merge(['estado_id' => 1]);\n\n                // Validar si el plan seleccionado tiene vigencia","new_string":"            } else {\n                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n\n                // Validar si el plan seleccionado tiene vigencia"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":55939,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":55939,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2dipWS3yDEsnGW4QUb","type":"assistant","uuid":"62c8e3d1-b25d-40af-a19e-f27aee714fa6","timestamp":"2026-01-22T20:14:29.955Z"}
{"parentUuid":"62c8e3d1-b25d-40af-a19e-f27aee714fa6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018r6X3ZKqoWGsrLxgutW28G","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KWCJRN5UBrJztxGmacJLXi","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"            if (!is_null($plan_activo)) {\n                $request->merge(['estado_id' => 3]);\n            } else {\n                $request->merge(['estado_id' => 1]);\n            }","new_string":"            if (!is_null($plan_activo)) {\n                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n            } else {\n                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n            }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":55939,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":55939,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2dipWS3yDEsnGW4QUb","type":"assistant","uuid":"74062d90-352f-46b9-8751-485a86c1a797","timestamp":"2026-01-22T20:14:31.656Z"}
{"parentUuid":"74062d90-352f-46b9-8751-485a86c1a797","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018r6X3ZKqoWGsrLxgutW28G","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YURzULmwVS74dAZQygYbfu","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }","new_string":"        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":55939,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":55939,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2dipWS3yDEsnGW4QUb","type":"assistant","uuid":"6a2c43cc-8fd6-49b0-bdd3-f4ab4744da17","timestamp":"2026-01-22T20:14:33.311Z"}
{"parentUuid":"6a2c43cc-8fd6-49b0-bdd3-f4ab4744da17","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018r6X3ZKqoWGsrLxgutW28G","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019qwyjzhPsSGQPp1brukN9j","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n\n            $request->merge(['estado_id' => 1]);\n        }","new_string":"        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n        }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":55939,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":55939,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2dipWS3yDEsnGW4QUb","type":"assistant","uuid":"d80f0ebc-0a69-4909-ab95-775fb3fbae86","timestamp":"2026-01-22T20:14:37.183Z"}
{"type":"file-history-snapshot","messageId":"9b65e43e-f48b-4678-b529-c093d2e5093f","snapshot":{"messageId":"8cd8037f-c69b-43c2-ac0c-aaf63d6083cb","trackedFileBackups":{"app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php":{"backupFileName":"b4706ac638207036@v2","version":2,"backupTime":"2026-01-22T19:45:29.008Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"115edace5e384ff2@v2","version":2,"backupTime":"2026-01-22T20:13:17.509Z"},"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"87ffcf5aa4ef1291@v1","version":1,"backupTime":"2026-01-22T20:15:55.407Z"}},"timestamp":"2026-01-22T20:14:14.049Z"},"isSnapshotUpdate":true}
{"parentUuid":"9b65e43e-f48b-4678-b529-c093d2e5093f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018M4R3jsqKFLZdzLrymntYp","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated successfully."}]},"uuid":"28d04739-4785-41bc-a046-0c987084f74d","timestamp":"2026-01-22T20:15:55.405Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"use App\\Http\\Services\\BaseService;\nuse App\\Models\\Pruebas\\TipoPrueba;","newString":"use App\\Http\\Services\\BaseService;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Pruebas\\TipoPrueba;","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $es_solo_creditos = $request->filled('plan_credito_id') && !$request->filled('plan_id');\n        $plan = null;\n        $plan_activo = null;\n        $vigencia = null;\n\n        if (!$es_solo_creditos) {\n            $plan = $this->plan_repositorio->getUno($request->plan_id);\n            $plan_activo = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n            $vigencia = $plan->vigencia;\n        } else {\n            $request->merge(['plan_id' => null]);\n            $plan_activo = $this->repositorio->planCreditosActivo($request->empresa_id);\n        }\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        } elseif (!$request->filled('plan_credito_id')) {\n            $request->merge([\n                'plan_credito_id' => null,\n                'creditos' => 0\n            ]);\n        }\n\n        if (!$es_solo_creditos) {\n            if ($request->filled('vigencia')) {\n                $vigencia = $request->vigencia;\n            }\n\n            if (!is_null($plan_activo)) {\n                if ($request->filled('id')) {\n                    // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                    if ($request->id === $plan_activo->id) {\n                        goto omitir_calcular_vigencia;\n                    }\n\n                    // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                    if ($vigencia == $request->vigencia) {\n                        array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                        goto omitir_calcular_vigencia;\n                    }\n                }\n\n                // Poner el nuevo plan como proximo\n                $request->merge(['estado_id' => 3]);\n\n                // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n                if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                    // Agregar las nuevas fechas al nuevo plan\n                    $hoy = now();\n                    $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                    $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n                }\n            } else {\n                $request->merge(['estado_id' => 1]);\n\n                // Validar si el plan seleccionado tiene vigencia\n                if (!is_null($plan->vigencia)) {\n                    $request->merge($this->calcularFechasVigencia($vigencia));\n                }\n            }\n        } else {\n            $request->merge([\n                'fecha_inicio' => null,\n                'fecha_vencimiento' => null\n            ]);\n\n            if (!is_null($plan_activo)) {\n                $request->merge(['estado_id' => 3]);\n            } else {\n                $request->merge(['estado_id' => 1]);\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$es_solo_creditos) {\n            if (!$request->filled('unidades')) {\n                $request->merge(['unidades' => $plan->unidades]);\n            } elseif ($request->unidades != $plan->unidades) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_ofertas_laborales')) {\n                $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n            } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_usuarios')) {\n                $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n            } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_pruebas')) {\n                $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n            } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            // Comprobar si se modificaron las funcionalidades respecto al plan original\n            if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n                $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n                $primera_comparacion = array_diff($request->funcionalidades, $funcionalidades_originales);\n                $segunda_comparacion = array_diff($funcionalidades_originales, $request->funcionalidades);\n                if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                    $request->merge(['plan_original' => false]);\n                }\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy = now();\n\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses = $vigencia / 30;\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n\n        $this->generarDirectorios(\"app/{$ruta}\");\n\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n\n            'modelo_id' => $id,\n\n            'nombre' => 'factura',\n\n            'ruta' => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n\n        $request->merge([\n            'con_conteo_consumos_agendas' => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n\n            RolRepository::ROL_PROPIETARIO_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n\n            $plan->creditos_consumidos = $creditos_consumidos;\n\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id' => $empresa_id,\n            'tipo_prueba_id' => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan = $this->plan_repositorio->getUno($request->plan_id);\n\n        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_SUPERADMIN_ID,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n\n            'empresa_id' => $request->empresa_id,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id' => $empresa_id,\n            'empresa_plan_id' => $empresa_plan->id,\n            'creditos_plan' => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito' => $empresa_plan->planCredito ? [\n                'id' => $empresa_plan->planCredito->id,\n                'nombre' => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio' => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":10,"oldLines":6,"newStart":10,"newLines":7,"lines":[" use App\\Mail\\CrearUsuarioMail;"," use Illuminate\\Http\\UploadedFile;"," use App\\Http\\Services\\BaseService;","+use App\\Models\\Planes\\Plan;"," use App\\Models\\Pruebas\\TipoPrueba;"," use Illuminate\\Support\\Collection;"," use App\\Models\\Empresas\\EmpresaPlan;"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"9b65e43e-f48b-4678-b529-c093d2e5093f"}
{"parentUuid":"4e56bb2b-c067-4ffd-9303-318e28ae3fcc","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018Uxfdu9RYnQpouamydFrq3","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated successfully."}]},"uuid":"16da0441-cdd5-42d8-aecb-51796ba637c7","timestamp":"2026-01-22T20:15:58.144Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"                // Poner el nuevo plan como proximo\n                $request->merge(['estado_id' => 3]);","newString":"                // Poner el nuevo plan como proximo\n                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $es_solo_creditos = $request->filled('plan_credito_id') && !$request->filled('plan_id');\n        $plan = null;\n        $plan_activo = null;\n        $vigencia = null;\n\n        if (!$es_solo_creditos) {\n            $plan = $this->plan_repositorio->getUno($request->plan_id);\n            $plan_activo = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n            $vigencia = $plan->vigencia;\n        } else {\n            $request->merge(['plan_id' => null]);\n            $plan_activo = $this->repositorio->planCreditosActivo($request->empresa_id);\n        }\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        } elseif (!$request->filled('plan_credito_id')) {\n            $request->merge([\n                'plan_credito_id' => null,\n                'creditos' => 0\n            ]);\n        }\n\n        if (!$es_solo_creditos) {\n            if ($request->filled('vigencia')) {\n                $vigencia = $request->vigencia;\n            }\n\n            if (!is_null($plan_activo)) {\n                if ($request->filled('id')) {\n                    // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                    if ($request->id === $plan_activo->id) {\n                        goto omitir_calcular_vigencia;\n                    }\n\n                    // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                    if ($vigencia == $request->vigencia) {\n                        array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                        goto omitir_calcular_vigencia;\n                    }\n                }\n\n                // Poner el nuevo plan como proximo\n                $request->merge(['estado_id' => 3]);\n\n                // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n                if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                    // Agregar las nuevas fechas al nuevo plan\n                    $hoy = now();\n                    $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                    $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n                }\n            } else {\n                $request->merge(['estado_id' => 1]);\n\n                // Validar si el plan seleccionado tiene vigencia\n                if (!is_null($plan->vigencia)) {\n                    $request->merge($this->calcularFechasVigencia($vigencia));\n                }\n            }\n        } else {\n            $request->merge([\n                'fecha_inicio' => null,\n                'fecha_vencimiento' => null\n            ]);\n\n            if (!is_null($plan_activo)) {\n                $request->merge(['estado_id' => 3]);\n            } else {\n                $request->merge(['estado_id' => 1]);\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$es_solo_creditos) {\n            if (!$request->filled('unidades')) {\n                $request->merge(['unidades' => $plan->unidades]);\n            } elseif ($request->unidades != $plan->unidades) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_ofertas_laborales')) {\n                $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n            } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_usuarios')) {\n                $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n            } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_pruebas')) {\n                $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n            } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            // Comprobar si se modificaron las funcionalidades respecto al plan original\n            if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n                $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n                $primera_comparacion = array_diff($request->funcionalidades, $funcionalidades_originales);\n                $segunda_comparacion = array_diff($funcionalidades_originales, $request->funcionalidades);\n                if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                    $request->merge(['plan_original' => false]);\n                }\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy = now();\n\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses = $vigencia / 30;\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n\n        $this->generarDirectorios(\"app/{$ruta}\");\n\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n\n            'modelo_id' => $id,\n\n            'nombre' => 'factura',\n\n            'ruta' => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n\n        $request->merge([\n            'con_conteo_consumos_agendas' => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n\n            RolRepository::ROL_PROPIETARIO_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n\n            $plan->creditos_consumidos = $creditos_consumidos;\n\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id' => $empresa_id,\n            'tipo_prueba_id' => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan = $this->plan_repositorio->getUno($request->plan_id);\n\n        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_SUPERADMIN_ID,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n\n            'empresa_id' => $request->empresa_id,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id' => $empresa_id,\n            'empresa_plan_id' => $empresa_plan->id,\n            'creditos_plan' => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito' => $empresa_plan->planCredito ? [\n                'id' => $empresa_plan->planCredito->id,\n                'nombre' => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio' => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":118,"oldLines":7,"newStart":118,"newLines":7,"lines":["                 }"," ","                 // Poner el nuevo plan como proximo","-                $request->merge(['estado_id' => 3]);","+                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);"," ","                 // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia","                 if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"4e56bb2b-c067-4ffd-9303-318e28ae3fcc"}
{"parentUuid":"62c8e3d1-b25d-40af-a19e-f27aee714fa6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018XReqebzd6red6QkgCKYrm","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated successfully."}]},"uuid":"a022eda1-04c2-4c27-a812-14a9a03ed7d6","timestamp":"2026-01-22T20:16:00.325Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"            } else {\n                $request->merge(['estado_id' => 1]);\n\n                // Validar si el plan seleccionado tiene vigencia","newString":"            } else {\n                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n\n                // Validar si el plan seleccionado tiene vigencia","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $es_solo_creditos = $request->filled('plan_credito_id') && !$request->filled('plan_id');\n        $plan = null;\n        $plan_activo = null;\n        $vigencia = null;\n\n        if (!$es_solo_creditos) {\n            $plan = $this->plan_repositorio->getUno($request->plan_id);\n            $plan_activo = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n            $vigencia = $plan->vigencia;\n        } else {\n            $request->merge(['plan_id' => null]);\n            $plan_activo = $this->repositorio->planCreditosActivo($request->empresa_id);\n        }\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        } elseif (!$request->filled('plan_credito_id')) {\n            $request->merge([\n                'plan_credito_id' => null,\n                'creditos' => 0\n            ]);\n        }\n\n        if (!$es_solo_creditos) {\n            if ($request->filled('vigencia')) {\n                $vigencia = $request->vigencia;\n            }\n\n            if (!is_null($plan_activo)) {\n                if ($request->filled('id')) {\n                    // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                    if ($request->id === $plan_activo->id) {\n                        goto omitir_calcular_vigencia;\n                    }\n\n                    // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                    if ($vigencia == $request->vigencia) {\n                        array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                        goto omitir_calcular_vigencia;\n                    }\n                }\n\n                // Poner el nuevo plan como proximo\n                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n\n                // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n                if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                    // Agregar las nuevas fechas al nuevo plan\n                    $hoy = now();\n                    $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                    $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n                }\n            } else {\n                $request->merge(['estado_id' => 1]);\n\n                // Validar si el plan seleccionado tiene vigencia\n                if (!is_null($plan->vigencia)) {\n                    $request->merge($this->calcularFechasVigencia($vigencia));\n                }\n            }\n        } else {\n            $request->merge([\n                'fecha_inicio' => null,\n                'fecha_vencimiento' => null\n            ]);\n\n            if (!is_null($plan_activo)) {\n                $request->merge(['estado_id' => 3]);\n            } else {\n                $request->merge(['estado_id' => 1]);\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$es_solo_creditos) {\n            if (!$request->filled('unidades')) {\n                $request->merge(['unidades' => $plan->unidades]);\n            } elseif ($request->unidades != $plan->unidades) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_ofertas_laborales')) {\n                $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n            } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_usuarios')) {\n                $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n            } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_pruebas')) {\n                $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n            } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            // Comprobar si se modificaron las funcionalidades respecto al plan original\n            if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n                $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n                $primera_comparacion = array_diff($request->funcionalidades, $funcionalidades_originales);\n                $segunda_comparacion = array_diff($funcionalidades_originales, $request->funcionalidades);\n                if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                    $request->merge(['plan_original' => false]);\n                }\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy = now();\n\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses = $vigencia / 30;\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n\n        $this->generarDirectorios(\"app/{$ruta}\");\n\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n\n            'modelo_id' => $id,\n\n            'nombre' => 'factura',\n\n            'ruta' => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n\n        $request->merge([\n            'con_conteo_consumos_agendas' => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n\n            RolRepository::ROL_PROPIETARIO_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n\n            $plan->creditos_consumidos = $creditos_consumidos;\n\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id' => $empresa_id,\n            'tipo_prueba_id' => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan = $this->plan_repositorio->getUno($request->plan_id);\n\n        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_SUPERADMIN_ID,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n\n            'empresa_id' => $request->empresa_id,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id' => $empresa_id,\n            'empresa_plan_id' => $empresa_plan->id,\n            'creditos_plan' => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito' => $empresa_plan->planCredito ? [\n                'id' => $empresa_plan->planCredito->id,\n                'nombre' => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio' => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":128,"oldLines":7,"newStart":128,"newLines":7,"lines":["                     $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));","                 }","             } else {","-                $request->merge(['estado_id' => 1]);","+                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);"," ","                 // Validar si el plan seleccionado tiene vigencia","                 if (!is_null($plan->vigencia)) {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"62c8e3d1-b25d-40af-a19e-f27aee714fa6"}
{"parentUuid":"74062d90-352f-46b9-8751-485a86c1a797","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KWCJRN5UBrJztxGmacJLXi","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated successfully."}]},"uuid":"8a85940e-4823-4118-9b51-29ebb5104f94","timestamp":"2026-01-22T20:16:01.996Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"            if (!is_null($plan_activo)) {\n                $request->merge(['estado_id' => 3]);\n            } else {\n                $request->merge(['estado_id' => 1]);\n            }","newString":"            if (!is_null($plan_activo)) {\n                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n            } else {\n                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n            }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $es_solo_creditos = $request->filled('plan_credito_id') && !$request->filled('plan_id');\n        $plan = null;\n        $plan_activo = null;\n        $vigencia = null;\n\n        if (!$es_solo_creditos) {\n            $plan = $this->plan_repositorio->getUno($request->plan_id);\n            $plan_activo = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n            $vigencia = $plan->vigencia;\n        } else {\n            $request->merge(['plan_id' => null]);\n            $plan_activo = $this->repositorio->planCreditosActivo($request->empresa_id);\n        }\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        } elseif (!$request->filled('plan_credito_id')) {\n            $request->merge([\n                'plan_credito_id' => null,\n                'creditos' => 0\n            ]);\n        }\n\n        if (!$es_solo_creditos) {\n            if ($request->filled('vigencia')) {\n                $vigencia = $request->vigencia;\n            }\n\n            if (!is_null($plan_activo)) {\n                if ($request->filled('id')) {\n                    // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                    if ($request->id === $plan_activo->id) {\n                        goto omitir_calcular_vigencia;\n                    }\n\n                    // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                    if ($vigencia == $request->vigencia) {\n                        array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                        goto omitir_calcular_vigencia;\n                    }\n                }\n\n                // Poner el nuevo plan como proximo\n                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n\n                // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n                if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                    // Agregar las nuevas fechas al nuevo plan\n                    $hoy = now();\n                    $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                    $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n                }\n            } else {\n                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n\n                // Validar si el plan seleccionado tiene vigencia\n                if (!is_null($plan->vigencia)) {\n                    $request->merge($this->calcularFechasVigencia($vigencia));\n                }\n            }\n        } else {\n            $request->merge([\n                'fecha_inicio' => null,\n                'fecha_vencimiento' => null\n            ]);\n\n            if (!is_null($plan_activo)) {\n                $request->merge(['estado_id' => 3]);\n            } else {\n                $request->merge(['estado_id' => 1]);\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$es_solo_creditos) {\n            if (!$request->filled('unidades')) {\n                $request->merge(['unidades' => $plan->unidades]);\n            } elseif ($request->unidades != $plan->unidades) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_ofertas_laborales')) {\n                $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n            } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_usuarios')) {\n                $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n            } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_pruebas')) {\n                $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n            } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            // Comprobar si se modificaron las funcionalidades respecto al plan original\n            if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n                $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n                $primera_comparacion = array_diff($request->funcionalidades, $funcionalidades_originales);\n                $segunda_comparacion = array_diff($funcionalidades_originales, $request->funcionalidades);\n                if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                    $request->merge(['plan_original' => false]);\n                }\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy = now();\n\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses = $vigencia / 30;\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n\n        $this->generarDirectorios(\"app/{$ruta}\");\n\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n\n            'modelo_id' => $id,\n\n            'nombre' => 'factura',\n\n            'ruta' => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n\n        $request->merge([\n            'con_conteo_consumos_agendas' => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n\n            RolRepository::ROL_PROPIETARIO_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n\n            $plan->creditos_consumidos = $creditos_consumidos;\n\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id' => $empresa_id,\n            'tipo_prueba_id' => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan = $this->plan_repositorio->getUno($request->plan_id);\n\n        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_SUPERADMIN_ID,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n\n            'empresa_id' => $request->empresa_id,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id' => $empresa_id,\n            'empresa_plan_id' => $empresa_plan->id,\n            'creditos_plan' => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito' => $empresa_plan->planCredito ? [\n                'id' => $empresa_plan->planCredito->id,\n                'nombre' => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio' => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":142,"oldLines":9,"newStart":142,"newLines":9,"lines":["             ]);"," ","             if (!is_null($plan_activo)) {","-                $request->merge(['estado_id' => 3]);","+                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);","             } else {","-                $request->merge(['estado_id' => 1]);","+                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);","             }","         }"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"74062d90-352f-46b9-8751-485a86c1a797"}
{"parentUuid":"6a2c43cc-8fd6-49b0-bdd3-f4ab4744da17","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YURzULmwVS74dAZQygYbfu","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated successfully."}]},"uuid":"e78de401-c3b2-43c9-b69e-45018525112d","timestamp":"2026-01-22T20:16:03.875Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }","newString":"        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $es_solo_creditos = $request->filled('plan_credito_id') && !$request->filled('plan_id');\n        $plan = null;\n        $plan_activo = null;\n        $vigencia = null;\n\n        if (!$es_solo_creditos) {\n            $plan = $this->plan_repositorio->getUno($request->plan_id);\n            $plan_activo = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n            $vigencia = $plan->vigencia;\n        } else {\n            $request->merge(['plan_id' => null]);\n            $plan_activo = $this->repositorio->planCreditosActivo($request->empresa_id);\n        }\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        } elseif (!$request->filled('plan_credito_id')) {\n            $request->merge([\n                'plan_credito_id' => null,\n                'creditos' => 0\n            ]);\n        }\n\n        if (!$es_solo_creditos) {\n            if ($request->filled('vigencia')) {\n                $vigencia = $request->vigencia;\n            }\n\n            if (!is_null($plan_activo)) {\n                if ($request->filled('id')) {\n                    // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                    if ($request->id === $plan_activo->id) {\n                        goto omitir_calcular_vigencia;\n                    }\n\n                    // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                    if ($vigencia == $request->vigencia) {\n                        array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                        goto omitir_calcular_vigencia;\n                    }\n                }\n\n                // Poner el nuevo plan como proximo\n                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n\n                // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n                if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                    // Agregar las nuevas fechas al nuevo plan\n                    $hoy = now();\n                    $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                    $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n                }\n            } else {\n                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n\n                // Validar si el plan seleccionado tiene vigencia\n                if (!is_null($plan->vigencia)) {\n                    $request->merge($this->calcularFechasVigencia($vigencia));\n                }\n            }\n        } else {\n            $request->merge([\n                'fecha_inicio' => null,\n                'fecha_vencimiento' => null\n            ]);\n\n            if (!is_null($plan_activo)) {\n                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n            } else {\n                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$es_solo_creditos) {\n            if (!$request->filled('unidades')) {\n                $request->merge(['unidades' => $plan->unidades]);\n            } elseif ($request->unidades != $plan->unidades) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_ofertas_laborales')) {\n                $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n            } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_usuarios')) {\n                $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n            } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_pruebas')) {\n                $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n            } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            // Comprobar si se modificaron las funcionalidades respecto al plan original\n            if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n                $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n                $primera_comparacion = array_diff($request->funcionalidades, $funcionalidades_originales);\n                $segunda_comparacion = array_diff($funcionalidades_originales, $request->funcionalidades);\n                if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                    $request->merge(['plan_original' => false]);\n                }\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy = now();\n\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses = $vigencia / 30;\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n\n        $this->generarDirectorios(\"app/{$ruta}\");\n\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n\n            'modelo_id' => $id,\n\n            'nombre' => 'factura',\n\n            'ruta' => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n\n        $request->merge([\n            'con_conteo_consumos_agendas' => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n\n            RolRepository::ROL_PROPIETARIO_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n\n            $plan->creditos_consumidos = $creditos_consumidos;\n\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id' => $empresa_id,\n            'tipo_prueba_id' => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan = $this->plan_repositorio->getUno($request->plan_id);\n\n        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_SUPERADMIN_ID,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n\n            'empresa_id' => $request->empresa_id,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id' => $empresa_id,\n            'empresa_plan_id' => $empresa_plan->id,\n            'creditos_plan' => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito' => $empresa_plan->planCredito ? [\n                'id' => $empresa_plan->planCredito->id,\n                'nombre' => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio' => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":238,"oldLines":7,"newStart":238,"newLines":7,"lines":["     public function renovar(int $id): EmpresaPlan {","         $empresa_plan = $this->repositorio->getUno($id);"," ","-        if ($empresa_plan->estado_id === 3) {","+        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {","             throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');","         }"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"6a2c43cc-8fd6-49b0-bdd3-f4ab4744da17"}
{"parentUuid":"d80f0ebc-0a69-4909-ab95-775fb3fbae86","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019qwyjzhPsSGQPp1brukN9j","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated successfully."}]},"uuid":"d1f5fc2f-6974-4983-8700-9111513b2d17","timestamp":"2026-01-22T20:16:06.757Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n\n            $request->merge(['estado_id' => 1]);\n        }","newString":"        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n        }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $es_solo_creditos = $request->filled('plan_credito_id') && !$request->filled('plan_id');\n        $plan = null;\n        $plan_activo = null;\n        $vigencia = null;\n\n        if (!$es_solo_creditos) {\n            $plan = $this->plan_repositorio->getUno($request->plan_id);\n            $plan_activo = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n            $vigencia = $plan->vigencia;\n        } else {\n            $request->merge(['plan_id' => null]);\n            $plan_activo = $this->repositorio->planCreditosActivo($request->empresa_id);\n        }\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        } elseif (!$request->filled('plan_credito_id')) {\n            $request->merge([\n                'plan_credito_id' => null,\n                'creditos' => 0\n            ]);\n        }\n\n        if (!$es_solo_creditos) {\n            if ($request->filled('vigencia')) {\n                $vigencia = $request->vigencia;\n            }\n\n            if (!is_null($plan_activo)) {\n                if ($request->filled('id')) {\n                    // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                    if ($request->id === $plan_activo->id) {\n                        goto omitir_calcular_vigencia;\n                    }\n\n                    // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                    if ($vigencia == $request->vigencia) {\n                        array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                        goto omitir_calcular_vigencia;\n                    }\n                }\n\n                // Poner el nuevo plan como proximo\n                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n\n                // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n                if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                    // Agregar las nuevas fechas al nuevo plan\n                    $hoy = now();\n                    $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                    $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n                }\n            } else {\n                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n\n                // Validar si el plan seleccionado tiene vigencia\n                if (!is_null($plan->vigencia)) {\n                    $request->merge($this->calcularFechasVigencia($vigencia));\n                }\n            }\n        } else {\n            $request->merge([\n                'fecha_inicio' => null,\n                'fecha_vencimiento' => null\n            ]);\n\n            if (!is_null($plan_activo)) {\n                $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n            } else {\n                $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$es_solo_creditos) {\n            if (!$request->filled('unidades')) {\n                $request->merge(['unidades' => $plan->unidades]);\n            } elseif ($request->unidades != $plan->unidades) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_ofertas_laborales')) {\n                $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n            } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_usuarios')) {\n                $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n            } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            if (!$request->filled('cantidad_pruebas')) {\n                $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n            } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n                $request->merge(['plan_original' => false]);\n            }\n\n            // Comprobar si se modificaron las funcionalidades respecto al plan original\n            if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n                $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n                $primera_comparacion = array_diff($request->funcionalidades, $funcionalidades_originales);\n                $segunda_comparacion = array_diff($funcionalidades_originales, $request->funcionalidades);\n                if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                    $request->merge(['plan_original' => false]);\n                }\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy = now();\n\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses = $vigencia / 30;\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n\n        $this->generarDirectorios(\"app/{$ruta}\");\n\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n\n            'modelo_id' => $id,\n\n            'nombre' => 'factura',\n\n            'ruta' => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n\n        $request->merge([\n            'con_conteo_consumos_agendas' => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n\n            RolRepository::ROL_PROPIETARIO_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n\n            $plan->creditos_consumidos = $creditos_consumidos;\n\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id' => $empresa_id,\n            'tipo_prueba_id' => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan = $this->plan_repositorio->getUno($request->plan_id);\n\n        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_SUPERADMIN_ID,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id' => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n\n            'empresa_id' => $request->empresa_id,\n\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id' => $empresa_id,\n            'empresa_plan_id' => $empresa_plan->id,\n            'creditos_plan' => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito' => $empresa_plan->planCredito ? [\n                'id' => $empresa_plan->planCredito->id,\n                'nombre' => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio' => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":246,"oldLines":14,"newStart":246,"newLines":12,"lines":[" ","         $request->merge(['por_facturar' => true]);"," ","-        if (in_array($empresa_plan->estado_id, [1, 4])) {","+        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {","             // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'","-","-            $request->merge(['estado_id' => 3]);","-        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {","+            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);","+        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {","             // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'","-","-            $request->merge(['estado_id' => 1]);","+            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);","         }"," ","         $this->verificarYAsignarTiempo($empresa_plan, $request);"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d80f0ebc-0a69-4909-ab95-775fb3fbae86"}
{"parentUuid":"d1f5fc2f-6974-4983-8700-9111513b2d17","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TL9veqJx36YA328esVRQ5V","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Todas las ediciones se aplicaron correctamente. Ahora voy a ejecutar pint sobre el archivo para asegurar que el formato sea correcto.","signature":"Eq4CCkYICxgCKkA0k5Ub8TpijeBjZZzEmNQbcO/EE1ANPFaEnE3bCFJ7K+OW68sj/qPV2uzbPW10Mkao99r8F98G3wufplsVTWy1Egx3Ooxl4Qq1bSb6FLMaDHZXmbPEqGf2A5fptSIwo7qDbTUfq+YUHiZnFc+GsDwpVtJaORV210yeOOja3Pg6vSTaZccP3iGjGZ34Vb8AKpUB7jsKO65fz/F56xIHOWcVa8YiWIf/2Mbixf2uv7T/e2AsAnDBZwRIOazQYEzrZnJjtuaKtxM4HJJqmPDV3tM3HxjMsneIMKT1+RhUvh1ro4sxA0dGZJd3Cat8ayTZzYnB7wx9LrPwVvSNMuweZhI/9MTrzNjT6/JCQgeK9Dn4Zhg66cYGgtWkfy5a4SPwq7XBn4L6h0kYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2672,"cache_read_input_tokens":55939,"cache_creation":{"ephemeral_5m_input_tokens":2672,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2n44cfnANV1qqedkoT","type":"assistant","uuid":"3eb73e9b-0a0b-4425-9ea7-0fc999851db4","timestamp":"2026-01-22T20:16:11.200Z"}
{"parentUuid":"3eb73e9b-0a0b-4425-9ea7-0fc999851db4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TL9veqJx36YA328esVRQ5V","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora ejecuto Laravel Pint sobre el archivo."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2672,"cache_read_input_tokens":55939,"cache_creation":{"ephemeral_5m_input_tokens":2672,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2n44cfnANV1qqedkoT","type":"assistant","uuid":"15b602e3-55d9-48f3-82f6-3633cfd85133","timestamp":"2026-01-22T20:16:11.641Z"}
{"parentUuid":"15b602e3-55d9-48f3-82f6-3633cfd85133","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TL9veqJx36YA328esVRQ5V","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NAkJK572kC6ToGEBKbfBKp","name":"Bash","input":{"command":"cd C:/Users/sergio/proyectos/Psicoalianza-2 && vendor/bin/pint app/Http/Services/Empresas/EmpresaPlanService.php","description":"Ejecutar Laravel Pint en EmpresaPlanService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2672,"cache_read_input_tokens":55939,"cache_creation":{"ephemeral_5m_input_tokens":2672,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2n44cfnANV1qqedkoT","type":"assistant","uuid":"c6e88661-ea15-468b-bbff-4eff8d321c3a","timestamp":"2026-01-22T20:16:12.628Z"}
{"parentUuid":"c6e88661-ea15-468b-bbff-4eff8d321c3a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NAkJK572kC6ToGEBKbfBKp","type":"tool_result","content":"  \u001b[32;1m✓\u001b[39;22m\n\n  \u001b[90m────────────────────────────────────────────────────────────────────────────────────────────────────────────────\u001b[39m \u001b[90mPER\u001b[39m  \n  \u001b[90;42;1m  FIXED  \u001b[39;49;22m \u001b[90m..............................................................................\u001b[39m 1 file, 1 style issue fixed  \r\n  \u001b[32;1m✓\u001b[39;22m app\\Http\\Services\\Empresas\\EmpresaPlanService.php \u001b[90mbraces, braces_position, curly_braces_position, blank_line_befo…\u001b[39m","is_error":false}]},"uuid":"34ca9da9-bb2e-4b9c-8bfe-96b18bbdf9d4","timestamp":"2026-01-22T20:16:17.781Z","toolUseResult":{"stdout":"  \u001b[32;1m✓\u001b[39;22m\n\n  \u001b[90m────────────────────────────────────────────────────────────────────────────────────────────────────────────────\u001b[39m \u001b[90mPER\u001b[39m  \n  \u001b[90;42;1m  FIXED  \u001b[39;49;22m \u001b[90m..............................................................................\u001b[39m 1 file, 1 style issue fixed  \r\n  \u001b[32;1m✓\u001b[39;22m app\\Http\\Services\\Empresas\\EmpresaPlanService.php \u001b[90mbraces, braces_position, curly_braces_position, blank_line_befo…\u001b[39m\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"c6e88661-ea15-468b-bbff-4eff8d321c3a"}
{"parentUuid":"34ca9da9-bb2e-4b9c-8bfe-96b18bbdf9d4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QjoYvLArWyJcL71gXXY6hD","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Se aplicaron todos los cambios y Pint corrigió el formato del archivo. Los números mágicos de estados han sido reemplazados por las constantes:\n\n- `1` → `Plan::ESTADO_ACTIVO_ID`\n- `2` → `Plan::ESTADO_INACTIVO_ID`\n- `3` → `Plan::ESTADO_PROXIMO_ID`\n- `4` → `Plan::ESTADO_POR_VENCER_ID`\n- `5` → `Plan::ESTADO_VENCIDO_ID`\n\nTambién se agregó el import de `App\\Models\\Planes\\Plan` al archivo.","signature":"ErUECkYICxgCKkBPWJeZF31a/4JBWlQjaoJvytNrMJXzr45oxlZnM0EetBHu9u+idTkA914oE0qWBPQbkMi388CVE7JeUE+U1n6XEgyJub6+i/vb3e1cJfcaDOPzwhSUkHJyhyUqqiIwq6MuOvMI32LKB8Qj2Y5TlvOFyukFO49R7SmPlMm0NgjpX99HoV3Ayh5u1nCL1BQrKpwDPHgqPq2Gx3LcepGAm7kzuN5SwnUs9zy+FW0ENNZu2RzaIvDqM51n+Ud1UqQ3UJtLJnkBhfau4CzCvz//QU66iUQmD0HBdpH1Z0t2Q2SOsGiHMhm+x7F/zgDwG7tqsJ+FqC3V78mhbUZsKrycQSWQxf0j6KsiBGOXaYyq2t3t7bsBaetz40wKxE/cXGIfbiqKquNfvz5TbyHRQdZdoheH7FV++mJrEu3KnCmJYMWYbYtJLgpJtlhC9pWum9aWa8VtElFJWwmNQ5v066dyXBa8CzIhqUJhl81KVzx+p45hCkx3E9uMw2CJhahjM+jS4ld8YYuBv2ECYlaU6x1JmvF8HmKqHXHZEm194jgNhCjojx1ZoWeQo1CmgdtI/QvseoUjIcggaJgPk4DimrTqcZGdocoQgTEOtFKqvWaWYN8YVKHWVIa/67wMuwm/ROjc53s6auXXlfQvbp4DMK5xwGw1t6lKXn0kSuc/LCe1meynHWhHW1pluAWPLRvwOb+b+CeXIiFHpf5MS3TEehC+/yw6U9igASmSlSZ752SngBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3729,"cache_read_input_tokens":58611,"cache_creation":{"ephemeral_5m_input_tokens":3729,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP2nt86d5sVE2v8VcTRB","type":"assistant","uuid":"deb3918a-1f73-4892-b91a-4f2efd18f814","timestamp":"2026-01-22T20:16:22.713Z"}
{"parentUuid":"deb3918a-1f73-4892-b91a-4f2efd18f814","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QjoYvLArWyJcL71gXXY6hD","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Se reemplazaron todos los números mágicos de estados por las constantes del modelo Plan:\n\n- `1` → `Plan::ESTADO_ACTIVO_ID`\n- `2` → `Plan::ESTADO_INACTIVO_ID`\n- `3` → `Plan::ESTADO_PROXIMO_ID`\n- `4` → `Plan::ESTADO_POR_VENCER_ID`\n- `5` → `Plan::ESTADO_VENCIDO_ID`\n\nTambién se agregó el import `use App\\Models\\Planes\\Plan;` y Pint aplicó correcciones de formato adicionales."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3729,"cache_read_input_tokens":58611,"cache_creation":{"ephemeral_5m_input_tokens":3729,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP2nt86d5sVE2v8VcTRB","type":"assistant","uuid":"db9de50f-cb94-4188-b5d6-0a02b0cb4a62","timestamp":"2026-01-22T20:16:24.280Z"}
{"parentUuid":"db9de50f-cb94-4188-b5d6-0a02b0cb4a62","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"ajustes-planes-creditos","slug":"atomic-coalescing-meadow","type":"system","subtype":"turn_duration","durationMs":46743,"timestamp":"2026-01-22T20:16:24.390Z","uuid":"d4e66940-853c-4344-b393-2f136f4b86ad","isMeta":false}
{"type":"file-history-snapshot","messageId":"3e1bafe2-aa68-40b6-985f-9db2686a63fa","snapshot":{"messageId":"3e1bafe2-aa68-40b6-985f-9db2686a63fa","trackedFileBackups":{"app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php":{"backupFileName":"b4706ac638207036@v2","version":2,"backupTime":"2026-01-22T19:45:29.008Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"115edace5e384ff2@v3","version":3,"backupTime":"2026-01-22T21:23:41.745Z"},"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"87ffcf5aa4ef1291@v2","version":2,"backupTime":"2026-01-22T21:23:41.747Z"}},"timestamp":"2026-01-22T21:23:41.703Z"},"isSnapshotUpdate":false}
{"parentUuid":"d4e66940-853c-4344-b393-2f136f4b86ad","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":"App\\Http\\Controllers\\Planes\\PlanController::show(): Argument #1 ($id) must be of type int, string given, called in C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\vendor\\laravel\\framework\\src\\Illuminate\\Routing\\Controller.php on line 54 la acceder al administrador en ruta planes/consumo"},"uuid":"3e1bafe2-aa68-40b6-985f-9db2686a63fa","timestamp":"2026-01-22T21:23:41.661Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"3e1bafe2-aa68-40b6-985f-9db2686a63fa","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Kkx5kPdNv9NusJxfEs4zvj","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user is getting a type error in `PlanController::show()` - the `$id` parameter is typed as `int` but receiving a `string`. This happens when accessing the route `planes/consumo`. This is likely a routing issue where \"consumo\" is being matched as the `{id}` parameter of a `show` route.\n\nLet me explore the controller and routes to understand the issue.","signature":"Eo0ECkYICxgCKkCWAvkdjadCBkSBER4vQa14KvoaMB4Mv2UI0TfK0i4Oub96XvsJ3lpzvoivS1r+PdLYLkPilxaPfOfUfuLLapGCEgwI143nfMeH89hjB24aDMwMw99G4x/D0IiNlCIwyZ/RWbd6rPglnb3yElX/OY9CpQq8BBLhogSZ2K8rR/6ggopocZ9BjJ3gpY0UQTnNKvQCuwZr7VgZabKK0izsUwhSlwgusBg72TWpU7JTnVsc1QslNGQAzoWkkMq5tqFV9lyhWz/YICrCakmYCgmCuq3K/KN8SLVtGXmQeGth5WlhA/lIXLdDYVluoq1EGoVcz2HkAnMpIh1Q2Ad3RARBdxhnyAAiq5Q26P9YX74wkn1W2EdSY6D0ktrfgIfRUn5fMCzpfNeJh9nZxDIx+Ip5Pzb/Zf8Z3ZT4rg8NSAyiQEYmGRdEllhN+fF+B3EWjUMbKQQgfgvp4efMSiSXVATY62UQjjHInriI6AIq1Tx5Zc4NJ7K38hgLsfKWnpMNbzGgI4cvUrc2mRp4YJgJ95GD7E7s4A/+XQAtBtUdZ/KWtxzWftum7MTPOZFcm72MW90NOOovRmhIBThswEPTmLIBGzOpBSq4IIbY2zsPLmVuRGwGV2Vg6Wp+X6jyXqcggIzBIIiA+iOnwBvFWwwnWlSbqbSRBQNtiBq4Kwgh5pGSSBRARzxKOTcBGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":63746,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":63746,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXP7vwkBnUm8hBoLwre7a","type":"assistant","uuid":"27a7fa27-6804-4c90-b697-19f9e6d7fabb","timestamp":"2026-01-22T21:23:45.575Z"}
{"parentUuid":"27a7fa27-6804-4c90-b697-19f9e6d7fabb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Kkx5kPdNv9NusJxfEs4zvj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","name":"Task","input":{"description":"Explore PlanController and routes","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","subagent_type":"Explore"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":63746,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":63746,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXP7vwkBnUm8hBoLwre7a","type":"assistant","uuid":"a1e8ed41-65ad-4bdc-baec-1d596684fe81","timestamp":"2026-01-22T21:23:49.587Z"}
{"parentUuid":"a1e8ed41-65ad-4bdc-baec-1d596684fe81","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"type":"text","text":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files."}]},"uuid":"16086a97-bf57-496a-95c3-af0a5df56ae7","timestamp":"2026-01-22T21:23:49.840Z"},"normalizedMessages":[{"type":"user","message":{"role":"user","content":[{"type":"text","text":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files."}]},"uuid":"16086a97-bf57-496a-95c3-af0a5df56ae7","timestamp":"2026-01-22T21:23:49.840Z"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"3f7f1cab-0b4b-4216-9318-f5ff79be5e7d","timestamp":"2026-01-22T21:23:49.841Z"}
{"parentUuid":"3f7f1cab-0b4b-4216-9318-f5ff79be5e7d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"75fd5be1-4ffd-400f-9246-d8da09c8143e","timestamp":"2026-01-22T21:23:52.602Z"}
{"parentUuid":"75fd5be1-4ffd-400f-9246-d8da09c8143e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"387d67a8-4d16-450b-a02f-5736a957062f","timestamp":"2026-01-22T21:23:52.744Z"}
{"parentUuid":"387d67a8-4d16-450b-a02f-5736a957062f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"9adbf17f-7b33-4a61-8012-28abe070acfc","timestamp":"2026-01-22T21:23:53.097Z"}
{"parentUuid":"9adbf17f-7b33-4a61-8012-28abe070acfc","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUgQii42KiQ94SnWfGBsqU","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"49efb63e-1db2-4a30-b762-a1bc0e161a63","timestamp":"2026-01-22T21:24:00.232Z"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUgQii42KiQ94SnWfGBsqU","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"49efb63e-1db2-4a30-b762-a1bc0e161a63","timestamp":"2026-01-22T21:24:00.232Z"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"4c886107-cebb-45c9-ab83-3354f6000fb3","timestamp":"2026-01-22T21:24:00.368Z"}
{"parentUuid":"4c886107-cebb-45c9-ab83-3354f6000fb3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","type":"tool_result","content":"Found 1 file\nroutes\\web.php"}]},"uuid":"bed09402-ca75-40ed-940c-7bcba7238d26","timestamp":"2026-01-22T21:24:00.948Z"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUgQii42KiQ94SnWfGBsqU","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"49efb63e-1db2-4a30-b762-a1bc0e161a63","timestamp":"2026-01-22T21:24:00.232Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","type":"tool_result","content":"Found 1 file\nroutes\\web.php"}]},"uuid":"bed09402-ca75-40ed-940c-7bcba7238d26","timestamp":"2026-01-22T21:24:00.948Z"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"62548495-ca50-4ccd-b435-9a9ea4d59df9","timestamp":"2026-01-22T21:24:01.022Z"}
{"parentUuid":"62548495-ca50-4ccd-b435-9a9ea4d59df9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017aPvpPevjvFVVXgb6FYUb8","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}]},"uuid":"03e0e5f6-0d67-46e7-9561-d0165f67a45c","timestamp":"2026-01-22T21:24:02.117Z"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUgQii42KiQ94SnWfGBsqU","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"49efb63e-1db2-4a30-b762-a1bc0e161a63","timestamp":"2026-01-22T21:24:00.232Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","type":"tool_result","content":"Found 1 file\nroutes\\web.php"}]},"uuid":"bed09402-ca75-40ed-940c-7bcba7238d26","timestamp":"2026-01-22T21:24:00.948Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017aPvpPevjvFVVXgb6FYUb8","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}]},"uuid":"03e0e5f6-0d67-46e7-9561-d0165f67a45c","timestamp":"2026-01-22T21:24:02.117Z"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"1453cab3-d59f-46c7-9723-c56d8accf3af","timestamp":"2026-01-22T21:24:02.185Z"}
{"parentUuid":"1453cab3-d59f-46c7-9723-c56d8accf3af","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-22T21:24:04.026Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013MFvRHDwM8TB7iobMzEr8g","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"77eed9db-6d09-4fc5-b43b-bbe57f5ba88c"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUgQii42KiQ94SnWfGBsqU","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"49efb63e-1db2-4a30-b762-a1bc0e161a63","timestamp":"2026-01-22T21:24:00.232Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","type":"tool_result","content":"Found 1 file\nroutes\\web.php"}]},"uuid":"bed09402-ca75-40ed-940c-7bcba7238d26","timestamp":"2026-01-22T21:24:00.948Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017aPvpPevjvFVVXgb6FYUb8","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}]},"uuid":"03e0e5f6-0d67-46e7-9561-d0165f67a45c","timestamp":"2026-01-22T21:24:02.117Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:03.832Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read the web.php file to see the route definitions:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"5c2e8c9f-717a-4a43-9361-8cfe4a8d6b2e"},{"type":"assistant","timestamp":"2026-01-22T21:24:04.026Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013MFvRHDwM8TB7iobMzEr8g","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"77eed9db-6d09-4fc5-b43b-bbe57f5ba88c"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"5de1a5c9-4149-4a23-bb1c-3b51ee97a8e4","timestamp":"2026-01-22T21:24:04.066Z"}
{"parentUuid":"5de1a5c9-4149-4a23-bb1c-3b51ee97a8e4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013MFvRHDwM8TB7iobMzEr8g","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Str;\n     4→use Illuminate\\Http\\Request;\n     5→use Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n     6→\n     7→Route::get('/', function () {\n     8→    return redirect()->route('login');\n     9→});\n    10→\n    11→Auth::routes(['register' => false]);\n    12→\n    13→// Rutas de acceso para aplicante.\n    14→Route::group([\n    15→    'prefix'    => 'control-acceso',\n    16→    'namespace' => 'App\\Http\\Controllers\\Auth'\n    17→], function ($ruta) {\n    18→    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    19→    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    20→    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n    21→});\n    22→\n    23→// Rutas de migración de usuarios desde la base de datos antigua.\n    24→Route::group([\n    25→    'prefix'    => 'migrar-usuario-app-antigua',\n    26→    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n    27→], function ($ruta) {\n    28→    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    29→    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n    30→});\n    31→\n    32→// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\n    33→Route::group([\n    34→    'prefix'     => 'rol-empresa',\n    35→    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    36→    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n    37→], function ($ruta) {\n    38→    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    39→    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n    40→});\n    41→\n    42→// Rutas protegidas por autenticación y selección de rol y empresa.\n    43→Route::group([\n    44→    'middleware' => ['auth', 'auth.rol-empresa'],\n    45→    'namespace'  => 'App\\Http\\Controllers'\n    46→], function ($ruta) {\n    47→    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n    48→\n    49→    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n    50→        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n    51→        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n    52→\n    53→        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n    54→            // Usuarios\n    55→            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n    56→            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n    57→            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n    58→            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n    59→            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n    60→            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n    61→            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n    62→            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n    63→            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n    64→            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n    65→            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n    66→            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n    67→            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n    68→            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n    69→\n    70→            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n    71→            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n    72→            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n    73→        });\n    74→    });\n    75→\n    76→    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n    77→        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n    78→            // Pruebas\n    79→            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n    80→            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n    81→            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n    82→            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n    83→            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n    84→            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n    85→            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n    86→            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n    87→        });\n    88→\n    89→        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n    90→            // Carga masiva de pruebas\n    91→            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n    92→            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n    93→            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n    94→            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n    95→        });\n    96→\n    97→        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n    98→            // Baremos\n    99→            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n   100→            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n   101→            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n   102→            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n   103→        });\n   104→\n   105→        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n   106→            // Dimensiones\n   107→            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n   108→            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n   109→            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n   110→            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n   111→            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n   112→        });\n   113→\n   114→        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n   115→            // Factores\n   116→            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n   117→            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n   118→            $ruta->resource('factores', 'Pruebas\\FactorController');\n   119→            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n   120→        });\n   121→\n   122→        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n   123→            // Reactivos\n   124→            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n   125→            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n   126→            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n   127→\n   128→            // Opciones\n   129→            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n   130→        });\n   131→\n   132→        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n   133→            // Calificaciones\n   134→            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n   135→            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n   136→            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n   137→        });\n   138→\n   139→        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n   140→            // Grupos de opciones\n   141→            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n   142→            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n   143→            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n   144→        });\n   145→\n   146→        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n   147→            // Secciones de texto\n   148→            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n   149→            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n   150→            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n   151→        });\n   152→\n   153→        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n   154→    });\n   155→\n   156→    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n   157→        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n   158→            // Perfiles\n   159→            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n   160→            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n   161→            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n   162→        });\n   163→\n   164→        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n   165→            // Módulos de preguntas\n   166→            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n   167→            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n   168→            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n   169→            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n   170→            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n   171→        });\n   172→\n   173→        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n   174→            // Demográficas\n   175→            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n   176→            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n   177→            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n   178→        });\n   179→    });\n   180→\n   181→    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n   182→        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n   183→            // Listado de empresas\n   184→            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n   185→            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n   186→            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n   187→            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n   188→            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n   189→            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n   190→            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n   191→            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n   192→            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n   193→            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n   194→            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n   195→            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n   196→            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n   197→            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n   198→            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n   199→        });\n   200→\n   201→        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n   202→            // Gestionar empresas\n   203→            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n   204→            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n   205→            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n   206→            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n   207→\n   208→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n   209→                // Usuarios\n   210→                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n   211→                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n   212→            });\n   213→\n   214→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n   215→                // Planes\n   216→                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n   217→                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n   218→            });\n   219→        });\n   220→\n   221→        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n   222→            // Archivo de empresas\n   223→            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n   224→            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n   225→            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n   226→        });\n   227→\n   228→        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n   229→            // Migración de empresas\n   230→            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n   231→            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n   232→            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n   233→            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n   234→        });\n   235→\n   236→        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n   237→            // Portales de empleo\n   238→            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   239→            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   240→            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n   241→            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n   242→\n   243→            // Premios destacados\n   244→            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n   245→            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n   246→\n   247→            // Motivadores\n   248→            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n   249→        });\n   250→\n   251→        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n   252→        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n   253→        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n   254→    });\n   255→\n   256→    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n   257→        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n   258→        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n   259→        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n   260→        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n   261→    });\n   262→\n   263→    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n   264→        // Planes\n   265→        $ruta->resource('planes', 'Planes\\PlanController');\n   266→        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n   267→        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n   268→        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n   269→        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n   270→        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n   271→        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n   272→        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n   273→        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n   274→        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n   275→        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n   276→        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n   277→        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n   278→        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n   279→        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n   280→        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n   281→\n   282→        // Planes de Créditos - Vista de creación\n   283→        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n   284→        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   285→        $ruta->get('servicios-ia/{id}/creditos', 'IA\\ServicioIAController@creditos');\n   286→        $ruta->post('servicios-ia/{id}/activar', 'IA\\ServicioIAController@activar');\n   287→        $ruta->post('servicios-ia/{id}/desactivar', 'IA\\ServicioIAController@desactivar');\n   288→        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n   289→        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n   290→        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   291→\n   292→        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n   293→            // Consumos\n   294→            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n   295→            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n   296→            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n   297→            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n   298→            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n   299→            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n   300→            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n   301→            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n   302→            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n   303→            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n   304→            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n   305→            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n   306→            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n   307→        });\n   308→\n   309→        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n   310→            // Archivo\n   311→            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n   312→            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n   313→        });\n   314→    });\n   315→\n   316→    // Perfiles laborales\n   317→    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n   318→    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n   319→    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n   320→    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n   321→\n   322→    // Preguntas de ofertas laborales\n   323→    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n   324→    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n   325→    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n   326→    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n   327→    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n   328→    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n   329→\n   330→    // Preguntas de videoentrevista\n   331→    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n   332→    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n   333→    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n   334→    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n   335→\n   336→    // Vacantes\n   337→    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n   338→    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n   339→    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n   340→    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n   341→    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n   342→    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n   343→    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n   344→    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n   345→    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n   346→    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n   347→    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n   348→    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n   349→\n   350→    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n   351→\n   352→    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n   353→    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n   354→\n   355→    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n   356→        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n   357→            // Ajustes - General\n   358→            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n   359→        });\n   360→\n   361→        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n   362→            // Ajustes - Roles y permisos\n   363→            $ruta->get('roles', 'Auth\\RolController@index');\n   364→        });\n   365→\n   366→        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n   367→            // Ajustes - Deshacer acciones\n   368→            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n   369→            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n   370→            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n   371→            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n   372→        });\n   373→\n   374→        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n   375→            // Ajustes - Ofertas y anuncios\n   376→            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n   377→            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n   378→            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n   379→            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n   380→            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n   381→        });\n   382→\n   383→        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n   384→            // Webinars\n   385→            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n   386→            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n   387→            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n   388→            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n   389→            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n   390→            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n   391→\n   392→            // Eventos\n   393→            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n   394→            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n   395→            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n   396→            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n   397→            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n   398→            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n   399→\n   400→            // Guías\n   401→            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n   402→            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n   403→            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n   404→            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n   405→            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n   406→            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n   407→\n   408→            // Tutoriales\n   409→            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n   410→            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n   411→            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n   412→            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n   413→            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n   414→\n   415→            // Podcast\n   416→            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n   417→            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n   418→            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n   419→            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n   420→            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n   421→\n   422→            // Capacitación\n   423→            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n   424→            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n   425→            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n   426→            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n   427→            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n   428→\n   429→            // Certificación\n   430→            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n   431→            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n   432→            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n   433→            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n   434→            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n   435→            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n   436→        });\n   437→    });\n   438→\n   439→    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n   440→        // Soportes\n   441→        $ruta->resource('soportes', 'Soportes\\SoporteController');\n   442→        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n   443→        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n   444→        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n   445→        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n   446→        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n   447→        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n   448→        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n   449→        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n   450→        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n   451→\n   452→        // Manuales\n   453→        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n   454→        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n   455→\n   456→        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n   457→            // Aplicantes\n   458→            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n   459→        });\n   460→\n   461→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n   462→            // Preguntas frecuentes\n   463→            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n   464→            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n   465→            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n   466→            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n   467→            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n   468→        });\n   469→\n   470→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n   471→            // Preguntas frecuentes reacciónes\n   472→            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n   473→        });\n   474→    });\n   475→\n   476→    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n   477→    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n   478→    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n   479→\n   480→    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n   481→        // Módulos\n   482→        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n   483→        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n   484→\n   485→        // Auditorías\n   486→        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n   487→\n   488→        // Accesos\n   489→        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n   490→\n   491→        // Registros de actividad\n   492→        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n   493→\n   494→        // Novedades\n   495→        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n   496→        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n   497→        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n   498→\n   499→        // Países\n   500→        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n   501→        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n   502→        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n   503→        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n   504→        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n   505→\n   506→        // Reportes\n   507→        $ruta->resource('reportes', 'Reportes\\ReporteController');\n   508→        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n   509→        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n   510→\n   511→        // Minería de datos.\n   512→        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n   513→        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n   514→\n   515→        // Pruebas completas\n   516→        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n   517→        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n   518→        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n   519→        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n   520→        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n   521→    });\n   522→\n   523→    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n   524→        // Ordenes de servicio\n   525→        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n   526→        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n   527→        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n   528→\n   529→        // Ofertas laborales\n   530→        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n   531→        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n   532→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n   533→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n   534→        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n   535→        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n   536→        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n   537→        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n   538→        ->name('sin-disponibilidad-ofertas-laborales');\n   539→        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n   540→        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n   541→        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n   542→        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n   543→        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n   544→        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n   545→        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n   546→\n   547→        // Vacantes\n   548→        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n   549→        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n   550→\n   551→        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n   552→            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n   553→            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n   554→            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n   555→            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n   556→            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n   557→            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n   558→            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n   559→            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n   560→            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n   561→        });\n   562→\n   563→        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n   564→        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n   565→        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n   566→        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n   567→        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n   568→        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n   569→        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n   570→        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n   571→        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n   572→        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n   573→        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n   574→        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n   575→        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n   576→        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n   577→        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n   578→        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n   579→        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n   580→        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n   581→        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n   582→        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n   583→        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n   584→        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n   585→\n   586→        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n   587→        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n   588→        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n   589→\n   590→        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n   591→        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n   592→        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n   593→\n   594→        // Etapas\n   595→        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n   596→        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n   597→        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n   598→        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n   599→        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n   600→        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n   601→\n   602→        // Movimientos\n   603→        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n   604→        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n   605→        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n   606→        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n   607→\n   608→        // Novedades\n   609→        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n   610→\n   611→        $ruta->get('feedback', 'DashboardController@enConstruccion');\n   612→        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n   613→\n   614→        // Procesos\n   615→        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n   616→        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n   617→        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n   618→        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n   619→        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n   620→        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n   621→        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n   622→        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n   623→        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n   624→        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n   625→        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n   626→        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n   627→        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n   628→        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n   629→        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n   630→        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n   631→        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n   632→        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n   633→        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n   634→        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n   635→        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n   636→        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n   637→        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n   638→        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n   639→        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n   640→        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n   641→        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n   642→        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n   643→        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n   644→        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n   645→        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n   646→        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n   647→\n   648→        // Firmas de rutas\n   649→        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n   650→\n   651→        // Perfiles pruebas\n   652→        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n   653→\n   654→        // Agendas\n   655→        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n   656→        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n   657→        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n   658→        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n   659→\n   660→        // Comentarios\n   661→        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n   662→\n   663→        // Usuarios\n   664→        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n   665→    });\n   666→\n   667→    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n   668→        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n   669→\n   670→        // Debug de calificaciones de agendas\n   671→        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n   672→        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n   673→        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n   674→        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n   675→    });\n   676→\n   677→    // Suplantación de rol Administrador general\n   678→    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n   679→        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n   680→    });\n   681→\n   682→    // Suplantación de rol Administrador sucursal\n   683→    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n   684→        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n   685→    });\n   686→\n   687→    // Restablecimiento de la sesión original que había antes de la suplantación\n   688→    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n   689→        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n   690→    });\n   691→\n   692→    // Ruta para completar los datos de un usuario aplicante\n   693→    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n   694→        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n   695→        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n   696→        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n   697→        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n   698→    });\n   699→\n   700→    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n   701→    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n   702→        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n   703→        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n   704→        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n   705→        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n   706→        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n   707→        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n   708→        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n   709→        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n   710→        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n   711→        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n   712→        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n   713→        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n   714→        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n   715→        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n   716→        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n   717→        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n   718→        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n   719→        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n   720→        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n   721→        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   722→        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n   723→            ->name('ofertas-laborales.detalles-aplicante');\n   724→        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   725→        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n   726→\n   727→        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n   728→    });\n   729→\n   730→    // Ofertas laborales\n   731→    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n   732→\n   733→    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n   734→    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n   735→    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n   736→    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n   737→    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n   738→    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n   739→    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n   740→\n   741→    // Usuarios\n   742→    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n   743→    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n   744→\n   745→    // Perfiles\n   746→    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n   747→    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n   748→    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n   749→    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n   750→    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n   751→\n   752→    // Archivos\n   753→    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n   754→    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n   755→    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n   756→\n   757→    // Menú clientes\n   758→    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n   759→    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n   760→    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n   761→\n   762→    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n   763→    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n   764→    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n   765→    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n   766→    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n   767→\n   768→    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n   769→    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n   770→    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n   771→    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n   772→    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n   773→    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n   774→    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n   775→    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n   776→    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n   777→\n   778→    // Agendas - Accesible para aplicantes y usuarios de empresa\n   779→    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n   780→\n   781→    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n   782→    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n   783→    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n   784→    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n   785→    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n   786→\n   787→    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n   788→    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n   789→\n   790→    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n   791→    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n   792→    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n   793→\n   794→    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n   795→    $ruta->get('novedades', 'DashboardController@enConstruccion');\n   796→\n   797→    // Áreas\n   798→    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n   799→    $ruta->post('areas', 'Empresas\\AreaController@store');\n   800→\n   801→    // Cargos\n   802→    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n   803→    $ruta->post('cargos', 'Empresas\\CargoController@store');\n   804→\n   805→    // Niveles educativos\n   806→    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n   807→\n   808→    // Áreas de estudio\n   809→    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n   810→\n   811→    // Idiomas\n   812→    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n   813→\n   814→    // Autenticación del websoket\n   815→    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n   816→\n   817→    $ruta->get('/botones', function () {\n   818→        return view('botones');\n   819→    })->name('botones');\n   820→\n   821→    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n   822→    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n   823→    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n   824→\n   825→    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n   826→    $ruta->get('analiticas', 'DashboardController@index');\n   827→    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n   828→    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n   829→    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n   830→    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n   831→    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n   832→\n   833→    // Rutas de componentes de desarrollo\n   834→    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n   835→    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n   836→\n   837→    // TODO: ruta de prueba, eliminarla próximamente\n   838→    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n   839→    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n   840→    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n   841→    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n   842→    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n   843→\n   844→    // Rutas para las encuestas\n   845→    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n   846→    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n   847→});\n   848→\n   849→// Rutas no protegidas por autenticación\n   850→Route::group([\n   851→    'namespace' => 'App\\Http\\Controllers'\n   852→], function ($ruta) {\n   853→    // Contraseñas\n   854→    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n   855→\n   856→    // Empresas\n   857→    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n   858→    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n   859→    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n   860→    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n   861→    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n   862→\n   863→    // Ordenes de servicio\n   864→    $ruta->group([\n   865→        'middleware' => 'orden-servicio-enlace-publico'\n   866→    ], function ($ruta) {\n   867→        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n   868→        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n   869→    });\n   870→\n   871→    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n   872→\n   873→    // Países\n   874→    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n   875→    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n   876→\n   877→    // Departamentos\n   878→    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n   879→\n   880→    // Ciudades\n   881→    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n   882→\n   883→    // Portales de empleo\n   884→    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n   885→    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n   886→    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n   887→    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n   888→    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n   889→    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n   890→    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n   891→\n   892→    // Firmas de rutas\n   893→    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n   894→    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n   895→    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n   896→    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n   897→\n   898→    // Archivos\n   899→    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n   900→\n   901→    // Imagen de usuarios\n   902→    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n   903→\n   904→    // Consultar reportes con firma\n   905→    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n   906→});\n   907→\n   908→/**\n   909→ * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n   910→ *\n   911→ * @author Fahibram Cárcamo\n   912→ */\n   913→Route::group([\n   914→    'prefix'     => 'rutas-firmadas',\n   915→    'middleware' => ['ruta-firmada'],\n   916→    'namespace'  => 'App\\Http\\Controllers'\n   917→], function ($ruta) {\n   918→    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n   919→    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n   920→});\n   921→\n   922→/**\n   923→ * Genera un token SSO firmado y redirige a WordPress.\n   924→ *\n   925→ * Flujo:\n   926→ *  - Requiere un usuario autenticado (será el admin en WP).\n   927→ *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n   928→ *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n   929→ *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n   930→ *  - Redirige al callback configurado en WordPress.\n   931→ *\n   932→ * @author Sergio Vargas\n   933→ */\n   934→Route::get('/sso/wordpress', function (Request $request) {\n   935→    $user = $request->user();\n   936→\n   937→    $studentId   = $request->input('student_id');\n   938→    $studentData = null;\n   939→\n   940→    if ($studentId) {\n   941→        $student = App\\Models\\Usuarios\\User::find($studentId);\n   942→\n   943→        if ($student && $student->id !== $user->id) {\n   944→            $studentData = [\n   945→                'id'    => (string) $student->id,\n   946→                'email' => $student->email,\n   947→                'name'  => $student->getNombreCompletoAttribute(),\n   948→            ];\n   949→        }\n   950→    }\n   951→\n   952→    $nonce = (string) Str::uuid();\n   953→    $exp   = now()->addSeconds(60)->timestamp;\n   954→\n   955→    Cache::put(\"sso_nonce:{$nonce}\", [\n   956→        'user_id' => $user->id,\n   957→        'exp'     => $exp,\n   958→    ], now()->addMinutes(5));\n   959→\n   960→    $payload = [\n   961→        'sub'     => (string) $user->id,\n   962→        'email'   => $user->email,\n   963→        'name'    => $user->getNombreCompletoAttribute(),\n   964→        'nonce'   => $nonce,\n   965→        'exp'     => $exp,\n   966→        'student' => $studentData,\n   967→    ];\n   968→\n   969→    $token    = sso_sign_token($payload, config('services.sso.secret'));\n   970→    $wp       = rtrim(config('services.sso.wp_url'), '/');\n   971→    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n   972→    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n   973→\n   974→    return redirect()->away(\n   975→        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n   976→    );\n   977→})->middleware('auth');\n   978→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0d63123c-dd15-46dd-92b9-7e3cd5adfee3","timestamp":"2026-01-22T21:24:05.464Z"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUgQii42KiQ94SnWfGBsqU","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"49efb63e-1db2-4a30-b762-a1bc0e161a63","timestamp":"2026-01-22T21:24:00.232Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","type":"tool_result","content":"Found 1 file\nroutes\\web.php"}]},"uuid":"bed09402-ca75-40ed-940c-7bcba7238d26","timestamp":"2026-01-22T21:24:00.948Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017aPvpPevjvFVVXgb6FYUb8","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}]},"uuid":"03e0e5f6-0d67-46e7-9561-d0165f67a45c","timestamp":"2026-01-22T21:24:02.117Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:03.832Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read the web.php file to see the route definitions:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"5c2e8c9f-717a-4a43-9361-8cfe4a8d6b2e"},{"type":"assistant","timestamp":"2026-01-22T21:24:04.026Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013MFvRHDwM8TB7iobMzEr8g","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"77eed9db-6d09-4fc5-b43b-bbe57f5ba88c"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013MFvRHDwM8TB7iobMzEr8g","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Str;\n     4→use Illuminate\\Http\\Request;\n     5→use Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n     6→\n     7→Route::get('/', function () {\n     8→    return redirect()->route('login');\n     9→});\n    10→\n    11→Auth::routes(['register' => false]);\n    12→\n    13→// Rutas de acceso para aplicante.\n    14→Route::group([\n    15→    'prefix'    => 'control-acceso',\n    16→    'namespace' => 'App\\Http\\Controllers\\Auth'\n    17→], function ($ruta) {\n    18→    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    19→    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    20→    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n    21→});\n    22→\n    23→// Rutas de migración de usuarios desde la base de datos antigua.\n    24→Route::group([\n    25→    'prefix'    => 'migrar-usuario-app-antigua',\n    26→    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n    27→], function ($ruta) {\n    28→    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    29→    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n    30→});\n    31→\n    32→// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\n    33→Route::group([\n    34→    'prefix'     => 'rol-empresa',\n    35→    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    36→    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n    37→], function ($ruta) {\n    38→    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    39→    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n    40→});\n    41→\n    42→// Rutas protegidas por autenticación y selección de rol y empresa.\n    43→Route::group([\n    44→    'middleware' => ['auth', 'auth.rol-empresa'],\n    45→    'namespace'  => 'App\\Http\\Controllers'\n    46→], function ($ruta) {\n    47→    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n    48→\n    49→    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n    50→        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n    51→        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n    52→\n    53→        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n    54→            // Usuarios\n    55→            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n    56→            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n    57→            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n    58→            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n    59→            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n    60→            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n    61→            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n    62→            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n    63→            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n    64→            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n    65→            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n    66→            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n    67→            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n    68→            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n    69→\n    70→            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n    71→            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n    72→            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n    73→        });\n    74→    });\n    75→\n    76→    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n    77→        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n    78→            // Pruebas\n    79→            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n    80→            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n    81→            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n    82→            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n    83→            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n    84→            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n    85→            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n    86→            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n    87→        });\n    88→\n    89→        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n    90→            // Carga masiva de pruebas\n    91→            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n    92→            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n    93→            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n    94→            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n    95→        });\n    96→\n    97→        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n    98→            // Baremos\n    99→            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n   100→            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n   101→            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n   102→            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n   103→        });\n   104→\n   105→        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n   106→            // Dimensiones\n   107→            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n   108→            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n   109→            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n   110→            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n   111→            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n   112→        });\n   113→\n   114→        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n   115→            // Factores\n   116→            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n   117→            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n   118→            $ruta->resource('factores', 'Pruebas\\FactorController');\n   119→            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n   120→        });\n   121→\n   122→        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n   123→            // Reactivos\n   124→            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n   125→            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n   126→            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n   127→\n   128→            // Opciones\n   129→            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n   130→        });\n   131→\n   132→        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n   133→            // Calificaciones\n   134→            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n   135→            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n   136→            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n   137→        });\n   138→\n   139→        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n   140→            // Grupos de opciones\n   141→            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n   142→            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n   143→            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n   144→        });\n   145→\n   146→        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n   147→            // Secciones de texto\n   148→            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n   149→            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n   150→            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n   151→        });\n   152→\n   153→        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n   154→    });\n   155→\n   156→    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n   157→        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n   158→            // Perfiles\n   159→            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n   160→            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n   161→            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n   162→        });\n   163→\n   164→        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n   165→            // Módulos de preguntas\n   166→            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n   167→            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n   168→            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n   169→            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n   170→            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n   171→        });\n   172→\n   173→        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n   174→            // Demográficas\n   175→            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n   176→            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n   177→            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n   178→        });\n   179→    });\n   180→\n   181→    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n   182→        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n   183→            // Listado de empresas\n   184→            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n   185→            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n   186→            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n   187→            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n   188→            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n   189→            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n   190→            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n   191→            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n   192→            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n   193→            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n   194→            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n   195→            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n   196→            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n   197→            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n   198→            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n   199→        });\n   200→\n   201→        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n   202→            // Gestionar empresas\n   203→            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n   204→            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n   205→            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n   206→            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n   207→\n   208→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n   209→                // Usuarios\n   210→                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n   211→                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n   212→            });\n   213→\n   214→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n   215→                // Planes\n   216→                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n   217→                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n   218→            });\n   219→        });\n   220→\n   221→        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n   222→            // Archivo de empresas\n   223→            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n   224→            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n   225→            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n   226→        });\n   227→\n   228→        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n   229→            // Migración de empresas\n   230→            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n   231→            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n   232→            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n   233→            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n   234→        });\n   235→\n   236→        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n   237→            // Portales de empleo\n   238→            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   239→            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   240→            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n   241→            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n   242→\n   243→            // Premios destacados\n   244→            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n   245→            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n   246→\n   247→            // Motivadores\n   248→            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n   249→        });\n   250→\n   251→        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n   252→        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n   253→        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n   254→    });\n   255→\n   256→    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n   257→        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n   258→        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n   259→        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n   260→        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n   261→    });\n   262→\n   263→    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n   264→        // Planes\n   265→        $ruta->resource('planes', 'Planes\\PlanController');\n   266→        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n   267→        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n   268→        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n   269→        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n   270→        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n   271→        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n   272→        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n   273→        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n   274→        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n   275→        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n   276→        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n   277→        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n   278→        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n   279→        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n   280→        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n   281→\n   282→        // Planes de Créditos - Vista de creación\n   283→        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n   284→        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   285→        $ruta->get('servicios-ia/{id}/creditos', 'IA\\ServicioIAController@creditos');\n   286→        $ruta->post('servicios-ia/{id}/activar', 'IA\\ServicioIAController@activar');\n   287→        $ruta->post('servicios-ia/{id}/desactivar', 'IA\\ServicioIAController@desactivar');\n   288→        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n   289→        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n   290→        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   291→\n   292→        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n   293→            // Consumos\n   294→            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n   295→            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n   296→            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n   297→            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n   298→            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n   299→            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n   300→            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n   301→            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n   302→            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n   303→            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n   304→            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n   305→            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n   306→            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n   307→        });\n   308→\n   309→        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n   310→            // Archivo\n   311→            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n   312→            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n   313→        });\n   314→    });\n   315→\n   316→    // Perfiles laborales\n   317→    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n   318→    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n   319→    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n   320→    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n   321→\n   322→    // Preguntas de ofertas laborales\n   323→    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n   324→    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n   325→    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n   326→    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n   327→    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n   328→    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n   329→\n   330→    // Preguntas de videoentrevista\n   331→    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n   332→    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n   333→    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n   334→    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n   335→\n   336→    // Vacantes\n   337→    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n   338→    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n   339→    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n   340→    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n   341→    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n   342→    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n   343→    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n   344→    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n   345→    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n   346→    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n   347→    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n   348→    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n   349→\n   350→    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n   351→\n   352→    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n   353→    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n   354→\n   355→    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n   356→        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n   357→            // Ajustes - General\n   358→            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n   359→        });\n   360→\n   361→        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n   362→            // Ajustes - Roles y permisos\n   363→            $ruta->get('roles', 'Auth\\RolController@index');\n   364→        });\n   365→\n   366→        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n   367→            // Ajustes - Deshacer acciones\n   368→            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n   369→            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n   370→            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n   371→            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n   372→        });\n   373→\n   374→        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n   375→            // Ajustes - Ofertas y anuncios\n   376→            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n   377→            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n   378→            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n   379→            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n   380→            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n   381→        });\n   382→\n   383→        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n   384→            // Webinars\n   385→            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n   386→            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n   387→            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n   388→            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n   389→            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n   390→            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n   391→\n   392→            // Eventos\n   393→            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n   394→            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n   395→            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n   396→            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n   397→            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n   398→            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n   399→\n   400→            // Guías\n   401→            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n   402→            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n   403→            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n   404→            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n   405→            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n   406→            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n   407→\n   408→            // Tutoriales\n   409→            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n   410→            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n   411→            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n   412→            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n   413→            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n   414→\n   415→            // Podcast\n   416→            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n   417→            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n   418→            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n   419→            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n   420→            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n   421→\n   422→            // Capacitación\n   423→            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n   424→            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n   425→            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n   426→            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n   427→            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n   428→\n   429→            // Certificación\n   430→            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n   431→            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n   432→            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n   433→            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n   434→            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n   435→            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n   436→        });\n   437→    });\n   438→\n   439→    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n   440→        // Soportes\n   441→        $ruta->resource('soportes', 'Soportes\\SoporteController');\n   442→        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n   443→        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n   444→        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n   445→        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n   446→        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n   447→        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n   448→        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n   449→        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n   450→        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n   451→\n   452→        // Manuales\n   453→        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n   454→        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n   455→\n   456→        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n   457→            // Aplicantes\n   458→            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n   459→        });\n   460→\n   461→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n   462→            // Preguntas frecuentes\n   463→            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n   464→            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n   465→            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n   466→            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n   467→            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n   468→        });\n   469→\n   470→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n   471→            // Preguntas frecuentes reacciónes\n   472→            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n   473→        });\n   474→    });\n   475→\n   476→    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n   477→    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n   478→    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n   479→\n   480→    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n   481→        // Módulos\n   482→        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n   483→        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n   484→\n   485→        // Auditorías\n   486→        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n   487→\n   488→        // Accesos\n   489→        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n   490→\n   491→        // Registros de actividad\n   492→        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n   493→\n   494→        // Novedades\n   495→        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n   496→        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n   497→        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n   498→\n   499→        // Países\n   500→        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n   501→        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n   502→        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n   503→        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n   504→        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n   505→\n   506→        // Reportes\n   507→        $ruta->resource('reportes', 'Reportes\\ReporteController');\n   508→        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n   509→        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n   510→\n   511→        // Minería de datos.\n   512→        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n   513→        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n   514→\n   515→        // Pruebas completas\n   516→        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n   517→        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n   518→        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n   519→        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n   520→        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n   521→    });\n   522→\n   523→    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n   524→        // Ordenes de servicio\n   525→        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n   526→        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n   527→        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n   528→\n   529→        // Ofertas laborales\n   530→        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n   531→        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n   532→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n   533→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n   534→        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n   535→        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n   536→        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n   537→        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n   538→        ->name('sin-disponibilidad-ofertas-laborales');\n   539→        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n   540→        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n   541→        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n   542→        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n   543→        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n   544→        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n   545→        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n   546→\n   547→        // Vacantes\n   548→        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n   549→        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n   550→\n   551→        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n   552→            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n   553→            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n   554→            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n   555→            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n   556→            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n   557→            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n   558→            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n   559→            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n   560→            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n   561→        });\n   562→\n   563→        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n   564→        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n   565→        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n   566→        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n   567→        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n   568→        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n   569→        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n   570→        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n   571→        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n   572→        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n   573→        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n   574→        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n   575→        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n   576→        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n   577→        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n   578→        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n   579→        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n   580→        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n   581→        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n   582→        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n   583→        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n   584→        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n   585→\n   586→        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n   587→        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n   588→        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n   589→\n   590→        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n   591→        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n   592→        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n   593→\n   594→        // Etapas\n   595→        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n   596→        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n   597→        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n   598→        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n   599→        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n   600→        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n   601→\n   602→        // Movimientos\n   603→        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n   604→        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n   605→        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n   606→        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n   607→\n   608→        // Novedades\n   609→        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n   610→\n   611→        $ruta->get('feedback', 'DashboardController@enConstruccion');\n   612→        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n   613→\n   614→        // Procesos\n   615→        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n   616→        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n   617→        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n   618→        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n   619→        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n   620→        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n   621→        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n   622→        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n   623→        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n   624→        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n   625→        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n   626→        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n   627→        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n   628→        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n   629→        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n   630→        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n   631→        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n   632→        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n   633→        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n   634→        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n   635→        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n   636→        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n   637→        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n   638→        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n   639→        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n   640→        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n   641→        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n   642→        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n   643→        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n   644→        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n   645→        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n   646→        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n   647→\n   648→        // Firmas de rutas\n   649→        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n   650→\n   651→        // Perfiles pruebas\n   652→        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n   653→\n   654→        // Agendas\n   655→        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n   656→        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n   657→        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n   658→        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n   659→\n   660→        // Comentarios\n   661→        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n   662→\n   663→        // Usuarios\n   664→        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n   665→    });\n   666→\n   667→    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n   668→        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n   669→\n   670→        // Debug de calificaciones de agendas\n   671→        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n   672→        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n   673→        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n   674→        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n   675→    });\n   676→\n   677→    // Suplantación de rol Administrador general\n   678→    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n   679→        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n   680→    });\n   681→\n   682→    // Suplantación de rol Administrador sucursal\n   683→    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n   684→        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n   685→    });\n   686→\n   687→    // Restablecimiento de la sesión original que había antes de la suplantación\n   688→    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n   689→        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n   690→    });\n   691→\n   692→    // Ruta para completar los datos de un usuario aplicante\n   693→    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n   694→        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n   695→        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n   696→        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n   697→        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n   698→    });\n   699→\n   700→    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n   701→    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n   702→        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n   703→        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n   704→        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n   705→        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n   706→        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n   707→        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n   708→        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n   709→        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n   710→        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n   711→        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n   712→        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n   713→        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n   714→        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n   715→        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n   716→        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n   717→        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n   718→        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n   719→        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n   720→        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n   721→        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   722→        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n   723→            ->name('ofertas-laborales.detalles-aplicante');\n   724→        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   725→        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n   726→\n   727→        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n   728→    });\n   729→\n   730→    // Ofertas laborales\n   731→    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n   732→\n   733→    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n   734→    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n   735→    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n   736→    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n   737→    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n   738→    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n   739→    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n   740→\n   741→    // Usuarios\n   742→    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n   743→    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n   744→\n   745→    // Perfiles\n   746→    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n   747→    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n   748→    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n   749→    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n   750→    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n   751→\n   752→    // Archivos\n   753→    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n   754→    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n   755→    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n   756→\n   757→    // Menú clientes\n   758→    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n   759→    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n   760→    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n   761→\n   762→    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n   763→    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n   764→    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n   765→    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n   766→    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n   767→\n   768→    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n   769→    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n   770→    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n   771→    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n   772→    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n   773→    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n   774→    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n   775→    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n   776→    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n   777→\n   778→    // Agendas - Accesible para aplicantes y usuarios de empresa\n   779→    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n   780→\n   781→    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n   782→    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n   783→    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n   784→    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n   785→    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n   786→\n   787→    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n   788→    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n   789→\n   790→    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n   791→    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n   792→    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n   793→\n   794→    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n   795→    $ruta->get('novedades', 'DashboardController@enConstruccion');\n   796→\n   797→    // Áreas\n   798→    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n   799→    $ruta->post('areas', 'Empresas\\AreaController@store');\n   800→\n   801→    // Cargos\n   802→    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n   803→    $ruta->post('cargos', 'Empresas\\CargoController@store');\n   804→\n   805→    // Niveles educativos\n   806→    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n   807→\n   808→    // Áreas de estudio\n   809→    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n   810→\n   811→    // Idiomas\n   812→    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n   813→\n   814→    // Autenticación del websoket\n   815→    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n   816→\n   817→    $ruta->get('/botones', function () {\n   818→        return view('botones');\n   819→    })->name('botones');\n   820→\n   821→    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n   822→    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n   823→    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n   824→\n   825→    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n   826→    $ruta->get('analiticas', 'DashboardController@index');\n   827→    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n   828→    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n   829→    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n   830→    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n   831→    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n   832→\n   833→    // Rutas de componentes de desarrollo\n   834→    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n   835→    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n   836→\n   837→    // TODO: ruta de prueba, eliminarla próximamente\n   838→    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n   839→    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n   840→    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n   841→    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n   842→    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n   843→\n   844→    // Rutas para las encuestas\n   845→    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n   846→    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n   847→});\n   848→\n   849→// Rutas no protegidas por autenticación\n   850→Route::group([\n   851→    'namespace' => 'App\\Http\\Controllers'\n   852→], function ($ruta) {\n   853→    // Contraseñas\n   854→    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n   855→\n   856→    // Empresas\n   857→    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n   858→    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n   859→    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n   860→    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n   861→    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n   862→\n   863→    // Ordenes de servicio\n   864→    $ruta->group([\n   865→        'middleware' => 'orden-servicio-enlace-publico'\n   866→    ], function ($ruta) {\n   867→        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n   868→        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n   869→    });\n   870→\n   871→    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n   872→\n   873→    // Países\n   874→    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n   875→    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n   876→\n   877→    // Departamentos\n   878→    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n   879→\n   880→    // Ciudades\n   881→    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n   882→\n   883→    // Portales de empleo\n   884→    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n   885→    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n   886→    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n   887→    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n   888→    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n   889→    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n   890→    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n   891→\n   892→    // Firmas de rutas\n   893→    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n   894→    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n   895→    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n   896→    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n   897→\n   898→    // Archivos\n   899→    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n   900→\n   901→    // Imagen de usuarios\n   902→    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n   903→\n   904→    // Consultar reportes con firma\n   905→    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n   906→});\n   907→\n   908→/**\n   909→ * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n   910→ *\n   911→ * @author Fahibram Cárcamo\n   912→ */\n   913→Route::group([\n   914→    'prefix'     => 'rutas-firmadas',\n   915→    'middleware' => ['ruta-firmada'],\n   916→    'namespace'  => 'App\\Http\\Controllers'\n   917→], function ($ruta) {\n   918→    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n   919→    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n   920→});\n   921→\n   922→/**\n   923→ * Genera un token SSO firmado y redirige a WordPress.\n   924→ *\n   925→ * Flujo:\n   926→ *  - Requiere un usuario autenticado (será el admin en WP).\n   927→ *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n   928→ *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n   929→ *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n   930→ *  - Redirige al callback configurado en WordPress.\n   931→ *\n   932→ * @author Sergio Vargas\n   933→ */\n   934→Route::get('/sso/wordpress', function (Request $request) {\n   935→    $user = $request->user();\n   936→\n   937→    $studentId   = $request->input('student_id');\n   938→    $studentData = null;\n   939→\n   940→    if ($studentId) {\n   941→        $student = App\\Models\\Usuarios\\User::find($studentId);\n   942→\n   943→        if ($student && $student->id !== $user->id) {\n   944→            $studentData = [\n   945→                'id'    => (string) $student->id,\n   946→                'email' => $student->email,\n   947→                'name'  => $student->getNombreCompletoAttribute(),\n   948→            ];\n   949→        }\n   950→    }\n   951→\n   952→    $nonce = (string) Str::uuid();\n   953→    $exp   = now()->addSeconds(60)->timestamp;\n   954→\n   955→    Cache::put(\"sso_nonce:{$nonce}\", [\n   956→        'user_id' => $user->id,\n   957→        'exp'     => $exp,\n   958→    ], now()->addMinutes(5));\n   959→\n   960→    $payload = [\n   961→        'sub'     => (string) $user->id,\n   962→        'email'   => $user->email,\n   963→        'name'    => $user->getNombreCompletoAttribute(),\n   964→        'nonce'   => $nonce,\n   965→        'exp'     => $exp,\n   966→        'student' => $studentData,\n   967→    ];\n   968→\n   969→    $token    = sso_sign_token($payload, config('services.sso.secret'));\n   970→    $wp       = rtrim(config('services.sso.wp_url'), '/');\n   971→    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n   972→    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n   973→\n   974→    return redirect()->away(\n   975→        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n   976→    );\n   977→})->middleware('auth');\n   978→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0d63123c-dd15-46dd-92b9-7e3cd5adfee3","timestamp":"2026-01-22T21:24:05.464Z"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"bd8120ba-12dd-4ee4-9f42-3c5792e24281","timestamp":"2026-01-22T21:24:05.532Z"}
{"parentUuid":"bd8120ba-12dd-4ee4-9f42-3c5792e24281","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-22T21:24:09.976Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SA2xTvsNGQ23frcfK7XrXY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016g2xruZ8G5Dys2yYXu7i26","name":"Grep","input":{"pattern":"consumo|paginaConsumos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":26989,"cache_read_input_tokens":20556,"cache_creation":{"ephemeral_5m_input_tokens":26989,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xhjdgDtXxm22f61pY","uuid":"7eebb30e-4213-4d4d-a287-365923b81b56"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUgQii42KiQ94SnWfGBsqU","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"49efb63e-1db2-4a30-b762-a1bc0e161a63","timestamp":"2026-01-22T21:24:00.232Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","type":"tool_result","content":"Found 1 file\nroutes\\web.php"}]},"uuid":"bed09402-ca75-40ed-940c-7bcba7238d26","timestamp":"2026-01-22T21:24:00.948Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017aPvpPevjvFVVXgb6FYUb8","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}]},"uuid":"03e0e5f6-0d67-46e7-9561-d0165f67a45c","timestamp":"2026-01-22T21:24:02.117Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:03.832Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read the web.php file to see the route definitions:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"5c2e8c9f-717a-4a43-9361-8cfe4a8d6b2e"},{"type":"assistant","timestamp":"2026-01-22T21:24:04.026Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013MFvRHDwM8TB7iobMzEr8g","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"77eed9db-6d09-4fc5-b43b-bbe57f5ba88c"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013MFvRHDwM8TB7iobMzEr8g","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Str;\n     4→use Illuminate\\Http\\Request;\n     5→use Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n     6→\n     7→Route::get('/', function () {\n     8→    return redirect()->route('login');\n     9→});\n    10→\n    11→Auth::routes(['register' => false]);\n    12→\n    13→// Rutas de acceso para aplicante.\n    14→Route::group([\n    15→    'prefix'    => 'control-acceso',\n    16→    'namespace' => 'App\\Http\\Controllers\\Auth'\n    17→], function ($ruta) {\n    18→    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    19→    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    20→    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n    21→});\n    22→\n    23→// Rutas de migración de usuarios desde la base de datos antigua.\n    24→Route::group([\n    25→    'prefix'    => 'migrar-usuario-app-antigua',\n    26→    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n    27→], function ($ruta) {\n    28→    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    29→    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n    30→});\n    31→\n    32→// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\n    33→Route::group([\n    34→    'prefix'     => 'rol-empresa',\n    35→    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    36→    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n    37→], function ($ruta) {\n    38→    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    39→    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n    40→});\n    41→\n    42→// Rutas protegidas por autenticación y selección de rol y empresa.\n    43→Route::group([\n    44→    'middleware' => ['auth', 'auth.rol-empresa'],\n    45→    'namespace'  => 'App\\Http\\Controllers'\n    46→], function ($ruta) {\n    47→    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n    48→\n    49→    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n    50→        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n    51→        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n    52→\n    53→        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n    54→            // Usuarios\n    55→            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n    56→            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n    57→            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n    58→            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n    59→            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n    60→            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n    61→            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n    62→            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n    63→            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n    64→            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n    65→            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n    66→            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n    67→            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n    68→            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n    69→\n    70→            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n    71→            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n    72→            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n    73→        });\n    74→    });\n    75→\n    76→    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n    77→        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n    78→            // Pruebas\n    79→            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n    80→            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n    81→            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n    82→            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n    83→            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n    84→            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n    85→            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n    86→            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n    87→        });\n    88→\n    89→        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n    90→            // Carga masiva de pruebas\n    91→            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n    92→            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n    93→            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n    94→            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n    95→        });\n    96→\n    97→        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n    98→            // Baremos\n    99→            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n   100→            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n   101→            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n   102→            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n   103→        });\n   104→\n   105→        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n   106→            // Dimensiones\n   107→            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n   108→            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n   109→            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n   110→            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n   111→            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n   112→        });\n   113→\n   114→        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n   115→            // Factores\n   116→            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n   117→            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n   118→            $ruta->resource('factores', 'Pruebas\\FactorController');\n   119→            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n   120→        });\n   121→\n   122→        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n   123→            // Reactivos\n   124→            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n   125→            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n   126→            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n   127→\n   128→            // Opciones\n   129→            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n   130→        });\n   131→\n   132→        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n   133→            // Calificaciones\n   134→            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n   135→            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n   136→            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n   137→        });\n   138→\n   139→        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n   140→            // Grupos de opciones\n   141→            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n   142→            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n   143→            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n   144→        });\n   145→\n   146→        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n   147→            // Secciones de texto\n   148→            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n   149→            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n   150→            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n   151→        });\n   152→\n   153→        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n   154→    });\n   155→\n   156→    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n   157→        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n   158→            // Perfiles\n   159→            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n   160→            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n   161→            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n   162→        });\n   163→\n   164→        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n   165→            // Módulos de preguntas\n   166→            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n   167→            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n   168→            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n   169→            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n   170→            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n   171→        });\n   172→\n   173→        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n   174→            // Demográficas\n   175→            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n   176→            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n   177→            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n   178→        });\n   179→    });\n   180→\n   181→    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n   182→        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n   183→            // Listado de empresas\n   184→            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n   185→            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n   186→            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n   187→            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n   188→            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n   189→            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n   190→            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n   191→            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n   192→            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n   193→            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n   194→            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n   195→            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n   196→            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n   197→            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n   198→            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n   199→        });\n   200→\n   201→        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n   202→            // Gestionar empresas\n   203→            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n   204→            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n   205→            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n   206→            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n   207→\n   208→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n   209→                // Usuarios\n   210→                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n   211→                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n   212→            });\n   213→\n   214→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n   215→                // Planes\n   216→                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n   217→                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n   218→            });\n   219→        });\n   220→\n   221→        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n   222→            // Archivo de empresas\n   223→            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n   224→            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n   225→            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n   226→        });\n   227→\n   228→        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n   229→            // Migración de empresas\n   230→            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n   231→            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n   232→            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n   233→            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n   234→        });\n   235→\n   236→        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n   237→            // Portales de empleo\n   238→            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   239→            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   240→            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n   241→            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n   242→\n   243→            // Premios destacados\n   244→            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n   245→            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n   246→\n   247→            // Motivadores\n   248→            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n   249→        });\n   250→\n   251→        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n   252→        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n   253→        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n   254→    });\n   255→\n   256→    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n   257→        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n   258→        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n   259→        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n   260→        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n   261→    });\n   262→\n   263→    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n   264→        // Planes\n   265→        $ruta->resource('planes', 'Planes\\PlanController');\n   266→        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n   267→        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n   268→        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n   269→        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n   270→        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n   271→        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n   272→        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n   273→        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n   274→        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n   275→        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n   276→        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n   277→        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n   278→        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n   279→        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n   280→        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n   281→\n   282→        // Planes de Créditos - Vista de creación\n   283→        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n   284→        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   285→        $ruta->get('servicios-ia/{id}/creditos', 'IA\\ServicioIAController@creditos');\n   286→        $ruta->post('servicios-ia/{id}/activar', 'IA\\ServicioIAController@activar');\n   287→        $ruta->post('servicios-ia/{id}/desactivar', 'IA\\ServicioIAController@desactivar');\n   288→        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n   289→        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n   290→        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   291→\n   292→        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n   293→            // Consumos\n   294→            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n   295→            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n   296→            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n   297→            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n   298→            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n   299→            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n   300→            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n   301→            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n   302→            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n   303→            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n   304→            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n   305→            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n   306→            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n   307→        });\n   308→\n   309→        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n   310→            // Archivo\n   311→            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n   312→            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n   313→        });\n   314→    });\n   315→\n   316→    // Perfiles laborales\n   317→    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n   318→    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n   319→    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n   320→    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n   321→\n   322→    // Preguntas de ofertas laborales\n   323→    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n   324→    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n   325→    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n   326→    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n   327→    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n   328→    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n   329→\n   330→    // Preguntas de videoentrevista\n   331→    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n   332→    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n   333→    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n   334→    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n   335→\n   336→    // Vacantes\n   337→    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n   338→    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n   339→    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n   340→    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n   341→    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n   342→    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n   343→    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n   344→    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n   345→    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n   346→    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n   347→    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n   348→    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n   349→\n   350→    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n   351→\n   352→    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n   353→    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n   354→\n   355→    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n   356→        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n   357→            // Ajustes - General\n   358→            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n   359→        });\n   360→\n   361→        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n   362→            // Ajustes - Roles y permisos\n   363→            $ruta->get('roles', 'Auth\\RolController@index');\n   364→        });\n   365→\n   366→        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n   367→            // Ajustes - Deshacer acciones\n   368→            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n   369→            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n   370→            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n   371→            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n   372→        });\n   373→\n   374→        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n   375→            // Ajustes - Ofertas y anuncios\n   376→            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n   377→            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n   378→            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n   379→            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n   380→            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n   381→        });\n   382→\n   383→        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n   384→            // Webinars\n   385→            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n   386→            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n   387→            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n   388→            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n   389→            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n   390→            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n   391→\n   392→            // Eventos\n   393→            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n   394→            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n   395→            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n   396→            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n   397→            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n   398→            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n   399→\n   400→            // Guías\n   401→            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n   402→            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n   403→            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n   404→            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n   405→            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n   406→            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n   407→\n   408→            // Tutoriales\n   409→            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n   410→            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n   411→            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n   412→            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n   413→            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n   414→\n   415→            // Podcast\n   416→            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n   417→            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n   418→            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n   419→            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n   420→            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n   421→\n   422→            // Capacitación\n   423→            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n   424→            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n   425→            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n   426→            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n   427→            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n   428→\n   429→            // Certificación\n   430→            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n   431→            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n   432→            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n   433→            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n   434→            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n   435→            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n   436→        });\n   437→    });\n   438→\n   439→    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n   440→        // Soportes\n   441→        $ruta->resource('soportes', 'Soportes\\SoporteController');\n   442→        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n   443→        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n   444→        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n   445→        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n   446→        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n   447→        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n   448→        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n   449→        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n   450→        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n   451→\n   452→        // Manuales\n   453→        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n   454→        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n   455→\n   456→        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n   457→            // Aplicantes\n   458→            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n   459→        });\n   460→\n   461→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n   462→            // Preguntas frecuentes\n   463→            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n   464→            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n   465→            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n   466→            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n   467→            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n   468→        });\n   469→\n   470→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n   471→            // Preguntas frecuentes reacciónes\n   472→            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n   473→        });\n   474→    });\n   475→\n   476→    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n   477→    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n   478→    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n   479→\n   480→    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n   481→        // Módulos\n   482→        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n   483→        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n   484→\n   485→        // Auditorías\n   486→        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n   487→\n   488→        // Accesos\n   489→        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n   490→\n   491→        // Registros de actividad\n   492→        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n   493→\n   494→        // Novedades\n   495→        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n   496→        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n   497→        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n   498→\n   499→        // Países\n   500→        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n   501→        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n   502→        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n   503→        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n   504→        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n   505→\n   506→        // Reportes\n   507→        $ruta->resource('reportes', 'Reportes\\ReporteController');\n   508→        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n   509→        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n   510→\n   511→        // Minería de datos.\n   512→        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n   513→        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n   514→\n   515→        // Pruebas completas\n   516→        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n   517→        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n   518→        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n   519→        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n   520→        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n   521→    });\n   522→\n   523→    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n   524→        // Ordenes de servicio\n   525→        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n   526→        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n   527→        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n   528→\n   529→        // Ofertas laborales\n   530→        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n   531→        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n   532→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n   533→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n   534→        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n   535→        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n   536→        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n   537→        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n   538→        ->name('sin-disponibilidad-ofertas-laborales');\n   539→        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n   540→        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n   541→        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n   542→        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n   543→        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n   544→        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n   545→        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n   546→\n   547→        // Vacantes\n   548→        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n   549→        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n   550→\n   551→        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n   552→            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n   553→            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n   554→            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n   555→            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n   556→            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n   557→            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n   558→            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n   559→            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n   560→            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n   561→        });\n   562→\n   563→        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n   564→        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n   565→        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n   566→        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n   567→        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n   568→        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n   569→        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n   570→        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n   571→        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n   572→        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n   573→        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n   574→        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n   575→        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n   576→        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n   577→        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n   578→        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n   579→        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n   580→        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n   581→        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n   582→        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n   583→        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n   584→        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n   585→\n   586→        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n   587→        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n   588→        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n   589→\n   590→        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n   591→        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n   592→        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n   593→\n   594→        // Etapas\n   595→        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n   596→        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n   597→        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n   598→        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n   599→        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n   600→        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n   601→\n   602→        // Movimientos\n   603→        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n   604→        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n   605→        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n   606→        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n   607→\n   608→        // Novedades\n   609→        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n   610→\n   611→        $ruta->get('feedback', 'DashboardController@enConstruccion');\n   612→        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n   613→\n   614→        // Procesos\n   615→        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n   616→        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n   617→        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n   618→        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n   619→        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n   620→        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n   621→        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n   622→        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n   623→        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n   624→        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n   625→        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n   626→        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n   627→        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n   628→        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n   629→        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n   630→        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n   631→        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n   632→        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n   633→        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n   634→        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n   635→        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n   636→        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n   637→        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n   638→        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n   639→        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n   640→        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n   641→        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n   642→        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n   643→        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n   644→        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n   645→        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n   646→        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n   647→\n   648→        // Firmas de rutas\n   649→        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n   650→\n   651→        // Perfiles pruebas\n   652→        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n   653→\n   654→        // Agendas\n   655→        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n   656→        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n   657→        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n   658→        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n   659→\n   660→        // Comentarios\n   661→        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n   662→\n   663→        // Usuarios\n   664→        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n   665→    });\n   666→\n   667→    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n   668→        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n   669→\n   670→        // Debug de calificaciones de agendas\n   671→        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n   672→        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n   673→        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n   674→        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n   675→    });\n   676→\n   677→    // Suplantación de rol Administrador general\n   678→    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n   679→        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n   680→    });\n   681→\n   682→    // Suplantación de rol Administrador sucursal\n   683→    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n   684→        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n   685→    });\n   686→\n   687→    // Restablecimiento de la sesión original que había antes de la suplantación\n   688→    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n   689→        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n   690→    });\n   691→\n   692→    // Ruta para completar los datos de un usuario aplicante\n   693→    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n   694→        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n   695→        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n   696→        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n   697→        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n   698→    });\n   699→\n   700→    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n   701→    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n   702→        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n   703→        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n   704→        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n   705→        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n   706→        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n   707→        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n   708→        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n   709→        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n   710→        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n   711→        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n   712→        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n   713→        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n   714→        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n   715→        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n   716→        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n   717→        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n   718→        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n   719→        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n   720→        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n   721→        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   722→        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n   723→            ->name('ofertas-laborales.detalles-aplicante');\n   724→        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   725→        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n   726→\n   727→        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n   728→    });\n   729→\n   730→    // Ofertas laborales\n   731→    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n   732→\n   733→    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n   734→    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n   735→    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n   736→    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n   737→    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n   738→    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n   739→    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n   740→\n   741→    // Usuarios\n   742→    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n   743→    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n   744→\n   745→    // Perfiles\n   746→    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n   747→    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n   748→    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n   749→    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n   750→    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n   751→\n   752→    // Archivos\n   753→    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n   754→    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n   755→    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n   756→\n   757→    // Menú clientes\n   758→    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n   759→    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n   760→    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n   761→\n   762→    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n   763→    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n   764→    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n   765→    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n   766→    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n   767→\n   768→    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n   769→    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n   770→    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n   771→    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n   772→    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n   773→    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n   774→    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n   775→    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n   776→    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n   777→\n   778→    // Agendas - Accesible para aplicantes y usuarios de empresa\n   779→    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n   780→\n   781→    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n   782→    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n   783→    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n   784→    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n   785→    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n   786→\n   787→    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n   788→    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n   789→\n   790→    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n   791→    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n   792→    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n   793→\n   794→    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n   795→    $ruta->get('novedades', 'DashboardController@enConstruccion');\n   796→\n   797→    // Áreas\n   798→    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n   799→    $ruta->post('areas', 'Empresas\\AreaController@store');\n   800→\n   801→    // Cargos\n   802→    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n   803→    $ruta->post('cargos', 'Empresas\\CargoController@store');\n   804→\n   805→    // Niveles educativos\n   806→    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n   807→\n   808→    // Áreas de estudio\n   809→    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n   810→\n   811→    // Idiomas\n   812→    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n   813→\n   814→    // Autenticación del websoket\n   815→    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n   816→\n   817→    $ruta->get('/botones', function () {\n   818→        return view('botones');\n   819→    })->name('botones');\n   820→\n   821→    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n   822→    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n   823→    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n   824→\n   825→    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n   826→    $ruta->get('analiticas', 'DashboardController@index');\n   827→    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n   828→    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n   829→    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n   830→    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n   831→    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n   832→\n   833→    // Rutas de componentes de desarrollo\n   834→    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n   835→    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n   836→\n   837→    // TODO: ruta de prueba, eliminarla próximamente\n   838→    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n   839→    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n   840→    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n   841→    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n   842→    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n   843→\n   844→    // Rutas para las encuestas\n   845→    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n   846→    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n   847→});\n   848→\n   849→// Rutas no protegidas por autenticación\n   850→Route::group([\n   851→    'namespace' => 'App\\Http\\Controllers'\n   852→], function ($ruta) {\n   853→    // Contraseñas\n   854→    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n   855→\n   856→    // Empresas\n   857→    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n   858→    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n   859→    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n   860→    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n   861→    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n   862→\n   863→    // Ordenes de servicio\n   864→    $ruta->group([\n   865→        'middleware' => 'orden-servicio-enlace-publico'\n   866→    ], function ($ruta) {\n   867→        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n   868→        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n   869→    });\n   870→\n   871→    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n   872→\n   873→    // Países\n   874→    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n   875→    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n   876→\n   877→    // Departamentos\n   878→    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n   879→\n   880→    // Ciudades\n   881→    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n   882→\n   883→    // Portales de empleo\n   884→    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n   885→    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n   886→    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n   887→    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n   888→    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n   889→    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n   890→    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n   891→\n   892→    // Firmas de rutas\n   893→    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n   894→    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n   895→    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n   896→    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n   897→\n   898→    // Archivos\n   899→    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n   900→\n   901→    // Imagen de usuarios\n   902→    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n   903→\n   904→    // Consultar reportes con firma\n   905→    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n   906→});\n   907→\n   908→/**\n   909→ * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n   910→ *\n   911→ * @author Fahibram Cárcamo\n   912→ */\n   913→Route::group([\n   914→    'prefix'     => 'rutas-firmadas',\n   915→    'middleware' => ['ruta-firmada'],\n   916→    'namespace'  => 'App\\Http\\Controllers'\n   917→], function ($ruta) {\n   918→    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n   919→    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n   920→});\n   921→\n   922→/**\n   923→ * Genera un token SSO firmado y redirige a WordPress.\n   924→ *\n   925→ * Flujo:\n   926→ *  - Requiere un usuario autenticado (será el admin en WP).\n   927→ *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n   928→ *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n   929→ *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n   930→ *  - Redirige al callback configurado en WordPress.\n   931→ *\n   932→ * @author Sergio Vargas\n   933→ */\n   934→Route::get('/sso/wordpress', function (Request $request) {\n   935→    $user = $request->user();\n   936→\n   937→    $studentId   = $request->input('student_id');\n   938→    $studentData = null;\n   939→\n   940→    if ($studentId) {\n   941→        $student = App\\Models\\Usuarios\\User::find($studentId);\n   942→\n   943→        if ($student && $student->id !== $user->id) {\n   944→            $studentData = [\n   945→                'id'    => (string) $student->id,\n   946→                'email' => $student->email,\n   947→                'name'  => $student->getNombreCompletoAttribute(),\n   948→            ];\n   949→        }\n   950→    }\n   951→\n   952→    $nonce = (string) Str::uuid();\n   953→    $exp   = now()->addSeconds(60)->timestamp;\n   954→\n   955→    Cache::put(\"sso_nonce:{$nonce}\", [\n   956→        'user_id' => $user->id,\n   957→        'exp'     => $exp,\n   958→    ], now()->addMinutes(5));\n   959→\n   960→    $payload = [\n   961→        'sub'     => (string) $user->id,\n   962→        'email'   => $user->email,\n   963→        'name'    => $user->getNombreCompletoAttribute(),\n   964→        'nonce'   => $nonce,\n   965→        'exp'     => $exp,\n   966→        'student' => $studentData,\n   967→    ];\n   968→\n   969→    $token    = sso_sign_token($payload, config('services.sso.secret'));\n   970→    $wp       = rtrim(config('services.sso.wp_url'), '/');\n   971→    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n   972→    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n   973→\n   974→    return redirect()->away(\n   975→        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n   976→    );\n   977→})->middleware('auth');\n   978→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0d63123c-dd15-46dd-92b9-7e3cd5adfee3","timestamp":"2026-01-22T21:24:05.464Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:09.346Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SA2xTvsNGQ23frcfK7XrXY","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I found the issue. Let me search for the specific route that defines \"consumo\" to get the complete picture:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":26989,"cache_read_input_tokens":20556,"cache_creation":{"ephemeral_5m_input_tokens":26989,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xhjdgDtXxm22f61pY","uuid":"b44d95cc-38e0-487b-8b3a-27bed60f9c4d"},{"type":"assistant","timestamp":"2026-01-22T21:24:09.976Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SA2xTvsNGQ23frcfK7XrXY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016g2xruZ8G5Dys2yYXu7i26","name":"Grep","input":{"pattern":"consumo|paginaConsumos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":26989,"cache_read_input_tokens":20556,"cache_creation":{"ephemeral_5m_input_tokens":26989,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xhjdgDtXxm22f61pY","uuid":"7eebb30e-4213-4d4d-a287-365923b81b56"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"781ca0ea-e099-4346-a7d1-95c2e67f940f","timestamp":"2026-01-22T21:24:10.017Z"}
{"parentUuid":"781ca0ea-e099-4346-a7d1-95c2e67f940f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016g2xruZ8G5Dys2yYXu7i26","type":"tool_result","content":"263:    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n289:        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n292:        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n294:            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n301:            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n302:            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n303:            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n304:            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n305:            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n306:            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n309:        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n790:    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');"}]},"uuid":"d3d1bfc1-4909-4741-925b-8cab40aca188","timestamp":"2026-01-22T21:24:11.814Z"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUgQii42KiQ94SnWfGBsqU","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"49efb63e-1db2-4a30-b762-a1bc0e161a63","timestamp":"2026-01-22T21:24:00.232Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","type":"tool_result","content":"Found 1 file\nroutes\\web.php"}]},"uuid":"bed09402-ca75-40ed-940c-7bcba7238d26","timestamp":"2026-01-22T21:24:00.948Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017aPvpPevjvFVVXgb6FYUb8","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}]},"uuid":"03e0e5f6-0d67-46e7-9561-d0165f67a45c","timestamp":"2026-01-22T21:24:02.117Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:03.832Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read the web.php file to see the route definitions:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"5c2e8c9f-717a-4a43-9361-8cfe4a8d6b2e"},{"type":"assistant","timestamp":"2026-01-22T21:24:04.026Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013MFvRHDwM8TB7iobMzEr8g","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"77eed9db-6d09-4fc5-b43b-bbe57f5ba88c"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013MFvRHDwM8TB7iobMzEr8g","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Str;\n     4→use Illuminate\\Http\\Request;\n     5→use Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n     6→\n     7→Route::get('/', function () {\n     8→    return redirect()->route('login');\n     9→});\n    10→\n    11→Auth::routes(['register' => false]);\n    12→\n    13→// Rutas de acceso para aplicante.\n    14→Route::group([\n    15→    'prefix'    => 'control-acceso',\n    16→    'namespace' => 'App\\Http\\Controllers\\Auth'\n    17→], function ($ruta) {\n    18→    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    19→    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    20→    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n    21→});\n    22→\n    23→// Rutas de migración de usuarios desde la base de datos antigua.\n    24→Route::group([\n    25→    'prefix'    => 'migrar-usuario-app-antigua',\n    26→    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n    27→], function ($ruta) {\n    28→    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    29→    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n    30→});\n    31→\n    32→// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\n    33→Route::group([\n    34→    'prefix'     => 'rol-empresa',\n    35→    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    36→    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n    37→], function ($ruta) {\n    38→    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    39→    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n    40→});\n    41→\n    42→// Rutas protegidas por autenticación y selección de rol y empresa.\n    43→Route::group([\n    44→    'middleware' => ['auth', 'auth.rol-empresa'],\n    45→    'namespace'  => 'App\\Http\\Controllers'\n    46→], function ($ruta) {\n    47→    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n    48→\n    49→    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n    50→        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n    51→        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n    52→\n    53→        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n    54→            // Usuarios\n    55→            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n    56→            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n    57→            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n    58→            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n    59→            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n    60→            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n    61→            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n    62→            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n    63→            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n    64→            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n    65→            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n    66→            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n    67→            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n    68→            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n    69→\n    70→            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n    71→            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n    72→            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n    73→        });\n    74→    });\n    75→\n    76→    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n    77→        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n    78→            // Pruebas\n    79→            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n    80→            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n    81→            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n    82→            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n    83→            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n    84→            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n    85→            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n    86→            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n    87→        });\n    88→\n    89→        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n    90→            // Carga masiva de pruebas\n    91→            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n    92→            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n    93→            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n    94→            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n    95→        });\n    96→\n    97→        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n    98→            // Baremos\n    99→            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n   100→            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n   101→            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n   102→            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n   103→        });\n   104→\n   105→        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n   106→            // Dimensiones\n   107→            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n   108→            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n   109→            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n   110→            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n   111→            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n   112→        });\n   113→\n   114→        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n   115→            // Factores\n   116→            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n   117→            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n   118→            $ruta->resource('factores', 'Pruebas\\FactorController');\n   119→            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n   120→        });\n   121→\n   122→        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n   123→            // Reactivos\n   124→            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n   125→            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n   126→            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n   127→\n   128→            // Opciones\n   129→            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n   130→        });\n   131→\n   132→        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n   133→            // Calificaciones\n   134→            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n   135→            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n   136→            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n   137→        });\n   138→\n   139→        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n   140→            // Grupos de opciones\n   141→            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n   142→            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n   143→            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n   144→        });\n   145→\n   146→        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n   147→            // Secciones de texto\n   148→            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n   149→            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n   150→            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n   151→        });\n   152→\n   153→        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n   154→    });\n   155→\n   156→    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n   157→        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n   158→            // Perfiles\n   159→            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n   160→            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n   161→            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n   162→        });\n   163→\n   164→        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n   165→            // Módulos de preguntas\n   166→            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n   167→            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n   168→            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n   169→            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n   170→            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n   171→        });\n   172→\n   173→        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n   174→            // Demográficas\n   175→            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n   176→            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n   177→            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n   178→        });\n   179→    });\n   180→\n   181→    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n   182→        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n   183→            // Listado de empresas\n   184→            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n   185→            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n   186→            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n   187→            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n   188→            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n   189→            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n   190→            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n   191→            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n   192→            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n   193→            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n   194→            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n   195→            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n   196→            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n   197→            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n   198→            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n   199→        });\n   200→\n   201→        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n   202→            // Gestionar empresas\n   203→            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n   204→            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n   205→            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n   206→            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n   207→\n   208→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n   209→                // Usuarios\n   210→                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n   211→                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n   212→            });\n   213→\n   214→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n   215→                // Planes\n   216→                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n   217→                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n   218→            });\n   219→        });\n   220→\n   221→        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n   222→            // Archivo de empresas\n   223→            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n   224→            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n   225→            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n   226→        });\n   227→\n   228→        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n   229→            // Migración de empresas\n   230→            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n   231→            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n   232→            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n   233→            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n   234→        });\n   235→\n   236→        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n   237→            // Portales de empleo\n   238→            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   239→            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   240→            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n   241→            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n   242→\n   243→            // Premios destacados\n   244→            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n   245→            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n   246→\n   247→            // Motivadores\n   248→            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n   249→        });\n   250→\n   251→        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n   252→        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n   253→        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n   254→    });\n   255→\n   256→    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n   257→        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n   258→        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n   259→        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n   260→        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n   261→    });\n   262→\n   263→    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n   264→        // Planes\n   265→        $ruta->resource('planes', 'Planes\\PlanController');\n   266→        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n   267→        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n   268→        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n   269→        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n   270→        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n   271→        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n   272→        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n   273→        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n   274→        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n   275→        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n   276→        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n   277→        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n   278→        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n   279→        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n   280→        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n   281→\n   282→        // Planes de Créditos - Vista de creación\n   283→        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n   284→        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   285→        $ruta->get('servicios-ia/{id}/creditos', 'IA\\ServicioIAController@creditos');\n   286→        $ruta->post('servicios-ia/{id}/activar', 'IA\\ServicioIAController@activar');\n   287→        $ruta->post('servicios-ia/{id}/desactivar', 'IA\\ServicioIAController@desactivar');\n   288→        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n   289→        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n   290→        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   291→\n   292→        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n   293→            // Consumos\n   294→            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n   295→            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n   296→            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n   297→            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n   298→            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n   299→            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n   300→            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n   301→            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n   302→            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n   303→            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n   304→            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n   305→            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n   306→            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n   307→        });\n   308→\n   309→        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n   310→            // Archivo\n   311→            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n   312→            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n   313→        });\n   314→    });\n   315→\n   316→    // Perfiles laborales\n   317→    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n   318→    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n   319→    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n   320→    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n   321→\n   322→    // Preguntas de ofertas laborales\n   323→    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n   324→    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n   325→    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n   326→    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n   327→    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n   328→    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n   329→\n   330→    // Preguntas de videoentrevista\n   331→    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n   332→    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n   333→    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n   334→    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n   335→\n   336→    // Vacantes\n   337→    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n   338→    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n   339→    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n   340→    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n   341→    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n   342→    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n   343→    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n   344→    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n   345→    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n   346→    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n   347→    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n   348→    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n   349→\n   350→    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n   351→\n   352→    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n   353→    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n   354→\n   355→    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n   356→        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n   357→            // Ajustes - General\n   358→            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n   359→        });\n   360→\n   361→        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n   362→            // Ajustes - Roles y permisos\n   363→            $ruta->get('roles', 'Auth\\RolController@index');\n   364→        });\n   365→\n   366→        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n   367→            // Ajustes - Deshacer acciones\n   368→            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n   369→            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n   370→            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n   371→            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n   372→        });\n   373→\n   374→        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n   375→            // Ajustes - Ofertas y anuncios\n   376→            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n   377→            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n   378→            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n   379→            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n   380→            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n   381→        });\n   382→\n   383→        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n   384→            // Webinars\n   385→            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n   386→            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n   387→            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n   388→            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n   389→            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n   390→            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n   391→\n   392→            // Eventos\n   393→            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n   394→            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n   395→            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n   396→            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n   397→            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n   398→            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n   399→\n   400→            // Guías\n   401→            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n   402→            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n   403→            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n   404→            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n   405→            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n   406→            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n   407→\n   408→            // Tutoriales\n   409→            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n   410→            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n   411→            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n   412→            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n   413→            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n   414→\n   415→            // Podcast\n   416→            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n   417→            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n   418→            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n   419→            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n   420→            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n   421→\n   422→            // Capacitación\n   423→            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n   424→            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n   425→            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n   426→            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n   427→            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n   428→\n   429→            // Certificación\n   430→            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n   431→            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n   432→            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n   433→            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n   434→            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n   435→            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n   436→        });\n   437→    });\n   438→\n   439→    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n   440→        // Soportes\n   441→        $ruta->resource('soportes', 'Soportes\\SoporteController');\n   442→        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n   443→        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n   444→        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n   445→        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n   446→        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n   447→        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n   448→        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n   449→        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n   450→        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n   451→\n   452→        // Manuales\n   453→        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n   454→        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n   455→\n   456→        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n   457→            // Aplicantes\n   458→            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n   459→        });\n   460→\n   461→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n   462→            // Preguntas frecuentes\n   463→            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n   464→            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n   465→            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n   466→            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n   467→            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n   468→        });\n   469→\n   470→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n   471→            // Preguntas frecuentes reacciónes\n   472→            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n   473→        });\n   474→    });\n   475→\n   476→    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n   477→    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n   478→    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n   479→\n   480→    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n   481→        // Módulos\n   482→        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n   483→        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n   484→\n   485→        // Auditorías\n   486→        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n   487→\n   488→        // Accesos\n   489→        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n   490→\n   491→        // Registros de actividad\n   492→        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n   493→\n   494→        // Novedades\n   495→        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n   496→        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n   497→        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n   498→\n   499→        // Países\n   500→        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n   501→        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n   502→        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n   503→        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n   504→        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n   505→\n   506→        // Reportes\n   507→        $ruta->resource('reportes', 'Reportes\\ReporteController');\n   508→        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n   509→        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n   510→\n   511→        // Minería de datos.\n   512→        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n   513→        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n   514→\n   515→        // Pruebas completas\n   516→        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n   517→        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n   518→        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n   519→        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n   520→        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n   521→    });\n   522→\n   523→    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n   524→        // Ordenes de servicio\n   525→        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n   526→        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n   527→        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n   528→\n   529→        // Ofertas laborales\n   530→        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n   531→        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n   532→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n   533→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n   534→        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n   535→        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n   536→        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n   537→        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n   538→        ->name('sin-disponibilidad-ofertas-laborales');\n   539→        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n   540→        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n   541→        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n   542→        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n   543→        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n   544→        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n   545→        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n   546→\n   547→        // Vacantes\n   548→        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n   549→        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n   550→\n   551→        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n   552→            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n   553→            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n   554→            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n   555→            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n   556→            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n   557→            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n   558→            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n   559→            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n   560→            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n   561→        });\n   562→\n   563→        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n   564→        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n   565→        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n   566→        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n   567→        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n   568→        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n   569→        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n   570→        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n   571→        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n   572→        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n   573→        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n   574→        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n   575→        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n   576→        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n   577→        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n   578→        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n   579→        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n   580→        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n   581→        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n   582→        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n   583→        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n   584→        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n   585→\n   586→        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n   587→        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n   588→        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n   589→\n   590→        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n   591→        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n   592→        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n   593→\n   594→        // Etapas\n   595→        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n   596→        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n   597→        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n   598→        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n   599→        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n   600→        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n   601→\n   602→        // Movimientos\n   603→        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n   604→        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n   605→        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n   606→        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n   607→\n   608→        // Novedades\n   609→        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n   610→\n   611→        $ruta->get('feedback', 'DashboardController@enConstruccion');\n   612→        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n   613→\n   614→        // Procesos\n   615→        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n   616→        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n   617→        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n   618→        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n   619→        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n   620→        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n   621→        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n   622→        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n   623→        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n   624→        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n   625→        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n   626→        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n   627→        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n   628→        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n   629→        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n   630→        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n   631→        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n   632→        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n   633→        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n   634→        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n   635→        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n   636→        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n   637→        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n   638→        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n   639→        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n   640→        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n   641→        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n   642→        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n   643→        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n   644→        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n   645→        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n   646→        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n   647→\n   648→        // Firmas de rutas\n   649→        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n   650→\n   651→        // Perfiles pruebas\n   652→        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n   653→\n   654→        // Agendas\n   655→        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n   656→        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n   657→        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n   658→        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n   659→\n   660→        // Comentarios\n   661→        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n   662→\n   663→        // Usuarios\n   664→        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n   665→    });\n   666→\n   667→    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n   668→        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n   669→\n   670→        // Debug de calificaciones de agendas\n   671→        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n   672→        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n   673→        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n   674→        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n   675→    });\n   676→\n   677→    // Suplantación de rol Administrador general\n   678→    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n   679→        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n   680→    });\n   681→\n   682→    // Suplantación de rol Administrador sucursal\n   683→    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n   684→        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n   685→    });\n   686→\n   687→    // Restablecimiento de la sesión original que había antes de la suplantación\n   688→    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n   689→        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n   690→    });\n   691→\n   692→    // Ruta para completar los datos de un usuario aplicante\n   693→    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n   694→        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n   695→        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n   696→        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n   697→        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n   698→    });\n   699→\n   700→    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n   701→    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n   702→        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n   703→        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n   704→        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n   705→        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n   706→        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n   707→        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n   708→        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n   709→        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n   710→        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n   711→        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n   712→        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n   713→        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n   714→        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n   715→        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n   716→        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n   717→        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n   718→        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n   719→        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n   720→        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n   721→        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   722→        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n   723→            ->name('ofertas-laborales.detalles-aplicante');\n   724→        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   725→        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n   726→\n   727→        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n   728→    });\n   729→\n   730→    // Ofertas laborales\n   731→    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n   732→\n   733→    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n   734→    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n   735→    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n   736→    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n   737→    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n   738→    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n   739→    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n   740→\n   741→    // Usuarios\n   742→    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n   743→    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n   744→\n   745→    // Perfiles\n   746→    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n   747→    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n   748→    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n   749→    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n   750→    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n   751→\n   752→    // Archivos\n   753→    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n   754→    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n   755→    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n   756→\n   757→    // Menú clientes\n   758→    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n   759→    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n   760→    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n   761→\n   762→    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n   763→    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n   764→    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n   765→    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n   766→    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n   767→\n   768→    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n   769→    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n   770→    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n   771→    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n   772→    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n   773→    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n   774→    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n   775→    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n   776→    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n   777→\n   778→    // Agendas - Accesible para aplicantes y usuarios de empresa\n   779→    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n   780→\n   781→    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n   782→    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n   783→    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n   784→    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n   785→    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n   786→\n   787→    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n   788→    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n   789→\n   790→    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n   791→    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n   792→    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n   793→\n   794→    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n   795→    $ruta->get('novedades', 'DashboardController@enConstruccion');\n   796→\n   797→    // Áreas\n   798→    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n   799→    $ruta->post('areas', 'Empresas\\AreaController@store');\n   800→\n   801→    // Cargos\n   802→    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n   803→    $ruta->post('cargos', 'Empresas\\CargoController@store');\n   804→\n   805→    // Niveles educativos\n   806→    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n   807→\n   808→    // Áreas de estudio\n   809→    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n   810→\n   811→    // Idiomas\n   812→    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n   813→\n   814→    // Autenticación del websoket\n   815→    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n   816→\n   817→    $ruta->get('/botones', function () {\n   818→        return view('botones');\n   819→    })->name('botones');\n   820→\n   821→    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n   822→    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n   823→    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n   824→\n   825→    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n   826→    $ruta->get('analiticas', 'DashboardController@index');\n   827→    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n   828→    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n   829→    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n   830→    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n   831→    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n   832→\n   833→    // Rutas de componentes de desarrollo\n   834→    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n   835→    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n   836→\n   837→    // TODO: ruta de prueba, eliminarla próximamente\n   838→    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n   839→    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n   840→    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n   841→    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n   842→    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n   843→\n   844→    // Rutas para las encuestas\n   845→    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n   846→    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n   847→});\n   848→\n   849→// Rutas no protegidas por autenticación\n   850→Route::group([\n   851→    'namespace' => 'App\\Http\\Controllers'\n   852→], function ($ruta) {\n   853→    // Contraseñas\n   854→    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n   855→\n   856→    // Empresas\n   857→    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n   858→    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n   859→    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n   860→    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n   861→    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n   862→\n   863→    // Ordenes de servicio\n   864→    $ruta->group([\n   865→        'middleware' => 'orden-servicio-enlace-publico'\n   866→    ], function ($ruta) {\n   867→        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n   868→        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n   869→    });\n   870→\n   871→    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n   872→\n   873→    // Países\n   874→    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n   875→    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n   876→\n   877→    // Departamentos\n   878→    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n   879→\n   880→    // Ciudades\n   881→    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n   882→\n   883→    // Portales de empleo\n   884→    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n   885→    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n   886→    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n   887→    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n   888→    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n   889→    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n   890→    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n   891→\n   892→    // Firmas de rutas\n   893→    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n   894→    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n   895→    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n   896→    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n   897→\n   898→    // Archivos\n   899→    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n   900→\n   901→    // Imagen de usuarios\n   902→    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n   903→\n   904→    // Consultar reportes con firma\n   905→    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n   906→});\n   907→\n   908→/**\n   909→ * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n   910→ *\n   911→ * @author Fahibram Cárcamo\n   912→ */\n   913→Route::group([\n   914→    'prefix'     => 'rutas-firmadas',\n   915→    'middleware' => ['ruta-firmada'],\n   916→    'namespace'  => 'App\\Http\\Controllers'\n   917→], function ($ruta) {\n   918→    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n   919→    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n   920→});\n   921→\n   922→/**\n   923→ * Genera un token SSO firmado y redirige a WordPress.\n   924→ *\n   925→ * Flujo:\n   926→ *  - Requiere un usuario autenticado (será el admin en WP).\n   927→ *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n   928→ *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n   929→ *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n   930→ *  - Redirige al callback configurado en WordPress.\n   931→ *\n   932→ * @author Sergio Vargas\n   933→ */\n   934→Route::get('/sso/wordpress', function (Request $request) {\n   935→    $user = $request->user();\n   936→\n   937→    $studentId   = $request->input('student_id');\n   938→    $studentData = null;\n   939→\n   940→    if ($studentId) {\n   941→        $student = App\\Models\\Usuarios\\User::find($studentId);\n   942→\n   943→        if ($student && $student->id !== $user->id) {\n   944→            $studentData = [\n   945→                'id'    => (string) $student->id,\n   946→                'email' => $student->email,\n   947→                'name'  => $student->getNombreCompletoAttribute(),\n   948→            ];\n   949→        }\n   950→    }\n   951→\n   952→    $nonce = (string) Str::uuid();\n   953→    $exp   = now()->addSeconds(60)->timestamp;\n   954→\n   955→    Cache::put(\"sso_nonce:{$nonce}\", [\n   956→        'user_id' => $user->id,\n   957→        'exp'     => $exp,\n   958→    ], now()->addMinutes(5));\n   959→\n   960→    $payload = [\n   961→        'sub'     => (string) $user->id,\n   962→        'email'   => $user->email,\n   963→        'name'    => $user->getNombreCompletoAttribute(),\n   964→        'nonce'   => $nonce,\n   965→        'exp'     => $exp,\n   966→        'student' => $studentData,\n   967→    ];\n   968→\n   969→    $token    = sso_sign_token($payload, config('services.sso.secret'));\n   970→    $wp       = rtrim(config('services.sso.wp_url'), '/');\n   971→    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n   972→    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n   973→\n   974→    return redirect()->away(\n   975→        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n   976→    );\n   977→})->middleware('auth');\n   978→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0d63123c-dd15-46dd-92b9-7e3cd5adfee3","timestamp":"2026-01-22T21:24:05.464Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:09.346Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SA2xTvsNGQ23frcfK7XrXY","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I found the issue. Let me search for the specific route that defines \"consumo\" to get the complete picture:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":26989,"cache_read_input_tokens":20556,"cache_creation":{"ephemeral_5m_input_tokens":26989,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xhjdgDtXxm22f61pY","uuid":"b44d95cc-38e0-487b-8b3a-27bed60f9c4d"},{"type":"assistant","timestamp":"2026-01-22T21:24:09.976Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SA2xTvsNGQ23frcfK7XrXY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016g2xruZ8G5Dys2yYXu7i26","name":"Grep","input":{"pattern":"consumo|paginaConsumos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":26989,"cache_read_input_tokens":20556,"cache_creation":{"ephemeral_5m_input_tokens":26989,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xhjdgDtXxm22f61pY","uuid":"7eebb30e-4213-4d4d-a287-365923b81b56"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016g2xruZ8G5Dys2yYXu7i26","type":"tool_result","content":"263:    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n289:        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n292:        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n294:            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n301:            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n302:            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n303:            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n304:            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n305:            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n306:            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n309:        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n790:    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');"}]},"uuid":"d3d1bfc1-4909-4741-925b-8cab40aca188","timestamp":"2026-01-22T21:24:11.814Z"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"31731a5c-56e1-4cc6-b1f4-a8f7f1727b6d","timestamp":"2026-01-22T21:24:11.895Z"}
{"parentUuid":"31731a5c-56e1-4cc6-b1f4-a8f7f1727b6d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-22T21:24:14.305Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01V1NcYL3qEMX8XcXWmfrVdL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015khCdCsSmUe5cZu22Hpnje","name":"Bash","input":{"command":"grep -n \"resource.*planes\\|get.*planes.*consumo\\|consumo\" \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php\" | head -30"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":666,"cache_read_input_tokens":47545,"cache_creation":{"ephemeral_5m_input_tokens":666,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7yAEaN1LLkXjF54HAd","uuid":"336baa12-25b9-42bb-9a95-2d1c1a23fb73"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUgQii42KiQ94SnWfGBsqU","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"49efb63e-1db2-4a30-b762-a1bc0e161a63","timestamp":"2026-01-22T21:24:00.232Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","type":"tool_result","content":"Found 1 file\nroutes\\web.php"}]},"uuid":"bed09402-ca75-40ed-940c-7bcba7238d26","timestamp":"2026-01-22T21:24:00.948Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017aPvpPevjvFVVXgb6FYUb8","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}]},"uuid":"03e0e5f6-0d67-46e7-9561-d0165f67a45c","timestamp":"2026-01-22T21:24:02.117Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:03.832Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read the web.php file to see the route definitions:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"5c2e8c9f-717a-4a43-9361-8cfe4a8d6b2e"},{"type":"assistant","timestamp":"2026-01-22T21:24:04.026Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013MFvRHDwM8TB7iobMzEr8g","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"77eed9db-6d09-4fc5-b43b-bbe57f5ba88c"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013MFvRHDwM8TB7iobMzEr8g","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Str;\n     4→use Illuminate\\Http\\Request;\n     5→use Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n     6→\n     7→Route::get('/', function () {\n     8→    return redirect()->route('login');\n     9→});\n    10→\n    11→Auth::routes(['register' => false]);\n    12→\n    13→// Rutas de acceso para aplicante.\n    14→Route::group([\n    15→    'prefix'    => 'control-acceso',\n    16→    'namespace' => 'App\\Http\\Controllers\\Auth'\n    17→], function ($ruta) {\n    18→    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    19→    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    20→    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n    21→});\n    22→\n    23→// Rutas de migración de usuarios desde la base de datos antigua.\n    24→Route::group([\n    25→    'prefix'    => 'migrar-usuario-app-antigua',\n    26→    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n    27→], function ($ruta) {\n    28→    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    29→    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n    30→});\n    31→\n    32→// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\n    33→Route::group([\n    34→    'prefix'     => 'rol-empresa',\n    35→    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    36→    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n    37→], function ($ruta) {\n    38→    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    39→    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n    40→});\n    41→\n    42→// Rutas protegidas por autenticación y selección de rol y empresa.\n    43→Route::group([\n    44→    'middleware' => ['auth', 'auth.rol-empresa'],\n    45→    'namespace'  => 'App\\Http\\Controllers'\n    46→], function ($ruta) {\n    47→    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n    48→\n    49→    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n    50→        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n    51→        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n    52→\n    53→        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n    54→            // Usuarios\n    55→            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n    56→            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n    57→            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n    58→            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n    59→            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n    60→            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n    61→            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n    62→            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n    63→            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n    64→            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n    65→            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n    66→            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n    67→            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n    68→            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n    69→\n    70→            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n    71→            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n    72→            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n    73→        });\n    74→    });\n    75→\n    76→    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n    77→        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n    78→            // Pruebas\n    79→            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n    80→            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n    81→            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n    82→            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n    83→            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n    84→            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n    85→            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n    86→            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n    87→        });\n    88→\n    89→        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n    90→            // Carga masiva de pruebas\n    91→            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n    92→            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n    93→            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n    94→            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n    95→        });\n    96→\n    97→        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n    98→            // Baremos\n    99→            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n   100→            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n   101→            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n   102→            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n   103→        });\n   104→\n   105→        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n   106→            // Dimensiones\n   107→            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n   108→            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n   109→            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n   110→            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n   111→            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n   112→        });\n   113→\n   114→        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n   115→            // Factores\n   116→            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n   117→            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n   118→            $ruta->resource('factores', 'Pruebas\\FactorController');\n   119→            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n   120→        });\n   121→\n   122→        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n   123→            // Reactivos\n   124→            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n   125→            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n   126→            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n   127→\n   128→            // Opciones\n   129→            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n   130→        });\n   131→\n   132→        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n   133→            // Calificaciones\n   134→            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n   135→            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n   136→            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n   137→        });\n   138→\n   139→        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n   140→            // Grupos de opciones\n   141→            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n   142→            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n   143→            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n   144→        });\n   145→\n   146→        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n   147→            // Secciones de texto\n   148→            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n   149→            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n   150→            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n   151→        });\n   152→\n   153→        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n   154→    });\n   155→\n   156→    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n   157→        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n   158→            // Perfiles\n   159→            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n   160→            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n   161→            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n   162→        });\n   163→\n   164→        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n   165→            // Módulos de preguntas\n   166→            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n   167→            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n   168→            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n   169→            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n   170→            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n   171→        });\n   172→\n   173→        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n   174→            // Demográficas\n   175→            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n   176→            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n   177→            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n   178→        });\n   179→    });\n   180→\n   181→    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n   182→        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n   183→            // Listado de empresas\n   184→            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n   185→            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n   186→            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n   187→            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n   188→            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n   189→            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n   190→            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n   191→            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n   192→            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n   193→            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n   194→            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n   195→            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n   196→            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n   197→            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n   198→            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n   199→        });\n   200→\n   201→        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n   202→            // Gestionar empresas\n   203→            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n   204→            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n   205→            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n   206→            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n   207→\n   208→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n   209→                // Usuarios\n   210→                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n   211→                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n   212→            });\n   213→\n   214→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n   215→                // Planes\n   216→                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n   217→                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n   218→            });\n   219→        });\n   220→\n   221→        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n   222→            // Archivo de empresas\n   223→            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n   224→            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n   225→            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n   226→        });\n   227→\n   228→        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n   229→            // Migración de empresas\n   230→            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n   231→            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n   232→            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n   233→            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n   234→        });\n   235→\n   236→        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n   237→            // Portales de empleo\n   238→            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   239→            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   240→            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n   241→            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n   242→\n   243→            // Premios destacados\n   244→            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n   245→            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n   246→\n   247→            // Motivadores\n   248→            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n   249→        });\n   250→\n   251→        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n   252→        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n   253→        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n   254→    });\n   255→\n   256→    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n   257→        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n   258→        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n   259→        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n   260→        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n   261→    });\n   262→\n   263→    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n   264→        // Planes\n   265→        $ruta->resource('planes', 'Planes\\PlanController');\n   266→        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n   267→        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n   268→        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n   269→        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n   270→        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n   271→        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n   272→        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n   273→        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n   274→        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n   275→        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n   276→        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n   277→        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n   278→        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n   279→        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n   280→        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n   281→\n   282→        // Planes de Créditos - Vista de creación\n   283→        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n   284→        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   285→        $ruta->get('servicios-ia/{id}/creditos', 'IA\\ServicioIAController@creditos');\n   286→        $ruta->post('servicios-ia/{id}/activar', 'IA\\ServicioIAController@activar');\n   287→        $ruta->post('servicios-ia/{id}/desactivar', 'IA\\ServicioIAController@desactivar');\n   288→        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n   289→        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n   290→        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   291→\n   292→        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n   293→            // Consumos\n   294→            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n   295→            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n   296→            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n   297→            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n   298→            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n   299→            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n   300→            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n   301→            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n   302→            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n   303→            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n   304→            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n   305→            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n   306→            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n   307→        });\n   308→\n   309→        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n   310→            // Archivo\n   311→            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n   312→            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n   313→        });\n   314→    });\n   315→\n   316→    // Perfiles laborales\n   317→    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n   318→    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n   319→    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n   320→    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n   321→\n   322→    // Preguntas de ofertas laborales\n   323→    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n   324→    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n   325→    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n   326→    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n   327→    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n   328→    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n   329→\n   330→    // Preguntas de videoentrevista\n   331→    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n   332→    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n   333→    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n   334→    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n   335→\n   336→    // Vacantes\n   337→    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n   338→    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n   339→    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n   340→    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n   341→    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n   342→    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n   343→    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n   344→    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n   345→    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n   346→    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n   347→    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n   348→    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n   349→\n   350→    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n   351→\n   352→    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n   353→    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n   354→\n   355→    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n   356→        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n   357→            // Ajustes - General\n   358→            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n   359→        });\n   360→\n   361→        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n   362→            // Ajustes - Roles y permisos\n   363→            $ruta->get('roles', 'Auth\\RolController@index');\n   364→        });\n   365→\n   366→        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n   367→            // Ajustes - Deshacer acciones\n   368→            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n   369→            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n   370→            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n   371→            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n   372→        });\n   373→\n   374→        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n   375→            // Ajustes - Ofertas y anuncios\n   376→            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n   377→            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n   378→            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n   379→            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n   380→            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n   381→        });\n   382→\n   383→        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n   384→            // Webinars\n   385→            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n   386→            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n   387→            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n   388→            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n   389→            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n   390→            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n   391→\n   392→            // Eventos\n   393→            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n   394→            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n   395→            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n   396→            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n   397→            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n   398→            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n   399→\n   400→            // Guías\n   401→            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n   402→            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n   403→            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n   404→            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n   405→            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n   406→            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n   407→\n   408→            // Tutoriales\n   409→            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n   410→            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n   411→            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n   412→            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n   413→            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n   414→\n   415→            // Podcast\n   416→            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n   417→            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n   418→            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n   419→            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n   420→            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n   421→\n   422→            // Capacitación\n   423→            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n   424→            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n   425→            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n   426→            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n   427→            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n   428→\n   429→            // Certificación\n   430→            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n   431→            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n   432→            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n   433→            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n   434→            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n   435→            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n   436→        });\n   437→    });\n   438→\n   439→    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n   440→        // Soportes\n   441→        $ruta->resource('soportes', 'Soportes\\SoporteController');\n   442→        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n   443→        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n   444→        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n   445→        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n   446→        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n   447→        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n   448→        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n   449→        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n   450→        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n   451→\n   452→        // Manuales\n   453→        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n   454→        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n   455→\n   456→        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n   457→            // Aplicantes\n   458→            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n   459→        });\n   460→\n   461→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n   462→            // Preguntas frecuentes\n   463→            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n   464→            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n   465→            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n   466→            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n   467→            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n   468→        });\n   469→\n   470→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n   471→            // Preguntas frecuentes reacciónes\n   472→            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n   473→        });\n   474→    });\n   475→\n   476→    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n   477→    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n   478→    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n   479→\n   480→    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n   481→        // Módulos\n   482→        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n   483→        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n   484→\n   485→        // Auditorías\n   486→        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n   487→\n   488→        // Accesos\n   489→        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n   490→\n   491→        // Registros de actividad\n   492→        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n   493→\n   494→        // Novedades\n   495→        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n   496→        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n   497→        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n   498→\n   499→        // Países\n   500→        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n   501→        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n   502→        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n   503→        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n   504→        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n   505→\n   506→        // Reportes\n   507→        $ruta->resource('reportes', 'Reportes\\ReporteController');\n   508→        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n   509→        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n   510→\n   511→        // Minería de datos.\n   512→        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n   513→        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n   514→\n   515→        // Pruebas completas\n   516→        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n   517→        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n   518→        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n   519→        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n   520→        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n   521→    });\n   522→\n   523→    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n   524→        // Ordenes de servicio\n   525→        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n   526→        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n   527→        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n   528→\n   529→        // Ofertas laborales\n   530→        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n   531→        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n   532→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n   533→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n   534→        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n   535→        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n   536→        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n   537→        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n   538→        ->name('sin-disponibilidad-ofertas-laborales');\n   539→        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n   540→        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n   541→        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n   542→        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n   543→        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n   544→        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n   545→        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n   546→\n   547→        // Vacantes\n   548→        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n   549→        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n   550→\n   551→        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n   552→            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n   553→            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n   554→            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n   555→            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n   556→            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n   557→            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n   558→            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n   559→            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n   560→            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n   561→        });\n   562→\n   563→        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n   564→        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n   565→        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n   566→        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n   567→        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n   568→        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n   569→        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n   570→        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n   571→        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n   572→        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n   573→        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n   574→        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n   575→        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n   576→        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n   577→        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n   578→        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n   579→        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n   580→        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n   581→        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n   582→        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n   583→        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n   584→        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n   585→\n   586→        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n   587→        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n   588→        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n   589→\n   590→        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n   591→        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n   592→        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n   593→\n   594→        // Etapas\n   595→        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n   596→        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n   597→        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n   598→        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n   599→        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n   600→        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n   601→\n   602→        // Movimientos\n   603→        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n   604→        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n   605→        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n   606→        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n   607→\n   608→        // Novedades\n   609→        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n   610→\n   611→        $ruta->get('feedback', 'DashboardController@enConstruccion');\n   612→        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n   613→\n   614→        // Procesos\n   615→        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n   616→        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n   617→        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n   618→        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n   619→        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n   620→        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n   621→        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n   622→        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n   623→        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n   624→        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n   625→        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n   626→        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n   627→        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n   628→        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n   629→        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n   630→        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n   631→        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n   632→        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n   633→        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n   634→        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n   635→        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n   636→        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n   637→        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n   638→        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n   639→        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n   640→        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n   641→        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n   642→        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n   643→        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n   644→        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n   645→        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n   646→        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n   647→\n   648→        // Firmas de rutas\n   649→        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n   650→\n   651→        // Perfiles pruebas\n   652→        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n   653→\n   654→        // Agendas\n   655→        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n   656→        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n   657→        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n   658→        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n   659→\n   660→        // Comentarios\n   661→        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n   662→\n   663→        // Usuarios\n   664→        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n   665→    });\n   666→\n   667→    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n   668→        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n   669→\n   670→        // Debug de calificaciones de agendas\n   671→        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n   672→        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n   673→        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n   674→        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n   675→    });\n   676→\n   677→    // Suplantación de rol Administrador general\n   678→    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n   679→        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n   680→    });\n   681→\n   682→    // Suplantación de rol Administrador sucursal\n   683→    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n   684→        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n   685→    });\n   686→\n   687→    // Restablecimiento de la sesión original que había antes de la suplantación\n   688→    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n   689→        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n   690→    });\n   691→\n   692→    // Ruta para completar los datos de un usuario aplicante\n   693→    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n   694→        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n   695→        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n   696→        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n   697→        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n   698→    });\n   699→\n   700→    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n   701→    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n   702→        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n   703→        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n   704→        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n   705→        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n   706→        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n   707→        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n   708→        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n   709→        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n   710→        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n   711→        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n   712→        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n   713→        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n   714→        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n   715→        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n   716→        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n   717→        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n   718→        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n   719→        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n   720→        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n   721→        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   722→        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n   723→            ->name('ofertas-laborales.detalles-aplicante');\n   724→        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   725→        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n   726→\n   727→        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n   728→    });\n   729→\n   730→    // Ofertas laborales\n   731→    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n   732→\n   733→    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n   734→    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n   735→    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n   736→    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n   737→    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n   738→    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n   739→    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n   740→\n   741→    // Usuarios\n   742→    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n   743→    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n   744→\n   745→    // Perfiles\n   746→    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n   747→    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n   748→    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n   749→    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n   750→    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n   751→\n   752→    // Archivos\n   753→    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n   754→    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n   755→    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n   756→\n   757→    // Menú clientes\n   758→    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n   759→    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n   760→    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n   761→\n   762→    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n   763→    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n   764→    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n   765→    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n   766→    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n   767→\n   768→    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n   769→    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n   770→    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n   771→    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n   772→    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n   773→    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n   774→    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n   775→    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n   776→    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n   777→\n   778→    // Agendas - Accesible para aplicantes y usuarios de empresa\n   779→    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n   780→\n   781→    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n   782→    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n   783→    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n   784→    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n   785→    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n   786→\n   787→    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n   788→    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n   789→\n   790→    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n   791→    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n   792→    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n   793→\n   794→    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n   795→    $ruta->get('novedades', 'DashboardController@enConstruccion');\n   796→\n   797→    // Áreas\n   798→    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n   799→    $ruta->post('areas', 'Empresas\\AreaController@store');\n   800→\n   801→    // Cargos\n   802→    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n   803→    $ruta->post('cargos', 'Empresas\\CargoController@store');\n   804→\n   805→    // Niveles educativos\n   806→    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n   807→\n   808→    // Áreas de estudio\n   809→    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n   810→\n   811→    // Idiomas\n   812→    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n   813→\n   814→    // Autenticación del websoket\n   815→    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n   816→\n   817→    $ruta->get('/botones', function () {\n   818→        return view('botones');\n   819→    })->name('botones');\n   820→\n   821→    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n   822→    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n   823→    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n   824→\n   825→    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n   826→    $ruta->get('analiticas', 'DashboardController@index');\n   827→    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n   828→    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n   829→    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n   830→    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n   831→    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n   832→\n   833→    // Rutas de componentes de desarrollo\n   834→    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n   835→    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n   836→\n   837→    // TODO: ruta de prueba, eliminarla próximamente\n   838→    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n   839→    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n   840→    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n   841→    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n   842→    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n   843→\n   844→    // Rutas para las encuestas\n   845→    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n   846→    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n   847→});\n   848→\n   849→// Rutas no protegidas por autenticación\n   850→Route::group([\n   851→    'namespace' => 'App\\Http\\Controllers'\n   852→], function ($ruta) {\n   853→    // Contraseñas\n   854→    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n   855→\n   856→    // Empresas\n   857→    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n   858→    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n   859→    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n   860→    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n   861→    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n   862→\n   863→    // Ordenes de servicio\n   864→    $ruta->group([\n   865→        'middleware' => 'orden-servicio-enlace-publico'\n   866→    ], function ($ruta) {\n   867→        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n   868→        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n   869→    });\n   870→\n   871→    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n   872→\n   873→    // Países\n   874→    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n   875→    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n   876→\n   877→    // Departamentos\n   878→    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n   879→\n   880→    // Ciudades\n   881→    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n   882→\n   883→    // Portales de empleo\n   884→    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n   885→    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n   886→    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n   887→    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n   888→    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n   889→    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n   890→    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n   891→\n   892→    // Firmas de rutas\n   893→    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n   894→    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n   895→    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n   896→    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n   897→\n   898→    // Archivos\n   899→    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n   900→\n   901→    // Imagen de usuarios\n   902→    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n   903→\n   904→    // Consultar reportes con firma\n   905→    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n   906→});\n   907→\n   908→/**\n   909→ * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n   910→ *\n   911→ * @author Fahibram Cárcamo\n   912→ */\n   913→Route::group([\n   914→    'prefix'     => 'rutas-firmadas',\n   915→    'middleware' => ['ruta-firmada'],\n   916→    'namespace'  => 'App\\Http\\Controllers'\n   917→], function ($ruta) {\n   918→    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n   919→    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n   920→});\n   921→\n   922→/**\n   923→ * Genera un token SSO firmado y redirige a WordPress.\n   924→ *\n   925→ * Flujo:\n   926→ *  - Requiere un usuario autenticado (será el admin en WP).\n   927→ *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n   928→ *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n   929→ *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n   930→ *  - Redirige al callback configurado en WordPress.\n   931→ *\n   932→ * @author Sergio Vargas\n   933→ */\n   934→Route::get('/sso/wordpress', function (Request $request) {\n   935→    $user = $request->user();\n   936→\n   937→    $studentId   = $request->input('student_id');\n   938→    $studentData = null;\n   939→\n   940→    if ($studentId) {\n   941→        $student = App\\Models\\Usuarios\\User::find($studentId);\n   942→\n   943→        if ($student && $student->id !== $user->id) {\n   944→            $studentData = [\n   945→                'id'    => (string) $student->id,\n   946→                'email' => $student->email,\n   947→                'name'  => $student->getNombreCompletoAttribute(),\n   948→            ];\n   949→        }\n   950→    }\n   951→\n   952→    $nonce = (string) Str::uuid();\n   953→    $exp   = now()->addSeconds(60)->timestamp;\n   954→\n   955→    Cache::put(\"sso_nonce:{$nonce}\", [\n   956→        'user_id' => $user->id,\n   957→        'exp'     => $exp,\n   958→    ], now()->addMinutes(5));\n   959→\n   960→    $payload = [\n   961→        'sub'     => (string) $user->id,\n   962→        'email'   => $user->email,\n   963→        'name'    => $user->getNombreCompletoAttribute(),\n   964→        'nonce'   => $nonce,\n   965→        'exp'     => $exp,\n   966→        'student' => $studentData,\n   967→    ];\n   968→\n   969→    $token    = sso_sign_token($payload, config('services.sso.secret'));\n   970→    $wp       = rtrim(config('services.sso.wp_url'), '/');\n   971→    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n   972→    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n   973→\n   974→    return redirect()->away(\n   975→        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n   976→    );\n   977→})->middleware('auth');\n   978→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0d63123c-dd15-46dd-92b9-7e3cd5adfee3","timestamp":"2026-01-22T21:24:05.464Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:09.346Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SA2xTvsNGQ23frcfK7XrXY","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I found the issue. Let me search for the specific route that defines \"consumo\" to get the complete picture:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":26989,"cache_read_input_tokens":20556,"cache_creation":{"ephemeral_5m_input_tokens":26989,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xhjdgDtXxm22f61pY","uuid":"b44d95cc-38e0-487b-8b3a-27bed60f9c4d"},{"type":"assistant","timestamp":"2026-01-22T21:24:09.976Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SA2xTvsNGQ23frcfK7XrXY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016g2xruZ8G5Dys2yYXu7i26","name":"Grep","input":{"pattern":"consumo|paginaConsumos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":26989,"cache_read_input_tokens":20556,"cache_creation":{"ephemeral_5m_input_tokens":26989,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xhjdgDtXxm22f61pY","uuid":"7eebb30e-4213-4d4d-a287-365923b81b56"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016g2xruZ8G5Dys2yYXu7i26","type":"tool_result","content":"263:    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n289:        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n292:        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n294:            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n301:            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n302:            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n303:            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n304:            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n305:            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n306:            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n309:        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n790:    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');"}]},"uuid":"d3d1bfc1-4909-4741-925b-8cab40aca188","timestamp":"2026-01-22T21:24:11.814Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:13.649Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01V1NcYL3qEMX8XcXWmfrVdL","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check if there's a specific route for \"planes/consumo\" by looking more carefully at the resource routes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":666,"cache_read_input_tokens":47545,"cache_creation":{"ephemeral_5m_input_tokens":666,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7yAEaN1LLkXjF54HAd","uuid":"4ea86469-a7f7-4826-9474-8466918ed7db"},{"type":"assistant","timestamp":"2026-01-22T21:24:14.305Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01V1NcYL3qEMX8XcXWmfrVdL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015khCdCsSmUe5cZu22Hpnje","name":"Bash","input":{"command":"grep -n \"resource.*planes\\|get.*planes.*consumo\\|consumo\" \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php\" | head -30"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":666,"cache_read_input_tokens":47545,"cache_creation":{"ephemeral_5m_input_tokens":666,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7yAEaN1LLkXjF54HAd","uuid":"336baa12-25b9-42bb-9a95-2d1c1a23fb73"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"d09a5b8f-2afe-4f65-b328-c03c0d72e074","timestamp":"2026-01-22T21:24:14.345Z"}
{"parentUuid":"d09a5b8f-2afe-4f65-b328-c03c0d72e074","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015khCdCsSmUe5cZu22Hpnje","type":"tool_result","content":"263:    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n265:        $ruta->resource('planes', 'Planes\\PlanController');\n271:        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n283:        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n289:        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n292:        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n294:            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n301:            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n302:            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n303:            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n304:            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n305:            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n306:            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n309:        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n790:    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');","is_error":false}]},"uuid":"8e2c9aaa-dd09-4773-b2c5-fca69fe3ee23","timestamp":"2026-01-22T21:24:15.585Z"},"normalizedMessages":[{"type":"assistant","timestamp":"2026-01-22T21:23:51.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you understand this routing issue. Let me search for the PlanController and route definitions."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"dbaf716d-275e-48fa-acbf-69e89a2b9fe2"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.562Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUgQii42KiQ94SnWfGBsqU","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"c9861168-12fd-4b57-ae6a-5a8deaa5c529"},{"type":"assistant","timestamp":"2026-01-22T21:23:52.703Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017aPvpPevjvFVVXgb6FYUb8","name":"Glob","input":{"pattern":"routes/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"bb961623-2223-461e-9f0c-ee413fc71e68"},{"type":"assistant","timestamp":"2026-01-22T21:23:53.055Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P9sHeFmAYJJ71XDzpR6SEn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","name":"Grep","input":{"pattern":"planes|consumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","type":"php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14694,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14694,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7wY99NFWJyjccqokry","uuid":"34307804-5a54-4ae0-96ec-6aabf5fe333b"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUgQii42KiQ94SnWfGBsqU","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"49efb63e-1db2-4a30-b762-a1bc0e161a63","timestamp":"2026-01-22T21:24:00.232Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0156Tf8tkyMrQHLHD1XovjuP","type":"tool_result","content":"Found 1 file\nroutes\\web.php"}]},"uuid":"bed09402-ca75-40ed-940c-7bcba7238d26","timestamp":"2026-01-22T21:24:00.948Z"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017aPvpPevjvFVVXgb6FYUb8","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}]},"uuid":"03e0e5f6-0d67-46e7-9561-d0165f67a45c","timestamp":"2026-01-22T21:24:02.117Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:03.832Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read the web.php file to see the route definitions:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"5c2e8c9f-717a-4a43-9361-8cfe4a8d6b2e"},{"type":"assistant","timestamp":"2026-01-22T21:24:04.026Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SNuruVXfxmJY56W8kMPddy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013MFvRHDwM8TB7iobMzEr8g","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":42,"cache_creation_input_tokens":5862,"cache_read_input_tokens":14694,"cache_creation":{"ephemeral_5m_input_tokens":5862,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xTJiL6jgSMTkwJBML","uuid":"77eed9db-6d09-4fc5-b43b-bbe57f5ba88c"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013MFvRHDwM8TB7iobMzEr8g","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Str;\n     4→use Illuminate\\Http\\Request;\n     5→use Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n     6→\n     7→Route::get('/', function () {\n     8→    return redirect()->route('login');\n     9→});\n    10→\n    11→Auth::routes(['register' => false]);\n    12→\n    13→// Rutas de acceso para aplicante.\n    14→Route::group([\n    15→    'prefix'    => 'control-acceso',\n    16→    'namespace' => 'App\\Http\\Controllers\\Auth'\n    17→], function ($ruta) {\n    18→    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    19→    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    20→    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n    21→});\n    22→\n    23→// Rutas de migración de usuarios desde la base de datos antigua.\n    24→Route::group([\n    25→    'prefix'    => 'migrar-usuario-app-antigua',\n    26→    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n    27→], function ($ruta) {\n    28→    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    29→    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n    30→});\n    31→\n    32→// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\n    33→Route::group([\n    34→    'prefix'     => 'rol-empresa',\n    35→    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    36→    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n    37→], function ($ruta) {\n    38→    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    39→    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n    40→});\n    41→\n    42→// Rutas protegidas por autenticación y selección de rol y empresa.\n    43→Route::group([\n    44→    'middleware' => ['auth', 'auth.rol-empresa'],\n    45→    'namespace'  => 'App\\Http\\Controllers'\n    46→], function ($ruta) {\n    47→    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n    48→\n    49→    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n    50→        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n    51→        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n    52→\n    53→        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n    54→            // Usuarios\n    55→            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n    56→            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n    57→            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n    58→            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n    59→            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n    60→            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n    61→            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n    62→            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n    63→            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n    64→            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n    65→            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n    66→            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n    67→            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n    68→            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n    69→\n    70→            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n    71→            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n    72→            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n    73→        });\n    74→    });\n    75→\n    76→    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n    77→        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n    78→            // Pruebas\n    79→            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n    80→            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n    81→            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n    82→            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n    83→            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n    84→            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n    85→            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n    86→            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n    87→        });\n    88→\n    89→        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n    90→            // Carga masiva de pruebas\n    91→            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n    92→            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n    93→            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n    94→            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n    95→        });\n    96→\n    97→        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n    98→            // Baremos\n    99→            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n   100→            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n   101→            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n   102→            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n   103→        });\n   104→\n   105→        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n   106→            // Dimensiones\n   107→            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n   108→            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n   109→            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n   110→            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n   111→            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n   112→        });\n   113→\n   114→        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n   115→            // Factores\n   116→            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n   117→            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n   118→            $ruta->resource('factores', 'Pruebas\\FactorController');\n   119→            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n   120→        });\n   121→\n   122→        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n   123→            // Reactivos\n   124→            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n   125→            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n   126→            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n   127→\n   128→            // Opciones\n   129→            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n   130→        });\n   131→\n   132→        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n   133→            // Calificaciones\n   134→            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n   135→            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n   136→            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n   137→        });\n   138→\n   139→        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n   140→            // Grupos de opciones\n   141→            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n   142→            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n   143→            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n   144→        });\n   145→\n   146→        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n   147→            // Secciones de texto\n   148→            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n   149→            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n   150→            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n   151→        });\n   152→\n   153→        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n   154→    });\n   155→\n   156→    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n   157→        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n   158→            // Perfiles\n   159→            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n   160→            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n   161→            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n   162→        });\n   163→\n   164→        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n   165→            // Módulos de preguntas\n   166→            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n   167→            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n   168→            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n   169→            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n   170→            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n   171→        });\n   172→\n   173→        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n   174→            // Demográficas\n   175→            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n   176→            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n   177→            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n   178→        });\n   179→    });\n   180→\n   181→    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n   182→        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n   183→            // Listado de empresas\n   184→            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n   185→            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n   186→            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n   187→            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n   188→            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n   189→            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n   190→            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n   191→            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n   192→            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n   193→            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n   194→            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n   195→            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n   196→            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n   197→            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n   198→            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n   199→        });\n   200→\n   201→        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n   202→            // Gestionar empresas\n   203→            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n   204→            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n   205→            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n   206→            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n   207→\n   208→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n   209→                // Usuarios\n   210→                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n   211→                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n   212→            });\n   213→\n   214→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n   215→                // Planes\n   216→                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n   217→                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n   218→            });\n   219→        });\n   220→\n   221→        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n   222→            // Archivo de empresas\n   223→            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n   224→            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n   225→            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n   226→        });\n   227→\n   228→        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n   229→            // Migración de empresas\n   230→            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n   231→            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n   232→            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n   233→            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n   234→        });\n   235→\n   236→        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n   237→            // Portales de empleo\n   238→            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   239→            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   240→            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n   241→            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n   242→\n   243→            // Premios destacados\n   244→            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n   245→            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n   246→\n   247→            // Motivadores\n   248→            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n   249→        });\n   250→\n   251→        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n   252→        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n   253→        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n   254→    });\n   255→\n   256→    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n   257→        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n   258→        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n   259→        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n   260→        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n   261→    });\n   262→\n   263→    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n   264→        // Planes\n   265→        $ruta->resource('planes', 'Planes\\PlanController');\n   266→        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n   267→        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n   268→        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n   269→        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n   270→        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n   271→        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n   272→        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n   273→        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n   274→        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n   275→        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n   276→        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n   277→        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n   278→        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n   279→        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n   280→        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n   281→\n   282→        // Planes de Créditos - Vista de creación\n   283→        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n   284→        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   285→        $ruta->get('servicios-ia/{id}/creditos', 'IA\\ServicioIAController@creditos');\n   286→        $ruta->post('servicios-ia/{id}/activar', 'IA\\ServicioIAController@activar');\n   287→        $ruta->post('servicios-ia/{id}/desactivar', 'IA\\ServicioIAController@desactivar');\n   288→        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n   289→        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n   290→        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   291→\n   292→        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n   293→            // Consumos\n   294→            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n   295→            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n   296→            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n   297→            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n   298→            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n   299→            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n   300→            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n   301→            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n   302→            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n   303→            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n   304→            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n   305→            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n   306→            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n   307→        });\n   308→\n   309→        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n   310→            // Archivo\n   311→            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n   312→            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n   313→        });\n   314→    });\n   315→\n   316→    // Perfiles laborales\n   317→    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n   318→    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n   319→    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n   320→    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n   321→\n   322→    // Preguntas de ofertas laborales\n   323→    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n   324→    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n   325→    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n   326→    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n   327→    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n   328→    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n   329→\n   330→    // Preguntas de videoentrevista\n   331→    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n   332→    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n   333→    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n   334→    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n   335→\n   336→    // Vacantes\n   337→    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n   338→    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n   339→    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n   340→    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n   341→    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n   342→    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n   343→    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n   344→    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n   345→    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n   346→    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n   347→    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n   348→    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n   349→\n   350→    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n   351→\n   352→    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n   353→    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n   354→\n   355→    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n   356→        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n   357→            // Ajustes - General\n   358→            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n   359→        });\n   360→\n   361→        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n   362→            // Ajustes - Roles y permisos\n   363→            $ruta->get('roles', 'Auth\\RolController@index');\n   364→        });\n   365→\n   366→        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n   367→            // Ajustes - Deshacer acciones\n   368→            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n   369→            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n   370→            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n   371→            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n   372→        });\n   373→\n   374→        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n   375→            // Ajustes - Ofertas y anuncios\n   376→            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n   377→            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n   378→            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n   379→            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n   380→            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n   381→        });\n   382→\n   383→        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n   384→            // Webinars\n   385→            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n   386→            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n   387→            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n   388→            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n   389→            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n   390→            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n   391→\n   392→            // Eventos\n   393→            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n   394→            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n   395→            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n   396→            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n   397→            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n   398→            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n   399→\n   400→            // Guías\n   401→            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n   402→            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n   403→            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n   404→            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n   405→            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n   406→            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n   407→\n   408→            // Tutoriales\n   409→            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n   410→            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n   411→            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n   412→            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n   413→            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n   414→\n   415→            // Podcast\n   416→            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n   417→            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n   418→            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n   419→            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n   420→            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n   421→\n   422→            // Capacitación\n   423→            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n   424→            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n   425→            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n   426→            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n   427→            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n   428→\n   429→            // Certificación\n   430→            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n   431→            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n   432→            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n   433→            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n   434→            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n   435→            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n   436→        });\n   437→    });\n   438→\n   439→    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n   440→        // Soportes\n   441→        $ruta->resource('soportes', 'Soportes\\SoporteController');\n   442→        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n   443→        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n   444→        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n   445→        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n   446→        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n   447→        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n   448→        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n   449→        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n   450→        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n   451→\n   452→        // Manuales\n   453→        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n   454→        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n   455→\n   456→        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n   457→            // Aplicantes\n   458→            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n   459→        });\n   460→\n   461→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n   462→            // Preguntas frecuentes\n   463→            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n   464→            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n   465→            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n   466→            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n   467→            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n   468→        });\n   469→\n   470→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n   471→            // Preguntas frecuentes reacciónes\n   472→            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n   473→        });\n   474→    });\n   475→\n   476→    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n   477→    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n   478→    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n   479→\n   480→    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n   481→        // Módulos\n   482→        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n   483→        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n   484→\n   485→        // Auditorías\n   486→        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n   487→\n   488→        // Accesos\n   489→        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n   490→\n   491→        // Registros de actividad\n   492→        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n   493→\n   494→        // Novedades\n   495→        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n   496→        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n   497→        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n   498→\n   499→        // Países\n   500→        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n   501→        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n   502→        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n   503→        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n   504→        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n   505→\n   506→        // Reportes\n   507→        $ruta->resource('reportes', 'Reportes\\ReporteController');\n   508→        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n   509→        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n   510→\n   511→        // Minería de datos.\n   512→        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n   513→        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n   514→\n   515→        // Pruebas completas\n   516→        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n   517→        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n   518→        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n   519→        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n   520→        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n   521→    });\n   522→\n   523→    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n   524→        // Ordenes de servicio\n   525→        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n   526→        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n   527→        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n   528→\n   529→        // Ofertas laborales\n   530→        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n   531→        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n   532→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n   533→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n   534→        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n   535→        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n   536→        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n   537→        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n   538→        ->name('sin-disponibilidad-ofertas-laborales');\n   539→        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n   540→        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n   541→        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n   542→        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n   543→        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n   544→        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n   545→        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n   546→\n   547→        // Vacantes\n   548→        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n   549→        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n   550→\n   551→        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n   552→            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n   553→            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n   554→            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n   555→            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n   556→            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n   557→            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n   558→            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n   559→            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n   560→            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n   561→        });\n   562→\n   563→        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n   564→        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n   565→        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n   566→        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n   567→        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n   568→        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n   569→        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n   570→        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n   571→        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n   572→        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n   573→        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n   574→        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n   575→        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n   576→        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n   577→        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n   578→        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n   579→        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n   580→        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n   581→        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n   582→        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n   583→        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n   584→        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n   585→\n   586→        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n   587→        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n   588→        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n   589→\n   590→        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n   591→        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n   592→        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n   593→\n   594→        // Etapas\n   595→        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n   596→        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n   597→        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n   598→        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n   599→        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n   600→        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n   601→\n   602→        // Movimientos\n   603→        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n   604→        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n   605→        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n   606→        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n   607→\n   608→        // Novedades\n   609→        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n   610→\n   611→        $ruta->get('feedback', 'DashboardController@enConstruccion');\n   612→        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n   613→\n   614→        // Procesos\n   615→        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n   616→        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n   617→        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n   618→        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n   619→        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n   620→        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n   621→        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n   622→        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n   623→        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n   624→        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n   625→        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n   626→        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n   627→        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n   628→        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n   629→        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n   630→        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n   631→        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n   632→        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n   633→        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n   634→        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n   635→        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n   636→        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n   637→        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n   638→        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n   639→        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n   640→        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n   641→        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n   642→        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n   643→        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n   644→        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n   645→        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n   646→        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n   647→\n   648→        // Firmas de rutas\n   649→        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n   650→\n   651→        // Perfiles pruebas\n   652→        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n   653→\n   654→        // Agendas\n   655→        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n   656→        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n   657→        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n   658→        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n   659→\n   660→        // Comentarios\n   661→        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n   662→\n   663→        // Usuarios\n   664→        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n   665→    });\n   666→\n   667→    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n   668→        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n   669→\n   670→        // Debug de calificaciones de agendas\n   671→        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n   672→        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n   673→        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n   674→        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n   675→    });\n   676→\n   677→    // Suplantación de rol Administrador general\n   678→    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n   679→        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n   680→    });\n   681→\n   682→    // Suplantación de rol Administrador sucursal\n   683→    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n   684→        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n   685→    });\n   686→\n   687→    // Restablecimiento de la sesión original que había antes de la suplantación\n   688→    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n   689→        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n   690→    });\n   691→\n   692→    // Ruta para completar los datos de un usuario aplicante\n   693→    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n   694→        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n   695→        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n   696→        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n   697→        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n   698→    });\n   699→\n   700→    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n   701→    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n   702→        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n   703→        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n   704→        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n   705→        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n   706→        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n   707→        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n   708→        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n   709→        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n   710→        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n   711→        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n   712→        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n   713→        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n   714→        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n   715→        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n   716→        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n   717→        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n   718→        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n   719→        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n   720→        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n   721→        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   722→        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n   723→            ->name('ofertas-laborales.detalles-aplicante');\n   724→        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   725→        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n   726→\n   727→        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n   728→    });\n   729→\n   730→    // Ofertas laborales\n   731→    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n   732→\n   733→    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n   734→    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n   735→    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n   736→    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n   737→    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n   738→    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n   739→    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n   740→\n   741→    // Usuarios\n   742→    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n   743→    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n   744→\n   745→    // Perfiles\n   746→    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n   747→    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n   748→    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n   749→    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n   750→    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n   751→\n   752→    // Archivos\n   753→    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n   754→    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n   755→    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n   756→\n   757→    // Menú clientes\n   758→    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n   759→    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n   760→    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n   761→\n   762→    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n   763→    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n   764→    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n   765→    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n   766→    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n   767→\n   768→    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n   769→    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n   770→    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n   771→    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n   772→    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n   773→    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n   774→    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n   775→    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n   776→    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n   777→\n   778→    // Agendas - Accesible para aplicantes y usuarios de empresa\n   779→    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n   780→\n   781→    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n   782→    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n   783→    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n   784→    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n   785→    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n   786→\n   787→    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n   788→    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n   789→\n   790→    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n   791→    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n   792→    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n   793→\n   794→    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n   795→    $ruta->get('novedades', 'DashboardController@enConstruccion');\n   796→\n   797→    // Áreas\n   798→    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n   799→    $ruta->post('areas', 'Empresas\\AreaController@store');\n   800→\n   801→    // Cargos\n   802→    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n   803→    $ruta->post('cargos', 'Empresas\\CargoController@store');\n   804→\n   805→    // Niveles educativos\n   806→    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n   807→\n   808→    // Áreas de estudio\n   809→    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n   810→\n   811→    // Idiomas\n   812→    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n   813→\n   814→    // Autenticación del websoket\n   815→    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n   816→\n   817→    $ruta->get('/botones', function () {\n   818→        return view('botones');\n   819→    })->name('botones');\n   820→\n   821→    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n   822→    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n   823→    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n   824→\n   825→    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n   826→    $ruta->get('analiticas', 'DashboardController@index');\n   827→    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n   828→    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n   829→    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n   830→    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n   831→    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n   832→\n   833→    // Rutas de componentes de desarrollo\n   834→    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n   835→    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n   836→\n   837→    // TODO: ruta de prueba, eliminarla próximamente\n   838→    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n   839→    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n   840→    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n   841→    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n   842→    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n   843→\n   844→    // Rutas para las encuestas\n   845→    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n   846→    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n   847→});\n   848→\n   849→// Rutas no protegidas por autenticación\n   850→Route::group([\n   851→    'namespace' => 'App\\Http\\Controllers'\n   852→], function ($ruta) {\n   853→    // Contraseñas\n   854→    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n   855→\n   856→    // Empresas\n   857→    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n   858→    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n   859→    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n   860→    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n   861→    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n   862→\n   863→    // Ordenes de servicio\n   864→    $ruta->group([\n   865→        'middleware' => 'orden-servicio-enlace-publico'\n   866→    ], function ($ruta) {\n   867→        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n   868→        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n   869→    });\n   870→\n   871→    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n   872→\n   873→    // Países\n   874→    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n   875→    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n   876→\n   877→    // Departamentos\n   878→    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n   879→\n   880→    // Ciudades\n   881→    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n   882→\n   883→    // Portales de empleo\n   884→    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n   885→    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n   886→    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n   887→    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n   888→    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n   889→    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n   890→    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n   891→\n   892→    // Firmas de rutas\n   893→    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n   894→    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n   895→    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n   896→    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n   897→\n   898→    // Archivos\n   899→    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n   900→\n   901→    // Imagen de usuarios\n   902→    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n   903→\n   904→    // Consultar reportes con firma\n   905→    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n   906→});\n   907→\n   908→/**\n   909→ * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n   910→ *\n   911→ * @author Fahibram Cárcamo\n   912→ */\n   913→Route::group([\n   914→    'prefix'     => 'rutas-firmadas',\n   915→    'middleware' => ['ruta-firmada'],\n   916→    'namespace'  => 'App\\Http\\Controllers'\n   917→], function ($ruta) {\n   918→    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n   919→    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n   920→});\n   921→\n   922→/**\n   923→ * Genera un token SSO firmado y redirige a WordPress.\n   924→ *\n   925→ * Flujo:\n   926→ *  - Requiere un usuario autenticado (será el admin en WP).\n   927→ *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n   928→ *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n   929→ *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n   930→ *  - Redirige al callback configurado en WordPress.\n   931→ *\n   932→ * @author Sergio Vargas\n   933→ */\n   934→Route::get('/sso/wordpress', function (Request $request) {\n   935→    $user = $request->user();\n   936→\n   937→    $studentId   = $request->input('student_id');\n   938→    $studentData = null;\n   939→\n   940→    if ($studentId) {\n   941→        $student = App\\Models\\Usuarios\\User::find($studentId);\n   942→\n   943→        if ($student && $student->id !== $user->id) {\n   944→            $studentData = [\n   945→                'id'    => (string) $student->id,\n   946→                'email' => $student->email,\n   947→                'name'  => $student->getNombreCompletoAttribute(),\n   948→            ];\n   949→        }\n   950→    }\n   951→\n   952→    $nonce = (string) Str::uuid();\n   953→    $exp   = now()->addSeconds(60)->timestamp;\n   954→\n   955→    Cache::put(\"sso_nonce:{$nonce}\", [\n   956→        'user_id' => $user->id,\n   957→        'exp'     => $exp,\n   958→    ], now()->addMinutes(5));\n   959→\n   960→    $payload = [\n   961→        'sub'     => (string) $user->id,\n   962→        'email'   => $user->email,\n   963→        'name'    => $user->getNombreCompletoAttribute(),\n   964→        'nonce'   => $nonce,\n   965→        'exp'     => $exp,\n   966→        'student' => $studentData,\n   967→    ];\n   968→\n   969→    $token    = sso_sign_token($payload, config('services.sso.secret'));\n   970→    $wp       = rtrim(config('services.sso.wp_url'), '/');\n   971→    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n   972→    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n   973→\n   974→    return redirect()->away(\n   975→        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n   976→    );\n   977→})->middleware('auth');\n   978→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0d63123c-dd15-46dd-92b9-7e3cd5adfee3","timestamp":"2026-01-22T21:24:05.464Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:09.346Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SA2xTvsNGQ23frcfK7XrXY","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I found the issue. Let me search for the specific route that defines \"consumo\" to get the complete picture:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":26989,"cache_read_input_tokens":20556,"cache_creation":{"ephemeral_5m_input_tokens":26989,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xhjdgDtXxm22f61pY","uuid":"b44d95cc-38e0-487b-8b3a-27bed60f9c4d"},{"type":"assistant","timestamp":"2026-01-22T21:24:09.976Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SA2xTvsNGQ23frcfK7XrXY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016g2xruZ8G5Dys2yYXu7i26","name":"Grep","input":{"pattern":"consumo|paginaConsumos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":26989,"cache_read_input_tokens":20556,"cache_creation":{"ephemeral_5m_input_tokens":26989,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7xhjdgDtXxm22f61pY","uuid":"7eebb30e-4213-4d4d-a287-365923b81b56"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016g2xruZ8G5Dys2yYXu7i26","type":"tool_result","content":"263:    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n289:        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n292:        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n294:            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n301:            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n302:            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n303:            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n304:            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n305:            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n306:            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n309:        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n790:    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');"}]},"uuid":"d3d1bfc1-4909-4741-925b-8cab40aca188","timestamp":"2026-01-22T21:24:11.814Z"},{"type":"assistant","timestamp":"2026-01-22T21:24:13.649Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01V1NcYL3qEMX8XcXWmfrVdL","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check if there's a specific route for \"planes/consumo\" by looking more carefully at the resource routes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":666,"cache_read_input_tokens":47545,"cache_creation":{"ephemeral_5m_input_tokens":666,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7yAEaN1LLkXjF54HAd","uuid":"4ea86469-a7f7-4826-9474-8466918ed7db"},{"type":"assistant","timestamp":"2026-01-22T21:24:14.305Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01V1NcYL3qEMX8XcXWmfrVdL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015khCdCsSmUe5cZu22Hpnje","name":"Bash","input":{"command":"grep -n \"resource.*planes\\|get.*planes.*consumo\\|consumo\" \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php\" | head -30"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":666,"cache_read_input_tokens":47545,"cache_creation":{"ephemeral_5m_input_tokens":666,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXP7yAEaN1LLkXjF54HAd","uuid":"336baa12-25b9-42bb-9a95-2d1c1a23fb73"},{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015khCdCsSmUe5cZu22Hpnje","type":"tool_result","content":"263:    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n265:        $ruta->resource('planes', 'Planes\\PlanController');\n271:        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n283:        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n289:        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n292:        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n294:            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n301:            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n302:            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n303:            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n304:            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n305:            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n306:            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n309:        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n790:    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');","is_error":false}]},"uuid":"8e2c9aaa-dd09-4773-b2c5-fca69fe3ee23","timestamp":"2026-01-22T21:24:15.585Z"}],"type":"agent_progress","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b"},"toolUseID":"agent_msg_01Kkx5kPdNv9NusJxfEs4zvj","parentToolUseID":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","uuid":"b00d8601-4ef1-495f-bde0-2a1c5a1f9732","timestamp":"2026-01-22T21:24:15.654Z"}
{"parentUuid":"a1e8ed41-65ad-4bdc-baec-1d596684fe81","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012Z6vv7P8jaA7DeqfcFaXX2","type":"tool_result","content":[{"type":"text","text":"Perfect! Now I have all the information needed. Let me provide a comprehensive analysis of the routing issue.\n\n## Summary of the Routing Issue\n\nThe problem is clear: you're trying to access `/planes/consumo` but Laravel's route resolution is interpreting \"consumo\" as the `{id}` parameter of the resource route, then passing it to the `show()` method which expects an integer.\n\n### The Root Cause\n\n**File**: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php` (line 265)\n\n```php\n$ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n    // ... other routes ...\n    $ruta->resource('planes', 'Planes\\PlanController');  // Line 265 - This creates RESTful routes\n    // ... other routes ...\n});\n```\n\nWhen you use `$ruta->resource('planes', 'Planes\\PlanController')`, Laravel automatically generates these routes:\n\n- `GET /planes` → `index()`\n- `GET /planes/create` → `create()`\n- `POST /planes` → `store()`\n- `GET /planes/{id}` → `show(int $id)` ← **This is the problem**\n- `GET /planes/{id}/edit` → `edit(int $id)`\n- `PUT/PATCH /planes/{id}` → `update(int $id, ...)`\n- `DELETE /planes/{id}` → `destroy(int $id)`\n\n### Why `/planes/consumo` Fails\n\nWhen you access `/planes/consumo`, Laravel's router:\n1. Matches the resource route `GET /planes/{id}`\n2. Treats \"consumo\" as the `{id}` parameter\n3. Passes the string \"consumo\" to `PlanController::show(int $id)`\n4. PHP's strict typing throws an error because a string cannot be cast to int\n\n### The PlanController::show() Method\n\n**File**: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php` (lines 127-131)\n\n```php\n/**\n * Obtener un plan.\n *\n * @param int $id ID del plan.\n * @return JsonResponse\n * @author Daniel Beltrán\n */\npublic function show(int $id): JsonResponse {\n    return new JsonResponse([\n        'data' => $this->repositorio->getUno($id)\n    ], 200);\n}\n```\n\nThe strict `int $id` type hint causes the failure.\n\n### What You Need\n\nI notice the `PlanController` has a `paginaConsumos()` method (lines 101-105) but it's **not registered as a route**:\n\n```php\npublic function paginaConsumos(): View {\n    return view('planes.paginas.consumos')->with([\n        'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    ]);\n}\n```\n\n### Solution\n\nYou need to add a **named route** BEFORE the resource route (named routes must come first to avoid being matched by the resource wildcard):\n\n```php\n$ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n    // Named route MUST come before resource route\n    $ruta->get('planes/consumo', 'Planes\\PlanController@paginaConsumos')->name('planes.consumo');\n    \n    // ... other routes ...\n    $ruta->resource('planes', 'Planes\\PlanController');\n    // ... rest of routes ...\n});\n```\n\nThis ensures that requests to `/planes/consumo` are matched by the explicit named route before Laravel's router tries to match the resource pattern `planes/{id}`."},{"type":"text","text":"agentId: a0e477b (for resuming to continue this agent's work if needed)"}]}]},"uuid":"f243f39c-59c5-4533-87f0-977343f17ac3","timestamp":"2026-01-22T21:24:25.112Z","toolUseResult":{"status":"completed","prompt":"I need to understand a routing issue. The error is: `PlanController::show(): Argument #1 ($id) must be of type int, string given` when accessing the route `planes/consumo`. This suggests \"consumo\" is being matched as the `{id}` parameter of a resource/show route.\n\nPlease find:\n1. The PlanController file at `app/Http/Controllers/Planes/PlanController.php` - read it fully\n2. The route definitions for \"planes\" - search in `routes/web.php` or any route files for \"planes\" related routes\n3. Any route that defines `planes/consumo`\n\nBe thorough in searching route files.","agentId":"a0e477b","content":[{"type":"text","text":"Perfect! Now I have all the information needed. Let me provide a comprehensive analysis of the routing issue.\n\n## Summary of the Routing Issue\n\nThe problem is clear: you're trying to access `/planes/consumo` but Laravel's route resolution is interpreting \"consumo\" as the `{id}` parameter of the resource route, then passing it to the `show()` method which expects an integer.\n\n### The Root Cause\n\n**File**: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php` (line 265)\n\n```php\n$ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n    // ... other routes ...\n    $ruta->resource('planes', 'Planes\\PlanController');  // Line 265 - This creates RESTful routes\n    // ... other routes ...\n});\n```\n\nWhen you use `$ruta->resource('planes', 'Planes\\PlanController')`, Laravel automatically generates these routes:\n\n- `GET /planes` → `index()`\n- `GET /planes/create` → `create()`\n- `POST /planes` → `store()`\n- `GET /planes/{id}` → `show(int $id)` ← **This is the problem**\n- `GET /planes/{id}/edit` → `edit(int $id)`\n- `PUT/PATCH /planes/{id}` → `update(int $id, ...)`\n- `DELETE /planes/{id}` → `destroy(int $id)`\n\n### Why `/planes/consumo` Fails\n\nWhen you access `/planes/consumo`, Laravel's router:\n1. Matches the resource route `GET /planes/{id}`\n2. Treats \"consumo\" as the `{id}` parameter\n3. Passes the string \"consumo\" to `PlanController::show(int $id)`\n4. PHP's strict typing throws an error because a string cannot be cast to int\n\n### The PlanController::show() Method\n\n**File**: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php` (lines 127-131)\n\n```php\n/**\n * Obtener un plan.\n *\n * @param int $id ID del plan.\n * @return JsonResponse\n * @author Daniel Beltrán\n */\npublic function show(int $id): JsonResponse {\n    return new JsonResponse([\n        'data' => $this->repositorio->getUno($id)\n    ], 200);\n}\n```\n\nThe strict `int $id` type hint causes the failure.\n\n### What You Need\n\nI notice the `PlanController` has a `paginaConsumos()` method (lines 101-105) but it's **not registered as a route**:\n\n```php\npublic function paginaConsumos(): View {\n    return view('planes.paginas.consumos')->with([\n        'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    ]);\n}\n```\n\n### Solution\n\nYou need to add a **named route** BEFORE the resource route (named routes must come first to avoid being matched by the resource wildcard):\n\n```php\n$ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n    // Named route MUST come before resource route\n    $ruta->get('planes/consumo', 'Planes\\PlanController@paginaConsumos')->name('planes.consumo');\n    \n    // ... other routes ...\n    $ruta->resource('planes', 'Planes\\PlanController');\n    // ... rest of routes ...\n});\n```\n\nThis ensures that requests to `/planes/consumo` are matched by the explicit named route before Laravel's router tries to match the resource pattern `planes/{id}`."}],"totalDurationMs":35384,"totalTokens":49291,"totalToolUseCount":6,"usage":{"input_tokens":3,"cache_creation_input_tokens":1076,"cache_read_input_tokens":48211,"cache_creation":{"ephemeral_5m_input_tokens":1076,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"sourceToolAssistantUUID":"a1e8ed41-65ad-4bdc-baec-1d596684fe81"}
{"parentUuid":"f243f39c-59c5-4533-87f0-977343f17ac3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01G4xb49QJyJcQkZWG3pNzu3","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The issue is clear. The route `planes/consumo` is being matched by the resource route `planes/{id}` and treating \"consumo\" as the `$id` parameter. The solution is to add the explicit route for `planes/consumo` BEFORE the resource route definition.\n\nLet me read the relevant section of the routes file to see the exact current state.","signature":"EvUDCkYICxgCKkCv5Bmnwa33p1+NJWfB67nlTVN6Vu1qdF+4vaHvYVtu1qL39dIR5KsCVBsCeW/Yn9aChap/LTS2u08ov6KY9A5WEgysz4Om5JFqrd/15PAaDIdfM6tRP1xHc5neGSIw3ZohRUor9u8bqkPda5pqQ5Ay+QFxkM93gVjtUG3a8WpvWc0V1lOkkMhEvm3xY25EKtwCxhgMmuhQXdIj6e4f0HTpDGbLWX1eQzcWIU0LP1fMKlVGr79y0jmtFe1vUQNPVY6klDY2bsjBi0RAdBs3ffeepBiL48ssziHZlimVJTM1YOH3brNjV4qRtliHAEqGnyev83M7lpvZJ7evBVtEUjshtnVHkT45YhQoNBN5ki/BV6Mcd+cynzL/ysry4HpsncJh1o35lA++G9xGlOgN708NwKJE3HjFZ3695iqV2kxMWwu6L3hKmLtCQeXNZbuQhpWK9UQxCfRk6VdQrDvf74BQ6Jr3NY8KtUNhAEv3U16I+gFICce1JLN21zpBtxHpIAZ7StsLenl7A7c1t7zK2QsHBtJW+vP9WjkJAocfiJba1aGoChGyOk3gYiH58bBebMrW+azIZbgqmAvreoUAV9aaAY75cxKvxZNEzgF/ciL7E7kZNFy1DpQqU0yJ2CqKEXm+6o55gqLpj5Ar8237GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1310,"cache_read_input_tokens":63746,"cache_creation":{"ephemeral_5m_input_tokens":1310,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP7z9gcextKGzv1Efoik","type":"assistant","uuid":"0e959cb0-e425-4a6b-8eb1-36c970c1cfaf","timestamp":"2026-01-22T21:24:28.224Z"}
{"parentUuid":"0e959cb0-e425-4a6b-8eb1-36c970c1cfaf","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01G4xb49QJyJcQkZWG3pNzu3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XP16uyNGpACaWzqSCCHSiH","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","offset":255,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1310,"cache_read_input_tokens":63746,"cache_creation":{"ephemeral_5m_input_tokens":1310,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP7z9gcextKGzv1Efoik","type":"assistant","uuid":"47ce9bd0-0a3b-4bed-ade4-3465f4b68b01","timestamp":"2026-01-22T21:24:29.004Z"}
{"parentUuid":"47ce9bd0-0a3b-4bed-ade4-3465f4b68b01","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XP16uyNGpACaWzqSCCHSiH","type":"tool_result","content":"   255→\n   256→    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n   257→        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n   258→        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n   259→        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n   260→        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n   261→    });\n   262→\n   263→    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n   264→        // Planes\n   265→        $ruta->resource('planes', 'Planes\\PlanController');\n   266→        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n   267→        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n   268→        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n   269→        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n   270→        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n   271→        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n   272→        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n   273→        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n   274→        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n   275→        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n   276→        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n   277→        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n   278→        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n   279→        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n   280→        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n   281→\n   282→        // Planes de Créditos - Vista de creación\n   283→        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n   284→        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d41be51d-bcab-4ec7-a628-1b31d83979c1","timestamp":"2026-01-22T21:24:30.153Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","content":"\n    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n    });\n\n    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n        // Planes\n        $ruta->resource('planes', 'Planes\\PlanController');\n        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n\n        // Planes de Créditos - Vista de creación\n        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);","numLines":30,"startLine":255,"totalLines":978}},"sourceToolAssistantUUID":"47ce9bd0-0a3b-4bed-ade4-3465f4b68b01"}
{"parentUuid":"d41be51d-bcab-4ec7-a628-1b31d83979c1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Nehwi2No2nNQx3nS3Mmc9s","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I can see the problem clearly. The `$ruta->resource('planes', 'Planes\\PlanController')` at line 265 creates a route `GET /planes/{id}` that matches `/planes/consumo`, treating \"consumo\" as the `$id` parameter.\n\nI need to find where the route for `planes/consumo` is defined (or should be defined). Let me also check the PlanController for the `paginaConsumos` method.","signature":"EpoECkYICxgCKkAPNqeURwGJxRPfNH26oAIUL1MLJwQIfiq9Qzwn5gOkWt2k7CLUqQykAZYbsM5bz4ExXWlbMLYT+2n85/iUttGNEgw1JJhnzOUJOIdyBA4aDBEFgvKWr/PtEInBzCIw/9KCCbLas7uSB8dXr5NB58lEkXP3BKiyRxjElZL8yIco4GWDzcAFgucO6CqK9Z73KoED4PVfsJCWdveasks/2TPvqPCUcXshrfO9pkstISAgFt+pMGurw5qUgcZNpDjPqSAx04aKkFusE/a4UxpMG86Riw51wfa11buRnG5MLOdTyQFUALEuk2q661Dwgq+VN+7rHlRVnKZvqJaaDztNsNZoLHKzHMoFZ0YjJZAYPdiXGcLcD/ERfBp/f4ArqW0PhXiURw59vv41QEc6cP5UqCyvn9w09JNYQpQXzSwi0YkjGsMFJTtEDIiyTqZARGAa/p4PLiJH4YZKliptyrQobxruBsPpx1yUNFJXpDZrQRg6/UZeHB6852Qc7G45BvxuK3hhnOaC3C8jE9zghuHws9h51e6wS+IGt8owDygY3Pecm+I3vYnWPMGDR9QL7lkBe9OqoNdq+jKhOUuSGAfaWtKRnItjBH16/1RVJbDyALRAyZcTdf9KokaFQ8NosfZYV2ucVruc7h+H4ip8B5cFkLrsQKbZ1ulhQxaqYuyPLnb1cDrl8hTmKCokp6zmPn6/aNCMVRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1258,"cache_read_input_tokens":65056,"cache_creation":{"ephemeral_5m_input_tokens":1258,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP7zXNbgRCH5p6EFWnKM","type":"assistant","uuid":"440e6cd1-83a8-484a-a0c0-fe17c68e3706","timestamp":"2026-01-22T21:24:34.316Z"}
{"parentUuid":"440e6cd1-83a8-484a-a0c0-fe17c68e3706","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Nehwi2No2nNQx3nS3Mmc9s","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DLp4CGM8QU5mwMTxTbxS3k","name":"Grep","input":{"pattern":"planes.*consumo|consumo.*planes|paginaConsumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1258,"cache_read_input_tokens":65056,"cache_creation":{"ephemeral_5m_input_tokens":1258,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP7zXNbgRCH5p6EFWnKM","type":"assistant","uuid":"2ea1f2d1-c513-462b-bd3b-7b1c93b56910","timestamp":"2026-01-22T21:24:36.053Z"}
{"parentUuid":"2ea1f2d1-c513-462b-bd3b-7b1c93b56910","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Nehwi2No2nNQx3nS3Mmc9s","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014cixvVv1BwsuHoMgGX1VWG","name":"Grep","input":{"pattern":"paginaConsumo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php","output_mode":"content","-A":3}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1258,"cache_read_input_tokens":65056,"cache_creation":{"ephemeral_5m_input_tokens":1258,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP7zXNbgRCH5p6EFWnKM","type":"assistant","uuid":"2465eedb-3524-43be-a778-f6633e42cf57","timestamp":"2026-01-22T21:24:37.092Z"}
{"parentUuid":"2465eedb-3524-43be-a778-f6633e42cf57","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014cixvVv1BwsuHoMgGX1VWG","type":"tool_result","content":"101:    public function paginaConsumos(): View {\n102-        return view('planes.paginas.consumos')->with([\n103-            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n104-        ]);"}]},"uuid":"93e51889-82fc-4629-8446-ae5cd38b692a","timestamp":"2026-01-22T21:24:39.739Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"101:    public function paginaConsumos(): View {\n102-        return view('planes.paginas.consumos')->with([\n103-            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n104-        ]);","numLines":4},"sourceToolAssistantUUID":"2465eedb-3524-43be-a778-f6633e42cf57"}
{"parentUuid":"2ea1f2d1-c513-462b-bd3b-7b1c93b56910","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DLp4CGM8QU5mwMTxTbxS3k","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:263:    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:292:        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:309:        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {"}]},"uuid":"e5211b2f-3704-40f5-9538-c13d7c5b87d8","timestamp":"2026-01-22T21:24:39.773Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:263:    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:292:        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:309:        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {","numLines":3},"sourceToolAssistantUUID":"2ea1f2d1-c513-462b-bd3b-7b1c93b56910"}
{"parentUuid":"e5211b2f-3704-40f5-9538-c13d7c5b87d8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GfLFS25AQGrgPLxcGTzTun","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I can see the issue clearly. There's a `paginaConsumos()` method in `PlanController` but no route for `planes/consumo`. Let me check lines 290-310 of the routes file to see what's in the `planes-consumo.consumo` middleware group.","signature":"EpIDCkYICxgCKkBTIswVa5pSyekqddy40U1D17sHrXEzLwn2qkVTgNOOgePiwzZikWC4Mv7KdksRqvpJ9QsRMWhhFZcxY5GeKIymEgzZe9rgNF4svZa1KhYaDKiL1j01rnuHRMUoYCIwXzq0h+L+oWqdwcOJ4xlL4Cp0hg1fB/WvdislWisGszsz5cjGXVhk/6loa+Q6nr1jKvkBNby6CmxdRUpf2dhGG7Jph7X4jwCwjYGP8wHSqZSY6qfBjpP/mi8BVaBeWuy9y4hGWTq5Ft1kOoqbvyFCj3EnMUWOPkHRc7Kv224PSlHzDpkxSSYEpfAGaKdmvrw09tS2YUF1ZcBDisxbWUN65ohr03JoY3USPnTciu0/bP9ejMw0Oo1qHKhe1NsNRVLSPUT9Zgq0Uh2k5nnD2JR8S3mLgyKfSKyxtD5kVTsXBSapPV0OFiq9V8gNS3ZyLuAfx57fzST80XmyFrERON/2m8VjQGBmcwYGm59INev8fgWwR4EwNRxIQJp/SVfHuCuPPSRuHcrfQAGCi/MlGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":108,"cache_creation_input_tokens":566,"cache_read_input_tokens":66314,"cache_creation":{"ephemeral_5m_input_tokens":566,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXP81ESPoL4fByGjCM2R7","type":"assistant","uuid":"7b715b9a-d2bb-4627-b2c3-8e12fb6b2a51","timestamp":"2026-01-22T21:24:42.577Z"}
{"parentUuid":"7b715b9a-d2bb-4627-b2c3-8e12fb6b2a51","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GfLFS25AQGrgPLxcGTzTun","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TnYeNex3afmX2Q7zergUKT","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","offset":288,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":108,"cache_creation_input_tokens":566,"cache_read_input_tokens":66314,"cache_creation":{"ephemeral_5m_input_tokens":566,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXP81ESPoL4fByGjCM2R7","type":"assistant","uuid":"b927b6b0-eaa8-401d-8697-6ab511825e02","timestamp":"2026-01-22T21:24:43.313Z"}
{"parentUuid":"b927b6b0-eaa8-401d-8697-6ab511825e02","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TnYeNex3afmX2Q7zergUKT","type":"tool_result","content":"   288→        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n   289→        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n   290→        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   291→\n   292→        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n   293→            // Consumos\n   294→            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n   295→            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n   296→            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n   297→            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n   298→            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n   299→            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n   300→            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n   301→            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n   302→            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n   303→            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n   304→            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n   305→            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n   306→            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n   307→        });\n   308→\n   309→        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n   310→            // Archivo\n   311→            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n   312→            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n   313→        });\n   314→    });\n   315→\n   316→    // Perfiles laborales\n   317→    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"89f3fa7f-1911-46ea-8b5d-378c6bee769c","timestamp":"2026-01-22T21:24:44.450Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","content":"        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n\n        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n            // Consumos\n            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n        });\n\n        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n            // Archivo\n            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n        });\n    });\n\n    // Perfiles laborales\n    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');","numLines":30,"startLine":288,"totalLines":978}},"sourceToolAssistantUUID":"b927b6b0-eaa8-401d-8697-6ab511825e02"}
{"parentUuid":"89f3fa7f-1911-46ea-8b5d-378c6bee769c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018pZvEMCZwG8dStvX6PDVcP","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a clear understanding of the issue. The route `planes/consumo` doesn't exist in the route definitions. The `PlanController::paginaConsumos()` method exists but has no corresponding route. When the user accesses `/planes/consumo`, Laravel matches it to the resource route `planes/{id}` and passes \"consumo\" as the `$id` parameter, which fails because `show(int $id)` expects an integer.\n\nThe fix is simple: add a `$ruta->get('planes/consumo', ...)` route BEFORE the resource route definition. Let me write the plan.","signature":"ErYFCkYICxgCKkBYFimZh1IoXCsV8w3CvublmlyeHCW7wUP7CihykqPePGOjdyFURmn1pqRNOhjL5iDWr1G31fyhLopkgAytfVNMEgw4aZUWSlItW/GdooQaDOT5tenWUHgjlTIFEyIwjVn8UNjLbt1hvEEvK3jd0QrkAxY8uF5zcOdwXqH4GjRWGtA2E6Nvza+Ag1LGWXlZKp0E4wP6RFQ59sDOwH9peDNI94BawzX+c9EG96n8/Rp3sx2hIe6gzVDMTOlW70i4s43WYmXoueD6nMJIwDqk8bMuWmfzgN5UWgBfNMCbs6tk7mI2fSx6205h4FRNBIJCJiy2vXQyjAs7vwSpTNrlSr0IhxIYzNeBLqq9PHwHoDi+U2/f/dZTkxA5Y9l7kyfxFVFkt7q5ImJkcNvZ7CPXIuIxoRy0h2yDVP2FIBuE4/1B973rICis2VuJ6bSUMYk3jhj/N5F2ImU/SYTWMNvegchpLsypLGI23OF1cTbLR45bOKMX7FWNcSKZt9QBoxTciCSb42i/kvU5LtQlmhXzQD2AtWVUxrdoWxG1/O5sAenkuVgeCho+hj8Mk7SKu8PCg53PFuV7SwYI0tqcszv3vSJO2HkqKMke8shYTcmkssJjKHVKk+5pD81vOdP8yMmFevpUEGM35oQmNCPHCpO/XYZ9/BCO+C4z9R9wdXW6MutjTGo21LpQnhpdUdYBejpjd4UpltKtPGJmM1CTAhhDEM8fDF/9XYs+LX2mclSbciOHuS9uxXILxe+9wvfMsGCv8hn/xq7HvCx9ABbSCwnEieveNUBK70aLmsaxVyYB4l1BkqGFT+9quKIrnGADh1RQa4u/QykKAgpDltovauZm3WcD/kvEXQ5Psv0pYTjv+4tqI9RLRP2iOVU/VC/kqaA2EkRccMUOtSVrTs/x0VX1VBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1394,"cache_read_input_tokens":66880,"cache_creation":{"ephemeral_5m_input_tokens":1394,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP81aZcJCASd5Sw3KWEh","type":"assistant","uuid":"20f2e137-cbef-42c1-b5f5-04f56b3d5a96","timestamp":"2026-01-22T21:24:49.438Z"}
{"parentUuid":"20f2e137-cbef-42c1-b5f5-04f56b3d5a96","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018pZvEMCZwG8dStvX6PDVcP","type":"message","role":"assistant","content":[{"type":"text","text":"El problema es claro. La ruta `planes/consumo` no está registrada, y el recurso `$ruta->resource('planes', ...)` en la línea 265 captura \"consumo\" como el parámetro `{id}` de la ruta `show`. La solución es agregar la ruta explícita antes del resource."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1394,"cache_read_input_tokens":66880,"cache_creation":{"ephemeral_5m_input_tokens":1394,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP81aZcJCASd5Sw3KWEh","type":"assistant","uuid":"2f3e6ede-a399-4291-baeb-e6167fe26824","timestamp":"2026-01-22T21:24:51.199Z"}
{"parentUuid":"2f3e6ede-a399-4291-baeb-e6167fe26824","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_018pZvEMCZwG8dStvX6PDVcP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01M3vR82ZqEqkjHMhALNASfo","name":"Write","input":{"file_path":"C:\\Users\\sergio\\.claude\\plans\\atomic-coalescing-meadow.md","content":"# Fix: planes/consumo route conflict\n\n## Problema\nAl acceder a `planes/consumo`, Laravel matchea la ruta resource `planes/{id}` y pasa \"consumo\" como `$id` (string) a `PlanController::show(int $id)`, causando el TypeError.\n\n## Causa\n- `PlanController::paginaConsumos()` existe (línea 101) pero no tiene ruta registrada.\n- `$ruta->resource('planes', ...)` (línea 265 de `routes/web.php`) captura todo lo que venga después de `planes/`.\n\n## Solución\nAgregar la ruta explícita `planes/consumo` ANTES del resource en `routes/web.php:265`:\n\n```php\n$ruta->get('planes/consumo', 'Planes\\PlanController@paginaConsumos');\n$ruta->resource('planes', 'Planes\\PlanController');\n```\n\n## Archivo a modificar\n- `routes/web.php` - línea 265\n\n## Verificacion\n- Acceder a la ruta `planes/consumo` en el navegador y confirmar que carga la vista sin error.\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1394,"cache_read_input_tokens":66880,"cache_creation":{"ephemeral_5m_input_tokens":1394,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP81aZcJCASd5Sw3KWEh","type":"assistant","uuid":"fa559ccc-209e-41e8-9466-93e12f59535a","timestamp":"2026-01-22T21:24:56.008Z"}
{"type":"file-history-snapshot","messageId":"fa559ccc-209e-41e8-9466-93e12f59535a","snapshot":{"messageId":"3e1bafe2-aa68-40b6-985f-9db2686a63fa","trackedFileBackups":{"app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php":{"backupFileName":"b4706ac638207036@v2","version":2,"backupTime":"2026-01-22T19:45:29.008Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"115edace5e384ff2@v3","version":3,"backupTime":"2026-01-22T21:23:41.745Z"},"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"87ffcf5aa4ef1291@v2","version":2,"backupTime":"2026-01-22T21:23:41.747Z"},"C:\\Users\\sergio\\.claude\\plans\\atomic-coalescing-meadow.md":{"backupFileName":null,"version":1,"backupTime":"2026-01-22T21:24:56.429Z"}},"timestamp":"2026-01-22T21:23:41.703Z"},"isSnapshotUpdate":true}
{"parentUuid":"fa559ccc-209e-41e8-9466-93e12f59535a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01M3vR82ZqEqkjHMhALNASfo","type":"tool_result","content":"File created successfully at: C:\\Users\\sergio\\.claude\\plans\\atomic-coalescing-meadow.md"}]},"uuid":"8add806a-7e53-47e8-91d8-694e73aee613","timestamp":"2026-01-22T21:24:57.254Z","toolUseResult":{"type":"create","filePath":"C:\\Users\\sergio\\.claude\\plans\\atomic-coalescing-meadow.md","content":"# Fix: planes/consumo route conflict\n\n## Problema\nAl acceder a `planes/consumo`, Laravel matchea la ruta resource `planes/{id}` y pasa \"consumo\" como `$id` (string) a `PlanController::show(int $id)`, causando el TypeError.\n\n## Causa\n- `PlanController::paginaConsumos()` existe (línea 101) pero no tiene ruta registrada.\n- `$ruta->resource('planes', ...)` (línea 265 de `routes/web.php`) captura todo lo que venga después de `planes/`.\n\n## Solución\nAgregar la ruta explícita `planes/consumo` ANTES del resource en `routes/web.php:265`:\n\n```php\n$ruta->get('planes/consumo', 'Planes\\PlanController@paginaConsumos');\n$ruta->resource('planes', 'Planes\\PlanController');\n```\n\n## Archivo a modificar\n- `routes/web.php` - línea 265\n\n## Verificacion\n- Acceder a la ruta `planes/consumo` en el navegador y confirmar que carga la vista sin error.\n","structuredPatch":[],"originalFile":null},"sourceToolAssistantUUID":"fa559ccc-209e-41e8-9466-93e12f59535a"}
{"parentUuid":"8add806a-7e53-47e8-91d8-694e73aee613","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Dn86yQBukUHDsT9EnGKMwS","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have the plan ready. Let me check if the middleware should be different. Looking at the route groups:\n\n- The resource route is inside `'middleware' => 'can:planes-consumo'`\n- There's a sub-group with `'middleware' => 'can:planes-consumo.consumo'` for consumption-related routes\n\nThe `paginaConsumos()` method returns a view for consumption. It should likely go inside the `planes-consumo.consumo` middleware group or at the parent level. Since it's a page for consumption, it might belong to the `planes-consumo.consumo` group.\n\nActually, the simplest fix is to just add it before the resource route in the same middleware group. The user accessed \"planes/consumo\" so it needs to be at that path. Let me just call ExitPlanMode.","signature":"EoQHCkYICxgCKkD9jP2TAavjR2z0HP4/8BszsFevXn1Y8YdSI5sTH3EMDOVHQBQI0G+Ihf/1UwYbTElH/DfODJ/DBKgQBVedDUHIEgw/UW4f96o8cKVdpC4aDLAZ35O1G1yEROW6nyIwXYArnu68Yu6QnojokERf+MogbCSHAjyI6CGI+jA4CijcxrOKcB3lVVqm790EcQf/KusFbjFvxIkA+G5zpZGgpBU2BCvUiAVLUFLiPwZpWwSUKnYTXzPN5MmNoc074VbEvZHaj7lAFmcwuDIKvx9O1RGriAeCaxGD9k+eWKlpyj4tekearNJqLXaGo2N2yVSbnmz9DgnBkNqt8wRkjEBy1I0XbEuwi3FYjr0Lls4cHIcT1dzT5H5Hh8luNNO8H3B7/0DKopx5SQW/yyOkqzobmNj+6YVT3PYOZi81wU3La40DXgmeuz91aZ5+2m0FmxONWtf5m0ojXfu9T+z6ftfBUMWAgoBPYojPF5Eo7OpW3eeH7pWA24w0CZKC0PpKgF5iDiTorSZZW4kM/gpau/es2lcDH4epI+o/Gr5KEaGsXeojl7bHiE7gBtZzgmfYLdPRLZRIU/1J2tKl53N3F3n75Hv9hSz4fbTE0WgMktkUn1UHq00cnMoFWZ5PQr9XaQR5aLqge49c+RX3CTETYb+j5n+48DPmKZq+LxKRkopp/d+2hQM4L47BHIBtC1eEFMcvf0sa0rtv9jB+EwlBBDl1CcSJQp86uypsm2QXxwJMH9yQV1wc09e240TAXkrBSNnBsYdAf5sFMCWnp4yJDpXTOLr14C9MHNpVYOL+MxypMhZ02Nq/9QoM0/wRdrpc9+BgAJm1p/BS0ShGr4zgcoilROL1H6DlT2wDEfiK/gApAK7KNoASomPBRPH6Mbjhj/doayCU9WkZr6gJzRO8CT7jGHBzXJxNBMjarOfs7ZmQVqTygyWfbQCFPzgXeykxeb78juQSTf8fqdioim019EPLosavUpZKAn/SScrA9wyNWcDyuyKPzRTkDfYbxLmyAxtuldI9ylVvk9IyarpukT1KU4tWeQcCYAADvqJ3Tj4lFNUAFza44216Rv58y2nL/MJKcZ4VNe6a9up1sY0hY3R3+kFhXqzGCPGTCxIZ/PAwUsR6WnFpnvMDLRKyxCAFHCFEP2hg0KCQEGOimm+EnunfPBu+iZryvQIOR5e/N2ISGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":753,"cache_read_input_tokens":68274,"cache_creation":{"ephemeral_5m_input_tokens":753,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXP82XBFD8Xxt5XXrXELA","type":"assistant","uuid":"d3d6ed3c-eea9-4f6e-a8e0-d65e583811ea","timestamp":"2026-01-22T21:25:03.183Z"}
{"parentUuid":"d3d6ed3c-eea9-4f6e-a8e0-d65e583811ea","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Dn86yQBukUHDsT9EnGKMwS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RjQURMQ6ggifX8bsr9yxY9","name":"AskUserQuestion","input":{"questions":[{"question":"La ruta planes/consumo deberia estar bajo el middleware 'can:planes-consumo.consumo' (junto con las rutas de consumos) o bajo 'can:planes-consumo' (nivel padre)?","header":"Middleware","options":[{"label":"can:planes-consumo (Recommended)","description":"Mismo nivel que el resource de planes, accesible para cualquiera con permiso planes-consumo"},{"label":"can:planes-consumo.consumo","description":"Dentro del grupo de consumos, requiere permiso mas especifico"}],"multiSelect":false}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":753,"cache_read_input_tokens":68274,"cache_creation":{"ephemeral_5m_input_tokens":753,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXP82XBFD8Xxt5XXrXELA","type":"assistant","uuid":"7d21cb6a-d444-4b61-8c04-52edce70acbf","timestamp":"2026-01-22T21:25:06.404Z"}
{"parentUuid":"7d21cb6a-d444-4b61-8c04-52edce70acbf","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"User has answered your questions: \"La ruta planes/consumo deberia estar bajo el middleware 'can:planes-consumo.consumo' (junto con las rutas de consumos) o bajo 'can:planes-consumo' (nivel padre)?\"=\"can:planes-consumo (Recommended)\". You can now continue with the user's answers in mind.","tool_use_id":"toolu_01RjQURMQ6ggifX8bsr9yxY9"}]},"uuid":"7a1176aa-03f5-4b2e-bc1e-1768695eaf6f","timestamp":"2026-01-22T21:27:55.475Z","toolUseResult":{"questions":[{"question":"La ruta planes/consumo deberia estar bajo el middleware 'can:planes-consumo.consumo' (junto con las rutas de consumos) o bajo 'can:planes-consumo' (nivel padre)?","header":"Middleware","options":[{"label":"can:planes-consumo (Recommended)","description":"Mismo nivel que el resource de planes, accesible para cualquiera con permiso planes-consumo"},{"label":"can:planes-consumo.consumo","description":"Dentro del grupo de consumos, requiere permiso mas especifico"}],"multiSelect":false}],"answers":{"La ruta planes/consumo deberia estar bajo el middleware 'can:planes-consumo.consumo' (junto con las rutas de consumos) o bajo 'can:planes-consumo' (nivel padre)?":"can:planes-consumo (Recommended)"}},"sourceToolAssistantUUID":"7d21cb6a-d444-4b61-8c04-52edce70acbf"}
{"parentUuid":"7a1176aa-03f5-4b2e-bc1e-1768695eaf6f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PFThUGzXVtT6Lr8po1F22w","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants it under the parent middleware `can:planes-consumo`. My plan is correct - just add it before the resource route at line 265. Let me exit plan mode.","signature":"EssCCkYICxgCKkATMTq2bkEbbUNoQXpscU3SJpW2XXx5l1Di9Xd5i6me5LWJQ0TTxqqVU0HoShWsTet/TSrV/YZi1TWAadfYAtI2Egwr5peigyQomTjz6ywaDEGW5SbbBpnxCfmfgSIwZJMUWmAAs6zYtTuzmRWrhJPOuTwJjFnv5RvdDdInUGJqRzhYxvV8CISUDDr6tPNKKrIBW42cuS654F5tb2nNTn/c6SO46bmuPv4ZdUgMq7Z60UEYnuv9nfhmgOqCSBjo+So2nagb8Dp/h1xFzw2XoHyIFfjO5B6qAfB2O4I63psj1y5dsfyHSYuztqpKLXr6CYT7Q2xXJClsXbpilxz8P3v0uK80JjMLBS2WXnSSNKRMl9a2huJVpigN79ky+ejopcJt6edbfvHOQ3jnBffFixIOLr+gVnYN6Kl+rWK8T4rjPeWeohgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":505,"cache_read_input_tokens":69027,"cache_creation":{"ephemeral_5m_input_tokens":505,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8FfHGa38ppRyYP3hDi","type":"assistant","uuid":"299d41ed-f2b2-4c49-9981-230be09a5bf3","timestamp":"2026-01-22T21:28:00.099Z"}
{"parentUuid":"299d41ed-f2b2-4c49-9981-230be09a5bf3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PFThUGzXVtT6Lr8po1F22w","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0158nd1PcQyptL5Q33acJfi9","name":"ExitPlanMode","input":{"plan":"# Fix: planes/consumo route conflict\n\n## Problema\nAl acceder a `planes/consumo`, Laravel matchea la ruta resource `planes/{id}` y pasa \"consumo\" como `$id` (string) a `PlanController::show(int $id)`, causando el TypeError.\n\n## Causa\n- `PlanController::paginaConsumos()` existe (línea 101) pero no tiene ruta registrada.\n- `$ruta->resource('planes', ...)` (línea 265 de `routes/web.php`) captura todo lo que venga después de `planes/`.\n\n## Solución\nAgregar la ruta explícita `planes/consumo` ANTES del resource en `routes/web.php:265`:\n\n```php\n$ruta->get('planes/consumo', 'Planes\\PlanController@paginaConsumos');\n$ruta->resource('planes', 'Planes\\PlanController');\n```\n\n## Archivo a modificar\n- `routes/web.php` - línea 265\n\n## Verificacion\n- Acceder a la ruta `planes/consumo` en el navegador y confirmar que carga la vista sin error.\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":505,"cache_read_input_tokens":69027,"cache_creation":{"ephemeral_5m_input_tokens":505,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8FfHGa38ppRyYP3hDi","type":"assistant","uuid":"2098d59a-23d2-41bb-9111-44e90f6bffc9","timestamp":"2026-01-22T21:28:00.188Z"}
{"parentUuid":"2098d59a-23d2-41bb-9111-44e90f6bffc9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"User has approved your plan. You can now start coding. Start with updating your todo list if applicable\n\nYour plan has been saved to: C:\\Users\\sergio\\.claude\\plans\\atomic-coalescing-meadow.md\nYou can refer back to it if needed during implementation.\n\n## Approved Plan:\n# Fix: planes/consumo route conflict\n\n## Problema\nAl acceder a `planes/consumo`, Laravel matchea la ruta resource `planes/{id}` y pasa \"consumo\" como `$id` (string) a `PlanController::show(int $id)`, causando el TypeError.\n\n## Causa\n- `PlanController::paginaConsumos()` existe (línea 101) pero no tiene ruta registrada.\n- `$ruta->resource('planes', ...)` (línea 265 de `routes/web.php`) captura todo lo que venga después de `planes/`.\n\n## Solución\nAgregar la ruta explícita `planes/consumo` ANTES del resource en `routes/web.php:265`:\n\n```php\n$ruta->get('planes/consumo', 'Planes\\PlanController@paginaConsumos');\n$ruta->resource('planes', 'Planes\\PlanController');\n```\n\n## Archivo a modificar\n- `routes/web.php` - línea 265\n\n## Verificacion\n- Acceder a la ruta `planes/consumo` en el navegador y confirmar que carga la vista sin error.\n","tool_use_id":"toolu_0158nd1PcQyptL5Q33acJfi9"}]},"uuid":"f3222d97-433f-4939-a105-2a9b62b69b29","timestamp":"2026-01-22T21:28:37.869Z","toolUseResult":{"plan":"# Fix: planes/consumo route conflict\n\n## Problema\nAl acceder a `planes/consumo`, Laravel matchea la ruta resource `planes/{id}` y pasa \"consumo\" como `$id` (string) a `PlanController::show(int $id)`, causando el TypeError.\n\n## Causa\n- `PlanController::paginaConsumos()` existe (línea 101) pero no tiene ruta registrada.\n- `$ruta->resource('planes', ...)` (línea 265 de `routes/web.php`) captura todo lo que venga después de `planes/`.\n\n## Solución\nAgregar la ruta explícita `planes/consumo` ANTES del resource en `routes/web.php:265`:\n\n```php\n$ruta->get('planes/consumo', 'Planes\\PlanController@paginaConsumos');\n$ruta->resource('planes', 'Planes\\PlanController');\n```\n\n## Archivo a modificar\n- `routes/web.php` - línea 265\n\n## Verificacion\n- Acceder a la ruta `planes/consumo` en el navegador y confirmar que carga la vista sin error.\n","isAgent":false,"filePath":"C:\\Users\\sergio\\.claude\\plans\\atomic-coalescing-meadow.md"},"sourceToolAssistantUUID":"2098d59a-23d2-41bb-9111-44e90f6bffc9"}
{"parentUuid":"f3222d97-433f-4939-a105-2a9b62b69b29","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ATzj9eu6A2DkG4L6uyGA5Z","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I can implement the fix. I need to add the route `planes/consumo` before the resource route in `routes/web.php` at line 265.","signature":"EqkCCkYICxgCKkA6KcgxWCqOQJlXrZxp1T3emj0G6PXRevKkOsjHXfxaubyY/SUU2p3DM7iMj4/lQ3kgJ/FAhOlfShy8dosxihnlEgwbo7lgBCvUTO8+NmMaDDVKoni2RZ0oNms3RSIwGrw/GT6P+M0IylgV1oehfNT/SS2XpZMsSSd0EWOTpl5R9G0x2RfRtVSkRHVwojxuKpABvHYSL/r5SczMLta/k9NrLZNr79Dxo48o7tw2F3klkbzaQGmBpdWtBiTofpZBa0jgF0ws9JB2gm2Rd+qM0zfGZ7/Vzhb4fDDsTI050HiwM/FH8w2/oz3GAVuvNPWsv4THTF1mcAOsc3tAcTiSAFp7F6+zGV27oAnT0shKCpBKN8T4KgiObOxs+ZWE3+NbUcFfGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":531,"cache_read_input_tokens":69532,"cache_creation":{"ephemeral_5m_input_tokens":531,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8Jni5ZPo8r8YbgRTKE","type":"assistant","uuid":"065bcfc6-b827-4883-aa7e-03f35467b3c5","timestamp":"2026-01-22T21:28:40.396Z"}
{"parentUuid":"065bcfc6-b827-4883-aa7e-03f35467b3c5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ATzj9eu6A2DkG4L6uyGA5Z","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SLKESxJejmuVe9x7Xd3pjj","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","old_string":"    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n        // Planes\n        $ruta->resource('planes', 'Planes\\PlanController');","new_string":"    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n        // Planes\n        $ruta->get('planes/consumo', 'Planes\\PlanController@paginaConsumos');\n        $ruta->resource('planes', 'Planes\\PlanController');"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":531,"cache_read_input_tokens":69532,"cache_creation":{"ephemeral_5m_input_tokens":531,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8Jni5ZPo8r8YbgRTKE","type":"assistant","uuid":"55a0a765-a41b-4576-b683-053f7f0f4893","timestamp":"2026-01-22T21:28:42.791Z"}
{"type":"file-history-snapshot","messageId":"55a0a765-a41b-4576-b683-053f7f0f4893","snapshot":{"messageId":"3e1bafe2-aa68-40b6-985f-9db2686a63fa","trackedFileBackups":{"app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php":{"backupFileName":"b4706ac638207036@v2","version":2,"backupTime":"2026-01-22T19:45:29.008Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"115edace5e384ff2@v3","version":3,"backupTime":"2026-01-22T21:23:41.745Z"},"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"87ffcf5aa4ef1291@v2","version":2,"backupTime":"2026-01-22T21:23:41.747Z"},"C:\\Users\\sergio\\.claude\\plans\\atomic-coalescing-meadow.md":{"backupFileName":null,"version":1,"backupTime":"2026-01-22T21:24:56.429Z"},"routes\\web.php":{"backupFileName":"8d4f24f72d6f32f1@v1","version":1,"backupTime":"2026-01-22T21:29:06.063Z"}},"timestamp":"2026-01-22T21:23:41.703Z"},"isSnapshotUpdate":true}
{"parentUuid":"55a0a765-a41b-4576-b683-053f7f0f4893","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SLKESxJejmuVe9x7Xd3pjj","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php has been updated successfully."}]},"uuid":"a7df7fe9-9e9e-449c-ad1f-dd42319b2ea4","timestamp":"2026-01-22T21:29:06.057Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","oldString":"    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n        // Planes\n        $ruta->resource('planes', 'Planes\\PlanController');","newString":"    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n        // Planes\n        $ruta->get('planes/consumo', 'Planes\\PlanController@paginaConsumos');\n        $ruta->resource('planes', 'Planes\\PlanController');","originalFile":"<?php\n\nuse Illuminate\\Support\\Str;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n\nRoute::get('/', function () {\n    return redirect()->route('login');\n});\n\nAuth::routes(['register' => false]);\n\n// Rutas de acceso para aplicante.\nRoute::group([\n    'prefix'    => 'control-acceso',\n    'namespace' => 'App\\Http\\Controllers\\Auth'\n], function ($ruta) {\n    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n});\n\n// Rutas de migración de usuarios desde la base de datos antigua.\nRoute::group([\n    'prefix'    => 'migrar-usuario-app-antigua',\n    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n], function ($ruta) {\n    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n});\n\n// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\nRoute::group([\n    'prefix'     => 'rol-empresa',\n    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n], function ($ruta) {\n    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n});\n\n// Rutas protegidas por autenticación y selección de rol y empresa.\nRoute::group([\n    'middleware' => ['auth', 'auth.rol-empresa'],\n    'namespace'  => 'App\\Http\\Controllers'\n], function ($ruta) {\n    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n\n    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n\n        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n            // Usuarios\n            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n\n            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n            // Pruebas\n            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n            // Carga masiva de pruebas\n            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n            // Baremos\n            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n            // Dimensiones\n            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n            // Factores\n            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n            $ruta->resource('factores', 'Pruebas\\FactorController');\n            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n            // Reactivos\n            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n\n            // Opciones\n            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n            // Calificaciones\n            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n            // Grupos de opciones\n            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n            // Secciones de texto\n            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n        });\n\n        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n    });\n\n    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n            // Perfiles\n            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n        });\n\n        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n            // Módulos de preguntas\n            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n        });\n\n        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n            // Demográficas\n            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n            // Listado de empresas\n            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n            // Gestionar empresas\n            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n\n            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n                // Usuarios\n                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n            });\n\n            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n                // Planes\n                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n            });\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n            // Archivo de empresas\n            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n            // Migración de empresas\n            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n            // Portales de empleo\n            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n\n            // Premios destacados\n            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n\n            // Motivadores\n            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n        });\n\n        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n    });\n\n    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n    });\n\n    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n        // Planes\n        $ruta->resource('planes', 'Planes\\PlanController');\n        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n\n        // Planes de Créditos - Vista de creación\n        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n        $ruta->get('servicios-ia/{id}/creditos', 'IA\\ServicioIAController@creditos');\n        $ruta->post('servicios-ia/{id}/activar', 'IA\\ServicioIAController@activar');\n        $ruta->post('servicios-ia/{id}/desactivar', 'IA\\ServicioIAController@desactivar');\n        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n\n        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n            // Consumos\n            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n        });\n\n        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n            // Archivo\n            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n        });\n    });\n\n    // Perfiles laborales\n    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n\n    // Preguntas de ofertas laborales\n    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n\n    // Preguntas de videoentrevista\n    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n\n    // Vacantes\n    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n\n    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n\n    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n\n    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n            // Ajustes - General\n            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n            // Ajustes - Roles y permisos\n            $ruta->get('roles', 'Auth\\RolController@index');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n            // Ajustes - Deshacer acciones\n            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n            // Ajustes - Ofertas y anuncios\n            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n            // Webinars\n            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n\n            // Eventos\n            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n\n            // Guías\n            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n\n            // Tutoriales\n            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n\n            // Podcast\n            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n\n            // Capacitación\n            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n\n            // Certificación\n            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n        // Soportes\n        $ruta->resource('soportes', 'Soportes\\SoporteController');\n        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n\n        // Manuales\n        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n\n        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n            // Aplicantes\n            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n        });\n\n        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n            // Preguntas frecuentes\n            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n        });\n\n        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n            // Preguntas frecuentes reacciónes\n            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n        });\n    });\n\n    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n\n    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n        // Módulos\n        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n\n        // Auditorías\n        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n\n        // Accesos\n        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n\n        // Registros de actividad\n        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n\n        // Novedades\n        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n\n        // Países\n        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n\n        // Reportes\n        $ruta->resource('reportes', 'Reportes\\ReporteController');\n        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n\n        // Minería de datos.\n        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n\n        // Pruebas completas\n        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n    });\n\n    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n        // Ordenes de servicio\n        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n\n        // Ofertas laborales\n        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n        ->name('sin-disponibilidad-ofertas-laborales');\n        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n\n        // Vacantes\n        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n\n        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n        });\n\n        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n\n        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n\n        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n\n        // Etapas\n        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n\n        // Movimientos\n        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n\n        // Novedades\n        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n\n        $ruta->get('feedback', 'DashboardController@enConstruccion');\n        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n\n        // Procesos\n        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n\n        // Firmas de rutas\n        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n\n        // Perfiles pruebas\n        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n\n        // Agendas\n        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n\n        // Comentarios\n        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n\n        // Usuarios\n        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n    });\n\n    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n\n        // Debug de calificaciones de agendas\n        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n    });\n\n    // Suplantación de rol Administrador general\n    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n    });\n\n    // Suplantación de rol Administrador sucursal\n    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n    });\n\n    // Restablecimiento de la sesión original que había antes de la suplantación\n    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n    });\n\n    // Ruta para completar los datos de un usuario aplicante\n    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n    });\n\n    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n            ->name('ofertas-laborales.detalles-aplicante');\n        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n\n        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n    });\n\n    // Ofertas laborales\n    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n\n    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n\n    // Usuarios\n    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n\n    // Perfiles\n    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n\n    // Archivos\n    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n\n    // Menú clientes\n    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n\n    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n\n    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n\n    // Agendas - Accesible para aplicantes y usuarios de empresa\n    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n\n    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n\n    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n\n    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n\n    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n    $ruta->get('novedades', 'DashboardController@enConstruccion');\n\n    // Áreas\n    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n    $ruta->post('areas', 'Empresas\\AreaController@store');\n\n    // Cargos\n    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n    $ruta->post('cargos', 'Empresas\\CargoController@store');\n\n    // Niveles educativos\n    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n\n    // Áreas de estudio\n    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n\n    // Idiomas\n    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n\n    // Autenticación del websoket\n    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n\n    $ruta->get('/botones', function () {\n        return view('botones');\n    })->name('botones');\n\n    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n\n    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n    $ruta->get('analiticas', 'DashboardController@index');\n    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n\n    // Rutas de componentes de desarrollo\n    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n\n    // TODO: ruta de prueba, eliminarla próximamente\n    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n\n    // Rutas para las encuestas\n    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n});\n\n// Rutas no protegidas por autenticación\nRoute::group([\n    'namespace' => 'App\\Http\\Controllers'\n], function ($ruta) {\n    // Contraseñas\n    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n\n    // Empresas\n    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n\n    // Ordenes de servicio\n    $ruta->group([\n        'middleware' => 'orden-servicio-enlace-publico'\n    ], function ($ruta) {\n        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n    });\n\n    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n\n    // Países\n    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n\n    // Departamentos\n    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n\n    // Ciudades\n    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n\n    // Portales de empleo\n    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n\n    // Firmas de rutas\n    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n\n    // Archivos\n    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n\n    // Imagen de usuarios\n    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n\n    // Consultar reportes con firma\n    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n});\n\n/**\n * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n *\n * @author Fahibram Cárcamo\n */\nRoute::group([\n    'prefix'     => 'rutas-firmadas',\n    'middleware' => ['ruta-firmada'],\n    'namespace'  => 'App\\Http\\Controllers'\n], function ($ruta) {\n    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n});\n\n/**\n * Genera un token SSO firmado y redirige a WordPress.\n *\n * Flujo:\n *  - Requiere un usuario autenticado (será el admin en WP).\n *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n *  - Redirige al callback configurado en WordPress.\n *\n * @author Sergio Vargas\n */\nRoute::get('/sso/wordpress', function (Request $request) {\n    $user = $request->user();\n\n    $studentId   = $request->input('student_id');\n    $studentData = null;\n\n    if ($studentId) {\n        $student = App\\Models\\Usuarios\\User::find($studentId);\n\n        if ($student && $student->id !== $user->id) {\n            $studentData = [\n                'id'    => (string) $student->id,\n                'email' => $student->email,\n                'name'  => $student->getNombreCompletoAttribute(),\n            ];\n        }\n    }\n\n    $nonce = (string) Str::uuid();\n    $exp   = now()->addSeconds(60)->timestamp;\n\n    Cache::put(\"sso_nonce:{$nonce}\", [\n        'user_id' => $user->id,\n        'exp'     => $exp,\n    ], now()->addMinutes(5));\n\n    $payload = [\n        'sub'     => (string) $user->id,\n        'email'   => $user->email,\n        'name'    => $user->getNombreCompletoAttribute(),\n        'nonce'   => $nonce,\n        'exp'     => $exp,\n        'student' => $studentData,\n    ];\n\n    $token    = sso_sign_token($payload, config('services.sso.secret'));\n    $wp       = rtrim(config('services.sso.wp_url'), '/');\n    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n\n    return redirect()->away(\n        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n    );\n})->middleware('auth');\n","structuredPatch":[{"oldStart":262,"oldLines":6,"newStart":262,"newLines":7,"lines":[" ","     $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {","         // Planes","+        $ruta->get('planes/consumo', 'Planes\\PlanController@paginaConsumos');","         $ruta->resource('planes', 'Planes\\PlanController');","         $ruta->get('planes-listado', 'Planes\\PlanController@listado');","         $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"55a0a765-a41b-4576-b683-053f7f0f4893"}
{"parentUuid":"a7df7fe9-9e9e-449c-ad1f-dd42319b2ea4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DqaeBA2i9XZNY1qatfT9do","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The fix is applied. Now the route `planes/consumo` will be matched explicitly before the resource route tries to capture \"consumo\" as an `{id}` parameter.","signature":"EsMCCkYICxgCKkAzIOW8MS68DGjgknq5OvyoEsh5I73qxTRxC96Wyo5O3X7ik1QRIwIiOQQAn0inpOFaGMREFG4XrTyMgpuC/5eBEgxiKjD2Je+glVC48W0aDAuKA+UfK4OCoK6RHCIw9XRv6+CqBM1VsbpYTWfzbo0Jh1JmQrYdJbGsIkRm802kqrwAYQdK0NhkDt0hpf6MKqoBNupGZgG81+xcQWqwi4SmboJf53SynBIw+bOzXhkEmy1dAjN3lb0zFq8hGPW58L5OP0opcMXJTuUE++HlTOcB6zFl1nTI8NlrMrzhVVC6o0Ix31ir1i9hap1Th83swZascFPRh/9MAT/uQ6CniKBKmuiB26dtW1nNS49SHLTBNnr+TylqtRu/X4iESuVx51swlIXIcGKIxfoKqEVeEABA9B7q8en3kqRX3/8YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":351,"cache_read_input_tokens":70063,"cache_creation":{"ephemeral_5m_input_tokens":351,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8LsRAD8RnLssWQPyqC","type":"assistant","uuid":"688e8d38-edcf-44b2-b755-206c42a4810c","timestamp":"2026-01-22T21:29:08.414Z"}
{"parentUuid":"688e8d38-edcf-44b2-b755-206c42a4810c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DqaeBA2i9XZNY1qatfT9do","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Se agregó la ruta `planes/consumo` antes del resource en `routes/web.php:265`. Ahora Laravel matcheará la ruta explícita primero, evitando que \"consumo\" sea interpretado como el parámetro `{id}` del resource."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":351,"cache_read_input_tokens":70063,"cache_creation":{"ephemeral_5m_input_tokens":351,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8LsRAD8RnLssWQPyqC","type":"assistant","uuid":"8c993a66-f41b-40e2-b59f-853ad9f3bfb8","timestamp":"2026-01-22T21:29:09.460Z"}
{"parentUuid":"8c993a66-f41b-40e2-b59f-853ad9f3bfb8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"system","subtype":"turn_duration","durationMs":99651,"timestamp":"2026-01-22T21:29:09.644Z","uuid":"deb65628-41b9-4f14-ac6f-8dd84e6c7ff1","isMeta":false}
{"type":"file-history-snapshot","messageId":"35e0cbb8-8114-41a4-b463-cdf5b45cd9b0","snapshot":{"messageId":"35e0cbb8-8114-41a4-b463-cdf5b45cd9b0","trackedFileBackups":{"app\\Console\\Commands\\Empresas\\ActivarEInactivarPlanesCommand.php":{"backupFileName":"b4706ac638207036@v2","version":2,"backupTime":"2026-01-22T19:45:29.008Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"115edace5e384ff2@v3","version":3,"backupTime":"2026-01-22T21:23:41.745Z"},"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"87ffcf5aa4ef1291@v2","version":2,"backupTime":"2026-01-22T21:23:41.747Z"},"C:\\Users\\sergio\\.claude\\plans\\atomic-coalescing-meadow.md":{"backupFileName":"c4cfc9ae38d8c071@v2","version":2,"backupTime":"2026-01-22T21:29:27.166Z"},"routes\\web.php":{"backupFileName":"8d4f24f72d6f32f1@v1","version":1,"backupTime":"2026-01-22T21:29:06.063Z"}},"timestamp":"2026-01-22T21:29:27.164Z"},"isSnapshotUpdate":false}
{"parentUuid":"deb65628-41b9-4f14-ac6f-8dd84e6c7ff1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":"sigue igual App\\Http\\Controllers\\Planes\\PlanController::show(): Argument #1 ($id) must be of type int, string given, called in C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\vendor\\laravel\\framework\\src\\Illuminate\\Routing\\Controller.php on line 54"},"uuid":"35e0cbb8-8114-41a4-b463-cdf5b45cd9b0","timestamp":"2026-01-22T21:29:27.120Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"35e0cbb8-8114-41a4-b463-cdf5b45cd9b0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Kgk7esRnhP4bnuC2ZmUVMV","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The route fix didn't work. This could be because Laravel caches routes or there might be another issue. Let me check if there's a route cache, or if the route definition order in the file is different. Let me also check if maybe the route is being registered somewhere else or if there's another resource route for \"planes\".\n\nActually, the issue might be that the route `planes/consumo` is correct but there could be a route cache. Let me check if there's a route cache file, or let me look at the actual route list.\n\nWait - another possibility is that the route might be defined with a prefix. Let me look at what wraps this group - there might be a prefix or namespace configuration that changes the URL.\n\nLet me also try running `php artisan route:list` to see all registered routes.","signature":"ErcHCkYICxgCKkCr+iMoEYdOh75o+GhWM3KJ9gens5XU4zY9nUmtm7vx7n7ksumnzZR93m/lxm8Z4daGcNEFsWZMy4HPgqmEANFbEgxrLaHF7oqsulTvnL4aDBGuns+uvJWJwpbsoiIwrE0y6xzK9MgqJId2bUZTbJCnsOywX3gTWzxFBAKEcQC5AaJNgpWPMX3zQZkgSNFiKp4GkcqxDdNAYuy2PbomxrPMO16zi+S2vy0sc47PdUOx+HMHjcgoB9RDtYRnW9NkA/yOtV3sNUid/KX8aVLEDsUJqUuyO5BPkNV+yKjNTZLzkIe4wnW/7Dwp7F3P1qt9XZEHJ8P3WxigtrphWpLO2AChbzQhoxFeadnhOpQSHml9xomh0CjbooRysL8QeUawgOZODfgt/34XT9g8rXsGzIFKSyda+W4OkK+b5J9k8Dgm2u+rb2U2krbHg+suz/YhjTDrrZl1xlxdFKQcbsnd0Np3+Vi1Q1iyShdj1z0HNJi2Fs7P25KTaceVyZ3juJNl3hKfdCVGEoJakIcDTyFrtE+yzpG6dhG36+tHseexrJ7A7k7HprHEyS5rMc2QcFxpJBTlhVkKoDXKl3o8akth0xQc+AlgFX4tAVDH1DoqcdDuJADcfwFUSFh2jsmc1C3EgKygglh/jFHj2qQVJK3j8BkfSLKTrSRkgSUDRo0adJAzON+YmCx66E63/24OuVUBusB4X9FeiOdgdnUpby+0GLyMXR0oEfipFGfZbVPeEbgDfvJh/JyA4Onj/K9JuRC8etRp6TmeP9Eh52Aq8UHiv/aWrR9wdECfFnVGFMsD+Q8U7qWiVlsMS/G5w6doy8P9QkzoRiURjlHle92rrdTxT60PWd46DIrXDivmU8Mgrx9rknGE5dBlO3DFywSr8H2se98jIqnWlT12oCk9ir//Q9CeYOJOW17r7Rdejsrppxm9m/mG/DA4H2aU+In80Z/t0ffK3UZ3Grj8YQzOIGHo43D+GpWJB0Z4EEwH552ltIaDyKwu9Kv58br5DKc4++R0NI0RLpkzt2zLfBNNcyywz8GrYz9T9LJr5C5Pjh4ycvMrJ/KCM0FGN/OdJc6z743Xl4AmvRe3m3419fm8FNPEQmWjDJ+06FCXKoHzkVX6bQ5PeQEvUC5m2gd0x5F3NMolPdDAgpO9cCXIAKlOudxwVqPCnHcSFyKLYbHqK2jRVwz5eejQCpCrb6Bpn7KqXKKX+krpIrLVkcb6O2LJkRBWwrMvOeXM65cWaKhBoajDQ4TgGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":81,"cache_read_input_tokens":70538,"cache_creation":{"ephemeral_5m_input_tokens":81,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP8NQUEHShCaMkNvhikv","type":"assistant","uuid":"06c86e52-3431-467e-8150-38e17c834654","timestamp":"2026-01-22T21:29:33.475Z"}
{"parentUuid":"06c86e52-3431-467e-8150-38e17c834654","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Kgk7esRnhP4bnuC2ZmUVMV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01W12sqadkw7iAy5HyAoENDN","name":"Bash","input":{"command":"cd C:/Users/sergio/proyectos/Psicoalianza-2 && php artisan route:list --path=planes/consumo 2>&1 | head -20","description":"List routes matching planes/consumo"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":81,"cache_read_input_tokens":70538,"cache_creation":{"ephemeral_5m_input_tokens":81,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP8NQUEHShCaMkNvhikv","type":"assistant","uuid":"436e098d-5578-4fb5-9dac-d48cb8ef29a9","timestamp":"2026-01-22T21:29:34.705Z"}
{"parentUuid":"436e098d-5578-4fb5-9dac-d48cb8ef29a9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"type":"bash_progress","output":"","fullOutput":"","elapsedTimeSeconds":1,"totalLines":0},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_01W12sqadkw7iAy5HyAoENDN","uuid":"3e56348d-b515-44a0-b1c3-b326a53e299b","timestamp":"2026-01-22T21:29:37.763Z"}
{"parentUuid":"436e098d-5578-4fb5-9dac-d48cb8ef29a9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01W12sqadkw7iAy5HyAoENDN","type":"tool_result","content":"  \u001b[37;41m ERROR \u001b[39;49m Your application doesn't have any routes matching the given criteria.","is_error":false}]},"uuid":"3b227eb4-4553-4695-b46c-a001b6c4c0d2","timestamp":"2026-01-22T21:29:38.097Z","toolUseResult":{"stdout":"  \u001b[37;41m ERROR \u001b[39;49m Your application doesn't have any routes matching the given criteria.\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"436e098d-5578-4fb5-9dac-d48cb8ef29a9"}
{"parentUuid":"3b227eb4-4553-4695-b46c-a001b6c4c0d2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PJ2Kjhh2ScRaW6BRhpV1VB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The route is not being registered. There might be a prefix or the group structure could affect how routes are resolved. Let me look at the broader context of the route file to see if there's a prefix or namespace wrapping the group.","signature":"EpEDCkYICxgCKkCA6lx7L13c5EOyruEvHcUoNUC5a4rc/wKr7eI97LahH7aERY1he5dh6kB6QW41eypEFUsFK3oVqqQxuBSa3j0UEgzkNTbyvTDGiB4KurgaDEn2qeQbJ0xB38OoxiIwVLpLRTrl+a3RlC4dOpGlhKKj1kIWyOAICKSfV0EngOssWxWo+45tpkrTibm42mh8KvgBTT6XxT9qAG3y2ZuWrhKJ6lLGAuVwfmT3X+Cud7ubmgZ6KL3aw7Vlz/C59OXEV6NIBIwliZwy5+1fBBYzqZ65FrK4xBZTih25Th3ltzaq10c1QbiGBSR0Pt1+AE76Z05lFa5x8iZ0egw9NdSUZEhjBeMlVsa6DHyTgscyMehyEmd2Eln+XK9kwxcCZ9LDiOEvGmdLKn+GuOIi4H+Kz0iZ7DpDFjUs/oPZ15PxgNbpUrndOHI7oDPP9r5Z1dS8rq/ynGxEGVA8YL7ypfY7WPHkfjOPPveI+W4+lI1vuFubX0426DiClUXQNEQEqsxqHhzR8mdWKRFZu28YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":341,"cache_read_input_tokens":70619,"cache_creation":{"ephemeral_5m_input_tokens":341,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP8PEFqwWVZuHGedfa2Q","type":"assistant","uuid":"3af9a677-ccd6-4e07-81bd-4eab0c38ce0b","timestamp":"2026-01-22T21:29:41.284Z"}
{"parentUuid":"3af9a677-ccd6-4e07-81bd-4eab0c38ce0b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PJ2Kjhh2ScRaW6BRhpV1VB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018HQYyCLisXhC986kK8558v","name":"Bash","input":{"command":"cd C:/Users/sergio/proyectos/Psicoalianza-2 && php artisan route:list --path=planes 2>&1 | head -30","description":"List all routes matching \"planes\""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":341,"cache_read_input_tokens":70619,"cache_creation":{"ephemeral_5m_input_tokens":341,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP8PEFqwWVZuHGedfa2Q","type":"assistant","uuid":"0d26adf3-8ba8-4ad6-a7fa-e31c9ca059e3","timestamp":"2026-01-22T21:29:42.140Z"}
{"parentUuid":"0d26adf3-8ba8-4ad6-a7fa-e31c9ca059e3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"type":"bash_progress","output":"","fullOutput":"","elapsedTimeSeconds":1,"totalLines":0},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_018HQYyCLisXhC986kK8558v","uuid":"e3d5748e-dd6d-4151-95d6-e55f142e4817","timestamp":"2026-01-22T21:29:45.070Z"}
{"parentUuid":"0d26adf3-8ba8-4ad6-a7fa-e31c9ca059e3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018HQYyCLisXhC986kK8558v","type":"tool_result","content":"  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mdatos-empresas-planes\u001b[39m\u001b[38;2;108;114;128m .. generated::z7xmvUeLvXxh0WKL › Empresas\\EmpresaPlanController@planesEmpresas\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mempresas-planes\u001b[39m\u001b[38;2;108;114;128m ....................... empresas-planes.store › Empresas\\EmpresaPlanController@store\u001b[39m\r\n  \u001b[33mPATCH\u001b[39m           \u001b[37mempresas-planes-actualizar/\u001b[39m\u001b[33m{id}\u001b[39m\u001b[38;2;108;114;128m generated::2Wt4WwP6mfuCHYVn › Empresas\\EmpresaPlanController@actual…\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mempresas-planes-descargar-factura/\u001b[39m\u001b[33m{archivo_id}\u001b[39m\u001b[38;2;108;114;128m generated::37s7yJZwu9OcI0yB › Empresas\\EmpresaPlanCo…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mempresas-planes-funcionalidades-listado\u001b[39m\u001b[38;2;108;114;128m generated::URqr4zovuNXQM7Wm › Empresas\\EmpresaPlanFuncional…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mempresas-planes-listado-tabla/\u001b[39m\u001b[33m{empresa_id}\u001b[39m\u001b[38;2;108;114;128m generated::Rv2DmM5YyLGc8kg8 › Empresas\\EmpresaPlanContro…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mempresas-planes/\u001b[39m\u001b[33m{empresas_plane}\u001b[39m\u001b[38;2;108;114;128m ........ empresas-planes.show › Empresas\\EmpresaPlanController@show\u001b[39m\r\n  \u001b[33mPUT\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[33mPATCH\u001b[39m       \u001b[37mempresas-planes/\u001b[39m\u001b[33m{empresas_plane}\u001b[39m\u001b[38;2;108;114;128m .... empresas-planes.update › Empresas\\EmpresaPlanController@update\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mempresas-planes/\u001b[39m\u001b[33m{empresas_plane}\u001b[39m\u001b[37m/edit\u001b[39m\u001b[38;2;108;114;128m ... empresas-planes.edit › Empresas\\EmpresaPlanController@edit\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mexportar-datos-empresas-planes\u001b[39m\u001b[38;2;108;114;128m generated::A3a8PrPPj6wm2gKV › Empresas\\EmpresaPlanController@exporta…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mfuncionalidades-planes-historial-cambios/\u001b[39m\u001b[33m{plan_id}\u001b[39m\u001b[38;2;108;114;128m generated::hsUAvRqcGAZjlZuF › Planes\\Funcionalid…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mlistado-planes-cliente\u001b[39m\u001b[38;2;108;114;128m .... generated::D7epKBflfQ47XRtb › Planes\\PlanController@listadoPlanesEmpresa\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes\u001b[39m\u001b[38;2;108;114;128m .................................................. planes.index › Planes\\PlanController@index\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mplanes\u001b[39m\u001b[38;2;108;114;128m .................................................. planes.store › Planes\\PlanController@store\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-accion\u001b[39m\u001b[38;2;108;114;128m ..................... generated::gWrUvmQ7mKW4CzNm › DashboardController@enConstruccion\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-accion-aplicantes\u001b[39m\u001b[38;2;108;114;128m generated::qrhmvFZ45PWZ9TfZ › DashboardController@paginaPlanesAccionAplica…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-archivados\u001b[39m\u001b[38;2;108;114;128m ........................ generated::xIQv27S6Ij1UVrmt › Planes\\PlanController@index\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mplanes-archivar/\u001b[39m\u001b[33m{id}\u001b[39m\u001b[38;2;108;114;128m .................. generated::4Aa30JQHhxsIhhRk › Planes\\PlanController@archivar\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-clientes\u001b[39m\u001b[38;2;108;114;128m ................. generated::andacgFCHelu7tHJ › Planes\\PlanController@planesClientes\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mplanes-clonar/\u001b[39m\u001b[33m{id}\u001b[39m\u001b[38;2;108;114;128m ...................... generated::Lja6lldGtBJrWgsM › Planes\\PlanController@clonar\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-creditos\u001b[39m\u001b[38;2;108;114;128m ......................... planes-creditos.index › Planes\\PlanCreditoController@index\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mplanes-creditos\u001b[39m\u001b[38;2;108;114;128m ......................... planes-creditos.store › Planes\\PlanCreditoController@store\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-creditos/create\u001b[39m\u001b[38;2;108;114;128m ................ planes-creditos.create › Planes\\PlanCreditoController@create\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-creditos/\u001b[39m\u001b[33m{planes_credito}\u001b[39m\u001b[38;2;108;114;128m .......... planes-creditos.show › Planes\\PlanCreditoController@show\u001b[39m\r\n  \u001b[33mPUT\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[33mPATCH\u001b[39m       \u001b[37mplanes-creditos/\u001b[39m\u001b[33m{planes_credito}\u001b[39m\u001b[38;2;108;114;128m ...... planes-creditos.update › Planes\\PlanCreditoController@update\u001b[39m\r\n  \u001b[31mDELETE\u001b[39m          \u001b[37mplanes-creditos/\u001b[39m\u001b[33m{planes_credito}\u001b[39m\u001b[38;2;108;114;128m .... planes-creditos.destroy › Planes\\PlanCreditoController@destroy\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-creditos/\u001b[39m\u001b[33m{planes_credito}\u001b[39m\u001b[37m/edit\u001b[39m\u001b[38;2;108;114;128m ..... planes-creditos.edit › Planes\\PlanCreditoController@edit\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mplanes-exportar\u001b[39m\u001b[38;2;108;114;128m .................. generated::zpnySSi6IsaC4YGT › Planes\\PlanController@exportarExcel\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-historial-cambios/\u001b[39m\u001b[33m{id}\u001b[39m\u001b[38;2;108;114;128m . generated::YafOnjNzzbE5duDV › Planes\\PlanController@historialCambios\u001b[39m","is_error":false}]},"uuid":"ca8d12e4-172a-42da-abe3-41d4ec4cf812","timestamp":"2026-01-22T21:29:45.296Z","toolUseResult":{"stdout":"  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mdatos-empresas-planes\u001b[39m\u001b[38;2;108;114;128m .. generated::z7xmvUeLvXxh0WKL › Empresas\\EmpresaPlanController@planesEmpresas\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mempresas-planes\u001b[39m\u001b[38;2;108;114;128m ....................... empresas-planes.store › Empresas\\EmpresaPlanController@store\u001b[39m\r\n  \u001b[33mPATCH\u001b[39m           \u001b[37mempresas-planes-actualizar/\u001b[39m\u001b[33m{id}\u001b[39m\u001b[38;2;108;114;128m generated::2Wt4WwP6mfuCHYVn › Empresas\\EmpresaPlanController@actual…\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mempresas-planes-descargar-factura/\u001b[39m\u001b[33m{archivo_id}\u001b[39m\u001b[38;2;108;114;128m generated::37s7yJZwu9OcI0yB › Empresas\\EmpresaPlanCo…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mempresas-planes-funcionalidades-listado\u001b[39m\u001b[38;2;108;114;128m generated::URqr4zovuNXQM7Wm › Empresas\\EmpresaPlanFuncional…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mempresas-planes-listado-tabla/\u001b[39m\u001b[33m{empresa_id}\u001b[39m\u001b[38;2;108;114;128m generated::Rv2DmM5YyLGc8kg8 › Empresas\\EmpresaPlanContro…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mempresas-planes/\u001b[39m\u001b[33m{empresas_plane}\u001b[39m\u001b[38;2;108;114;128m ........ empresas-planes.show › Empresas\\EmpresaPlanController@show\u001b[39m\r\n  \u001b[33mPUT\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[33mPATCH\u001b[39m       \u001b[37mempresas-planes/\u001b[39m\u001b[33m{empresas_plane}\u001b[39m\u001b[38;2;108;114;128m .... empresas-planes.update › Empresas\\EmpresaPlanController@update\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mempresas-planes/\u001b[39m\u001b[33m{empresas_plane}\u001b[39m\u001b[37m/edit\u001b[39m\u001b[38;2;108;114;128m ... empresas-planes.edit › Empresas\\EmpresaPlanController@edit\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mexportar-datos-empresas-planes\u001b[39m\u001b[38;2;108;114;128m generated::A3a8PrPPj6wm2gKV › Empresas\\EmpresaPlanController@exporta…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mfuncionalidades-planes-historial-cambios/\u001b[39m\u001b[33m{plan_id}\u001b[39m\u001b[38;2;108;114;128m generated::hsUAvRqcGAZjlZuF › Planes\\Funcionalid…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mlistado-planes-cliente\u001b[39m\u001b[38;2;108;114;128m .... generated::D7epKBflfQ47XRtb › Planes\\PlanController@listadoPlanesEmpresa\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes\u001b[39m\u001b[38;2;108;114;128m .................................................. planes.index › Planes\\PlanController@index\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mplanes\u001b[39m\u001b[38;2;108;114;128m .................................................. planes.store › Planes\\PlanController@store\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-accion\u001b[39m\u001b[38;2;108;114;128m ..................... generated::gWrUvmQ7mKW4CzNm › DashboardController@enConstruccion\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-accion-aplicantes\u001b[39m\u001b[38;2;108;114;128m generated::qrhmvFZ45PWZ9TfZ › DashboardController@paginaPlanesAccionAplica…\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-archivados\u001b[39m\u001b[38;2;108;114;128m ........................ generated::xIQv27S6Ij1UVrmt › Planes\\PlanController@index\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mplanes-archivar/\u001b[39m\u001b[33m{id}\u001b[39m\u001b[38;2;108;114;128m .................. generated::4Aa30JQHhxsIhhRk › Planes\\PlanController@archivar\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-clientes\u001b[39m\u001b[38;2;108;114;128m ................. generated::andacgFCHelu7tHJ › Planes\\PlanController@planesClientes\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mplanes-clonar/\u001b[39m\u001b[33m{id}\u001b[39m\u001b[38;2;108;114;128m ...................... generated::Lja6lldGtBJrWgsM › Planes\\PlanController@clonar\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-creditos\u001b[39m\u001b[38;2;108;114;128m ......................... planes-creditos.index › Planes\\PlanCreditoController@index\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mplanes-creditos\u001b[39m\u001b[38;2;108;114;128m ......................... planes-creditos.store › Planes\\PlanCreditoController@store\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-creditos/create\u001b[39m\u001b[38;2;108;114;128m ................ planes-creditos.create › Planes\\PlanCreditoController@create\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-creditos/\u001b[39m\u001b[33m{planes_credito}\u001b[39m\u001b[38;2;108;114;128m .......... planes-creditos.show › Planes\\PlanCreditoController@show\u001b[39m\r\n  \u001b[33mPUT\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[33mPATCH\u001b[39m       \u001b[37mplanes-creditos/\u001b[39m\u001b[33m{planes_credito}\u001b[39m\u001b[38;2;108;114;128m ...... planes-creditos.update › Planes\\PlanCreditoController@update\u001b[39m\r\n  \u001b[31mDELETE\u001b[39m          \u001b[37mplanes-creditos/\u001b[39m\u001b[33m{planes_credito}\u001b[39m\u001b[38;2;108;114;128m .... planes-creditos.destroy › Planes\\PlanCreditoController@destroy\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-creditos/\u001b[39m\u001b[33m{planes_credito}\u001b[39m\u001b[37m/edit\u001b[39m\u001b[38;2;108;114;128m ..... planes-creditos.edit › Planes\\PlanCreditoController@edit\u001b[39m\r\n  \u001b[33mPOST\u001b[39m            \u001b[37mplanes-exportar\u001b[39m\u001b[38;2;108;114;128m .................. generated::zpnySSi6IsaC4YGT › Planes\\PlanController@exportarExcel\u001b[39m\r\n  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m        \u001b[37mplanes-historial-cambios/\u001b[39m\u001b[33m{id}\u001b[39m\u001b[38;2;108;114;128m . generated::YafOnjNzzbE5duDV › Planes\\PlanController@historialCambios\u001b[39m\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"0d26adf3-8ba8-4ad6-a7fa-e31c9ca059e3"}
{"parentUuid":"ca8d12e4-172a-42da-abe3-41d4ec4cf812","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HGzbL95DzX8jiTX9TDQBYg","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I can see that `planes/consumo` is not in the list but `planes` resource routes are there. Let me check more output:","signature":"Ep0CCkYICxgCKkDgeoMOg/Bm9CyIzoha190N3jPPRau0Z1AZPsW9t//P4MLmbHIK84Z6rBQfpXY00g4e6YBIQLwxF4zg7kL14rDSEgypKA6EcO9HOXEGjkYaDJA3bBN+hGp4JB20GyIwPQ2HmJI6AeXZAsZYj7XT0eFEpybBEQQEtSh/B+0Se0Pd+H34uB0+RXN7ANKR3QbhKoQBafl4ydYGVlqqi+YxrkGFgwRGOyqN6ZiJM3h/AabZDoXQyCbDKahxXttdCr0SMOGayQFKns5HlCn0yljBsuZzDuqaPTGImRy4npGTxyNbKQ6eWaKkpGUpWclsJ5/O8E7WMB1jbhOq0eylOtq55MrRBFjsXIGgZjh8NsgbVhQ2Vw3EbijqGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2827,"cache_read_input_tokens":70960,"cache_creation":{"ephemeral_5m_input_tokens":2827,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8Pks6f7eTs6fBsShXC","type":"assistant","uuid":"724073a7-9df9-4361-88b1-8cbeabf21c9c","timestamp":"2026-01-22T21:29:48.106Z"}
{"parentUuid":"724073a7-9df9-4361-88b1-8cbeabf21c9c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HGzbL95DzX8jiTX9TDQBYg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DXW4DrzZotKvmu94YmxRrU","name":"Bash","input":{"command":"cd C:/Users/sergio/proyectos/Psicoalianza-2 && php artisan route:list --path=planes 2>&1 | grep consumo","description":"Check if planes/consumo route is registered"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2827,"cache_read_input_tokens":70960,"cache_creation":{"ephemeral_5m_input_tokens":2827,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8Pks6f7eTs6fBsShXC","type":"assistant","uuid":"c2752b3a-c8dd-458e-ad89-75eff9a42fd2","timestamp":"2026-01-22T21:29:49.756Z"}
{"parentUuid":"c2752b3a-c8dd-458e-ad89-75eff9a42fd2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"type":"bash_progress","output":"","fullOutput":"","elapsedTimeSeconds":1,"totalLines":0},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_01DXW4DrzZotKvmu94YmxRrU","uuid":"a317e421-1de0-4b6c-b219-295c859c43ab","timestamp":"2026-01-22T21:29:52.626Z"}
{"parentUuid":"c2752b3a-c8dd-458e-ad89-75eff9a42fd2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DXW4DrzZotKvmu94YmxRrU","type":"tool_result","content":"","is_error":false}]},"uuid":"0b4f6a9c-ebbf-4788-962f-9b6ab8a21d30","timestamp":"2026-01-22T21:29:52.850Z","toolUseResult":{"stdout":"","stderr":"","interrupted":false,"isImage":false,"returnCodeInterpretation":"No matches found"},"sourceToolAssistantUUID":"c2752b3a-c8dd-458e-ad89-75eff9a42fd2"}
{"parentUuid":"0b4f6a9c-ebbf-4788-962f-9b6ab8a21d30","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NHdogWP7TD9TPuyaMW6xE1","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The route `planes/consumo` is not being registered at all! Let me check if there's a route cache that needs to be cleared.","signature":"EqMCCkYICxgCKkAgh7C+CUYYqcOYgjaJ852JJ2yZIwCXPfFXTBcI6WpwJS26W+qzKQ9v0i+kCcKpkMFCCzelHpPyHbzjKtgz9ZsdEgy4lmVMoXNW7SIkbD8aDNkzc11k+3FxCPYvCSIwWwwnUuj4952/Jl7tJKSDWEvmL6E6S+BlT6dOYl05vC03ehJ6IJS21P4xXfkx6UM/KooBKUcSAKN6FtMkz1jKnBKeS41VQ9TN83fQo9R3CCuh8bC7GSUVoZOenMR555lZywT0Ljk/UJlJxRhEsQtg3IdGwD7JGiyLnH+d/HmotTPfycnDYYNfLYuIqE6V5rHAZSdMJ0WtwdDEMn7YRkhmcM1l0NrOD9RsK3zRCPvkJ5EPbwWrcnN9X5UgpkErGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":187,"cache_read_input_tokens":73787,"cache_creation":{"ephemeral_5m_input_tokens":187,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8QKD2ffTZqnG6Q3dHD","type":"assistant","uuid":"36c22b3b-e62e-445e-bcd5-b864178c4ebd","timestamp":"2026-01-22T21:29:55.463Z"}
{"parentUuid":"36c22b3b-e62e-445e-bcd5-b864178c4ebd","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NHdogWP7TD9TPuyaMW6xE1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SQpVXpaNhce4oKg43R2ETF","name":"Bash","input":{"command":"cd C:/Users/sergio/proyectos/Psicoalianza-2 && php artisan route:clear 2>&1","description":"Clear route cache"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":187,"cache_read_input_tokens":73787,"cache_creation":{"ephemeral_5m_input_tokens":187,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8QKD2ffTZqnG6Q3dHD","type":"assistant","uuid":"d8371711-2c53-4c47-aabe-e7d2fce12b4a","timestamp":"2026-01-22T21:29:56.036Z"}
{"parentUuid":"d8371711-2c53-4c47-aabe-e7d2fce12b4a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SQpVXpaNhce4oKg43R2ETF","type":"tool_result","content":"  \u001b[37;44m INFO \u001b[39;49m Route cache cleared successfully.","is_error":false}]},"uuid":"ba23dabf-2392-4738-bd1b-ce069f665c5d","timestamp":"2026-01-22T21:29:57.500Z","toolUseResult":{"stdout":"  \u001b[37;44m INFO \u001b[39;49m Route cache cleared successfully.\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"d8371711-2c53-4c47-aabe-e7d2fce12b4a"}
{"parentUuid":"ba23dabf-2392-4738-bd1b-ce069f665c5d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_012VmscrV1Q59iMx2QU8LTvu","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"There was a route cache! Now let me verify the route is registered:","signature":"EusBCkYICxgCKkAi18uVvzZXcO2WXhOcyuowIhtco3MlgulYTbRJJcoz+IDRVItlvlkKbhidN4Jbs94HDNODtObxu+zj0PHG2s03EgxMZTpqJ6vpZuF7F/IaDB+GqGZG5w6PT/LXGyIw6vbENcQCMbNeYmHNS0CsjaGYF8fo94tRISrBgrk28Vbx64CmLOIZv87Q2lP2I+3JKlNfRLwX3vAK0+ob2J6kRG5Wlg3iKYbrUXXHgYyuBsDvKVGw2rqtlzanVU8OTVjHS5w2jFTLA/c9KYZRz+3fNpy8GJwp46hpL4aIZlW9t8VpOfiLGhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":174,"cache_read_input_tokens":73974,"cache_creation":{"ephemeral_5m_input_tokens":174,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8Qf8bAZ2fkYbn9Btzx","type":"assistant","uuid":"74bfe6aa-053b-4cd9-8511-d88dfb8cb1b3","timestamp":"2026-01-22T21:30:00.359Z"}
{"parentUuid":"74bfe6aa-053b-4cd9-8511-d88dfb8cb1b3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_012VmscrV1Q59iMx2QU8LTvu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015NUNKWByoserPRTZRB1v13","name":"Bash","input":{"command":"cd C:/Users/sergio/proyectos/Psicoalianza-2 && php artisan route:list --path=planes/consumo 2>&1","description":"Verify planes/consumo route after cache clear"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":174,"cache_read_input_tokens":73974,"cache_creation":{"ephemeral_5m_input_tokens":174,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8Qf8bAZ2fkYbn9Btzx","type":"assistant","uuid":"f1440afb-25a6-4a05-b017-e2ac7e69e6b8","timestamp":"2026-01-22T21:30:01.164Z"}
{"parentUuid":"f1440afb-25a6-4a05-b017-e2ac7e69e6b8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"progress","data":{"type":"bash_progress","output":"","fullOutput":"","elapsedTimeSeconds":1,"totalLines":0},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_015NUNKWByoserPRTZRB1v13","uuid":"288566a6-aaa2-4ca7-9292-844806d3bb47","timestamp":"2026-01-22T21:30:03.782Z"}
{"parentUuid":"f1440afb-25a6-4a05-b017-e2ac7e69e6b8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015NUNKWByoserPRTZRB1v13","type":"tool_result","content":"  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m       \u001b[37mplanes/consumo\u001b[39m\u001b[38;2;108;114;128m ................................................. Planes\\PlanController@paginaConsumos\u001b[39m\r\n\r\n                                                                                                    \u001b[34;1mShowing [1] routes\u001b[39;22m","is_error":false}]},"uuid":"910c8ef0-c108-4cf4-a950-6207161ea920","timestamp":"2026-01-22T21:30:04.082Z","toolUseResult":{"stdout":"  \u001b[34mGET\u001b[39m\u001b[38;2;108;114;128m|\u001b[39m\u001b[38;2;108;114;128mHEAD\u001b[39m       \u001b[37mplanes/consumo\u001b[39m\u001b[38;2;108;114;128m ................................................. Planes\\PlanController@paginaConsumos\u001b[39m\r\n\r\n                                                                                                    \u001b[34;1mShowing [1] routes\u001b[39;22m\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"f1440afb-25a6-4a05-b017-e2ac7e69e6b8"}
{"parentUuid":"910c8ef0-c108-4cf4-a950-6207161ea920","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XhPpFBhxenx8hgyLmKUYVB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The route is now registered after clearing the route cache. The problem was that Laravel had a route cache that didn't include the new route. The fix is working correctly now.","signature":"EtgCCkYICxgCKkCCONE1t/EVtdQHQafHao0Mp/b8W+//dlJ8HdOCUgOrUqNQrCywgR4YzfgnZfEax2WxDfMNFzB/2t7StfflFk89EgxO6tnM4CE0oSUqDioaDJlQU40rz/0DLvI25yIwSTLnesppxocPiHCaE9Io7uwE2+UR6k/hiXkqFgbY5Ys2yxrtyECieiz4qrzuSTV4Kr8BYrymxfyibsH1Igmq7yD4NRshwNtdk4XdsA4QsOlN8kslhmhQwZF6+x4Q3Bs5P19G2cO0VV9ezbr06kv9mAP2HKTip8n7sv19IUUVVUhcRBjuHkMvvvcocDQyCIyCCMFuCCZnsGGw0j0dRlYngLvoJU1OJqqbLtDilETTt1SwHSxx2m6dS74XTEHGfxIYVvMmo3zfraGczAlq+Imo6M1xT66y/ljf5mATNPDvJ73XeDc5IRscc2h7GJ3McPaJkeQYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":265,"cache_read_input_tokens":74148,"cache_creation":{"ephemeral_5m_input_tokens":265,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8R9Kz95Tbw6yJY4VkV","type":"assistant","uuid":"f75c5372-d2e4-4eaf-abf6-c105380df582","timestamp":"2026-01-22T21:30:07.556Z"}
{"parentUuid":"f75c5372-d2e4-4eaf-abf6-c105380df582","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XhPpFBhxenx8hgyLmKUYVB","type":"message","role":"assistant","content":[{"type":"text","text":"El problema era que Laravel tenía un **cache de rutas**. Después de limpiar el cache con `route:clear`, la ruta `planes/consumo` se registra correctamente. Prueba acceder de nuevo."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":265,"cache_read_input_tokens":74148,"cache_creation":{"ephemeral_5m_input_tokens":265,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXP8R9Kz95Tbw6yJY4VkV","type":"assistant","uuid":"231c9ba4-c1a2-4fb5-b460-55bbf874af37","timestamp":"2026-01-22T21:30:08.778Z"}
{"parentUuid":"231c9ba4-c1a2-4fb5-b460-55bbf874af37","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"84fabe1a-5f73-466e-bbff-2169b8ab1373","version":"2.1.14","gitBranch":"pre-main","slug":"atomic-coalescing-meadow","type":"system","subtype":"turn_duration","durationMs":41745,"timestamp":"2026-01-22T21:30:08.912Z","uuid":"ca1c9bb0-8e75-4900-9542-db4ab8596c44","isMeta":false}
{"type":"summary","summary":"Fix Code Style and Magic Numbers in Laravel","leafUuid":"231c9ba4-c1a2-4fb5-b460-55bbf874af37"}
