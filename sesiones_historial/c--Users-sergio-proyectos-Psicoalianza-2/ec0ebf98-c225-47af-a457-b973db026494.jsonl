{"type":"file-history-snapshot","messageId":"73a75574-b2b4-452a-9221-9c8a41eb4e68","snapshot":{"messageId":"73a75574-b2b4-452a-9221-9c8a41eb4e68","trackedFileBackups":{},"timestamp":"2026-02-11T15:32:02.336Z"},"isSnapshotUpdate":false}
{"parentUuid":"27b4bcef-2911-4de3-8352-e032221f9644","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"27b14693-5a2b-4094-8670-56e4ef72c70d","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","type":"user","message":{"role":"user","content":[{"type":"text","text":"[Request interrupted by user for tool use]"}]},"uuid":"7c88ee1c-b501-494c-b594-e5f03d0edb30","timestamp":"2026-02-11T15:32:02.265Z"}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","type":"user","message":{"role":"user","content":"Implement the following plan:\n\n# Fix: Mostrar mensaje de descarte tras modal de Competencias por mejorar\n\n## Contexto\n\nEn la vista `vacantes-detalle/{id}`, cuando un reclutador pasa un candidato a \"Contratados\" y este tiene pruebas con id 7 o 12, se abre el modal \"Competencias por mejorar\". Al darle \"Continuar\", se ejecuta directamente el movimiento de etapa **sin mostrar** el SweetAlert de confirmación que advierte sobre el descarte de los demás candidatos. Ese SweetAlert sí se muestra cuando el candidato NO tiene esas pruebas.\n\n**Resultado esperado:** Modal de competencias → clic \"Continuar\" → SweetAlert de confirmación de contratación (con mensaje de descarte) → clic \"Continuar con la contratación\" → ejecutar movimiento.\n\n## Archivo a modificar\n\n`public/js/vacantes/detalles/detalle-etapas.js`\n\n## Cambio\n\nModificar la función `cerrarModalCompetenciasMejorar()` (línea 1277) para que, en lugar de llamar directamente a `ejecutarMovimientoEtapa()`, muestre el SweetAlert de confirmación de contratación primero.\n\n**Código actual (líneas 1277-1283):**\n```javascript\nfunction cerrarModalCompetenciasMejorar() {\n    $('#modal-competencias-mejorar').modal('hide');\n    if (window.etapa_vacante_usuario_pendiente) {\n        ejecutarMovimientoEtapa(window.etapa_vacante_usuario_pendiente);\n        window.etapa_vacante_usuario_pendiente = null;\n    }\n}\n```\n\n**Código propuesto:**\n```javascript\nfunction cerrarModalCompetenciasMejorar() {\n    $('#modal-competencias-mejorar').modal('hide');\n    if (window.etapa_vacante_usuario_pendiente) {\n        var etapa_vacante_usuario_id = window.etapa_vacante_usuario_pendiente;\n        window.etapa_vacante_usuario_pendiente = null;\n\n        Swal.fire({\n            width: '533px',\n            showCloseButton: true,\n            closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n            showConfirmButton: false,\n            showDenyButton: false,\n            showCancelButton: false,\n            html: `\n                <div class=\"row w-100 mx-0 mt-2\">\n                    <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">Confirmar contratación</div>\n                    <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">\n                        Estás a punto de pasar a Contratados al canditato seleccionado y finalizar esta vacante.\n                    </div>\n                    <div class=\"col-12 mt-5 text-start text-body-2 fw-semibold\">\n                        ¿Deseas continuar?\n                    </div>\n                    <div class=\"col-6 mt-5 mb-2\">\n                        ${crearBoton({\n                            clases: 'btn-outline-primary w-100 justify-content-center',\n                            texto: 'Volver',\n                            onclick: `Swal.clickDeny();`\n                        })}\n                    </div>\n                    <div class=\"col-6 mt-5 mb-2\">\n                        ${crearBoton({\n                            clases: 'btn-primary w-100 justify-content-center',\n                            texto: 'Continuar con la contratación',\n                            onclick: `Swal.clickConfirm();`\n                        })}\n                    </div>\n                </div>\n            `,\n        }).then(async (resultado) => {\n            if (resultado.isConfirmed) {\n                ejecutarMovimientoEtapa(etapa_vacante_usuario_id);\n            }\n        });\n    }\n}\n```\n\nEste es exactamente el mismo SweetAlert que ya se usa en el flujo sin pruebas (líneas 577-613), asegurando consistencia visual y funcional.\n\n## Verificación\n\n1. Ir a `vacantes-detalle/{id}` con un candidato que tenga pruebas id 7 o 12\n2. Dar clic en mover a siguiente etapa (cuando la siguiente es \"Contratados\")\n3. Verificar que se abre el modal de \"Competencias por mejorar\"\n4. Clic en \"Continuar\" → debe aparecer el SweetAlert de \"Confirmar contratación\"\n5. Clic en \"Continuar con la contratación\" → el candidato se mueve a Contratados\n6. Clic en \"Volver\" → no debe mover al candidato\n7. Probar también con un candidato SIN pruebas 7/12 → el flujo debe seguir igual (SweetAlert directo sin modal previo)\n\n\nIf you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: C:\\Users\\sergio\\.claude\\projects\\C--Users-sergio-proyectos-Psicoalianza-2\\27b14693-5a2b-4094-8670-56e4ef72c70d.jsonl"},"uuid":"73a75574-b2b4-452a-9221-9c8a41eb4e68","timestamp":"2026-02-11T15:32:02.263Z","planContent":"# Fix: Mostrar mensaje de descarte tras modal de Competencias por mejorar\n\n## Contexto\n\nEn la vista `vacantes-detalle/{id}`, cuando un reclutador pasa un candidato a \"Contratados\" y este tiene pruebas con id 7 o 12, se abre el modal \"Competencias por mejorar\". Al darle \"Continuar\", se ejecuta directamente el movimiento de etapa **sin mostrar** el SweetAlert de confirmación que advierte sobre el descarte de los demás candidatos. Ese SweetAlert sí se muestra cuando el candidato NO tiene esas pruebas.\n\n**Resultado esperado:** Modal de competencias → clic \"Continuar\" → SweetAlert de confirmación de contratación (con mensaje de descarte) → clic \"Continuar con la contratación\" → ejecutar movimiento.\n\n## Archivo a modificar\n\n`public/js/vacantes/detalles/detalle-etapas.js`\n\n## Cambio\n\nModificar la función `cerrarModalCompetenciasMejorar()` (línea 1277) para que, en lugar de llamar directamente a `ejecutarMovimientoEtapa()`, muestre el SweetAlert de confirmación de contratación primero.\n\n**Código actual (líneas 1277-1283):**\n```javascript\nfunction cerrarModalCompetenciasMejorar() {\n    $('#modal-competencias-mejorar').modal('hide');\n    if (window.etapa_vacante_usuario_pendiente) {\n        ejecutarMovimientoEtapa(window.etapa_vacante_usuario_pendiente);\n        window.etapa_vacante_usuario_pendiente = null;\n    }\n}\n```\n\n**Código propuesto:**\n```javascript\nfunction cerrarModalCompetenciasMejorar() {\n    $('#modal-competencias-mejorar').modal('hide');\n    if (window.etapa_vacante_usuario_pendiente) {\n        var etapa_vacante_usuario_id = window.etapa_vacante_usuario_pendiente;\n        window.etapa_vacante_usuario_pendiente = null;\n\n        Swal.fire({\n            width: '533px',\n            showCloseButton: true,\n            closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n            showConfirmButton: false,\n            showDenyButton: false,\n            showCancelButton: false,\n            html: `\n                <div class=\"row w-100 mx-0 mt-2\">\n                    <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">Confirmar contratación</div>\n                    <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">\n                        Estás a punto de pasar a Contratados al canditato seleccionado y finalizar esta vacante.\n                    </div>\n                    <div class=\"col-12 mt-5 text-start text-body-2 fw-semibold\">\n                        ¿Deseas continuar?\n                    </div>\n                    <div class=\"col-6 mt-5 mb-2\">\n                        ${crearBoton({\n                            clases: 'btn-outline-primary w-100 justify-content-center',\n                            texto: 'Volver',\n                            onclick: `Swal.clickDeny();`\n                        })}\n                    </div>\n                    <div class=\"col-6 mt-5 mb-2\">\n                        ${crearBoton({\n                            clases: 'btn-primary w-100 justify-content-center',\n                            texto: 'Continuar con la contratación',\n                            onclick: `Swal.clickConfirm();`\n                        })}\n                    </div>\n                </div>\n            `,\n        }).then(async (resultado) => {\n            if (resultado.isConfirmed) {\n                ejecutarMovimientoEtapa(etapa_vacante_usuario_id);\n            }\n        });\n    }\n}\n```\n\nEste es exactamente el mismo SweetAlert que ya se usa en el flujo sin pruebas (líneas 577-613), asegurando consistencia visual y funcional.\n\n## Verificación\n\n1. Ir a `vacantes-detalle/{id}` con un candidato que tenga pruebas id 7 o 12\n2. Dar clic en mover a siguiente etapa (cuando la siguiente es \"Contratados\")\n3. Verificar que se abre el modal de \"Competencias por mejorar\"\n4. Clic en \"Continuar\" → debe aparecer el SweetAlert de \"Confirmar contratación\"\n5. Clic en \"Continuar con la contratación\" → el candidato se mueve a Contratados\n6. Clic en \"Volver\" → no debe mover al candidato\n7. Probar también con un candidato SIN pruebas 7/12 → el flujo debe seguir igual (SweetAlert directo sin modal previo)\n"}
{"parentUuid":"73a75574-b2b4-452a-9221-9c8a41eb4e68","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","message":{"model":"claude-opus-4-6","id":"msg_01SeQAg4NcQPGRab9B4r9Bhq","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5866,"cache_read_input_tokens":20459,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5866},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY2XHz9DC8RmMxxFsPShh","type":"assistant","uuid":"c0b1d135-164a-46b7-918b-f4b387aaf3c7","timestamp":"2026-02-11T15:32:05.553Z"}
{"parentUuid":"c0b1d135-164a-46b7-918b-f4b387aaf3c7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","message":{"model":"claude-opus-4-6","id":"msg_01SeQAg4NcQPGRab9B4r9Bhq","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me read the file to make the change.","signature":"EtABCkYICxgCKkDdau8pYJE6mYDX+blk50iXPMAyWAKSSFuNqk2rMTk5MURZi7DuD1mBwUBJifqoK7n9ophswqWLR3WOXaJfMwueEgwxCx71lxNFwPrtMa4aDITionq2X0gU4B2LgyIwhp1kAhVnkhqEozktUcg/5mzjRxk/C5po+1P9OyfAv4guAYhA3e/gA1Vlx0iBDuRwKjgRpy4tlphkBmXgYOn4lK8yyzujiRFMiyMcZuKaP+x9WCVfoY2zU9Y0/yt7ORc5WMUSS96FoDE2cxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5866,"cache_read_input_tokens":20459,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5866},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY2XHz9DC8RmMxxFsPShh","type":"assistant","uuid":"808edee1-dc49-48ab-aa37-89ba8ee9bd2b","timestamp":"2026-02-11T15:32:06.248Z"}
{"parentUuid":"808edee1-dc49-48ab-aa37-89ba8ee9bd2b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","message":{"model":"claude-opus-4-6","id":"msg_01SeQAg4NcQPGRab9B4r9Bhq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013ZFb78UDiNQp3tAcBu4dXE","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\vacantes\\detalles\\detalle-etapas.js","offset":1270,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5866,"cache_read_input_tokens":20459,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5866},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY2XHz9DC8RmMxxFsPShh","type":"assistant","uuid":"1d530413-eab5-44d1-83f5-43cc42142c39","timestamp":"2026-02-11T15:32:07.221Z"}
{"parentUuid":"1d530413-eab5-44d1-83f5-43cc42142c39","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_013ZFb78UDiNQp3tAcBu4dXE","toolUseID":"toolu_013ZFb78UDiNQp3tAcBu4dXE","timestamp":"2026-02-11T15:32:07.227Z","uuid":"b2903631-d124-4efb-848d-523fd3c2f67b"}
{"parentUuid":"1d530413-eab5-44d1-83f5-43cc42142c39","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013ZFb78UDiNQp3tAcBu4dXE","type":"tool_result","content":"  1270→\n  1271→/**\n  1272→ * Cerrar modal y ejecutar movimiento de etapa.\n  1273→ *\n  1274→ * @returns {void}\n  1275→ * @author Sergio Vargas\n  1276→ */\n  1277→function cerrarModalCompetenciasMejorar() {\n  1278→    $('#modal-competencias-mejorar').modal('hide');\n  1279→    if (window.etapa_vacante_usuario_pendiente) {\n  1280→        ejecutarMovimientoEtapa(window.etapa_vacante_usuario_pendiente);\n  1281→        window.etapa_vacante_usuario_pendiente = null;\n  1282→    }\n  1283→}\n  1284→\n  1285→/**\n  1286→ * Crear mensaje cuando la etapa de prueba técnica no tiene archivos de instrucciones.\n  1287→ *\n  1288→ * @param {number} etapa_id ID de la etapa.\n  1289→ * @returns {string} HTML del mensaje."}]},"uuid":"c524ddbe-bb2f-44d5-93b6-ee27d12d1bee","timestamp":"2026-02-11T15:32:07.227Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\vacantes\\detalles\\detalle-etapas.js","content":"\n/**\n * Cerrar modal y ejecutar movimiento de etapa.\n *\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction cerrarModalCompetenciasMejorar() {\n    $('#modal-competencias-mejorar').modal('hide');\n    if (window.etapa_vacante_usuario_pendiente) {\n        ejecutarMovimientoEtapa(window.etapa_vacante_usuario_pendiente);\n        window.etapa_vacante_usuario_pendiente = null;\n    }\n}\n\n/**\n * Crear mensaje cuando la etapa de prueba técnica no tiene archivos de instrucciones.\n *\n * @param {number} etapa_id ID de la etapa.\n * @returns {string} HTML del mensaje.","numLines":20,"startLine":1270,"totalLines":1915}},"sourceToolAssistantUUID":"1d530413-eab5-44d1-83f5-43cc42142c39"}
{"parentUuid":"c524ddbe-bb2f-44d5-93b6-ee27d12d1bee","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","message":{"model":"claude-opus-4-6","id":"msg_01BjJo7Sp9Y4UWtsz2gmKuVQ","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me also verify the existing SweetAlert at lines 577-613 to ensure consistency."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":585,"cache_read_input_tokens":26325,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":585},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY2XJLZHbPF5VdBZaV2BB","type":"assistant","uuid":"c69a7721-5096-4442-9c1d-51b2166eca71","timestamp":"2026-02-11T15:32:10.153Z"}
{"parentUuid":"c69a7721-5096-4442-9c1d-51b2166eca71","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","message":{"model":"claude-opus-4-6","id":"msg_01BjJo7Sp9Y4UWtsz2gmKuVQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GYXbXQ4XRPWxsed74bvFgB","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\vacantes\\detalles\\detalle-etapas.js","offset":570,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":585,"cache_read_input_tokens":26325,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":585},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY2XJLZHbPF5VdBZaV2BB","type":"assistant","uuid":"2ab739b4-86ea-4760-ad8a-f532fcd1569c","timestamp":"2026-02-11T15:32:10.906Z"}
{"parentUuid":"2ab739b4-86ea-4760-ad8a-f532fcd1569c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01GYXbXQ4XRPWxsed74bvFgB","toolUseID":"toolu_01GYXbXQ4XRPWxsed74bvFgB","timestamp":"2026-02-11T15:32:10.912Z","uuid":"d443d2da-80d1-46b5-93a7-bb2fc620b00b"}
{"parentUuid":"2ab739b4-86ea-4760-ad8a-f532fcd1569c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GYXbXQ4XRPWxsed74bvFgB","type":"tool_result","content":"   570→            // Obtener el valor de tiene_pruebas_requeridas desde el atributo data de la card\n   571→            var $contenedor_candidato = $(`.candidato-card[data-etapa-vacante-usuario-id=\"${etapa_vacante_usuario_id}\"]`);\n   572→            var tiene_pruebas = $contenedor_candidato.attr('data-tiene-pruebas-requeridas') === 'true';\n   573→\n   574→            if (tiene_pruebas) {\n   575→                mostrarModalCompetenciasMejorar(etapa_vacante_usuario_id);\n   576→            } else {\n   577→                Swal.fire({\n   578→                    width: '533px',\n   579→                    showCloseButton: true,\n   580→                    closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n   581→                    showConfirmButton: false,\n   582→                    showDenyButton: false,\n   583→                    showCancelButton: false,\n   584→                    html: `\n   585→                        <div class=\"row w-100 mx-0 mt-2\">\n   586→                            <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">Confirmar contratación</div>\n   587→                            <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">\n   588→                                Estás a punto de pasar a Contratados al canditato seleccionado y finalizar esta vacante.\n   589→                            </div>\n   590→                            <div class=\"col-12 mt-5 text-start text-body-2 fw-semibold\">\n   591→                                ¿Deseas continuar?\n   592→                            </div>\n   593→                            <div class=\"col-6 mt-5 mb-2\">\n   594→                                ${crearBoton({\n   595→                                    clases: 'btn-outline-primary w-100 justify-content-center',\n   596→                                    texto: 'Volver',\n   597→                                    onclick: `Swal.clickDeny();`\n   598→                                })}\n   599→                            </div>\n   600→                            <div class=\"col-6 mt-5 mb-2\">\n   601→                                ${crearBoton({\n   602→                                    clases: 'btn-primary w-100 justify-content-center',\n   603→                                    texto: 'Continuar con la contratación',\n   604→                                    onclick: `Swal.clickConfirm();`\n   605→                                })}\n   606→                            </div>\n   607→                        </div>\n   608→                    `,\n   609→                }).then(async (resultado) => {\n   610→                    if (resultado.isConfirmed) {\n   611→                        ejecutarMovimientoEtapa(etapa_vacante_usuario_id);\n   612→                    }\n   613→                });\n   614→            }\n   615→        } else {\n   616→            ejecutarMovimientoEtapa(etapa_vacante_usuario_id);\n   617→        }\n   618→    });\n   619→}"}]},"uuid":"87a5fdf9-709f-479a-8ce6-cefe56173a36","timestamp":"2026-02-11T15:32:10.911Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\vacantes\\detalles\\detalle-etapas.js","content":"            // Obtener el valor de tiene_pruebas_requeridas desde el atributo data de la card\n            var $contenedor_candidato = $(`.candidato-card[data-etapa-vacante-usuario-id=\"${etapa_vacante_usuario_id}\"]`);\n            var tiene_pruebas = $contenedor_candidato.attr('data-tiene-pruebas-requeridas') === 'true';\n\n            if (tiene_pruebas) {\n                mostrarModalCompetenciasMejorar(etapa_vacante_usuario_id);\n            } else {\n                Swal.fire({\n                    width: '533px',\n                    showCloseButton: true,\n                    closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n                    showConfirmButton: false,\n                    showDenyButton: false,\n                    showCancelButton: false,\n                    html: `\n                        <div class=\"row w-100 mx-0 mt-2\">\n                            <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">Confirmar contratación</div>\n                            <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">\n                                Estás a punto de pasar a Contratados al canditato seleccionado y finalizar esta vacante.\n                            </div>\n                            <div class=\"col-12 mt-5 text-start text-body-2 fw-semibold\">\n                                ¿Deseas continuar?\n                            </div>\n                            <div class=\"col-6 mt-5 mb-2\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary w-100 justify-content-center',\n                                    texto: 'Volver',\n                                    onclick: `Swal.clickDeny();`\n                                })}\n                            </div>\n                            <div class=\"col-6 mt-5 mb-2\">\n                                ${crearBoton({\n                                    clases: 'btn-primary w-100 justify-content-center',\n                                    texto: 'Continuar con la contratación',\n                                    onclick: `Swal.clickConfirm();`\n                                })}\n                            </div>\n                        </div>\n                    `,\n                }).then(async (resultado) => {\n                    if (resultado.isConfirmed) {\n                        ejecutarMovimientoEtapa(etapa_vacante_usuario_id);\n                    }\n                });\n            }\n        } else {\n            ejecutarMovimientoEtapa(etapa_vacante_usuario_id);\n        }\n    });\n}","numLines":50,"startLine":570,"totalLines":1915}},"sourceToolAssistantUUID":"2ab739b4-86ea-4760-ad8a-f532fcd1569c"}
{"parentUuid":"87a5fdf9-709f-479a-8ce6-cefe56173a36","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","message":{"model":"claude-opus-4-6","id":"msg_01BaHvLquoiGeQq17KP4Sw3Z","type":"message","role":"assistant","content":[{"type":"text","text":"The existing SweetAlert matches the plan. Now I'll apply the change."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1007,"cache_read_input_tokens":26910,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1007},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY2XJcSWvDPEFYmdya1eD","type":"assistant","uuid":"10d2a1c1-2c14-4174-ad37-0a28bc320132","timestamp":"2026-02-11T15:32:13.413Z"}
{"parentUuid":"10d2a1c1-2c14-4174-ad37-0a28bc320132","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","message":{"model":"claude-opus-4-6","id":"msg_01BaHvLquoiGeQq17KP4Sw3Z","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PfSSxTnDBMvkAs9YksjkvW","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\vacantes\\detalles\\detalle-etapas.js","old_string":"function cerrarModalCompetenciasMejorar() {\n    $('#modal-competencias-mejorar').modal('hide');\n    if (window.etapa_vacante_usuario_pendiente) {\n        ejecutarMovimientoEtapa(window.etapa_vacante_usuario_pendiente);\n        window.etapa_vacante_usuario_pendiente = null;\n    }\n}","new_string":"function cerrarModalCompetenciasMejorar() {\n    $('#modal-competencias-mejorar').modal('hide');\n    if (window.etapa_vacante_usuario_pendiente) {\n        var etapa_vacante_usuario_id = window.etapa_vacante_usuario_pendiente;\n        window.etapa_vacante_usuario_pendiente = null;\n\n        Swal.fire({\n            width: '533px',\n            showCloseButton: true,\n            closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n            showConfirmButton: false,\n            showDenyButton: false,\n            showCancelButton: false,\n            html: `\n                <div class=\"row w-100 mx-0 mt-2\">\n                    <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">Confirmar contratación</div>\n                    <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">\n                        Estás a punto de pasar a Contratados al canditato seleccionado y finalizar esta vacante.\n                    </div>\n                    <div class=\"col-12 mt-5 text-start text-body-2 fw-semibold\">\n                        ¿Deseas continuar?\n                    </div>\n                    <div class=\"col-6 mt-5 mb-2\">\n                        ${crearBoton({\n                            clases: 'btn-outline-primary w-100 justify-content-center',\n                            texto: 'Volver',\n                            onclick: `Swal.clickDeny();`\n                        })}\n                    </div>\n                    <div class=\"col-6 mt-5 mb-2\">\n                        ${crearBoton({\n                            clases: 'btn-primary w-100 justify-content-center',\n                            texto: 'Continuar con la contratación',\n                            onclick: `Swal.clickConfirm();`\n                        })}\n                    </div>\n                </div>\n            `,\n        }).then(async (resultado) => {\n            if (resultado.isConfirmed) {\n                ejecutarMovimientoEtapa(etapa_vacante_usuario_id);\n            }\n        });\n    }\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1007,"cache_read_input_tokens":26910,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1007},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY2XJcSWvDPEFYmdya1eD","type":"assistant","uuid":"41797d2a-2abe-4b1f-8c80-5841c94624e4","timestamp":"2026-02-11T15:32:19.222Z"}
{"type":"file-history-snapshot","messageId":"41797d2a-2abe-4b1f-8c80-5841c94624e4","snapshot":{"messageId":"73a75574-b2b4-452a-9221-9c8a41eb4e68","trackedFileBackups":{"public\\js\\vacantes\\detalles\\detalle-etapas.js":{"backupFileName":"f2cb7ab147e54316@v1","version":1,"backupTime":"2026-02-11T15:32:19.282Z"}},"timestamp":"2026-02-11T15:32:02.336Z"},"isSnapshotUpdate":true}
{"parentUuid":"41797d2a-2abe-4b1f-8c80-5841c94624e4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01PfSSxTnDBMvkAs9YksjkvW","toolUseID":"toolu_01PfSSxTnDBMvkAs9YksjkvW","timestamp":"2026-02-11T15:32:19.292Z","uuid":"6393ce74-01dc-4ed5-aff7-5a92f83d5294"}
{"parentUuid":"41797d2a-2abe-4b1f-8c80-5841c94624e4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PfSSxTnDBMvkAs9YksjkvW","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\vacantes\\detalles\\detalle-etapas.js has been updated successfully."}]},"uuid":"7f3a21f2-1179-4d0e-8d31-9d540de40be0","timestamp":"2026-02-11T15:32:19.291Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\vacantes\\detalles\\detalle-etapas.js","oldString":"function cerrarModalCompetenciasMejorar() {\n    $('#modal-competencias-mejorar').modal('hide');\n    if (window.etapa_vacante_usuario_pendiente) {\n        ejecutarMovimientoEtapa(window.etapa_vacante_usuario_pendiente);\n        window.etapa_vacante_usuario_pendiente = null;\n    }\n}","newString":"function cerrarModalCompetenciasMejorar() {\n    $('#modal-competencias-mejorar').modal('hide');\n    if (window.etapa_vacante_usuario_pendiente) {\n        var etapa_vacante_usuario_id = window.etapa_vacante_usuario_pendiente;\n        window.etapa_vacante_usuario_pendiente = null;\n\n        Swal.fire({\n            width: '533px',\n            showCloseButton: true,\n            closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n            showConfirmButton: false,\n            showDenyButton: false,\n            showCancelButton: false,\n            html: `\n                <div class=\"row w-100 mx-0 mt-2\">\n                    <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">Confirmar contratación</div>\n                    <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">\n                        Estás a punto de pasar a Contratados al canditato seleccionado y finalizar esta vacante.\n                    </div>\n                    <div class=\"col-12 mt-5 text-start text-body-2 fw-semibold\">\n                        ¿Deseas continuar?\n                    </div>\n                    <div class=\"col-6 mt-5 mb-2\">\n                        ${crearBoton({\n                            clases: 'btn-outline-primary w-100 justify-content-center',\n                            texto: 'Volver',\n                            onclick: `Swal.clickDeny();`\n                        })}\n                    </div>\n                    <div class=\"col-6 mt-5 mb-2\">\n                        ${crearBoton({\n                            clases: 'btn-primary w-100 justify-content-center',\n                            texto: 'Continuar con la contratación',\n                            onclick: `Swal.clickConfirm();`\n                        })}\n                    </div>\n                </div>\n            `,\n        }).then(async (resultado) => {\n            if (resultado.isConfirmed) {\n                ejecutarMovimientoEtapa(etapa_vacante_usuario_id);\n            }\n        });\n    }\n}","originalFile":"/**\n * Archivo para el manejo de etapas en el detalle de vacantes\n * @author Andres Morales\n*/\n\nlet candidatos_descartados = [];\nlet candidatos_seleccionados = [];\nlet json_filtros_etapas = {};\nlet es_primera_carga = true;\nlet posicion_scroll_guardada = 0;\n\n$(document).ready(function() {\n    consultarPaisesListadoCompleto(true);\n    observarCambiosChips();\n    cargarEtapasConCandidatos();\n});\n\n/**\n * Cargar etapas de la vacante con sus candidatos desde el endpoint.\n *\n * @param {Object} filtros Objeto con filtros a aplicar (opcional).\n * @returns {void}\n * @author Andres Morales\n * @author Andres Gonzalez\n */\nfunction cargarEtapasConCandidatos(filtros = {}) {\n    // Guardar posición del scroll antes de actualizar (solo si no es la primera carga)\n    if (!es_primera_carga) {\n        var $contenedor = $('#contenido-etapas-lista');\n        if ($contenedor.length) {\n            posicion_scroll_guardada = $contenedor.scrollLeft();\n        }\n    }\n\n    $.ajax({\n        url: `/etapas-vacantes-aplicantes/${VACANTE_ID}`,\n        type: 'GET',\n        dataType: 'json',\n        data: {\n            ciudad_id: filtros.ciudad_id || '',\n            departamento_id: filtros.departamento_id || '',\n            pais_id: filtros.pais_id || '',\n            etapa_id: filtros.etapa_id || '',\n            nivel_educativo_id: filtros.nivel_educativo_id || '',\n            fecha_desde: filtros.fecha_desde || '',\n            fecha_hasta: filtros.fecha_hasta || '',\n            edad: filtros.edad || '',\n            chips: filtros.chips,\n            nivel_adecuacion: filtros.nivel_adecuacion || ''\n        },\n        success: function(respuesta) {\n            let datos = respuesta.data;\n            renderizarEtapas(datos.etapas, calcularTotalCandidatos(datos.etapas) + datos.descartados.length);\n            actualizarConteoDescartados(datos.descartados.length);\n\n            candidatos_descartados = datos.descartados;\n        },\n        error: function() {\n            mostrarToast('danger', 'Error al cargar las etapas y candidatos');\n        }\n    });\n}\n\n/**\n * Calcular el total de candidatos en todas las etapas.\n *\n * @param {Array} etapas Array de etapas con candidatos.\n * @returns {number} Total de candidatos.\n * @author Andres Morales\n */\nfunction calcularTotalCandidatos(etapas) {\n    let total = 0;\n    etapas.forEach(etapa => {\n        if (etapa.usuarios_vacantes) {\n            total += etapa.usuarios_vacantes.length;\n        }\n    });\n    return total;\n}\n\n/**\n * Observar cambios en el contenedor de chips para mostrar/ocultar el wrapper.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction observarCambiosChips() {\n    var $contenedor_chips = $('#contenedor-chips-etapa-filtro-candidatos');\n    var $envolvente = $('#contenedor-chips-wrapper-etapa-filtro-candidatos');\n\n    if ($contenedor_chips.length === 0 || $envolvente.length === 0) return;\n\n    var observador = new MutationObserver(function() {\n        var tiene_chips = $contenedor_chips.children().length > 0;\n\n        if (tiene_chips) {\n            $envolvente.removeClass('d-none');\n        } else {\n            $envolvente.addClass('d-none');\n        }\n    });\n\n    observador.observe($contenedor_chips[0], {\n        childList: true,\n        subtree: false\n    });\n}\n\n/**\n * Actualizar el conteo de aplicantes en el botón.\n *\n * @param {number} conteo Número de candidatos aplicantes.\n * @returns {void}\n * @author Andres Morales\n */\nfunction actualizarConteoAplicantes(conteo) {\n    $('#etapa-total-candidatos').text(`${conteo}`);\n}\n\n/**\n * Actualizar el badge de conteo de descartados.\n *\n * @param {number} conteo Número de candidatos descartados.\n * @returns {void}\n * @author Andres Morales\n * @author Andres Gonzalez\n */\nfunction actualizarConteoDescartados(conteo) {\n    $('#etapa-total-descartados').text(conteo);\n\n    if (conteo == 0) {\n        $('#etapa-total-descartados').addClass('d-none');\n    } else {\n        $('#etapa-total-descartados').removeClass('d-none');\n    }\n}\n\n/**\n * Cargar las etapas en el select2 del filtro.\n *\n * @param {Array} etapas Array de etapas de la vacante.\n * @returns {void}\n * @author Andres Morales\n */\nfunction cargarEtapasEnFiltro(etapas) {\n    var $select_etapa_filtro = $('#etapa_filtro');\n\n    if (!$select_etapa_filtro.length) return;\n\n    $select_etapa_filtro.empty();\n\n    var opcion_todas = new Option('Todas', '', false, false);\n    $select_etapa_filtro.append(opcion_todas);\n\n    etapas.sort((a, b) => a.orden - b.orden);\n\n    etapas.forEach(function(etapa) {\n        var opcion = new Option(etapa.nombre, etapa.id, false, false);\n        $select_etapa_filtro.append(opcion);\n    });\n\n    $select_etapa_filtro.trigger('change');\n}\n\n/**\n * Animar scroll horizontal del contenedor de etapas.\n * Desplaza desde el final hasta el inicio (solo en primera carga).\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction animarScrollEtapas() {\n    var $contenedor = $('#contenido-etapas-lista');\n\n    if (!$contenedor.length) return;\n\n    var ancho_scroll = $contenedor[0].scrollWidth - $contenedor[0].clientWidth;\n\n    if (ancho_scroll <= 0) return;\n\n    // Posicionar al final primero\n    $contenedor.scrollLeft(ancho_scroll);\n\n    // Animar de final a inicio\n    $contenedor.animate(\n        { scrollLeft: 0 },\n        {\n            duration: 1500,\n            easing: 'swing'\n        }\n    );\n}\n\n/**\n * Renderizar las etapas de la vacante en cards horizontales.\n *\n * @param {Array} etapas Array de etapas de la vacante.\n * @param {number} conteo_aplicantes Cantidad de aplicantes de la vacante.\n * @returns {void}\n * @author Andres Morales\n * @author Andres Gonzalez\n * @author Jair Carvajal\n */\nfunction renderizarEtapas(etapas, conteo_aplicantes) {\n    var $contenido_lista = $('#contenido-etapas-lista');\n    var $contenido_vacio = $('#contenido-etapas-empty');\n    var $contenido_controles = $('#contenido-etapas-controles');\n\n    // Verificar si hay filtros activos\n    var hay_filtros_activos = Object.keys(json_filtros_etapas).length > 0;\n\n    // Solo mostrar empty state si NO hay aplicantes Y NO hay filtros activos\n    if ((!conteo_aplicantes || conteo_aplicantes === 0) && !hay_filtros_activos) {\n        $contenido_lista.addClass('d-none');\n        $contenido_controles.addClass('d-none');\n        $contenido_vacio.removeClass('d-none');\n        return;\n    }\n\n    $contenido_vacio.addClass('d-none');\n    $contenido_lista.removeClass('d-none');\n    $contenido_controles.removeClass('d-none');\n\n    if (!etapas || etapas.length === 0) {\n        $contenido_lista.html(`\n            <div class=\"w-100 text-center py-5\">\n                <p class=\"text-muted\">${hay_filtros_activos ? 'No se encontraron coincidencias con los filtros aplicados. vuelve a intentar con otros filtros' : 'No hay etapas configuradas para esta vacante'}</p>\n            </div>\n        `);\n        return;\n    }\n\n    let html = '';\n    etapas.sort((a, b) => a.orden - b.orden);\n\n    // Filtrar la etapa con el orden inmediatamente anterior al orden 8 (Contratados)\n    let etapa_anterior_orden_8 = etapas\n        .filter(etapa => etapa.orden < 8)\n        .sort((a, b) => b.orden - a.orden)[0];\n\n    etapas.forEach((etapa) => {\n        html += crearTarjetaEtapa(etapa, etapa_anterior_orden_8);\n    });\n\n    $contenido_lista.html(html);\n\n    cargarEtapasEnFiltro(etapas);\n\n    // Ejecutar animación solo en la primera carga, de lo contrario restaurar posición\n    if (es_primera_carga) {\n        animarScrollEtapas();\n        es_primera_carga = false;\n    } else {\n        // Restaurar la posición del scroll guardada\n        setTimeout(() => {\n            $contenido_lista.scrollLeft(posicion_scroll_guardada);\n        }, 50);\n    }\n\n    inicializarEventosCheckboxes();\n\n    // Inicializar tooltips después de renderizar\n    setTimeout(() => {\n        inicializarTooltips();\n    }, 100);\n}\n\n/**\n * Crear una tarjeta(card) de etapa.\n *\n * @param {Object} etapa Datos de la etapa.\n * @param {Object} etapa_anterior_orden_8 Etapa con el orden inmediatamente anterior al orden 8.\n * @returns {string} HTML de la card.\n * @author Andres Morales\n * @author Andres Gonzalez\n * @author Jair Carvajal\n * @author Esperanza Olivo\n */\nfunction crearTarjetaEtapa(etapa, etapa_anterior_orden_8) {\n    let etapa_anterior_contracion = false;\n\n    if (etapa_anterior_orden_8 && etapa.orden === etapa_anterior_orden_8.orden && etapa.activa == 1) {\n        etapa_anterior_contracion = true;\n    }\n\n    // Detectar si es etapa de prueba técnica sin archivos\n    let es_prueba_tecnica = etapa.nombre === 'Prueba técnica';\n    let tiene_prueba_tecnica_cargada = etapa?.prueba_cargada ?? true;\n\n    let candidatos_html = '';\n    let candidatos_totales = 0;\n    let candidatos_completaron = 0;\n\n    // Mostrar mensaje si es prueba técnica sin archivos\n    if (es_prueba_tecnica && !tiene_prueba_tecnica_cargada) {\n        let html = crearMensajeSinArchivosInstrucciones(etapa.id);\n\n        // Si hay candidatos, agregarlos después del mensaje\n        if (etapa?.usuarios_vacantes?.length > 0) {\n            etapa.usuarios_vacantes.forEach((usuario_vacante) => {\n                html += crearCardCandidato(usuario_vacante, 'listado', etapa.nombre, etapa_anterior_contracion);\n            });\n            candidatos_totales = etapa.usuarios_vacantes.length;\n            candidatos_completaron = etapa.usuarios_vacantes.filter((usuario_vacante) => usuario_vacante.puntaje !== null || usuario_vacante.puntaje_ia !== null).length;\n        }\n\n        candidatos_html = `<div class=\"candidatos-container\">${html}</div>`;\n    } else if (etapa?.usuarios_vacantes?.length > 0) {\n        let html = '';\n\n        etapa.usuarios_vacantes.forEach((usuario_vacante) => {\n            html += crearCardCandidato(usuario_vacante, 'listado', etapa.nombre, etapa_anterior_contracion);\n        });\n\n        candidatos_html = `<div class=\"candidatos-container\">${html}</div>`;\n        candidatos_totales = etapa.usuarios_vacantes.length;\n        candidatos_completaron = etapa.nombre === 'Documentos para contratación'\n            ? etapa.usuarios_vacantes.filter((usuario_vacante) => usuario_vacante.etapa_completada === true).length\n            : etapa.usuarios_vacantes.filter((usuario_vacante) => usuario_vacante.puntaje !== null || usuario_vacante.puntaje_ia !== null).length;\n    } else {\n        candidatos_html = `\n            <div class=\"candidatos-container\">\n                <div class=\"mensaje-etapa-vacia d-flex justify-content-center align-items-center my-5\"><div class=\"etapa-icono-circulo\"><i class=\"bi bi-arrow-90deg-right\"></i></div></div>\n                <div class=\"mensaje-etapa-vacia mt-auto pb-10 px-5\"><p class=\"text-headline-5 text-gray-40 text-center mb-5 pb-10 px-6\">Mueve candidatos con el botón o arrástralos desde la etapa anterior. </p></div>\n            </div>\n        `;\n    }\n    return `\n        <div class=\"card etapa-card bg-gray-90\" data-etapa-id=\"${etapa.id}\">\n            <div class=\"card-body d-flex flex-column\">\n                <div class=\"d-flex align-items-center mb-3 gap-3\">\n                    ${crearCheckbox({\n                        id: 'etapa-check-' + etapa.id,\n                        name: 'etapa_check',\n                        value: etapa.id,\n                        checked: false,\n                        input_container_class: 'd-inline-block',\n                        disabled: (candidatos_totales > 0) ? false : true\n                    })}\n                    <h6 class=\"etapa-titulo text-headline-5 fw-bold mb-0\">${etapa.nombre}</h6>\n                    ${(candidatos_totales > 0 && etapa.nombre !== 'Contratados') ?\n                        `<div class=\"ms-auto\">\n                            ${crearTag({\n                                texto: candidatos_completaron + '/' + candidatos_totales + ' completaron la tarea',\n                                class: etapa.nombre === 'Documentos para contratación' ? 'tag-tonal-green' : 'tag-tonal-blue',\n                            })}\n                        </div>`\n                    : ''}\n                </div>\n                ${candidatos_html}\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Ver candidatos descartados en modal.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction verCandidatosDescartados() {\n    let $contenedor = $('#contenedor-candidatos-descartados');\n    let $controles = $('#controles-candidatos-descartados');\n\n    if (candidatos_descartados.length === 0) {\n        $controles.addClass('d-none');\n        $contenedor.html(`\n            <div class=\"row justify-content-center align-items-center py-5\">\n                <div class=\"col-auto text-center\">\n                    <div class=\"mb-4\">\n                        <i class=\"bi bi-person-x-fill empty-state-icon\"></i>\n                    </div>\n                    <div class=\"text-gray-30 fw-semibold text-headline-4 mb-3\">\n                        No hay candidatos descartados\n                    </div>\n                    <div class=\"text-gray-50 text-body-2\">\n                        Los candidatos que descartaste aparecerán aquí\n                    </div>\n                </div>\n            </div>\n        `);\n    } else {\n        $controles.removeClass('d-none');\n        let html = '';\n        candidatos_descartados.forEach(candidato => {\n            html += crearCardCandidato(candidato, 'modal');\n        });\n        $contenedor.html(html);\n\n        setTimeout(() => {\n            inicializarTooltips();\n            inicializarEventosModalDescartados();\n        }, 100);\n    }\n\n    $('#modal-candidatos-descartados').modal('show');\n}\n\n/**\n * Crear una card individual de candidato.\n *\n * @param {Object} usuario_vacante Datos del candidato aplicante.\n * @param {string} origen Origen del render: 'listado' o 'modal'. Default: 'listado'\n * @param {string} nombre_etapa Nombre de la etapa actual. Default: null\n * @returns {string} HTML de la card del candidato.\n * @author Andres Morales\n * @author Andres Gonzalez\n * @author José Manuel Jiménez\n * @author Jair Carvajal\n */\nfunction crearCardCandidato(usuario_vacante, origen = 'listado', nombre_etapa = null, etapa_anterior_contracion = false) {\n    var usuario = usuario_vacante.usuario || {};\n    var nombre_completo = usuario.nombre_completo?.trim() || 'Sin nombre';\n    var salario = usuario?.perfiles_laborales[0]?.salario || 0;\n    var salario_maximo = usuario?.perfiles_laborales[0]?.salario_maximo || 0;\n\n    var salario_solicitado = (salario_maximo > 0) ? `Salario: ${formatearSalario(salario)} a ${formatearSalario(salario_maximo)}` : `Solicita ${formatearSalario(salario)}`;\n    var experiencia_meses = usuario?.perfiles_laborales[0]?.experiencia_laboral_meses || 0;\n    var experiencia = convertirMesesAAnios(experiencia_meses);\n\n    var ciudad = usuario.ciudad?.nombre || '';\n    var pais = usuario.ciudad?.departamento?.pais?.nombre || '';\n    var ubicacion = `${ciudad}${ciudad && pais ? ',' : ''}${pais}`;\n\n    var documento = usuario.documento || '';\n\n    var adecuacion = usuario_vacante.adecuacion;\n    var borde_color = '';\n    var etiqueta_estilo = '';\n\n    if (adecuacion !== null) {\n        if (adecuacion <= ADECUACION_CALIFICACION_BAJA) {\n            borde_color = 'borde-indice-talento-rojo';\n            etiqueta_estilo = 'badge-indice-talento-rojo';\n        } else if (adecuacion <= ADECUACION_CALIFICACION_ALTA) {\n            borde_color = 'borde-indice-talento-amarillo';\n            etiqueta_estilo = 'badge-indice-talento-amarillo';\n        } else {\n            borde_color = 'borde-indice-talento-verde';\n            etiqueta_estilo = 'badge-indice-talento-verde';\n        }\n    }\n\n    var tiene_motivo_abandono = origen === 'modal' && usuario_vacante.etapa_descarte?.motivo_abandono !== null;\n\n    var checkbox_html = !tiene_motivo_abandono ?\n        crearCheckbox({\n            id: `candidato-check-${usuario_vacante.id}`,\n            name: `candidato_check`,\n            value: usuario_vacante.id,\n            class: 'candidato-checkbox',\n            input_container_class: 'd-inline-block'\n        }) : '';\n\n    var etapa_descarte_html = origen === 'modal' && usuario_vacante.etapa_descarte ?\n        `${crearTag({\n            texto: `Etapa de descarte: ${usuario_vacante.etapa_descarte.nombre}`,\n            class: 'tag-tonal-orange w-fit-content',\n        })}` : '';\n\n    var fecha_descarte = '';\n    if (origen === 'modal' && usuario_vacante.created_at) {\n        var fecha = new Date(usuario_vacante.created_at);\n        var dia = fecha.getDate();\n        var mes = fecha.toLocaleDateString('es-CO', { month: 'short' }).replace('.', '');\n        var anio = fecha.getFullYear();\n        fecha_descarte = `${dia}/${mes.charAt(0).toUpperCase() + mes.slice(1)}/${anio}`;\n    }\n\n    return `\n        <div class=\"card candidato-card mb-3\" data-candidato-id=\"${usuario.id}\" data-etapa-vacante-usuario-id=\"${usuario_vacante.id}\" data-tiene-pruebas-requeridas=\"${usuario_vacante.tiene_pruebas_requeridas || false}\">\n            <div class=\"card-body p-3\">\n                <div class=\"d-flex align-items-center gap-1\">\n                    ${checkbox_html}\n                    <div class=\"candidato-avatar-container d-flex flex-column align-items-center justify-content-center text-center\">\n                        <div class=\"position-relative d-inline-block\">\n                            <img class=\"candidato-avatar ${borde_color}\"\n                                onclick=\"verDetalleCandidato(${usuario.id}, '${nombre_etapa}')\"\n                                src=\"/usuarios-imagen/${usuario.id}\"\n                                ${crearTooltip({\n                                    placement: `bottom`,\n                                    content: `Ver detalle del candidato`,\n                                    toggle: `popover`,\n                                })}>\n\n                            ${(adecuacion !== null) ? `\n                                <span class=\"candidato-badge-detalle text-label-1 badge ${etiqueta_estilo} position-absolute\">\n                                    ${adecuacion !== null ? `${adecuacion}%` : ''}\n                                </span>\n                            ` : ''}\n                        </div>\n\n                        ${ubicacion ? `\n                            <div class=\"col-10 d-flex align-items-center gap-2 mt-3\">\n                                <span class=\"text-label-2 text-gray-30 mt-1 text-wrap\">${ubicacion}</span>\n                            </div>\n                        ` : ''}\n                    </div>\n                    <div class=\"flex-grow-1\">\n                        <h6 class=\"candidato-nombre mb-2 text-headline-6 fw-bold text-gray-10\" onclick=\"verDetalleCandidato(${usuario.id}, '${nombre_etapa}')\">${nombre_completo}</h6>\n                        <div class=\"candidato-info d-flex flex-column gap-1\">\n                            ${etapa_descarte_html}\n                            ${(origen === 'modal' && fecha_descarte) ? `\n                                <div class=\"d-flex align-items-center gap-2\">\n                                    <span class=\"icono-info-centrado\">\n                                        <i class=\"bi bi-calendar-event\"></i>\n                                    </span>\n                                    <span class=\"text-label-2\">Fecha de descarte: ${fecha_descarte}</span>\n                                </div>\n                            ` : ''}\n                            ${documento ? `\n                                <div class=\"d-flex align-items-center gap-2\">\n                                    <span class=\"icono-info-centrado\">\n                                        <img width=\"12\" height=\"16\" src=\"/iconos/file-person.png\">\n                                    </span>\n                                    <span class=\"text-label-2\">No. documento: ${documento}</span>\n                                </div>\n                            ` : ''}\n                            ${experiencia ? `\n                                <div class=\"d-flex align-items-center gap-2\">\n                                    <span class=\"icono-info-centrado\">\n                                        <i class=\"bi bi-briefcase\"></i>\n                                    </span>\n                                    <span class=\"text-label-2\">Experiencia: ${experiencia}</span>\n                                </div>\n                            ` : ''}\n                            ${salario_solicitado ? `\n                                <div class=\"d-flex align-items-center gap-2\">\n                                    <span class=\"icono-info-centrado\">\n                                        <i class=\"bi bi-currency-dollar\"></i>\n                                    </span>\n                                    <span class=\"text-label-2\">${salario_solicitado}</span>\n                                </div>\n                            ` : ''}\n                        </div>\n                    </div>\n\n                    <div class=\"d-flex flex-column align-items-end gap-2\">\n                        ${generarBotonesAccionCandidato(usuario_vacante, origen, nombre_etapa, etapa_anterior_contracion, tiene_motivo_abandono)}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Ver y calificar candidato.\n *\n * @param {number} candidato_id ID del candidato.\n * @returns {void}\n * @author Andres Morales\n */\nfunction verCalificarCandidatos(candidato_id) {\n    mostrarToast('info','Calificar candidato:', candidato_id);\n}\n\n/**\n * Mover candidato a la siguiente etapa.\n *\n * @param {number} etapa_vacante_usuario_id ID de la relación etapa-vacante-usuario.\n * @returns {void}\n * @author Andres Morales\n * @author Sergio Vargas - Modificación para modal de competencias\n */\nfunction moverEtapaCandidato(etapa_vacante_usuario_id) {\n    verificarSiguienteEtapa(etapa_vacante_usuario_id, function(es_contratados) {\n        if (es_contratados) {\n            // Obtener el valor de tiene_pruebas_requeridas desde el atributo data de la card\n            var $contenedor_candidato = $(`.candidato-card[data-etapa-vacante-usuario-id=\"${etapa_vacante_usuario_id}\"]`);\n            var tiene_pruebas = $contenedor_candidato.attr('data-tiene-pruebas-requeridas') === 'true';\n\n            if (tiene_pruebas) {\n                mostrarModalCompetenciasMejorar(etapa_vacante_usuario_id);\n            } else {\n                Swal.fire({\n                    width: '533px',\n                    showCloseButton: true,\n                    closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n                    showConfirmButton: false,\n                    showDenyButton: false,\n                    showCancelButton: false,\n                    html: `\n                        <div class=\"row w-100 mx-0 mt-2\">\n                            <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">Confirmar contratación</div>\n                            <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">\n                                Estás a punto de pasar a Contratados al canditato seleccionado y finalizar esta vacante.\n                            </div>\n                            <div class=\"col-12 mt-5 text-start text-body-2 fw-semibold\">\n                                ¿Deseas continuar?\n                            </div>\n                            <div class=\"col-6 mt-5 mb-2\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary w-100 justify-content-center',\n                                    texto: 'Volver',\n                                    onclick: `Swal.clickDeny();`\n                                })}\n                            </div>\n                            <div class=\"col-6 mt-5 mb-2\">\n                                ${crearBoton({\n                                    clases: 'btn-primary w-100 justify-content-center',\n                                    texto: 'Continuar con la contratación',\n                                    onclick: `Swal.clickConfirm();`\n                                })}\n                            </div>\n                        </div>\n                    `,\n                }).then(async (resultado) => {\n                    if (resultado.isConfirmed) {\n                        ejecutarMovimientoEtapa(etapa_vacante_usuario_id);\n                    }\n                });\n            }\n        } else {\n            ejecutarMovimientoEtapa(etapa_vacante_usuario_id);\n        }\n    });\n}\n\n/**\n * Inicializar eventos de checkboxes.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction inicializarEventosCheckboxes() {\n    $(document).off('change', 'input[name=\"candidato_check\"]');\n    $(document).on('change', 'input[name=\"candidato_check\"]', function() {\n        let $etapa_tarjeta = $(this).closest('.etapa-card');\n        validarEstadoCheckboxEtapa($etapa_tarjeta);\n\n        actualizarContadorSeleccionados();\n        actualizarEstadoBotonDescartar();\n    });\n\n    $(document).off('change', 'input[name=\"etapa_check\"]');\n    $(document).on('change', 'input[name=\"etapa_check\"]', function() {\n        let comprobado = $(this).is(':checked');\n\n        let $etapa_tarjeta = $(this).closest('.etapa-card');\n        $etapa_tarjeta.find('input[name=\"candidato_check\"]').prop('checked', comprobado);\n\n        actualizarContadorSeleccionados();\n        actualizarEstadoBotonDescartar();\n    });\n}\n\n/**\n * Validar y actualizar el estado del checkbox de una etapa según sus candidatos.\n *\n * @param {jQuery} $etapa_tarjeta Card de la etapa a validar.\n * @returns {void}\n * @author Andres Morales\n */\nfunction validarEstadoCheckboxEtapa($etapa_tarjeta) {\n    let $checkbox_etapa = $etapa_tarjeta.find('input[name=\"etapa_check\"]');\n    let $checkboxes_candidatos = $etapa_tarjeta.find('input[name=\"candidato_check\"]');\n\n    let total_candidatos = $checkboxes_candidatos.length;\n    let candidatos_seleccionados_etapa = $checkboxes_candidatos.filter(':checked').length;\n\n    if (candidatos_seleccionados_etapa === 0) {\n        $checkbox_etapa.prop('indeterminate', false);\n        $checkbox_etapa.prop('checked', false);\n    } else if (candidatos_seleccionados_etapa === total_candidatos) {\n        $checkbox_etapa.prop('indeterminate', false);\n        $checkbox_etapa.prop('checked', true);\n    } else {\n        $checkbox_etapa.prop('indeterminate', true);\n        $checkbox_etapa.prop('checked', false);\n    }\n}\n\n/**\n * Actualizar el contador de candidatos seleccionados.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction actualizarContadorSeleccionados() {\n    let checkboxes_seleccionados = $('input[name=\"candidato_check\"]:checked');\n    let contador = checkboxes_seleccionados.length;\n\n    $('#etapa-total-seleccionados').text(contador);\n\n    candidatos_seleccionados = checkboxes_seleccionados.map(function() {\n        return parseInt($(this).val(), 10);\n    }).get();\n}\n\n/**\n * Actualizar estado del botón de descartar.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction actualizarEstadoBotonDescartar() {\n    let hay_seleccionados = candidatos_seleccionados.length > 0;\n\n    if (hay_seleccionados) {\n        $('#etapa-boton-descartar').prop('disabled', false);\n        $('#etapa-boton-descartar').attr('onclick', 'descartarCandidatos()');\n    } else {\n        $('#etapa-boton-descartar').prop('disabled', true);\n        $('#etapa-boton-descartar').attr('onclick', '');\n    }\n}\n\n/**\n * Aplicar filtros y recargar etapas.\n *\n * @param {Object} filtros Objeto con filtros seleccionados.\n * @returns {void}\n * @author Andres Morales\n * @author Andres Gonzalez\n */\nfunction aplicarFiltrosDropdown(filtros) {\n    json_filtros_etapas = filtros;\n\n    let filtros_endpoint = {};\n\n    if (filtros.ciudad_filtro) filtros_endpoint.ciudad_id = filtros.ciudad_filtro;\n    if (filtros.departamento_filtro) filtros_endpoint.departamento_id = filtros.departamento_filtro;\n    if (filtros.pais_filtro) filtros_endpoint.pais_id = filtros.pais_filtro;\n    if (filtros.etapa_filtro) filtros_endpoint.etapa_id = filtros.etapa_filtro;\n    if (filtros.nivel_academico_filtro) filtros_endpoint.nivel_educativo_id = filtros.nivel_academico_filtro;\n    if (filtros.edad_filtro) filtros_endpoint.edad = filtros.edad_filtro;\n    if (filtros.nivel_adecuacion_filtro) filtros_endpoint.nivel_adecuacion = filtros.nivel_adecuacion_filtro;\n\n    if (filtros.fecha_agregado_filtro) {\n        let partes_fecha = filtros.fecha_agregado_filtro.split(' a ');\n        if (partes_fecha[0]) filtros_endpoint.fecha_desde = partes_fecha[0];\n        if (partes_fecha[1]) filtros_endpoint.fecha_hasta = partes_fecha[1];\n    }\n\n    if (filtros.chips && filtros.chips.length > 0) {\n        filtros_endpoint.chips = filtros.chips;\n    }\n\n    cargarEtapasConCandidatos(filtros_endpoint);\n}\n\n/**\n * Preparar objeto de filtros actuales para recargar etapas.\n *\n * @returns {Object} Objeto con filtros actuales.\n * @author Andres Morales\n */\nfunction prepararFiltrosActuales() {\n    let filtros_endpoint = {};\n\n    if (json_filtros_etapas.ciudad_filtro) filtros_endpoint.ciudad_id = json_filtros_etapas.ciudad_filtro;\n    if (json_filtros_etapas.departamento_filtro) filtros_endpoint.departamento_id = json_filtros_etapas.departamento_filtro;\n    if (json_filtros_etapas.pais_filtro) filtros_endpoint.pais_id = json_filtros_etapas.pais_filtro;\n    if (json_filtros_etapas.etapa_filtro) filtros_endpoint.etapa_id = json_filtros_etapas.etapa_filtro;\n    if (json_filtros_etapas.nivel_academico_filtro) filtros_endpoint.nivel_educativo_id = json_filtros_etapas.nivel_academico_filtro;\n    if (json_filtros_etapas.edad_filtro) filtros_endpoint.edad = json_filtros_etapas.edad_filtro;\n\n    if (json_filtros_etapas.fecha_agregado_filtro) {\n        let partes_fecha = json_filtros_etapas.fecha_agregado_filtro.split(' a ');\n        if (partes_fecha[0]) filtros_endpoint.fecha_desde = partes_fecha[0];\n        if (partes_fecha[1]) filtros_endpoint.fecha_hasta = partes_fecha[1];\n    }\n\n    if (json_filtros_etapas.chips && json_filtros_etapas.chips.length > 0) {\n        filtros_endpoint.chips = json_filtros_etapas.chips;\n    }\n\n    return filtros_endpoint;\n}\n\n/**\n * Inicializar eventos del modal de candidatos descartados.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction inicializarEventosModalDescartados() {\n    // Evento para checkboxes en modal de descartados\n    $('#contenedor-candidatos-descartados').off('change', 'input[name=\"candidato_check\"]');\n    $('#contenedor-candidatos-descartados').on('change', 'input[name=\"candidato_check\"]', function() {\n        actualizarEstadoBotonRevertirDescarte();\n    });\n\n    // Evento para búsqueda en candidatos descartados\n    $('#buscar-candidatos-descartados').off('input');\n    $('#buscar-candidatos-descartados').on('input', function() {\n        let termino_busqueda = $(this).val().toLowerCase().trim();\n        filtrarCandidatosDescartados(termino_busqueda);\n    });\n\n    // Limpiar búsqueda al cerrar el modal\n    $('#modal-candidatos-descartados').off('hidden.bs.modal');\n    $('#modal-candidatos-descartados').on('hidden.bs.modal', function() {\n        $('#buscar-candidatos-descartados').val('');\n        $('#contenedor-candidatos-descartados input[name=\"candidato_check\"]').prop('checked', false);\n        $('#boton-revertir-descarte-masivo').prop('disabled', true);\n    });\n}\n\n/**\n * Actualizar estado del botón de revertir descarte masivo.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction actualizarEstadoBotonRevertirDescarte() {\n    let checkboxes_seleccionados = $('#contenedor-candidatos-descartados input[name=\"candidato_check\"]:checked');\n    let hay_seleccionados = checkboxes_seleccionados.length > 0;\n\n    $('#boton-revertir-descarte-masivo').prop('disabled', !hay_seleccionados);\n}\n\n/**\n * Filtrar candidatos descartados por término de búsqueda.\n *\n * @param {string} termino Término de búsqueda.\n * @returns {void}\n * @author Andres Morales\n */\nfunction filtrarCandidatosDescartados(termino) {\n    $('#contenedor-candidatos-descartados .candidato-card').each(function() {\n        let $tarjeta = $(this);\n        let nombre = $tarjeta.find('.candidato-nombre').text().toLowerCase();\n        let ubicacion = $tarjeta.find('.bi-geo-alt').next('span').text().toLowerCase();\n        let etapa_descarte = $tarjeta.find('.tag-tonal-orange').text().toLowerCase();\n\n        let coincide = nombre.includes(termino) || ubicacion.includes(termino) || etapa_descarte.includes(termino);\n\n        if (coincide || termino === '') {\n            $tarjeta.removeClass('d-none');\n        } else {\n            $tarjeta.addClass('d-none');\n        }\n    });\n}\n\n/**\n * Revertir descarte de un candidato individual.\n *\n * @param {number} etapa_vacante_usuario_id ID de la relación etapa-vacante-usuario.\n * @returns {void}\n * @author Andres Morales\n */\nfunction devolverDescarteCandidato(etapa_vacante_usuario_id) {\n    revertirDescarte([etapa_vacante_usuario_id]);\n}\n\n/**\n * Revertir descarte de candidatos seleccionados.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction revertirDescarteMasivo() {\n    let checkboxes_seleccionados = $('#contenedor-candidatos-descartados input[name=\"candidato_check\"]:checked');\n\n    if (checkboxes_seleccionados.length === 0) {\n        mostrarToast('warning', 'Selecciona al menos un candidato para revertir el descarte');\n        return;\n    }\n\n    let revertir_ids = checkboxes_seleccionados.map(function() {\n        return parseInt($(this).val(), 10);\n    }).get();\n\n    revertirDescarte(revertir_ids);\n}\n\n/**\n * Revertir descarte de uno o varios candidatos con confirmación.\n *\n * @param {Array} ids Array de IDs de relaciones etapa-vacante-usuario.\n * @returns {void}\n * @author Andres Morales\n */\nfunction revertirDescarte(ids) {\n    let cantidad = ids.length;\n\n    Swal.fire({\n        showCloseButton: true,\n        closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n        showConfirmButton: false,\n        showDenyButton: false,\n        showCancelButton: false,\n        html: `\n            <div class=\"row w-100 mx-0 mt-2\">\n                <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">¿Revertir descarte?</div>\n                <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">\n                   ¿Estás seguro que deseas revertir el descarte ${cantidad === 1 ? 'del candidato' : 'de los candidatos'}?\n                </div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-outline-primary w-100 justify-content-center',\n                        texto: 'Cancelar',\n                        onclick: `Swal.clickDeny();`\n                    })}\n                </div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-primary w-100 justify-content-center',\n                        texto: 'Revertir',\n                        onclick: `Swal.clickConfirm();`\n                    })}\n                </div>\n            </div>\n        `,\n    }).then((resultado) => {\n        if (resultado.isConfirmed) {\n            ejecutarRevertirDescarte(ids);\n        }\n    });\n}\n\n/**\n * Ejecutar la reversión de descarte.\n *\n * @param {Array} ids Array de IDs de relaciones etapa-vacante-usuario.\n * @returns {void}\n * @author Andres Morales\n */\nfunction ejecutarRevertirDescarte(ids) {\n    if (ids.length > 1) {\n        $('#boton-revertir-descarte-masivo').prop('disabled', true).html('<i class=\"bi bi-hourglass-split\"></i> Procesando...');\n    }\n\n    $.ajax({\n        url: '/vacantes-revertir-descarte-aplicantes',\n        type: 'POST',\n        dataType: 'json',\n        headers: {\n            'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n        },\n        data: {\n            ids: ids\n        },\n        success: function(respuesta) {\n            mostrarToast('success', respuesta.message || 'Descarte revertido exitosamente');\n            $('#modal-candidatos-descartados').modal('hide');\n            cargarEtapasConCandidatos(prepararFiltrosActuales());\n        },\n        error: function(xhr) {\n            var mensaje = xhr.responseJSON?.message || 'Error al revertir el descarte';\n            mostrarToast('danger', mensaje);\n        },\n        complete: function() {\n            if (ids.length > 1) {\n                $('#boton-revertir-descarte-masivo').prop('disabled', false).html('Revertir descarte');\n            }\n        }\n    });\n}\n\n/**\n * Verificar si la siguiente etapa es \"Contratados\".\n *\n * @param {number} etapa_vacante_usuario_id ID de la relación.\n * @param {function} callback Función callback con resultado booleano.\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction verificarSiguienteEtapa(etapa_vacante_usuario_id, callback) {\n    var $contenedor_candidato = $(`.candidato-card[data-etapa-vacante-usuario-id=\"${etapa_vacante_usuario_id}\"]`);\n    var $etapa_contenedor = $contenedor_candidato.closest('.etapa-card');\n    var $siguiente_etapa = $etapa_contenedor.next('.etapa-card');\n\n    if ($siguiente_etapa.length > 0) {\n        var nombre_siguiente_etapa = $siguiente_etapa.find('.etapa-titulo').text().trim();\n        callback(nombre_siguiente_etapa === 'Contratados');\n    } else {\n        callback(false);\n    }\n}\n\n/**\n * Ejecutar el movimiento de etapa (flujo normal).\n *\n * @param {number} etapa_vacante_usuario_id ID de la relación.\n * @returns {void}\n * @author Sergio Vargas\n * @author Andres Gonzalez\n * @author Jair Carvajal\n * @author Andres Morales\n */\nfunction ejecutarMovimientoEtapa(etapa_vacante_usuario_id) {\n    var botones_mover_etapa = $(`.btn-mover-etapa-accion[data-etapa-vacante-usuario-id=\"${etapa_vacante_usuario_id}\"]`);\n    botones_mover_etapa.prop('disabled', true);\n\n    var modal_detalle_abierto = $('#modal-detalle-resultados').hasClass('show');\n\n    if (modal_detalle_abierto) {\n        moverVacantesEtapaAplicante(etapa_vacante_usuario_id);\n        return;\n    }\n\n    var seccion_candidato = $(`.candidato-card[data-etapa-vacante-usuario-id=\"${etapa_vacante_usuario_id}\"]`);\n\n    if (seccion_candidato.length > 0) {\n        var etapa_actual = seccion_candidato.closest('.etapa-card');\n        var etapa_siguiente = etapa_actual.next('.etapa-card');\n\n        if (etapa_siguiente.length > 0) {\n            var $contenedor_etapas = $('#contenido-etapas-lista');\n            var posicion_original = seccion_candidato.offset();\n            var ancho_original = seccion_candidato.outerWidth();\n            var alto_original = seccion_candidato.outerHeight();\n\n            var contenedor_candidatos_siguiente = etapa_siguiente.find('.candidatos-container');\n            if (contenedor_candidatos_siguiente.length === 0) {\n                contenedor_candidatos_siguiente = etapa_siguiente.find('.card-body');\n            }\n            var posicion_siguiente = contenedor_candidatos_siguiente.offset();\n            var ancho_contenedor = contenedor_candidatos_siguiente.outerWidth();\n            var margen = 85;\n\n            var izquierda_centrado = posicion_siguiente.left + (ancho_contenedor / 2) - (ancho_original / 2);\n            var arriba_margen = posicion_siguiente.top + margen;\n\n            var posicion_contenedor = $contenedor_etapas.offset();\n            var arriba_contenedor = posicion_contenedor.top;\n            var izquierda_contenedor = posicion_contenedor.left;\n            var ancho_contenedor_pixel = $contenedor_etapas.outerWidth();\n            var alto_contenedor_pixel = $contenedor_etapas.outerHeight();\n\n            var envolvente_animacion = $('<div id=\"wrapper-animacion-candidato\"></div>').css({\n                position: 'fixed',\n                top: arriba_contenedor + 'px',\n                left: izquierda_contenedor + 'px',\n                width: ancho_contenedor_pixel + 'px',\n                height: alto_contenedor_pixel + 'px',\n                overflow: 'hidden',\n                'z-index': 9998,\n                'pointer-events': 'none'\n            });\n\n            var inicial_arriba_relativo = posicion_original.top - arriba_contenedor;\n            var inicial_izquierda_relativo = posicion_original.left - izquierda_contenedor - 15;\n            var final_arriba_relativo = arriba_margen - arriba_contenedor;\n            var final_izquierda_relativo = izquierda_centrado - 10 - izquierda_contenedor;\n\n            var seccion_clonada = seccion_candidato.clone();\n            seccion_clonada.css({\n                position: 'absolute',\n                top: inicial_arriba_relativo + 'px',\n                left: inicial_izquierda_relativo + 'px',\n                width: ancho_original + 'px',\n                height: alto_original + 'px',\n                margin: 0,\n                transition: 'all 500ms ease-out',\n                'z-index': 1\n            });\n\n            $('body').append(envolvente_animacion);\n            envolvente_animacion.append(seccion_clonada);\n            seccion_candidato.css('visibility', 'hidden');\n\n            seccion_clonada[0].offsetHeight;\n\n            seccion_clonada.css({\n                top: final_arriba_relativo + 'px',\n                left: final_izquierda_relativo + 'px'\n            });\n\n            setTimeout(function() {\n                moverVacantesEtapaAplicante(etapa_vacante_usuario_id, etapa_siguiente);\n            }, 430);\n\n            setTimeout(function() {\n                envolvente_animacion.remove();\n            }, 1000);\n        } else {\n            moverVacantesEtapaAplicante(etapa_vacante_usuario_id);\n        }\n    } else {\n        moverVacantesEtapaAplicante(etapa_vacante_usuario_id);\n    }\n}\n\n/**\n * Animar el movimiento de la tarjeta hacia la siguiente etapa.\n *\n * @param {Object} tarjeta_candidato Tarjeta del candidato.\n * @param {Object} etapa_destino Etapa destino.\n * @returns {void}\n * @author Esperanza Olivo\n */\nfunction animarMovimientoEtapaCandidato(tarjeta_candidato, etapa_destino) {\n    $('#candidato-animacion-temp').remove();\n\n    var posicion_tarjeta = tarjeta_candidato.offset();\n    var ancho_tarjeta = tarjeta_candidato.outerWidth();\n    var alto_tarjeta = tarjeta_candidato.outerHeight();\n    var scroll_vertical = $(window).scrollTop();\n\n    var contenedor_destino = etapa_destino.find('.candidatos-container').first();\n    var destino = contenedor_destino.offset();\n    var destino_ancho = contenedor_destino.outerWidth();\n\n    tarjeta_candidato.css('visibility', 'hidden');\n    contenedor_destino.find('.mensaje-etapa-vacia').remove();\n    contenedor_destino.append(tarjeta_candidato);\n\n    var posicion_final = tarjeta_candidato.offset();\n\n    var tarjeta_clon_candidato = tarjeta_candidato.clone().attr('id', 'candidato-animacion-temp').css({\n        position: 'fixed',\n        top: posicion_tarjeta.top - scroll_vertical,\n        left: posicion_tarjeta.left,\n        width: ancho_tarjeta,\n        height: alto_tarjeta,\n        margin: 0,\n        zIndex: 9999,\n        visibility: 'visible',\n        pointerEvents: 'none',\n        boxShadow: '0 8px 25px rgba(0,0,0,0.18)'\n    });\n\n    $('body').append(tarjeta_clon_candidato);\n\n    tarjeta_clon_candidato.animate({\n        top: posicion_final.top - scroll_vertical,\n        left: destino.left + (destino_ancho - ancho_tarjeta) / 2\n    }, 180, 'swing', function() {\n        tarjeta_clon_candidato.remove();\n        tarjeta_candidato.css('visibility', 'visible');\n\n    });\n}\n\n/**\n * Ejecutar el movimiento de etapa (Envio de ajax).\n *\n * @param {number} etapa_vacante_usuario_id ID de la relación.\n * @param {jQuery} etapa_siguiente Etapa destino (opcional).\n * @returns {void}\n * @author Jair Carvajal\n * @author Andres Morales\n */\nfunction moverVacantesEtapaAplicante(etapa_vacante_usuario_id, etapa_siguiente = null) {\n    $.ajax({\n        url: `/vacantes-mover-etapa-aplicante/${etapa_vacante_usuario_id}`,\n        type: 'POST',\n        dataType: 'json',\n        headers: {'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')},\n        success: function(respuesta) {\n            $('#modal-detalle-resultados').modal('hide');\n            mostrarToast('success', respuesta.message);\n\n            if (etapa_siguiente && etapa_siguiente.length > 0) {\n                var filtros_actuales = prepararFiltrosActuales();\n                cargarEtapasConCandidatos(filtros_actuales);\n\n                setTimeout(function() {\n                    scrollHaciaEtapa(etapa_siguiente);\n                }, 300);\n            } else {\n                cargarEtapasConCandidatos(prepararFiltrosActuales());\n            }\n        },\n        error: function(xhr) {\n            var mensaje = xhr.responseJSON?.message || 'Error al mover el candidato de etapa';\n            mostrarToast('danger', mensaje);\n            var botones_mover_etapa = $(`.btn-mover-etapa-accion[data-etapa-vacante-usuario-id=\"${etapa_vacante_usuario_id}\"]`);\n            botones_mover_etapa.prop('disabled', false);\n        }\n    });\n}\n\n/**\n * Mostrar modal de competencias por mejorar.\n *\n * @param {number} etapa_vacante_usuario_id ID de la relación.\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction mostrarModalCompetenciasMejorar(etapa_vacante_usuario_id) {\n    window.etapa_vacante_usuario_pendiente = etapa_vacante_usuario_id;\n\n    $.ajax({\n        url: `/vacantes-competencias-mejorar/${etapa_vacante_usuario_id}`,\n        type: 'GET',\n        dataType: 'json',\n        beforeSend: function() {\n            $('#contenedor-competencias-mejorar').html(`\n                <div class=\"text-center py-5\">\n                    <div class=\"spinner-border text-primary\" role=\"status\">\n                        <span class=\"visually-hidden\">Cargando...</span>\n                    </div>\n                    <p class=\"mt-3 text-muted\">Consultando competencias...</p>\n                </div>\n            `);\n            $('#modal-competencias-mejorar').modal('show');\n        },\n        success: function(respuesta) {\n            renderizarCompetenciasMejorar(respuesta.data);\n\n            if (respuesta.data.usuario_id) {\n                var url_sso = `/sso/wordpress?student_id=${respuesta.data.usuario_id}&etapa_vacante_usuario_id=${window.etapa_vacante_usuario_pendiente}`;\n                $('#btn-plataforma-capacitacion')\n                    .attr('href', url_sso)\n                    .attr('data-usuario-id', respuesta.data.usuario_id);\n            }\n        },\n        error: function(xhr) {\n            var mensaje = xhr.responseJSON?.message || 'Error al obtener competencias';\n            $('#contenedor-competencias-mejorar').html(`\n                <div class=\"alert alert-warning\" role=\"alert\">\n                    <i class=\"bi bi-exclamation-triangle me-2\"></i>${mensaje}\n                </div>\n            `);\n        }\n    });\n}\n\n/**\n * Renderizar competencias en el modal.\n *\n * @param {Object} data Datos de competencias agrupadas por prueba.\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction renderizarCompetenciasMejorar(data) {\n    var html = '';\n\n    if (!data.pruebas || data.pruebas.length === 0) {\n        html = `\n            <div class=\"alert alert-info\" role=\"alert\">\n                <i class=\"bi bi-info-circle me-2\"></i>\n                No se encontraron resultados de pruebas psicométricas para este candidato.\n            </div>\n        `;\n    } else {\n        data.pruebas.forEach(function(prueba) {\n            html += `\n                <div class=\"card mb-3\">\n                    <div class=\"card-header bg-primary text-white\">\n                        <h6 class=\"mb-0\">\n                            <i class=\"bi bi-clipboard-data me-2\"></i>${prueba.nombre_prueba}\n                        </h6>\n                    </div>\n                    <div class=\"card-body\">\n            `;\n\n            if (prueba.competencias && prueba.competencias.length > 0) {\n                html += '<ul class=\"list-group list-group-flush\">';\n                prueba.competencias.forEach(function(competencia, index) {\n                    var color_badge = competencia.puntaje < 40 ? 'bg-danger' :\n                                     competencia.puntaje < 70 ? 'bg-warning' : 'bg-success';\n                    html += `\n                        <li class=\"list-group-item d-flex justify-content-between align-items-center\">\n                            <div><strong>${index + 1}. ${competencia.nombre}</strong></div>\n                            <span class=\"badge ${color_badge} rounded-pill\">${competencia.puntaje} pts</span>\n                        </li>\n                    `;\n                });\n                html += '</ul>';\n            } else {\n                html += `<p class=\"text-muted mb-0\">\n                    <i class=\"bi bi-info-circle me-2\"></i>\n                    No se identificaron competencias específicas para esta prueba.\n                </p>`;\n            }\n            html += `</div></div>`;\n        });\n    }\n\n    $('#contenedor-competencias-mejorar').html(html);\n}\n\n/**\n * Cerrar modal y ejecutar movimiento de etapa.\n *\n * @returns {void}\n * @author Sergio Vargas\n */\nfunction cerrarModalCompetenciasMejorar() {\n    $('#modal-competencias-mejorar').modal('hide');\n    if (window.etapa_vacante_usuario_pendiente) {\n        ejecutarMovimientoEtapa(window.etapa_vacante_usuario_pendiente);\n        window.etapa_vacante_usuario_pendiente = null;\n    }\n}\n\n/**\n * Crear mensaje cuando la etapa de prueba técnica no tiene archivos de instrucciones.\n *\n * @param {number} etapa_id ID de la etapa.\n * @returns {string} HTML del mensaje.\n * @author Andres Morales\n */\nfunction crearMensajeSinArchivosInstrucciones(etapa_id) {\n    return `\n        <div class=\"card candidato-card mb-3\">\n            <div class=\"card-body p-4\">\n                <div class=\"d-flex flex-column justify-content-center align-items-center py-3\">\n                    <i class=\"bi bi-folder\" style=\"font-size: 80px; color: #9CA3AF;\"></i>\n                    <p class=\"text-headline-6 text-gray-30 text-center mb-0 mt-4 px-4\">\n                        Adjunta una prueba o elimina esta etapa para continuar.\n                    </p>\n                    <div class=\"d-flex gap-3 mt-4\">\n                        ${crearBoton({\n                            clases: 'btn-primary',\n                            texto: 'Adjuntar prueba técnica',\n                            onclick: `abrirModalAdjuntarInstrucciones(${etapa_id})`\n                        })}\n                        ${crearBoton({\n                            clases: 'btn-outline-danger',\n                            texto: 'Eliminar etapa',\n                            onclick: `eliminarEtapaPruebaTecnica(${etapa_id})`\n                        })}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Generar botones de acción para un candidato según el contexto.\n *\n * @param {Object} usuario_vacante Datos del candidato.\n * @param {string} origen 'listado' o 'modal'.\n * @param {string} nombre_etapa Nombre de la etapa.\n * @param {boolean} etapa_anterior_contracion Si es etapa anterior a Contratados.\n * @param {boolean} tiene_motivo_abandono Si el candidato abandonó.\n * @returns {string} HTML de los botones.\n * @author Andres Morales\n * @author José Manuel Jiménez\n */\nfunction generarBotonesAccionCandidato(usuario_vacante, origen, nombre_etapa, etapa_anterior_contracion, tiene_motivo_abandono) {\n    let html = '';\n\n    // Lógica para etapa de Prueba técnica\n    if (origen === 'listado' && nombre_etapa === 'Prueba técnica') {\n        let prueba_tecnica = usuario_vacante.prueba_tecnica || {};\n        let tiene_prueba = prueba_tecnica.existe && (prueba_tecnica.tiene_archivos || prueba_tecnica.tiene_enlace);\n        let tiene_calificacion = usuario_vacante.puntaje !== null;\n\n        if (!tiene_prueba) {\n            // Ojo gris - candidato NO ha subido su prueba\n            html += crearBoton({\n                clases: 'btn-outline-secondary btn-circle',\n                texto: '<i class=\"bi bi-eye-slash\"></i>',\n                disabled: true,\n                tooltip: crearTooltip({\n                    content: 'Candidato no ha subido su prueba técnica',\n                    placement: 'bottom'\n                })\n            });\n        } else if (!tiene_calificacion) {\n            // Ojo azul - abre detalle del candidato para calificar\n            html += crearBoton({\n                clases: 'btn-outline-primary btn-circle',\n                texto: '<i class=\"bi bi-eye\"></i>',\n                onclick: `verDetalleCandidato(${usuario_vacante.usuario.id}, 'Prueba técnica')`,\n                tooltip: crearTooltip({\n                    content: 'Ver detalle del candidato',\n                    placement: 'bottom'\n                })\n            });\n        } else {\n            // Flecha - puede mover de etapa\n            html += crearBoton({\n                clases: 'btn-outline-primary btn-circle btn-mover-etapa-accion',\n                adicional: `data-etapa-vacante-usuario-id=\"${usuario_vacante.id}\"`,\n                texto: '<i class=\"bi bi-arrow-90deg-right\"></i>',\n                onclick: `moverEtapaCandidato(${usuario_vacante.id})`,\n                tooltip: crearTooltip({\n                    content: 'Mover de etapa',\n                    placement: 'bottom'\n                })\n            });\n        }\n    } else if (origen === 'listado' && nombre_etapa !== 'Contratados') {\n        // Lógica para otras etapas (código existente)\n        let icono = '<i class=\"bi bi-arrow-90deg-right\"></i>';\n        let mensaje = 'Mover de etapa';\n        if (etapa_anterior_contracion) {\n            icono = '<i class=\"bi bi-file-earmark-person\"></i>';\n            mensaje = 'Seleccionar como contratado';\n        }\n\n        html += crearBoton({\n            clases: 'btn-outline-primary btn-circle btn-mover-etapa-accion',\n            adicional: `data-etapa-vacante-usuario-id=\"${usuario_vacante.id}\"`,\n            texto: icono,\n            onclick: `moverEtapaCandidato(${usuario_vacante.id})`,\n            tooltip: crearTooltip({\n                content: mensaje,\n                placement: 'bottom'\n            }),\n            disabled: nombre_etapa === 'Documentos para contratación'\n                ? !usuario_vacante.etapa_completada\n                : ((usuario_vacante.puntaje === null && usuario_vacante.puntaje_ia === null) || usuario_vacante.etapa_completada === false || (usuario_vacante?.formato_entrevista_completado !== undefined && usuario_vacante?.formato_entrevista_completado === false))\n        });\n    }\n\n    // Botón de descartar\n    if (origen === 'listado' && nombre_etapa !== 'Contratados') {\n        html += crearBoton({\n            clases: 'btn-outline-danger btn-circle',\n            texto: `<i class=\"bi bi-person-x\"></i>`,\n            onclick: `descartarCandidatos(${usuario_vacante.id})`,\n            tooltip: crearTooltip({\n                content: 'Descartar candidato',\n                placement: 'bottom'\n            })\n        });\n    }\n\n    // Botón de revertir descarte (para modal)\n    if (origen === 'modal') {\n        html += crearBoton({\n            clases: 'btn-outline-success btn-circle',\n            texto: `<i class=\"bi bi-person-add\"></i>`,\n            onclick: `devolverDescarteCandidato(${usuario_vacante.id})`,\n            tooltip: crearTooltip({\n                content: tiene_motivo_abandono ? 'No se puede revertir: candidato abandonó' : 'Revertir descarte',\n                placement: 'bottom'\n            }),\n            disabled: tiene_motivo_abandono\n        });\n    }\n\n    return html;\n}\n\nvar archivos_instrucciones_prueba = [];\n\n/**\n * Abrir modal para adjuntar instrucciones de prueba técnica.\n *\n * @param {number} etapa_id ID de la etapa.\n * @returns {void}\n * @author Andres Morales\n */\nfunction abrirModalAdjuntarInstrucciones(etapa_id) {\n    $('#modal-adjuntar-instrucciones-prueba-tecnica').remove();\n\n    archivos_instrucciones_prueba = [];\n\n    $.ajax({\n        url: `/etapas-vacantes/${etapa_id}/obtener-configuraciones-prueba-tecnica`,\n        type: 'GET',\n        success: function(respuesta) {\n            crearModalConDatos(etapa_id, respuesta.data ||{});\n        },\n        error: function() {\n            crearModalConDatos(etapa_id, {});\n        }\n    });\n}\n\n/**\n * Crear el modal con los datos existentes.\n *\n * @param {number} etapa_id ID de la etapa.\n * @param {Object} datos Datos de configuración existentes.\n * @returns {void}\n * @author Andres Morales\n */\nfunction crearModalConDatos(etapa_id, datos = {}) {\n    let descripcion_valor = datos.descripcion || '';\n    let enlace_valor = datos.enlace || '';\n\n    let modal_html = crearModal({\n        id: 'modal-adjuntar-instrucciones-prueba-tecnica',\n        titulo_header: 'Prueba técnica',\n        dialog_class: 'modal-dialog-centered modal-lg modal-dialog-scrollable',\n        adiconales_modals_header: 'data-bs-backdrop=\"static\"',\n        modal_body: `\n            <form class=\"col-12 px-3\" id=\"form-adjuntar-instrucciones\" enctype=\"multipart/form-data\">\n                <input type=\"hidden\" name=\"etapa_vacante_id\" value=\"${etapa_id}\">\n                <div class=\"col-12 px-0 text-label-1 py-2\">\n                    Puedes habilitar esta etapa aunque no tengas aún la prueba lista. Sube el archivo más adelante.\n                </div>\n                <div class=\"col-12 px-0 text-body-2 text-gray-10 my-3\">\n                    Agrega una descripción a la prueba\n                </div>\n                <div class=\"col-12 my-2 pb-2\">\n                    ${crearTextarea({\n                        id: 'descripcion_prueba',\n                        name: 'descripcion',\n                        placeholder: '',\n                        required: true,\n                        value: descripcion_valor,\n                        label: 'Descripción',\n                        contador: 1500\n                    })}\n                </div>\n                <div class=\"col-12 px-4 rounded-3 border\">\n                    <div class=\"row\">\n                        <div class=\"col-12 text-body-2 text-gray-10 my-3\">\n                            Adjuntar prueba técnica\n                        </div>\n                        <div class=\"col-12\">\n                            ${crearInput({\n                                id: 'enlace_prueba',\n                                name: 'enlace',\n                                input_container_class: 'mb-4',\n                                label: 'Agregar enlace',\n                                required: false,\n                                value: enlace_valor,\n                                adicional: 'style=\"height: 60px;\"'\n                            })}\n                        </div>\n                        <div class=\"col-12\">\n                            ${crearInputFile({\n                                id: 'archivo_prueba',\n                                name: 'archivo_prueba',\n                                placeholder: '',\n                                disabled: false,\n                                required: false,\n                                multiple: true,\n                                accept: 'image/jpg,image/jpeg,image/png,application/pdf,.doc,.docx,.xls,.xlsx',\n                            })}\n                        </div>\n                        <div class=\"col-12 pb-4\">\n                            <div class=\"col-12 pt-4 px-4 mb-4 rounded-3 border text-body-3\">\n                                Los archivos tienen que:\n                                <ul class=\"text-body-2 text-gray-10\">\n                                    <li>Estar en formato JPG, PNG, PDF, DOCX o XLSX.</li>\n                                    <li>No superar los 2000 px de alto y pesar máximo 5GB.</li>\n                                </ul>\n                            </div>\n                            <div class=\"col-12\">\n                                <div class=\"row g-3\" id=\"contenedor-archivos-instrucciones\"></div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </form>\n        `,\n        boton_footer1: {\n            texto: 'Cancelar',\n            class: 'btn-outline-primary',\n            cerrar_modal: true\n        },\n        boton_footer2: {\n            texto: 'Guardar',\n            class: 'btn-primary',\n            id: 'btn-guardar-instrucciones',\n            onclick: 'adjuntarInstruccionesPruebaTecnica()',\n            disabled: true\n        }\n    });\n\n    $('body').append(modal_html);\n\n    $('#modal-adjuntar-instrucciones-prueba-tecnica').on('shown.bs.modal', function() {\n        inicializarIputsFile();\n\n        $('#archivo_prueba').off('change').on('change', function (e) {\n            let archivos_seleccionados = e.target.files;\n            for (let i = 0; i < archivos_seleccionados.length; i++) {\n                let archivo = archivos_seleccionados[i];\n                let nombre_repetido = archivos_instrucciones_prueba.some(item => item.archivo.name === archivo.name);\n                if (!nombre_repetido) {\n                    archivos_instrucciones_prueba.push({\n                        archivo: archivo,\n                        seleccionado: true,\n                        id: Date.now() + '_' + i\n                    });\n                } else {\n                    mostrarToast('warning', `El archivo \"${archivo.name}\" ya fue seleccionado anteriormente.`);\n                }\n            }\n            renderizarArchivosInstrucciones();\n        });\n\n        validarCamposModalPruebaTecnicaDetalle();\n\n        inicializarTooltips();\n    });\n\n    // Limpiar cuando se cierra el modal\n    $('#modal-adjuntar-instrucciones-prueba-tecnica').on('hidden.bs.modal', function() {\n        // Liberar todas las URLs temporales de las imágenes\n        $('#contenedor-archivos-instrucciones img').each(function() {\n            URL.revokeObjectURL($(this).attr('src'));\n        });\n\n        $('#contenedor-archivos-instrucciones').empty();\n        $('#archivo_prueba').val('');\n        archivos_instrucciones_prueba = [];\n        $(this).remove();\n    });\n\n    $('#modal-adjuntar-instrucciones-prueba-tecnica').modal('show');\n}\n\n/**\n * Renderizar archivos seleccionados para instrucciones.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction renderizarArchivosInstrucciones() {\n    let contenedor = $('#contenedor-archivos-instrucciones');\n    contenedor.empty();\n\n    if (archivos_instrucciones_prueba.length === 0) {\n        return;\n    }\n\n    let documentos = [];\n    let imagenes = [];\n\n    archivos_instrucciones_prueba.forEach((item) => {\n        if (!item.seleccionado) return;\n\n        let archivo = item.archivo;\n        let extension = archivo.name.split('.').pop().toLowerCase();\n        let es_imagen = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension);\n\n        if (es_imagen) {\n            imagenes.push(item);\n        } else {\n            documentos.push(item);\n        }\n    });\n\n    documentos.forEach((item) => {\n        let archivo = item.archivo;\n        let extension = archivo.name.split('.').pop().toLowerCase();\n        let icono = obtenerIconoPorExtensionDetalle(extension);\n\n        let html = `\n            <div class=\"col-auto archivo-item\">\n                <div class=\"col-auto px-3 border rounded-2\">\n                    <div class=\"row align-items-center\">\n                        <div class=\"col-auto py-3\">\n                            <i class=\"${icono}\"></i>\n                        </div>\n                        <div class=\"col px-0 py-3 text-blue-40\"\n                             ${crearTooltip({placement: 'top', content: archivo.name, toggle: 'popover'})}>\n                            ${archivo.name}\n                        </div>\n                        <div class=\"col-auto\">\n                            <i class=\"bi bi-trash-fill text-danger pointer\" onclick=\"quitarArchivoInstruccion('${item.id}')\"></i>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n\n        contenedor.append(html);\n    });\n\n    imagenes.forEach((item) => {\n        let archivo = item.archivo;\n        let url_imagen = URL.createObjectURL(archivo);\n\n        let html = `\n            <div class=\"col-auto archivo-item\">\n                <div class=\"px-3 border rounded-2 contenedor-archivo-imagen\">\n                    <div class=\"row align-items-center\">\n                        <img class=\"col-12 px-0 imagen-archivo-previsualizacion\"\n                             src=\"${url_imagen}\"\n                             alt=\"${archivo.name}\"\n                             style=\"height: 97px; object-fit: cover; border-radius: 6px 6px 0 0;\">\n                    </div>\n                    <div class=\"row align-items-center\">\n                        <div class=\"col pe-0 py-3 text-blue-40 text-truncate\"\n                             ${crearTooltip({placement: 'top', content: archivo.name, toggle: 'popover'})}>\n                            ${archivo.name}\n                        </div>\n                        <div class=\"col-auto\">\n                            <i class=\"bi bi-trash-fill text-danger pointer\" onclick=\"quitarArchivoInstruccion('${item.id}')\"></i>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n\n        contenedor.append(html);\n    });\n\n    inicializarTooltips();\n}\n\n/**\n * Quitar archivo de instrucciones seleccionado.\n *\n * @param {string} id ID del archivo.\n * @returns {void}\n * @author Andres Morales\n */\nfunction quitarArchivoInstruccion(id) {\n    // Buscar la imagen en el DOM y revocar la URL temporal si existe\n    let img = $(`img[src]`).filter(function() {\n        return $(this).closest('.archivo-item').find(`[onclick*=\"${id}\"]`).length > 0;\n    });\n\n    if (img.length > 0) {\n        URL.revokeObjectURL(img.attr('src'));\n    }\n\n    archivos_instrucciones_prueba = archivos_instrucciones_prueba.filter(item => item.id !== id);\n\n    renderizarArchivosInstrucciones();\n}\n\n/**\n * Obtener icono por extensión de archivo con colores específicos.\n *\n * @param {string} extension Extensión del archivo.\n * @returns {string} Clase del icono con color.\n * @author Andres Morales\n */\nfunction obtenerIconoPorExtensionDetalle(extension) {\n    let iconos = {\n        'pdf': 'bi bi-filetype-pdf text-danger fs-2',          // Rojo\n        'doc': 'bi bi-filetype-docx text-primary fs-2',        // Azul\n        'docx': 'bi bi-filetype-docx text-primary fs-2',       // Azul\n        'xls': 'bi bi-filetype-xlsx text-success fs-2',        // Verde\n        'xlsx': 'bi bi-filetype-xlsx text-success fs-2',       // Verde\n        'jpg': 'bi bi-file-image text-info fs-2',              // Cyan\n        'jpeg': 'bi bi-file-image text-info fs-2',             // Cyan\n        'png': 'bi bi-file-image text-info fs-2',              // Cyan\n        'gif': 'bi bi-file-image text-info fs-2',              // Cyan\n        'bmp': 'bi bi-file-image text-info fs-2',              // Cyan\n        'webp': 'bi bi-file-image text-info fs-2'              // Cyan\n    };\n    return iconos[extension] || 'bi bi-file-earmark text-secondary fs-2';\n}\n\n/**\n * Adjuntar instrucciones de prueba técnica.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Andres Gonzalez\n */\nfunction adjuntarInstruccionesPruebaTecnica() {\n    let formulario_datos = new FormData();\n\n    formulario_datos.append('etapa_vacante_id', $('#form-adjuntar-instrucciones input[name=\"etapa_vacante_id\"]').val());\n    formulario_datos.append('descripcion', $('#descripcion_prueba').val());\n    formulario_datos.append('enlace', $('#enlace_prueba').val());\n    formulario_datos.append('notificar_aplicantes', 1);\n\n    archivos_instrucciones_prueba.forEach((item) => {\n        if (item.seleccionado) {\n            formulario_datos.append('archivos[]', item.archivo);\n        }\n    });\n\n    $('#btn-guardar-instrucciones').prop('disabled', true).html('<i class=\"bi bi-hourglass-split me-2\"></i>Guardando...');\n\n    $.ajax({\n        url: '/etapas-vacantes-adjuntar-archivos',\n        type: 'POST',\n        data: formulario_datos,\n        processData: false,\n        contentType: false,\n        headers: {'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')},\n        success: function(respuesta) {\n            mostrarToast('success', respuesta.message || 'Prueba técnica guardada correctamente');\n            $('#modal-adjuntar-instrucciones-prueba-tecnica').modal('hide');\n            cargarEtapasConCandidatos(prepararFiltrosActuales());\n        },\n        error: function(xhr) {\n            let mensaje = xhr.responseJSON?.message || 'Error al guardar la prueba técnica';\n            mostrarToast('danger', mensaje);\n            $('#btn-guardar-instrucciones').prop('disabled', false).html('Guardar');\n        }\n    });\n}\n\n/**\n * Eliminar etapa de prueba técnica.\n *\n * @param {number} etapa_id ID de la etapa.\n * @returns {void}\n * @author Andres Morales\n */\nfunction eliminarEtapaPruebaTecnica(etapa_id) {\n    Swal.fire({\n        width: '533px',\n        showCloseButton: true,\n        closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',\n        showConfirmButton: false,\n        showDenyButton: false,\n        showCancelButton: false,\n        html: `\n            <div class=\"row w-100 mx-0 mt-2\">\n                <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">\n                    ¿Eliminar etapa?\n                </div>\n                <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">\n                    Esta seguro de querer eliminar la etapa Prueba técnica.\n                </div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-outline-primary w-100 justify-content-center',\n                        texto: 'Cancelar',\n                        onclick: `Swal.clickDeny();`\n                    })}\n                </div>\n                <div class=\"col-6 mt-5 mb-2\">\n                    ${crearBoton({\n                        clases: 'btn-danger w-100 justify-content-center',\n                        texto: 'Eliminar etapa',\n                        onclick: `Swal.clickConfirm();`\n                    })}\n                </div>\n            </div>\n        `,\n    }).then((resultado) => {\n        if (resultado.isConfirmed) {\n            $.ajax({\n                url: `/etapas-vacantes/${etapa_id}/eliminar-etapa-prueba-tecnica`,\n                type: 'DELETE',\n                headers: {'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')},\n                success: function(respuesta) {\n                    mostrarToast('success', respuesta.message || 'Etapa eliminada correctamente');\n                    cargarEtapasConCandidatos(prepararFiltrosActuales());\n                },\n                error: function(xhr) {\n                    let mensaje = xhr.responseJSON?.message || 'Error al eliminar la etapa';\n                    mostrarToast('danger', mensaje);\n                }\n            });\n        }\n    });\n}\n\n/**\n * Validar campos del modal de prueba técnica en detalle y habilitar/deshabilitar botón guardar.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction validarCamposModalPruebaTecnicaDetalle() {\n    let campos = [\n        '#descripcion_prueba'\n    ];\n\n    // Agregar evento input a todos los campos\n    campos.forEach(function(campo) {\n        $(campo).on('input', function() {\n            validarYActualizarBotonGuardarDetalle();\n        });\n    });\n\n    validarYActualizarBotonGuardarDetalle();\n}\n\n/**\n * Validar campos y actualizar estado del botón guardar.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction validarYActualizarBotonGuardarDetalle() {\n    let descripcion = $('#descripcion_prueba').val().trim();\n\n    let es_valido = descripcion !== '';\n\n    $('#btn-guardar-instrucciones').prop('disabled', !es_valido);\n}\n\n/**\n * Hacer scroll suave hacia una etapa específica después del movimiento.\n *\n * @param {jQuery} etapa_destino Etapa a la que hacer scroll.\n * @returns {void}\n * @author Andres Morales\n */\nfunction scrollHaciaEtapa(etapa_destino) {\n    var $contenedor = $('#contenido-etapas-lista');\n\n    if (!$contenedor.length || !etapa_destino.length) {\n        return;\n    }\n\n    var etapa_id = etapa_destino.data('etapa-id');\n    var $etapa_actualizada = $(`.etapa-card[data-etapa-id=\"${etapa_id}\"]`);\n\n    if (!$etapa_actualizada.length) {\n        return;\n    }\n\n    var desplazamiento_izquierda_contenedor = $contenedor.scrollLeft();\n    var contenedor_ancho = $contenedor.outerWidth();\n    var ancho_desplazamiento_contenedor = $contenedor[0].scrollWidth;\n\n    var posicion_etapa = $etapa_actualizada.position().left;\n    var etapa_ancho = $etapa_actualizada.outerWidth();\n\n    var limite_izquierdo = desplazamiento_izquierda_contenedor;\n    var limite_derecho = desplazamiento_izquierda_contenedor + contenedor_ancho;\n\n    var etapa_visible = (posicion_etapa >= limite_izquierdo) &&\n                       ((posicion_etapa + etapa_ancho) <= limite_derecho);\n\n    if (etapa_visible) {\n        return;\n    }\n\n    var nueva_posicion_scroll = posicion_etapa - (contenedor_ancho / 2) + (etapa_ancho / 2);\n\n    nueva_posicion_scroll = Math.max(0, Math.min(nueva_posicion_scroll, ancho_desplazamiento_contenedor - contenedor_ancho));\n\n    $contenedor.animate(\n        { scrollLeft: nueva_posicion_scroll },\n        {\n            duration: 600,\n            easing: 'swing'\n        }\n    );\n}\n","structuredPatch":[{"oldStart":1277,"oldLines":8,"newStart":1277,"newLines":46,"lines":[" function cerrarModalCompetenciasMejorar() {","     $('#modal-competencias-mejorar').modal('hide');","     if (window.etapa_vacante_usuario_pendiente) {","-        ejecutarMovimientoEtapa(window.etapa_vacante_usuario_pendiente);","+        var etapa_vacante_usuario_id = window.etapa_vacante_usuario_pendiente;","         window.etapa_vacante_usuario_pendiente = null;","+","+        Swal.fire({","+            width: '533px',","+            showCloseButton: true,","+            closeButtonHtml: '<i class=\"bi bi-x text-headline-4 text-gray-20\"></i>',","+            showConfirmButton: false,","+            showDenyButton: false,","+            showCancelButton: false,","+            html: `","+                <div class=\"row w-100 mx-0 mt-2\">","+                    <div class=\"col-12 fw-semibold text-start text-gray-10 text-headline-4\">Confirmar contratación</div>","+                    <div class=\"col-12 mt-5 text-start text-body-2 fw-normal\">","+                        Estás a punto de pasar a Contratados al canditato seleccionado y finalizar esta vacante.","+                    </div>","+                    <div class=\"col-12 mt-5 text-start text-body-2 fw-semibold\">","+                        ¿Deseas continuar?","+                    </div>","+                    <div class=\"col-6 mt-5 mb-2\">","+                        ${crearBoton({","+                            clases: 'btn-outline-primary w-100 justify-content-center',","+                            texto: 'Volver',","+                            onclick: `Swal.clickDeny();`","+                        })}","+                    </div>","+                    <div class=\"col-6 mt-5 mb-2\">","+                        ${crearBoton({","+                            clases: 'btn-primary w-100 justify-content-center',","+                            texto: 'Continuar con la contratación',","+                            onclick: `Swal.clickConfirm();`","+                        })}","+                    </div>","+                </div>","+            `,","+        }).then(async (resultado) => {","+            if (resultado.isConfirmed) {","+                ejecutarMovimientoEtapa(etapa_vacante_usuario_id);","+            }","+        });","     }"," }"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"41797d2a-2abe-4b1f-8c80-5841c94624e4"}
{"parentUuid":"7f3a21f2-1179-4d0e-8d31-9d540de40be0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"ec0ebf98-c225-47af-a457-b973db026494","version":"2.1.39","gitBranch":"main","slug":"cryptic-percolating-kazoo","message":{"model":"claude-opus-4-6","id":"msg_01K2RRPgu4VzsK8aU3iSK6Fh","type":"message","role":"assistant","content":[{"type":"text","text":"Done. The `cerrarModalCompetenciasMejorar()` function now shows the SweetAlert de \"Confirmar contratación\" before executing the stage movement, matching the same confirmation flow that already exists for candidates without pruebas 7/12 (lines 577-613).\n\n**Flow after the fix:**\n1. Modal \"Competencias por mejorar\" appears\n2. User clicks \"Continuar\" → modal closes → SweetAlert \"Confirmar contratación\" appears\n3. \"Continuar con la contratación\" → executes `ejecutarMovimientoEtapa()`\n4. \"Volver\" → cancels, candidate stays in current stage"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":906,"cache_read_input_tokens":27917,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":906},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY2XKE2APEuwGjTtJp3yX","type":"assistant","uuid":"fb3c81fa-566e-4c63-b713-8a8cbd1c42eb","timestamp":"2026-02-11T15:32:23.675Z"}
