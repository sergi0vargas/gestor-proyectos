{"type":"file-history-snapshot","messageId":"57783518-b909-4957-8668-d69d9e941a86","snapshot":{"messageId":"57783518-b909-4957-8668-d69d9e941a86","trackedFileBackups":{},"timestamp":"2026-01-25T01:55:13.586Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":"tengo problemas para visualizar mis planes de creditos cuando vienen separados de los planes normales en el superadmin (por ejemplo en empresas-gestionar/id solo sale 1 plan de seleccion pero no de creditos) y en el menu de empresa (/planes-clientes) si salen todos (3 de creditos y 1 de seleccion)  @app/Models/Empresas/EmpresaPlan.php  @app/Models/Planes/Plan.php "},"uuid":"68b322db-c18c-4b2f-b710-df87bc5430ed","timestamp":"2026-01-25T01:45:28.863Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[],"permissionMode":"plan"}
{"parentUuid":"68b322db-c18c-4b2f-b710-df87bc5430ed","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01A72or2KSVbEVUnSqgcvop4","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario tiene un problema donde los planes de créditos no se muestran correctamente en la vista de superadmin (empresas-gestionar/id) pero sí se muestran en la vista de empresa (/planes-clientes). \n\nNecesito investigar:\n1. Cómo se cargan los planes en la vista de superadmin (empresas-gestionar)\n2. Cómo se cargan los planes en la vista de empresa (planes-clientes)\n3. Entender la diferencia entre planes normales y planes de créditos\n\nPor los modelos que ya leí:\n- `EmpresaPlan` tiene `plan_id` y `plan_credito_id`\n- Un plan solo de créditos tiene `plan_credito_id` pero `plan_id` es null (método `esSoloPlanCreditos()`)\n- Un plan híbrido tiene ambos (método `esPlanHibrido()`)\n\nEl problema probablemente está en cómo se consultan los planes. En la vista de superadmin probablemente hay una condición que filtra solo los planes con `plan_id` no nulo, excluyendo los planes solo de créditos.\n\nNecesito explorar:\n1. El controlador/servicio/repositorio de empresas-gestionar\n2. El controlador/servicio/repositorio de planes-clientes\n3. Las vistas Blade correspondientes\n\nVoy a usar agentes de exploración para investigar esto.","signature":"EpMKCkYICxgCKkAWtt9lCs8GA/s7seoqTCFy7avgUhrt8usc5khidm0n5kzhCt4jhs14zO3NBvk4YhcDNT5W0RIoLYjvDu/65CsDEgwnIey1vnhiGyxFLNwaDLTxEyZvAHLWfAe66yIws2JzZ11JQI5TI5t1zF11VVNpt6NhSOAL50w1N2PtlMTbaqA1QINgzJy0hVN53nImKvoIa6nJp2yvcjq7boZBJnk4fB04BnSs+07/nLJJw8GRThL1X5TyEmTjW+hoZjXfbhAMbPHr1Re2tNZTorDk4RCvqS0pojvR+9iqnPKF7fWgnAw3xeCr9e9R6BM/OqxC9JhyJS2UCYatV8j5f10CaySrTEdzT8rCpA5z1s+Ii9lU3cO0HNgMARas7becU8I0FbMXK3H69ELBICRkQfW/ntktgeV5ZqokfjkasYE1SJAPHmfYAsC+kYd6P1Bfrqg+MaY2cFzUTuTKd9yTNp/RtfcLdE2sd3krFQw/PqyJUzfeSiAyzX2Xg3V+f0vPoT8f/B9qbbrGyd4PAjdrIrkHaBQqADh556zuo6dfDUbeJUL7mPT/sSv6AlBftW8VPtpEGhurl9IoeWN6BMge/qj4bXDs3LyqPqAme9VxQwYmy8BKxLQKw4Kx/RQGR1TEgChCkP+U3jTN6J5ujBBzgVdwud102uni//yP0r7Ppw2LL8wwPCMMcLN6wy3Kdeqk6/rItcKCodwekcQI66RQff3XUURJvaqVvzcsLxjpKTGjCZOvlTwDbvSPdbW5MGVbXyYwzBETxk8x4kMKJ3mrtR3aIab2C+wvhnU3QXwZ2+cCAXGnYxPnTOz7c3iVKJ9AES1DrBxgKf65f69OKmNr6DKBJegudtE1SlaaNKpOJUT46gMSlHTEvImY9V2O7P187FGim8pMlKLoDpuSnzr5IOUADaVXeYXa7+enwRtQ0U4GPfJJymuO/kmR+PQjFPdezJKWwUawBMY7wqr/pvX6MUsS3Hpfz7Wp+MTstvGJAwW+Vp1gC7DvIU/pX4Ke5t1VauHY8pTxI/DpWJVY8s6fsTDEtJ3DZWVE/1909y0NsRWYohmfu/ydHRYzA2W6lojMMdCDYXGxRVKOtWv22rUD9qVlvr9SJCChd1z+vB2DXdkqFDi+JaINgzk7ytcDaAQSKjjt+5UhJVElA771nR9f1exbiAFmVl6wle+TFnikMEX9QWoks5QyTwf//ILIRH+c2XvM9vPP/NKj3OZ2o1xZXxa/Hk76bE/WRmCaheGKvjLKuG8ZVnZVhnVFWcnq6VsA0Qo2w55xbq/axB/7cD5ulcRKdo/HDn2nHHvKx7jTD/kjNoK/5K+0jaxeuON+UkYbjSy5O5f3paxY6PKnZdLUcyLmPXWVYgHccAfPHOg8O6XOsFAXK5OLRZKn/g4R60uAaSsTpc64suY9BqqgYBaEVlmF/qk74HYAF/mPC7+qZ9qVDTLbCpN7QXv2L6I4QYOoRAbJadsbOHpd9QNsdUfTwlAZ169l2vt1djSZAMebtZAVGI6rOb3wE02HQLsNpvXDHruZguoEd3NydUqcMi5VwshHULrT+GB3kZ6wPSXYC0l4Xf9VmCU+lWrmLPfqbU/BoVk4pAqV1Fpsty58Dh4NifE/KsR4vb5tAiGuKycZBk27hrj3PAaeCi+A3XlHsNbTl2v6tX1hz72EH8E8mkqwHqZU2rGl+3Ma3HmBUHZGgprlm3xpSjvQBXp7ayhQ7eoFGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":30110,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":30110,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTFWd6YjS2ZQQodTLptQ","type":"assistant","uuid":"3c969fd0-1ba7-4d6e-a016-e1f6ccda5ea5","timestamp":"2026-01-25T01:45:36.942Z"}
{"parentUuid":"3c969fd0-1ba7-4d6e-a016-e1f6ccda5ea5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01A72or2KSVbEVUnSqgcvop4","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo el problema. Los planes de créditos (que tienen `plan_credito_id` pero `plan_id` es null) no aparecen en la vista de superadmin pero sí en la vista de empresa. Necesito investigar cómo se cargan los planes en ambas vistas."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":30110,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":30110,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTFWd6YjS2ZQQodTLptQ","type":"assistant","uuid":"f94dc9bd-d188-44f1-8b4f-303d58535c6a","timestamp":"2026-01-25T01:45:37.952Z"}
{"parentUuid":"f94dc9bd-d188-44f1-8b4f-303d58535c6a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01A72or2KSVbEVUnSqgcvop4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01K1dppusw7BUt5avh2Tvgsn","name":"Task","input":{"description":"Explorar vista superadmin empresas-gestionar","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","subagent_type":"Explore"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":30110,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":30110,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTFWd6YjS2ZQQodTLptQ","type":"assistant","uuid":"136b07db-43f8-4b80-9787-86d315266392","timestamp":"2026-01-25T01:45:41.375Z"}
{"parentUuid":"136b07db-43f8-4b80-9787-86d315266392","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01A72or2KSVbEVUnSqgcvop4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0154KEMTsTHAt3gFABaEm7cU","name":"Task","input":{"description":"Explorar vista planes-clientes empresa","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","subagent_type":"Explore"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":30110,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":30110,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTFWd6YjS2ZQQodTLptQ","type":"assistant","uuid":"94edd578-1235-4014-bfe1-dd4870c24d6a","timestamp":"2026-01-25T01:45:43.980Z"}
{"parentUuid":"94edd578-1235-4014-bfe1-dd4870c24d6a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista."}]},"uuid":"398481a0-5c2e-4886-89be-8ace48ba4891","timestamp":"2026-01-25T01:45:44.151Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"ee16f803-4e65-4dd3-af27-c81da3eca228","timestamp":"2026-01-25T01:45:44.152Z"}
{"parentUuid":"ee16f803-4e65-4dd3-af27-c81da3eca228","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes."}]},"uuid":"aea91574-9db9-41cd-bb5d-16d8deb633bf","timestamp":"2026-01-25T01:45:44.171Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"c6c171d7-bd90-49b8-93ef-792fc405cd2a","timestamp":"2026-01-25T01:45:44.171Z"}
{"parentUuid":"c6c171d7-bd90-49b8-93ef-792fc405cd2a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:45:46.486Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_018KMc6SB1JdMEyih9cMTWEo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01L6RsE6r6isT7MvQCkG4eC7","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && find . -name \"web.php\" -type f | head -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15123,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15123,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFXkS79WDYKaaUV1ews","uuid":"860e257e-e5bd-4f9b-99cd-ce71f6ba379d"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"01a19e93-ae59-4e13-aff3-37bdcebf06c5","timestamp":"2026-01-25T01:45:46.527Z"}
{"parentUuid":"01a19e93-ae59-4e13-aff3-37bdcebf06c5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:45:46.498Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01HmRP2GZN5t3KwEmC2ki21T","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UU67HiTLRdJYyzszzaHhxt","name":"Bash","input":{"command":"find \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" -name \"web.php\" -type f | head -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15108,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":15108,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFXmGD6nvLtqSjCW3ae","uuid":"83515fc7-968b-4375-948b-af2b1169720d"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"c1448221-8f3e-41a2-8452-a652ac4fe69a","timestamp":"2026-01-25T01:45:46.550Z"}
{"parentUuid":"c1448221-8f3e-41a2-8452-a652ac4fe69a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UU67HiTLRdJYyzszzaHhxt","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2/routes/web.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/laravel/passport/routes/web.php","is_error":false}]},"uuid":"01fe8612-6755-4227-b025-c81a176f3e68","timestamp":"2026-01-25T01:45:51.786Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"e24beab3-9f47-46ed-8345-302e2dfac3e5","timestamp":"2026-01-25T01:45:51.843Z"}
{"parentUuid":"e24beab3-9f47-46ed-8345-302e2dfac3e5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01L6RsE6r6isT7MvQCkG4eC7","type":"tool_result","content":"./routes/web.php\n./vendor/laravel/passport/routes/web.php","is_error":false}]},"uuid":"bea29939-e227-41c8-bb74-786f5f53e614","timestamp":"2026-01-25T01:45:51.805Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"b165fbd9-ac67-45af-b437-333d63ea20bf","timestamp":"2026-01-25T01:45:51.886Z"}
{"parentUuid":"b165fbd9-ac67-45af-b437-333d63ea20bf","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:45:53.817Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01HPeThhVKeno7yxmedYWvPP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013pUbWyoqiDFZuhNFRVeTCh","name":"Grep","input":{"pattern":"empresas-gestionar","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":436,"cache_read_input_tokens":15123,"cache_creation":{"ephemeral_5m_input_tokens":436,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFYK9rQ1VFsLCPF9k5G","uuid":"e5fc6673-9eb1-4a28-9249-760a8faa2dbf"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"09261c40-9226-403a-b505-cec20b535076","timestamp":"2026-01-25T01:45:53.889Z"}
{"parentUuid":"09261c40-9226-403a-b505-cec20b535076","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:45:57.639Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01KyjPakBfE4JzGA6K2Xq1Ub","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GBchWp3tHFNpnFBUsuoLvC","name":"Grep","input":{"pattern":"planes-clientes|planes/clientes","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":479,"cache_read_input_tokens":15108,"cache_creation":{"ephemeral_5m_input_tokens":479,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFYJrVb518RauTrsbj4","uuid":"8618a574-fb69-4401-8a69-75b0c5d2444d"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"aa8448e9-c71b-47a0-8ce7-3bfc9a5ec811","timestamp":"2026-01-25T01:45:57.688Z"}
{"parentUuid":"aa8448e9-c71b-47a0-8ce7-3bfc9a5ec811","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013pUbWyoqiDFZuhNFRVeTCh","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:203:            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:204:            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:205:            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');"}]},"uuid":"0dc6571b-a68e-4ff3-964c-f7632265d4cc","timestamp":"2026-01-25T01:45:58.704Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"2b8315c7-3a54-4160-bd6b-e653ce1b5e64","timestamp":"2026-01-25T01:45:58.820Z"}
{"parentUuid":"2b8315c7-3a54-4160-bd6b-e653ce1b5e64","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GBchWp3tHFNpnFBUsuoLvC","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:216:                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');"}]},"uuid":"7c62ab51-bc1d-4941-b276-d3f54d4c459d","timestamp":"2026-01-25T01:45:59.328Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"e41ecbbc-3ee5-4249-b5ec-82d013613f1a","timestamp":"2026-01-25T01:45:59.377Z"}
{"parentUuid":"e41ecbbc-3ee5-4249-b5ec-82d013613f1a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:00.252Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01J72fNj3ddmdoWRY52Uzbke","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011ix9SBjj2QoJ5zCvAj5V7G","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":380,"cache_read_input_tokens":15559,"cache_creation":{"ephemeral_5m_input_tokens":380,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFYpgNNUm3cyH7ZBknm","uuid":"09b41af2-02f4-4713-90c8-1b64621a37ea"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"331e3197-52db-4763-9476-06e5a51be4c8","timestamp":"2026-01-25T01:46:00.291Z"}
{"parentUuid":"331e3197-52db-4763-9476-06e5a51be4c8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:01.339Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_014Yp51eRZ2kfB7jyWdLwBJk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013DXyQxtWoePxwMprtxsgfJ","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":239,"cache_read_input_tokens":15587,"cache_creation":{"ephemeral_5m_input_tokens":239,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFYs3kEoxjspqkh83oA","uuid":"029b8103-e160-45d8-9f0a-0553175338fb"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"e7d9f205-4e07-47c2-bf18-f8995eab8e54","timestamp":"2026-01-25T01:46:01.374Z"}
{"parentUuid":"e7d9f205-4e07-47c2-bf18-f8995eab8e54","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011ix9SBjj2QoJ5zCvAj5V7G","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Empresas;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use App\\Exports\\GlobalExport;\n     9→use App\\Models\\Empresas\\Empresa;\n    10→use App\\Http\\Controllers\\Controller;\n    11→use Maatwebsite\\Excel\\Facades\\Excel;\n    12→use App\\Http\\Services\\Usuarios\\UserService;\n    13→use Illuminate\\Http\\{JsonResponse, Request};\n    14→use App\\Http\\Services\\Empresas\\EmpresaService;\n    15→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    16→use Illuminate\\Support\\Facades\\{Auth, DB, Route};\n    17→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    18→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    19→use App\\Http\\Services\\Configuraciones\\ArchivoService;\n    20→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    21→use Symfony\\Component\\HttpFoundation\\{BinaryFileResponse, Response};\n    22→use App\\Http\\Repositories\\Usuarios\\{TipoDocumentoRepository, UserRepository};\n    23→use App\\Http\\Repositories\\Configuraciones\\{ArchivoRepository, PaisRepository, RutaRepository};\n    24→use App\\Http\\Requests\\Empresas\\{CambiarLogoRequest, CargarArchivosRequest, CrearContactosRequest, CrearEmpresaRequest};\n    25→use App\\Http\\Repositories\\Empresas\\{EmpresaRepository,\n    26→    EmpresaUsuarioRepository,\n    27→    SectorRepository,\n    28→    TamanoEmpresaRepository\n    29→};\n    30→\n    31→class EmpresaController extends Controller\n    32→{\n    33→    use SesionTrait;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaService $servicio Servicio de empresas.\n    39→     * @param EmpresaRepository $repositorio Repositorio de empresas.\n    40→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    41→     * @param SectorRepository $sector_repositorio Repositorio de sectores.\n    42→     * @param TamanoEmpresaRepository $tamano_empresa_repositorio Repositorio de tamaños de empresas.\n    43→     * @param PaisRepository $pais_repositorio Repositorio de países.\n    44→     * @param TipoDocumentoRepository $tipo_documento_repositorio Repositorio de tipos de documentos.\n    45→     * @param UserService $usuario_servicio Servicio de usuarios.\n    46→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n    47→     * @param ArchivoService $archivo_servicio Servicio de archivos.\n    48→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    49→     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de empresas-usuarios.\n    50→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    51→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    52→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    53→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    54→     * @return void\n    55→     * @author Daniel Beltrán\n    56→     * @author Fahibram Cárcamo\n    57→     */\n    58→    public function __construct(\n    59→        private EmpresaService $servicio,\n    60→        private EmpresaRepository $repositorio,\n    61→        private UserRepository $usuario_repositorio,\n    62→        private SectorRepository $sector_repositorio,\n    63→        private TamanoEmpresaRepository $tamano_empresa_repositorio,\n    64→        private PaisRepository $pais_repositorio,\n    65→        private TipoDocumentoRepository $tipo_documento_repositorio,\n    66→        private UserService $usuario_servicio,\n    67→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    68→        private ArchivoService $archivo_servicio,\n    69→        private RutaRepository $ruta_repositorio,\n    70→        private EmpresaUsuarioRepository $empresa_usuario_repositorio,\n    71→        private RolRepository $rol_repositorio,\n    72→        private PruebaRepository $prueba_repositorio,\n    73→        private PerfilRepository $perfil_repositorio,\n    74→        private ArchivoRepository $archivo_repositorio\n    75→    ) {\n    76→        $this->middleware('auth.rol-tipo-superadmin')->only(['index', 'gestionar']);\n    77→\n    78→        $this->middleware(function ($request, $next) {\n    79→            if (in_array($request->route()->getAction(), ['edit', 'update', 'archivar', 'cambiarLogo', 'eliminarLogo', 'guardarArchivos', 'paginaEmpresaCambiarImagen'])) {\n    80→                abort_unless(Auth::user()->can('empresas.listado-empresas.editar'), 403, 'No está autorizado para realizar esta acción.');\n    81→            }\n    82→\n    83→            if (in_array($request->route()->getAction(), ['store', 'create'])) {\n    84→                abort_unless(Auth::user()->can('empresas.listado-empresas.crear'), 403, 'No está autorizado para realizar esta acción.');\n    85→            }\n    86→\n    87→            if (in_array($request->route()->getAction(), ['destroy'])) {\n    88→                abort_unless(Auth::user()->can('empresas.listado-empresas.eliminar'), 403, 'No está autorizado para realizar esta acción.');\n    89→            }\n    90→\n    91→            if (in_array($request->route()->getAction(), ['guardarContactos'])) {\n    92→                abort_unless(Auth::user()->can('empresas.gestionar-empresas.usuarios.crear'), 403, 'No está autorizado para realizar esta acción.');\n    93→            }\n    94→\n    95→            return $next($request);\n    96→        });\n    97→    }\n    98→\n    99→    /**\n   100→     * Listado de empresas.\n   101→     *\n   102→     * @param Request $request Contenido de la petición.\n   103→     * @return JsonResponse\n   104→     * @author Daniel Beltrán\n   105→     */\n   106→    public function listado(Request $request): JsonResponse {\n   107→        return new JsonResponse([\n   108→            'data' => $this->repositorio->getListado($request)\n   109→        ], 200);\n   110→    }\n   111→\n   112→    /**\n   113→     * Obtener los datos para la tabla.\n   114→     *\n   115→     * @param Request $request Contenido de la petición.\n   116→     * @return JsonResponse\n   117→     * @author Daniel Beltrán\n   118→     */\n   119→    public function getDatatable(Request $request): JsonResponse {\n   120→        return new JsonResponse(\n   121→            $this->servicio->getTodo($request)\n   122→        );\n   123→    }\n   124→\n   125→    /**\n   126→     * Cargar la página principal.\n   127→     *\n   128→     * @return View\n   129→     * @author Daniel Beltrán\n   130→     */\n   131→    public function index(): View {\n   132→        return view('empresas.index')->with([\n   133→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   134→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   135→            'ejecutivos'    => $this->usuario_repositorio->getEjecutivos(),\n   136→            'paises'        => $this->pais_repositorio->getListado(new Request()),\n   137→        ]);\n   138→    }\n   139→\n   140→    /**\n   141→     * Cargar la página para crear.\n   142→     *\n   143→     * @param Request $request Contenido de la petición.\n   144→     * @return View\n   145→     * @author Daniel Beltrán\n   146→     * @author Fahibram Cárcamo\n   147→     */\n   148→    public function create(Request $request): View {\n   149→        $es_sucursal = Route::current()->getName() === 'crear.sucursal';\n   150→        $rol_activo  = $this->rol_repositorio->usuarioRolActivo();\n   151→\n   152→        $datos_adjuntos = [\n   153→            'es_sucursal'             => $es_sucursal,\n   154→            'tipo_rol_activo_usuario' => $rol_activo->type,\n   155→            'titulo_pagina'           => $es_sucursal ? 'Crear sucursal' : 'Crear empresa',\n   156→            'sectores'                => $this->sector_repositorio->getTodo(new Request()),\n   157→            'tamanos_empresas'        => $this->tamano_empresa_repositorio->getTodo(new Request()),\n   158→            'paises'                  => $this->pais_repositorio->getListado(new Request()),\n   159→            'ejecutivos'              => $this->usuario_repositorio->getEjecutivos(),\n   160→            'tipos_documentos'        => $this->tipo_documento_repositorio->getListado(new Request()),\n   161→            'rutas_menu'              => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   162→            'opcion'                  => 'Crear'\n   163→        ];\n   164→\n   165→        if ($es_sucursal) {\n   166→            if ($rol_activo->type === 'superadmin') {\n   167→                // La sucursal fué creada por un usuario con rol de tipo superadmin.\n   168→                $datos_adjuntos['empresas_principales'] = $this->repositorio->getTodo(new Request(['solo_principales' => true]));\n   169→            } else {\n   170→                // La sucursal fué creada por un usuario asociado a la empresa cliente.\n   171→                $datos_adjuntos['empresa_padre'] = $this->repositorio->getUno($request->empresa_id);\n   172→            }\n   173→        }\n   174→\n   175→        return view('empresas.paginas.crear')->with($datos_adjuntos);\n   176→    }\n   177→\n   178→    /**\n   179→     * Cargar la página para editar.\n   180→     *\n   181→     * @param int $id ID de la empresa.\n   182→     * @return View\n   183→     * @author Daniel Beltrán\n   184→     * @author Fahibram Cárcamo\n   185→     */\n   186→    public function edit(int $id): View {\n   187→        $empresa     = $this->repositorio->getUno($id);\n   188→        $es_sucursal = !is_null($empresa->empresa_id);\n   189→        $rol_activo  = $this->rol_repositorio->usuarioRolActivo(Auth::user());\n   190→\n   191→        $datos_adjuntos = [\n   192→            'empresa'                 => $empresa,\n   193→            'es_sucursal'             => $es_sucursal,\n   194→            'tipo_rol_activo_usuario' => $rol_activo->type,\n   195→            'tipo_rol_usuario'        => $rol_activo->type,\n   196→            'titulo_pagina'           => $es_sucursal ? 'Editar sucursal' : 'Editar empresa',\n   197→            'sectores'                => $this->sector_repositorio->getTodo(new Request()),\n   198→            'tamanos_empresas'        => $this->tamano_empresa_repositorio->getTodo(new Request()),\n   199→            'paises'                  => $this->pais_repositorio->getListado(new Request()),\n   200→            'ejecutivos'              => $this->usuario_repositorio->getEjecutivos(),\n   201→            'tipos_documentos'        => $this->tipo_documento_repositorio->getListado(new Request()),\n   202→            'rutas_menu'              => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   203→            'opcion'                  => 'Editar'\n   204→        ];\n   205→\n   206→        if ($es_sucursal) {\n   207→            if ($rol_activo->type === 'superadmin') {\n   208→                $datos_adjuntos['empresas_principales'] = $this->repositorio->getTodo(new Request(['solo_principales' => true]));\n   209→            } else {\n   210→                $datos_adjuntos['empresa_padre'] = $this->repositorio->getUno($empresa->empresa_id);\n   211→            }\n   212→        }\n   213→\n   214→        return view('empresas.paginas.crear')->with($datos_adjuntos);\n   215→    }\n   216→\n   217→    /**\n   218→     * Obtener empresa.\n   219→     *\n   220→     * @param int $id ID de la empresa.\n   221→     * @return JsonResponse\n   222→     * @author Daniel Beltrán\n   223→     */\n   224→    public function show(int $id): JsonResponse {\n   225→        return new JsonResponse([\n   226→            'data' => $this->repositorio->getUno($id)\n   227→        ], 200);\n   228→    }\n   229→\n   230→    /**\n   231→     * Cargar la página con la lista de sucursales de la empresa.\n   232→     *\n   233→     * @return View\n   234→     * @author Fahibram Cárcamo\n   235→     */\n   236→    public function sucursales(): View {\n   237→        return view('empresa.paginas.sucursales.sucursales')->with([\n   238→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   239→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   240→            'ejecutivos'    => $this->usuario_repositorio->getEjecutivos(),\n   241→            'paises'        => $this->pais_repositorio->getListado(new Request()),\n   242→            'empresa'       => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(Auth::id())\n   243→        ]);\n   244→    }\n   245→\n   246→    /**\n   247→     * Retornar los datos de la empresa actual y el listado de sus sucursales.\n   248→     *\n   249→     * @param Request $request Solicitud HTTP.\n   250→     * @return JsonResponse\n   251→     * @author Fahibram Cárcamo\n   252→     */\n   253→    public function listadoSucursales(Request $request): JsonResponse {\n   254→        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(Auth::id());\n   255→        $request->merge(['con_relaciones' => true, 'con_usuarios' => true]);\n   256→        return datatables()->of($this->repositorio->obtenerSucursales($empresa->id, $request))->toJson();\n   257→    }\n   258→\n   259→    /**\n   260→     * Retornar los datos de la empresa actual y el listado de sus usuarios agrupados por sucursal.\n   261→     *\n   262→     * @param Request $request Solicitud HTTP.\n   263→     * @return JsonResponse\n   264→     * @author Fahibram Cárcamo\n   265→     */\n   266→    public function listadoSucursalesUsuarios(Request $request): JsonResponse {\n   267→        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(Auth::id());\n   268→        return new JsonResponse([\n   269→            'sucursales' => $this->repositorio->obtenerSucursalesUsuarios($empresa->id, $request),\n   270→            'empresa'    => $empresa\n   271→        ], 200);\n   272→    }\n   273→\n   274→    /**\n   275→     * Retornar la página para la gestión de una sucursal.\n   276→     *\n   277→     * @param int $id Id de la sucursal a gestionar.\n   278→     * @return View\n   279→     * @author Fahibram Cárcamo\n   280→     */\n   281→    public function gestionarSucursal(int $id): View {\n   282→        return view('empresa.paginas.sucursales.gestionar')->with([\n   283→            'sucursal'         => $this->repositorio->getUno($id),\n   284→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   285→            'tipos_pruebas'    => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   286→            'tamanos_empresas' => $this->tamano_empresa_repositorio->getTodo(new Request()),\n   287→            'sectores'         => $this->sector_repositorio->getTodo(new Request()),\n   288→            'paises'           => $this->pais_repositorio->getListado(new Request()),\n   289→            'ejecutivos'       => $this->usuario_repositorio->getEjecutivos(),\n   290→            'tipos_documentos' => $this->tipo_documento_repositorio->getListado(new Request())\n   291→        ]);\n   292→    }\n   293→\n   294→    /**\n   295→     * Cargar la página para gestionar.\n   296→     *\n   297→     * @param ?int $id ID de la empresa.\n   298→     * @param ?string $submenu_vista Vista del submenú en específico.\n   299→     * @return View\n   300→     * @author Daniel Beltrán\n   301→     * @author Andres Gonzalez\n   302→     * @author Fahibram Cárcamo\n   303→     */\n   304→    public function gestionar(?int $id = null, ?string $submenu_vista = null): View {\n   305→        return view('empresas.paginas.gestionar')->with([\n   306→            'perfiles'         => $this->perfil_repositorio->getTodo(new Request([])),\n   307→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request(['activo' => 1])),\n   308→            'empresa'          => !is_null($id) ? $this->repositorio->getUno($id) : null,\n   309→            'tipos_pruebas'    => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   310→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   311→            'sectores'         => $this->sector_repositorio->getTodo(new Request()),\n   312→            'tamanos_empresas' => $this->tamano_empresa_repositorio->getTodo(new Request()),\n   313→            'paises'           => $this->pais_repositorio->getListado(new Request()),\n   314→            'ejecutivos'       => $this->usuario_repositorio->getEjecutivos(),\n   315→            'tipos_documentos' => $this->tipo_documento_repositorio->getListado(new Request()),\n   316→            'submenu_vista'    => $submenu_vista\n   317→        ]);\n   318→    }\n   319→\n   320→    /**\n   321→     * Crear empresa.\n   322→     *\n   323→     * @param CrearEmpresaRequest $request Contenido de la petición.\n   324→     * @return JsonResponse\n   325→     * @author Daniel Beltrán\n   326→     */\n   327→    public function store(CrearEmpresaRequest $request): JsonResponse {\n   328→        $codigo    = 201;\n   329→        $respuesta = [\n   330→            'message' => 'Empresa creada correctamente'\n   331→        ];\n   332→\n   333→        try {\n   334→            DB::beginTransaction();\n   335→            $respuesta['data'] = $this->servicio->guardar($request);\n   336→            DB::commit();\n   337→        } catch (Exception $error) {\n   338→            DB::rollBack();\n   339→\n   340→            $codigo    = 400;\n   341→            $respuesta = [\n   342→                'message' => 'Ocurrió un error',\n   343→                'errors'  => $error->getMessage()\n   344→            ];\n   345→        }\n   346→\n   347→        return new JsonResponse($respuesta, $codigo);\n   348→    }\n   349→\n   350→    /**\n   351→     * Actualizar empresa.\n   352→     *\n   353→     * @param int $id ID de la empresa.\n   354→     * @param CrearEmpresaRequest $request Contenido de la petición.\n   355→     * @return JsonResponse\n   356→     * @author Daniel Beltrán\n   357→     */\n   358→    public function update(int $id, CrearEmpresaRequest $request): JsonResponse {\n   359→        $codigo    = 200;\n   360→        $respuesta = [\n   361→            'message' => 'Empresa actualizada correctamente'\n   362→        ];\n   363→\n   364→        try {\n   365→            DB::beginTransaction();\n   366→            $request->merge(['id' => $id]);\n   367→            $respuesta['data'] = $this->servicio->guardar($request);\n   368→            DB::commit();\n   369→        } catch (Exception $error) {\n   370→            DB::rollBack();\n   371→\n   372→            $codigo    = 400;\n   373→            $respuesta = [\n   374→                'message' => 'Ocurrió un error',\n   375→                'errors'  => $error->getMessage()\n   376→            ];\n   377→        }\n   378→\n   379→        return new JsonResponse($respuesta, $codigo);\n   380→    }\n   381→\n   382→    /**\n   383→     * Eliminar empresa.\n   384→     *\n   385→     * @param int $id ID de la empresa.\n   386→     * @return JsonResponse\n   387→     * @author Daniel Beltrán\n   388→     */\n   389→    public function destroy(int $id): JsonResponse {\n   390→        $codigo    = 200;\n   391→        $respuesta = [\n   392→            'tipo'    => 'success',\n   393→            'mensaje' => 'Empresa eliminada correctamente'\n   394→        ];\n   395→\n   396→        try {\n   397→            DB::beginTransaction();\n   398→            $this->servicio->eliminar($id);\n   399→            DB::commit();\n   400→        } catch (Exception $error) {\n   401→            DB::rollBack();\n   402→\n   403→            $codigo    = 400;\n   404→            $respuesta = [\n   405→                'message' => 'Ocurrió un error',\n   406→                'errors'  => $error->getMessage()\n   407→            ];\n   408→        }\n   409→\n   410→        return new JsonResponse($respuesta, $codigo);\n   411→    }\n   412→\n   413→    /**\n   414→     * Guardar archivos.\n   415→     *\n   416→     * @param int $id ID de la empresa.\n   417→     * @param CargarArchivosRequest $request Contenido de la petición.\n   418→     * @return JsonResponse\n   419→     * @author Daniel Beltrán\n   420→     */\n   421→    public function guardarArchivos(int $id, CargarArchivosRequest $request): JsonResponse {\n   422→        $codigo    = 201;\n   423→        $respuesta = [\n   424→            'tipo'    => 'success',\n   425→            'mensaje' => 'Archivos actualizados correctamente'\n   426→        ];\n   427→\n   428→        try {\n   429→            DB::beginTransaction();\n   430→\n   431→            $this->servicio->guardarArchivos($id, $request);\n   432→\n   433→            $archivos_empresa = $this->archivo_repositorio->getTodo(new Request([\n   434→                'modelo'    => Empresa::class,\n   435→                'modelo_id' => $id\n   436→            ]));\n   437→\n   438→            $respuesta['data'] = $archivos_empresa;\n   439→\n   440→            DB::commit();\n   441→        } catch (Exception $error) {\n   442→            DB::rollBack();\n   443→\n   444→            $codigo    = 400;\n   445→            $respuesta = [\n   446→                'message' => 'Ocurrió un error',\n   447→                'errors'  => $error->getMessage()\n   448→            ];\n   449→        }\n   450→\n   451→        return new JsonResponse($respuesta, $codigo);\n   452→    }\n   453→\n   454→    /**\n   455→     * Guardar contactos.\n   456→     *\n   457→     * @param int $id ID de la empresa.\n   458→     * @param CrearContactosRequest $request Contenido de la petición.\n   459→     * @return JsonResponse\n   460→     * @author Daniel Beltrán\n   461→     */\n   462→    public function guardarContactos(int $id, CrearContactosRequest $request): JsonResponse {\n   463→        $codigo    = 200;\n   464→        $respuesta = [\n   465→            'tipo'    => 'success',\n   466→            'mensaje' => 'Contactos actualizados correctamente'\n   467→        ];\n   468→\n   469→        try {\n   470→            DB::beginTransaction();\n   471→\n   472→            $request->merge(['id' => $id]);\n   473→            $this->servicio->guardar(new Request($request->only([\n   474→                'id',\n   475→                'nombre_tesorero',\n   476→                'email_tesorero',\n   477→                'celular_tesorero',\n   478→                'indicativo_celular_tesorero',\n   479→                'codigo_iso2_pais_celular_tesorero',\n   480→                'telefono_tesorero',\n   481→                'extension_tesorero',\n   482→                'nombre_contacto',\n   483→                'email_contacto',\n   484→                'celular_contacto',\n   485→                'indicativo_celular_contacto',\n   486→                'codigo_iso2_pais_celular_contacto'\n   487→            ])));\n   488→\n   489→            // Si se recibe el usuario se guarda\n   490→            if ($request->filled('usuario')) {\n   491→                $request_usuario = new Request($request->usuario);\n   492→                $request_usuario->merge(['empresa_id' => $id]);\n   493→                $this->usuario_servicio->guardarUsuarioPrincipalEmpresa($request_usuario);\n   494→            }\n   495→\n   496→            DB::commit();\n   497→        } catch (Exception $error) {\n   498→            DB::rollBack();\n   499→\n   500→            $codigo    = 400;\n   501→            $respuesta = [\n   502→                'message' => 'Ocurrió un error',\n   503→                'errors'  => $error->getMessage()\n   504→            ];\n   505→        }\n   506→\n   507→        return new JsonResponse($respuesta, $codigo);\n   508→    }\n   509→\n   510→    /**\n   511→     * Archivar o desarchivar empresa.\n   512→     *\n   513→     * @param int $id ID de la empresa.\n   514→     * @param Request $request Contenido de la petición.\n   515→     * @return JsonResponse\n   516→     * @author Daniel Beltrán\n   517→     */\n   518→    public function archivar(int $id, Request $request): JsonResponse {\n   519→        $codigo    = 200;\n   520→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   521→        $accion    = $activo ? 'desarchivada' : 'archivada';\n   522→        $respuesta = [\n   523→            'tipo'    => 'success',\n   524→            'mensaje' => \"Empresa {$accion} correctamente\"\n   525→        ];\n   526→\n   527→        $request->merge([\n   528→            'id'         => $id,\n   529→            'activo'     => $activo,\n   530→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   531→        ]);\n   532→\n   533→        try {\n   534→            DB::beginTransaction();\n   535→            $this->servicio->guardar($request);\n   536→            DB::commit();\n   537→        } catch (Exception $error) {\n   538→            DB::rollBack();\n   539→\n   540→            $codigo    = 400;\n   541→            $respuesta = [\n   542→                'message' => 'Ocurrió un error',\n   543→                'errors'  => $error->getMessage()\n   544→            ];\n   545→        }\n   546→\n   547→        return new JsonResponse($respuesta, $codigo);\n   548→    }\n   549→\n   550→    /**\n   551→     * Obtener el historial de cambios.\n   552→     *\n   553→     * @param int $id ID de la empresa.\n   554→     * @return JsonResponse\n   555→     * @author Daniel Beltrán\n   556→     */\n   557→    public function historialCambios(int $id): JsonResponse {\n   558→        return new JsonResponse([\n   559→            'data' => $this->servicio->historialCambios($id)\n   560→        ], 200);\n   561→    }\n   562→\n   563→    /**\n   564→     * Obtener logo.\n   565→     *\n   566→     * @param int $id ID de la empresa.\n   567→     * @return BinaryFileResponse|Response\n   568→     * @author Daniel Beltrán\n   569→     */\n   570→    public function getLogo(int $id): BinaryFileResponse|Response {\n   571→        return $this->servicio->getLogo($id);\n   572→    }\n   573→\n   574→    /**\n   575→     * Cambiar logo.\n   576→     *\n   577→     * @param CambiarLogoRequest $request Contenido de la petición.\n   578→     * @return JsonResponse\n   579→     * @author Daniel Beltrán\n   580→     */\n   581→    public function cambiarLogo(CambiarLogoRequest $request): JsonResponse {\n   582→        $codigo    = 200;\n   583→        $respuesta = [\n   584→            'tipo'    => 'success',\n   585→            'mensaje' => 'Logo actualizado correctamente'\n   586→        ];\n   587→\n   588→        try {\n   589→            DB::beginTransaction();\n   590→            $this->servicio->cambiarLogo($request->id, $request->logo);\n   591→            DB::commit();\n   592→        } catch (Exception $error) {\n   593→            DB::rollBack();\n   594→\n   595→            $codigo    = 400;\n   596→            $respuesta = [\n   597→                'message' => 'Ocurrió un error',\n   598→                'errors'  => $error->getMessage()\n   599→            ];\n   600→        }\n   601→\n   602→        return new JsonResponse($respuesta, $codigo);\n   603→    }\n   604→\n   605→    /**\n   606→     * Eliminar el logo de la empresa.\n   607→     *\n   608→     * @param int $id ID de la empresa.\n   609→     * @return JsonResponse\n   610→     * @author Daniel Beltrán\n   611→     */\n   612→    public function eliminarLogo(int $id): JsonResponse {\n   613→        $codigo    = 200;\n   614→        $respuesta = [\n   615→            'tipo'    => 'success',\n   616→            'mensaje' => 'Logo eliminado correctamente'\n   617→        ];\n   618→\n   619→        try {\n   620→            DB::beginTransaction();\n   621→            $this->archivo_servicio->eliminarPorModelo('App\\Models\\Empresas\\Empresa', $id, 'logo');\n   622→            DB::commit();\n   623→        } catch (Exception $error) {\n   624→            DB::rollBack();\n   625→\n   626→            $codigo    = 400;\n   627→            $respuesta = [\n   628→                'message' => 'Ocurrió un error',\n   629→                'errors'  => $error->getMessage()\n   630→            ];\n   631→        }\n   632→\n   633→        return new JsonResponse($respuesta, $codigo);\n   634→    }\n   635→\n   636→    /**\n   637→     * Obtener el detalle de la última vez que se archivó la empresa.\n   638→     *\n   639→     * @param int $id ID de la empresa.\n   640→     * @return JsonResponse\n   641→     * @author Daniel Beltrán\n   642→     */\n   643→    public function detalleArchivado(int $id): JsonResponse {\n   644→        return new JsonResponse([\n   645→            'data' => $this->repositorio->ultimoArchivado($id)\n   646→        ], 200);\n   647→    }\n   648→\n   649→    /**\n   650→     * Exportar Excel.\n   651→     *\n   652→     * @param Request $request Contenido de la petición.\n   653→     * @return BinaryFileResponse\n   654→     * @author Daniel Beltrán\n   655→     */\n   656→    public function exportarExcel(Request $request): BinaryFileResponse {\n   657→        return Excel::download(new GlobalExport([\n   658→            'Sucursales',\n   659→            'ID',\n   660→            'Nombre comercial',\n   661→            'Razón social',\n   662→            'Sucursal de',\n   663→            'NIT',\n   664→            'Ejecutivo',\n   665→            'Plan de selección',\n   666→            'Plan organizacional',\n   667→            'Plan vocacional',\n   668→            'Ubicación',\n   669→            'Número de celular',\n   670→            'Correo de facturación electrónica',\n   671→            'Fecha de creación',\n   672→            'Progreso de creación',\n   673→            'Tamaño de empresa',\n   674→            'Sector',\n   675→            'Dirección',\n   676→            'Nombre del representante legal',\n   677→            'Documento del representante legal',\n   678→            'Correo del representante legal'\n   679→        ], $this->servicio->getTodo($request), 'Empresas', 'excel.empresas.empresas'), 'empresas.xlsx');\n   680→    }\n   681→\n   682→    /**\n   683→     * Exportar Excel de sucursales.\n   684→     *\n   685→     * @param Request $request Contenido de la petición.\n   686→     * @return BinaryFileResponse\n   687→     * @author Daniel Beltrán\n   688→     */\n   689→    public function exportarExcelSucursales(Request $request): BinaryFileResponse {\n   690→        $request->merge(['solo_sucursales' => true]);\n   691→\n   692→        return Excel::download(new GlobalExport([\n   693→            'ID',\n   694→            'Nombre comercial',\n   695→            'NIT',\n   696→            'Ubicación',\n   697→            'Dirección',\n   698→            'Celular',\n   699→            'Sector',\n   700→            'Cantidad de empleados',\n   701→            'Fecha de creación'\n   702→        ], $this->repositorio->getTodo($request), 'Sucursales', 'excel.empresas.sucursales'), 'sucursales.xlsx');\n   703→    }\n   704→\n   705→    /**\n   706→     * Obtener datos para gestionar.\n   707→     *\n   708→     * @param int $id ID de la empresa.\n   709→     * @return JsonResponse\n   710→     * @author Daniel Beltrán\n   711→     */\n   712→    public function datosGestionar(int $id): JsonResponse {\n   713→        return new JsonResponse([\n   714→            'data' => $this->servicio->getUno($id)\n   715→        ], 200);\n   716→    }\n   717→\n   718→    /**\n   719→     * Exportar Excel del historial de cambios.\n   720→     *\n   721→     * @param int $id ID de la empresa.\n   722→     * @return BinaryFileResponse\n   723→     * @author Daniel Beltrán\n   724→     */\n   725→    public function exportarExcelHistorialCambios(int $id): BinaryFileResponse {\n   726→        return $this->servicio->exportarExcelHistorialCambios($id);\n   727→    }\n   728→\n   729→    /**\n   730→     * Obtener el propietario de la empresa.\n   731→     *\n   732→     * @param int $empresa_id ID de la empresa.\n   733→     * @return JsonResponse\n   734→     * @author Daniel Beltrán\n   735→     */\n   736→    public function obtenerPropietario(int $empresa_id): JsonResponse {\n   737→        return new JsonResponse([\n   738→            'data' => $this->usuario_repositorio->obtenerPropietarioEmpresa($empresa_id)\n   739→        ], 200);\n   740→    }\n   741→\n   742→    /**\n   743→     * Si la empresa dada es sucursal retornar la empresa padre y sus sucursales.\n   744→     *\n   745→     * @param Request $request Contenido de la petición.\n   746→     * @return JsonResponse\n   747→     * @author Fahibram Cárcamo\n   748→     */\n   749→    public function empresaSucursales(Request $request): JsonResponse {\n   750→        $empresa = $this->repositorio->getUno($request->empresa_id);\n   751→        return new JsonResponse([\n   752→            'empresa_padre' => $empresa->empresa_id ? $this->repositorio->obtenerEmpresaPadre($empresa) : $empresa\n   753→        ], 200);\n   754→    }\n   755→\n   756→    /**\n   757→     * Obtener los datos de la empresa actual para para su edición.\n   758→     *\n   759→     * @return JsonResponse\n   760→     * @author Fahibram Cárcamo\n   761→     */\n   762→    public function obtenerDatosEmpresa(): JsonResponse {\n   763→        $codigo    = 200;\n   764→        $respuesta = ['message' => 'Datos de empresa obtenidos correctamente'];\n   765→\n   766→        try {\n   767→            DB::beginTransaction();\n   768→            $respuesta['data'] = [\n   769→                'empresa'          => $this->repositorio->getUno($this->obtenerDeSesion('empresa_id')),\n   770→                'sectores'         => $this->sector_repositorio->getTodo(new Request()),\n   771→                'tamanos_empresas' => $this->tamano_empresa_repositorio->getTodo(new Request()),\n   772→                'paises'           => $this->pais_repositorio->getListado(new Request()),\n   773→                'ejecutivos'       => $this->usuario_repositorio->getEjecutivos(),\n   774→                'tipos_documentos' => $this->tipo_documento_repositorio->getListado(new Request())\n   775→            ];\n   776→            DB::commit();\n   777→        } catch (Exception $error) {\n   778→            DB::rollBack();\n   779→\n   780→            $codigo    = 400;\n   781→            $respuesta = [\n   782→                'message' => 'Ocurrió un error',\n   783→                'errors'  => $error->getMessage()\n   784→            ];\n   785→        }\n   786→\n   787→        return new JsonResponse($respuesta, $codigo);\n   788→    }\n   789→\n   790→    /**\n   791→     * Cargar la página para cambiar la imagen en mi empresa.\n   792→     *\n   793→     * @return View\n   794→     * @author Andres Morales\n   795→     */\n   796→    public function paginaEmpresaCambiarImagen(): View {\n   797→        return view('empresa.paginas.cambiar-logo-empresa')->with([\n   798→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   799→        ]);\n   800→    }\n   801→}\n   802→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"284027c3-d9bd-48b4-8e1f-c41595d79da4","timestamp":"2026-01-25T01:46:02.385Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"8f802552-6866-4749-a8b3-146e722d580f","timestamp":"2026-01-25T01:46:02.450Z"}
{"parentUuid":"8f802552-6866-4749-a8b3-146e722d580f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013DXyQxtWoePxwMprtxsgfJ","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    23→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    24→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    26→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    27→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    28→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    29→\n    30→class PlanController extends Controller\n    31→{\n    32→    use SesionTrait;\n    33→\n    34→    /**\n    35→     * Constructor.\n    36→     *\n    37→     * @param PlanService $servicio Servicio de planes.\n    38→     * @param PlanRepository $repositorio Repositorio de planes.\n    39→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    40→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    41→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    42→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    43→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    44→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    45→     * @param CargoService $cargo_servicio Servicio de cargos.\n    46→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    47→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    48→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    49→     * @return void\n    50→     * @author Daniel Beltrán\n    51→     * @author Fahibram Cárcamo\n    52→     * @author Jair Carvajal\n    53→     */\n    54→    public function __construct(\n    55→        private PlanService $servicio,\n    56→        private PlanRepository $repositorio,\n    57→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    58→        private RutaRepository $ruta_repositorio,\n    59→        private PerfilRepository $perfil_repositorio,\n    60→        private PruebaRepository $prueba_repositorio,\n    61→        private EmpresaRepository $empresa_repositorio,\n    62→        private RolRepository $rol_repositorio,\n    63→        private CargoService $cargo_servicio,\n    64→        private UserRepository $usuario_repositorio,\n    65→        private EmpresaPlanService $empresa_plan_servicio,\n    66→        private ServicioIARepository $servicio_ia_repositorio\n    67→    ) {}\n    68→\n    69→    /**\n    70→     * Obtener el listado de planes.\n    71→     *\n    72→     * @param Request $request Contenido de la petición.\n    73→     * @return JsonResponse\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function listado(Request $request): JsonResponse {\n    77→        return new JsonResponse([\n    78→            'data' => $this->repositorio->getTodo($request)\n    79→        ], 200);\n    80→    }\n    81→\n    82→    /**\n    83→     * Cargar la página principal.\n    84→     *\n    85→     * @return View\n    86→     * @author Daniel Beltrán\n    87→     */\n    88→    public function index(): View {\n    89→        return view('planes.index')->with([\n    90→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    91→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    92→        ]);\n    93→    }\n    94→\n    95→    /**\n    96→     * Cargar la página para crear.\n    97→     *\n    98→     * @return View\n    99→     * @author Sol Espitia\n   100→     */\n   101→    public function paginaConsumos(): View {\n   102→        return view('planes.paginas.consumos')->with([\n   103→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   104→        ]);\n   105→    }\n   106→\n   107→    /**\n   108→     * Cargar la página para crear.\n   109→     *\n   110→     * @return View\n   111→     * @author Daniel Beltrán\n   112→     */\n   113→    public function create(): View {\n   114→        return view('planes.paginas.crear')->with([\n   115→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   116→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   117→        ]);\n   118→    }\n   119→\n   120→    /**\n   121→     * Obtener un plan.\n   122→     *\n   123→     * @param int $id ID del plan.\n   124→     * @return JsonResponse\n   125→     * @author Daniel Beltrán\n   126→     */\n   127→    public function show(int $id): JsonResponse {\n   128→        return new JsonResponse([\n   129→            'data' => $this->repositorio->getUno($id)\n   130→        ], 200);\n   131→    }\n   132→\n   133→    /**\n   134→     * Cargar la página para editar.\n   135→     *\n   136→     * @param int $id ID del plan.\n   137→     * @return View\n   138→     * @author Daniel Beltrán\n   139→     */\n   140→    public function edit(int $id): View {\n   141→        return view('planes.paginas.crear')->with([\n   142→            'plan'          => $this->repositorio->getUno($id),\n   143→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   144→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   145→        ]);\n   146→    }\n   147→\n   148→    /**\n   149→     * Crear plan.\n   150→     *\n   151→     * @param CrearPlanRequest $request Contenido de la petición.\n   152→     * @return JsonResponse\n   153→     * @author Daniel Beltrán\n   154→     */\n   155→    public function store(CrearPlanRequest $request): JsonResponse {\n   156→        $codigo    = 201;\n   157→        $respuesta = [\n   158→            'message' => 'Plan creado correctamente'\n   159→        ];\n   160→\n   161→        try {\n   162→            DB::beginTransaction();\n   163→            $this->servicio->guardar($request);\n   164→            DB::commit();\n   165→        } catch (Exception $error) {\n   166→            DB::rollBack();\n   167→\n   168→            $codigo    = 400;\n   169→            $respuesta = [\n   170→                'message' => 'Ocurrió un error',\n   171→                'errors'  => $error->getMessage()\n   172→            ];\n   173→        }\n   174→\n   175→        return new JsonResponse($respuesta, $codigo);\n   176→    }\n   177→\n   178→    /**\n   179→     * Actualizar plan.\n   180→     *\n   181→     * @param int $id ID del plan.\n   182→     * @param CrearPlanRequest $request Contenido de la petición.\n   183→     * @return JsonResponse\n   184→     * @author Daniel Beltrán\n   185→     */\n   186→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   187→        $codigo    = 200;\n   188→        $respuesta = [\n   189→            'message' => 'Plan actualizado correctamente'\n   190→        ];\n   191→\n   192→        try {\n   193→            DB::beginTransaction();\n   194→            $request->merge(['id' => $id]);\n   195→            $this->servicio->guardar($request);\n   196→            DB::commit();\n   197→        } catch (Exception $error) {\n   198→            DB::rollBack();\n   199→\n   200→            $codigo    = 400;\n   201→            $respuesta = [\n   202→                'message' => 'Ocurrió un error',\n   203→                'errors'  => $error->getMessage()\n   204→            ];\n   205→        }\n   206→\n   207→        return new JsonResponse($respuesta, $codigo);\n   208→    }\n   209→\n   210→    /**\n   211→     * Eliminar plan.\n   212→     *\n   213→     * @param int $id ID del plan.\n   214→     * @return JsonResponse\n   215→     * @author Daniel Beltrán\n   216→     */\n   217→    public function destroy(int $id): JsonResponse {\n   218→        $codigo    = 200;\n   219→        $respuesta = [\n   220→            'tipo'    => 'success',\n   221→            'mensaje' => 'Plan eliminado correctamente'\n   222→        ];\n   223→\n   224→        try {\n   225→            DB::beginTransaction();\n   226→            $this->servicio->eliminar($id);\n   227→            DB::commit();\n   228→        } catch (Exception $error) {\n   229→            DB::rollBack();\n   230→\n   231→            $codigo    = 400;\n   232→            $respuesta = [\n   233→                'message' => 'Ocurrió un error',\n   234→                'errors'  => $error->getMessage()\n   235→            ];\n   236→        }\n   237→\n   238→        return new JsonResponse($respuesta, $codigo);\n   239→    }\n   240→\n   241→    /**\n   242→     * Archivar o desarchivar plan.\n   243→     *\n   244→     * @param int $id ID del plan.\n   245→     * @param Request $request Contenido de la petición.\n   246→     * @return JsonResponse\n   247→     * @author Daniel Beltrán\n   248→     */\n   249→    public function archivar(int $id, Request $request): JsonResponse {\n   250→        $codigo    = 200;\n   251→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   252→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   253→        $respuesta = [\n   254→            'tipo'    => 'success',\n   255→            'mensaje' => \"Plan {$accion} correctamente\"\n   256→        ];\n   257→\n   258→        $request->merge([\n   259→            'id'         => $id,\n   260→            'activo'     => $activo,\n   261→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   262→        ]);\n   263→\n   264→        try {\n   265→            DB::beginTransaction();\n   266→            $this->servicio->guardar($request);\n   267→            DB::commit();\n   268→        } catch (Exception $error) {\n   269→            DB::rollBack();\n   270→\n   271→            $codigo    = 400;\n   272→            $respuesta = [\n   273→                'message' => 'Ocurrió un error',\n   274→                'errors'  => $error->getMessage()\n   275→            ];\n   276→        }\n   277→\n   278→        return new JsonResponse($respuesta, $codigo);\n   279→    }\n   280→\n   281→    /**\n   282→     * Clonar plan.\n   283→     *\n   284→     * @param int $id ID del plan.\n   285→     * @return JsonResponse\n   286→     * @author Daniel Beltrán\n   287→     */\n   288→    public function clonar(int $id): JsonResponse {\n   289→        $codigo    = 201;\n   290→        $respuesta = [\n   291→            'message' => 'Plan clonado correctamente'\n   292→        ];\n   293→\n   294→        try {\n   295→            DB::beginTransaction();\n   296→            $respuesta['data'] = $this->servicio->clonar($id);\n   297→            DB::commit();\n   298→        } catch (Exception $error) {\n   299→            DB::rollBack();\n   300→\n   301→            $codigo    = 400;\n   302→            $respuesta = [\n   303→                'message' => 'Ocurrió un error',\n   304→                'errors'  => $error->getMessage()\n   305→            ];\n   306→        }\n   307→\n   308→        return new JsonResponse($respuesta, $codigo);\n   309→    }\n   310→\n   311→    /**\n   312→     * Obtener el historial de cambios.\n   313→     *\n   314→     * @param int $id ID del plan.\n   315→     * @return JsonResponse\n   316→     * @author Daniel Beltrán\n   317→     */\n   318→    public function historialCambios(int $id): JsonResponse {\n   319→        return new JsonResponse([\n   320→            'data' => $this->servicio->historialCambios($id)\n   321→        ], 200);\n   322→    }\n   323→\n   324→    /**\n   325→     * Exportar Excel.\n   326→     *\n   327→     * @param Request $request Contenido de la petición.\n   328→     * @return BinaryFileResponse\n   329→     * @author Daniel Beltrán\n   330→     */\n   331→    public function exportarExcel(Request $request): BinaryFileResponse {\n   332→        return Excel::download(new GlobalExport([\n   333→            'ID',\n   334→            'Nombre del plan',\n   335→            'Tipo de prueba',\n   336→            'Pruebas disponibles',\n   337→            'Tiempo',\n   338→            'Unidades',\n   339→            'Ofertas laborales',\n   340→            'Beneficios predeterminados',\n   341→            'Beneficios adicionales',\n   342→            'Usuarios',\n   343→            'Costo',\n   344→            'Fecha de creación',\n   345→            'Empresas con plan activo'\n   346→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   347→    }\n   348→\n   349→    /**\n   350→     * Carga la vista que muestra los planes de una empresa dada.\n   351→     *\n   352→     * @return View\n   353→     * @author Fahibram Cárcamo\n   354→     * @author Jair Carvajal\n   355→     */\n   356→    public function planesClientes(): View {\n   357→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   358→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   359→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   360→        $empresas   = clone $sucursales;\n   361→        $empresas->push($empresa);\n   362→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   363→\n   364→        $planes        = [];\n   365→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   366→\n   367→        foreach ($tipos_pruebas as $tipo_prueba) {\n   368→            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n   369→                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n   370→\n   371→            if (!is_null($plan)) {\n   372→                array_push($planes, $plan);\n   373→            }\n   374→        }\n   375→\n   376→        $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   377→            new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   378→            $empresa\n   379→        );\n   380→\n   381→        return view('empresa.paginas.planes.planes')->with([\n   382→            'empresa'          => $empresa,\n   383→            'usuario_id'       => Auth::id(),\n   384→            'sucursales'       => $empresas,\n   385→            'planes'           => $planes,\n   386→            'rutas_menu'       => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   387→            'perfiles'         => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   388→            'pruebas'          => $this->prueba_repositorio->getTodo(new Request()),\n   389→            'roles'            => $this->rol_repositorio->getTodo(new Request()),\n   390→            'cargos'           => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   391→            'usuarios'         => $usuarios,\n   392→            'servicios_ia'     => $this->servicio_ia_repositorio->getTodo(new Request(['activo' => true])),\n   393→            'usuarios_empresa' => $usuarios\n   394→        ]);\n   395→    }\n   396→}\n   397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"527dc18c-ec2e-4181-a921-e174f84029a5","timestamp":"2026-01-25T01:46:02.398Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"969c0414-5252-4622-8639-d81b3fd5fb6d","timestamp":"2026-01-25T01:46:02.559Z"}
{"parentUuid":"969c0414-5252-4622-8639-d81b3fd5fb6d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:05.504Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01G4DrEqoyYJSrYJQ7r3KDuy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LLHWZMAMeHcANM55seEdc8","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5350,"cache_read_input_tokens":15826,"cache_creation":{"ephemeral_5m_input_tokens":5350,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFZ7BJamQi7rXsynMHC","uuid":"dd2fcb8d-2963-459b-a04e-4537e9747e41"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"8c8bf144-dbb0-405f-8166-101d5128adc4","timestamp":"2026-01-25T01:46:05.541Z"}
{"parentUuid":"8c8bf144-dbb0-405f-8166-101d5128adc4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:05.947Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01G4DrEqoyYJSrYJQ7r3KDuy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CZBizeznamMmE2XrEgAHDU","name":"Glob","input":{"pattern":"app/Http/Repositories/Empresas/**/*Repository.php","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5350,"cache_read_input_tokens":15826,"cache_creation":{"ephemeral_5m_input_tokens":5350,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFZ7BJamQi7rXsynMHC","uuid":"ae4d9267-c354-4d8d-a046-7fd4c29ad80d"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"b5507791-c7a9-4297-992f-e733b3be397f","timestamp":"2026-01-25T01:46:05.987Z"}
{"parentUuid":"b5507791-c7a9-4297-992f-e733b3be397f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LLHWZMAMeHcANM55seEdc8","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Empresas;\n     4→\n     5→use Exception;\n     6→use Carbon\\Carbon;\n     7→use App\\Models\\Planes\\Plan;\n     8→use Illuminate\\Support\\Arr;\n     9→use App\\Traits\\ArchivoTrait;\n    10→use Illuminate\\Http\\Request;\n    11→use App\\Mail\\CrearUsuarioMail;\n    12→use Illuminate\\Http\\UploadedFile;\n    13→use App\\Http\\Services\\BaseService;\n    14→use App\\Models\\Pruebas\\TipoPrueba;\n    15→use Illuminate\\Support\\Collection;\n    16→use App\\Models\\Empresas\\EmpresaPlan;\n    17→use Illuminate\\Support\\Facades\\Notification;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use Illuminate\\Support\\Facades\\{Mail, Password};\n    20→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    23→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    24→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    25→use App\\Notifications\\SolicitudRenovacionPlanNotification;\n    26→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    27→use Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n    28→\n    29→/**\n    30→ * @property EmpresaPlanRepository $repositorio\n    31→ */\n    32→class EmpresaPlanService extends BaseService\n    33→{\n    34→    use ArchivoTrait;\n    35→\n    36→    /**\n    37→     * Constructor.\n    38→     *\n    39→     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n    40→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    41→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    42→     * @param PlanRepository $plan_repositorio Repositorio de planes.\n    43→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    44→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    45→     * @return void\n    46→     * @author Daniel Beltrán\n    47→     */\n    48→    public function __construct(\n    49→        EmpresaPlanRepository $repositorio,\n    50→        protected EmpresaRepository $empresa_repositorio,\n    51→        protected RolRepository $rol_repositorio,\n    52→        protected PlanRepository $plan_repositorio,\n    53→        protected PlanCreditoRepository $plan_credito_repositorio,\n    54→        protected ArchivoRepository $archivo_repositorio,\n    55→        protected UserRepository $usuario_repositorio\n    56→    ) {\n    57→        parent::__construct($repositorio);\n    58→    }\n    59→\n    60→    /**\n    61→     * Guardar un plan de empresa.\n    62→     *\n    63→     * @param Request $request Contenido de la petición.\n    64→     * @return EmpresaPlan\n    65→     * @author Sergio Vargas\n    66→     * @author Daniel Beltrán\n    67→     * @author Andres Morales\n    68→     * @author Jair Carvajal\n    69→     * @author Andres Gonzalez\n    70→     */\n    71→    public function guardar(Request $request): EmpresaPlan {\n    72→        $tiene_plan_seleccion = $request->filled('plan_id');\n    73→        $tiene_plan_creditos  = $request->filled('plan_credito_id');\n    74→        $plan_asignado        = null;\n    75→\n    76→        // Si tiene plan de selección, crear/actualizar ese plan\n    77→        if ($tiene_plan_seleccion) {\n    78→            $plan_asignado = $this->guardarPlanSeleccion($request);\n    79→        }\n    80→\n    81→        // Si tiene plan de créditos, crear ese plan por separado\n    82→        if ($tiene_plan_creditos) {\n    83→            $plan_creditos = $this->guardarPlanCreditos($request);\n    84→\n    85→            // Si no había plan de selección, retornar el de créditos\n    86→            if (!$tiene_plan_seleccion) {\n    87→                $plan_asignado = $plan_creditos;\n    88→            }\n    89→        }\n    90→\n    91→        return $plan_asignado;\n    92→    }\n    93→\n    94→    /**\n    95→     * Guardar un plan de selección.\n    96→     *\n    97→     * @param Request $request Contenido de la petición.\n    98→     * @return EmpresaPlan\n    99→     * @author Andres Gonzalez\n   100→     */\n   101→    protected function guardarPlanSeleccion(Request $request): EmpresaPlan {\n   102→        $enviar_correo    = false;\n   103→        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades', 'precio_creditos', 'porcentaje_descuento_creditos', 'plan_credito_id', 'creditos'];\n   104→        $plan             = $this->plan_repositorio->getUno($request->plan_id);\n   105→        $plan_activo      = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n   106→        $vigencia         = $plan->vigencia;\n   107→\n   108→        if ($request->filled('vigencia')) {\n   109→            $vigencia = $request->vigencia;\n   110→        }\n   111→\n   112→        if (!is_null($plan_activo)) {\n   113→            if ($request->filled('id')) {\n   114→                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n   115→                if ($request->id === $plan_activo->id) {\n   116→                    goto omitir_calcular_vigencia_seleccion;\n   117→                }\n   118→\n   119→                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n   120→                if ($vigencia == $request->vigencia) {\n   121→                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n   122→                    goto omitir_calcular_vigencia_seleccion;\n   123→                }\n   124→            }\n   125→\n   126→            // Poner el nuevo plan como proximo\n   127→            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n   128→\n   129→            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n   130→            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n   131→                // Agregar las nuevas fechas al nuevo plan\n   132→                $hoy          = now();\n   133→                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n   134→                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n   135→            }\n   136→        } else {\n   137→            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   138→\n   139→            // Validar si el plan seleccionado tiene vigencia\n   140→            if (!is_null($plan->vigencia)) {\n   141→                $request->merge($this->calcularFechasVigencia($vigencia));\n   142→            }\n   143→        }\n   144→\n   145→        omitir_calcular_vigencia_seleccion:\n   146→\n   147→        if (!$request->filled('unidades')) {\n   148→            $request->merge(['unidades' => $plan->unidades]);\n   149→        } elseif ($request->unidades != $plan->unidades) {\n   150→            $request->merge(['plan_original' => false]);\n   151→        }\n   152→\n   153→        if (!$request->filled('cantidad_ofertas_laborales')) {\n   154→            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n   155→        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n   156→            $request->merge(['plan_original' => false]);\n   157→        }\n   158→\n   159→        if (!$request->filled('cantidad_usuarios')) {\n   160→            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n   161→        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n   162→            $request->merge(['plan_original' => false]);\n   163→        }\n   164→\n   165→        if (!$request->filled('cantidad_pruebas')) {\n   166→            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n   167→        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n   168→            $request->merge(['plan_original' => false]);\n   169→        }\n   170→\n   171→        // Comprobar si se modificaron las funcionalidades respecto al plan original\n   172→        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n   173→            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n   174→            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n   175→            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n   176→\n   177→            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n   178→                $request->merge(['plan_original' => false]);\n   179→            }\n   180→        }\n   181→\n   182→        if ($request->filled('id')) {\n   183→            // Eliminar la factura actual\n   184→            if ($request->hasFile('factura')) {\n   185→                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n   186→\n   187→                if (!is_null($archivo)) {\n   188→                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n   189→                    $this->archivo_repositorio->eliminar($archivo->id);\n   190→                }\n   191→            }\n   192→\n   193→            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n   194→        } else {\n   195→            $enviar_correo = true;\n   196→            $request->merge(['usuario_id' => auth()->user()->id]);\n   197→            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n   198→        }\n   199→\n   200→        if ($request->filled('pruebas')) {\n   201→            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n   202→        }\n   203→\n   204→        if ($request->filled('funcionalidades')) {\n   205→            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n   206→        }\n   207→\n   208→        if ($request->hasFile('factura')) {\n   209→            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n   210→        }\n   211→\n   212→        if ($enviar_correo) {\n   213→            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n   214→            $usuario      = $empresa->usuarios[0];\n   215→            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n   216→            $titulo       = 'Usuario principal de la empresa creado';\n   217→            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n   218→        }\n   219→\n   220→        return $plan_asignado;\n   221→    }\n   222→\n   223→    /**\n   224→     * Guardar un plan de créditos.\n   225→     *\n   226→     * @param Request $request Contenido de la petición.\n   227→     * @return EmpresaPlan\n   228→     * @author Andres Gonzalez\n   229→     */\n   230→    protected function guardarPlanCreditos(Request $request): EmpresaPlan {\n   231→        $enviar_correo = false;\n   232→        $plan_credito  = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n   233→        $plan_activo   = $this->repositorio->planCreditosActivo($request->empresa_id);\n   234→\n   235→        // Preparar datos para el plan de créditos\n   236→        $datos_creditos = [\n   237→            'empresa_id'            => $request->empresa_id,\n   238→            'plan_id'               => null,\n   239→            'plan_credito_id'       => $request->plan_credito_id,\n   240→            'creditos'              => $plan_credito->creditos ?? 0,\n   241→            'precio'                => $request->precio_creditos ?? $plan_credito->precio ?? null,\n   242→            'porcentaje_descuento'  => $request->porcentaje_descuento_creditos ?? null,\n   243→            'numero_factura'        => $request->numero_factura,\n   244→            'comentario'            => $request->comentario,\n   245→            'fecha_inicio'          => null,\n   246→            'fecha_vencimiento'     => null,\n   247→            'usuario_id'            => auth()->user()->id,\n   248→        ];\n   249→\n   250→        // Si es edición de un plan de créditos existente\n   251→        if ($request->filled('id')) {\n   252→            // Eliminar la factura actual si se sube una nueva\n   253→            if ($request->hasFile('factura')) {\n   254→                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n   255→\n   256→                if (!is_null($archivo)) {\n   257→                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n   258→                    $this->archivo_repositorio->eliminar($archivo->id);\n   259→                }\n   260→            }\n   261→\n   262→            $plan_asignado = $this->repositorio->actualizar($request->id, $datos_creditos);\n   263→        } else {\n   264→            // Determinar estado para nuevo plan\n   265→            if (!is_null($plan_activo) && $plan_activo->id != $request->id) {\n   266→                $datos_creditos['estado_id'] = Plan::ESTADO_PROXIMO_ID;\n   267→            } else {\n   268→                $datos_creditos['estado_id'] = Plan::ESTADO_ACTIVO_ID;\n   269→            }\n   270→\n   271→            $enviar_correo = true;\n   272→            $plan_asignado = $this->repositorio->crear($datos_creditos);\n   273→        }\n   274→\n   275→        if ($request->hasFile('factura')) {\n   276→            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n   277→        }\n   278→\n   279→        return $plan_asignado;\n   280→    }\n   281→\n   282→    /**\n   283→     * Renovar el plan asignado.\n   284→     *\n   285→     * @param int $id ID del plan de la empresa que se quiere renovar.\n   286→     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n   287→     * @return EmpresaPlan Plan de la empresa renovado.\n   288→     * @author Daniel Beltrán\n   289→     */\n   290→    public function renovar(int $id): EmpresaPlan {\n   291→        $empresa_plan = $this->repositorio->getUno($id);\n   292→\n   293→        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n   294→            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n   295→        }\n   296→\n   297→        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n   298→\n   299→        $request->merge(['por_facturar' => true]);\n   300→\n   301→        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n   302→            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n   303→            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n   304→        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {\n   305→            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n   306→            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   307→        }\n   308→\n   309→        $this->verificarYAsignarTiempo($empresa_plan, $request);\n   310→\n   311→        $plan_renovado = $this->repositorio->crear($request->toArray());\n   312→\n   313→        if ($request->filled('pruebas')) {\n   314→            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n   315→        }\n   316→\n   317→        if ($request->filled('funcionalidades')) {\n   318→            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n   319→        }\n   320→\n   321→        return $plan_renovado;\n   322→    }\n   323→\n   324→    /**\n   325→     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n   326→     *\n   327→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   328→     * @param Request $request Contenido de la petición.\n   329→     * @return void\n   330→     * @author Daniel Beltrán\n   331→     */\n   332→    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n   333→        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n   334→            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n   335→        }\n   336→    }\n   337→\n   338→    /**\n   339→     * Calcular las fechas en las que el plan estará vigente.\n   340→     *\n   341→     * @param int $vigencia Cantidad de días de vigencia.\n   342→     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n   343→     * @return array Fechas de inicio y vencimiento.\n   344→     * @author Daniel Beltrán\n   345→     */\n   346→    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n   347→        $hoy = now();\n   348→\n   349→        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n   350→\n   351→        // Si es múltiplo de 3, entonces la vigencia es en meses\n   352→\n   353→        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n   354→            $meses = $vigencia / 30;\n   355→\n   356→            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n   357→\n   358→            if ($fecha_inicio->day === 1) {\n   359→                $fecha_vencimiento->subDay();\n   360→            }\n   361→        } else {\n   362→            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n   363→\n   364→            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n   365→        }\n   366→\n   367→        return [\n   368→            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n   369→\n   370→            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n   371→        ];\n   372→    }\n   373→\n   374→    /**\n   375→     * Facturar un plan de empresa.\n   376→     *\n   377→     * @param int $id ID del plan de empresa.\n   378→     * @param Request $request Contenido de la petición.\n   379→     * @return EmpresaPlan\n   380→     * @author Daniel Beltrán\n   381→     */\n   382→    public function facturar(int $id, Request $request): EmpresaPlan {\n   383→        $empresa_plan = $this->repositorio->getUno($id);\n   384→\n   385→        if ($request->filled('vigencia')) {\n   386→            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n   387→        }\n   388→\n   389→        $request->merge(['por_facturar' => false]);\n   390→\n   391→        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n   392→\n   393→        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n   394→\n   395→        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n   396→\n   397→        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n   398→    }\n   399→\n   400→    /**\n   401→     * Guardar factura.\n   402→     *\n   403→     * @param int $id ID del plan de empresa.\n   404→     * @param int $empresa_id ID de la empresa.\n   405→     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n   406→     * @return void\n   407→     * @author Daniel Beltrán\n   408→     */\n   409→    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n   410→        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n   411→\n   412→        $this->generarDirectorios(\"app/{$ruta}\");\n   413→\n   414→        $nombre_archivo = $this->generarNombreArchivo($archivo);\n   415→\n   416→        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n   417→\n   418→        $this->archivo_repositorio->crear([\n   419→            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n   420→\n   421→            'modelo_id' => $id,\n   422→\n   423→            'nombre' => 'factura',\n   424→\n   425→            'ruta' => $ruta . '/' . $nombre_archivo\n   426→        ]);\n   427→    }\n   428→\n   429→    /**\n   430→     * Obtener el historial de recompras de una empresa por tipo de prueba.\n   431→     *\n   432→     * @param Request $request Contenido de la petición HTTP entrante.\n   433→     * @return Collection\n   434→     * @author Daniel Beltrán\n   435→     * @author Fahibram Cárcamo\n   436→     * @author Andres Morales\n   437→     * @author Andres Gonzalez\n   438→     */\n   439→    public function historialRecompras(Request $request): Collection {\n   440→        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n   441→\n   442→        $request->merge([\n   443→            'con_conteo_consumos_agendas'           => true,\n   444→            'con_conteo_consumos_ofertas_laborales' => true\n   445→        ]);\n   446→\n   447→        return match ($rol_usuario->id) {\n   448→            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n   449→\n   450→            RolRepository::ROL_PROPIETARIO_ID,\n   451→\n   452→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   453→\n   454→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   455→\n   456→            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n   457→        };\n   458→    }\n   459→\n   460→    /**\n   461→     * Obtener el historial de compras de planes con creditos para una empresa.\n   462→     *\n   463→     * @param int $empresa_id ID de la empresa.\n   464→     * @param Request $request Contenido de la peticion.\n   465→     * @return Collection\n   466→     * @author Sergio Vargas\n   467→     */\n   468→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   469→        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n   470→\n   471→        return $historial->map(function (EmpresaPlan $plan) {\n   472→            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n   473→\n   474→            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n   475→\n   476→            $plan->creditos_totales = $total_creditos;\n   477→\n   478→            $plan->creditos_consumidos = $creditos_consumidos;\n   479→\n   480→            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n   481→\n   482→            return $plan;\n   483→        });\n   484→    }\n   485→\n   486→    /**\n   487→     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n   488→     *\n   489→     * @param int $empresa_id ID de la empresa.\n   490→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   491→     * @return ?EmpresaPlan\n   492→     * @author Daniel Beltrán\n   493→     */\n   494→    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   495→        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n   496→            'empresa_id'             => $empresa_id,\n   497→            'tipo_prueba_id'         => $tipo_prueba_id,\n   498→            'excluir_estado_proximo' => true\n   499→        ]));\n   500→\n   501→        if (!is_null($plan)) {\n   502→            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   503→\n   504→            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n   505→        }\n   506→\n   507→        return $plan;\n   508→    }\n   509→\n   510→    /**\n   511→     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n   512→     *\n   513→     * @param int $id ID del plan de empresa.\n   514→     * @return ?EmpresaPlan\n   515→     * @author Daniel Beltrán\n   516→     */\n   517→    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n   518→        $plan               = $this->repositorio->getUno($id);\n   519→        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n   520→\n   521→        return $plan;\n   522→    }\n   523→\n   524→    /**\n   525→     * Obtener el plan activo de la empresa por tipo de prueba.\n   526→     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n   527→     * La propiedad se llama 'plan_proximo' y es un booleano.\n   528→     *\n   529→     * @param int $empresa_id ID de la empresa.\n   530→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   531→     * @return ?EmpresaPlan\n   532→     * @author Daniel Beltrán\n   533→     */\n   534→    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   535→        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   536→\n   537→        if (!is_null($plan)) {\n   538→            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n   539→        }\n   540→\n   541→        return $plan;\n   542→    }\n   543→\n   544→    /**\n   545→     * Solicitar la renovación de un plan específico de una empresa específica.\n   546→     *\n   547→     * @param Request $request Solicitud HTTP.\n   548→     * @return void\n   549→     * @author Fahibram Cárcamo\n   550→     * @author Andres González\n   551→     */\n   552→    public function solicitarRenovacionPlan(Request $request) {\n   553→        $tipo_plan = $request->tipo_plan ?? 'plan';\n   554→\n   555→        if ($tipo_plan === 'plan_credito') {\n   556→            $plan = $this->plan_credito_repositorio->getUno($request->plan_id);\n   557→        } else {\n   558→            $plan = $this->plan_repositorio->getUno($request->plan_id);\n   559→        }\n   560→\n   561→        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n   562→        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n   563→\n   564→        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   565→            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n   566→            'con_roles_ids' => true\n   567→        ]));\n   568→\n   569→        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   570→            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n   571→            'empresa_id'    => $request->empresa_id,\n   572→            'con_roles_ids' => true\n   573→        ]));\n   574→\n   575→        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n   576→        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n   577→    }\n   578→\n   579→    /**\n   580→     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n   581→     *\n   582→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   583→     * @return bool\n   584→     * @author Daniel Beltrán\n   585→     * @author Fahibram Cárcamo\n   586→     */\n   587→    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n   588→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   589→            return true;\n   590→        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n   591→            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n   592→                return true;\n   593→            }\n   594→        }\n   595→\n   596→        return false;\n   597→    }\n   598→\n   599→    /**\n   600→     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n   601→     *\n   602→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   603→     * @return bool\n   604→     * @author Daniel Beltrán\n   605→     * @author Fahibram Cárcamo\n   606→     */\n   607→    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   608→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   609→            return true;\n   610→        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n   611→            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n   612→                return true;\n   613→            }\n   614→        }\n   615→\n   616→        return false;\n   617→    }\n   618→\n   619→    /**\n   620→     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n   621→     *\n   622→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   623→     * @return bool\n   624→     * @author Fahibram Cárcamo\n   625→     */\n   626→    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n   627→        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n   628→    }\n   629→\n   630→    /**\n   631→     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n   632→     *\n   633→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   634→     * @return bool\n   635→     * @author Fahibram Cárcamo\n   636→     */\n   637→    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   638→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n   639→    }\n   640→\n   641→    /**\n   642→     * Verificar que la fecha de vencimiento del plan no haya pasado.\n   643→     *\n   644→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   645→     * @return bool\n   646→     * @author Andres Gonzalez\n   647→     */\n   648→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   649→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n   650→            return true;\n   651→        }\n   652→\n   653→        return false;\n   654→    }\n   655→\n   656→    /**\n   657→     * Verificar que el plan tenga vacantes disponibles.\n   658→     *\n   659→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   660→     * @return bool\n   661→     * @author Andres Gonzalez\n   662→     */\n   663→    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n   664→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n   665→    }\n   666→\n   667→    /**\n   668→     * Obtener creditos disponibles para un plan de empresa.\n   669→     *\n   670→     * @param int $empresa_plan_id ID del plan de empresa.\n   671→     * @return int\n   672→     * @author Sergio Vargas\n   673→     * @author Daniel Beltrán\n   674→     */\n   675→    public function creditosDisponibles(int $empresa_plan_id): int {\n   676→        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n   677→\n   678→        return $empresa_plan?->creditos_restantes ?? 0;\n   679→    }\n   680→\n   681→    /**\n   682→     * Obtener creditos disponibles y plan asignado de una empresa.\n   683→     *\n   684→     * @param int $empresa_id ID de la empresa.\n   685→     * @param Request $request Contenido de la peticion.\n   686→     * @return array|null\n   687→     * @author Sergio Vargas\n   688→     * @author José Manuel Jiménez\n   689→     */\n   690→    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n   691→        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n   692→            ? (int) $request->tipo_prueba_id\n   693→            : TipoPrueba::SELECCION_ID;\n   694→\n   695→        $empresa_plan = $this->repositorio->planCreditosActivo($empresa_id);\n   696→\n   697→        if (!$empresa_plan) {\n   698→            return null;\n   699→        }\n   700→\n   701→        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n   702→\n   703→        return [\n   704→            'empresa_id'           => $empresa_id,\n   705→            'empresa_plan_id'      => $empresa_plan->id,\n   706→            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n   707→            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n   708→            'plan_credito'         => $empresa_plan->planCredito ? [\n   709→                'id'       => $empresa_plan->planCredito->id,\n   710→                'nombre'   => $empresa_plan->planCredito->nombre,\n   711→                'creditos' => $empresa_plan->planCredito->creditos,\n   712→                'precio'   => $empresa_plan->planCredito->precio\n   713→            ] : null,\n   714→            'estado'               => $empresa_plan->estado ? [\n   715→                'id'     => $empresa_plan->estado->id,\n   716→                'nombre' => $empresa_plan->estado->nombre,\n   717→            ] : null\n   718→        ];\n   719→    }\n   720→\n   721→    /**\n   722→     * Validar si hay creditos suficientes.\n   723→     *\n   724→     * @param int $empresa_plan_id ID del plan de empresa.\n   725→     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n   726→     * @return bool\n   727→     * @author Sergio Vargas\n   728→     * @author Daniel Beltrán\n   729→     */\n   730→    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n   731→        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n   732→    }\n   733→}\n   734→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"438f7de7-e013-43b8-b86d-fa91086b90cf","timestamp":"2026-01-25T01:46:07.993Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"2d2a11e7-664b-4bfa-8617-4c59dd8dc16d","timestamp":"2026-01-25T01:46:08.054Z"}
{"parentUuid":"2d2a11e7-664b-4bfa-8617-4c59dd8dc16d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CZBizeznamMmE2XrEgAHDU","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\AreaRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\CargoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaEnlaceCreacionRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanFuncionalidadRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\MigracionEmpresaRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\MotivadorRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\PortalEmpleoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\PremioDestacadoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\SectorRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\TamanoEmpresaRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php"}]},"uuid":"60b623e8-d0ca-4cca-a379-075971e28a69","timestamp":"2026-01-25T01:46:08.648Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"08c79d4f-8629-478c-94ce-75662c2d1e32","timestamp":"2026-01-25T01:46:08.698Z"}
{"parentUuid":"08c79d4f-8629-478c-94ce-75662c2d1e32","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:11.414Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TDHTiBdtR63Q8DTjcFxpcW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DGLqg73yS8DHYvZW8xw5u1","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && find . -path ./vendor -prune -o -name \"*.php\" -type f -exec grep -l \"empresas-gestionar-datos\" {} \\;"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":11195,"cache_read_input_tokens":15939,"cache_creation":{"ephemeral_5m_input_tokens":11195,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFZ6ca6PDgydLiySDGb","uuid":"99306e5f-e319-4e8e-bc73-d5143bd66084"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"58d8028f-0a07-4641-a67e-a6d8c984a156","timestamp":"2026-01-25T01:46:11.450Z"}
{"parentUuid":"58d8028f-0a07-4641-a67e-a6d8c984a156","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:12.436Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Kv2SowikQfqoaJYe47BX3x","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01URbGQyqQzkbSW4ZGnasngB","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":12342,"cache_read_input_tokens":21176,"cache_creation":{"ephemeral_5m_input_tokens":12342,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFZZNu5DN1DrwUusQcP","uuid":"fff162dd-5812-42e2-bc21-a5b1c556a722"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"9cbdcd40-0091-4e80-a2d7-7ce9028b3d45","timestamp":"2026-01-25T01:46:12.481Z"}
{"parentUuid":"9cbdcd40-0091-4e80-a2d7-7ce9028b3d45","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01URbGQyqQzkbSW4ZGnasngB","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\Empresas;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\Pruebas\\TipoPrueba;\n     7→use Illuminate\\Support\\Collection;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use App\\Http\\Repositories\\BaseRepository;\n    11→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    12→use App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n    13→\n    14→class EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n    15→{\n    16→    /**\n    17→     * Ids de los roles de tipo empresa.\n    18→     *\n    19→     * @var array\n    20→     * @author Fahibram Cárcamo\n    21→     */\n    22→    private const IDS_ROLES_TIPO_EMPRESA = [\n    23→        RolRepository::ROL_PROPIETARIO_ID,\n    24→        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n    25→        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n    26→        RolRepository::ROL_EVALUADOR_ID\n    27→    ];\n    28→\n    29→    private $consulta_conteo_total_usuarios_empresa_sucursales;\n    30→\n    31→    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n    32→\n    33→    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n    39→     * @return void\n    40→     * @author Daniel Beltrán\n    41→     * @author Fahibram Cárcamo\n    42→     */\n    43→    public function __construct(EmpresaPlan $modelo) {\n    44→        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n    45→            (\n    46→                SELECT COUNT(DISTINCT eu.usuario_id)\n    47→                FROM empresas_usuarios AS eu\n    48→                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n    49→                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n    50→                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n    51→            ) AS conteo_total_usuarios_empresa_sucursales\n    52→        ';\n    53→\n    54→        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n    55→            (\n    56→                SELECT COUNT(*)\n    57→                FROM consumos\n    58→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    59→                WHERE (\n    60→                    consumos.empresa_id = empresas_planes.empresa_id\n    61→                    OR suc.empresa_id = empresas_planes.empresa_id\n    62→                )\n    63→                AND consumos.agenda_id IS NOT NULL\n    64→            ) AS conteo_total_consumos_agendas_empresa_sucursales\n    65→        ';\n    66→\n    67→        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n    68→            (\n    69→                SELECT COUNT(*)\n    70→                FROM consumos\n    71→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    72→                WHERE (\n    73→                    consumos.empresa_id = empresas_planes.empresa_id\n    74→                    OR suc.empresa_id = empresas_planes.empresa_id\n    75→                )\n    76→                AND consumos.oferta_laboral_id IS NOT NULL\n    77→            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n    78→        ';\n    79→\n    80→        parent::__construct($modelo);\n    81→    }\n    82→\n    83→    /**\n    84→     * Obtener todos los planes de empresas.\n    85→     *\n    86→     * @param Request $request Contenido de la petición.\n    87→     * @return Collection\n    88→     * @author Daniel Beltrán\n    89→     * @author Fahibram Cárcamo\n    90→     * @author Jair Carvajal\n    91→     * @author Andres Gonzalez\n    92→     */\n    93→    public function getTodo(Request $request): Collection {\n    94→        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n    95→            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    96→        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n    97→            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n    98→        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n    99→            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n   100→        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n   101→            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n   102→        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n   103→            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n   104→\n   105→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   106→        ->with([\n   107→            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n   108→            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   109→            'plan.tipoPrueba:id,nombre',\n   110→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   111→            'estado:id,nombre',\n   112→            'pruebas:id,nombre',\n   113→            'funcionalidades:id,nombre,predeterminado',\n   114→            'archivos' => function ($archivos) {\n   115→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   116→            }\n   117→        ])\n   118→        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   119→            $query->with([\n   120→                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   121→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   122→                        ->with(['empresa' => function ($empresa) {\n   123→                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n   124→                        }])\n   125→                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n   126→                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n   127→                },\n   128→                'consumos.agenda:id,prueba_id',\n   129→                'consumos.agenda.prueba:id,nombre,slug'\n   130→            ]);\n   131→        })\n   132→        ->when($con_conteo_consumos_agendas, function ($consulta) {\n   133→            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   134→        })\n   135→        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n   136→            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   137→        })\n   138→        ->when($con_conteo_consumos_creditos, function ($consulta) {\n   139→            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n   140→        })\n   141→        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n   142→            $query->where('empresa_id', $request->empresa_id);\n   143→        })\n   144→        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n   145→            $query->whereHas('plan', function ($plan) use ($request) {\n   146→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   147→            });\n   148→        })\n   149→        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n   150→            $query->whereHas('plan', function ($plan) use ($request) {\n   151→                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n   152→            });\n   153→        })\n   154→        ->when($request->filled('plan_id'), function ($query) use ($request) {\n   155→            $query->where('plan_id', $request->plan_id);\n   156→        })\n   157→        ->when(\n   158→            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n   159→            function ($query) use ($request) {\n   160→                $query->whereIn($request->campo, $request->valores);\n   161→            }\n   162→        )\n   163→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   164→            $consulta->whereIn('estado_id', $request->estado_id);\n   165→        })\n   166→        ->when(\n   167→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   168→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   169→        )\n   170→        ->when(\n   171→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   172→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   173→        )\n   174→        ->when(\n   175→            $request->filled('fecha_vencimiento_desde'),\n   176→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   177→        )\n   178→        ->when(\n   179→            $request->filled('fecha_vencimiento_hasta'),\n   180→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   181→        )\n   182→        ->when(\n   183→            $request->filled('fecha_inicio_desde'),\n   184→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   185→        )\n   186→        ->when(\n   187→            $request->filled('fecha_inicio_hasta'),\n   188→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   189→        )\n   190→        ->orderBy('created_at', 'DESC')\n   191→        ->get();\n   192→    }\n   193→\n   194→    /**\n   195→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n   196→     *\n   197→     * @param Request $request Contenido de la petición HTTP entrante.\n   198→     * @return Collection\n   199→     * @author Fahibram Cárcamo\n   200→     * @author Jair Carvajal\n   201→     */\n   202→    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n   203→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   204→            ->addSelect([\n   205→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   206→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   207→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   208→            ])\n   209→            ->whereExists(function ($subconsulta) {\n   210→                $subconsulta->select(DB::raw(1))\n   211→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   212→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   213→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   214→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   215→            })\n   216→            ->with([\n   217→                'estado:id,nombre',\n   218→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   219→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n   220→            ])\n   221→            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n   222→            ->when(\n   223→                $request->filled('tipo_prueba_id'),\n   224→                function ($consulta) use ($request) {\n   225→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   226→                },\n   227→                function ($consulta) {\n   228→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   229→                        TipoPrueba::SELECCION_ID,\n   230→                        TipoPrueba::ORGANIZACIONAL_ID,\n   231→                        TipoPrueba::VOCACIONAL_ID\n   232→                    ]));\n   233→                }\n   234→            )\n   235→            ->get();\n   236→    }\n   237→\n   238→    /**\n   239→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n   240→     *\n   241→     * @param Request $request Contenido de la petición HTTP entrante.\n   242→     * @return Collection\n   243→     * @author Fahibram Cárcamo\n   244→     * @author Andres Gonzalez\n   245→     * @author Jair Carvajal\n   246→     */\n   247→    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n   248→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   249→            ->addSelect([\n   250→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   251→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   252→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   253→            ])\n   254→            ->whereExists(function ($sub_consulta) {\n   255→                $sub_consulta->select(DB::raw(1))\n   256→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   257→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   258→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   259→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   260→            })\n   261→            ->with([\n   262→                'estado:id,nombre',\n   263→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   264→                'plan.tipoPrueba:id,nombre',\n   265→                'pruebas:id,nombre,slug',\n   266→                'funcionalidades:id,nombre,predeterminado',\n   267→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n   268→                'consumos' => function ($consumos) {\n   269→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   270→                        ->with([\n   271→                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   272→                            'agenda:id,prueba_id',\n   273→                            'agenda.prueba:id,nombre,slug'\n   274→                        ]);\n   275→                }\n   276→            ])\n   277→            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   278→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   279→            })\n   280→            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   281→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n   282→            })\n   283→            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n   284→                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n   285→                    $sub_consulta->where('empresa_id', $request->empresa_id)\n   286→                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n   287→                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n   288→                        });\n   289→                });\n   290→            })\n   291→            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   292→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   293→            }, function ($consulta) {\n   294→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   295→                    TipoPrueba::SELECCION_ID,\n   296→                    TipoPrueba::ORGANIZACIONAL_ID,\n   297→                    TipoPrueba::VOCACIONAL_ID\n   298→                ]));\n   299→            })\n   300→            ->orderBy('created_at', 'DESC')\n   301→            ->get();\n   302→    }\n   303→\n   304→    /**\n   305→     * Obtener datos básicos de los planes de empresas.\n   306→     *\n   307→     * @param Request $request Contenido de la petición.\n   308→     * @return Collection\n   309→     * @author Daniel Beltrán\n   310→     * @author Fahibram Cárcamo\n   311→     * @author Jair Carvajal\n   312→     * @author Sergio Vargas\n   313→     */\n   314→    public function getDatosBasicos(Request $request): Collection {\n   315→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   316→        ->with([\n   317→            'plan:id,tipo_prueba_id,nombre',\n   318→            'planCredito:id,nombre,creditos',\n   319→            'consumosCreditos'\n   320→        ])\n   321→        ->withCount([\n   322→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   323→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n   324→        ])\n   325→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   326→            $consulta->where('empresa_id', $request->empresa_id);\n   327→        })\n   328→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   329→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   330→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   331→            });\n   332→        })\n   333→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   334→            $consulta->whereIn('estado_id', $request->estados_ids);\n   335→        })\n   336→        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n   337→            $sentido = $request->ordenar_sentido ?? 'ASC';\n   338→            $consulta->orderBy($request->ordenar_por, $sentido);\n   339→        })\n   340→        ->get();\n   341→    }\n   342→\n   343→    /**\n   344→     * Obtener el proximo plan de creditos de la empresa.\n   345→     *\n   346→     * @param int $empresa_id ID de la empresa.\n   347→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   348→     * @return EmpresaPlan|null\n   349→     * @author Sergio Vargas\n   350→     */\n   351→    public function planProximoCreditos(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   352→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   353→        ->with(['planCredito:id,nombre,creditos,precio'])\n   354→        ->where([\n   355→            'empresa_id' => $empresa_id,\n   356→            'estado_id'  => 3\n   357→        ])\n   358→        ->whereNotNull('plan_credito_id')\n   359→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   360→            $query->where(function ($q) use ($tipo_prueba_id) {\n   361→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   362→                  ->orWhereNull('plan_id');\n   363→            });\n   364→        })\n   365→        ->orderBy('created_at', 'ASC')\n   366→        ->first();\n   367→    }\n   368→\n   369→    /**\n   370→     * Obtener el plan de creditos activo de la empresa.\n   371→     *\n   372→     * @param int $empresa_id ID de la empresa.\n   373→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   374→     * @return EmpresaPlan|null\n   375→     * @author Sergio Vargas\n   376→     */\n   377→    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   378→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   379→        ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n   380→        ->where('empresa_id', $empresa_id)\n   381→        ->whereNotNull('plan_credito_id')\n   382→        ->whereIn('estado_id', [1, 4])\n   383→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   384→            $query->where(function ($q) use ($tipo_prueba_id) {\n   385→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   386→                  ->orWhereNull('plan_id');\n   387→            });\n   388→        })\n   389→        ->first();\n   390→    }\n   391→\n   392→    /**\n   393→     * Obtener un plan de empresa.\n   394→     *\n   395→     * @param int $id ID del plan de empresa.\n   396→     * @return EmpresaPlan|null\n   397→     * @author Daniel Beltrán\n   398→     * @author Jair Carvajal\n   399→     */\n   400→    public function getUno(int $id): ?EmpresaPlan {\n   401→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   402→        ->with([\n   403→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n   404→            'plan.tipoPrueba:id,nombre',\n   405→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   406→            'estado:id,nombre',\n   407→            'pruebas:id,nombre,slug',\n   408→            'funcionalidades:id,nombre,llave,valor',\n   409→            'archivos' => function ($archivos) {\n   410→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   411→            }\n   412→        ])\n   413→        ->find($id);\n   414→    }\n   415→\n   416→    /**\n   417→     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n   418→     *\n   419→     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n   420→     *\n   421→     * @param int $empresa_id ID de la empresa.\n   422→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   423→     * @return EmpresaPlan|null\n   424→     * @author Daniel Beltrán\n   425→     * @author Fahibram Cárcamo\n   426→     * @author José Manuel Jiménez\n   427→     * @author Andres Gonzalez\n   428→     * @author Sergio Vargas\n   429→     * @author Jair Carvajal\n   430→     */\n   431→    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   432→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   433→        ->with([\n   434→            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n   435→            'plan.tipoPrueba:id,nombre',\n   436→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   437→            'estado:id,nombre',\n   438→            'pruebas:id,nombre,slug',\n   439→            'usuario:id,nombres,apellidos',\n   440→            'archivos' => function ($archivos) {\n   441→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   442→                ->orderBy('created_at', 'DESC');\n   443→            }\n   444→        ])\n   445→        ->withCount([\n   446→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   447→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n   448→            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n   449→        ])\n   450→        ->where('empresa_id', $empresa_id)\n   451→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   452→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   453→        })\n   454→        ->whereIn('estado_id', [1, 4])\n   455→        ->first();\n   456→    }\n   457→\n   458→    /**\n   459→     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n   460→     *\n   461→     * @param int $empresa_id ID de la empresa.\n   462→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   463→     * @return EmpresaPlan|null\n   464→     * @author Daniel Beltrán\n   465→     * @author Jair Carvajal\n   466→     */\n   467→    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   468→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   469→        ->with([\n   470→            'plan:id,tipo_prueba_id,nombre',\n   471→            'plan.tipoPrueba:id,nombre',\n   472→            'estado:id,nombre',\n   473→            'pruebas:id,nombre',\n   474→            'archivos' => function ($archivos) {\n   475→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   476→                ->orderBy('created_at', 'DESC');\n   477→            }\n   478→        ])\n   479→        ->where([\n   480→            'empresa_id' => $empresa_id,\n   481→            'estado_id'  => 3\n   482→        ])\n   483→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   484→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   485→        })\n   486→        ->first();\n   487→    }\n   488→\n   489→    /**\n   490→     * Obtener el último plan asignado.\n   491→     *\n   492→     * @param Request $request Contenido de la petición.\n   493→     * @return EmpresaPlan|null\n   494→     * @author Daniel Beltrán\n   495→     * @author Jair Carvajal\n   496→     */\n   497→    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n   498→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   499→        ->with([\n   500→            'plan:id,tipo_prueba_id,nombre',\n   501→            'plan.tipoPrueba:id,nombre',\n   502→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   503→            'estado:id,nombre',\n   504→            'pruebas:id,nombre',\n   505→            'archivos' => function ($archivos) {\n   506→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   507→                ->orderBy('created_at', 'DESC');\n   508→            }\n   509→        ])\n   510→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   511→            $consulta->where('empresa_id', $request->empresa_id);\n   512→        })\n   513→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   514→            $consulta->where('estado_id', $request->estado_id);\n   515→        })\n   516→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   517→            $consulta->whereIn('estado_id', $request->estados_ids);\n   518→        })\n   519→        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   520→            $consulta->where('estado_id', '!=', 3);\n   521→        })\n   522→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   523→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   524→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   525→            });\n   526→        })\n   527→        ->orderBy('created_at', 'DESC')\n   528→        ->first();\n   529→    }\n   530→\n   531→    /**\n   532→     * Sincronizar pruebas.\n   533→     *\n   534→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   535→     * @param array $pruebas ID's de las pruebas.\n   536→     * @return void\n   537→     * @author Daniel Beltrán\n   538→     */\n   539→    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n   540→        $empresa_plan->pruebas()->sync($pruebas);\n   541→    }\n   542→\n   543→    /**\n   544→     * Sincronizar funcionalidades.\n   545→     *\n   546→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   547→     * @param array $funcionalidades ID's de las funcionalidades.\n   548→     * @return void\n   549→     * @author Daniel Beltrán\n   550→     */\n   551→    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n   552→        $empresa_plan->funcionalidades()->sync($funcionalidades);\n   553→    }\n   554→\n   555→    /**\n   556→     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n   557→     *\n   558→     * @param Request $request Contenido de la petición.\n   559→     * @return ?EmpresaPlan\n   560→     * @author Fahibram Cárcamo\n   561→     * @author Jair Carvajal\n   562→     */\n   563→    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n   564→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   565→        ->with([\n   566→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n   567→            'plan.tipoPrueba:id,nombre',\n   568→            'estado:id,nombre',\n   569→            'pruebas:id,nombre',\n   570→            'funcionalidades:id,nombre,llave,valor'\n   571→        ])\n   572→        ->when(\n   573→            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n   574→            function ($consulta) {\n   575→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   576→            }\n   577→        )\n   578→        ->when(\n   579→            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n   580→            function ($consulta) {\n   581→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   582→            }\n   583→        )\n   584→        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n   585→        ->first();\n   586→    }\n   587→\n   588→    /**\n   589→     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n   590→     *\n   591→     * @return Collection\n   592→     * @author Fahibram Cárcamo\n   593→     * @author Andres Gonzalez\n   594→     * @author José Manuel Jiménez\n   595→     * @author Jair Carvajal\n   596→     * @author Daniel Beltrán\n   597→     */\n   598→    public function datosConsumosEmpresas(Request $request): Collection {\n   599→        $roles_tipo_empresa_ids = [\n   600→            RolRepository::ROL_PROPIETARIO_ID,\n   601→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   602→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   603→            RolRepository::ROL_EVALUADOR_ID\n   604→        ];\n   605→\n   606→        $matriz_conteos = [\n   607→            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n   608→            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n   609→            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n   610→                'empresasUsuarios',\n   611→                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n   612→            )\n   613→        ];\n   614→\n   615→        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n   616→\n   617→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   618→            ->addSelect([\n   619→                DB::raw('\n   620→                    (\n   621→                        SELECT COUNT(DISTINCT eu.usuario_id)\n   622→                        FROM empresas_usuarios AS eu\n   623→                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n   624→                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n   625→                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n   626→                    ) AS conteo_total_usuarios_empresa_sucursales\n   627→                '),\n   628→                DB::raw('\n   629→                    (\n   630→                        SELECT COUNT(*)\n   631→                        FROM consumos\n   632→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   633→                        WHERE (\n   634→                            consumos.empresa_id = empresas_planes.empresa_id\n   635→                            OR suc.empresa_id = empresas_planes.empresa_id\n   636→                        )\n   637→                        AND consumos.agenda_id IS NOT NULL\n   638→                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n   639→                '),\n   640→                DB::raw('\n   641→                    (\n   642→                        SELECT COUNT(*)\n   643→                        FROM consumos\n   644→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   645→                        WHERE (\n   646→                            consumos.empresa_id = empresas_planes.empresa_id\n   647→                            OR suc.empresa_id = empresas_planes.empresa_id\n   648→                        )\n   649→                        AND consumos.oferta_laboral_id IS NOT NULL\n   650→                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n   651→                '),\n   652→            ])\n   653→            ->with([\n   654→                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n   655→                'plan.tipoPrueba:id,nombre',\n   656→                'pruebas:id,nombre,slug',\n   657→                'estado:id,nombre',\n   658→                'usuario:id,nombres,apellidos',\n   659→                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n   660→                    $consulta_empresa->select($campos_empresas)\n   661→                        ->whereNull('empresa_id')\n   662→                        ->withCount([\n   663→                            ...$matriz_conteos,\n   664→                            'sucursales as conteo_sucursales'\n   665→                        ])\n   666→                        ->with([\n   667→                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n   668→                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n   669→                            }\n   670→                        ]);\n   671→                }\n   672→            ])\n   673→            ->when(\n   674→                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n   675→                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n   676→            )\n   677→            ->whereNotIn('estado_id', [3, 8])\n   678→            ->when(\n   679→                $request->filled('prueba_id'),\n   680→                fn($consulta) => $consulta->whereHas(\n   681→                    'pruebas',\n   682→                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n   683→                )\n   684→            )\n   685→            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n   686→                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n   687→            })\n   688→            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n   689→                switch ($request->plan_por) {\n   690→                    case 'por unidades':\n   691→                        $consulta_plan_por->whereNotNull('unidades');\n   692→                        break;\n   693→\n   694→                    case 'por ofertas laborales':\n   695→                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n   696→                        break;\n   697→\n   698→                    case 'por tiempo':\n   699→                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n   700→                        break;\n   701→                }\n   702→            })\n   703→            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n   704→                $fecha_inicio = $request->fecha_vencimiento;\n   705→                $fecha_fin    = $request->fecha_vencimiento;\n   706→\n   707→                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n   708→                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n   709→                    $fecha_inicio = $fechas[0];\n   710→                    $fecha_fin    = $fechas[1];\n   711→                }\n   712→\n   713→                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n   714→            })\n   715→            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n   716→                $fecha_inicio = $request->fecha_inicio;\n   717→                $fecha_fin    = $request->fecha_inicio;\n   718→\n   719→                if (strpos($request->fecha_inicio, ' a ') !== false) {\n   720→                    $fechas       = explode(' a ', $request->fecha_inicio);\n   721→                    $fecha_inicio = $fechas[0];\n   722→                    $fecha_fin    = $fechas[1];\n   723→                }\n   724→\n   725→                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n   726→            })\n   727→            ->when(\n   728→                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   729→                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n   730→            )\n   731→            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n   732→                if ($request->tipo_activacion === 'compra') {\n   733→                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n   734→                        $subconsulta->select(DB::raw(1))\n   735→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   736→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   737→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   738→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   739→                    });\n   740→                } elseif ($request->tipo_activacion === 'recompra') {\n   741→                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n   742→                        $subconsulta->select(DB::raw(1))\n   743→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   744→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   745→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   746→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   747→                    });\n   748→                }\n   749→            })\n   750→            ->get();\n   751→    }\n   752→\n   753→    /**\n   754→     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n   755→     *\n   756→     * @param Request $request Contenido de la petición HTTP entrante.\n   757→     * @return Collection\n   758→     * @author Fahibram Cárcamo\n   759→     */\n   760→    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n   761→        return $this->modelo::select(\n   762→            'empresas_planes.id',\n   763→            'empresas_planes.empresa_id',\n   764→            'empresas_planes.plan_id',\n   765→            'empresas_planes.plan_credito_id',\n   766→            'empresas_planes.usuario_id',\n   767→            'empresas_planes.estado_id',\n   768→            'empresas_planes.unidades',\n   769→            'empresas_planes.cantidad_ofertas_laborales',\n   770→            'empresas_planes.cantidad_usuarios',\n   771→            'empresas_planes.cantidad_pruebas',\n   772→            'empresas_planes.creditos',\n   773→            'empresas_planes.fecha_inicio',\n   774→            'empresas_planes.fecha_vencimiento',\n   775→            'empresas_planes.precio',\n   776→            'empresas_planes.porcentaje_descuento',\n   777→            'empresas_planes.numero_factura',\n   778→            'empresas_planes.comentario',\n   779→            'empresas_planes.plan_original',\n   780→            'empresas_planes.renovando',\n   781→            'empresas_planes.por_facturar',\n   782→            'empresas_planes.created_at',\n   783→            'planes.id',\n   784→            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n   785→            'planes.nombre AS plan_nombre',\n   786→            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n   787→            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n   788→            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n   789→            'planes.unidades AS plan_unidades',\n   790→            'planes.vigencia AS plan_vigencia',\n   791→            'planes.precio AS plan_precio',\n   792→            'tipos_pruebas.id AS tipo_prueba_id',\n   793→            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n   794→            'estados_planes.id AS estado_plan_id',\n   795→            'estados_planes.nombre AS estado_plan_nombre',\n   796→            'users.id AS usuario_usuario_id',\n   797→            'users.nombres AS usuario_nombres',\n   798→            'users.apellidos AS usuario_apellidos',\n   799→            'empresas.id AS empresa_empresa_id',\n   800→            'empresas.empresa_id',\n   801→            'empresas.nombre_comercial AS empresa_nombre_comercial',\n   802→            'empresas.razon_social AS empresa_razon_social',\n   803→            'empresas.nombre_contacto',\n   804→            'empresas.celular_contacto',\n   805→            'empresas.email_contacto',\n   806→            'empresas.telefono_contacto',\n   807→            'empresas.extension_contacto',\n   808→            'empresas.nombre_tesorero',\n   809→            'empresas.celular_tesorero',\n   810→            'empresas.telefono_tesorero',\n   811→            'empresas.email_tesorero',\n   812→            DB::raw('\n   813→                (\n   814→                    SELECT COUNT(*)\n   815→                    FROM consumos\n   816→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n   817→                )\n   818→                AS conteo_consumos_agendas\n   819→            '),\n   820→            DB::raw('\n   821→                (\n   822→                    SELECT COUNT(*)\n   823→                    FROM consumos\n   824→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n   825→                )\n   826→                AS conteo_consumos_ofertas_laborales\n   827→            '),\n   828→            DB::raw('\n   829→                (\n   830→                    SELECT COUNT(*)\n   831→                    FROM empresas\n   832→                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n   833→                )\n   834→                AS conteo_sucursales\n   835→            '),\n   836→            DB::raw('\n   837→                (\n   838→                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n   839→                    FROM empresas AS sucursales\n   840→                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n   841→                )\n   842→                AS nombres_comerciales_sucursales\n   843→            ')\n   844→        )\n   845→        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n   846→        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n   847→        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n   848→        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n   849→        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n   850→        ->whereNull('empresas.empresa_id')\n   851→        ->when(\n   852→            $request->filled('plan_por'),\n   853→            function ($consulta) use ($request) {\n   854→                switch ($request->plan_por) {\n   855→                    case 'por unidades':\n   856→                        $consulta->whereNotNull('empresas_planes.unidades');\n   857→                        break;\n   858→\n   859→                    case 'por ofertas laborales':\n   860→                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n   861→                        break;\n   862→\n   863→                    case 'por tiempo':\n   864→                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n   865→                        break;\n   866→                }\n   867→            }\n   868→        )\n   869→        ->when(\n   870→            $request->filled('tipo_prueba_id'),\n   871→            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n   872→            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n   873→                TipoPrueba::SELECCION_ID,\n   874→                TipoPrueba::ORGANIZACIONAL_ID,\n   875→                TipoPrueba::VOCACIONAL_ID\n   876→            ])\n   877→        )\n   878→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n   879→        ->when(\n   880→            $request->filled('ejecutivo_id'),\n   881→            function ($consulta) use ($request) {\n   882→                $consulta->whereExists(function ($subconsulta) use ($request) {\n   883→                    $subconsulta->select(DB::raw(1))\n   884→                        ->from('empresas_usuarios')\n   885→                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n   886→                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n   887→                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n   888→                });\n   889→            }\n   890→        )\n   891→        ->when(\n   892→            $request->filled('fecha_vencimiento'),\n   893→            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n   894→        )\n   895→        ->when(\n   896→            $request->filled('fecha_inicio'),\n   897→            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n   898→        )\n   899→        ->when(\n   900→            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   901→            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n   902→        )\n   903→        ->get();\n   904→    }\n   905→\n   906→    /**\n   907→     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n   908→     *\n   909→     * @param int $empresa_id ID de la empresa.\n   910→     * @param Request $request Contenido de la peticion.\n   911→     * @return Collection\n   912→     * @author Sergio Vargas\n   913→     */\n   914→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   915→        return $this->modelo::select(\n   916→            'id',\n   917→            'empresa_id',\n   918→            'plan_credito_id',\n   919→            'estado_id',\n   920→            'creditos',\n   921→            'fecha_inicio',\n   922→            'fecha_vencimiento',\n   923→            'precio',\n   924→            'porcentaje_descuento',\n   925→            'numero_factura',\n   926→            'comentario',\n   927→            'created_at'\n   928→        )\n   929→        ->with([\n   930→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   931→            'estado:id,nombre',\n   932→            'archivos' => function ($archivos) {\n   933→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   934→                    ->orderBy('created_at', 'DESC');\n   935→            }\n   936→        ])\n   937→        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n   938→        ->where('empresa_id', $empresa_id)\n   939→        ->whereNotNull('plan_credito_id')\n   940→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n   941→        ->when(\n   942→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   943→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   944→        )\n   945→        ->when(\n   946→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   947→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   948→        )\n   949→        ->when(\n   950→            $request->filled('fecha_vencimiento_desde'),\n   951→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   952→        )\n   953→        ->when(\n   954→            $request->filled('fecha_vencimiento_hasta'),\n   955→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   956→        )\n   957→        ->when(\n   958→            $request->filled('fecha_inicio_desde'),\n   959→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   960→        )\n   961→        ->when(\n   962→            $request->filled('fecha_inicio_hasta'),\n   963→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   964→        )\n   965→        ->orderBy('created_at', 'DESC')\n   966→        ->get();\n   967→    }\n   968→}\n   969→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1232d72c-d4b2-4382-ba73-62fa4666f6a4","timestamp":"2026-01-25T01:46:13.822Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"40ef67e4-6643-4767-9a99-762c0aff1229","timestamp":"2026-01-25T01:46:13.872Z"}
{"parentUuid":"40ef67e4-6643-4767-9a99-762c0aff1229","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:17.481Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PoqFEcXniod19Qtx1ayVix","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JycRbnxUSU1BvR7hz8RUjW","name":"Bash","input":{"command":"grep -r \"obtenerPlanActivo\\|obtenerUltimoPorTipo\" \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\" --include=\"*.php\" | head -30"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":18006,"cache_read_input_tokens":33518,"cache_creation":{"ephemeral_5m_input_tokens":18006,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFZwTgY2MW8raeP92up","uuid":"048c565b-8d49-4d1f-9212-3e67bd5ead44"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"122e3743-af77-466b-a9ca-be8c26068c5d","timestamp":"2026-01-25T01:46:17.523Z"}
{"parentUuid":"122e3743-af77-466b-a9ca-be8c26068c5d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JycRbnxUSU1BvR7hz8RUjW","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Controllers/Planes/PlanController.php:            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Controllers/Planes/PlanController.php:                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Services/Empresas/EmpresaPlanService.php:    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Services/Empresas/EmpresaPlanService.php:    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Services/Empresas/EmpresaService.php:                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http/Services/Empresas/EmpresaService.php:                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);","is_error":false}]},"uuid":"86cbb971-ed8c-4860-b750-41c25f9c94d0","timestamp":"2026-01-25T01:46:18.740Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"d03bed16-31f1-42f8-9aeb-8e7e66f017ed","timestamp":"2026-01-25T01:46:18.797Z"}
{"parentUuid":"d03bed16-31f1-42f8-9aeb-8e7e66f017ed","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:20.813Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QC5zf7DEaXiGQKeQ1BFrqA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AE1gCFT9LdAqKnGw4nm9qE","name":"Grep","input":{"pattern":"obtenerPlanActivo|obtenerUltimoPorTipo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","output_mode":"content","context":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":624,"cache_read_input_tokens":51524,"cache_creation":{"ephemeral_5m_input_tokens":624,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFaJ7ek8C8H9FT2KVNS","uuid":"ec986eea-fc3d-450b-b7a5-f43692f99079"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"02e4e8e2-d8a6-4067-a1a9-206338e80588","timestamp":"2026-01-25T01:46:20.855Z"}
{"parentUuid":"02e4e8e2-d8a6-4067-a1a9-206338e80588","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>InputValidationError: Grep failed due to the following issue:\nAn unexpected parameter `context` was provided</tool_use_error>","is_error":true,"tool_use_id":"toolu_01AE1gCFT9LdAqKnGw4nm9qE"}]},"uuid":"39a7a3b7-9390-498c-9699-10ad6d177ebf","timestamp":"2026-01-25T01:46:20.858Z","toolUseResult":"InputValidationError: [\n  {\n    \"code\": \"unrecognized_keys\",\n    \"keys\": [\n      \"context\"\n    ],\n    \"path\": [],\n    \"message\": \"Unrecognized key: \\\"context\\\"\"\n  }\n]"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"dfe92e8f-162d-44ec-b5c7-be1bf6ff8542","timestamp":"2026-01-25T01:46:20.913Z"}
{"parentUuid":"dfe92e8f-162d-44ec-b5c7-be1bf6ff8542","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:23.037Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01LKnSyi55AZBZA6vHvT4kV6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01R1DUDRPMbG69WYSCswGv7W","name":"Grep","input":{"pattern":"obtenerPlanActivo|obtenerUltimoPorTipo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","output_mode":"content","-B":10,"-A":10}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":514,"cache_read_input_tokens":52148,"cache_creation":{"ephemeral_5m_input_tokens":514,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFaTDLempTfFPvXkSE1","uuid":"3e55d78d-29ca-4bba-a8b9-28dfb77afab1"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"2f9de8f6-596e-44a7-9703-055d6121aea8","timestamp":"2026-01-25T01:46:23.077Z"}
{"parentUuid":"2f9de8f6-596e-44a7-9703-055d6121aea8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01R1DUDRPMbG69WYSCswGv7W","type":"tool_result","content":"101-     * @author Jair Carvajal\n102-     */\n103-    public function getUno(int $id): ?Empresa {\n104-        $empresa = $this->repositorio->getUnoBasico($id);\n105-\n106-        if (!is_null($empresa)) {\n107-            $planes        = [];\n108-            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n109-\n110-            foreach ($tipos_pruebas as $tipo_prueba) {\n111:                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n112:                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n113-\n114-                if (!is_null($plan)) {\n115-                    array_push($planes, $plan);\n116-                }\n117-            }\n118-\n119-            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n120-                'empresa_id'         => $id,\n121-                'con_relaciones'     => true,\n122-                'validar_relaciones' => true,"}]},"uuid":"5ac05fc0-ca38-4b40-9e76-95dba62f0534","timestamp":"2026-01-25T01:46:24.925Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_0154KEMTsTHAt3gFABaEm7cU","uuid":"85976c7b-9d82-4e33-b8b9-0c1090e97e60","timestamp":"2026-01-25T01:46:24.975Z"}
{"parentUuid":"94edd578-1235-4014-bfe1-dd4870c24d6a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0154KEMTsTHAt3gFABaEm7cU","type":"tool_result","content":[{"type":"text","text":"Perfecto. Ahora voy a crear un reporte completo con el análisis de las consultas. Déjame crear un documento de resumen:\n\n## Resumen de Hallazgos: Cómo se cargan los planes en \"/planes-clientes\"\n\nHe encontrado exactamente cómo funciona el sistema para cargar todos los planes correctamente. Aquí está el análisis completo:\n\n### 1. **RUTA EN ROUTES/WEB.PHP**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php`\n\n```\nLínea 216: $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n```\n\n### 2. **CONTROLADOR: PlanController**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php`\n\n**Método: `planesClientes()` (líneas 356-395)**\n\n```php\npublic function planesClientes(): View {\n    $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n    $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n    $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n    $empresas   = clone $sucursales;\n    $empresas->push($empresa);\n    $empresas_ids = array_column($empresas->toArray(), 'id');\n\n    $planes        = [];\n    $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n    // AQUÍ ESTÁ LA CLAVE - ITERA POR CADA TIPO DE PRUEBA\n    foreach ($tipos_pruebas as $tipo_prueba) {\n        $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n            ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n\n        if (!is_null($plan)) {\n            array_push($planes, $plan);\n        }\n    }\n\n    $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n        new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n        $empresa\n    );\n\n    return view('empresa.paginas.planes.planes')->with([\n        'empresa'          => $empresa,\n        'usuario_id'       => Auth::id(),\n        'sucursales'       => $empresas,\n        'planes'           => $planes,  // <-- AQUÍ SE PASAN LOS PLANES A LA VISTA\n        // ... más datos\n    ]);\n}\n```\n\n### 3. **SERVICIO: EmpresaPlanService**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php`\n\n**Método 1: `obtenerPlanActivo()` (líneas 534-542)**\n\n```php\npublic function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n    $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n    if (!is_null($plan)) {\n        $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n    }\n\n    return $plan;\n}\n```\n\n**Método 2: `obtenerUltimoPorTipo()` (líneas 494-508)**\n\n```php\npublic function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n    $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n        'empresa_id'             => $empresa_id,\n        'tipo_prueba_id'         => $tipo_prueba_id,\n        'excluir_estado_proximo' => true\n    ]));\n\n    if (!is_null($plan)) {\n        $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n        $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n    }\n\n    return $plan;\n}\n```\n\n### 4. **REPOSITORIO: EmpresaPlanRepository - LAS CONSULTAS CLAVE**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php`\n\n#### **Consulta A: `planActivo()` (líneas 431-456)**\n```php\npublic function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n    return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', ...)\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])  // <-- ESTADOS: 1 = ACTIVO, 4 = POR_VENCER\n        ->first();\n}\n```\n\n#### **Consulta B: `ultimoPlanAsignado()` (líneas 497-529)**\n```php\npublic function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n    return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', ...)\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);  // <-- EXCLUYE ESTADO 3 (PROXIMO)\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n}\n```\n\n### 5. **LA DIFERENCIA CRÍTICA - POR QUÉ AQUÍ SÍ SE MUESTRAN TODOS**\n\nEl método `planesClientes()` muestra **todos los planes correctamente (3 de créditos + 1 de selección)** porque:\n\n1. **Itera por CADA tipo de prueba** (línea 367):\n   ```php\n   foreach ($tipos_pruebas as $tipo_prueba) {\n       $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n           ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n       \n       if (!is_null($plan)) {\n           array_push($planes, $plan);\n       }\n   }\n   ```\n\n2. **Busca en dos formas secuenciales**:\n   - **Primera búsqueda**: `obtenerPlanActivo()` - busca planes con estado 1 (ACTIVO) o 4 (POR_VENCER)\n   - **Segunda búsqueda (fallback)**: `obtenerUltimoPorTipo()` - busca el ÚLTIMO plan que NO sea estado 3 (PRÓXIMO)\n\n3. **Las consultas incluyen AMBOS tipos de planes**:\n   - Planes de **selección** (contienen `plan_id`)\n   - Planes de **créditos** (contienen `plan_credito_id`)\n\n### 6. **COMPARACIÓN CON OTROS LUGARES**\n\nEl mismo patrón se usa en `EmpresaService::getUno()` (líneas 111-112), que también carga todos los planes correctamente:\n\n```php\nforeach ($tipos_pruebas as $tipo_prueba) {\n    $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n        ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n    if (!is_null($plan)) {\n        array_push($planes, $plan);\n    }\n}\n```\n\n### 7. **CONDICIONES DE FILTRADO EN LAS CONSULTAS**\n\n**En `planActivo()` (línea 454)**:\n```php\n->whereIn('estado_id', [1, 4])  // ACTIVO, POR_VENCER\n```\n\n**En `ultimoPlanAsignado()` (línea 520)**:\n```php\n->where('estado_id', '!=', 3)  // Excluye PRÓXIMO\n```\n\nEsto significa que obtiene planes en estados: 1, 2, 4, 5, 6 (cualquiera excepto PRÓXIMO = 3)\n\n---\n\n## CONCLUSIÓN\n\nLa vista **\"/planes-clientes\" muestra todos los planes correctamente** porque:\n\n1. Itera explícitamente sobre **cada tipo de prueba** en la base de datos\n2. Para cada tipo, busca primero un plan **ACTIVO**, luego el **ÚLTIMO PLAN** de ese tipo\n3. Las consultas del repositorio están diseñadas para traer:\n   - Planes de **selección** (con plan_id)\n   - Planes de **créditos** (con plan_credito_id)\n4. Ambas consultas usan lógica de `whereHas` que no discrimina entre tipos de planes\n\n**Si hay otros lugares donde NO se muestran todos los planes, probablemente es porque:**\n- No iteran por cada tipo de prueba\n- Filtran por un `plan_id` o `plan_credito_id` específico\n- Usan una consulta diferente sin el fallback de `obtenerUltimoPorTipo()`"},{"type":"text","text":"agentId: a5b6fcc (for resuming to continue this agent's work if needed)"}]}]},"uuid":"95f2ea85-6d99-4516-a3f0-4f6043362fd6","timestamp":"2026-01-25T01:46:47.386Z","toolUseResult":{"status":"completed","prompt":"Necesito encontrar cómo se cargan los planes en la vista de empresa \"/planes-clientes\" donde SÍ se muestran todos los planes correctamente (3 de créditos y 1 de selección).\n\nBusca:\n1. La ruta en routes/web.php que maneja \"planes-clientes\"\n2. El controlador que maneja esta ruta\n3. El método que carga los planes\n4. La consulta específica que obtiene los planes de la empresa\n\nNecesito entender qué diferencia hay en la consulta que hace que aquí sí se muestren todos los planes.","agentId":"a5b6fcc","content":[{"type":"text","text":"Perfecto. Ahora voy a crear un reporte completo con el análisis de las consultas. Déjame crear un documento de resumen:\n\n## Resumen de Hallazgos: Cómo se cargan los planes en \"/planes-clientes\"\n\nHe encontrado exactamente cómo funciona el sistema para cargar todos los planes correctamente. Aquí está el análisis completo:\n\n### 1. **RUTA EN ROUTES/WEB.PHP**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php`\n\n```\nLínea 216: $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n```\n\n### 2. **CONTROLADOR: PlanController**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php`\n\n**Método: `planesClientes()` (líneas 356-395)**\n\n```php\npublic function planesClientes(): View {\n    $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n    $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n    $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n    $empresas   = clone $sucursales;\n    $empresas->push($empresa);\n    $empresas_ids = array_column($empresas->toArray(), 'id');\n\n    $planes        = [];\n    $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n    // AQUÍ ESTÁ LA CLAVE - ITERA POR CADA TIPO DE PRUEBA\n    foreach ($tipos_pruebas as $tipo_prueba) {\n        $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n            ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n\n        if (!is_null($plan)) {\n            array_push($planes, $plan);\n        }\n    }\n\n    $usuarios = $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n        new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n        $empresa\n    );\n\n    return view('empresa.paginas.planes.planes')->with([\n        'empresa'          => $empresa,\n        'usuario_id'       => Auth::id(),\n        'sucursales'       => $empresas,\n        'planes'           => $planes,  // <-- AQUÍ SE PASAN LOS PLANES A LA VISTA\n        // ... más datos\n    ]);\n}\n```\n\n### 3. **SERVICIO: EmpresaPlanService**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php`\n\n**Método 1: `obtenerPlanActivo()` (líneas 534-542)**\n\n```php\npublic function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n    $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n    if (!is_null($plan)) {\n        $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n    }\n\n    return $plan;\n}\n```\n\n**Método 2: `obtenerUltimoPorTipo()` (líneas 494-508)**\n\n```php\npublic function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n    $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n        'empresa_id'             => $empresa_id,\n        'tipo_prueba_id'         => $tipo_prueba_id,\n        'excluir_estado_proximo' => true\n    ]));\n\n    if (!is_null($plan)) {\n        $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n        $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n    }\n\n    return $plan;\n}\n```\n\n### 4. **REPOSITORIO: EmpresaPlanRepository - LAS CONSULTAS CLAVE**\nArchivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php`\n\n#### **Consulta A: `planActivo()` (líneas 431-456)**\n```php\npublic function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n    return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', ...)\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])  // <-- ESTADOS: 1 = ACTIVO, 4 = POR_VENCER\n        ->first();\n}\n```\n\n#### **Consulta B: `ultimoPlanAsignado()` (líneas 497-529)**\n```php\npublic function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n    return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', ...)\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);  // <-- EXCLUYE ESTADO 3 (PROXIMO)\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n}\n```\n\n### 5. **LA DIFERENCIA CRÍTICA - POR QUÉ AQUÍ SÍ SE MUESTRAN TODOS**\n\nEl método `planesClientes()` muestra **todos los planes correctamente (3 de créditos + 1 de selección)** porque:\n\n1. **Itera por CADA tipo de prueba** (línea 367):\n   ```php\n   foreach ($tipos_pruebas as $tipo_prueba) {\n       $plan = $this->empresa_plan_servicio->obtenerPlanActivo($empresa_id, $tipo_prueba->id)\n           ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($empresa_id, $tipo_prueba->id);\n       \n       if (!is_null($plan)) {\n           array_push($planes, $plan);\n       }\n   }\n   ```\n\n2. **Busca en dos formas secuenciales**:\n   - **Primera búsqueda**: `obtenerPlanActivo()` - busca planes con estado 1 (ACTIVO) o 4 (POR_VENCER)\n   - **Segunda búsqueda (fallback)**: `obtenerUltimoPorTipo()` - busca el ÚLTIMO plan que NO sea estado 3 (PRÓXIMO)\n\n3. **Las consultas incluyen AMBOS tipos de planes**:\n   - Planes de **selección** (contienen `plan_id`)\n   - Planes de **créditos** (contienen `plan_credito_id`)\n\n### 6. **COMPARACIÓN CON OTROS LUGARES**\n\nEl mismo patrón se usa en `EmpresaService::getUno()` (líneas 111-112), que también carga todos los planes correctamente:\n\n```php\nforeach ($tipos_pruebas as $tipo_prueba) {\n    $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n        ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n    if (!is_null($plan)) {\n        array_push($planes, $plan);\n    }\n}\n```\n\n### 7. **CONDICIONES DE FILTRADO EN LAS CONSULTAS**\n\n**En `planActivo()` (línea 454)**:\n```php\n->whereIn('estado_id', [1, 4])  // ACTIVO, POR_VENCER\n```\n\n**En `ultimoPlanAsignado()` (línea 520)**:\n```php\n->where('estado_id', '!=', 3)  // Excluye PRÓXIMO\n```\n\nEsto significa que obtiene planes en estados: 1, 2, 4, 5, 6 (cualquiera excepto PRÓXIMO = 3)\n\n---\n\n## CONCLUSIÓN\n\nLa vista **\"/planes-clientes\" muestra todos los planes correctamente** porque:\n\n1. Itera explícitamente sobre **cada tipo de prueba** en la base de datos\n2. Para cada tipo, busca primero un plan **ACTIVO**, luego el **ÚLTIMO PLAN** de ese tipo\n3. Las consultas del repositorio están diseñadas para traer:\n   - Planes de **selección** (con plan_id)\n   - Planes de **créditos** (con plan_credito_id)\n4. Ambas consultas usan lógica de `whereHas` que no discrimina entre tipos de planes\n\n**Si hay otros lugares donde NO se muestran todos los planes, probablemente es porque:**\n- No iteran por cada tipo de prueba\n- Filtran por un `plan_id` o `plan_credito_id` específico\n- Usan una consulta diferente sin el fallback de `obtenerUltimoPorTipo()`"}],"totalDurationMs":63331,"totalTokens":53198,"totalToolUseCount":9,"usage":{"input_tokens":0,"cache_creation_input_tokens":534,"cache_read_input_tokens":52662,"cache_creation":{"ephemeral_5m_input_tokens":534,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"sourceToolAssistantUUID":"94edd578-1235-4014-bfe1-dd4870c24d6a"}
{"parentUuid":"95f2ea85-6d99-4516-a3f0-4f6043362fd6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DGLqg73yS8DHYvZW8xw5u1","type":"tool_result","content":"./routes/web.php","is_error":false}]},"uuid":"b8e1ebd6-e67b-4e7f-994f-d06aca61f1f7","timestamp":"2026-01-25T01:46:51.511Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"bab417d6-c649-4f44-a0cb-2e8311fa99fe","timestamp":"2026-01-25T01:46:51.576Z"}
{"parentUuid":"bab417d6-c649-4f44-a0cb-2e8311fa99fe","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:53.346Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011wWbeUFPQp3D45x7uuoHbQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EQuhPQ8pW1msKHoSvfyjg1","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && find ./resources/views -name \"gestionar.blade.php\" -type f"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":464,"cache_read_input_tokens":27134,"cache_creation":{"ephemeral_5m_input_tokens":464,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFciFH3ancg8cVjywKj","uuid":"f168f041-a331-4b65-8f99-f3e3dde80a2e"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"cf6a0536-7031-4fbd-98e7-545e599752d5","timestamp":"2026-01-25T01:46:53.382Z"}
{"parentUuid":"cf6a0536-7031-4fbd-98e7-545e599752d5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EQuhPQ8pW1msKHoSvfyjg1","type":"tool_result","content":"./resources/views/empresa/paginas/sucursales/gestionar.blade.php\n./resources/views/empresas/paginas/gestionar.blade.php","is_error":false}]},"uuid":"c6ada668-04b6-4b8c-94f1-0b73e74bddc7","timestamp":"2026-01-25T01:46:54.425Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"5a38c023-033b-490c-9905-7559bfde117b","timestamp":"2026-01-25T01:46:54.473Z"}
{"parentUuid":"5a38c023-033b-490c-9905-7559bfde117b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:46:56.321Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QpHozD6WDaWfKgtyVrbwTq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DtTJ4aAN1Kb8m3kYaWttBP","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresas\\paginas\\gestionar.blade.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":323,"cache_read_input_tokens":27598,"cache_creation":{"ephemeral_5m_input_tokens":323,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFcvZwjYEhKwFFhhPm5","uuid":"3d66f711-0974-4b21-aee3-2cde7ab1a72f"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"dd07d41d-6153-4cc8-9c18-2474ce5fc09c","timestamp":"2026-01-25T01:46:56.356Z"}
{"parentUuid":"dd07d41d-6153-4cc8-9c18-2474ce5fc09c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DtTJ4aAN1Kb8m3kYaWttBP","type":"tool_result","content":"     1→@extends('layouts.app')\n     2→\n     3→@section('titulo', 'Gestionar empresa')\n     4→\n     5→@section('estilos')\n     6→    <link href=\"{{ asset('css/empresas/gestionar.css') }}\" rel=\"stylesheet\">\n     7→@endsection\n     8→\n     9→@section('contenido')\n    10→    ${contenedorPrincipal({\n    11→        cabecera: `\n    12→            <div class=\"col-12\">\n    13→                <h1 class=\"text-headline-2 fw-semibold\">Empresas</h1>\n    14→            </div>\n    15→        `,\n    16→        contenido: `\n    17→            <div class=\"card\">\n    18→                @include('componentes.menu-superior', ['rutas' => $rutas_menu->where('slug', 'empresas')->first()?->rutas, 'activo' => 'gestionar-empresas'])\n    19→                <div class=\"card-body\">\n    20→                    <div class=\"container-fluid mt-4\">\n    21→                        <div class=\"row\">\n    22→                            <div class=\"col-12 col-lg-3\">\n    23→                                ${crearSelect2({\n    24→                                    id: 'filtro_empresa_id',\n    25→                                    name: 'filtro_empresa_id',\n    26→                                    opciones: [],\n    27→                                    label: 'Empresa',\n    28→                                    onchange: 'obtenerDatosGestionarEmpresa(this.value);'\n    29→                                })}\n    30→                            </div>\n    31→                            <div class=\"col-12 col-lg-3\">\n    32→                                ${crearSelect2({\n    33→                                    id: 'filtro_sucursal_id',\n    34→                                    name: 'sucursal_id',\n    35→                                    opciones: [],\n    36→                                    label: 'Sucursal',\n    37→                                    onchange: 'obtenerDatosGestionarEmpresa(this.value);'\n    38→                                })}\n    39→                            </div>\n    40→                        </div>\n    41→                    </div>\n    42→                    <div class=\"card d-none\" id=\"tabs-empresa\">\n    43→                        <div class=\"row\">\n    44→                            ${crearTabsHorizontal({\n    45→                                id: 'pestanas-principales',\n    46→                                tabs: [\n    47→                                    {\n    48→                                        id: 'pestana-datos',\n    49→                                        titulo: `Datos de empresa`,\n    50→                                        contenido: `@include('empresas.paginas.formularios-gestionar.datos-empresa')`,\n    51→                                        activo: {{ $submenu_vista == null ? 'true' : 'false' }}\n    52→                                    },\n    53→                                    {\n    54→                                        id: 'pestana-planes',\n    55→                                        titulo: `Planes`,\n    56→                                        contenido: `@include('empresas.paginas.formularios-gestionar.planes')`,\n    57→                                        activo: {{ $submenu_vista == 'planes' ? 'true' : 'false' }}\n    58→                                    },\n    59→                                    {\n    60→                                        id: 'pestana-usuarios',\n    61→                                        titulo: `Usuarios`,\n    62→                                        contenido: `@include('empresas.paginas.formularios-gestionar.usuarios')`,\n    63→                                        activo: {{ $submenu_vista == 'usuarios' ? 'true' : 'false' }}\n    64→                                    },\n    65→                                    {\n    66→                                        id: 'pestana-configuraciones',\n    67→                                        titulo: `Configuraciones`,\n    68→                                        contenido: `@include('empresas.paginas.formularios-gestionar.configuraciones')`,\n    69→                                        activo: {{ $submenu_vista == 'configuraciones' ? 'true' : 'false' }}\n    70→                                    }\n    71→                                ]\n    72→                            })}\n    73→                        </div>\n    74→                    </div>\n    75→                </div>\n    76→            </div>\n    77→        `\n    78→    })}\n    79→    @section('modals')\n    80→        @include('empresas.secciones.modal-generar-enlace', ['renovar' => true])\n    81→        ${crearModal({\n    82→            id: 'modal-historial-recompras',\n    83→            dialog_class: 'modal-dialog-centered modal-xl',\n    84→            titulo_header: 'Historial de recompras - <span id=\"nombre-tipo-prueba\"></span>',\n    85→            modal_body: `\n    86→                <div class=\"col-12 px-3\">\n    87→                    <div class=\"row\">\n    88→                        <div class=\"col-12\">\n    89→                            <p>Aquí puedes ver un registro detallado de las recompras realizadas.</p>\n    90→                        </div>\n    91→                    </div>\n    92→                    <div class=\"row mt-5\">\n    93→                        <div class=\"col-12\">\n    94→                            ${crearTabla({\n    95→                                id: 'tabla-historial-recompras',\n    96→                                url: '{{ \"/planes-historial-recompras\" }}',\n    97→                                class: 'p-0 table-borderless',\n    98→                                registros_paginas: true,\n    99→                                input_container_class: 'mb-0',\n   100→                                issubtabla: '.desplegarSubRow',\n   101→                                buscador: {\n   102→                                    icono: '<i class=\"bi bi-search input-icono1\"></i>'\n   103→                                },\n   104→                                botones_class: 'justify-content-end',\n   105→                                botones: `\n   106→                                    <div class=\"col-auto my-md-auto my-2\">\n   107→                                        ${crearBoton({\n   108→                                            id: 'boton-descargar-historial-recompras',\n   109→                                            clases: 'btn-green-excel',\n   110→                                            texto: '<img class=\"me-3\" src=\"{{ asset('/iconos/excel_icon.svg') }}\"> Exportar todo',\n   111→                                        })}\n   112→                                    </div>\n   113→                                `\n   114→                            })}\n   115→                        </div>\n   116→                    </div>\n   117→                </div>\n   118→            `\n   119→        })}\n   120→        ${crearModal({\n   121→            id: 'modal-historial-recompras-creditos',\n   122→            dialog_class: 'modal-dialog-centered modal-xl',\n   123→            titulo_header: 'Historial de recompras - Créditos IA',\n   124→            modal_body: `\n   125→                <div class=\"col-12 px-3\">\n   126→                    <div class=\"row\">\n   127→                        <div class=\"col-12\">\n   128→                            <p>Aquí puedes ver un registro detallado de las compras de créditos IA.</p>\n   129→                        </div>\n   130→                    </div>\n   131→                    <div class=\"col-12 mt-3\" id=\"contenedor-tabla-historial-recompras-creditos\"></div>\n   132→                </div>\n   133→            `\n   134→        })}\n   135→        ${crearModal({\n   136→            id: 'modal-historial-cambios-usuario',\n   137→            dialog_class: 'modal-dialog-centered modal-xl',\n   138→            titulo_header: 'Historial de cambios - cliente',\n   139→            modal_body: `\n   140→                <div class=\"col-12 px-3\">\n   141→                    <div class=\"row\">\n   142→                        <div class=\"col-12\">\n   143→                            <p>Aquí puedes ver un registro detallado de las acciones que ha realizado este usuario, al descargar los datos tendrás información\n   144→                                del navegador e IP de estos cambios.</p>\n   145→                        </div>\n   146→                        <div class=\"col-12\">\n   147→                            <p class=\"mb-0\"><span class=\"text-body-2\">Usuario:</span>&nbsp;<span id=\"historial-usuario-nombre\"></span></p>\n   148→                        </div>\n   149→                    </div>\n   150→                    <div class=\"row mt-5\">\n   151→                        <div class=\"col-12\">\n   152→                            ${crearTabla({\n   153→                                id: 'tabla-historial-cambios-usuario',\n   154→                                url: '',\n   155→                                class: 'p-0 table-borderless',\n   156→                                registros_paginas: true,\n   157→                                input_container_class: 'mb-0',\n   158→                                buscador: {\n   159→                                    icono: '<i class=\"bi bi-search input-icono1\"></i>',\n   160→                                    icono3: '<i class=\"bi bi-filter input-icono3 pointer\" onclick=\"abrirModalFiltrosAvanzados()\"></i>'\n   161→                                },\n   162→                                botones: `\n   163→                                    <div class=\"col-auto\">\n   164→                                        ${crearBoton({\n   165→                                            id: 'boton-descargar-historial-cambios-usuario',\n   166→                                            clases: 'btn-green-excel',\n   167→                                            texto: '<img class=\"me-3\" src=\"{{ asset('/iconos/excel_icon.svg') }}\"> Exportar todo',\n   168→                                        })}\n   169→                                    </div>\n   170→                                `\n   171→                            })}\n   172→                        </div>\n   173→                    </div>\n   174→                </div>\n   175→            `\n   176→        })}\n   177→        ${crearModal({\n   178→            id: 'modal-filtros-avanzados',\n   179→            adiconales_modals_header: 'data-bs-backdrop=\"static\" tabindex=\"-1\" aria-labelledby=\"modal-filtros-avanzadosLabel\" aria-hidden=\"true\"',\n   180→            dialog_class: 'modal-md',\n   181→            titulo_header: 'Filtros avanzados',\n   182→            modal_body: `\n   183→                <div class=\"row w-100 mx-0\">\n   184→                    <div class=\"col-4 pt-2\">\n   185→                        Tipo de acción:\n   186→                    </div>\n   187→                    <div class=\"col-8\">\n   188→                        ${crearSelect2({\n   189→                            id: 'filtro_tipo_accion',\n   190→                            name: 'filtro_tipo_accion',\n   191→                            class: 'select2-filtro',\n   192→                            value: '',\n   193→                            opciones: [\n   194→                                { nombre: 'Todas', id: '' },\n   195→                                { nombre: 'Creación', id: 'created' },\n   196→                                { nombre: 'Edición', id: 'updated' },\n   197→                                { nombre: 'Eliminación', id: 'deleted' }\n   198→                            ],\n   199→                            input_container_class: 'mb-4'\n   200→                        })}\n   201→                    </div>\n   202→                    <div class=\"col-4 pt-2\">\n   203→                        Fecha:\n   204→                    </div>\n   205→                    <div class=\"col-8\">\n   206→                        ${crearDatePicker({\n   207→                            id: 'filtro_fecha_hora',\n   208→                            name: 'filtro_fecha_hora',\n   209→                            class: 'flatpickr-range bg-transparent',\n   210→                            placeholder: 'Desde - Hasta',\n   211→                            input_container_class: 'mb-3',\n   212→                            icono2: '<i class=\"bi bi-calendar input-icono2 pointer\"></i>'\n   213→                        })}\n   214→                    </div>\n   215→                </div>\n   216→                <div class=\"col-12 px-4 mb-4 mt-3\">\n   217→                    <div class=\"row m-0 w-100\">\n   218→                        ${crearBoton({\n   219→                            texto: 'Borrar filtros',\n   220→                            clases: 'col btn-outline-primary me-1 pt-2 text-center d-block',\n   221→                            onclick: 'borrarFiltrosAvanzados();',\n   222→                            adicional: 'data-bs-dismiss=\"modal\" aria-label=\"Close\"'\n   223→                        })}\n   224→                        ${crearBoton({\n   225→                            id: 'boton-estoy-seguro',\n   226→                            texto: 'Aplicar filtros',\n   227→                            clases: 'col btn-primary ms-1 pt-2 text-center d-block',\n   228→                            onclick: 'aplicarFiltrosAvanzados();'\n   229→                        })}\n   230→                    </div>\n   231→                </div>\n   232→            `\n   233→        })}\n   234→        ${crearModal({\n   235→            id: 'modal-confirmar-eliminacion',\n   236→            titulo_header: '¿Eliminar?',\n   237→            modal_body: `\n   238→                <div class=\"col-12\">\n   239→                    <p>¿Estás seguro? <span id=\"nombre-confirmar-eliminacion\"></span></p>\n   240→                </div>\n   241→            `,\n   242→            boton_footer1: {\n   243→                texto: 'Cancelar',\n   244→                class: 'btn-outline-primary pt-2',\n   245→                cerrar_modal: true\n   246→            },\n   247→            boton_footer2: {\n   248→                texto: 'Eliminar',\n   249→                class: 'btn-danger pt-2',\n   250→                onclick: 'confirmarEliminarUsuarios();'\n   251→            }\n   252→        })}\n   253→        ${crearModal({\n   254→            id: 'modal-detalle-plan-creditos',\n   255→            adiconales_modals_header: 'tabindex=\"-1\"',\n   256→            dialog_class: 'modal-dialog-centered modal-md',\n   257→            titulo_header: 'Detalle del plan - Créditos',\n   258→            modal_body_class: 'px-0 pb-6 pt-0',\n   259→            modal_body: `\n   260→                <div class=\"col-12\">\n   261→                    <div class=\"row align-items-center mt-3 mb-6\">\n   262→                        <div class=\"col-auto text-headline-6\">\n   263→                            <img width=\"24\" src=\"{{ asset('/imagenes/plantilla/corona.png') }}\">\n   264→                        </div>\n   265→                        <div class=\"col-auto text-headline-6\">\n   266→                            Paquete\n   267→                        </div>\n   268→                        <div class=\"col text-headline-5 text-end\" id=\"nombre-plan-creditos\"></div>\n   269→                    </div>\n   270→                    <div class=\"row align-items-center mt-3 mb-6\">\n   271→                        <div class=\"col-auto text-headline-6\">\n   272→                            <img width=\"24\" src=\"{{ asset('/iconos/icono_ia.svg') }}\">\n   273→                        </div>\n   274→                        <div class=\"col-auto text-headline-6\">\n   275→                            Créditos del plan\n   276→                        </div>\n   277→                        <div class=\"col text-headline-5 text-end\" id=\"unidades-plan-creditos\"></div>\n   278→                    </div>\n   279→                    <div class=\"row mt-3\">\n   280→                        <div class=\"col-12\">\n   281→                            ${crearBoton({\n   282→                                texto: '<i class=\"bi bi-eye me-2 text-white\"></i> Ver consumo',\n   283→                                clases: 'btn-primary w-100 text-center pt-2 d-block',\n   284→                                onclick: 'verConsumoCreditos()'\n   285→                            })}\n   286→                        </div>\n   287→                    </div>\n   288→                </div>\n   289→            `\n   290→        })}\n   291→        ${crearModal({\n   292→            id: 'modal-detalle-consumo-creditos',\n   293→            adiconales_modals_header: 'tabindex=\"-1\"',\n   294→            dialog_class: 'modal-dialog-centered modal-xl',\n   295→            titulo_header: 'Consumo del plan de créditos',\n   296→            modal_body_class: 'px-0 pb-6 pt-0',\n   297→            modal_body: `\n   298→                <div class=\"col-12 mt-3\" id=\"contenedor-tabla-detalle-consumo-creditos\"></div>\n   299→                <div class=\"col-12 mt-10\">\n   300→                    ${crearBoton({\n   301→                        texto: 'Descargar',\n   302→                        clases: 'btn-outline-primary w-100 text-center pt-2 d-block',\n   303→                        onclick: 'descargarExcelHistorialCreditos()'\n   304→                    })}\n   305→                </div>\n   306→            `\n   307→        })}\n   308→        @include('consumos.modal-consumos-empresa-plan')\n   309→    @endsection\n   310→@endsection\n   311→\n   312→@section('scripts')\n   313→    <script type=\"text/javascript\">\n   314→        let vista = 'gestionar';\n   315→        $(document).ready(function () {\n   316→            @if(isset($empresa))\n   317→                obtenerDatosGestionarEmpresa({{ $empresa->id }});\n   318→            @endif\n   319→        });\n   320→    </script>\n   321→    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css\" rel=\"stylesheet\">\n   322→    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js\"></script>\n   323→    <script src=\"{{ asset('js/consumos/modal-consumos-empresa-plan.js') }}\" type=\"text/javascript\"></script>\n   324→    <script src=\"{{ asset('js/empresas/empresas.js') }}\" type=\"text/javascript\"></script>\n   325→    <script src=\"{{ asset('js/empresas/usuarios.js') }}\" type=\"text/javascript\"></script>\n   326→@endsection\n   327→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"12af6c99-4d67-41d0-9e18-255a3e77cb7b","timestamp":"2026-01-25T01:46:57.322Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"fb6a3277-1593-4dd3-a915-6b672b16910f","timestamp":"2026-01-25T01:46:57.373Z"}
{"parentUuid":"fb6a3277-1593-4dd3-a915-6b672b16910f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:47:00.249Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01R5wLPS3TUStaHTwGuEDr4q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SCJX2eF8i7aMox7Qm39brp","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresas\\paginas\\formularios-gestionar\\planes.blade.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":5346,"cache_read_input_tokens":27921,"cache_creation":{"ephemeral_5m_input_tokens":5346,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFd9Ps2VA8Jin8bHSh1","uuid":"c8c2594d-7ff9-41b9-9ef8-64eac52b428f"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"fd3d1907-8bbd-4a18-a372-f93badef371f","timestamp":"2026-01-25T01:47:00.284Z"}
{"parentUuid":"fd3d1907-8bbd-4a18-a372-f93badef371f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SCJX2eF8i7aMox7Qm39brp","type":"tool_result","content":"     1→<div class=\"row mx-0 px-3 mt-4\" id=\"fila-cabecera-tabla-planes\">\n     2→    <div class=\"col-3\">\n     3→        <div class=\"input-container input-icon mb-0\" id=\"input-busqueda\">\n     4→            <i class=\"bi bi-search input-icono1\"></i>\n     5→        </div>\n     6→    </div>\n     7→    <div class=\"col-3\">\n     8→        ${crearSelect2({\n     9→            opciones: [\n    10→                { nombre: 'Todos los planes', id: 'Todos' },\n    11→                @foreach ($tipos_pruebas as $item)\n    12→                    { nombre: '{{ $item->nombre }}', id: '{{ $item->id }}' },\n    13→                @endforeach\n    14→            ],\n    15→            id: 'filtro_tipo_prueba_id',\n    16→            name: 'tipo_prueba_id',\n    17→            input_container_class: 'mb-0',\n    18→            onchange: 'mostrarPlanes();',\n    19→            opcion_vacia: false\n    20→        })}\n    21→    </div>\n    22→    <div class=\"col-2 offset-4 text-end\">\n    23→        ${crearBoton({\n    24→            id: 'boton-asignar-planes',\n    25→            texto: 'Asignar plan',\n    26→            clases: 'btn-primary px-6',\n    27→            url: '#'\n    28→        })}\n    29→    </div>\n    30→</div>\n    31→<div class=\"row w-100 m-0\">\n    32→    <div class=\"table-responsive w-100\" id=\"tabla-responsive-planes\" style=\"overflow: initial;\">\n    33→        <table class=\"table table-borderless w-100\" id=\"tabla-planes\">\n    34→            <thead class=\"d-none\">\n    35→                <tr>\n    36→                    <th></th>\n    37→                </tr>\n    38→            </thead>\n    39→            <tbody id=\"tbody-planes\"></tbody>\n    40→        </table>\n    41→    </div>\n    42→</div>\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"074389a2-5245-4cac-b694-a2681e57061e","timestamp":"2026-01-25T01:47:01.344Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"5c8ebc85-e957-4dc2-9e06-47a3765f2134","timestamp":"2026-01-25T01:47:01.403Z"}
{"parentUuid":"5c8ebc85-e957-4dc2-9e06-47a3765f2134","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:47:03.704Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01MyA38ZUAAf5M3ymNP4o7U2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KDTbj38x2oFezuf12oj8LC","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && find ./public -name \"empresas.js\" -type f"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1078,"cache_read_input_tokens":33267,"cache_creation":{"ephemeral_5m_input_tokens":1078,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFdSeCGNeazM9siiyEu","uuid":"bb1ac7b0-b68a-4cab-80f5-a2ca784577ab"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"812c1bb9-b320-4d20-986f-e301169c13ce","timestamp":"2026-01-25T01:47:03.744Z"}
{"parentUuid":"812c1bb9-b320-4d20-986f-e301169c13ce","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KDTbj38x2oFezuf12oj8LC","type":"tool_result","content":"./public/js/empresas/empresas.js","is_error":false}]},"uuid":"07a03ee1-2640-4ce5-8f0a-112ea28aa81f","timestamp":"2026-01-25T01:47:04.776Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"4e3c993f-7551-4872-93ae-8f01cbb64741","timestamp":"2026-01-25T01:47:04.825Z"}
{"parentUuid":"4e3c993f-7551-4872-93ae-8f01cbb64741","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:47:06.218Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01MhUtLwXo4B9rYaxQ4THx5t","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013mT3d7TMVRLQAa1S4Mm8MM","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","limit":500}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":169,"cache_read_input_tokens":34345,"cache_creation":{"ephemeral_5m_input_tokens":169,"ephemeral_1h_input_tokens":0},"output_tokens":18,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFdgvga4DHZ2VaPfPxp","uuid":"5687135f-2ee2-408a-bd29-83ab18e27dfa"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"8d627053-444f-41d5-8358-55bed32dd6cb","timestamp":"2026-01-25T01:47:06.258Z"}
{"parentUuid":"8d627053-444f-41d5-8358-55bed32dd6cb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013mT3d7TMVRLQAa1S4Mm8MM","type":"tool_result","content":"     1→let redirige_form = 'empresas-gestionar';\n     2→let empresa_id      = null;\n     3→let enlace_creacion = null;\n     4→let resource_url = 'empresas';\n     5→let logo_valido = true;\n     6→let validacion_logo_mensaje = '';\n     7→if (resource_url == undefined) {\n     8→    redirige_form = 'empresas';\n     9→}\n    10→let usuarios_seleccionados = [];\n    11→let empresas_seleccionadas = [];\n    12→let url_datatable = {\n    13→    url: resource_url + '-listado-tabla',\n    14→};\n    15→let cantidad_empresas_listado = 0;\n    16→let empresas_listado = [];\n    17→empresa_id_eliminar = null;\n    18→empresa_nombre_eliminar = '';\n    19→\n    20→const CAMPO_CELULAR_ID = 'celular';\n    21→const CAMPO_CELULAR_CONTACTO_ID = 'celular_contacto';\n    22→const CAMPO_CELULAR_TESORERO_ID = 'celular_tesorero';\n    23→const CAMPO_CELULAR_USUARIO_ID = 'celular_usuario';\n    24→\n    25→let campo_celular = null;\n    26→let campo_celular_contacto = null;\n    27→let campo_celular_tesorero = null;\n    28→let campo_celular_usuario = null;\n    29→\n    30→let columnas_datatable = [\n    31→    { data: 'id' },\n    32→    { data: 'sucursales_count' },\n    33→    { data: 'id' },\n    34→    { data: 'nombre_comercial' },\n    35→    { data: 'razon_social' },\n    36→    { data: 'documento' },\n    37→    { data: 'ejecutivo.nombre_completo' },\n    38→    { data: 'plan_seleccion' },\n    39→    { data: 'plan_organizacional' },\n    40→    { data: 'plan_vocacional' },\n    41→    { data: null, name: 'acciones', orderable: false, searchable: false }\n    42→];\n    43→\n    44→let colunmasHTML = [\n    45→    {\n    46→        targets: [0],\n    47→        render: function (data) {\n    48→            return `<div class=\"check-container my-1 me-1\">\n    49→                        <input type=\"checkbox\" class=\"form-check-input\" value=\"${data}\" name=\"empresas_seleccionadas[]\" />\n    50→                    </div>`;\n    51→        }\n    52→    },\n    53→    {\n    54→        targets: 1,\n    55→        render: function (data, type, row) {\n    56→            // Agrega botón para mostrar sucursales\n    57→            return `<span style=\"witdh:80px;\" class=\"pointer\" onclick=\"mostrarOcultarSucursales(this, ${row.id})\">${row.sucursales_count}</span>`;\n    58→        }\n    59→    },\n    60→    {\n    61→        targets: -1,\n    62→        render: function(data, type, row) {\n    63→            return `\n    64→                <div class=\"text-center text-nowrap\">\n    65→                    <button type=\"button\" class=\"btn btn-text-primary btn-circle\" onclick=\"consultarTabla('${resource_url}', ${row.id}, 'ver')\">\n    66→                        <i class=\"bi bi-eye\"></i>\n    67→                    </button>\n    68→                    <button type=\"button\" class=\"btn btn-text-primary btn-circle\" onclick=\"consultarTabla('${resource_url}', ${row.id}, 'editar')\">\n    69→                        <i class=\"bi bi-pencil\"></i>\n    70→                    </button>\n    71→                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalArchivar(${row.id})\">\n    72→                        <i class=\"bi bi-archive\"></i>\n    73→                    </button>\n    74→                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirHistorialCambios(${row.id}, '${row.razon_social}')\">\n    75→                        <i class=\"bi bi-clock\"></i>\n    76→                    </button>\n    77→                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirDetalleArchivado(${row.id}, '${row.razon_social}', '${row.comentario}')\" title=\"Detalle de archivado\">\n    78→                        <i class=\"bi bi-list\"></i>\n    79→                    </button>\n    80→                    <button type=\"button\" class=\"btn btn-text-danger text-white btn-circle\" onclick=\"eliminarTabla('${resource_url}', ${row.id}, 'empresa')\">\n    81→                        <i class=\"bi bi-trash\"></i>\n    82→                    </button>\n    83→                </div>\n    84→            `;\n    85→        }\n    86→    },\n    87→    {\n    88→        targets: [6, 7, 8], // Columnas de planes de empresa por tipo de prueba\n    89→        render: function (data) {\n    90→            if (data === null) {\n    91→                return null;\n    92→            }\n    93→\n    94→            return `<span onclick=\"abrirDetallePlan(${data?.id})\" class=\"pointer\">${data?.estado?.nombre}</span>`;\n    95→        }\n    96→    }\n    97→];\n    98→\n    99→/**\n   100→ * Función que abre el modal para filtrar las empresas.\n   101→ *\n   102→ * @returns {void}\n   103→ * @author José Manuel Jiménez\n   104→ */\n   105→function abrirModalFiltrosAvanzadosEmpresas() {\n   106→    $('#modal-filtros-avanzados-empresas').modal('show');\n   107→}\n   108→\n   109→/**\n   110→ * Función busca los planes de un tipo de prueba para el filtrado.\n   111→ *\n   112→ * @returns {void}\n   113→ * @author José Manuel Jiménez\n   114→ */\n   115→function seleccionarTipoPruebaFiltro(tipo_prueba_id) {\n   116→    $('#filtro_plan_id').empty();\n   117→    if (tipo_prueba_id == '') {\n   118→        $('#filtro_plan_id').append(`<option value=\"\">Todos</option>`);\n   119→        $('#filtro-plan').addClass('d-none');\n   120→    } else {\n   121→        $.ajax({\n   122→            type : 'GET',\n   123→            url : `/planes-listado`,\n   124→            data : {\n   125→                tipo_prueba_id: tipo_prueba_id\n   126→            },\n   127→            success: function(respuesta) {\n   128→                let planes = respuesta.data;\n   129→                $('#filtro_plan_id').append(`<option value=\"\">Todos</option>`);\n   130→                for (let i = 0; i < planes.length; i++) {\n   131→                    $('#filtro_plan_id').append(`\n   132→                        <option value=\"${planes[i].id}\">${planes[i].nombre}</option>\n   133→                    `);\n   134→                }\n   135→            },\n   136→            error: function(error) {\n   137→                console.log(error);\n   138→            }\n   139→        });\n   140→        $('#filtro-plan').removeClass('d-none');\n   141→    }\n   142→}\n   143→\n   144→/**\n   145→ * Función recarga las empresas con el filtro aplicado.\n   146→ *\n   147→ * @returns {void}\n   148→ * @author José Manuel Jiménez\n   149→ */\n   150→function aplicarFiltrosAvanzadosEmpresas() {\n   151→    mostrarEmpresas();\n   152→    $('#modal-filtros-avanzados-empresas').modal('hide');\n   153→}\n   154→\n   155→/**\n   156→ * Función que limpia los filtros aplicados en las empresas.\n   157→ *\n   158→ * @returns {void}\n   159→ * @author José Manuel Jiménez\n   160→ */\n   161→function borrarFiltrosAvanzadosEmpresas() {\n   162→    $('#modal-filtros-avanzados-empresas .select2-filtro').val('').trigger('change').trigger('select2:select');\n   163→    aplicarFiltrosAvanzadosEmpresas();\n   164→}\n   165→\n   166→/**\n   167→ * Función que muestra la lista de las empresas.\n   168→ *\n   169→ * @returns {void}\n   170→ * @author José Manuel Jiménez\n   171→ */\n   172→function mostrarEmpresas() {\n   173→    let estado = !archivadas;\n   174→    let tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n   175→    let plan_id = $('#filtro_plan_id').val();\n   176→    let ejecutivo_id = $('#filtro_ejecutivo_id').val();\n   177→    let rango_fechas = $('#filtro_fecha_hora').val();\n   178→    if (rango_fechas != '') {\n   179→        rango_fechas = rango_fechas.split(\" a \");\n   180→    }\n   181→    let pais_id = $('#pais_id').val();\n   182→    let departamento_id = $('#departamento_id').val();\n   183→    let estado_plan_id = $('#filtro_estado').val();\n   184→    let ciudad_id = $('#ciudad_id').val();\n   185→    inicializarTooltips()\n   186→    $.ajax({\n   187→        type: 'GET',\n   188→        url: `/empresas-listado-tabla`,\n   189→        data: {\n   190→            'solo_principales': true,\n   191→            'estado_plan_id': estado_plan_id,\n   192→            'activo': estado,\n   193→            'tipo_prueba_id': tipo_prueba_id,\n   194→            'plan_id': plan_id,\n   195→            'ejecutivo_id': ejecutivo_id,\n   196→            'rango_fechas': rango_fechas,\n   197→            'pais_id': pais_id,\n   198→            'departamento_id': departamento_id,\n   199→            'ciudad_id': ciudad_id\n   200→        },\n   201→        success: function(empresas) {\n   202→            cantidad_empresas_listado = 0;\n   203→            empresas_listado = empresas;\n   204→            if ($.fn.DataTable.isDataTable('#tabla-empresas')) {\n   205→                tabla_empresas.destroy();\n   206→            }\n   207→            $('#buscador-empresas').remove();\n   208→            $('#tbody-empresas').empty();\n   209→            for (let i = 0; i < empresas.length; i++) {\n   210→                cantidad_empresas_listado++;\n   211→                crearItemTabla(empresas[i]);\n   212→                let sucursales = empresas[i].sucursales;\n   213→                for (let j = 0; j < sucursales.length; j++) {\n   214→                    cantidad_empresas_listado++;\n   215→                    crearItemTabla(sucursales[j], 'sucursal', empresas[i].plan_seleccion, empresas[i].plan_organizacional, empresas[i].plan_vocacional);\n   216→                }\n   217→            }\n   218→            tabla_empresas = $('#tabla-empresas').DataTable({\n   219→                language: lenguajeDatatables,\n   220→                deferRender: true,\n   221→                lengthMenu: [\n   222→                    [ 10, 25, 50, 100, 200],\n   223→                    [ 10, 25, 50, 100, 200]\n   224→                ],\n   225→                columnDefs: [\n   226→                    { targets: [0, 1], orderable: false }\n   227→                ],\n   228→            });\n   229→            mostrarComponenteNumeroRegistrosTabla('tabla-empresas');\n   230→            $('colgroup').addClass('d-none');\n   231→            mostrarOcultarColumnas();\n   232→            tabla_empresas.on('page order length', function () {\n   233→                setTimeout(function() {\n   234→                    mostrarOcultarColumnas();\n   235→                }, 30);\n   236→            });\n   237→            $(`#buscador-tabla-empresas`).empty();\n   238→            $(`#buscador-tabla-empresas`).append(`\n   239→                <div class=\"input-container input-icon mb-3\" id=\"contenedor-buscador-tabla-empresas\">\n   240→                    <i class=\"bi bi-search\"></i>\n   241→                    <i class=\"bi bi-filter pointer\" style=\"right: 10px!important; left: auto!important;\" onclick=\"abrirModalFiltrosAvanzadosEmpresas();\"></i>\n   242→                </div>\n   243→            `);\n   244→            var buscador_datatables = $(`#tabla-empresas_wrapper .dt-search .dt-input`).first();\n   245→            $(buscador_datatables).addClass('rounded-2 text-body-2 input-filtro');\n   246→            $(buscador_datatables).prop('placeholder', 'Buscar');\n   247→            $(`#contenedor-buscador-tabla-empresas`).append(buscador_datatables);\n   248→            $(`#tabla-empresas_wrapper .dt-layout-cell.dt-end `).first().addClass('d-none');\n   249→        },\n   250→        error: function(error) {\n   251→            console.log(error);\n   252→        }\n   253→    });\n   254→}\n   255→\n   256→/**\n   257→ * Función que muestra cada item de empresa o sucursal.\n   258→ *\n   259→ * @returns {void}\n   260→ * @author José Manuel Jiménez\n   261→ */\n   262→function crearItemTabla(item, tipo = 'empresa', plan_seleccion = null, plan_organizacional = null, plan_vocacional = null) {\n   263→    let campo_sucursal = '';\n   264→    if (tipo == 'empresa' && item.sucursales.length > 0) {\n   265→        campo_sucursal = `\n   266→            <div class=\"width-60px rounded-1 badge-estado-plan badge-estado-inactivo nowrap pointer\" onclick=\"mostrarOcultarSucursales(this, ${item.id})\">\n   267→                ${item.sucursales_count} <i class=\"bi bi-caret-down-fill\"></i>\n   268→            </div>\n   269→        `;\n   270→    }\n   271→    let planes = '';\n   272→    let clase = '';\n   273→    let bg = '';\n   274→    if (tipo == 'sucursal') {\n   275→        clase = `empresa-${item.empresa_id} d-none`;\n   276→        bg = 'bg-gray-90';\n   277→        planes = `\n   278→            <td class=\"${bg}\">\n   279→                ${obtenerEstadoPlan(\n   280→                    plan_seleccion?.estado?.id ?? null,\n   281→                    plan_seleccion?.estado?.nombre ?? null,\n   282→                    plan_seleccion?.por_facturar ?? null,\n   283→                    plan_seleccion?.renovando ?? null,\n   284→                    plan_seleccion?.id ?? null,\n   285→                    plan_seleccion?.plan_proximo\n   286→                )}\n   287→            </td>\n   288→            <td class=\"${bg}\">\n   289→                ${obtenerEstadoPlan(\n   290→                    plan_organizacional?.estado?.id ?? null,\n   291→                    plan_organizacional?.estado?.nombre ?? null,\n   292→                    plan_organizacional?.por_facturar ?? null,\n   293→                    plan_organizacional?.renovando ?? null,\n   294→                    plan_organizacional?.id ?? null,\n   295→                    plan_organizacional?.plan_proximo\n   296→                )}\n   297→            </td>\n   298→            <td class=\"${bg}\">\n   299→                ${obtenerEstadoPlan(\n   300→                    plan_vocacional?.estado?.id ?? null,\n   301→                    plan_vocacional?.estado?.nombre ?? null,\n   302→                    plan_vocacional?.por_facturar ?? null,\n   303→                    plan_vocacional?.renovando ?? null,\n   304→                    plan_vocacional?.id ?? null,\n   305→                    plan_vocacional?.plan_proximo\n   306→                )}\n   307→            </td>\n   308→        `;\n   309→    } else {\n   310→        planes = `\n   311→            <td class=\"${bg}\">\n   312→                ${obtenerEstadoPlan(\n   313→                    item?.plan_procesos_de_seleccion?.estado?.id ?? null,\n   314→                    item?.plan_procesos_de_seleccion?.estado?.nombre ?? null,\n   315→                    item?.plan_procesos_de_seleccion?.por_facturar ?? null,\n   316→                    item?.plan_procesos_de_seleccion?.renovando ?? null,\n   317→                    item?.plan_procesos_de_seleccion?.id ?? null,\n   318→                    item?.plan_procesos_de_seleccion?.plan_proximo\n   319→                )}\n   320→            </td>\n   321→            <td class=\"${bg}\">\n   322→                ${obtenerEstadoPlan(\n   323→                    item?.plan_procesos_organizacionales?.estado?.id ?? null,\n   324→                    item?.plan_procesos_organizacionales?.estado?.nombre ?? null,\n   325→                    item?.plan_procesos_organizacionales?.por_facturar ?? null,\n   326→                    item?.plan_procesos_organizacionales?.renovando ?? null,\n   327→                    item?.plan_procesos_organizacionales?.id ?? null,\n   328→                    item?.plan_procesos_organizacionales?.plan_proximo\n   329→                )}\n   330→            </td>\n   331→            <td class=\"${bg}\">\n   332→                ${obtenerEstadoPlan(\n   333→                    item?.plan_procesos_vocacionales?.estado?.id ?? null,\n   334→                    item?.plan_procesos_vocacionales?.estado?.nombre ?? null,\n   335→                    item?.plan_procesos_vocacionales?.por_facturar ?? null,\n   336→                    item?.plan_procesos_vocacionales?.renovando ?? null,\n   337→                    item?.plan_procesos_vocacionales?.id ?? null,\n   338→                    item?.plan_procesos_vocacionales?.plan_proximo\n   339→                )}\n   340→            </td>\n   341→        `;\n   342→    }\n   343→    let checked = '';\n   344→    if (empresas_seleccionadas.includes(item.id)) {\n   345→        checked = 'checked';\n   346→    }\n   347→\n   348→    $('#tbody-empresas').append(`\n   349→        <tr class=\"${clase} ${bg}\">\n   350→            <td class=\"${bg}\">\n   351→                <div class=\"check-container my-1 me-1\">\n   352→                    <input type=\"checkbox\" class=\"form-check-input\" value=\"${item.id}\" onchange=\"seleccionarCheckboxEmpresa(this.checked, this.value);\" ${checked}/>\n   353→                </div>\n   354→            </td>\n   355→            <td class=\"${bg}\">${campo_sucursal ?? ''}</td>\n   356→            <td class=\"${bg}\">${item?.id ?? ''}</td>\n   357→            <td class=\"${bg}\">${item?.nombre_comercial ?? ''}</td>\n   358→            <td class=\"${bg}\">${item?.razon_social ?? ''}</td>\n   359→            <td class=\"${bg}\">${item?.documento ?? ''}</td>\n   360→            <td class=\"${bg}\">${item?.ejecutivo?.nombre_completo ?? ''}</td>\n   361→            ${planes}\n   362→            <td class=\"${bg} d-none columna-ubicacion\">${item?.ciudad?.nombre ?? ''} ${item?.ciudad?.departamento?.pais?.nombre ?? ''}</td>\n   363→            <td class=\"${bg} d-none columna-numero-celular\">${item?.celular ?? ''}</td>\n   364→            <td class=\"${bg} d-none columna-correo-facturacion\">${item?.email_facturacion ?? ''}</td>\n   365→            <td class=\"${bg} d-none columna-fecha-creacion\">${item?.created_at ?? ''}</td>\n   366→            <td class=\"${bg} d-none columna-progreso-creacion\">${item?.porcentaje_creacion ?? ''}</td>\n   367→            <td class=\"${bg} d-none columna-tamano-empresa\">${item?.tamano_empresa?.nombre ?? ''}</td>\n   368→            <td class=\"${bg} d-none columna-sector\">${item?.sector?.nombre ?? ''}</td>\n   369→            <td class=\"${bg} d-none columna-direccion\">${item?.direccion ?? ''}</td>\n   370→            <td class=\"${bg} d-none columna-representante\">${item?.nombre_representante ?? ''}</td>\n   371→            <td class=\"${bg} text-center\">\n   372→                <div class=\"col-auto px-0 dropdown\">\n   373→                    <i class=\"bi bi-three-dots dropdown-toggle text-blue-40 pointer\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n   374→                    <div class=\"dropdown-menu\">\n   375→                        <a href=\"/empresas-gestionar/${item.id}\" class=\"dropdown-item no-visited pointer py-2\">Gestionar empresa</a>\n   376→                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirHistorialCambios(${item?.id}, '${item?.razon_social}', '${item?.creado_administrador}')\">Historial de cambios</div>\n   377→                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirModalArchivar(${item?.id})\">Archivar</div>\n   378→                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"cambiarEmpresa(${item?.id});\">Cambiar a esta empresa</div>\n   379→                        <div class=\"dropdown-item no-visited pointer py-2 text-danger\" onclick=\"abrirModalConfirmarEliminarEmpresas('${item?.id}', '${item?.razon_social}')\">Eliminar</div>\n   380→                    </div>\n   381→                </div>\n   382→            </td>\n   383→        </tr>\n   384→    `);\n   385→}\n   386→\n   387→/**\n   388→ * Función que muestra u oculta las sucursales de una empresa.\n   389→ *\n   390→ * @returns {void}\n   391→ * @author José Manuel Jiménez\n   392→ */\n   393→function mostrarOcultarSucursales(elemento, empresa_id_padre) {\n   394→    if ($(elemento).find('.bi-caret-down-fill').first().length > 0) {\n   395→        $('.empresa-' + empresa_id_padre).removeClass('d-none');\n   396→        $(elemento).find('.bi-caret-down-fill').first().removeClass('bi-caret-down-fill').addClass('bi-caret-up-fill');\n   397→    } else {\n   398→        $('.empresa-' + empresa_id_padre).addClass('d-none');\n   399→        $(elemento).find('.bi-caret-up-fill').first().removeClass('bi-caret-up-fill').addClass('bi-caret-down-fill');\n   400→    }\n   401→}\n   402→\n   403→/**\n   404→ * Función que evalua que columnasn adicionales hay que mostrar.\n   405→ *\n   406→ * @returns {void}\n   407→ * @author José Manuel Jiménez\n   408→ */\n   409→function mostrarOcultarColumnas() {\n   410→    let columnas = $('.filtro-columna');\n   411→    for (let i = 0; i < columnas.length; i++) {\n   412→        let valor = $(columnas[i]).val();\n   413→        let checked = $(columnas[i]).prop('checked');\n   414→        if (checked) {\n   415→            $('.' + valor).removeClass('d-none');\n   416→        } else {\n   417→            $('.' + valor).addClass('d-none');\n   418→        }\n   419→    }\n   420→}\n   421→\n   422→/**\n   423→ * Función que abre el modal para confirmar la eliminación de empresas.\n   424→ *\n   425→ * @returns {void}\n   426→ * @author José Manuel Jiménez\n   427→ */\n   428→function abrirModalConfirmarEliminarEmpresas(empresa_id = null, nombre_empresa = '') {\n   429→    empresa_id_eliminar = empresa_id;\n   430→    nombre_empresa = 'Eliminar ' + nombre_empresa;\n   431→    $('#nombre-confirmar-eliminacion').text(nombre_empresa);\n   432→    $('#modal-confirmar-eliminacion').modal('show');\n   433→}\n   434→\n   435→/**\n   436→ * Confirmar la eliminación de empresas.\n   437→ *\n   438→ * @returns {void}\n   439→ * @author José Manuel Jiménez\n   440→ */\n   441→function confirmarEliminarEmpresas() {\n   442→    eliminarEmpresas(empresa_id_eliminar);\n   443→}\n   444→\n   445→/**\n   446→ * Eliminar empresas.\n   447→ *\n   448→ * @returns {void}\n   449→ * @author Daniel Beltrán\n   450→ */\n   451→async function eliminarEmpresas(empresa_id = null) {\n   452→    await $.ajax({\n   453→        type: 'DELETE',\n   454→        url : `/empresas/${empresa_id}`,\n   455→        data: {\n   456→            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n   457→        }\n   458→    }).then((respuesta) => {\n   459→        empresa_id_eliminar = null;\n   460→        empresa_nombre_eliminar = '';\n   461→        if (respuesta.tipo != undefined && respuesta.tipo == 'success') {\n   462→            mostrarToast('success', respuesta.mensaje);\n   463→            mostrarEmpresas();\n   464→        } else if (respuesta.errors != undefined) {\n   465→            mostrarToast('danger', respuesta.message);\n   466→        }\n   467→        $('#modal-confirmar-eliminacion').modal('hide');\n   468→    }).catch((error) => {\n   469→        mostrarToast('danger', error.responseJSON.errors);\n   470→        empresa_id_eliminar = null;\n   471→        empresa_nombre_eliminar = '';\n   472→        $('#modal-confirmar-eliminacion').modal('hide');\n   473→    });\n   474→}\n   475→\n   476→$(document).ready(function () {\n   477→    if (typeof opcion_form !== 'undefined' && opcion_form == \"Editar\") {\n   478→        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;\n   479→        $(\"#digito_verificacion\").val(numero)\n   480→    }\n   481→\n   482→    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n   483→    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n   484→    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n   485→    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n   486→\n   487→    inicializarSelect2Asincrono('filtro_empresa_id', 'empresas-listado', 'razon_social', { id: 'id', nombre: 'razon_social' }, false, { solo_principales: true });\n   488→\n   489→    configurarFormulario('formulario-archivos');\n   490→    configurarFormulario('formulario-contactos');\n   491→\n   492→    if ($('#pais_id').val() != '') {\n   493→        $('#pais_id').trigger('change');\n   494→    }\n   495→    if ($('#empresa_id').val() != '') {\n   496→        $('#empresa_id').trigger('change');\n   497→    }\n   498→    if ($('#filtro_empresa_id').val() != '') {\n   499→        $('#filtro_empresa_id').trigger('change').trigger('select2:select');\n   500→    }\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"745ad8e2-badc-451d-b907-8c7d6990ce55","timestamp":"2026-01-25T01:47:07.274Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"963ad46e-09cb-4974-9b85-299d33c6d866","timestamp":"2026-01-25T01:47:07.324Z"}
{"parentUuid":"963ad46e-09cb-4974-9b85-299d33c6d866","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:47:10.238Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XXLdkZaTqkGmh33ti39BqP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018ypbiSASK6nW1ZqCHEGoLj","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && grep -rn \"function mostrarPlanes\" ./public/js --include=\"*.js\""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":8112,"cache_read_input_tokens":34514,"cache_creation":{"ephemeral_5m_input_tokens":8112,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFdsywayQtTqp7dQGoy","uuid":"cc900138-c9fe-4528-b2cf-0e590231d054"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"f62050ff-1268-4d59-bd9a-26dcd644a282","timestamp":"2026-01-25T01:47:10.283Z"}
{"parentUuid":"f62050ff-1268-4d59-bd9a-26dcd644a282","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018ypbiSASK6nW1ZqCHEGoLj","type":"tool_result","content":"./public/js/empresas/asignar-plan.js:257:function mostrarPlanesCreditos() {\n./public/js/empresas/asignar-plan.js:404:function mostrarPlanes() {\n./public/js/empresas/empresas.js:1491:function mostrarPlanes() {","is_error":false}]},"uuid":"f10025aa-55af-434f-9f5d-f07b313c2f06","timestamp":"2026-01-25T01:47:11.550Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"2204699b-b913-4c14-a5fa-c8ccf65ffca9","timestamp":"2026-01-25T01:47:11.599Z"}
{"parentUuid":"2204699b-b913-4c14-a5fa-c8ccf65ffca9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:47:13.474Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01LQDcG79V3EarY8TQpCbSiw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019jAvJeDYTkeFsF4TdCjRMt","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":1491,"limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":488,"cache_read_input_tokens":42626,"cache_creation":{"ephemeral_5m_input_tokens":488,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFeBpFYkbvtmZj445mV","uuid":"666fd98d-2e0e-4776-8c64-ca41764d9380"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"cab98a01-b945-4689-9ecc-8ac063c1d4c1","timestamp":"2026-01-25T01:47:13.512Z"}
{"parentUuid":"cab98a01-b945-4689-9ecc-8ac063c1d4c1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019jAvJeDYTkeFsF4TdCjRMt","type":"tool_result","content":"  1491→function mostrarPlanes() {\n  1492→    let empresa_id = empresa_seleccionada.id;\n  1493→    let buscar = $('#buscador-plan').val();\n  1494→    let filtro_tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n  1495→    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n  1496→        tabla_planes.destroy();\n  1497→    }\n  1498→    $('#buscador-plan').remove();\n  1499→    $('#tbody-planes').empty();\n  1500→    let planes = empresa_seleccionada.planes;\n  1501→    if (planes.length > 0) {\n  1502→        for (let i = 0; i < planes.length; i++) {\n  1503→            if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n  1504→                continue;\n  1505→            }\n  1506→            if (\n  1507→                (filtro_tipo_prueba_id == 'Todos') ||\n  1508→                (filtro_tipo_prueba_id == '1' && planes[i].plan.tipo_prueba_id == 1) ||\n  1509→                (filtro_tipo_prueba_id == '2' && planes[i].plan.tipo_prueba_id == 2) ||\n  1510→                (filtro_tipo_prueba_id == '3' && planes[i].plan.tipo_prueba_id != 3)\n  1511→            ) {\n  1512→                let estado = obtenerEstadoPlan(\n  1513→                    planes[i].estado.id,\n  1514→                    planes[i].estado.nombre,\n  1515→                    planes[i].por_facturar,\n  1516→                    planes[i].renovando,\n  1517→                    null,\n  1518→                    planes[i].plan_proximo_id\n  1519→                );\n  1520→\n  1521→                let acciones = obtenerAcciones(\n  1522→                    planes[i].estado.id,\n  1523→                    planes[i].id, empresa_id,\n  1524→                    planes[i].plan.tipo_prueba_id,\n  1525→                    planes[i].plan.nombre,\n  1526→                    planes[i]?.archivos[0]?.id ?? '0',\n  1527→                    empresa_seleccionada.nombre_comercial\n  1528→                );\n  1529→\n  1530→                let modificado = '';\n  1531→                if (planes[i].plan_original == 0) {\n  1532→                    modificado = `<i class=\"bi bi-wrench me-3 text-blue-40\" ${crearTooltip({placement: 'top', content: 'Plan modificado', toggle: 'popover' })}></i>`;\n  1533→                }\n  1534→                let fecha_vencimiento = '';\n  1535→                if (planes[i].fecha_vencimiento != null) {\n  1536→                    fecha_vencimiento = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n  1537→                }\n  1538→                let fecha_creacion = '';\n  1539→                if (planes[i].created_at != null) {\n  1540→                    fecha_creacion = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n  1541→                }\n  1542→                let fecha_inicio = '';\n  1543→                if (planes[i].fecha_inicio != null) {\n  1544→                    fecha_inicio = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n  1545→                }\n  1546→                let pruebas_plan = '';\n  1547→                if (planes[i].pruebas !== undefined) {\n  1548→                    let pruebas = planes[i].pruebas;\n  1549→                    for (let j = 0; j < pruebas.length; j++) {\n  1550→                        pruebas_plan += `\n  1551→                            <div\n  1552→                                class=\"col-auto me-3 circulo-prueba\"\n  1553→                                style=\"background-image: url(../imagenes/logos/pruebas/${slugify(planes[i].pruebas[j].nombre)}.png)\"\n  1554→                                ${crearTooltip({placement: 'top', content: planes[i].pruebas[j].nombre, toggle: 'popover' })}\n  1555→                            ></div>\n  1556→                        `;\n  1557→                    }\n  1558→                }\n  1559→                let icono = '';\n  1560→                let title = '';\n  1561→                if (planes[i].plan.tipo_prueba_id == 1) {\n  1562→                    title = 'Selección';\n  1563→                    icono = 'bi-person-fill';\n  1564→                } else if (planes[i].plan.tipo_prueba_id == 2) {\n  1565→                    title = 'Organizacional';\n  1566→                    icono = 'bi-people-fill';\n  1567→                } else if (planes[i].plan.tipo_prueba_id == 3) {\n  1568→                    title = 'Vocacional';\n  1569→                    icono = 'bi-mortarboard-fill';\n  1570→                }\n  1571→                let opcion_editar = `\n  1572→                    <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit'\">\n  1573→                        <i class=\"bi bi-pencil-fill\"></i>\n  1574→                    </button>\n  1575→                `;\n  1576→                if (planes[i]?.plan_proximo_id) {\n  1577→                    opcion_editar = `\n  1578→                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n  1579→                            <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n  1580→                            <div class=\"dropdown-menu\">\n  1581→                                <a href=\"/empresas-planes/${planes[i].id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n  1582→                                <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n  1583→                            </div>\n  1584→                        </button>\n  1585→                    `;\n  1586→                }\n  1587→                $('#tbody-planes').append(`\n  1588→                    <tr>\n  1589→                        <td style=\"border-bottom: 0px!important;\">\n  1590→                            <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"dc2c20b6-248d-412b-9dfe-036b468bfdec","timestamp":"2026-01-25T01:47:14.508Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"d38e8447-9028-4602-a43f-273c84080bc7","timestamp":"2026-01-25T01:47:14.565Z"}
{"parentUuid":"d38e8447-9028-4602-a43f-273c84080bc7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:47:18.443Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015Kh2td6Lr8GUVW3JsAqGBd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019LWsF3oHwxSVW1Wv5tfzcw","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && grep -n \"function obtenerDatosGestionarEmpresa\" ./public/js/empresas/*.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":2274,"cache_read_input_tokens":43114,"cache_creation":{"ephemeral_5m_input_tokens":2274,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFeRKbn8kDhKnk9yYUV","uuid":"71e7b3ca-a214-4996-b5ce-0a560967d89c"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"56f2e1ae-4287-4363-bcfd-9853d8c7d9b8","timestamp":"2026-01-25T01:47:18.479Z"}
{"parentUuid":"56f2e1ae-4287-4363-bcfd-9853d8c7d9b8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019LWsF3oHwxSVW1Wv5tfzcw","type":"tool_result","content":"./public/js/empresas/empresas.js:1256:function obtenerDatosGestionarEmpresa(empresa_id) {","is_error":false}]},"uuid":"09afdd62-85fb-40f9-ae36-0f1946772ef5","timestamp":"2026-01-25T01:51:34.856Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"dc7ae36f-0a75-495e-b70b-b0be76397b08","timestamp":"2026-01-25T01:51:34.914Z"}
{"parentUuid":"dc7ae36f-0a75-495e-b70b-b0be76397b08","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:51:36.424Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DxmD19RyMpnw8nML5qA5mD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QGamJMW2sm1E2njzq9NAMW","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":1256,"limit":150}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":304,"cache_read_input_tokens":45388,"cache_creation":{"ephemeral_5m_input_tokens":304,"ephemeral_1h_input_tokens":0},"output_tokens":18,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFybiCyr9KMuGdumtdc","uuid":"de222fbe-302e-459e-a6eb-fd8909714f22"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"8d35268a-ce67-4636-b0a4-b59cc5dc467d","timestamp":"2026-01-25T01:51:36.464Z"}
{"parentUuid":"8d35268a-ce67-4636-b0a4-b59cc5dc467d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QGamJMW2sm1E2njzq9NAMW","type":"tool_result","content":"  1256→function obtenerDatosGestionarEmpresa(empresa_id) {\n  1257→\n  1258→    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n  1259→    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n  1260→    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n  1261→    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n  1262→\n  1263→    usuarios = [];\n  1264→    usuarios_seleccionados = [];\n  1265→    empresa_seleccionada = null;\n  1266→    configuraciones_defecto = [];\n  1267→    configuraciones_personalizadas = [];\n  1268→\n  1269→    $('.id').val('');\n  1270→    $('.empresa_id').val('');\n  1271→    $('#usuario').val('');\n  1272→    $('.col-lg-6-empresa').addClass('col-lg-6');\n  1273→    $('#tabs-empresa').addClass('d-none');\n  1274→    if (empresa_id != '' && empresa_id != null) {\n  1275→        $.ajax({\n  1276→            type : 'GET',\n  1277→            url : `/empresas-gestionar-datos/${empresa_id}`,\n  1278→            processData: false,\n  1279→            contentType: false,\n  1280→            success: function(respuesta) {\n  1281→                let empresa = respuesta.data;\n  1282→                if (empresa.empresa_id != null) {\n  1283→                    $('#boton-crear-usuarios').prop('href', `/usuarios/create?empresa_id=${empresa.id}`);\n  1284→                    $('#boton-asignar-planes').prop('href', `/asignar-plan/${empresa.id}`);\n  1285→                    $('#filtro_empresa_id').append(`\n  1286→                        <option value=\"${empresa.empresa.id}\">${empresa.empresa.razon_social}</option>\n  1287→                    `);\n  1288→                    if ($('#filtro_empresa_id').val() == '' || $('#filtro_empresa_id').val() == null) {\n  1289→                        $('#filtro_empresa_id').val(empresa.empresa.id).trigger('change', {programmatic: true});\n  1290→                    }\n  1291→                    buscarSucursalesEmpresa(empresa.empresa.id, empresa.id);\n  1292→                    $('.id').val(empresa.id);\n  1293→                    $('.empresa_id').val(empresa.empresa.id);\n  1294→                    $('.empresa').addClass('d-none');\n  1295→                    $('.sucursal').removeClass('d-none');\n  1296→                    $('.col-lg-6-empresa').removeClass('col-lg-6');\n  1297→                    $('#ejecutivo-cuenta').text('Ejecutivo de cuenta: ' + empresa.ejecutivo.nombre_completo);\n  1298→                    $('#seccion-logo').addClass('d-none');\n  1299→                } else {\n  1300→                    $('#boton-crear-usuarios').prop('href', `/usuarios/create?empresa_id=${empresa.id}`);\n  1301→                    $('#boton-asignar-planes').prop('href', `/asignar-plan/${empresa.id}`);\n  1302→                    $('#filtro_empresa_id').append(`\n  1303→                        <option value=\"${empresa.id}\">${empresa.razon_social}</option>\n  1304→                    `);\n  1305→                    if ($('#filtro_empresa_id').val() == '' || $('#filtro_empresa_id').val() == null) {\n  1306→                        $('#filtro_empresa_id').val(empresa.id).trigger('change', {programmatic: true});\n  1307→                    }\n  1308→                    buscarSucursalesEmpresa(empresa_id);\n  1309→                    $('.id').val(empresa.id);\n  1310→                    $('.empresa').removeClass('d-none');\n  1311→                    $('.sucursal').addClass('d-none');\n  1312→                    $('#ejecutivo-cuenta').text('');\n  1313→                    $('#seccion-logo').removeClass('d-none');\n  1314→                }\n  1315→                if (empresa.es_persona_juridica == 1) {\n  1316→                    $(\"#es_persona_juridica_si\").prop('checked', true);\n  1317→                } else {\n  1318→                    $(\"#es_persona_juridica_no\").prop('checked', true);\n  1319→                }\n  1320→                $('#razon_social').val(empresa.razon_social);\n  1321→                $('#nombre_comercial').val(empresa.nombre_comercial);\n  1322→                let documento = empresa.documento.split('-');\n  1323→                $('#documento').val(documento[0]);\n  1324→                $('#digito_verificacion').val(documento[1]);\n  1325→                $('#sector_id').val(empresa.sector_id).trigger('change').trigger('select2:select');\n  1326→                $('#tamano_empresa_id').val(empresa.tamano_empresa_id).trigger('change').trigger('select2:select');\n  1327→                $('#procesos_estimados_mensuales').val(empresa.procesos_estimados_mensuales);\n  1328→                $('#pruebas_estimadas_mensuales').val(empresa.pruebas_estimadas_mensuales);\n  1329→                $('#pais_id').data('departamento_id', empresa.ciudad.departamento_id);\n  1330→                $('#pais_id').val(empresa.ciudad.departamento.pais_id).trigger('change').trigger('select2:select');\n  1331→                $('#departamento_id').data('ciudad_id', empresa.ciudad.id);\n  1332→                $('#departamento_id').val(empresa.departamento_id).trigger('change').trigger('select2:select');\n  1333→                $('#ciudad_id').val(empresa.ciudad_id).trigger('change').trigger('select2:select');\n  1334→                $('#direccion').val(empresa.direccion);\n  1335→                $('#celular').val(empresa.celular);\n  1336→\n  1337→                rellenarInputCelular(empresa.indicativo_celular, empresa.codigo_iso2_pais_celular, empresa.celular, CAMPO_CELULAR_ID, campo_celular);\n  1338→\n  1339→                $('#email_facturacion').val(empresa.email_facturacion);\n  1340→                $('#telefono').val(empresa.telefono);\n  1341→\n  1342→                actualizarEnlacesPrevisualizacionArchivos(empresa.archivos);\n  1343→\n  1344→                if (empresa.telefono_tesorero != null) {\n  1345→                    let telefono = empresa.telefono_tesorero.split('-');\n  1346→                    $('#telefono').val(telefono[0]);\n  1347→                    $('#extension').val(telefono[1]);\n  1348→                }\n  1349→\n  1350→                $('#ejecutivo_id').val(empresa.ejecutivo_id).trigger('change').trigger('select2:select');\n  1351→                $('#nombre_representante').val(empresa.nombre_representante);\n  1352→                $('#tipo_documento_representante_id').val(empresa.tipo_documento_representante_id).trigger('change').trigger('select2:select');\n  1353→                $('#documento_representante').val(empresa.documento_representante);\n  1354→                $('#email_representante').val(empresa.email_representante);\n  1355→                if (![undefined, null, ''].includes(empresa.id)) {\n  1356→                    if (empresa.empresa_id != null) {\n  1357→                        $.ajax({\n  1358→                            type: 'GET',\n  1359→                            url : `/empresas-logo/${empresa.id}`,\n  1360→                            success: function() {\n  1361→                                $('#logo_sucursal_fondo_previsualizacion').addClass('d-none');\n  1362→                                $('#logo_sucursal_previsualizacion').attr('src', `/empresas-logo/${empresa.id}`);\n  1363→                                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n  1364→                            }\n  1365→                        });\n  1366→                    } else {\n  1367→                        $.ajax({\n  1368→                            type: 'GET',\n  1369→                            url : `/empresas-logo/${empresa.id}`,\n  1370→                            success: function() {\n  1371→                                $('#logo_fondo_previsualizacion').addClass('d-none');\n  1372→                                $('#logo_previsualizacion').attr('src', `/empresas-logo/${empresa.id}`);\n  1373→                                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n  1374→                            }\n  1375→                        });\n  1376→                    }\n  1377→                }\n  1378→\n  1379→                if (empresa.usuarios.length > 0) {\n  1380→                    const USUARIO_EMPRESA = empresa.usuarios[0].usuario;\n  1381→\n  1382→                    $('#usuario_id').val(USUARIO_EMPRESA.id);\n  1383→                    $('#nombres').val(USUARIO_EMPRESA.nombres);\n  1384→                    $('#apellidos').val(USUARIO_EMPRESA.apellidos);\n  1385→                    $('#tipo_documento_id').val(USUARIO_EMPRESA.tipo_documento_id).trigger('change').trigger('select2:select');\n  1386→                    $('#documento_usuario').val(USUARIO_EMPRESA.documento);\n  1387→                    $('#email').val(USUARIO_EMPRESA.email);\n  1388→\n  1389→                    rellenarInputCelular(\n  1390→                        USUARIO_EMPRESA.indicativo_telefono,\n  1391→                        USUARIO_EMPRESA.codigo_iso2_pais_telefono,\n  1392→                        USUARIO_EMPRESA.telefono,\n  1393→                        CAMPO_CELULAR_USUARIO_ID,\n  1394→                        campo_celular_usuario\n  1395→                    );\n  1396→\n  1397→                    $('#usuario').val(JSON.stringify({\n  1398→                        id               : USUARIO_EMPRESA.id,\n  1399→                        tipo_documento_id: USUARIO_EMPRESA.tipo_documento_id,\n  1400→                        documento        : USUARIO_EMPRESA.documento,\n  1401→                        nombres          : USUARIO_EMPRESA.nombres,\n  1402→                        apellidos        : USUARIO_EMPRESA.apellidos,\n  1403→                        email            : USUARIO_EMPRESA.email,\n  1404→                        telefono         : USUARIO_EMPRESA.telefono\n  1405→                    }));\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3b70e62d-d325-4761-9b89-35ab3cff5843","timestamp":"2026-01-25T01:51:37.481Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"3d4476f3-1e8f-4f8d-a32d-641a57a8cca1","timestamp":"2026-01-25T01:51:37.531Z"}
{"parentUuid":"3d4476f3-1e8f-4f8d-a32d-641a57a8cca1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:51:39.651Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PMF8CsCVxEwK2N3mN8HSWi","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ExGAjpQWXQMzopRMK3nu6H","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":1405,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":3453,"cache_read_input_tokens":45692,"cache_creation":{"ephemeral_5m_input_tokens":3453,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFyoE1EMY297FD2Cr1a","uuid":"d5f732ce-ce06-4eb2-a4be-218201cff3cf"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"35a6781f-1d60-4f0b-abf4-73509a444e4c","timestamp":"2026-01-25T01:51:39.689Z"}
{"parentUuid":"35a6781f-1d60-4f0b-abf4-73509a444e4c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ExGAjpQWXQMzopRMK3nu6H","type":"tool_result","content":"  1405→                    }));\n  1406→                }\n  1407→\n  1408→                $('#nombre_tesorero').val(empresa.nombre_tesorero);\n  1409→                $('#email_tesorero').val(empresa.email_tesorero);\n  1410→\n  1411→                rellenarInputCelular(\n  1412→                    empresa.indicativo_celular_tesorero,\n  1413→                    empresa.codigo_iso2_pais_celular_tesorero,\n  1414→                    empresa.celular_tesorero,\n  1415→                    CAMPO_CELULAR_TESORERO_ID,\n  1416→                    campo_celular_tesorero\n  1417→                );\n  1418→\n  1419→                if ( empresa.telefono_tesorero != null) {\n  1420→                    let telefono_tesorero = empresa.telefono_tesorero.split('-');\n  1421→                    $('#telefono_tesorero').val(telefono_tesorero[0]);\n  1422→                    $('#extension_tesorero').val(empresa.telefono_tesorero[1]);\n  1423→                }\n  1424→                $('#nombre_contacto').val(empresa.nombre_contacto);\n  1425→                $('#email_contacto').val(empresa.email_contacto);\n  1426→\n  1427→                rellenarInputCelular(\n  1428→                    empresa.indicativo_celular_contacto,\n  1429→                    empresa.codigo_iso2_pais_celular_contacto,\n  1430→                    empresa.celular_contacto,\n  1431→                    CAMPO_CELULAR_CONTACTO_ID,\n  1432→                    campo_celular_contacto\n  1433→                );\n  1434→\n  1435→                empresa_seleccionada = empresa;\n  1436→                mostrarPlanes();\n  1437→                $('#empresa-tab').click();\n  1438→                $('#tabs-empresa').removeClass('d-none');\n  1439→                usuarios = empresa.usuarios;\n  1440→                mostrarUsuarios(empresa_id);\n  1441→                configuraciones_defecto = empresa.configuraciones_defecto;\n  1442→                configuraciones_personalizadas = empresa.configuraciones_personalizadas;\n  1443→                let archivos = empresa.archivos;\n  1444→                $('.contenedor-archivo').addClass('d-none');\n  1445→                archivos.forEach((archivo) => {\n  1446→                    $('#archivo_' + archivo.nombre).removeClass('d-none');\n  1447→                    $('#archivo_' + archivo.nombre).prop('href', '/archivos-abrir/' + archivo.id);\n  1448→                });\n  1449→\n  1450→                mostrarConfiguraciones();\n  1451→            },\n  1452→            error: function(error) {\n  1453→                console.log(error);\n  1454→            }\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"9792bf4a-90d1-4256-bb0a-eca05a16943f","timestamp":"2026-01-25T01:51:40.721Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"f1f530c7-69fd-4ee0-b30e-8c0b930975f2","timestamp":"2026-01-25T01:51:40.773Z"}
{"parentUuid":"f1f530c7-69fd-4ee0-b30e-8c0b930975f2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:51:43.475Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_016aFd1rQHoHgkkYU7Ycn26H","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018KtaVqN6UxH7cm8LCjmPDu","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && find ./app/Http/Services -name \"*EmpresaService*\" -type f"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1005,"cache_read_input_tokens":49145,"cache_creation":{"ephemeral_5m_input_tokens":1005,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFz38RC1zS43gEpXLhX","uuid":"039babdd-f82c-47bc-9038-6685605a3c1e"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"7ebb7f0b-b874-44ac-add4-833be654b455","timestamp":"2026-01-25T01:51:43.511Z"}
{"parentUuid":"7ebb7f0b-b874-44ac-add4-833be654b455","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018KtaVqN6UxH7cm8LCjmPDu","type":"tool_result","content":"./app/Http/Services/Empresas/EmpresaService.php\n./app/Http/Services/Empresas/MigracionEmpresaService.php","is_error":false}]},"uuid":"8b448b58-72da-45ea-aa77-63cb967af7de","timestamp":"2026-01-25T01:51:44.593Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"8a9bd6a9-e132-430d-be67-ee8ed568bfbf","timestamp":"2026-01-25T01:51:44.641Z"}
{"parentUuid":"8a9bd6a9-e132-430d-be67-ee8ed568bfbf","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:51:46.130Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QuHXJigJbYYYeynGJuPe1g","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018Pb6sMiQtYQREQJ7cDwVWo","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && grep -n \"function getUno\\|public function getUno\" ./app/Http/Services/Empresas/EmpresaService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":213,"cache_read_input_tokens":50150,"cache_creation":{"ephemeral_5m_input_tokens":213,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFzKHmUxV9hdfF7uyrL","uuid":"fc01d43c-79ff-4b7d-a8a0-a6683ab6bd2e"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"29dba915-e929-4250-81e6-d295173b6dc0","timestamp":"2026-01-25T01:51:46.171Z"}
{"parentUuid":"29dba915-e929-4250-81e6-d295173b6dc0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018Pb6sMiQtYQREQJ7cDwVWo","type":"tool_result","content":"103:    public function getUno(int $id): ?Empresa {","is_error":false}]},"uuid":"3e1ab058-d7da-4553-9e1d-095ea41f876b","timestamp":"2026-01-25T01:51:47.292Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"9ef713c2-9780-426a-8f4d-5169a93a0a8c","timestamp":"2026-01-25T01:51:47.344Z"}
{"parentUuid":"9ef713c2-9780-426a-8f4d-5169a93a0a8c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:51:48.892Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01FsWxRoy84u943qnxNh2gcw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019orBD7K5WFjbZS9d2HeRpA","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","offset":103,"limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":413,"cache_read_input_tokens":50363,"cache_creation":{"ephemeral_5m_input_tokens":413,"ephemeral_1h_input_tokens":0},"output_tokens":18,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFzWo4XxqFTAQJMvGvB","uuid":"43096b99-f5b5-4771-a797-f085d99b0bb5"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"134d302a-88e3-42e4-b842-95a5a56f4ee3","timestamp":"2026-01-25T01:51:48.934Z"}
{"parentUuid":"134d302a-88e3-42e4-b842-95a5a56f4ee3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019orBD7K5WFjbZS9d2HeRpA","type":"tool_result","content":"   103→    public function getUno(int $id): ?Empresa {\n   104→        $empresa = $this->repositorio->getUnoBasico($id);\n   105→\n   106→        if (!is_null($empresa)) {\n   107→            $planes        = [];\n   108→            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   109→\n   110→            foreach ($tipos_pruebas as $tipo_prueba) {\n   111→                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n   112→                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n   113→\n   114→                if (!is_null($plan)) {\n   115→                    array_push($planes, $plan);\n   116→                }\n   117→            }\n   118→\n   119→            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n   120→                'empresa_id'         => $id,\n   121→                'con_relaciones'     => true,\n   122→                'validar_relaciones' => true,\n   123→                'en'                 => true,\n   124→                'campo'              => 'rol_id',\n   125→                'valores'            => [\n   126→                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n   127→                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n   128→                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n   129→                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n   130→                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n   131→                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   132→                    $this->rol_repositorio::ROL_EVALUADOR_ID\n   133→                ]\n   134→            ]));\n   135→\n   136→            $usuarios = $usuarios->map(function ($usuario) {\n   137→                $eliminar = false;\n   138→\n   139→                if (\n   140→                    !$usuario->usuario->tiene_agendas\n   141→                    && !$usuario->usuario->tiene_ofertas_laborales\n   142→                    && !$usuario->usuario->tiene_procesos\n   143→                    && !$usuario->usuario->tiene_procesos\n   144→                    && !$usuario->usuario->tiene_etapa_usuario\n   145→                ) {\n   146→                    $eliminar = true;\n   147→                }\n   148→\n   149→                $usuario->usuario->eliminar = $eliminar;\n   150→                return $usuario;\n   151→            });\n   152→\n   153→            $empresa->planes                         = $planes;\n   154→            $empresa->usuarios                       = $usuarios;\n   155→            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n   156→            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n   157→                'model_type' => $this->modelo,\n   158→                'modelo_id'  => $id\n   159→            ]));\n   160→            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n   161→        }\n   162→\n   163→        return $empresa;\n   164→    }\n   165→\n   166→    /**\n   167→     * Obtener todas las empresas.\n   168→     *\n   169→     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n   170→     *\n   171→     * @param Request $request Contenido de la petición.\n   172→     * @return Collection\n   173→     * @author Daniel Beltrán\n   174→     * @author Andres Gonzalez\n   175→     */\n   176→    public function getTodo(Request $request): Collection {\n   177→        $empresas      = $this->repositorio->getTodo($request);\n   178→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   179→        $coleccion     = [];\n   180→\n   181→        foreach ($empresas as $empresa) {\n   182→            $registro = $empresa;\n   183→\n   184→            foreach ($tipos_pruebas as $tipo_prueba) {\n   185→                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n   186→\n   187→                // Obtener el plan activo, si no tiene se obtiene el último plan asignado\n   188→                $registro[$llave] = $this->empresa_plan_repositorio->planActivo($empresa->id, $tipo_prueba->id);\n   189→\n   190→                if (is_null($registro[$llave])) {\n   191→                    $registro[$llave] = $this->empresa_plan_repositorio->ultimoPlanAsignado(new Request([\n   192→                        'empresa_id'             => $empresa->id,\n   193→                        'tipo_prueba_id'         => $tipo_prueba->id,\n   194→                        'excluir_estado_proximo' => true\n   195→                    ]));\n   196→                }\n   197→\n   198→                // Verificar si tiene un plan próximo adicional al plan actual\n   199→                if (!is_null($registro[$llave])) {\n   200→                    $plan_proximo                     = $this->empresa_plan_repositorio->planProximo($empresa->id, $tipo_prueba->id);\n   201→                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n   202→                }\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"4c68c872-1916-40f6-8f26-db25329bf919","timestamp":"2026-01-25T01:51:49.973Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"b0e130bc-3c9b-47fc-830e-bd6b489e1899","timestamp":"2026-01-25T01:51:50.029Z"}
{"parentUuid":"b0e130bc-3c9b-47fc-830e-bd6b489e1899","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:51:52.484Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_019g16my9i6ENjfBnB9J6tYm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016vAA53YQQoqZXALekiGsQR","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && find ./app/Models -name \"EmpresaPlan*\" -type f"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1812,"cache_read_input_tokens":50776,"cache_creation":{"ephemeral_5m_input_tokens":1812,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFzigvsGL8rrH9bykSQ","uuid":"607a0d63-1b3f-453c-bf61-7a2c4edbe6da"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"692e49de-95a0-438f-8b2c-a0b484c874bc","timestamp":"2026-01-25T01:51:52.524Z"}
{"parentUuid":"692e49de-95a0-438f-8b2c-a0b484c874bc","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016vAA53YQQoqZXALekiGsQR","type":"tool_result","content":"./app/Models/Empresas/EmpresaPlan.php\n./app/Models/Empresas/EmpresaPlanFuncionalidad.php","is_error":false}]},"uuid":"2e336628-e88e-49cd-98b9-2917ec2d7a39","timestamp":"2026-01-25T01:51:53.647Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"0deda2dc-daed-47e9-8603-b5df9edc05ea","timestamp":"2026-01-25T01:51:53.698Z"}
{"parentUuid":"0deda2dc-daed-47e9-8603-b5df9edc05ea","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:51:55.186Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_017E9QjztcnGugMKpynYcDiS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01T2ajHSHetmnB3DE7qCru7a","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":324,"cache_read_input_tokens":52588,"cache_creation":{"ephemeral_5m_input_tokens":324,"ephemeral_1h_input_tokens":0},"output_tokens":18,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTFzz59W2X3tDN6zC3Hp","uuid":"508377a5-ff99-408a-ba64-e5fc3f81265d"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"b8c1eebd-a7d8-43f8-ba3c-212f19fc928d","timestamp":"2026-01-25T01:51:55.224Z"}
{"parentUuid":"b8c1eebd-a7d8-43f8-ba3c-212f19fc928d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01T2ajHSHetmnB3DE7qCru7a","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Empresas;\n     4→\n     5→use App\\Models\\Planes\\Plan;\n     6→use App\\Models\\Usuarios\\User;\n     7→use App\\Models\\Planes\\Consumo;\n     8→use App\\Models\\Pruebas\\Prueba;\n     9→use OwenIt\\Auditing\\Auditable;\n    10→use App\\Models\\IA\\ConsumoCredito;\n    11→use App\\Models\\Planes\\EstadoPlan;\n    12→use App\\Models\\Planes\\PlanCredito;\n    13→use App\\Models\\Planes\\Funcionalidad;\n    14→use App\\Models\\Configuraciones\\Archivo;\n    15→use Illuminate\\Database\\Eloquent\\Model;\n    16→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n    17→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    18→use Illuminate\\Database\\Eloquent\\Relations\\MorphMany;\n    19→use Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n    20→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    21→\n    22→class EmpresaPlan extends Model implements AuditableContract\n    23→{\n    24→    use Auditable;\n    25→\n    26→    protected $table = 'empresas_planes';\n    27→\n    28→    protected $fillable = [\n    29→        'empresa_id',\n    30→        'plan_id',\n    31→        'plan_credito_id',\n    32→        'usuario_id',\n    33→        'estado_id',\n    34→        'unidades',\n    35→        'cantidad_ofertas_laborales',\n    36→        'cantidad_usuarios',\n    37→        'cantidad_pruebas',\n    38→        'creditos',\n    39→        'fecha_inicio',\n    40→        'fecha_vencimiento',\n    41→        'precio',\n    42→        'porcentaje_descuento',\n    43→        'numero_factura',\n    44→        'comentario',\n    45→        'plan_original',\n    46→        'renovando',\n    47→        'por_facturar'\n    48→    ];\n    49→\n    50→    protected $casts = [\n    51→        'plan_credito_id'   => 'integer',\n    52→        'creditos'          => 'integer',\n    53→        'fecha_inicio'      => 'date:Y-m-d',\n    54→        'fecha_vencimiento' => 'date:Y-m-d'\n    55→    ];\n    56→\n    57→    protected $appends = [\n    58→        'vigencia_dias',\n    59→        'creditos_restantes'\n    60→    ];\n    61→\n    62→    /**\n    63→     * Obtener el atributo vigencia_dias.\n    64→     *\n    65→     * @return int\n    66→     * @author Daniel Beltrán\n    67→     */\n    68→    public function getVigenciaDiasAttribute(): int {\n    69→        $vigencia = 0;\n    70→\n    71→        if (!is_null($this->fecha_vencimiento) && !is_null($this->fecha_inicio)) {\n    72→            $vigencia = $this->fecha_inicio->diffInDays($this->fecha_vencimiento);\n    73→        }\n    74→\n    75→        return $vigencia;\n    76→    }\n    77→\n    78→    /**\n    79→     * Obtener el atributo creditos_restantes.\n    80→     *\n    81→     * @return int\n    82→     * @author Sergio Vargas\n    83→     * @author Daniel Beltrán\n    84→     */\n    85→    public function getCreditosRestantesAttribute(): int {\n    86→        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    87→    }\n    88→\n    89→    /**\n    90→     * Relación de muchos a uno con empresas.\n    91→     *\n    92→     * @return BelongsTo\n    93→     * @author Daniel Beltrán\n    94→     */\n    95→    public function empresa(): BelongsTo {\n    96→        return $this->belongsTo(Empresa::class);\n    97→    }\n    98→\n    99→    /**\n   100→     * Relación de muchos a uno con planes.\n   101→     *\n   102→     * @return BelongsTo\n   103→     * @author Daniel Beltrán\n   104→     */\n   105→    public function plan(): BelongsTo {\n   106→        return $this->belongsTo(Plan::class);\n   107→    }\n   108→\n   109→    /**\n   110→     * Relación de muchos a uno con planes_creditos.\n   111→     *\n   112→     * @return BelongsTo\n   113→     * @author Sergio Vargas\n   114→     * @author Daniel Beltrán\n   115→     * @author Jair Carvajal\n   116→     */\n   117→    public function planCredito(): BelongsTo {\n   118→        return $this->belongsTo(PlanCredito::class, 'plan_credito_id')->withDefault([]);\n   119→    }\n   120→\n   121→    /**\n   122→     * Relación de uno a varios con users.\n   123→     *\n   124→     * @return BelongsTo\n   125→     * @author José Manuel Jiménez\n   126→     */\n   127→    public function usuario(): BelongsTo {\n   128→        return $this->belongsTo(User::class);\n   129→    }\n   130→\n   131→    /**\n   132→     * Relación de muchos a uno con estados_planes.\n   133→     *\n   134→     * @return BelongsTo\n   135→     * @author Daniel Beltrán\n   136→     */\n   137→    public function estado(): BelongsTo {\n   138→        return $this->belongsTo(EstadoPlan::class);\n   139→    }\n   140→\n   141→    /**\n   142→     * Relación de uno a muchos con consumos.\n   143→     *\n   144→     * @return HasMany\n   145→     * @author Daniel Beltrán\n   146→     */\n   147→    public function consumos(): HasMany {\n   148→        return $this->hasMany(Consumo::class, 'empresa_plan_id');\n   149→    }\n   150→\n   151→    /**\n   152→     * Relación de uno a muchos con consumos de créditos.\n   153→     *\n   154→     * @return HasMany\n   155→     * @author Sergio Vargas\n   156→     * @author Daniel Beltrán\n   157→     */\n   158→    public function consumosCreditos(): HasMany {\n   159→        return $this->hasMany(ConsumoCredito::class, 'empresa_plan_id');\n   160→    }\n   161→\n   162→    /**\n   163→     * Relación de muchos a muchos con pruebas.\n   164→     *\n   165→     * @return BelongsToMany\n   166→     * @author Daniel Beltrán\n   167→     */\n   168→    public function pruebas(): BelongsToMany {\n   169→        return $this->belongsToMany(Prueba::class, 'empresas_planes_pruebas', 'empresa_plan_id', 'prueba_id')->withTimestamps();\n   170→    }\n   171→\n   172→    /**\n   173→     * Relación polimórfica de uno a muchos con archivos.\n   174→     *\n   175→     * @return MorphMany\n   176→     * @author Daniel Beltrán\n   177→     */\n   178→    public function archivos(): MorphMany {\n   179→        return $this->morphMany(Archivo::class, 'modelo', 'modelo', 'modelo_id');\n   180→    }\n   181→\n   182→    /**\n   183→     * Relación de muchos a muchos con funcionalidades.\n   184→     *\n   185→     * @return BelongsToMany\n   186→     * @author Daniel Beltrán\n   187→     */\n   188→    public function funcionalidades(): BelongsToMany {\n   189→        return $this->belongsToMany(Funcionalidad::class, 'empresas_planes_funcionalidades', 'empresa_plan_id', 'funcionalidad_id')->withTimestamps();\n   190→    }\n   191→\n   192→    /**\n   193→     * Determinar si es un plan solo de creditos (sin plan base).\n   194→     *\n   195→     * @return bool\n   196→     * @author Sergio Vargas\n   197→     */\n   198→    public function esSoloPlanCreditos(): bool {\n   199→        return !is_null($this->plan_credito_id) && is_null($this->plan_id);\n   200→    }\n   201→\n   202→    /**\n   203→     * Determinar si es un plan hibrido (plan base + creditos).\n   204→     *\n   205→     * @return bool\n   206→     * @author Sergio Vargas\n   207→     */\n   208→    public function esPlanHibrido(): bool {\n   209→        return !is_null($this->plan_id) && !is_null($this->plan_credito_id);\n   210→    }\n   211→\n   212→    /**\n   213→     * Determinar si tiene creditos asignados.\n   214→     *\n   215→     * @return bool\n   216→     * @author Sergio Vargas\n   217→     */\n   218→    public function tieneCreditos(): bool {\n   219→        return !is_null($this->plan_credito_id) || $this->creditos > 0;\n   220→    }\n   221→\n   222→    /**\n   223→     * Verificar si los creditos estan agotados.\n   224→     *\n   225→     * @return bool\n   226→     * @author Sergio Vargas\n   227→     */\n   228→    public function creditosAgotados(): bool {\n   229→        if (!$this->tieneCreditos()) {\n   230→            return false;\n   231→        }\n   232→\n   233→        return $this->creditos_restantes <= 0;\n   234→    }\n   235→}\n   236→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"8840ab6d-9849-4b14-ba8a-2fdf550aee9c","timestamp":"2026-01-25T01:51:56.203Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"6462e389-4487-46c2-9c50-b8b1b250f422","timestamp":"2026-01-25T01:51:56.256Z"}
{"parentUuid":"6462e389-4487-46c2-9c50-b8b1b250f422","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:51:58.718Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01H8jJDVAY8EStEMp9HXYLy5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YbEuqsrs8SoLVWbLRLPGP3","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && find ./app/Http/Repositories -name \"*EmpresaPlan*\" -type f"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":2980,"cache_read_input_tokens":52912,"cache_creation":{"ephemeral_5m_input_tokens":2980,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTG1BK4zFrXZpz83eahG","uuid":"c40f8966-d508-4599-bb49-2048715cba65"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"c8a7c03a-1b01-48b1-9deb-15d3b61115b2","timestamp":"2026-01-25T01:51:58.760Z"}
{"parentUuid":"c8a7c03a-1b01-48b1-9deb-15d3b61115b2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YbEuqsrs8SoLVWbLRLPGP3","type":"tool_result","content":"./app/Http/Repositories/Empresas/EmpresaPlanFuncionalidadRepository.php\n./app/Http/Repositories/Empresas/EmpresaPlanRepository.php","is_error":false}]},"uuid":"d55024aa-9656-4436-8264-b110c8ef74e7","timestamp":"2026-01-25T01:51:59.849Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"6e9aafeb-5bab-4bbe-86b1-ea28daa9406e","timestamp":"2026-01-25T01:51:59.898Z"}
{"parentUuid":"6e9aafeb-5bab-4bbe-86b1-ea28daa9406e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:52:01.297Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CEPYXAvsufEZaduzhu6D96","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WPnxDiZL9GCQqDqGsGgS5x","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":459,"cache_read_input_tokens":55892,"cache_creation":{"ephemeral_5m_input_tokens":459,"ephemeral_1h_input_tokens":0},"output_tokens":18,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTG1SSAP35DG2KbQNCgU","uuid":"a3855cee-212a-4d90-b47c-e1fa91c99396"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"a86ebb44-e1cb-4231-b30a-40971af202fa","timestamp":"2026-01-25T01:52:01.334Z"}
{"parentUuid":"a86ebb44-e1cb-4231-b30a-40971af202fa","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WPnxDiZL9GCQqDqGsGgS5x","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\Empresas;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\Pruebas\\TipoPrueba;\n     7→use Illuminate\\Support\\Collection;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use App\\Http\\Repositories\\BaseRepository;\n    11→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    12→use App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n    13→\n    14→class EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n    15→{\n    16→    /**\n    17→     * Ids de los roles de tipo empresa.\n    18→     *\n    19→     * @var array\n    20→     * @author Fahibram Cárcamo\n    21→     */\n    22→    private const IDS_ROLES_TIPO_EMPRESA = [\n    23→        RolRepository::ROL_PROPIETARIO_ID,\n    24→        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n    25→        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n    26→        RolRepository::ROL_EVALUADOR_ID\n    27→    ];\n    28→\n    29→    private $consulta_conteo_total_usuarios_empresa_sucursales;\n    30→\n    31→    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n    32→\n    33→    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n    39→     * @return void\n    40→     * @author Daniel Beltrán\n    41→     * @author Fahibram Cárcamo\n    42→     */\n    43→    public function __construct(EmpresaPlan $modelo) {\n    44→        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n    45→            (\n    46→                SELECT COUNT(DISTINCT eu.usuario_id)\n    47→                FROM empresas_usuarios AS eu\n    48→                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n    49→                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n    50→                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n    51→            ) AS conteo_total_usuarios_empresa_sucursales\n    52→        ';\n    53→\n    54→        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n    55→            (\n    56→                SELECT COUNT(*)\n    57→                FROM consumos\n    58→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    59→                WHERE (\n    60→                    consumos.empresa_id = empresas_planes.empresa_id\n    61→                    OR suc.empresa_id = empresas_planes.empresa_id\n    62→                )\n    63→                AND consumos.agenda_id IS NOT NULL\n    64→            ) AS conteo_total_consumos_agendas_empresa_sucursales\n    65→        ';\n    66→\n    67→        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n    68→            (\n    69→                SELECT COUNT(*)\n    70→                FROM consumos\n    71→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    72→                WHERE (\n    73→                    consumos.empresa_id = empresas_planes.empresa_id\n    74→                    OR suc.empresa_id = empresas_planes.empresa_id\n    75→                )\n    76→                AND consumos.oferta_laboral_id IS NOT NULL\n    77→            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n    78→        ';\n    79→\n    80→        parent::__construct($modelo);\n    81→    }\n    82→\n    83→    /**\n    84→     * Obtener todos los planes de empresas.\n    85→     *\n    86→     * @param Request $request Contenido de la petición.\n    87→     * @return Collection\n    88→     * @author Daniel Beltrán\n    89→     * @author Fahibram Cárcamo\n    90→     * @author Jair Carvajal\n    91→     * @author Andres Gonzalez\n    92→     */\n    93→    public function getTodo(Request $request): Collection {\n    94→        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n    95→            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    96→        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n    97→            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n    98→        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n    99→            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n   100→        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n   101→            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n   102→        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n   103→            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n   104→\n   105→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   106→        ->with([\n   107→            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n   108→            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   109→            'plan.tipoPrueba:id,nombre',\n   110→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   111→            'estado:id,nombre',\n   112→            'pruebas:id,nombre',\n   113→            'funcionalidades:id,nombre,predeterminado',\n   114→            'archivos' => function ($archivos) {\n   115→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   116→            }\n   117→        ])\n   118→        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   119→            $query->with([\n   120→                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   121→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   122→                        ->with(['empresa' => function ($empresa) {\n   123→                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n   124→                        }])\n   125→                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n   126→                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n   127→                },\n   128→                'consumos.agenda:id,prueba_id',\n   129→                'consumos.agenda.prueba:id,nombre,slug'\n   130→            ]);\n   131→        })\n   132→        ->when($con_conteo_consumos_agendas, function ($consulta) {\n   133→            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   134→        })\n   135→        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n   136→            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   137→        })\n   138→        ->when($con_conteo_consumos_creditos, function ($consulta) {\n   139→            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n   140→        })\n   141→        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n   142→            $query->where('empresa_id', $request->empresa_id);\n   143→        })\n   144→        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n   145→            $query->whereHas('plan', function ($plan) use ($request) {\n   146→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   147→            });\n   148→        })\n   149→        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n   150→            $query->whereHas('plan', function ($plan) use ($request) {\n   151→                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n   152→            });\n   153→        })\n   154→        ->when($request->filled('plan_id'), function ($query) use ($request) {\n   155→            $query->where('plan_id', $request->plan_id);\n   156→        })\n   157→        ->when(\n   158→            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n   159→            function ($query) use ($request) {\n   160→                $query->whereIn($request->campo, $request->valores);\n   161→            }\n   162→        )\n   163→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   164→            $consulta->whereIn('estado_id', $request->estado_id);\n   165→        })\n   166→        ->when(\n   167→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   168→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   169→        )\n   170→        ->when(\n   171→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   172→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   173→        )\n   174→        ->when(\n   175→            $request->filled('fecha_vencimiento_desde'),\n   176→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   177→        )\n   178→        ->when(\n   179→            $request->filled('fecha_vencimiento_hasta'),\n   180→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   181→        )\n   182→        ->when(\n   183→            $request->filled('fecha_inicio_desde'),\n   184→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   185→        )\n   186→        ->when(\n   187→            $request->filled('fecha_inicio_hasta'),\n   188→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   189→        )\n   190→        ->orderBy('created_at', 'DESC')\n   191→        ->get();\n   192→    }\n   193→\n   194→    /**\n   195→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n   196→     *\n   197→     * @param Request $request Contenido de la petición HTTP entrante.\n   198→     * @return Collection\n   199→     * @author Fahibram Cárcamo\n   200→     * @author Jair Carvajal\n   201→     */\n   202→    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n   203→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   204→            ->addSelect([\n   205→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   206→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   207→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   208→            ])\n   209→            ->whereExists(function ($subconsulta) {\n   210→                $subconsulta->select(DB::raw(1))\n   211→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   212→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   213→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   214→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   215→            })\n   216→            ->with([\n   217→                'estado:id,nombre',\n   218→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   219→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n   220→            ])\n   221→            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n   222→            ->when(\n   223→                $request->filled('tipo_prueba_id'),\n   224→                function ($consulta) use ($request) {\n   225→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   226→                },\n   227→                function ($consulta) {\n   228→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   229→                        TipoPrueba::SELECCION_ID,\n   230→                        TipoPrueba::ORGANIZACIONAL_ID,\n   231→                        TipoPrueba::VOCACIONAL_ID\n   232→                    ]));\n   233→                }\n   234→            )\n   235→            ->get();\n   236→    }\n   237→\n   238→    /**\n   239→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n   240→     *\n   241→     * @param Request $request Contenido de la petición HTTP entrante.\n   242→     * @return Collection\n   243→     * @author Fahibram Cárcamo\n   244→     * @author Andres Gonzalez\n   245→     * @author Jair Carvajal\n   246→     */\n   247→    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n   248→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   249→            ->addSelect([\n   250→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   251→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   252→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   253→            ])\n   254→            ->whereExists(function ($sub_consulta) {\n   255→                $sub_consulta->select(DB::raw(1))\n   256→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   257→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   258→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   259→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   260→            })\n   261→            ->with([\n   262→                'estado:id,nombre',\n   263→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   264→                'plan.tipoPrueba:id,nombre',\n   265→                'pruebas:id,nombre,slug',\n   266→                'funcionalidades:id,nombre,predeterminado',\n   267→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n   268→                'consumos' => function ($consumos) {\n   269→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   270→                        ->with([\n   271→                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   272→                            'agenda:id,prueba_id',\n   273→                            'agenda.prueba:id,nombre,slug'\n   274→                        ]);\n   275→                }\n   276→            ])\n   277→            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   278→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   279→            })\n   280→            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   281→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n   282→            })\n   283→            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n   284→                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n   285→                    $sub_consulta->where('empresa_id', $request->empresa_id)\n   286→                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n   287→                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n   288→                        });\n   289→                });\n   290→            })\n   291→            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   292→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   293→            }, function ($consulta) {\n   294→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   295→                    TipoPrueba::SELECCION_ID,\n   296→                    TipoPrueba::ORGANIZACIONAL_ID,\n   297→                    TipoPrueba::VOCACIONAL_ID\n   298→                ]));\n   299→            })\n   300→            ->orderBy('created_at', 'DESC')\n   301→            ->get();\n   302→    }\n   303→\n   304→    /**\n   305→     * Obtener datos básicos de los planes de empresas.\n   306→     *\n   307→     * @param Request $request Contenido de la petición.\n   308→     * @return Collection\n   309→     * @author Daniel Beltrán\n   310→     * @author Fahibram Cárcamo\n   311→     * @author Jair Carvajal\n   312→     * @author Sergio Vargas\n   313→     */\n   314→    public function getDatosBasicos(Request $request): Collection {\n   315→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   316→        ->with([\n   317→            'plan:id,tipo_prueba_id,nombre',\n   318→            'planCredito:id,nombre,creditos',\n   319→            'consumosCreditos'\n   320→        ])\n   321→        ->withCount([\n   322→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   323→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n   324→        ])\n   325→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   326→            $consulta->where('empresa_id', $request->empresa_id);\n   327→        })\n   328→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   329→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   330→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   331→            });\n   332→        })\n   333→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   334→            $consulta->whereIn('estado_id', $request->estados_ids);\n   335→        })\n   336→        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n   337→            $sentido = $request->ordenar_sentido ?? 'ASC';\n   338→            $consulta->orderBy($request->ordenar_por, $sentido);\n   339→        })\n   340→        ->get();\n   341→    }\n   342→\n   343→    /**\n   344→     * Obtener el proximo plan de creditos de la empresa.\n   345→     *\n   346→     * @param int $empresa_id ID de la empresa.\n   347→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   348→     * @return EmpresaPlan|null\n   349→     * @author Sergio Vargas\n   350→     */\n   351→    public function planProximoCreditos(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   352→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   353→        ->with(['planCredito:id,nombre,creditos,precio'])\n   354→        ->where([\n   355→            'empresa_id' => $empresa_id,\n   356→            'estado_id'  => 3\n   357→        ])\n   358→        ->whereNotNull('plan_credito_id')\n   359→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   360→            $query->where(function ($q) use ($tipo_prueba_id) {\n   361→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   362→                  ->orWhereNull('plan_id');\n   363→            });\n   364→        })\n   365→        ->orderBy('created_at', 'ASC')\n   366→        ->first();\n   367→    }\n   368→\n   369→    /**\n   370→     * Obtener el plan de creditos activo de la empresa.\n   371→     *\n   372→     * @param int $empresa_id ID de la empresa.\n   373→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   374→     * @return EmpresaPlan|null\n   375→     * @author Sergio Vargas\n   376→     */\n   377→    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   378→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   379→        ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n   380→        ->where('empresa_id', $empresa_id)\n   381→        ->whereNotNull('plan_credito_id')\n   382→        ->whereIn('estado_id', [1, 4])\n   383→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   384→            $query->where(function ($q) use ($tipo_prueba_id) {\n   385→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   386→                  ->orWhereNull('plan_id');\n   387→            });\n   388→        })\n   389→        ->first();\n   390→    }\n   391→\n   392→    /**\n   393→     * Obtener un plan de empresa.\n   394→     *\n   395→     * @param int $id ID del plan de empresa.\n   396→     * @return EmpresaPlan|null\n   397→     * @author Daniel Beltrán\n   398→     * @author Jair Carvajal\n   399→     */\n   400→    public function getUno(int $id): ?EmpresaPlan {\n   401→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   402→        ->with([\n   403→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n   404→            'plan.tipoPrueba:id,nombre',\n   405→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   406→            'estado:id,nombre',\n   407→            'pruebas:id,nombre,slug',\n   408→            'funcionalidades:id,nombre,llave,valor',\n   409→            'archivos' => function ($archivos) {\n   410→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   411→            }\n   412→        ])\n   413→        ->find($id);\n   414→    }\n   415→\n   416→    /**\n   417→     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n   418→     *\n   419→     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n   420→     *\n   421→     * @param int $empresa_id ID de la empresa.\n   422→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   423→     * @return EmpresaPlan|null\n   424→     * @author Daniel Beltrán\n   425→     * @author Fahibram Cárcamo\n   426→     * @author José Manuel Jiménez\n   427→     * @author Andres Gonzalez\n   428→     * @author Sergio Vargas\n   429→     * @author Jair Carvajal\n   430→     */\n   431→    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   432→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   433→        ->with([\n   434→            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n   435→            'plan.tipoPrueba:id,nombre',\n   436→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   437→            'estado:id,nombre',\n   438→            'pruebas:id,nombre,slug',\n   439→            'usuario:id,nombres,apellidos',\n   440→            'archivos' => function ($archivos) {\n   441→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   442→                ->orderBy('created_at', 'DESC');\n   443→            }\n   444→        ])\n   445→        ->withCount([\n   446→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   447→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n   448→            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n   449→        ])\n   450→        ->where('empresa_id', $empresa_id)\n   451→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   452→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   453→        })\n   454→        ->whereIn('estado_id', [1, 4])\n   455→        ->first();\n   456→    }\n   457→\n   458→    /**\n   459→     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n   460→     *\n   461→     * @param int $empresa_id ID de la empresa.\n   462→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   463→     * @return EmpresaPlan|null\n   464→     * @author Daniel Beltrán\n   465→     * @author Jair Carvajal\n   466→     */\n   467→    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   468→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   469→        ->with([\n   470→            'plan:id,tipo_prueba_id,nombre',\n   471→            'plan.tipoPrueba:id,nombre',\n   472→            'estado:id,nombre',\n   473→            'pruebas:id,nombre',\n   474→            'archivos' => function ($archivos) {\n   475→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   476→                ->orderBy('created_at', 'DESC');\n   477→            }\n   478→        ])\n   479→        ->where([\n   480→            'empresa_id' => $empresa_id,\n   481→            'estado_id'  => 3\n   482→        ])\n   483→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   484→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   485→        })\n   486→        ->first();\n   487→    }\n   488→\n   489→    /**\n   490→     * Obtener el último plan asignado.\n   491→     *\n   492→     * @param Request $request Contenido de la petición.\n   493→     * @return EmpresaPlan|null\n   494→     * @author Daniel Beltrán\n   495→     * @author Jair Carvajal\n   496→     */\n   497→    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n   498→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   499→        ->with([\n   500→            'plan:id,tipo_prueba_id,nombre',\n   501→            'plan.tipoPrueba:id,nombre',\n   502→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   503→            'estado:id,nombre',\n   504→            'pruebas:id,nombre',\n   505→            'archivos' => function ($archivos) {\n   506→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   507→                ->orderBy('created_at', 'DESC');\n   508→            }\n   509→        ])\n   510→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   511→            $consulta->where('empresa_id', $request->empresa_id);\n   512→        })\n   513→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   514→            $consulta->where('estado_id', $request->estado_id);\n   515→        })\n   516→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   517→            $consulta->whereIn('estado_id', $request->estados_ids);\n   518→        })\n   519→        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   520→            $consulta->where('estado_id', '!=', 3);\n   521→        })\n   522→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   523→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   524→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   525→            });\n   526→        })\n   527→        ->orderBy('created_at', 'DESC')\n   528→        ->first();\n   529→    }\n   530→\n   531→    /**\n   532→     * Sincronizar pruebas.\n   533→     *\n   534→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   535→     * @param array $pruebas ID's de las pruebas.\n   536→     * @return void\n   537→     * @author Daniel Beltrán\n   538→     */\n   539→    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n   540→        $empresa_plan->pruebas()->sync($pruebas);\n   541→    }\n   542→\n   543→    /**\n   544→     * Sincronizar funcionalidades.\n   545→     *\n   546→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   547→     * @param array $funcionalidades ID's de las funcionalidades.\n   548→     * @return void\n   549→     * @author Daniel Beltrán\n   550→     */\n   551→    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n   552→        $empresa_plan->funcionalidades()->sync($funcionalidades);\n   553→    }\n   554→\n   555→    /**\n   556→     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n   557→     *\n   558→     * @param Request $request Contenido de la petición.\n   559→     * @return ?EmpresaPlan\n   560→     * @author Fahibram Cárcamo\n   561→     * @author Jair Carvajal\n   562→     */\n   563→    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n   564→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   565→        ->with([\n   566→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n   567→            'plan.tipoPrueba:id,nombre',\n   568→            'estado:id,nombre',\n   569→            'pruebas:id,nombre',\n   570→            'funcionalidades:id,nombre,llave,valor'\n   571→        ])\n   572→        ->when(\n   573→            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n   574→            function ($consulta) {\n   575→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   576→            }\n   577→        )\n   578→        ->when(\n   579→            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n   580→            function ($consulta) {\n   581→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   582→            }\n   583→        )\n   584→        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n   585→        ->first();\n   586→    }\n   587→\n   588→    /**\n   589→     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n   590→     *\n   591→     * @return Collection\n   592→     * @author Fahibram Cárcamo\n   593→     * @author Andres Gonzalez\n   594→     * @author José Manuel Jiménez\n   595→     * @author Jair Carvajal\n   596→     * @author Daniel Beltrán\n   597→     */\n   598→    public function datosConsumosEmpresas(Request $request): Collection {\n   599→        $roles_tipo_empresa_ids = [\n   600→            RolRepository::ROL_PROPIETARIO_ID,\n   601→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   602→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   603→            RolRepository::ROL_EVALUADOR_ID\n   604→        ];\n   605→\n   606→        $matriz_conteos = [\n   607→            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n   608→            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n   609→            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n   610→                'empresasUsuarios',\n   611→                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n   612→            )\n   613→        ];\n   614→\n   615→        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n   616→\n   617→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   618→            ->addSelect([\n   619→                DB::raw('\n   620→                    (\n   621→                        SELECT COUNT(DISTINCT eu.usuario_id)\n   622→                        FROM empresas_usuarios AS eu\n   623→                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n   624→                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n   625→                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n   626→                    ) AS conteo_total_usuarios_empresa_sucursales\n   627→                '),\n   628→                DB::raw('\n   629→                    (\n   630→                        SELECT COUNT(*)\n   631→                        FROM consumos\n   632→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   633→                        WHERE (\n   634→                            consumos.empresa_id = empresas_planes.empresa_id\n   635→                            OR suc.empresa_id = empresas_planes.empresa_id\n   636→                        )\n   637→                        AND consumos.agenda_id IS NOT NULL\n   638→                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n   639→                '),\n   640→                DB::raw('\n   641→                    (\n   642→                        SELECT COUNT(*)\n   643→                        FROM consumos\n   644→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   645→                        WHERE (\n   646→                            consumos.empresa_id = empresas_planes.empresa_id\n   647→                            OR suc.empresa_id = empresas_planes.empresa_id\n   648→                        )\n   649→                        AND consumos.oferta_laboral_id IS NOT NULL\n   650→                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n   651→                '),\n   652→            ])\n   653→            ->with([\n   654→                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n   655→                'plan.tipoPrueba:id,nombre',\n   656→                'pruebas:id,nombre,slug',\n   657→                'estado:id,nombre',\n   658→                'usuario:id,nombres,apellidos',\n   659→                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n   660→                    $consulta_empresa->select($campos_empresas)\n   661→                        ->whereNull('empresa_id')\n   662→                        ->withCount([\n   663→                            ...$matriz_conteos,\n   664→                            'sucursales as conteo_sucursales'\n   665→                        ])\n   666→                        ->with([\n   667→                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n   668→                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n   669→                            }\n   670→                        ]);\n   671→                }\n   672→            ])\n   673→            ->when(\n   674→                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n   675→                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n   676→            )\n   677→            ->whereNotIn('estado_id', [3, 8])\n   678→            ->when(\n   679→                $request->filled('prueba_id'),\n   680→                fn($consulta) => $consulta->whereHas(\n   681→                    'pruebas',\n   682→                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n   683→                )\n   684→            )\n   685→            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n   686→                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n   687→            })\n   688→            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n   689→                switch ($request->plan_por) {\n   690→                    case 'por unidades':\n   691→                        $consulta_plan_por->whereNotNull('unidades');\n   692→                        break;\n   693→\n   694→                    case 'por ofertas laborales':\n   695→                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n   696→                        break;\n   697→\n   698→                    case 'por tiempo':\n   699→                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n   700→                        break;\n   701→                }\n   702→            })\n   703→            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n   704→                $fecha_inicio = $request->fecha_vencimiento;\n   705→                $fecha_fin    = $request->fecha_vencimiento;\n   706→\n   707→                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n   708→                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n   709→                    $fecha_inicio = $fechas[0];\n   710→                    $fecha_fin    = $fechas[1];\n   711→                }\n   712→\n   713→                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n   714→            })\n   715→            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n   716→                $fecha_inicio = $request->fecha_inicio;\n   717→                $fecha_fin    = $request->fecha_inicio;\n   718→\n   719→                if (strpos($request->fecha_inicio, ' a ') !== false) {\n   720→                    $fechas       = explode(' a ', $request->fecha_inicio);\n   721→                    $fecha_inicio = $fechas[0];\n   722→                    $fecha_fin    = $fechas[1];\n   723→                }\n   724→\n   725→                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n   726→            })\n   727→            ->when(\n   728→                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   729→                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n   730→            )\n   731→            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n   732→                if ($request->tipo_activacion === 'compra') {\n   733→                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n   734→                        $subconsulta->select(DB::raw(1))\n   735→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   736→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   737→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   738→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   739→                    });\n   740→                } elseif ($request->tipo_activacion === 'recompra') {\n   741→                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n   742→                        $subconsulta->select(DB::raw(1))\n   743→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   744→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   745→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   746→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   747→                    });\n   748→                }\n   749→            })\n   750→            ->get();\n   751→    }\n   752→\n   753→    /**\n   754→     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n   755→     *\n   756→     * @param Request $request Contenido de la petición HTTP entrante.\n   757→     * @return Collection\n   758→     * @author Fahibram Cárcamo\n   759→     */\n   760→    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n   761→        return $this->modelo::select(\n   762→            'empresas_planes.id',\n   763→            'empresas_planes.empresa_id',\n   764→            'empresas_planes.plan_id',\n   765→            'empresas_planes.plan_credito_id',\n   766→            'empresas_planes.usuario_id',\n   767→            'empresas_planes.estado_id',\n   768→            'empresas_planes.unidades',\n   769→            'empresas_planes.cantidad_ofertas_laborales',\n   770→            'empresas_planes.cantidad_usuarios',\n   771→            'empresas_planes.cantidad_pruebas',\n   772→            'empresas_planes.creditos',\n   773→            'empresas_planes.fecha_inicio',\n   774→            'empresas_planes.fecha_vencimiento',\n   775→            'empresas_planes.precio',\n   776→            'empresas_planes.porcentaje_descuento',\n   777→            'empresas_planes.numero_factura',\n   778→            'empresas_planes.comentario',\n   779→            'empresas_planes.plan_original',\n   780→            'empresas_planes.renovando',\n   781→            'empresas_planes.por_facturar',\n   782→            'empresas_planes.created_at',\n   783→            'planes.id',\n   784→            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n   785→            'planes.nombre AS plan_nombre',\n   786→            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n   787→            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n   788→            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n   789→            'planes.unidades AS plan_unidades',\n   790→            'planes.vigencia AS plan_vigencia',\n   791→            'planes.precio AS plan_precio',\n   792→            'tipos_pruebas.id AS tipo_prueba_id',\n   793→            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n   794→            'estados_planes.id AS estado_plan_id',\n   795→            'estados_planes.nombre AS estado_plan_nombre',\n   796→            'users.id AS usuario_usuario_id',\n   797→            'users.nombres AS usuario_nombres',\n   798→            'users.apellidos AS usuario_apellidos',\n   799→            'empresas.id AS empresa_empresa_id',\n   800→            'empresas.empresa_id',\n   801→            'empresas.nombre_comercial AS empresa_nombre_comercial',\n   802→            'empresas.razon_social AS empresa_razon_social',\n   803→            'empresas.nombre_contacto',\n   804→            'empresas.celular_contacto',\n   805→            'empresas.email_contacto',\n   806→            'empresas.telefono_contacto',\n   807→            'empresas.extension_contacto',\n   808→            'empresas.nombre_tesorero',\n   809→            'empresas.celular_tesorero',\n   810→            'empresas.telefono_tesorero',\n   811→            'empresas.email_tesorero',\n   812→            DB::raw('\n   813→                (\n   814→                    SELECT COUNT(*)\n   815→                    FROM consumos\n   816→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n   817→                )\n   818→                AS conteo_consumos_agendas\n   819→            '),\n   820→            DB::raw('\n   821→                (\n   822→                    SELECT COUNT(*)\n   823→                    FROM consumos\n   824→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n   825→                )\n   826→                AS conteo_consumos_ofertas_laborales\n   827→            '),\n   828→            DB::raw('\n   829→                (\n   830→                    SELECT COUNT(*)\n   831→                    FROM empresas\n   832→                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n   833→                )\n   834→                AS conteo_sucursales\n   835→            '),\n   836→            DB::raw('\n   837→                (\n   838→                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n   839→                    FROM empresas AS sucursales\n   840→                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n   841→                )\n   842→                AS nombres_comerciales_sucursales\n   843→            ')\n   844→        )\n   845→        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n   846→        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n   847→        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n   848→        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n   849→        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n   850→        ->whereNull('empresas.empresa_id')\n   851→        ->when(\n   852→            $request->filled('plan_por'),\n   853→            function ($consulta) use ($request) {\n   854→                switch ($request->plan_por) {\n   855→                    case 'por unidades':\n   856→                        $consulta->whereNotNull('empresas_planes.unidades');\n   857→                        break;\n   858→\n   859→                    case 'por ofertas laborales':\n   860→                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n   861→                        break;\n   862→\n   863→                    case 'por tiempo':\n   864→                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n   865→                        break;\n   866→                }\n   867→            }\n   868→        )\n   869→        ->when(\n   870→            $request->filled('tipo_prueba_id'),\n   871→            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n   872→            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n   873→                TipoPrueba::SELECCION_ID,\n   874→                TipoPrueba::ORGANIZACIONAL_ID,\n   875→                TipoPrueba::VOCACIONAL_ID\n   876→            ])\n   877→        )\n   878→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n   879→        ->when(\n   880→            $request->filled('ejecutivo_id'),\n   881→            function ($consulta) use ($request) {\n   882→                $consulta->whereExists(function ($subconsulta) use ($request) {\n   883→                    $subconsulta->select(DB::raw(1))\n   884→                        ->from('empresas_usuarios')\n   885→                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n   886→                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n   887→                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n   888→                });\n   889→            }\n   890→        )\n   891→        ->when(\n   892→            $request->filled('fecha_vencimiento'),\n   893→            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n   894→        )\n   895→        ->when(\n   896→            $request->filled('fecha_inicio'),\n   897→            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n   898→        )\n   899→        ->when(\n   900→            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   901→            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n   902→        )\n   903→        ->get();\n   904→    }\n   905→\n   906→    /**\n   907→     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n   908→     *\n   909→     * @param int $empresa_id ID de la empresa.\n   910→     * @param Request $request Contenido de la peticion.\n   911→     * @return Collection\n   912→     * @author Sergio Vargas\n   913→     */\n   914→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   915→        return $this->modelo::select(\n   916→            'id',\n   917→            'empresa_id',\n   918→            'plan_credito_id',\n   919→            'estado_id',\n   920→            'creditos',\n   921→            'fecha_inicio',\n   922→            'fecha_vencimiento',\n   923→            'precio',\n   924→            'porcentaje_descuento',\n   925→            'numero_factura',\n   926→            'comentario',\n   927→            'created_at'\n   928→        )\n   929→        ->with([\n   930→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   931→            'estado:id,nombre',\n   932→            'archivos' => function ($archivos) {\n   933→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   934→                    ->orderBy('created_at', 'DESC');\n   935→            }\n   936→        ])\n   937→        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n   938→        ->where('empresa_id', $empresa_id)\n   939→        ->whereNotNull('plan_credito_id')\n   940→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n   941→        ->when(\n   942→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   943→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   944→        )\n   945→        ->when(\n   946→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   947→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   948→        )\n   949→        ->when(\n   950→            $request->filled('fecha_vencimiento_desde'),\n   951→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   952→        )\n   953→        ->when(\n   954→            $request->filled('fecha_vencimiento_hasta'),\n   955→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   956→        )\n   957→        ->when(\n   958→            $request->filled('fecha_inicio_desde'),\n   959→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   960→        )\n   961→        ->when(\n   962→            $request->filled('fecha_inicio_hasta'),\n   963→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   964→        )\n   965→        ->orderBy('created_at', 'DESC')\n   966→        ->get();\n   967→    }\n   968→}\n   969→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"bfc993cd-16a3-4e43-8cf8-4569e113da17","timestamp":"2026-01-25T01:52:02.595Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"eeb84c16-26e7-4d24-af48-1ad1b934e3a5","timestamp":"2026-01-25T01:52:02.641Z"}
{"parentUuid":"eeb84c16-26e7-4d24-af48-1ad1b934e3a5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:52:05.658Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01488MdHbWxS4p6P7CqpXP25","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GiDo9cVwpqeoXNEHtkXM3r","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && find ./app/Http/Services -name \"*EmpresaPlan*\" -type f"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":17847,"cache_read_input_tokens":56351,"cache_creation":{"ephemeral_5m_input_tokens":17847,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTG1eauFt2awg3NuSrpZ","uuid":"e71528db-4fdc-4933-98af-3b936ac4a8db"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"fa44db9b-5bb0-42ac-80fb-3d439e02f6c5","timestamp":"2026-01-25T01:52:05.695Z"}
{"parentUuid":"fa44db9b-5bb0-42ac-80fb-3d439e02f6c5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GiDo9cVwpqeoXNEHtkXM3r","type":"tool_result","content":"./app/Http/Services/Empresas/EmpresaPlanService.php","is_error":false}]},"uuid":"98430958-b1e6-4ade-9a91-569d295f0bc4","timestamp":"2026-01-25T01:52:06.910Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"6e92028a-b437-40e3-b2c3-0095be30d3be","timestamp":"2026-01-25T01:52:06.960Z"}
{"parentUuid":"6e92028a-b437-40e3-b2c3-0095be30d3be","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:52:08.646Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JptWuMue8VihSGaDvXbdeE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HEgkSPoaqej6jFyHBx2E2x","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && grep -n \"function obtenerPlanActivo\\|public function obtenerPlanActivo\" ./app/Http/Services/Empresas/EmpresaPlanService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":195,"cache_read_input_tokens":74198,"cache_creation":{"ephemeral_5m_input_tokens":195,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTG1xgq4hf3B1W9PjFYf","uuid":"e4fc52aa-c35c-422f-b440-0ec97e30e03d"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"7afd9457-0e4e-40aa-b9b3-9e87fa8c9657","timestamp":"2026-01-25T01:52:08.685Z"}
{"parentUuid":"7afd9457-0e4e-40aa-b9b3-9e87fa8c9657","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HEgkSPoaqej6jFyHBx2E2x","type":"tool_result","content":"534:    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {","is_error":false}]},"uuid":"d7db3466-989f-465a-9ece-e5900f817ab9","timestamp":"2026-01-25T01:52:09.765Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"26dfc2fb-8131-4e08-963a-ea522f127040","timestamp":"2026-01-25T01:52:09.812Z"}
{"parentUuid":"26dfc2fb-8131-4e08-963a-ea522f127040","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:52:11.533Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01F96LVCkdgPUXAsfW3CncbU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B4kskfhPc7s8vGCS4Esenc","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","offset":534,"limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":195,"cache_read_input_tokens":74393,"cache_creation":{"ephemeral_5m_input_tokens":195,"ephemeral_1h_input_tokens":0},"output_tokens":18,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTG2AtoGMBEiA2F1UCur","uuid":"faf6f282-6436-4198-9cfd-4173a7030c7b"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"0a058c5e-b9dc-47fc-91f8-3fe0ed1acd0b","timestamp":"2026-01-25T01:52:11.582Z"}
{"parentUuid":"0a058c5e-b9dc-47fc-91f8-3fe0ed1acd0b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B4kskfhPc7s8vGCS4Esenc","type":"tool_result","content":"   534→    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   535→        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   536→\n   537→        if (!is_null($plan)) {\n   538→            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n   539→        }\n   540→\n   541→        return $plan;\n   542→    }\n   543→\n   544→    /**\n   545→     * Solicitar la renovación de un plan específico de una empresa específica.\n   546→     *\n   547→     * @param Request $request Solicitud HTTP.\n   548→     * @return void\n   549→     * @author Fahibram Cárcamo\n   550→     * @author Andres González\n   551→     */\n   552→    public function solicitarRenovacionPlan(Request $request) {\n   553→        $tipo_plan = $request->tipo_plan ?? 'plan';\n   554→\n   555→        if ($tipo_plan === 'plan_credito') {\n   556→            $plan = $this->plan_credito_repositorio->getUno($request->plan_id);\n   557→        } else {\n   558→            $plan = $this->plan_repositorio->getUno($request->plan_id);\n   559→        }\n   560→\n   561→        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n   562→        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n   563→\n   564→        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   565→            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n   566→            'con_roles_ids' => true\n   567→        ]));\n   568→\n   569→        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   570→            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n   571→            'empresa_id'    => $request->empresa_id,\n   572→            'con_roles_ids' => true\n   573→        ]));\n   574→\n   575→        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n   576→        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n   577→    }\n   578→\n   579→    /**\n   580→     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n   581→     *\n   582→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   583→     * @return bool\n   584→     * @author Daniel Beltrán\n   585→     * @author Fahibram Cárcamo\n   586→     */\n   587→    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n   588→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   589→            return true;\n   590→        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n   591→            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n   592→                return true;\n   593→            }\n   594→        }\n   595→\n   596→        return false;\n   597→    }\n   598→\n   599→    /**\n   600→     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n   601→     *\n   602→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   603→     * @return bool\n   604→     * @author Daniel Beltrán\n   605→     * @author Fahibram Cárcamo\n   606→     */\n   607→    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   608→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   609→            return true;\n   610→        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n   611→            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n   612→                return true;\n   613→            }\n   614→        }\n   615→\n   616→        return false;\n   617→    }\n   618→\n   619→    /**\n   620→     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n   621→     *\n   622→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   623→     * @return bool\n   624→     * @author Fahibram Cárcamo\n   625→     */\n   626→    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n   627→        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n   628→    }\n   629→\n   630→    /**\n   631→     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n   632→     *\n   633→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"53a9f9c3-f263-4797-9a85-77d43a68a6cb","timestamp":"2026-01-25T01:52:12.564Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"d00921e1-fa1d-4923-8258-b551fd344c2c","timestamp":"2026-01-25T01:52:12.627Z"}
{"parentUuid":"d00921e1-fa1d-4923-8258-b551fd344c2c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:52:15.623Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01KRLDVzs8HcH3Z6MM3Psjpp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ReuBRpc4Ye8qfVLt5MiBUj","name":"Bash","input":{"command":"cd \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" && grep -n \"obtenerUltimoPorTipo\\|public function obtenerUltimoPorTipo\" ./app/Http/Services/Empresas/EmpresaPlanService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":2075,"cache_read_input_tokens":74588,"cache_creation":{"ephemeral_5m_input_tokens":2075,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTG2PMtqE7gZt2tNZeF8","uuid":"53d0e2ba-d9c1-4e78-87a5-96cf7cc03efb"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"830032c3-8202-47ae-bffd-c60018c1e1eb","timestamp":"2026-01-25T01:52:15.664Z"}
{"parentUuid":"830032c3-8202-47ae-bffd-c60018c1e1eb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ReuBRpc4Ye8qfVLt5MiBUj","type":"tool_result","content":"494:    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {","is_error":false}]},"uuid":"552bcd16-c213-41e6-96d4-ea12e891a8d0","timestamp":"2026-01-25T01:52:16.677Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"c8e72223-dd6a-4123-be65-3b6e37fd766b","timestamp":"2026-01-25T01:52:16.726Z"}
{"parentUuid":"c8e72223-dd6a-4123-be65-3b6e37fd766b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-01-25T01:52:18.390Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_017FvEYeW5Ny4vfsipozYJcC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016yd3Hmia4wCYxwYQnzX86V","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","offset":494,"limit":40}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":363,"cache_read_input_tokens":76663,"cache_creation":{"ephemeral_5m_input_tokens":363,"ephemeral_1h_input_tokens":0},"output_tokens":18,"service_tier":"standard"},"context_management":null},"requestId":"req_011CXTG2gVXaT51wovfRnCDG","uuid":"4a62ca64-caa6-443f-a7f5-30fb72039063"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"da542193-065c-4c55-aa17-b70360f46d61","timestamp":"2026-01-25T01:52:18.427Z"}
{"parentUuid":"da542193-065c-4c55-aa17-b70360f46d61","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016yd3Hmia4wCYxwYQnzX86V","type":"tool_result","content":"   494→    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   495→        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n   496→            'empresa_id'             => $empresa_id,\n   497→            'tipo_prueba_id'         => $tipo_prueba_id,\n   498→            'excluir_estado_proximo' => true\n   499→        ]));\n   500→\n   501→        if (!is_null($plan)) {\n   502→            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   503→\n   504→            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n   505→        }\n   506→\n   507→        return $plan;\n   508→    }\n   509→\n   510→    /**\n   511→     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n   512→     *\n   513→     * @param int $id ID del plan de empresa.\n   514→     * @return ?EmpresaPlan\n   515→     * @author Daniel Beltrán\n   516→     */\n   517→    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n   518→        $plan               = $this->repositorio->getUno($id);\n   519→        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n   520→\n   521→        return $plan;\n   522→    }\n   523→\n   524→    /**\n   525→     * Obtener el plan activo de la empresa por tipo de prueba.\n   526→     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n   527→     * La propiedad se llama 'plan_proximo' y es un booleano.\n   528→     *\n   529→     * @param int $empresa_id ID de la empresa.\n   530→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   531→     * @return ?EmpresaPlan\n   532→     * @author Daniel Beltrán\n   533→     */\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2b1e0ffb-e866-41d3-a3a4-fc792c27cb12","timestamp":"2026-01-25T01:52:19.464Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91"},"toolUseID":"agent_msg_01A72or2KSVbEVUnSqgcvop4","parentToolUseID":"toolu_01K1dppusw7BUt5avh2Tvgsn","uuid":"27e5d142-bb35-4515-8711-3ace8293d816","timestamp":"2026-01-25T01:52:19.515Z"}
{"parentUuid":"136b07db-43f8-4b80-9787-86d315266392","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01K1dppusw7BUt5avh2Tvgsn","type":"tool_result","content":[{"type":"text","text":"Ahora tengo toda la información que necesito. Voy a crear un resumen comprensivo del problema:\n\n## RESUMEN DEL ANÁLISIS\n\nHe encontrado exactamente dónde y por qué los planes de crédito (donde `plan_id` es NULL pero `plan_credito_id` no es NULL) no se muestran en la vista de gestionar empresas del superadmin.\n\n### UBICACIONES CLAVE:\n\n1. **Ruta**: `/empresas-gestionar/{id}` \n   - Archivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php` (línea 203)\n   - Controlador: `App\\Http\\Controllers\\Empresas\\EmpresaController@gestionar`\n\n2. **Controlador**:\n   - Archivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaController.php`\n   - Método: `gestionar()` (línea 304-318)\n   - Este método solo renderiza la vista, sin cargar datos inicialmente\n\n3. **Carga de datos Ajax**:\n   - Archivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php` (línea 204)\n   - Ruta: `/empresas-gestionar-datos/{id}`\n   - Controlador: `EmpresaController@datosGestionar()` (línea 712)\n   - Servicio: `EmpresaService->getUno($id)` (línea 103)\n\n4. **Frontend - Archivo JavaScript**:\n   - Archivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js`\n   - Función: `obtenerDatosGestionarEmpresa()` (línea 1256)\n   - Función que muestra los planes: `mostrarPlanes()` (línea 1491)\n\n### EL PROBLEMA - FILTRO QUE EXCLUYE PLANES DE CRÉDITO:\n\nEn `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js` (línea 1503-1505):\n\n```javascript\nfunction mostrarPlanes() {\n    // ... código previo ...\n    let planes = empresa_seleccionada.planes;\n    if (planes.length > 0) {\n        for (let i = 0; i < planes.length; i++) {\n            if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n                continue;  // <-- ESTO EXCLUYE PLANES DE CRÉDITO\n            }\n```\n\n**Explicación del bug:**\n- La condición `if (!planes[i].plan || !planes[i].plan.tipo_prueba_id)` descarta cualquier plan donde:\n  - `planes[i].plan` es null (que es el caso de planes solo de créditos)\n  - O donde `planes[i].plan.tipo_prueba_id` es undefined\n- Los planes de crédito tienen `plan_id = NULL` y `plan_credito_id != NULL`, por lo que `planes[i].plan` es null, causando que se salten con `continue`\n\n### POR QUÉ OCURRE EN LA CARGA DE DATOS:\n\nEn `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php` (línea 103-164):\n\n```php\npublic function getUno(int $id): ?Empresa {\n    $empresa = $this->repositorio->getUnoBasico($id);\n\n    if (!is_null($empresa)) {\n        $planes = [];\n        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n        foreach ($tipos_pruebas as $tipo_prueba) {\n            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n            if (!is_null($plan)) {\n                array_push($planes, $plan);\n            }\n        }\n        // ... el resto del código ...\n        $empresa->planes = $planes;\n```\n\nEl servicio `getUno()`:\n1. Obtiene los últimos planes **por tipo de prueba** (SOLO para Selección, Organizacional, Vocacional)\n2. Los planes de crédito están asociados a `plan_id = NULL` y `plan_credito_id != NULL`\n3. Estos planes no coinciden con ningún tipo de prueba específico y nunca se cargan en el array `$planes`\n4. **No se cargan los planes de crédito en absoluto en el backend**\n\n### ARCHIVOS INVOLUCRADOS:\n\n1. **Backend:**\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaController.php` (línea 712-715)\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php` (línea 103-164)\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php` (múltiples métodos que filtran por tipo_prueba_id)\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php` (línea 198-199 - tiene método `esSoloPlanCreditos()`)\n\n2. **Frontend:**\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresas\\paginas\\gestionar.blade.php` (línea 54-57 - pestaña de planes)\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresas\\paginas\\formularios-gestionar\\planes.blade.php` (línea 1-42)\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js` (línea 1256, 1491-1620)\n\n### CAUSA RAÍZ:\n\n**El problema es de dos niveles:**\n\n1. **Backend (Nivel 1 - Principal):**\n   - En `EmpresaService->getUno()`, los planes se cargan solo filtrando por tipo_prueba_id\n   - Los planes de crédito (solo créditos) no tienen tipo_prueba_id porque `plan_id` es NULL\n   - **Nunca se cargan en el backend**\n\n2. **Frontend (Nivel 2 - Secundario):**\n   - Incluso si se cargaran, la función `mostrarPlanes()` los filtraría con la condición `if (!planes[i].plan)`\n   - **Se requerirían cambios en JavaScript para mostrarlos**"},{"type":"text","text":"agentId: ad73e91 (for resuming to continue this agent's work if needed)"}]}]},"uuid":"72b87048-04a4-4741-9763-29fadd52dc50","timestamp":"2026-01-25T01:52:33.970Z","toolUseResult":{"status":"completed","prompt":"Necesito encontrar cómo se cargan los planes en la vista de superadmin \"empresas-gestionar/{id}\". \n\nBusca:\n1. La ruta en routes/web.php que maneja \"empresas-gestionar/{id}\" o similar\n2. El controlador que maneja esta ruta\n3. El método del controlador que carga los planes de la empresa\n4. Cualquier consulta o filtro que pueda estar excluyendo planes donde plan_id sea null (planes solo de créditos)\n\nEl problema es que los planes de créditos (donde plan_id es null pero plan_credito_id no es null) no se muestran en esta vista.","agentId":"ad73e91","content":[{"type":"text","text":"Ahora tengo toda la información que necesito. Voy a crear un resumen comprensivo del problema:\n\n## RESUMEN DEL ANÁLISIS\n\nHe encontrado exactamente dónde y por qué los planes de crédito (donde `plan_id` es NULL pero `plan_credito_id` no es NULL) no se muestran en la vista de gestionar empresas del superadmin.\n\n### UBICACIONES CLAVE:\n\n1. **Ruta**: `/empresas-gestionar/{id}` \n   - Archivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php` (línea 203)\n   - Controlador: `App\\Http\\Controllers\\Empresas\\EmpresaController@gestionar`\n\n2. **Controlador**:\n   - Archivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaController.php`\n   - Método: `gestionar()` (línea 304-318)\n   - Este método solo renderiza la vista, sin cargar datos inicialmente\n\n3. **Carga de datos Ajax**:\n   - Archivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php` (línea 204)\n   - Ruta: `/empresas-gestionar-datos/{id}`\n   - Controlador: `EmpresaController@datosGestionar()` (línea 712)\n   - Servicio: `EmpresaService->getUno($id)` (línea 103)\n\n4. **Frontend - Archivo JavaScript**:\n   - Archivo: `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js`\n   - Función: `obtenerDatosGestionarEmpresa()` (línea 1256)\n   - Función que muestra los planes: `mostrarPlanes()` (línea 1491)\n\n### EL PROBLEMA - FILTRO QUE EXCLUYE PLANES DE CRÉDITO:\n\nEn `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js` (línea 1503-1505):\n\n```javascript\nfunction mostrarPlanes() {\n    // ... código previo ...\n    let planes = empresa_seleccionada.planes;\n    if (planes.length > 0) {\n        for (let i = 0; i < planes.length; i++) {\n            if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n                continue;  // <-- ESTO EXCLUYE PLANES DE CRÉDITO\n            }\n```\n\n**Explicación del bug:**\n- La condición `if (!planes[i].plan || !planes[i].plan.tipo_prueba_id)` descarta cualquier plan donde:\n  - `planes[i].plan` es null (que es el caso de planes solo de créditos)\n  - O donde `planes[i].plan.tipo_prueba_id` es undefined\n- Los planes de crédito tienen `plan_id = NULL` y `plan_credito_id != NULL`, por lo que `planes[i].plan` es null, causando que se salten con `continue`\n\n### POR QUÉ OCURRE EN LA CARGA DE DATOS:\n\nEn `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php` (línea 103-164):\n\n```php\npublic function getUno(int $id): ?Empresa {\n    $empresa = $this->repositorio->getUnoBasico($id);\n\n    if (!is_null($empresa)) {\n        $planes = [];\n        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n        foreach ($tipos_pruebas as $tipo_prueba) {\n            $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n            if (!is_null($plan)) {\n                array_push($planes, $plan);\n            }\n        }\n        // ... el resto del código ...\n        $empresa->planes = $planes;\n```\n\nEl servicio `getUno()`:\n1. Obtiene los últimos planes **por tipo de prueba** (SOLO para Selección, Organizacional, Vocacional)\n2. Los planes de crédito están asociados a `plan_id = NULL` y `plan_credito_id != NULL`\n3. Estos planes no coinciden con ningún tipo de prueba específico y nunca se cargan en el array `$planes`\n4. **No se cargan los planes de crédito en absoluto en el backend**\n\n### ARCHIVOS INVOLUCRADOS:\n\n1. **Backend:**\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaController.php` (línea 712-715)\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php` (línea 103-164)\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php` (múltiples métodos que filtran por tipo_prueba_id)\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php` (línea 198-199 - tiene método `esSoloPlanCreditos()`)\n\n2. **Frontend:**\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresas\\paginas\\gestionar.blade.php` (línea 54-57 - pestaña de planes)\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresas\\paginas\\formularios-gestionar\\planes.blade.php` (línea 1-42)\n   - `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js` (línea 1256, 1491-1620)\n\n### CAUSA RAÍZ:\n\n**El problema es de dos niveles:**\n\n1. **Backend (Nivel 1 - Principal):**\n   - En `EmpresaService->getUno()`, los planes se cargan solo filtrando por tipo_prueba_id\n   - Los planes de crédito (solo créditos) no tienen tipo_prueba_id porque `plan_id` es NULL\n   - **Nunca se cargan en el backend**\n\n2. **Frontend (Nivel 2 - Secundario):**\n   - Incluso si se cargaran, la función `mostrarPlanes()` los filtraría con la condición `if (!planes[i].plan)`\n   - **Se requerirían cambios en JavaScript para mostrarlos**"}],"totalDurationMs":409917,"totalTokens":77884,"totalToolUseCount":26,"usage":{"input_tokens":0,"cache_creation_input_tokens":856,"cache_read_input_tokens":77026,"cache_creation":{"ephemeral_5m_input_tokens":856,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"sourceToolAssistantUUID":"136b07db-43f8-4b80-9787-86d315266392"}
{"parentUuid":"72b87048-04a4-4741-9763-29fadd52dc50","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_011keET8326zEQaPhExM6VWC","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Excelente, ahora tengo toda la información necesaria. El problema está claro:\n\n## Problema identificado:\n\n### En la vista de superadmin (empresas-gestionar/{id}):\n\n**Backend (EmpresaService->getUno()):**\nLos planes se cargan iterando por cada tipo de prueba:\n```php\nforeach ($tipos_pruebas as $tipo_prueba) {\n    $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n        ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n```\n\nEl problema es que los planes de créditos (solo créditos) tienen `plan_id = NULL`, por lo que no tienen un `tipo_prueba_id` asociado. Cuando la consulta hace `whereHas('plan', ...)` con un tipo_prueba_id específico, estos planes no coinciden y se excluyen.\n\n**Frontend (empresas.js mostrarPlanes()):**\nAdemás, hay un filtro que excluye planes donde `plan` es null:\n```javascript\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n```\n\n### En la vista de empresa (/planes-clientes):\n\nUsa el mismo patrón de carga pero los agentes sugieren que aquí SÍ funcionan todos los planes (3 de créditos y 1 de selección).\n\nEspera, hay una contradicción. Si ambos usan el mismo método `obtenerPlanActivo()` y `obtenerUltimoPorTipo()`, ¿por qué funcionan diferente?\n\nDéjame revisar más a fondo. El agente encontró que:\n\n1. En `EmpresaPlanRepository::planActivo()` línea 454:\n\n\nLa consulta requiere una relación `plan` con un `tipo_prueba_id` específico mediante `whereHas()`. Los planes de solo créditos tienen `plan_id = NULL`, así que carecen de esa relación y quedan filtrados. En `ultimoPlanAsignado()` hay un condicional que solo aplica el filtro de `tipo_prueba_id` si está presente en la solicitud, lo que permite que algunos planes se carguen sin esa restricción.\n\nSin embargo, el usuario confirma que en `/planes-clientes` aparecen los 3 planes de créditos. Esto sugiere que esos planes podrían tener un `plan_id` asignado además del `plan_credito_id`, o que existe otra ruta de carga diferente para los planes de créditos en esa vista. Necesito revisar cómo se cargan exactamente los planes en ese endpoint.","signature":"EsgXCkYICxgCKkDaE0P38yIVYBJjFPPHiDOgHZyjMjG+AKzPUGwijHxRHNGurv58wRw2ISrWktDBZSzj8BXlRGkotFUbEW8CecZVEgw0aT0EKcJaBOKJkjgaDHnrRgh+cEKhXrrHLiIwwR8sk/L3UmRDon5oNrc3Zk52u4yHiC3QS6edwFLakbaeXGrQsNXn5IW74aoTgrFQKq8WS84eR7pDIyJhIkbaMFAKN5PSZNNM2+XtadmsSKm//Tr7AH0v15SvoEDI9LvztLp4uXcmNjEKAET8WiwJVqNOnX/65yX3KAJhs9ogXhyTAXDIWw5HW2BLq0ZFUtpgWmcqBmmoqCC01CnxOcGMulDTjzkgSa9QxVIQJf+nFasGATAhsMbnippraIHsLdJC2eWBYlWf/TrT8KOAzKHf6dOybXhhmKiMleG3f1xjG9U0wQY1fpYuMWZkKpY1V+rGeRRUeeG44APZEEjLy9EkQN6CI2Ynxq3UwEefGmnkbWi8BvU+Ts/SE64PE10JngtwKc1gElDsYKHy8JB3BMMe1Hsl/or3HGXEO/4jQ0uXSr5xDC9dkWk2VcXAFPkL7LRQdxo2ZeSrK4zs2GAYKSiT4I4ki4wQD4g8GhDcUjret6BOJsgdIx0s94PEeM2LgbrANBUb8yQMy4b++M79BEW5H7zugz7HY7q0+CnGp/39qcT+WFPGfFt6CC2EEF1inLqs/nTBJGzLTh8VdUMX9aRvfENVQiAYXHrmWGyLnalT10CsuYYvO9mE4l2D+ES0NTtZB9qnU/kR1UlhdcHuYMPjDzLZwa21695E5t4k86saW2Q7ADalMgENmYKXfqNHVniqUUcuipqGED69w7JtRw4zDRpTUGZV/62BQQrXCic/zjB4BNZG/zOr8nEMYXumT/8zlpL30GB+59Tchsq+g/1V95ywg284TIc2eh7lUPr7pA+OamfBvl2C66MjbuItLp/rVgcaf4190PhAa7UZecAT1hnMHB5QMu5RQDffF5tExMVO2MUFrjEtZNPD/61x18nBPkH5UxZ7Z8Adn+MaRSNbGjhnOpkS8T/QmRCQImDvDJTWk5RH9yRSAUs5QX5Qq4sf7wGxCyR6KXNHE81oW1Rrk5BplB6MTJ4ZEIYqFw1SRTQAp2coF4YH7JyoiCcLUxiGScaDS6CHhkJU5jWC6rsVE7FgPsFx0bpkKkIgqW2vR3ajsgt7UlELroyDAEY+kXUzLkOVerOhA0VvjItkIytT9RF1B6fFTjwozEMLiTea2wU+LWZFoAAQ17EyARB7nNAun1LG67ZnfO5q1LpT3VbA8VaeiqwD4MTvdexdriv6PbUk8NsK6icNfVY0f+iuM1eZJbuzwYEGYwhaz1KSRCYWGj62VJS+EWCgwaIcdOB8/XLjR+hYQdFu2ipOGimYZ4S6v7rWy0Ytxhrh9ctjn6MDG7DBVPJJDqUb1NWuu54zPwAVL89SQLgMjt0qnA9jfxum/avt7H9gpDrfiND80DhHPEl/Jjboip8kLS8SaiRTEDh1Hf3vQQr/zXy+BU6dkQONsXxx2vi/lVj9sqiL9hIkbf0vGal2kqlOO8aYQBH/Evvaema2R4ZK6bt1X7+BAMD6GbkSMC5S6T0f8o+5wDlgPORgszpH+54mgVw0Ftn2qQBf+WajcR/LVH5nmFuBWytq577chsKXUeUu7W7xmd6uHVwhDZGnB3kHXvLjmez7NI+0RS6VSADzjG/iauM8S8dNA22HgPC3g3GYSmiL8W9AWk0qlIwXkH+M314gDGK90IvDWWY44yTRVPse85J4IOfkWZvHQ6LQklGSchACv3RHyvxqJFuiwW6SOP8O6sGhVHU+H6Xq5ylAO0CFGV0hhKxrf8lZRfySneWAqhUS4cjcRnvy+xyHinr0ggc6f3NqcKahVx03pr+toHgL+KAaBFyZ4bVcaQCKse34+LKmHw86J1t3M1LxikvQg4yRnUoa0Z21FN9qX4dzn6W36uv2TJimbOFWd8sAeL6qucHP1eAvhei1klRI9s0gd/uVKMGFz5MDaFtFwfLDexhdqt1+OUnX0C+rhB3WVLGKTr7GuogSv+ZAn4Tf89l8YHhV+yE2MynNrXuJ0ZfKEqB5vrdAASGhkrhn4U6xjw6V6t0Eelo6wnIvMiZV0wo4HTtaT11BIJhfu67PHVsRlxLajCBeYYed9gIqHwGyC6qgeD34LR0I/ctcKh/sQ3SLblTAKcqNBuOt4ER/QaHVmJ9yzpskWGtWcG8aiRjT1EU+om57qAyaC50d32EPgwoqqkZxJXd9K/MsO3BOCCn3Mfb9ODf9DB3bHWeAypvlTCJ1UocVLZ6CyKBzpICb3TtucCbZMFQRB48pZRngTe8LbR3uK0wYp6zeuN9UnCe1A7jHh+X34QqxRxF02cvpCtSwvsI/FEOMml7Hid74o1Wm/ZH+G8C6FV4QAuKhS8abbKDzirsxmxKr5/yyLFOSdC8eWfB8wH3JXUGZh4CLZjkaEHv/WsqukxHxRsfJ+X39WpZrPgbTvcFxSzV8bw4UTEtWHzDH8xNP+Oy+IFRVPnAbGlq5eodS2PgadKz/HzUb1HQWnlTSzW/+jupBRr+l+AGFagFIPCxepYdR+x57BShtoM8DqDbyhFgU1v4J2uCFbpn8xqEYbHj17zcBarpTdAV5JulZrTv9eMXX3/qAVUqNFt1TZz05I9r7ap3haO8H+r0qkZVFWfJ+cIbl1s1A/laqxGLo8CoFhgnwJ3yiescfqM8Fue/BqvKzZmmsLrB4kFtibsYzNRvGRbRDR0ZnLhwDMc+qJuMYCgagRQqKj2LJH0d9DLxQTCSokBl1a1ppC8x6LsTbEVR6BhqFT7UftLkA2EYaQxo5qoQD0wVXA5VpunV53qC64sOKmcYXQ2PaxSZwZcfTbBDL05v0EItrtT3wygbNosedoMkXmIMq5C2MwsAuyEaMejYlDBdAFGcVn1byO44TU9C2ky1qnL8qeLbAYS17KXyGd6D4xV2ApweCFbyY/kteBhbiLvvtt5LqH3BJRwsSgpP2/r4jPrbLN6sRxCfek5pHLuBfrS8T2ubru+MQ9TjhXap8dymQ/LHdP6w/fHErS88q6Ok9bRnfGlsHmglbbLqzPwwmu1lh5pswxCG5r4s7JsjA6QCPs6y9VZmEWEiRrt/LKLj2XkPWz4Uva1X1ThiVfOQQWi2VOYbKxeItexZKz49gsIbRXCkUPSpvCtAASPWHKC5viA4DqPnEENGEPOWvTNuluMhhG+19wwcxfBvTBkGBI7v1lZ7J3Z+dV2Z3Btu/P+1pb+spFKR+clVIQL8zla7ck+V0RK5xZEUPPuQJ2abBRQy1l75cTK+DWYgz9smcoLRfAsWvWzYgotg32Nudygz8UUz5vjGkk0ePzBiWeMTEjeCklXuuMYYPGWfbc/uzYCqsPZ3dIg8/un79oHo0IN2X9LxJLLQc5RsLlbc9EDzz1EkVH+1Cikds63pC1PjCX8qShPZiivLc1pcAfbqhFmX+3bvuR821bVZg0WhwZbFs7/fvaEfWQ5euwGUN9w/iievH4ecBKD6AIUKootC0uwWsQ1FHFMof6kw84mRPiCGD3J6WVUSvfAMHoeX4NUgT1ymcuSe0fCFGlRIxUvd7WKjF5hLl/pKCfyjDYMBETwr2wohQzwGAJiMvL7QC+n+5LTDreHMdRwHwBEs7lWb0llHjA+1ZuB5YTuAnke7RaeyElNJj9NmNE+fbMffUS3gMRLl9YP0ux+2ItjNiRiVLAcQ05V75CUxSdFL9rdYW0X6t0DfH1pur8KIuvcHt6fFLMHkcuDf61SfxCZm9nIixWB89wEY9l89SV0XYbvQ28tpsOHYlEm0Was8Z8jEPiCi0t0V7q0IPInogX4rCT1wg1VceIKORnNuzLyCxBibJ4vRUSQ0q8bAIg4TwotryeL6oPWaS/T26+WJrcpH9Q3r/+jD7cQhzUGOPBeI7lsqK4VyjKHkHlE+y8WYVT3J/CqZ/DL+zoe7iGOWy53+GQjJ61ZEW2xgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3255,"cache_creation_input_tokens":32899,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":32899,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTG3xWDvVP9skPVh9X3X","type":"assistant","uuid":"f15623ad-b84e-4f12-9927-d0c4fe8a19e9","timestamp":"2026-01-25T01:52:49.993Z"}
{"parentUuid":"f15623ad-b84e-4f12-9927-d0c4fe8a19e9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_011keET8326zEQaPhExM6VWC","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente, ya tengo un panorama claro del problema. Déjame leer los archivos clave para confirmar la causa raíz y diseñar la solución."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3255,"cache_creation_input_tokens":32899,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":32899,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTG3xWDvVP9skPVh9X3X","type":"assistant","uuid":"c744585d-0d86-4de2-8024-0c1b04c29e26","timestamp":"2026-01-25T01:52:50.646Z"}
{"parentUuid":"c744585d-0d86-4de2-8024-0c1b04c29e26","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_011keET8326zEQaPhExM6VWC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LW3eprAJehu9yoSB7knPyf","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","offset":100,"limit":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3255,"cache_creation_input_tokens":32899,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":32899,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTG3xWDvVP9skPVh9X3X","type":"assistant","uuid":"ccae780b-9c4e-48ca-8434-f5808034a0ce","timestamp":"2026-01-25T01:52:51.549Z"}
{"parentUuid":"ccae780b-9c4e-48ca-8434-f5808034a0ce","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_011keET8326zEQaPhExM6VWC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FZDaC43uxjuU9MVDT47aZ6","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","offset":425,"limit":120}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3255,"cache_creation_input_tokens":32899,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":32899,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTG3xWDvVP9skPVh9X3X","type":"assistant","uuid":"0af9506b-5985-4aae-8ddc-bc117368f410","timestamp":"2026-01-25T01:52:52.345Z"}
{"parentUuid":"0af9506b-5985-4aae-8ddc-bc117368f410","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_011keET8326zEQaPhExM6VWC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015gVWgUWsrwjFd83wkavTKe","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":1490,"limit":140}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3255,"cache_creation_input_tokens":32899,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":32899,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTG3xWDvVP9skPVh9X3X","type":"assistant","uuid":"32fbcdc4-a561-4fa2-9444-02a111a03bd9","timestamp":"2026-01-25T01:52:53.180Z"}
{"parentUuid":"ccae780b-9c4e-48ca-8434-f5808034a0ce","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LW3eprAJehu9yoSB7knPyf","type":"tool_result","content":"   100→     * @author Andres Gonzalez\n   101→     * @author Jair Carvajal\n   102→     */\n   103→    public function getUno(int $id): ?Empresa {\n   104→        $empresa = $this->repositorio->getUnoBasico($id);\n   105→\n   106→        if (!is_null($empresa)) {\n   107→            $planes        = [];\n   108→            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   109→\n   110→            foreach ($tipos_pruebas as $tipo_prueba) {\n   111→                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n   112→                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n   113→\n   114→                if (!is_null($plan)) {\n   115→                    array_push($planes, $plan);\n   116→                }\n   117→            }\n   118→\n   119→            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n   120→                'empresa_id'         => $id,\n   121→                'con_relaciones'     => true,\n   122→                'validar_relaciones' => true,\n   123→                'en'                 => true,\n   124→                'campo'              => 'rol_id',\n   125→                'valores'            => [\n   126→                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n   127→                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n   128→                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n   129→                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n   130→                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n   131→                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   132→                    $this->rol_repositorio::ROL_EVALUADOR_ID\n   133→                ]\n   134→            ]));\n   135→\n   136→            $usuarios = $usuarios->map(function ($usuario) {\n   137→                $eliminar = false;\n   138→\n   139→                if (\n   140→                    !$usuario->usuario->tiene_agendas\n   141→                    && !$usuario->usuario->tiene_ofertas_laborales\n   142→                    && !$usuario->usuario->tiene_procesos\n   143→                    && !$usuario->usuario->tiene_procesos\n   144→                    && !$usuario->usuario->tiene_etapa_usuario\n   145→                ) {\n   146→                    $eliminar = true;\n   147→                }\n   148→\n   149→                $usuario->usuario->eliminar = $eliminar;\n   150→                return $usuario;\n   151→            });\n   152→\n   153→            $empresa->planes                         = $planes;\n   154→            $empresa->usuarios                       = $usuarios;\n   155→            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n   156→            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n   157→                'model_type' => $this->modelo,\n   158→                'modelo_id'  => $id\n   159→            ]));\n   160→            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n   161→        }\n   162→\n   163→        return $empresa;\n   164→    }\n   165→\n   166→    /**\n   167→     * Obtener todas las empresas.\n   168→     *\n   169→     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n   170→     *\n   171→     * @param Request $request Contenido de la petición.\n   172→     * @return Collection\n   173→     * @author Daniel Beltrán\n   174→     * @author Andres Gonzalez\n   175→     */\n   176→    public function getTodo(Request $request): Collection {\n   177→        $empresas      = $this->repositorio->getTodo($request);\n   178→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   179→        $coleccion     = [];\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e31dbdf8-acf0-46f6-a9fb-781b102989b3","timestamp":"2026-01-25T01:52:56.132Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","content":"     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?Empresa {\n        $empresa = $this->repositorio->getUnoBasico($id);\n\n        if (!is_null($empresa)) {\n            $planes        = [];\n            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n                'empresa_id'         => $id,\n                'con_relaciones'     => true,\n                'validar_relaciones' => true,\n                'en'                 => true,\n                'campo'              => 'rol_id',\n                'valores'            => [\n                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n                    $this->rol_repositorio::ROL_EVALUADOR_ID\n                ]\n            ]));\n\n            $usuarios = $usuarios->map(function ($usuario) {\n                $eliminar = false;\n\n                if (\n                    !$usuario->usuario->tiene_agendas\n                    && !$usuario->usuario->tiene_ofertas_laborales\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_etapa_usuario\n                ) {\n                    $eliminar = true;\n                }\n\n                $usuario->usuario->eliminar = $eliminar;\n                return $usuario;\n            });\n\n            $empresa->planes                         = $planes;\n            $empresa->usuarios                       = $usuarios;\n            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n                'model_type' => $this->modelo,\n                'modelo_id'  => $id\n            ]));\n            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Obtener todas las empresas.\n     *\n     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function getTodo(Request $request): Collection {\n        $empresas      = $this->repositorio->getTodo($request);\n        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n        $coleccion     = [];","numLines":80,"startLine":100,"totalLines":769}},"sourceToolAssistantUUID":"ccae780b-9c4e-48ca-8434-f5808034a0ce"}
{"parentUuid":"0af9506b-5985-4aae-8ddc-bc117368f410","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FZDaC43uxjuU9MVDT47aZ6","type":"tool_result","content":"   425→     * @author Fahibram Cárcamo\n   426→     * @author José Manuel Jiménez\n   427→     * @author Andres Gonzalez\n   428→     * @author Sergio Vargas\n   429→     * @author Jair Carvajal\n   430→     */\n   431→    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   432→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   433→        ->with([\n   434→            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n   435→            'plan.tipoPrueba:id,nombre',\n   436→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   437→            'estado:id,nombre',\n   438→            'pruebas:id,nombre,slug',\n   439→            'usuario:id,nombres,apellidos',\n   440→            'archivos' => function ($archivos) {\n   441→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   442→                ->orderBy('created_at', 'DESC');\n   443→            }\n   444→        ])\n   445→        ->withCount([\n   446→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   447→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n   448→            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n   449→        ])\n   450→        ->where('empresa_id', $empresa_id)\n   451→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   452→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   453→        })\n   454→        ->whereIn('estado_id', [1, 4])\n   455→        ->first();\n   456→    }\n   457→\n   458→    /**\n   459→     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n   460→     *\n   461→     * @param int $empresa_id ID de la empresa.\n   462→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   463→     * @return EmpresaPlan|null\n   464→     * @author Daniel Beltrán\n   465→     * @author Jair Carvajal\n   466→     */\n   467→    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   468→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   469→        ->with([\n   470→            'plan:id,tipo_prueba_id,nombre',\n   471→            'plan.tipoPrueba:id,nombre',\n   472→            'estado:id,nombre',\n   473→            'pruebas:id,nombre',\n   474→            'archivos' => function ($archivos) {\n   475→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   476→                ->orderBy('created_at', 'DESC');\n   477→            }\n   478→        ])\n   479→        ->where([\n   480→            'empresa_id' => $empresa_id,\n   481→            'estado_id'  => 3\n   482→        ])\n   483→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   484→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   485→        })\n   486→        ->first();\n   487→    }\n   488→\n   489→    /**\n   490→     * Obtener el último plan asignado.\n   491→     *\n   492→     * @param Request $request Contenido de la petición.\n   493→     * @return EmpresaPlan|null\n   494→     * @author Daniel Beltrán\n   495→     * @author Jair Carvajal\n   496→     */\n   497→    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n   498→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   499→        ->with([\n   500→            'plan:id,tipo_prueba_id,nombre',\n   501→            'plan.tipoPrueba:id,nombre',\n   502→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   503→            'estado:id,nombre',\n   504→            'pruebas:id,nombre',\n   505→            'archivos' => function ($archivos) {\n   506→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   507→                ->orderBy('created_at', 'DESC');\n   508→            }\n   509→        ])\n   510→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   511→            $consulta->where('empresa_id', $request->empresa_id);\n   512→        })\n   513→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   514→            $consulta->where('estado_id', $request->estado_id);\n   515→        })\n   516→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   517→            $consulta->whereIn('estado_id', $request->estados_ids);\n   518→        })\n   519→        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   520→            $consulta->where('estado_id', '!=', 3);\n   521→        })\n   522→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   523→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   524→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   525→            });\n   526→        })\n   527→        ->orderBy('created_at', 'DESC')\n   528→        ->first();\n   529→    }\n   530→\n   531→    /**\n   532→     * Sincronizar pruebas.\n   533→     *\n   534→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   535→     * @param array $pruebas ID's de las pruebas.\n   536→     * @return void\n   537→     * @author Daniel Beltrán\n   538→     */\n   539→    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n   540→        $empresa_plan->pruebas()->sync($pruebas);\n   541→    }\n   542→\n   543→    /**\n   544→     * Sincronizar funcionalidades.\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ab08371a-3a7d-4924-8e72-7336b1d4c028","timestamp":"2026-01-25T01:52:56.133Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","content":"     * @author Fahibram Cárcamo\n     * @author José Manuel Jiménez\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])\n        ->first();\n    }\n\n    /**\n     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener el último plan asignado.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->where('estado_id', $request->estado_id);\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n    }\n\n    /**\n     * Sincronizar pruebas.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $pruebas ID's de las pruebas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n        $empresa_plan->pruebas()->sync($pruebas);\n    }\n\n    /**\n     * Sincronizar funcionalidades.","numLines":120,"startLine":425,"totalLines":969}},"sourceToolAssistantUUID":"0af9506b-5985-4aae-8ddc-bc117368f410"}
{"parentUuid":"32fbcdc4-a561-4fa2-9444-02a111a03bd9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015gVWgUWsrwjFd83wkavTKe","type":"tool_result","content":"  1490→\n  1491→function mostrarPlanes() {\n  1492→    let empresa_id = empresa_seleccionada.id;\n  1493→    let buscar = $('#buscador-plan').val();\n  1494→    let filtro_tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n  1495→    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n  1496→        tabla_planes.destroy();\n  1497→    }\n  1498→    $('#buscador-plan').remove();\n  1499→    $('#tbody-planes').empty();\n  1500→    let planes = empresa_seleccionada.planes;\n  1501→    if (planes.length > 0) {\n  1502→        for (let i = 0; i < planes.length; i++) {\n  1503→            if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n  1504→                continue;\n  1505→            }\n  1506→            if (\n  1507→                (filtro_tipo_prueba_id == 'Todos') ||\n  1508→                (filtro_tipo_prueba_id == '1' && planes[i].plan.tipo_prueba_id == 1) ||\n  1509→                (filtro_tipo_prueba_id == '2' && planes[i].plan.tipo_prueba_id == 2) ||\n  1510→                (filtro_tipo_prueba_id == '3' && planes[i].plan.tipo_prueba_id != 3)\n  1511→            ) {\n  1512→                let estado = obtenerEstadoPlan(\n  1513→                    planes[i].estado.id,\n  1514→                    planes[i].estado.nombre,\n  1515→                    planes[i].por_facturar,\n  1516→                    planes[i].renovando,\n  1517→                    null,\n  1518→                    planes[i].plan_proximo_id\n  1519→                );\n  1520→\n  1521→                let acciones = obtenerAcciones(\n  1522→                    planes[i].estado.id,\n  1523→                    planes[i].id, empresa_id,\n  1524→                    planes[i].plan.tipo_prueba_id,\n  1525→                    planes[i].plan.nombre,\n  1526→                    planes[i]?.archivos[0]?.id ?? '0',\n  1527→                    empresa_seleccionada.nombre_comercial\n  1528→                );\n  1529→\n  1530→                let modificado = '';\n  1531→                if (planes[i].plan_original == 0) {\n  1532→                    modificado = `<i class=\"bi bi-wrench me-3 text-blue-40\" ${crearTooltip({placement: 'top', content: 'Plan modificado', toggle: 'popover' })}></i>`;\n  1533→                }\n  1534→                let fecha_vencimiento = '';\n  1535→                if (planes[i].fecha_vencimiento != null) {\n  1536→                    fecha_vencimiento = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n  1537→                }\n  1538→                let fecha_creacion = '';\n  1539→                if (planes[i].created_at != null) {\n  1540→                    fecha_creacion = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n  1541→                }\n  1542→                let fecha_inicio = '';\n  1543→                if (planes[i].fecha_inicio != null) {\n  1544→                    fecha_inicio = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n  1545→                }\n  1546→                let pruebas_plan = '';\n  1547→                if (planes[i].pruebas !== undefined) {\n  1548→                    let pruebas = planes[i].pruebas;\n  1549→                    for (let j = 0; j < pruebas.length; j++) {\n  1550→                        pruebas_plan += `\n  1551→                            <div\n  1552→                                class=\"col-auto me-3 circulo-prueba\"\n  1553→                                style=\"background-image: url(../imagenes/logos/pruebas/${slugify(planes[i].pruebas[j].nombre)}.png)\"\n  1554→                                ${crearTooltip({placement: 'top', content: planes[i].pruebas[j].nombre, toggle: 'popover' })}\n  1555→                            ></div>\n  1556→                        `;\n  1557→                    }\n  1558→                }\n  1559→                let icono = '';\n  1560→                let title = '';\n  1561→                if (planes[i].plan.tipo_prueba_id == 1) {\n  1562→                    title = 'Selección';\n  1563→                    icono = 'bi-person-fill';\n  1564→                } else if (planes[i].plan.tipo_prueba_id == 2) {\n  1565→                    title = 'Organizacional';\n  1566→                    icono = 'bi-people-fill';\n  1567→                } else if (planes[i].plan.tipo_prueba_id == 3) {\n  1568→                    title = 'Vocacional';\n  1569→                    icono = 'bi-mortarboard-fill';\n  1570→                }\n  1571→                let opcion_editar = `\n  1572→                    <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit'\">\n  1573→                        <i class=\"bi bi-pencil-fill\"></i>\n  1574→                    </button>\n  1575→                `;\n  1576→                if (planes[i]?.plan_proximo_id) {\n  1577→                    opcion_editar = `\n  1578→                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n  1579→                            <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n  1580→                            <div class=\"dropdown-menu\">\n  1581→                                <a href=\"/empresas-planes/${planes[i].id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n  1582→                                <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n  1583→                            </div>\n  1584→                        </button>\n  1585→                    `;\n  1586→                }\n  1587→                $('#tbody-planes').append(`\n  1588→                    <tr>\n  1589→                        <td style=\"border-bottom: 0px!important;\">\n  1590→                            <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n  1591→                                <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n  1592→                                    <div class=\"col\">\n  1593→                                        <div class=\"row align-items-center\">\n  1594→                                            <div class=\"col-auto mb-0\">\n  1595→                                                <p class=\"text-gray-30 text-headline-4 mb-0\">\n  1596→                                                    <i class=\"bi ${icono} me-3\" title=\"${title}\"></i> ${modificado} ${planes[i].plan.nombre}\n  1597→                                                </p>\n  1598→                                            </div>\n  1599→                                            <div class=\"col-auto\">\n  1600→                                                ${estado}\n  1601→                                            </div>\n  1602→                                            <div class=\"col-auto\">\n  1603→                                                <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n  1604→                                                    <i class=\"bi bi-person-fill\"></i>&nbsp;<span class=\"text-label-2\">${planes[i].cantidad_usuarios}&nbsp;${fecha_vencimiento}</span>\n  1605→                                                </p>\n  1606→                                            </div>\n  1607→                                            <div class=\"col-12 mt-3\">\n  1608→                                                <div class=\"row w-100 m-0\">${pruebas_plan}</div>\n  1609→                                            </div>\n  1610→                                            <div class=\"col-12 mt-3\">\n  1611→\n  1612→                                            </div>\n  1613→                                        </div>\n  1614→                                    </div>\n  1615→                                    <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n  1616→                                        ${opcion_editar}\n  1617→                                        ${crearBoton({\n  1618→                                            clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n  1619→                                            texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n  1620→                                            adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n  1621→                                        })}\n  1622→                                        ${acciones}\n  1623→                                    </div>\n  1624→                                </div>\n  1625→                                <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n  1626→                                    <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n  1627→                                        <div>\n  1628→                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n  1629→                                                <i class=\"bi bi-briefcase\"></i>&nbsp;\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"907fb45e-7b55-4e67-947f-6c0f19cad73b","timestamp":"2026-01-25T01:52:56.133Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","content":"\nfunction mostrarPlanes() {\n    let empresa_id = empresa_seleccionada.id;\n    let buscar = $('#buscador-plan').val();\n    let filtro_tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        tabla_planes.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    let planes = empresa_seleccionada.planes;\n    if (planes.length > 0) {\n        for (let i = 0; i < planes.length; i++) {\n            if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n                continue;\n            }\n            if (\n                (filtro_tipo_prueba_id == 'Todos') ||\n                (filtro_tipo_prueba_id == '1' && planes[i].plan.tipo_prueba_id == 1) ||\n                (filtro_tipo_prueba_id == '2' && planes[i].plan.tipo_prueba_id == 2) ||\n                (filtro_tipo_prueba_id == '3' && planes[i].plan.tipo_prueba_id != 3)\n            ) {\n                let estado = obtenerEstadoPlan(\n                    planes[i].estado.id,\n                    planes[i].estado.nombre,\n                    planes[i].por_facturar,\n                    planes[i].renovando,\n                    null,\n                    planes[i].plan_proximo_id\n                );\n\n                let acciones = obtenerAcciones(\n                    planes[i].estado.id,\n                    planes[i].id, empresa_id,\n                    planes[i].plan.tipo_prueba_id,\n                    planes[i].plan.nombre,\n                    planes[i]?.archivos[0]?.id ?? '0',\n                    empresa_seleccionada.nombre_comercial\n                );\n\n                let modificado = '';\n                if (planes[i].plan_original == 0) {\n                    modificado = `<i class=\"bi bi-wrench me-3 text-blue-40\" ${crearTooltip({placement: 'top', content: 'Plan modificado', toggle: 'popover' })}></i>`;\n                }\n                let fecha_vencimiento = '';\n                if (planes[i].fecha_vencimiento != null) {\n                    fecha_vencimiento = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                }\n                let fecha_creacion = '';\n                if (planes[i].created_at != null) {\n                    fecha_creacion = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                }\n                let fecha_inicio = '';\n                if (planes[i].fecha_inicio != null) {\n                    fecha_inicio = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                }\n                let pruebas_plan = '';\n                if (planes[i].pruebas !== undefined) {\n                    let pruebas = planes[i].pruebas;\n                    for (let j = 0; j < pruebas.length; j++) {\n                        pruebas_plan += `\n                            <div\n                                class=\"col-auto me-3 circulo-prueba\"\n                                style=\"background-image: url(../imagenes/logos/pruebas/${slugify(planes[i].pruebas[j].nombre)}.png)\"\n                                ${crearTooltip({placement: 'top', content: planes[i].pruebas[j].nombre, toggle: 'popover' })}\n                            ></div>\n                        `;\n                    }\n                }\n                let icono = '';\n                let title = '';\n                if (planes[i].plan.tipo_prueba_id == 1) {\n                    title = 'Selección';\n                    icono = 'bi-person-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 2) {\n                    title = 'Organizacional';\n                    icono = 'bi-people-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 3) {\n                    title = 'Vocacional';\n                    icono = 'bi-mortarboard-fill';\n                }\n                let opcion_editar = `\n                    <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit'\">\n                        <i class=\"bi bi-pencil-fill\"></i>\n                    </button>\n                `;\n                if (planes[i]?.plan_proximo_id) {\n                    opcion_editar = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n                            <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                            <div class=\"dropdown-menu\">\n                                <a href=\"/empresas-planes/${planes[i].id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n                                <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n                            </div>\n                        </button>\n                    `;\n                }\n                $('#tbody-planes').append(`\n                    <tr>\n                        <td style=\"border-bottom: 0px!important;\">\n                            <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                    <div class=\"col\">\n                                        <div class=\"row align-items-center\">\n                                            <div class=\"col-auto mb-0\">\n                                                <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                    <i class=\"bi ${icono} me-3\" title=\"${title}\"></i> ${modificado} ${planes[i].plan.nombre}\n                                                </p>\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                ${estado}\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                    <i class=\"bi bi-person-fill\"></i>&nbsp;<span class=\"text-label-2\">${planes[i].cantidad_usuarios}&nbsp;${fecha_vencimiento}</span>\n                                                </p>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n                                                <div class=\"row w-100 m-0\">${pruebas_plan}</div>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n\n                                            </div>\n                                        </div>\n                                    </div>\n                                    <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                        ${opcion_editar}\n                                        ${crearBoton({\n                                            clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                            texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                            adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                        })}\n                                        ${acciones}\n                                    </div>\n                                </div>\n                                <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                    <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-briefcase\"></i>&nbsp;","numLines":140,"startLine":1490,"totalLines":3611}},"sourceToolAssistantUUID":"32fbcdc4-a561-4fa2-9444-02a111a03bd9"}
{"parentUuid":"907fb45e-7b55-4e67-947f-6c0f19cad73b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KhGeekPffwXAQfW1xv2QCW","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora tengo una imagen clara del problema. Déjame revisar la vista de `/planes-clientes` para ver si hay algo diferente en cómo se muestran los planes de créditos.\n\nEl problema está claro:\n\n1. **Backend**: En `EmpresaService->getUno()` (líneas 110-117), los planes se cargan iterando por cada tipo de prueba:\n   ```php\n   foreach ($tipos_pruebas as $tipo_prueba) {\n       $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n           ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n   ```\n   \n   Y en `planActivo()` (línea 451-453):\n   ```php\n   ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n       $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   })\n   ```\n   \n   Esto REQUIERE que el EmpresaPlan tenga un `plan_id` válido con un `tipo_prueba_id`. Los planes de solo créditos (`plan_id = NULL`) NO tienen esta relación, así que se excluyen.\n\n2. **Frontend**: En `empresas.js` (líneas 1503-1505):\n   ```javascript\n   if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n       continue;\n   }\n   ```\n   Esto excluye cualquier plan donde `plan` sea null.\n\nAhora necesito ver cómo se muestran los planes en `/planes-clientes` para entender por qué ahí sí se muestran los planes de créditos. Probablemente hay una sección separada para planes de créditos.\n\n\nNecesito buscar en la vista de planes-clientes para ver cómo se renderizan los planes de créditos y si utilizan una lógica diferente.","signature":"EsAMCkYICxgCKkCulYfqwTEvGpaS8GDtiePmv2UnwJYk78CH3SFBU+3CeuKu/TtwEp9y80TvaF+ZjvHQR0rhwC+8r9qFDq3bJeGEEgx1gEzDnJbc/5V5xVMaDOaE1tJd3k1e+Q4/9yIwrSr+McOfvH+UE15kCr5DlqlS5Lo4YlY7wI6bRPLiZ/7g18q6MDtOHRz9II9KfAIuKqcLkhxbDc1YZ7mHajES+PtOEuQ9dLvt7jx9lCBrHjBKfjjz5NZqWKzXBKNCHiCKFMLOThSXgs0w0c8W4R7GfT8suWTk418y9gJIWmNhQOC9M4mg1lSgpLoX3uqy+qGPaUho4RGjhFBViqj6m+9gcOf2UMclW8iDZgi0QlSkLfD1H/GHHbQHcVGGtB5BOY6grzUa0/PYsClMPD01spYIoHHQNrMOeIFm3T3mmwfELg70aXvxazAtDDT/BhMuu1g1LOgyOVxAVrHrS4obcYVyl0Su9FI2MGxUcHLESO3Rogbb0GpqgfdWofKHNajF+Mz2IfuASVk7ikWdSWC1wy5yEehmdTyAUvGyc63OvR05sO5/D1mde2VRfVdjZpcCJopfQWZMkZKycMHdkz+7zlQIzkj+UNo+KX7fi/ets37EI5Wnz+HuSA6jMr3lDPvPti6rh70xI62bb1cH7E4R+YafGG8vZTqw27bGpCl7aAdb9eYQiPqXgXJ/zuV2s+qa52H4Hh6gN8AAL5+mPzW6Lf+VdWmHYKQxXTzu59PQ7bUkO8lP0TZbCL0GSQL+ZTpA5uRur54VP8142of5WrgcYytU8X+wgiwgXmqr9vmY1i4gJ97sscUa7XslISWmUsawRvWZ7nstkbaV8wKq/wRRWrHkYYA8JVB2DlH6hgAnL0CA33NdG2lewNiPSUNfzJnrVIGRDobje8jGU2diK28eSqBznh/YfRHYGVuYQLZYCJRe2bWBuGhy5SmeXjCWuK4nM1HJNz1P27xj3a5LZFgYYl86Qae9FEFZIs5nAqB8gGyfjBtqGRZ7kAVYfj40srvGaYVEwLsK0rlPyw8oPQFftVdllDZsTT6iixW3xZPKaesIqlfavXDSDLTuFs+WmRWxlGfvfxGX7IW+QKrB22VybfN7llmRtQplKyzDaKn0cohAmbgstMHEOH6EX7WVnFtcoXu2SOYwCJATJARNkzZhb5c3DKvTEGp9nGLsraza5UY6QZ1TzAaapXu7JdKVeN7BHZfx9lpuLJk8gpdzwzewOnRTzRTBxXa9DGP5YfnLnarZ2Ec8i647v5pDuRzh8rJNAWTF0A9TJEof569IQQM+5tj1+s9/AEQGCyhVGL/ZQ4ZH7N287fX3I+uPcgVrnpYD5sOZvXWkY+czsXFNW2O1xCQYl/z/HliZ5x33STgdgx7KR3uTh/4DC7ui1y/CSA1BBFPaShS+iRnatPzmwzi8VAsObulNifTNy96P1EZ2lUG6fszB+0z6pF2z17LGlZlX2j0YzSvQqMBN0WfRgAEWRwWs4nbrbSlcp+QbJZJCjKuL+3jEiu5m81K6SD5LEZUS/5lQr40mKvzTHvd8qPCEvhXLDYnqBt7KPzKb3ghN2IQFQmexgDYXRqTksJUohbF/JGX2nYzuStn0SljmbyUhFLZvAqneFsFqhi0zSWGxk0UMMswSqBoWdZB/BrvDsMhb9v8izaFfWfO1EYKwtDG5salh615fjUFoWJ+19vFZpSOFSC8sZSofKbqcvhfLcqIYVK0YxRM90hoSX9gq2BN1joiGqjcsaPNduBkhUWxHqTZ+0JRmOYFbtXyT4hSBZZedThSfsJjPth4J7iw79DJnaP2LdplBIjI4lM2h9MRyuuBSh1iqOWvXZtMMJ0jePQVsEOnfEYvJ/TBZcGSoTGSP/5OLF/MI5UQOeCfWtSRm/ut7E+tKfxzl6t7SopwOTtET9M5j81qtQJcHe00P3KOqfRx4+t9VglJttjKWO/cJqXujodOqEiWfZdMZdbcdvpBuI6RTbqncWGHImAm7Ot24ZUMIInt4bOc4oaBjk4b4wGCk5Dh4r3plQw/Mtlp60xRhVnHjKRV7mntsCYWDVlf0PgYIon6ohYYjMZAk3dXzha7bTBe+TzEQhK149q+yJrNu3dGbYnZoZJUkWDRdGBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":11139,"cache_read_input_tokens":32899,"cache_creation":{"ephemeral_5m_input_tokens":11139,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG5cXVB1M7vbdiH8neL","type":"assistant","uuid":"61b4dd7a-cfab-42cf-9f28-5555ff53390b","timestamp":"2026-01-25T01:53:07.634Z"}
{"parentUuid":"61b4dd7a-cfab-42cf-9f28-5555ff53390b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KhGeekPffwXAQfW1xv2QCW","type":"message","role":"assistant","content":[{"type":"text","text":"Necesito ver cómo se muestran los planes en la vista de `/planes-clientes` para entender la diferencia."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":11139,"cache_read_input_tokens":32899,"cache_creation":{"ephemeral_5m_input_tokens":11139,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG5cXVB1M7vbdiH8neL","type":"assistant","uuid":"5eb06e24-4c32-478d-a121-68135f4cacb0","timestamp":"2026-01-25T01:53:07.647Z"}
{"parentUuid":"5eb06e24-4c32-478d-a121-68135f4cacb0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KhGeekPffwXAQfW1xv2QCW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UDaJAho3xAsfP6mfbMc4As","name":"Glob","input":{"pattern":"**/views/**/planes/**/*.blade.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":11139,"cache_read_input_tokens":32899,"cache_creation":{"ephemeral_5m_input_tokens":11139,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG5cXVB1M7vbdiH8neL","type":"assistant","uuid":"a6c28d53-a9ab-41a7-b16c-d659ad25d33a","timestamp":"2026-01-25T01:53:08.279Z"}
{"parentUuid":"a6c28d53-a9ab-41a7-b16c-d659ad25d33a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KhGeekPffwXAQfW1xv2QCW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Prc1ok5RL49eywrcXZfyYU","name":"Grep","input":{"pattern":"plan_credito|planCredito|creditos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":11139,"cache_read_input_tokens":32899,"cache_creation":{"ephemeral_5m_input_tokens":11139,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG5cXVB1M7vbdiH8neL","type":"assistant","uuid":"32c78620-9984-45c2-b8e6-1c2b345c1094","timestamp":"2026-01-25T01:53:10.089Z"}
{"parentUuid":"32c78620-9984-45c2-b8e6-1c2b345c1094","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Prc1ok5RL49eywrcXZfyYU","type":"tool_result","content":"Found 3 files\nresources\\views\\empresa\\paginas\\planes\\planes.blade.php\nresources\\views\\empresa\\paginas\\planes\\modal-consumos-creditos.blade.php\nresources\\views\\empresa\\paginas\\planes\\modal-recompras.blade.php"}]},"uuid":"4fdb736c-98c9-4472-93bf-8d9dd350b562","timestamp":"2026-01-25T01:53:13.262Z","toolUseResult":{"mode":"files_with_matches","filenames":["resources\\views\\empresa\\paginas\\planes\\planes.blade.php","resources\\views\\empresa\\paginas\\planes\\modal-consumos-creditos.blade.php","resources\\views\\empresa\\paginas\\planes\\modal-recompras.blade.php"],"numFiles":3},"sourceToolAssistantUUID":"32c78620-9984-45c2-b8e6-1c2b345c1094"}
{"parentUuid":"a6c28d53-a9ab-41a7-b16c-d659ad25d33a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UDaJAho3xAsfP6mfbMc4As","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\modal-consumos.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\excel\\planes\\planes.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\paginas\\consumos.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\paginas\\crear.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\modal-recompras.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\index.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\paginas\\crear-plan-creditos.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\modal-consumos-creditos.blade.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\planes.blade.php"}]},"uuid":"d412647c-c1a1-4fd2-ba58-73e1dc26ce5e","timestamp":"2026-01-25T01:53:14.323Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\modal-consumos.blade.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\excel\\planes\\planes.blade.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\paginas\\consumos.blade.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\paginas\\crear.blade.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\modal-recompras.blade.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\index.blade.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\paginas\\crear-plan-creditos.blade.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\modal-consumos-creditos.blade.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\planes.blade.php"],"durationMs":2423,"numFiles":9,"truncated":false},"sourceToolAssistantUUID":"a6c28d53-a9ab-41a7-b16c-d659ad25d33a"}
{"parentUuid":"d412647c-c1a1-4fd2-ba58-73e1dc26ce5e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_018hjYfd4K78Auxe8FfoRqSa","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Bien, encontré el archivo. Déjame leer la vista de planes del cliente para ver cómo se muestran los planes de créditos.","signature":"EqQCCkYICxgCKkDvpZes/PaUWxnrNUNUlBS+rzZUVs2SfKTNoPughjAs9pSMGGqLJewRu1qZRsoNnmIWqpgBnhg0Hc0v97j/FdHDEgxZAECQXsXAtt16AdYaDNZ+7bQj3S+5DBCKryIwwUvwKPHjfjf8tud5WOdxZCr9garZPg0kRDgOLv93HyjoX45jwCJbryKiTwmYcy7yKosB313AViMzGIzSIoQwwNuOC/u1jZ0BiNEoJJnoAjuyypk0RKNaANc4RiEBTriusItiRVXBvZ4teODZ1Ednw89sXYw2ffLKnLhak4UoH2icuqoPW+aAdA2vltS0gSUkO+91fKsV0ORQR2iSJqS7FX04AbZXo08JISjaHxqalImWFJrBzy4WLjJ49pyKhBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":104,"cache_creation_input_tokens":1168,"cache_read_input_tokens":44038,"cache_creation":{"ephemeral_5m_input_tokens":1168,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG6wFQ9HEh9teQovg3W","type":"assistant","uuid":"8c51a348-d585-4d75-9c5a-3c2af6884972","timestamp":"2026-01-25T01:53:17.434Z"}
{"parentUuid":"8c51a348-d585-4d75-9c5a-3c2af6884972","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_018hjYfd4K78Auxe8FfoRqSa","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019L8ct2YjPypsiPk4qLvzSQ","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\planes.blade.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":104,"cache_creation_input_tokens":1168,"cache_read_input_tokens":44038,"cache_creation":{"ephemeral_5m_input_tokens":1168,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG6wFQ9HEh9teQovg3W","type":"assistant","uuid":"f593b757-3bef-4cf3-81f9-9a055c548dbb","timestamp":"2026-01-25T01:53:18.240Z"}
{"parentUuid":"f593b757-3bef-4cf3-81f9-9a055c548dbb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019L8ct2YjPypsiPk4qLvzSQ","type":"tool_result","content":"     1→@extends('layouts.app')\n     2→\n     3→@section('titulo', 'Mi empresa')\n     4→\n     5→@section('estilos')\n     6→    <link href=\"{{ asset('css/empresa/planes.css') }}\" rel=\"stylesheet\">\n     7→@endsection\n     8→\n     9→@section('contenido')\n    10→    <input type=\"hidden\" id=\"input_empresa_id\" value=\"{{ $empresa->id ?? '' }}\">\n    11→    <input type=\"hidden\" id=\"input_usuario_id\" value=\"{{ $usuario_id ?? '' }}\">\n    12→    <input type=\"hidden\" id=\"input_usuarios\" value=\"{{ json_encode($usuarios) }}\">\n    13→    <input type=\"hidden\" id=\"input_sucursales\" value=\"{{ json_encode($sucursales) }}\">\n    14→    <input type=\"hidden\" id=\"input_empresa\" value=\"{{ json_encode($empresa) }}\">\n    15→    <input type=\"hidden\" id=\"input_planes\" value=\"{{ json_encode($planes) }}\">\n    16→    @php\n    17→        $empresa_sesion = obtenerEmpresaSesion();\n    18→        $empresa_padre = obtenerEmpresaPadre($empresa_sesion);\n    19→    @endphp\n    20→    ${contenedorPrincipal({\n    21→        cabecera: `\n    22→            <div class=\"col-12\">\n    23→                <h1 class=\"text-headline-1\">Mi Empresa</h1>\n    24→            </div>\n    25→            <div class=\"col-auto\">\n    26→                <table>\n    27→                    <tr>\n    28→                        <td>\n    29→                            @if(auth()->user()->hasAnyRole(['Administrador general', 'Propietario']))\n    30→                                ${crearBotonImagenIcono({\n    31→                                    id: 'btn_editar_icono_empresa',\n    32→                                    clase: 'clase-personalizada',\n    33→                                    imagen: '{{ asset('/empresas-logo') }}/{{ Session::get('empresa_id') }}',\n    34→                                    claseicon: 'bg-primary text-white',\n    35→                                    icon: 'bi bi-pencil-square text-white',\n    36→                                    size: 48,\n    37→                                    url: '/empresa-cambiar-logo'\n    38→                                })}\n    39→                            @else\n    40→                                ${crearBotonImagenIcono({\n    41→                                    id: 'btn_editar_icono_empresa',\n    42→                                    clase: 'clase-personalizada',\n    43→                                    imagen: '{{ asset('/empresas-logo') }}/{{ Session::get('empresa_id') }}',\n    44→                                    size: 48,\n    45→                                })}\n    46→                            @endif\n    47→                        </td>\n    48→                        <td>\n    49→                            <span class=\"mx-3 text-headline-2\" id=\"nombre-comercial-empresa-cabecera\">{{$empresa_sesion->nombre_comercial}}</span>\n    50→                        </td>\n    51→                        <td>\n    52→                            @if ($empresa_sesion->empresa_id != null)\n    53→                                <span class=\"mx-3 text-body-3\">Sucursal de {{$empresa_padre->nombre_comercial}}</span>\n    54→                            @else\n    55→                                <span class=\"mx-3 text-body-3\">Sucursales: {{ $empresa_sesion->sucursales->count() }}</span>\n    56→                            @endif\n    57→                        </td>\n    58→                    </tr>\n    59→                </table>\n    60→            </div>\n    61→        `,\n    62→        contenido: `\n    63→            <div class=\"card\">\n    64→                @include('componentes.menu-superior', [\n    65→                    'rutas' => $rutas_menu->where('slug', 'empresa')->first()?->rutas,\n    66→                    'activo' => 'planes-clientes',\n    67→                ])\n    68→                <div class=\"card-body\">\n    69→                    <div class=\"d-flex justify-content-end\">\n    70→                        <button class=\"btn btn-outline-primary btn-lg mb-4 text-label-1\" type=\"button\" id=\"boton-modal-recompras\"><i class=\"bi bi-cart-fill text-headline-4 me-3\"></i> Historial de compras</button>\n    71→                    </div>\n    72→                    <div id=\"listado-planes\"></div>\n    73→                </div>\n    74→            </div>\n    75→        `\n    76→    })}\n    77→@endsection\n    78→\n    79→@section('modals')\n    80→    ${crearModal({\n    81→        id: 'modal-solicitar-renovacion',\n    82→        dialog_class: 'modal-dialog-centered',\n    83→        titulo_header: 'Solicitar renovación',\n    84→        subtitulo_header: `¿Desea enviar una solicitud de renovación para el plan \"<span class=\"fw-bolder\" id=\"nombre-plan-solicitar-renovacion\"></span>\"?`,\n    85→        boton_footer1: {\n    86→            type: 'button',\n    87→            texto: 'Cancelar',\n    88→            class: 'btn-outline-primary',\n    89→            cerrar_modal: true,\n    90→        },\n    91→        boton_footer2: {\n    92→            type: 'submit',\n    93→            texto: 'Si, solicitar',\n    94→            class: 'btn-primary',\n    95→            cerrar_modal: false,\n    96→            onclick: 'solicitarRenovacionPlan()',\n    97→        },\n    98→        modal_body: `\n    99→            <input type=\"hidden\" id=\"id-plan-solicitar-renovacion\">\n   100→            <input type=\"hidden\" id=\"tipo-plan-solicitar-renovacion\">\n   101→        `\n   102→    })}\n   103→    @include('empresa.paginas.planes.modal-recompras')\n   104→    @include('empresa.paginas.planes.modal-consumos')\n   105→    @include('empresa.paginas.planes.modal-consumos-creditos')\n   106→@endsection\n   107→\n   108→@section('scripts')\n   109→    <script>\n   110→        const configuracion_tablas = {\n   111→            autoWidth: false,\n   112→            responsive: true,\n   113→            processing: false,\n   114→            serverSide: false,\n   115→            searching: true,\n   116→            deferRender: true,\n   117→            paging: true,\n   118→            aaSorting: [],\n   119→            language: lenguaje_componente_datatables,\n   120→            lengthMenu: [\n   121→                [5, 10, 25, 50, 100, 200],\n   122→                [5, 10, 25, 50, 100, 200]\n   123→            ],\n   124→            scrollX: true,\n   125→            scrollY: 'calc(100vh - 400px)',\n   126→            scrollCollapse: true,\n   127→        };\n   128→\n   129→    </script>\n   130→    <script src=\"{{ asset('js/empresa/planes/planes.js') }}\" type=\"text/javascript\"></script>\n   131→    <script src=\"{{ asset('js/empresa/planes/modal-recompras.js') }}\" type=\"text/javascript\"></script>\n   132→    <script src=\"{{ asset('js/empresa/planes/modal-consumos.js') }}\" type=\"text/javascript\"></script>\n   133→    <script src=\"{{ asset('js/empresa/planes/modal-consumos-creditos.js') }}\" type=\"text/javascript\"></script>\n   134→@endsection\n   135→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b85f5283-cbfe-4d2b-9609-b350796da08f","timestamp":"2026-01-25T01:53:19.434Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\empresa\\paginas\\planes\\planes.blade.php","content":"@extends('layouts.app')\n\n@section('titulo', 'Mi empresa')\n\n@section('estilos')\n    <link href=\"{{ asset('css/empresa/planes.css') }}\" rel=\"stylesheet\">\n@endsection\n\n@section('contenido')\n    <input type=\"hidden\" id=\"input_empresa_id\" value=\"{{ $empresa->id ?? '' }}\">\n    <input type=\"hidden\" id=\"input_usuario_id\" value=\"{{ $usuario_id ?? '' }}\">\n    <input type=\"hidden\" id=\"input_usuarios\" value=\"{{ json_encode($usuarios) }}\">\n    <input type=\"hidden\" id=\"input_sucursales\" value=\"{{ json_encode($sucursales) }}\">\n    <input type=\"hidden\" id=\"input_empresa\" value=\"{{ json_encode($empresa) }}\">\n    <input type=\"hidden\" id=\"input_planes\" value=\"{{ json_encode($planes) }}\">\n    @php\n        $empresa_sesion = obtenerEmpresaSesion();\n        $empresa_padre = obtenerEmpresaPadre($empresa_sesion);\n    @endphp\n    ${contenedorPrincipal({\n        cabecera: `\n            <div class=\"col-12\">\n                <h1 class=\"text-headline-1\">Mi Empresa</h1>\n            </div>\n            <div class=\"col-auto\">\n                <table>\n                    <tr>\n                        <td>\n                            @if(auth()->user()->hasAnyRole(['Administrador general', 'Propietario']))\n                                ${crearBotonImagenIcono({\n                                    id: 'btn_editar_icono_empresa',\n                                    clase: 'clase-personalizada',\n                                    imagen: '{{ asset('/empresas-logo') }}/{{ Session::get('empresa_id') }}',\n                                    claseicon: 'bg-primary text-white',\n                                    icon: 'bi bi-pencil-square text-white',\n                                    size: 48,\n                                    url: '/empresa-cambiar-logo'\n                                })}\n                            @else\n                                ${crearBotonImagenIcono({\n                                    id: 'btn_editar_icono_empresa',\n                                    clase: 'clase-personalizada',\n                                    imagen: '{{ asset('/empresas-logo') }}/{{ Session::get('empresa_id') }}',\n                                    size: 48,\n                                })}\n                            @endif\n                        </td>\n                        <td>\n                            <span class=\"mx-3 text-headline-2\" id=\"nombre-comercial-empresa-cabecera\">{{$empresa_sesion->nombre_comercial}}</span>\n                        </td>\n                        <td>\n                            @if ($empresa_sesion->empresa_id != null)\n                                <span class=\"mx-3 text-body-3\">Sucursal de {{$empresa_padre->nombre_comercial}}</span>\n                            @else\n                                <span class=\"mx-3 text-body-3\">Sucursales: {{ $empresa_sesion->sucursales->count() }}</span>\n                            @endif\n                        </td>\n                    </tr>\n                </table>\n            </div>\n        `,\n        contenido: `\n            <div class=\"card\">\n                @include('componentes.menu-superior', [\n                    'rutas' => $rutas_menu->where('slug', 'empresa')->first()?->rutas,\n                    'activo' => 'planes-clientes',\n                ])\n                <div class=\"card-body\">\n                    <div class=\"d-flex justify-content-end\">\n                        <button class=\"btn btn-outline-primary btn-lg mb-4 text-label-1\" type=\"button\" id=\"boton-modal-recompras\"><i class=\"bi bi-cart-fill text-headline-4 me-3\"></i> Historial de compras</button>\n                    </div>\n                    <div id=\"listado-planes\"></div>\n                </div>\n            </div>\n        `\n    })}\n@endsection\n\n@section('modals')\n    ${crearModal({\n        id: 'modal-solicitar-renovacion',\n        dialog_class: 'modal-dialog-centered',\n        titulo_header: 'Solicitar renovación',\n        subtitulo_header: `¿Desea enviar una solicitud de renovación para el plan \"<span class=\"fw-bolder\" id=\"nombre-plan-solicitar-renovacion\"></span>\"?`,\n        boton_footer1: {\n            type: 'button',\n            texto: 'Cancelar',\n            class: 'btn-outline-primary',\n            cerrar_modal: true,\n        },\n        boton_footer2: {\n            type: 'submit',\n            texto: 'Si, solicitar',\n            class: 'btn-primary',\n            cerrar_modal: false,\n            onclick: 'solicitarRenovacionPlan()',\n        },\n        modal_body: `\n            <input type=\"hidden\" id=\"id-plan-solicitar-renovacion\">\n            <input type=\"hidden\" id=\"tipo-plan-solicitar-renovacion\">\n        `\n    })}\n    @include('empresa.paginas.planes.modal-recompras')\n    @include('empresa.paginas.planes.modal-consumos')\n    @include('empresa.paginas.planes.modal-consumos-creditos')\n@endsection\n\n@section('scripts')\n    <script>\n        const configuracion_tablas = {\n            autoWidth: false,\n            responsive: true,\n            processing: false,\n            serverSide: false,\n            searching: true,\n            deferRender: true,\n            paging: true,\n            aaSorting: [],\n            language: lenguaje_componente_datatables,\n            lengthMenu: [\n                [5, 10, 25, 50, 100, 200],\n                [5, 10, 25, 50, 100, 200]\n            ],\n            scrollX: true,\n            scrollY: 'calc(100vh - 400px)',\n            scrollCollapse: true,\n        };\n\n    </script>\n    <script src=\"{{ asset('js/empresa/planes/planes.js') }}\" type=\"text/javascript\"></script>\n    <script src=\"{{ asset('js/empresa/planes/modal-recompras.js') }}\" type=\"text/javascript\"></script>\n    <script src=\"{{ asset('js/empresa/planes/modal-consumos.js') }}\" type=\"text/javascript\"></script>\n    <script src=\"{{ asset('js/empresa/planes/modal-consumos-creditos.js') }}\" type=\"text/javascript\"></script>\n@endsection\n","numLines":135,"startLine":1,"totalLines":135}},"sourceToolAssistantUUID":"f593b757-3bef-4cf3-81f9-9a055c548dbb"}
{"parentUuid":"b85f5283-cbfe-4d2b-9609-b350796da08f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_015bZvcQW1vTydrzLRPeG14v","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito leer el archivo JavaScript que maneja la visualización de planes en la vista de empresa para ver cómo se muestran los planes de créditos.","signature":"EsQCCkYICxgCKkBrZRC/r4G8eDwF+dGOYy6PGXALkyB2jx14UIXmKY+PGEJ+3XF5CLis/Eq8SF5epupe2hgmgEaM7m9aCH7b+XmzEgxmM3T4vgNVHPHBJeMaDH/n2V6o/YjR0tiWhCIwlDcuKIXEH4nBu/YWMNlS9TqWI5xTx/zri8XHH5YdiA0R1249QE5jet0fGFVRFFSDKqsB7Mhsi+/Qk6wu4fzk5Q5vahv+/c78b/E0pPNPMtoGY4ytIJTPjDtkGjIiP5UiP5KphsRac3d25wJXQM5t2/9x/99VODUSmqYIOTU7sL8TjcKCCdX9gJYgiujEY40qXCiWGAIqJZeKWnxZymipeYwIp99291nbbjnd32QbCvqaBGdR1UyeyU6aU9kEgR4ZIDsFTJaqX1afSAJbSjyK5u67j0c9fw3k9WaRSjz4GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2395,"cache_read_input_tokens":45206,"cache_creation":{"ephemeral_5m_input_tokens":2395,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTG7KJTL7w6zpgevNj3z","type":"assistant","uuid":"3d973be6-08ff-405f-8a0b-0c232aafff19","timestamp":"2026-01-25T01:53:22.049Z"}
{"parentUuid":"3d973be6-08ff-405f-8a0b-0c232aafff19","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_015bZvcQW1vTydrzLRPeG14v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016pC2heChv3N1WZn8p8Hpwk","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2395,"cache_read_input_tokens":45206,"cache_creation":{"ephemeral_5m_input_tokens":2395,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTG7KJTL7w6zpgevNj3z","type":"assistant","uuid":"f125bb66-0911-4777-9535-e3c7ca01f58a","timestamp":"2026-01-25T01:53:22.566Z"}
{"parentUuid":"f125bb66-0911-4777-9535-e3c7ca01f58a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016pC2heChv3N1WZn8p8Hpwk","type":"tool_result","content":"     1→let empresa_id = $('#input_empresa_id').val();\n     2→let usuario_id = $('#input_usuario_id').val();\n     3→let empresas_planes = [];\n     4→let usuarios_ids = [];\n     5→let sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     6→let usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     7→let empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     8→let planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     9→usuarios_ids = usuarios.map(usuario => usuario.id);\n    10→let total_usuarios = usuarios_ids.length;\n    11→\n    12→const ESTADOS_PLANES = {\n    13→    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    14→    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    15→    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    16→    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    17→    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    18→    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n    19→};\n    20→\n    21→const ICONOS_PLANES_TIPO = {\n    22→    'Selección': 'bi-person-bounding-box',\n    23→    'Organizacional': 'bi-diagram-3-fill',\n    24→    'Vocacional': 'bi-mortarboard-fill',\n    25→};\n    26→\n    27→/**\n    28→ * Obtiene la data para mostrar en la tabla de planes de la empresa.\n    29→ *\n    30→ * @returns {void}\n    31→ * @author Andres Morales\n    32→ * @author Fahibram Cárcamo\n    33→ * @author Sergio Vargas\n    34→*/\n    35→async function traerDatos() {\n    36→    try {\n    37→        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n    38→        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n    39→        empresas_planes = respuesta.data.empresas_planes;\n    40→    } catch (error) {\n    41→        console.error(error);\n    42→    }\n    43→}\n    44→traerDatos();\n    45→\n    46→/**\n    47→ * Crea el componente html de los planes de la empresa\n    48→ *\n    49→ * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n    50→ * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n    51→ * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n    52→ * @returns {void}\n    53→ * @author Fahibram Cárcamo\n    54→ * @author Andres Morales\n    55→ * @author Jair Carvajal\n    56→ * @author Andres González\n    57→ */\n    58→function listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    59→    let contenidoHTML = empresas_planes.map(empresa_plan => {\n    60→        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n    61→        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n    62→\n    63→        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n    64→        if (!plan && !empresa_plan.plan_credito) {\n    65→            return '';\n    66→        }\n    67→        let suscripcion_ilimitada = !!fecha_vencimiento;\n    68→\n    69→        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n    70→            ? empresa_plan.fecha_inicio\n    71→            : (new Date()).toString();\n    72→\n    73→        let dias_restantes = suscripcion_ilimitada\n    74→            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n    75→            : null;\n    76→\n    77→        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n    78→        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n    79→\n    80→        return empresa_plan.plan_credito_id === null ? `\n    81→            <div class=\"card my-5\">\n    82→                <div class=\"card-body\">\n    83→                    <div class=\"row\">\n    84→                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n    85→                        <div class=\"col-auto my-auto\">\n    86→                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n    87→                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n    88→                        </div>\n    89→                        <div class=\"col-auto ms-auto my-auto\">\n    90→                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n    91→                        </div>\n    92→                        <div class=\"col-auto my-auto\">\n    93→                            <div class=\"dropdown\">\n    94→                                ${crearBoton({\n    95→                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n    96→                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n    97→                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n    98→                                })}\n    99→                                <div class=\"dropdown-menu dropdown-menu-start\">\n   100→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n   101→                                        Solicitar renovación\n   102→                                    </button>\n   103→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n   104→                                        Ver factura\n   105→                                    </button>\n   106→                                </div>\n   107→                            </div>\n   108→                        </div>\n   109→                    </div>\n   110→                    <div class=\"table-responsive mt-4\">\n   111→                        <table class=\"table\">\n   112→                            <tbody>\n   113→                                <tr id=\"contenedor_plan_padre\">\n   114→                                    <td class=\"py-0 my-0 border-0\">\n   115→                                        <div class=\"card bg-gray-90 border-0\">\n   116→                                            <div class=\"card-body py-2\">\n   117→                                                <div class=\"row\">\n   118→                                                    <div class=\"col-auto my-auto\">\n   119→                                                        ${crearBoton({\n   120→                                                            clases: 'btn-text-gray text-label-2',\n   121→                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   122→                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   123→                                                        })}\n   124→                                                    </div>\n   125→                                                    <div class=\"col my-auto\">\n   126→                                                        <div class=\"card bg-white border-0\">\n   127→                                                            <div class=\"card-body py-2\">\n   128→                                                                <div class=\"row\">\n   129→                                                                    <div class=\"col-4 px-7\">\n   130→                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n   131→                                                                    </div>\n   132→                                                                    <div class=\"col-4 px-7\">\n   133→                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n   134→                                                                    </div>\n   135→                                                                    <div class=\"col-4 px-7\">\n   136→                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n   137→                                                                    </div>\n   138→                                                                </div>\n   139→                                                            </div>\n   140→                                                        </div>\n   141→                                                    </div>\n   142→                                                    <div class=\"col-auto my-auto ps-0\">\n   143→                                                        ${crearBoton({\n   144→                                                            tooltip: `${crearTooltip({\n   145→                                                                placement: `top`,\n   146→                                                                content: `Detalle de consumo`,\n   147→                                                                toggle: `popover`,\n   148→                                                            })}`,\n   149→                                                            clases: 'btn-text-primary btn-circle p-2',\n   150→                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   151→                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n   152→                                                        })}\n   153→                                                    </div>\n   154→                                                </div>\n   155→                                            </div>\n   156→                                        </div>\n   157→                                    </td>\n   158→                                </tr>\n   159→                                ${lista_consumos_por_sucursal}\n   160→                            </tbody>\n   161→                        </table>\n   162→                    </div>\n   163→                    <div class=\"row mt-5\">\n   164→                        <div class=\"col-auto\">\n   165→                            <p class=\"text-label-2\">\n   166→                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n   167→                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n   168→                            </p>\n   169→                        </div>\n   170→                        <div class=\"col-auto ms-auto\">\n   171→                            <p class=\"text-label-2\">\n   172→                                <span class=\"me-4\">Vigencia</span>\n   173→                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n   174→                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n   175→                            </p>\n   176→                        </div>\n   177→                    </div>\n   178→                </div>\n   179→            </div>\n   180→        ` : `\n   181→            <div class=\"card my-5\">\n   182→                <div class=\"card-body\">\n   183→                    <div class=\"row\">\n   184→                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n   185→                        <div class=\"col-auto my-auto\">\n   186→                            <p class=\"m-0 text-body-3\"><img src=\"/iconos/icono_ia_azul.svg\" alt=\"IA\" class=\"me-2\">Plan de Créditos</p>\n   187→                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n   188→                        </div>\n   189→                        <div class=\"col-auto ms-auto my-auto\">\n   190→                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n   191→                        </div>\n   192→                        <div class=\"col-auto my-auto\">\n   193→                            <div class=\"dropdown\">\n   194→                                ${crearBoton({\n   195→                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n   196→                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n   197→                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n   198→                                })}\n   199→                                <div class=\"dropdown-menu dropdown-menu-start\">\n   200→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}', 'plan_credito')\">\n   201→                                        Solicitar renovación\n   202→                                    </button>\n   203→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n   204→                                        Ver factura\n   205→                                    </button>\n   206→                                </div>\n   207→                            </div>\n   208→                        </div>\n   209→                    </div>\n   210→                    <div class=\"row mt-4\">\n   211→                        <div class=\"col-12\">\n   212→                            <div class=\"card bg-gray-90 border-0\">\n   213→                                <div class=\"card-body py-3\">\n   214→                                    <div class=\"row\">\n   215→                                        <div class=\"col-auto my-auto\">\n   216→                                            ${crearBoton({\n   217→                                                clases: 'btn-text-gray text-label-2',\n   218→                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   219→                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   220→                                            })}\n   221→                                        </div>\n   222→                                        <div class=\"col my-auto\">\n   223→                                            ${crearProgressBarTemplate('Créditos disponibles', '/iconos/icono_ia.svg', empresa_plan.creditos_consumidos ?? 0, empresa_plan.plan_credito.creditos ?? 0, true)}\n   224→                                        </div>\n   225→                                        <div class=\"col-auto my-auto ps-0\">\n   226→                                            ${crearBoton({\n   227→                                                tooltip: `${crearTooltip({\n   228→                                                    placement: `top`,\n   229→                                                    content: `Ver detalle consumo`,\n   230→                                                    toggle: `popover`,\n   231→                                                })}`,\n   232→                                                clases: 'btn-text-primary btn-circle p-2',\n   233→                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   234→                                                onclick: `abrirModalConsumosCreditos(${empresa_plan.empresa_id}, ${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}')`,\n   235→                                            })}\n   236→                                        </div>\n   237→                                    </div>\n   238→                                </div>\n   239→                            </div>\n   240→                        </div>\n   241→                    </div>\n   242→                </div>\n   243→            </div>\n   244→        `;\n   245→    }).join('');\n   246→\n   247→    $('#listado-planes').html(contenidoHTML);\n   248→    inicializarTooltips();\n   249→}\n   250→\n   251→/**\n   252→ * Crea el componente HTML de los progress bars de los consumos.\n   253→ *\n   254→ * @param {string} label Etiqueta del progress bar.\n   255→ * @param {string} icono Icono del progress bar.\n   256→ * @param {number} valor Valor actual del consumo.\n   257→ * @param {number} total Valor total del consumo.\n   258→ * @param {boolean} un_text Booleano para mostrar o no el texto.\n   259→ * @returns {string} HTML del progress bar.\n   260→ * @author Andres Morales\n   261→ * @author Andres Gonzalez\n   262→ */\n   263→function crearProgressBarTemplate(label, icono, valor, total, un_text) {\n   264→    let icono_html = '';\n   265→    if (icono) {\n   266→        if (icono.startsWith('/') || icono.includes('.svg')) {\n   267→            icono_html = `<img src=\"${icono}\" alt=\"${label}\" class=\"me-2\">`;\n   268→        } else {\n   269→            icono_html = `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>`;\n   270→        }\n   271→    }\n   272→    return `\n   273→        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono_html}${label}${un_text ? '</p>' : ''}\n   274→        ${crearProgressBar({\n   275→            label: `${valor}/${total ?? 0}`,\n   276→            height: '8px',\n   277→            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n   278→        })}\n   279→    `;\n   280→}\n   281→\n   282→/**\n   283→ * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n   284→ *\n   285→ * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n   286→ * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n   287→ * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n   288→ * @returns {string}\n   289→ * @author Andres Morales\n   290→ * @author Fahibram Cárcamo\n   291→ * @author Sergio Vargas\n   292→ */\n   293→function listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n   294→    if (!empresa_plan.plan) {\n   295→        return '';\n   296→    }\n   297→    return sucursales.map(sucursal => {\n   298→        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n   299→        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n   300→\n   301→        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n   302→            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n   303→            ?.conteo_consumos ?? 0;\n   304→\n   305→        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n   306→            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n   307→            ?.conteo_consumos ?? 0;\n   308→\n   309→        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n   310→        let plan = empresa_plan.plan;\n   311→\n   312→        return `\n   313→            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n   314→                <td class=\"py-0 my-0\">\n   315→                    <div class=\"card border-0\">\n   316→                        <div class=\"card-body py-2 px-10\">\n   317→                            <div class=\"row\">\n   318→                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n   319→                                    ${sucursal.nombre_comercial}\n   320→                                </div>\n   321→                                <div class=\"col my-auto\">\n   322→                                    <div class=\"card bg-white border-0\">\n   323→                                        <div class=\"card-body py-2\">\n   324→                                            <div class=\"row\">\n   325→                                                <div class=\"col-4 px-7\">\n   326→                                                    ${\n   327→                                                        crearProgressBarTemplate(\n   328→                                                            'Unidades',\n   329→                                                            'box',\n   330→                                                            total_agendas_consumidas_sucursal,\n   331→                                                            plan.unidades,\n   332→                                                            false\n   333→                                                        )\n   334→                                                    }\n   335→                                                </div>\n   336→                                                <div class=\"col-4 px-7\">\n   337→                                                    ${\n   338→                                                        crearProgressBarTemplate(\n   339→                                                            'Vacantes',\n   340→                                                            'briefcase',\n   341→                                                            total_ofertas_laborales_consumidas_sucursal,\n   342→                                                            plan.cantidad_ofertas_laborales,\n   343→                                                            false\n   344→                                                        )\n   345→                                                    }\n   346→                                                </div>\n   347→                                                <div class=\"col-4 px-7\">\n   348→                                                    ${\n   349→                                                        crearProgressBarTemplate(\n   350→                                                            'Usuarios',\n   351→                                                            'person',\n   352→                                                            total_usuarios_sucursal,\n   353→                                                            plan.cantidad_usuarios,\n   354→                                                            false\n   355→                                                        )\n   356→                                                    }\n   357→                                                </div>\n   358→                                            </div>\n   359→                                        </div>\n   360→                                    </div>\n   361→                                </div>\n   362→                            </div>\n   363→                        </div>\n   364→                    </div>\n   365→                </td>\n   366→            </tr>\n   367→        `;\n   368→    }).join('');\n   369→}\n   370→\n   371→/**\n   372→ * Agrupar los consumos de un plan por empresa.\n   373→ *\n   374→ * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n   375→ * @returns {array}\n   376→ * @author Andres Morales\n   377→ */\n   378→function obtenerConsumos(empresa_plan_consumos) {\n   379→    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n   380→\n   381→    let consumos_empresas = new Map();\n   382→\n   383→    empresa_plan_consumos.forEach(consumo => {\n   384→        let empresa = consumo.empresa;\n   385→        if (!consumos_empresas.has(empresa.id)) {\n   386→            empresa.consumos = [];\n   387→            consumos_empresas.set(empresa.id, empresa);\n   388→        }\n   389→        consumos_empresas.get(empresa.id).consumos.push(consumo);\n   390→    });\n   391→\n   392→    sucursales.forEach(sucursal => {\n   393→        if (!consumos_empresas.has(sucursal.id)) {\n   394→            consumos_empresas.set(sucursal.id, sucursal);\n   395→        }\n   396→    });\n   397→\n   398→    return Array.from(consumos_empresas.values());\n   399→}\n   400→\n   401→/**\n   402→ * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n   403→ *\n   404→ * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n   405→ * @returns {number}\n   406→ * @author Andres Morales\n   407→ */\n   408→function obtenerTotalUsuarios(empresa = null) {\n   409→    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n   410→    let usuarios_ids_temporal = new Set();\n   411→    usuarios_temporal.forEach(usuario => {\n   412→        if (usuarios_ids.includes(usuario.id)) {\n   413→            usuarios_ids_temporal.add(usuario.id);\n   414→        }\n   415→    });\n   416→    return usuarios_ids_temporal.size;\n   417→}\n   418→\n   419→/**\n   420→ * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n   421→ *\n   422→ * @param {string} id Id del elemento a mostar u ocultar.\n   423→ * @param {string} elemento Elemento padre del menú de acciones.\n   424→ * @returns {void}\n   425→ * @author Andres Morales\n   426→ */\n   427→function toggleSucursalesList(id, elemento) {\n   428→    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n   429→    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n   430→}\n   431→\n   432→/**\n   433→ * Realizar la consulta HTTP para solicitar la renovación de un plan.\n   434→ *\n   435→ * @returns {void}\n   436→ * @author Fahibram Cárcamo\n   437→ * @author Andres Morales\n   438→ * @author Andres González\n   439→ */\n   440→async function solicitarRenovacionPlan() {\n   441→    $('#modal-solicitar-renovacion').modal('hide');\n   442→    let plan_id = $('#id-plan-solicitar-renovacion').val();\n   443→    let tipo_plan = $('#tipo-plan-solicitar-renovacion').val();\n   444→    await $.ajax({\n   445→        type: 'POST',\n   446→        url : '/solicitud-renovacion-plan',\n   447→        data: {\n   448→            plan_id,\n   449→            tipo_plan,\n   450→            empresa_id,\n   451→            usuario_id,\n   452→            _token: $('meta[name=\"csrf-token\"]').attr('content')\n   453→        }\n   454→    }).then(respuesta => {\n   455→        $('#nombre-plan-solicitar-renovacion').text('');\n   456→        $('#id-plan-solicitar-renovacion').val('');\n   457→        $('#tipo-plan-solicitar-renovacion').val('');\n   458→        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n   459→    }).catch((error) => {\n   460→        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n   461→    });\n   462→}\n   463→\n   464→/**\n   465→ * Abrir el modal de confirmación de solicitud de renovación de un plan.\n   466→ *\n   467→ * @param {number} plan_id Id del plan o plan de créditos.\n   468→ * @param {string} nombre_plan Nombre del plan.\n   469→ * @param {string} tipo_plan Tipo de plan ('plan' o 'plan_credito').\n   470→ * @returns {void}\n   471→ * @author Fahibram Cárcamo\n   472→ * @author Andres González\n   473→ */\n   474→function abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan, tipo_plan = 'plan') {\n   475→    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n   476→    $('#id-plan-solicitar-renovacion').val(plan_id);\n   477→    $('#tipo-plan-solicitar-renovacion').val(tipo_plan);\n   478→    $('#modal-solicitar-renovacion').modal('show');\n   479→}\n   480→\n   481→/**\n   482→ * Abrir la factura del plan en una nueva pestaña del navegador.\n   483→ *\n   484→ * @param {number} factura_id Id de la factura.\n   485→ * @returns {void}\n   486→ * @author Fahibram Cárcamo\n   487→ * @author Andres Morales\n   488→ */\n   489→async function abrirFacturaPlan(factura_id){\n   490→    if (factura_id) {\n   491→        await $.ajax({\n   492→            type: 'GET',\n   493→            url: `archivos-abrir/${factura_id}`,\n   494→            xhrFields: {responseType: 'blob'},\n   495→        })\n   496→            .then(respuesta => {\n   497→                let ruta_factura = window.URL.createObjectURL(respuesta);\n   498→                window.open(ruta_factura, '_blank');\n   499→            })\n   500→            .catch((error) => {\n   501→                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n   502→            });\n   503→    } else {\n   504→        mostrarToast('danger', 'No se encontró la factura');\n   505→    }\n   506→}\n   507→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5c236160-3da9-4f03-918e-c95e06a36e78","timestamp":"2026-01-25T01:53:23.745Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","content":"let empresa_id = $('#input_empresa_id').val();\nlet usuario_id = $('#input_usuario_id').val();\nlet empresas_planes = [];\nlet usuarios_ids = [];\nlet sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nusuarios_ids = usuarios.map(usuario => usuario.id);\nlet total_usuarios = usuarios_ids.length;\n\nconst ESTADOS_PLANES = {\n    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n};\n\nconst ICONOS_PLANES_TIPO = {\n    'Selección': 'bi-person-bounding-box',\n    'Organizacional': 'bi-diagram-3-fill',\n    'Vocacional': 'bi-mortarboard-fill',\n};\n\n/**\n * Obtiene la data para mostrar en la tabla de planes de la empresa.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n * @author Sergio Vargas\n*/\nasync function traerDatos() {\n    try {\n        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n        empresas_planes = respuesta.data.empresas_planes;\n    } catch (error) {\n        console.error(error);\n    }\n}\ntraerDatos();\n\n/**\n * Crea el componente html de los planes de la empresa\n *\n * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Jair Carvajal\n * @author Andres González\n */\nfunction listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    let contenidoHTML = empresas_planes.map(empresa_plan => {\n        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n\n        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n        if (!plan && !empresa_plan.plan_credito) {\n            return '';\n        }\n        let suscripcion_ilimitada = !!fecha_vencimiento;\n\n        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n            ? empresa_plan.fecha_inicio\n            : (new Date()).toString();\n\n        let dias_restantes = suscripcion_ilimitada\n            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n            : null;\n\n        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n\n        return empresa_plan.plan_credito_id === null ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><img src=\"/iconos/icono_ia_azul.svg\" alt=\"IA\" class=\"me-2\">Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}', 'plan_credito')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', '/iconos/icono_ia.svg', empresa_plan.creditos_consumidos ?? 0, empresa_plan.plan_credito.creditos ?? 0, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Ver detalle consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumosCreditos(${empresa_plan.empresa_id}, ${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.\n * @param {number} total Valor total del consumo.\n * @param {boolean} un_text Booleano para mostrar o no el texto.\n * @returns {string} HTML del progress bar.\n * @author Andres Morales\n * @author Andres Gonzalez\n */\nfunction crearProgressBarTemplate(label, icono, valor, total, un_text) {\n    let icono_html = '';\n    if (icono) {\n        if (icono.startsWith('/') || icono.includes('.svg')) {\n            icono_html = `<img src=\"${icono}\" alt=\"${label}\" class=\"me-2\">`;\n        } else {\n            icono_html = `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>`;\n        }\n    }\n    return `\n        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono_html}${label}${un_text ? '</p>' : ''}\n        ${crearProgressBar({\n            label: `${valor}/${total ?? 0}`,\n            height: '8px',\n            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n        })}\n    `;\n}\n\n/**\n * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n *\n * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {string}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n * @author Sergio Vargas\n */\nfunction listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    if (!empresa_plan.plan) {\n        return '';\n    }\n    return sucursales.map(sucursal => {\n        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n\n        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n        let plan = empresa_plan.plan;\n\n        return `\n            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n                <td class=\"py-0 my-0\">\n                    <div class=\"card border-0\">\n                        <div class=\"card-body py-2 px-10\">\n                            <div class=\"row\">\n                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n                                    ${sucursal.nombre_comercial}\n                                </div>\n                                <div class=\"col my-auto\">\n                                    <div class=\"card bg-white border-0\">\n                                        <div class=\"card-body py-2\">\n                                            <div class=\"row\">\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Unidades',\n                                                            'box',\n                                                            total_agendas_consumidas_sucursal,\n                                                            plan.unidades,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Vacantes',\n                                                            'briefcase',\n                                                            total_ofertas_laborales_consumidas_sucursal,\n                                                            plan.cantidad_ofertas_laborales,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Usuarios',\n                                                            'person',\n                                                            total_usuarios_sucursal,\n                                                            plan.cantidad_usuarios,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        `;\n    }).join('');\n}\n\n/**\n * Agrupar los consumos de un plan por empresa.\n *\n * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n * @returns {array}\n * @author Andres Morales\n */\nfunction obtenerConsumos(empresa_plan_consumos) {\n    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n\n    let consumos_empresas = new Map();\n\n    empresa_plan_consumos.forEach(consumo => {\n        let empresa = consumo.empresa;\n        if (!consumos_empresas.has(empresa.id)) {\n            empresa.consumos = [];\n            consumos_empresas.set(empresa.id, empresa);\n        }\n        consumos_empresas.get(empresa.id).consumos.push(consumo);\n    });\n\n    sucursales.forEach(sucursal => {\n        if (!consumos_empresas.has(sucursal.id)) {\n            consumos_empresas.set(sucursal.id, sucursal);\n        }\n    });\n\n    return Array.from(consumos_empresas.values());\n}\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n *\n * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n * @returns {number}\n * @author Andres Morales\n */\nfunction obtenerTotalUsuarios(empresa = null) {\n    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n    let usuarios_ids_temporal = new Set();\n    usuarios_temporal.forEach(usuario => {\n        if (usuarios_ids.includes(usuario.id)) {\n            usuarios_ids_temporal.add(usuario.id);\n        }\n    });\n    return usuarios_ids_temporal.size;\n}\n\n/**\n * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n *\n * @param {string} id Id del elemento a mostar u ocultar.\n * @param {string} elemento Elemento padre del menú de acciones.\n * @returns {void}\n * @author Andres Morales\n */\nfunction toggleSucursalesList(id, elemento) {\n    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n}\n\n/**\n * Realizar la consulta HTTP para solicitar la renovación de un plan.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Andres González\n */\nasync function solicitarRenovacionPlan() {\n    $('#modal-solicitar-renovacion').modal('hide');\n    let plan_id = $('#id-plan-solicitar-renovacion').val();\n    let tipo_plan = $('#tipo-plan-solicitar-renovacion').val();\n    await $.ajax({\n        type: 'POST',\n        url : '/solicitud-renovacion-plan',\n        data: {\n            plan_id,\n            tipo_plan,\n            empresa_id,\n            usuario_id,\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then(respuesta => {\n        $('#nombre-plan-solicitar-renovacion').text('');\n        $('#id-plan-solicitar-renovacion').val('');\n        $('#tipo-plan-solicitar-renovacion').val('');\n        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n    });\n}\n\n/**\n * Abrir el modal de confirmación de solicitud de renovación de un plan.\n *\n * @param {number} plan_id Id del plan o plan de créditos.\n * @param {string} nombre_plan Nombre del plan.\n * @param {string} tipo_plan Tipo de plan ('plan' o 'plan_credito').\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres González\n */\nfunction abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan, tipo_plan = 'plan') {\n    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n    $('#id-plan-solicitar-renovacion').val(plan_id);\n    $('#tipo-plan-solicitar-renovacion').val(tipo_plan);\n    $('#modal-solicitar-renovacion').modal('show');\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id){\n    if (factura_id) {\n        await $.ajax({\n            type: 'GET',\n            url: `archivos-abrir/${factura_id}`,\n            xhrFields: {responseType: 'blob'},\n        })\n            .then(respuesta => {\n                let ruta_factura = window.URL.createObjectURL(respuesta);\n                window.open(ruta_factura, '_blank');\n            })\n            .catch((error) => {\n                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n            });\n    } else {\n        mostrarToast('danger', 'No se encontró la factura');\n    }\n}\n","numLines":507,"startLine":1,"totalLines":507}},"sourceToolAssistantUUID":"f125bb66-0911-4777-9535-e3c7ca01f58a"}
{"parentUuid":"5c236160-3da9-4f03-918e-c95e06a36e78","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Ezb3ZyX7tyJBSPz8anjWd7","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora entiendo todo el panorama. Puedo ver la diferencia clave:\n\n## La vista de empresa (/planes-clientes) - planes.js\n\nEn la función `traerDatos()` (línea 37):\n```javascript\nlet respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n```\n\nUsa un **endpoint diferente**: `empresas-planes-listado-tabla/{empresa_id}` que devuelve todos los planes, incluyendo los de créditos.\n\nEn la función `listarPlanes()` (líneas 58-249):\n- Línea 64-66: Verifica si hay `plan` O `plan_credito`:\n```javascript\nif (!plan && !empresa_plan.plan_credito) {\n    return '';\n}\n```\n- Línea 80: Usa un ternario para mostrar diferente HTML según sea un plan normal o de créditos:\n```javascript\nreturn empresa_plan.plan_credito_id === null ? `\n    // HTML para plan normal\n` : `\n    // HTML para plan de créditos\n`;\n```\n\n## La vista de superadmin (empresas-gestionar) - empresas.js\n\nEn la función `mostrarPlanes()` (líneas 1491-):\n- Línea 1503-1505: **FILTRA los planes de créditos**:\n```javascript\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n```\n- No tiene código para mostrar planes de solo créditos\n\nAdemás, los datos vienen del método `EmpresaService::getUno()` que usa `obtenerPlanActivo()` y `obtenerUltimoPorTipo()`, los cuales filtran usando `whereHas('plan', ...)` excluyendo planes donde `plan_id` es null.\n \nNecesito hacer dos cambios: primero, en el backend, modificar `EmpresaService::getUno()` para incluir planes donde `plan_id` es null pero `plan_credito_id` tiene valor. Segundo, en el frontend, actualizar `mostrarPlanes()` en empresas.js para renderizar planes de créditos igual que lo hace planes.js. Debo verificar si existe un método en el repositorio para obtener estos planes de solo créditos.","signature":"EowQCkYICxgCKkCdUb+NnhpkipXrqmwlvfbF/48scXo/Zlxj8ng51hMWdjJ/kmeVxq2ioleBqeNo+IAW2gyQzefvsGvnquoi2l1iEgyQELLlitW9tUKf+jcaDFf5df0LOv6I2uunHCIwVFhAUIML4HzgoZ9pTX4LWbEBAGBX6VDIjfbyuc0/N/EF+fSzk4rKlaK6lB5ijcJFKvMOfqwapRJ/Nk7RiQz16cktV4nGXwhjYqDsxNkfNGqLjVyOpiT2PbxSbyZaIf32OqjtkGfQSm3v+2hQuT+FNr4aUl268mv3yvh+hDiFXpLFSVje5vHvi/Uupv2+BXUZUps6Ex2j4R3EawUSeU+KrLwcdfZln1F8Mppz3XZZ3YDCdwl7lX28G8+8/zWsGg9suY4BrSp6rhkSAD7BqIqgfxjC461kI1nyaWkXFqZ//2aE2xaMwyQuP2ovY+vronaGuOUP1NEoF9KkzuMnvDtIwhduStR4+T4IY1kYDFyOhosNH9qHglHg91C5J0EtuL85vixVCjGVX6jzY2Un4EG+7Mmjt5Ylm5wpSiRChBbgv/7rP28/fiuPHMIMz4w6jo9M61H/tLpVUQoKxFiF3UomVN2wSJ/5zelV2r+ZQjiVrrF4NJZINd/1T/07xZjGk6P4N9nE2nuYyJGilF81epuQrL/3+gBdfJxQ31hcqzUcYs+MiGbNw3QMkzE6CwCaAp6O9YjXii+PW0/n/Rh12gfeKT/s9GETazjBD9rPRYf+jTNWmpUe17R3MN8N5Wtu3CwVgoFyAchBVTIIhrOXoBf7XvVgxpXFigIrvZ7IYHwyso/88rkKYlaxxtq3vkDIFNxD9c1s3AF/Y3OAdJQrl8BWL8dO5NwhUod7nw4A2Wem0nv42eOixJKmvMhnc0+lmZEp75zPHmYYiLMmhXKmUBModbo0k7VK7dy5rziHzLweX2yKGswsPhxyBiN7swgp0u5xJObvNROzJLMMHUHAs5X5gZe4nYziT6cbEf9W62O/woyI3GOVmI055se6MKgL7ChRiT9NjwJVd0S5lXny+uMK+1gp0dAejtjCpsn1BjM/ZKTKkTWfhEB9wzf1opOD1hWLNjekOomFX3J24QUOf699IY64lxYkkTlS2LY1BW3v8lutcbysgtkg3oeIX4Eb85700WxLeqGzLwajeIleS3HnviFuIPGbS/4u9Vq6iQrgu78RaqRmWbs4EYSwEN8tydDo9YpFGDzQoQ821n07t5twmK5wEhOiEopbBkHBZCMakdfTKilJUDxr3ps0bSLneLepHZ+pDY34O2liojxm9Qll9NBKXCnEpC9pXxwfN3rx6qeAuyPPOsKLkX777B8I7lB+JwGLsq/JfM9WW4pOAcTsQ9qssPBLVmc2UxjeTB+QGTGUj8TmeeLtEuEwapbpqvLnS1g+3WMDxZkdR/aiEQX1HswoNLDCCxPyEQNIu3SNo8Pd1b7ptASrZCkQImsKz4u85OfVy23IypHQVtG0us6020kgYw7d8ubFgCYA1POSPX96S+kwBZYKjrSqqHz+9Y0zvZ/odz9qj3YzwY1jT9BH5QvsHtcq8rrxvaCOwhkGYtNVtf60k6fIfrZOeNBtj1DLj0E9ui8Kx7FmfStw1sLz5MLkUDYK5W5n7SOlIC4LxPLNDu+OmOMikd7KT6e2215LuJWIr/dMWVQjDKZVOMt3l3xsEDS9whfv5jefyfbqNc5/AbW+5+B61sAtLIeBYQbHdRN+OXwgBhuGpAVi8lPMg5bbdHpnkqdprbTHExUBrLDENeGf6Aursf3QeSyXflU/gx2VnxYjthRiEBWSz3MXZYy+mLjw7k2W2PjbzwdqdZyWe3IZ/ShJqV1iQLnxqNjSaOp/8DwlhzFpZzY1Uwhu/C/Wqa3GNcLjmnbzcPmhHt+LhiTU1mLyQZRCQK+hZZDMZnNKKZNJrASCbd4+TjZjjmeaS2QmuDP/J8RG5wPx6yQWEay6Ey614S48YZC1Al5p0H5Zgk9+VKjuUM6Kkjbph67fynZ3eoKDcwOxb3KIpUJFyDlYmUc1jEEeN5KtKxp1Er4hW4XD5ymi5iKrCIfPfvpkZo68mn9G6ul0dj8pkdTJeVQaoOm0s9VtmwIEmvgWI4wbvzWDfL/eJvIM7n7vKkUUP0h+O4OpHVHgEM6PRtyoP0s48xR1h4xaNkY3U1vevYcx9Qm1i5TtEWuVCQO9+m6Uq6BMRvOtzIRW+3mtwJWYTlnCdFxxkEtbUhubuZALUEexQK2l2znudXFoQUXJz35U0Gyag+g+Uj7B9brk3Drypssj2AYVhSyW3Q6WkQ7DeCZ+v6WtGI0A5SDPY+wc66VFiqD6mCVa5ILPAhYZ/jjzAdFp0JPWxbH3qkv5t0+hD8YWMqCmwwegBILgtR1EKAO1xcnAPIzKgkUqqpnq8erLQdBs0TzgT0od34HDGamS/VRu6orWNGKGE/ZCmvOn2SHsT/zn8dxFHiSGoT9WiJIBuXKGgTHYCXOXTQ/8qTsOs77U6KridgaICrOq+bXAxS8oqyHPU0H08UDmnvgo5nFiN4Y6Djc4ik/2zDzfn1iLS83MRjfHI9mJVPLBmqB9n86xRapYx9W8/2enyIA9j7m/TFLh7uucrthovA16PyNWvtyHFWrkCvzJlP8kFg7kX2xUaqgY9UxOzumInp6jvxcI3lhtmd7GIcEYF/uyIuQrL8V/dG9xOU+SHJYGw2I0BGYa9KtfTjyS4twU+hVA1FFPuCitd8wYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8970,"cache_read_input_tokens":47601,"cache_creation":{"ephemeral_5m_input_tokens":8970,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG7dpvfwHK3W5MRtZdz","type":"assistant","uuid":"65f3c187-75c4-421e-990b-bec9a97079ee","timestamp":"2026-01-25T01:53:40.333Z"}
{"parentUuid":"65f3c187-75c4-421e-990b-bec9a97079ee","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Ezb3ZyX7tyJBSPz8anjWd7","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora tengo claro el problema. Déjame verificar qué endpoint usa `/planes-clientes` para obtener los planes y cómo difiere."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8970,"cache_read_input_tokens":47601,"cache_creation":{"ephemeral_5m_input_tokens":8970,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG7dpvfwHK3W5MRtZdz","type":"assistant","uuid":"3d48188e-fd6f-4e53-815e-11fd42a4b32b","timestamp":"2026-01-25T01:53:40.344Z"}
{"parentUuid":"3d48188e-fd6f-4e53-815e-11fd42a4b32b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Ezb3ZyX7tyJBSPz8anjWd7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019kXUVa7hMc9s6nUCWnAcqM","name":"Grep","input":{"pattern":"empresas-planes-listado-tabla","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8970,"cache_read_input_tokens":47601,"cache_creation":{"ephemeral_5m_input_tokens":8970,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG7dpvfwHK3W5MRtZdz","type":"assistant","uuid":"49b40880-e1f5-4079-a64c-a0ae58c6e295","timestamp":"2026-01-25T01:53:40.768Z"}
{"parentUuid":"49b40880-e1f5-4079-a64c-a0ae58c6e295","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Ezb3ZyX7tyJBSPz8anjWd7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011k5SfJmcU3YPqubBX9aZmv","name":"Grep","input":{"pattern":"listadoTabla|planesListadoTabla","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8970,"cache_read_input_tokens":47601,"cache_creation":{"ephemeral_5m_input_tokens":8970,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG7dpvfwHK3W5MRtZdz","type":"assistant","uuid":"e8dc5271-79f1-40b9-85f6-7c6048147eb0","timestamp":"2026-01-25T01:53:41.792Z"}
{"parentUuid":"49b40880-e1f5-4079-a64c-a0ae58c6e295","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019kXUVa7hMc9s6nUCWnAcqM","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:270:        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');"}]},"uuid":"c2a2878a-195b-4bba-a272-408ab6a836e1","timestamp":"2026-01-25T01:53:44.221Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:270:        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');","numLines":1},"sourceToolAssistantUUID":"49b40880-e1f5-4079-a64c-a0ae58c6e295"}
{"parentUuid":"e8dc5271-79f1-40b9-85f6-7c6048147eb0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011k5SfJmcU3YPqubBX9aZmv","type":"tool_result","content":"No files found"}]},"uuid":"2162ea8a-e7a7-4fd5-b72d-ab98134c5af2","timestamp":"2026-01-25T01:53:44.256Z","toolUseResult":{"mode":"files_with_matches","filenames":[],"numFiles":0},"sourceToolAssistantUUID":"e8dc5271-79f1-40b9-85f6-7c6048147eb0"}
{"parentUuid":"2162ea8a-e7a7-4fd5-b72d-ab98134c5af2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QTRYxQRaB3DNcTECrutXxE","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Encontré que el endpoint `empresas-planes-listado-tabla/{empresa_id}` usa `EmpresaPlanController@datosTabla`. Déjame ver ese método.","signature":"ErACCkYICxgCKkCBVe5grKlbIsQZZC7Q7d6YvyLCqE2O54zZfLavGol2/R/toGbLj4Za3r0BzmoQNO7KJagm6ver3Enh3jSjNC/bEgykrwKIIHfuTvRykHoaDGTKKV3LbkhM3pPZ7iIwAK3RBeSK1iQUMihjx0FM9AHrzMt0vYCLdpC3v8yPF8BYu+2GvHzPACqWcuBgaaEMKpcB0OI23gWXJbl8qnez1kusgGUm3WWYz6kNlvoNPhXkP7rT/0W5eWUh/XhI2XWnYLiBynd4WZYlJ/XG43DLN8Z7QIKa9GKoEcAfFCJVZrhcuGSAmieUoMS5p3hY/4lBKyuc0aWi/vcJoQfcH1p46+fsVge0uYEWoA07G36Hy6mlg1uwIXNTTAxKCsMVgByn8ZWkigeHUwI6NxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1033,"cache_read_input_tokens":56571,"cache_creation":{"ephemeral_5m_input_tokens":1033,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG99Ap1bKJsH7Fagxa2","type":"assistant","uuid":"7cfce403-a55b-4bb4-8c38-dbf47092c2f7","timestamp":"2026-01-25T01:53:46.962Z"}
{"parentUuid":"7cfce403-a55b-4bb4-8c38-dbf47092c2f7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QTRYxQRaB3DNcTECrutXxE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PfsBC17LvL1amiDsVkm2gx","name":"Grep","input":{"pattern":"datosTabla","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","output_mode":"content","-B":5,"-A":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1033,"cache_read_input_tokens":56571,"cache_creation":{"ephemeral_5m_input_tokens":1033,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTG99Ap1bKJsH7Fagxa2","type":"assistant","uuid":"02ee2951-6475-4837-a3dd-c83f51ecb7ac","timestamp":"2026-01-25T01:53:48.108Z"}
{"parentUuid":"02ee2951-6475-4837-a3dd-c83f51ecb7ac","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PfsBC17LvL1amiDsVkm2gx","type":"tool_result","content":"113-     * @param Request $request Contenido de la petición.\n114-     * @return JsonResponse\n115-     * @author Daniel Beltrán\n116-     * @author Andres Gonzalez\n117-     */\n118:    public function datosTabla(int $empresa_id, Request $request): JsonResponse {\n119-        $request->merge([\n120-            'empresa_id'                            => $empresa_id,\n121-            'con_conteo_consumos_agendas'           => true,\n122-            'con_conteo_consumos_ofertas_laborales' => true,\n123-            'con_conteo_consumos_creditos'          => true\n124-        ]);\n125-\n126-        return new JsonResponse([\n127-            'data' => [\n128-                'empresas_planes'             => $this->repositorio->getTodo($request),\n129-                'sucursales_consumos_agendas' => $this->empresa_repositorio\n130-                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n131-                        'empresa_id'       => $empresa_id,\n132-                        'consumos_agendas' => true\n133-                    ])),\n134-                'sucursales_consumos_ofertas_laborales' => $this->empresa_repositorio\n135-                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n136-                        'empresa_id'                 => $empresa_id,\n137-                        'consumos_ofertas_laborales' => true\n138-                    ]))\n139-            ]\n140-        ], 200);\n141-    }\n142-\n143-    /**\n144-     * Obtener un plan de empresa.\n145-     *\n146-     * @param int $id ID del plan de empresa.\n147-     * @return JsonResponse\n148-     * @author Daniel Beltrán"}]},"uuid":"537cf32b-d4ec-4eaf-83b3-70c3829b3dce","timestamp":"2026-01-25T01:53:49.575Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"113-     * @param Request $request Contenido de la petición.\n114-     * @return JsonResponse\n115-     * @author Daniel Beltrán\n116-     * @author Andres Gonzalez\n117-     */\n118:    public function datosTabla(int $empresa_id, Request $request): JsonResponse {\n119-        $request->merge([\n120-            'empresa_id'                            => $empresa_id,\n121-            'con_conteo_consumos_agendas'           => true,\n122-            'con_conteo_consumos_ofertas_laborales' => true,\n123-            'con_conteo_consumos_creditos'          => true\n124-        ]);\n125-\n126-        return new JsonResponse([\n127-            'data' => [\n128-                'empresas_planes'             => $this->repositorio->getTodo($request),\n129-                'sucursales_consumos_agendas' => $this->empresa_repositorio\n130-                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n131-                        'empresa_id'       => $empresa_id,\n132-                        'consumos_agendas' => true\n133-                    ])),\n134-                'sucursales_consumos_ofertas_laborales' => $this->empresa_repositorio\n135-                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n136-                        'empresa_id'                 => $empresa_id,\n137-                        'consumos_ofertas_laborales' => true\n138-                    ]))\n139-            ]\n140-        ], 200);\n141-    }\n142-\n143-    /**\n144-     * Obtener un plan de empresa.\n145-     *\n146-     * @param int $id ID del plan de empresa.\n147-     * @return JsonResponse\n148-     * @author Daniel Beltrán","numLines":36},"sourceToolAssistantUUID":"02ee2951-6475-4837-a3dd-c83f51ecb7ac"}
{"parentUuid":"537cf32b-d4ec-4eaf-83b3-70c3829b3dce","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TRE9EstFMBkaEMJZFCgzxo","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora veo que en `/planes-clientes`, los planes se cargan con `$this->repositorio->getTodo($request)` del `EmpresaPlanRepository`. Este método probablemente no filtra por tipo_prueba_id, por lo que obtiene TODOS los planes incluyendo los de créditos.Mientras que en `EmpresaService::getUno()` (usado por `/empresas-gestionar/{id}`), los planes se cargan iterando por cada tipo_prueba y usando métodos que tienen `whereHas('plan', ...)` lo cual excluye planes donde `plan_id` es null.\n\nVoy a verificar el método `getTodo` del `EmpresaPlanRepository` para confirmar.","signature":"EuEFCkYICxgCKkAPJHdLli65GTUEtkuy4PK8hahGu/H/Igm+bZ148MwS5YnOwQVNEhqV6F0e9j/d2LWyp/tMVS4bzZO+WA2R2KmDEgww3XKAE2vdQxeBJX0aDFkg5lIBXiTHlocgCyIwcJm0tyv2XOYJ1zdsmFZqgbNKlUuhz68NOTmSvwjDv3WR4O3XkRoc/Y6QBQiVcqcuKsgE/B7hk2vKTmPr4AenDla3c1EcaYUEcDsEVDCO4qDQk4r7aI4Gk59IXwQyhmcJ35bjqvmDf8m7SxjjNI0RWlndrJfZNbucOkZ/6kBnV327HZURUfG0fkvKTLtWSet8AMu6H1qjBoxcFr1fyxxGLHs2lfWb4wvQ3B9FNrxa8eukIjiZalH1C2LuoAZRNTQD6zlYr0s1Sde+feXSwR144G57sMUqgBPKf3NfB85i/JmU+PIARHohIpPjNS1WYbYNmjiuR8pmvcFYM2ixS+y21byDwu3OfDDu+4dXxgVg3a01QmPtQV6dIovxb7sAUf34jc4uzVUsXwcXz32QPlNj0rgkZRSEC4IUcGoJsJlY5Ot/cBvBYJVaWXkdDhqCDZbC7MaMnXZcra5SEgaFrUqRGAvz4LMhBB9U0RdZZf8hQGjSWKuBc4x9kD6fFlO5JxTyZr+1/hwwCeRxj1OBTSjHZEb25Dcnr493RXqsUjXO6YEAtQ7e5MYV6vvNqgzNYxPj2OChE4Woe/CkfW5BlB2L4W4buo5iYzFuRkn07k6Hb1tbLx6J9lXgvcGiZ1YLP6exD5arBMaVOfhHe7btLua/8gj5cWnTwdH0d6SolC1GM2g3HmOxzW1Vn1T9q47qmuUEV4lj9P1xMsWM34ZhogzKAiXv3GvvjIyifHhqEpVfxz2PqQ1igHI4SnxfhStUQeDKrowL+x9q6g8aPcUR9rSQVYKMb15IXSG9rekV1bOLr5arI8bqbOYlYkW8tIOmxvH/kuGn1yjCgyKmvEYYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":722,"cache_read_input_tokens":57604,"cache_creation":{"ephemeral_5m_input_tokens":722,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTG9Xrozt4Zt7ZnxCc1G","type":"assistant","uuid":"ec6cccf0-4d55-4ba5-9f62-15e0ef3102eb","timestamp":"2026-01-25T01:53:54.817Z"}
{"parentUuid":"ec6cccf0-4d55-4ba5-9f62-15e0ef3102eb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TRE9EstFMBkaEMJZFCgzxo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016SJzQ2dwsyPRnun7XUcwFB","name":"Grep","input":{"pattern":"function getTodo","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","output_mode":"content","-A":60}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":722,"cache_read_input_tokens":57604,"cache_creation":{"ephemeral_5m_input_tokens":722,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTG9Xrozt4Zt7ZnxCc1G","type":"assistant","uuid":"887d5e2c-5aab-4e71-8c27-ab61d10c7942","timestamp":"2026-01-25T01:53:55.765Z"}
{"parentUuid":"887d5e2c-5aab-4e71-8c27-ab61d10c7942","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016SJzQ2dwsyPRnun7XUcwFB","type":"tool_result","content":"93:    public function getTodo(Request $request): Collection {\n94-        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n95-            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n96-        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n97-            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n98-        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n99-            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n100-        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n101-            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n102-        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n103-            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n104-\n105-        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n106-        ->with([\n107-            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n108-            'empresa:id,empresa_id,nombre_comercial,razon_social',\n109-            'plan.tipoPrueba:id,nombre',\n110-            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n111-            'estado:id,nombre',\n112-            'pruebas:id,nombre',\n113-            'funcionalidades:id,nombre,predeterminado',\n114-            'archivos' => function ($archivos) {\n115-                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n116-            }\n117-        ])\n118-        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n119-            $query->with([\n120-                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n121-                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n122-                        ->with(['empresa' => function ($empresa) {\n123-                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n124-                        }])\n125-                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n126-                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n127-                },\n128-                'consumos.agenda:id,prueba_id',\n129-                'consumos.agenda.prueba:id,nombre,slug'\n130-            ]);\n131-        })\n132-        ->when($con_conteo_consumos_agendas, function ($consulta) {\n133-            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n134-        })\n135-        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n136-            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n137-        })\n138-        ->when($con_conteo_consumos_creditos, function ($consulta) {\n139-            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n140-        })\n141-        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n142-            $query->where('empresa_id', $request->empresa_id);\n143-        })\n144-        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n145-            $query->whereHas('plan', function ($plan) use ($request) {\n146-                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n147-            });\n148-        })\n149-        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n150-            $query->whereHas('plan', function ($plan) use ($request) {\n151-                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n152-            });\n153-        })"}]},"uuid":"b4585906-6b2b-4772-98c7-b835d6b87cae","timestamp":"2026-01-25T01:53:57.276Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"93:    public function getTodo(Request $request): Collection {\n94-        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n95-            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n96-        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n97-            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n98-        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n99-            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n100-        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n101-            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n102-        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n103-            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n104-\n105-        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n106-        ->with([\n107-            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n108-            'empresa:id,empresa_id,nombre_comercial,razon_social',\n109-            'plan.tipoPrueba:id,nombre',\n110-            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n111-            'estado:id,nombre',\n112-            'pruebas:id,nombre',\n113-            'funcionalidades:id,nombre,predeterminado',\n114-            'archivos' => function ($archivos) {\n115-                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n116-            }\n117-        ])\n118-        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n119-            $query->with([\n120-                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n121-                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n122-                        ->with(['empresa' => function ($empresa) {\n123-                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n124-                        }])\n125-                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n126-                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n127-                },\n128-                'consumos.agenda:id,prueba_id',\n129-                'consumos.agenda.prueba:id,nombre,slug'\n130-            ]);\n131-        })\n132-        ->when($con_conteo_consumos_agendas, function ($consulta) {\n133-            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n134-        })\n135-        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n136-            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n137-        })\n138-        ->when($con_conteo_consumos_creditos, function ($consulta) {\n139-            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n140-        })\n141-        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n142-            $query->where('empresa_id', $request->empresa_id);\n143-        })\n144-        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n145-            $query->whereHas('plan', function ($plan) use ($request) {\n146-                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n147-            });\n148-        })\n149-        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n150-            $query->whereHas('plan', function ($plan) use ($request) {\n151-                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n152-            });\n153-        })","numLines":61},"sourceToolAssistantUUID":"887d5e2c-5aab-4e71-8c27-ab61d10c7942"}
{"parentUuid":"b4585906-6b2b-4772-98c7-b835d6b87cae","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CgDBqK8PzN7Kb3wCfSjtx5","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora tengo la imagen completa. El método `getTodo` del `EmpresaPlanRepository` SÍ incluye los planes de créditos porque:\n\n1. No tiene un filtro obligatorio de `whereHas('plan', ...)` - el filtro de `tipo_prueba_id` es opcional (con `when`)\n2. Incluye la relación `planCredito` en el `with()`\n3. Simplemente filtra por `empresa_id` cuando se proporciona\n\nMientras que en `EmpresaService::getUno()`:\n- Itera por cada tipo_prueba\n- Usa `obtenerPlanActivo()` y `obtenerUltimoPorTipo()` que SIEMPRE usan `whereHas('plan', ...)` con un `tipo_prueba_id` específico\n- Esto excluye planes donde `plan_id` es NULL (planes de solo créditos)\n\n## RESUMEN DEL PROBLEMA:\n\n**En `/planes-clientes`:**\n- Usa `EmpresaPlanController@datosTabla` → `EmpresaPlanRepository::getTodo()`\n- `getTodo()` obtiene TODOS los planes de la empresa sin filtrar por `tipo_prueba_id`\n- El frontend `planes.js` maneja tanto planes normales como de créditos con el ternario en línea 80\n\n**En `/empresas-gestionar/{id}`:**\n- Usa `EmpresaController@datosGestionar` → `EmpresaService::getUno()`\n- `getUno()` obtiene planes iterando por cada `tipo_prueba` usando métodos que tienen `whereHas('plan', ...)`\n- Esto EXCLUYE planes de solo créditos (donde `plan_id` es NULL)\n- El frontend `empresas.js` también filtra con `if (!planes[i].plan || !planes[i].plan.tipo_prueba_id)`\n \nNecesito modificar `EmpresaService::getUno()` para que después de iterar por tipos de prueba, agregue también los planes de créditos que no tienen `plan_id`. En el frontend, `empresas.js::mostrarPlanes()` debe renderizar estos planes de créditos con la misma estructura que usa `planes.js`, mostrando el nombre del plan de crédito y sus detalles correspondientes.","signature":"EuoQCkYICxgCKkDxkJt34qzOzSYuyhRM+pXoNbMSOg7zjd1hhLA/eo/iZAu2BoLJoqBkDa4ULHz4y7Vz+KtlJV8YYqKNinA+PPswEgw1FjXTpVA9BnQLS+YaDKrpUnxngDKgb9E7tSIw+U4dnwVyyJl5dP0jTZM63XkxvAbjJyW/DcwQpBUxIxoLrt+ut0Z2HgapeGPVsTEuKtEPNrJJ+inoEzErypVhebRRCBNxZZzCGksu9aCCaWrPa3bMRp26F/W4z9DG0VSkQK+vONLkYat/7E+NPFkX0y2/8c5ey9I8+zJR/x/TCr2LbicA0uwmrA2+C+Nr0vBzaZx3wGNq7+FzX7m52qGAtH6qxOjIntE4GCOlJJJXEKdMViZPKIVYnppJu8bkZnNTvHQNJK2da75zCmmxc3lpo8qS/8gealsbTfIxloBEuwJwF77CMKL1Vb44tNuuG06wAkHJ7JpzKGpkv8VOuXerCbyF016d0nnBEipgZULD6gbPVZWxomagQ9hmf888xasxjbnnLA+bZvRlBXy72IQ0D795UR2NID5TvQ73JVmsThC+R6pU4ndZNAsMkuNxtwbfKFdmZ8ZbZQjprCENvtNK4sp9hB9S5S3VvDGQhb50Ck7cczz2oALjRkd4PhzXGetWBpdqctswW0Ts2CzPDL/J0FtZ8IyUsiG+UMPPqlQ9nzcUgxd/+zVHbhKZTOK8DMVXh96vGBJClfnFMRnUrWIeat0YrBt2uFBM9Y4Z76YCFQ8dHGwBxei92JPIOM/V/lodqtt6RaVNrm3x4TrI/scWWivK5tEuQNEUX1TbZcQy1qMDaWdppjti6ihvwTUf5V5BFIJmkdRgqqNb16HFizdmHge/P6lvCvciLOrWq9mCnInFC9CD7jmkMKSd5d3zSTOSWs/8sW+jxNFpm+KB8J2qrapLsE/ZdfkPBZUY4/Dx4cLpOorhtluZpb90h5c5rUGTTJAHCYrGFH7dIijFu6b8HUpXy0ToysHhYFhlFomD0V3b8SQR9Za7tzeqRBUBhuzv8f8D9XhjY4fhjMwI5aQk6EG5iwohZcB+DLUSp6eCC/Di+ddsunTJ7dZz/KhM8oUbY+de5n+KS7E8n+N2EsusbuDvMfrTowCpkhM8gpCIcoWc1ZG5ANzWFCWk0Lsy5h7GNalQde51BumdUif7yMawd3ITqkg1e6lqSHnSwiewc3HZGVvt86valqi/wnkKswPr2WgE6F9H3IzPYDKIL9Kf6o3l9HLnBBdbUg3geGnGuvcMRA6O/ac9l/JFkayo3iVk7BHMWLdCIYcgn+r+RRHXMcYAG6qMd0sNpYZaO1YYuutB1XpRO21SrPpkQcGTVpITRv3Ayj69mVgrkxFIniVJFt/r3Qi3Eg+iMD8ZzxDSnxLs1wNjx36zeNP5U5KrL/AV0CCsFz7QiaxSjyYQP1/vFeoGZdaYcFH/Fzw+pkAKI70pauZkFtZTQzxGEPhcGBLt1sWovgNo51u1agf8FtypVBQRHIqh4n7ipAp0q/UhF6SCT0oLxJsB8xFrDW5J5VuZ5rKQs8uLC+RRAv1Ct9UyN3blRfL2z1fwCn+MAoIvivebldLpqPaNsNV7yLK9lCJHjHqmoe/RXlpePuGKq5IbuiABrBRJm/cWU7bpqjAkYPEKCpflj1c/hbzF2UO277VaqoedqB0lp1rsfYbkNa+DItcplTDS/mk1mYpTiUoil3LGI5+l7uBVKsZ5nef1WidZZ42zS70w4hcpekIiCrG8I5z3k2teRBLB+QSUB2WwKk3keS0AKemFENCg8CmwftRcoVd1ILORysqQiPc2Yd19U7jOVN19+OAWEyj6QTSl1MX2+iV8GOpTeI6ubQgcr2WrLhyP4zOvJRvs1WktqngqZimPR8zHmzW0HXZa+dWNK4X2xRMYa5CTTYOq7dm2N/xpBkay4A8WAr9UXcv1Bsx0v28GqXjUTld3csO3kiBx4wZyUcM5uzBdSBOTK6l4XXp/m53K2Y7hSQdMfS16w9hoi0moOQbZGVWFl2tg+Dj6T5hGWpHHPcW/94MOJ/N7vBZWVpXFhHCAWOOfyqt1WhJGniSnEAk2j6fnmWixdwHnzX3NsgqitFOVMaab42Bgs3b1pcz8XthY/f58Cgl7/pQuQIaG9Woegq9KgVj4eTld6Y19rzBzhTSRUSCthFjwLcY/1eH5v5cVtu12y2MS1xJk/GwmEwMpom+zJh2unnjQeJivDlbBPYc0dEJsjY27hDWeCLEfwz/f5MvIE01oUIlNL8FaInuNNa6SZDBpJQP2qndwJvWwihNDPn1XFdWGF2HYR81llaMSQuuv6xlGyGiysldEvJBzg1Wta3e/L9v24V+H1i90F2Hx27aOJ2sS73AK40sH/6sLspZDJhG/qsVoyaFduKwHsTa0ecISy18NoQNu04BwoQ8GO3YVu5PHiQ/jWrxnbw8k8Gv3hVZValZBo5xzQbmsIp66kK3K795jOmnMmlak7bOaPfpEyB6COSPqSmBgdURZ6iFkoenRtHOmry0K1XJ78aN3JiiRmQ4rNIKxsZQxDZHM8GxrfH+wmF6bxjAB7fk6ZnOIBRMq707Dt/C8hI2rG3wAMIMQ29xLEjG/EjpmLF1VWIDSLLAN14Jxv2myLePIuG9ft3LZXp3ZaF9//uAK26QplRw+gX2dvr/hvwQCLwDAlSYPav+WiuWutOIWZaHwVLjz9xT5lDom12yYF7bjLdupHYGyjv7afhnuPNGmuzaqozexJADBlY+YqjWd9ot+4NUTMnU3zOSYxKhYM3bFEPxQbiBwPci+LgOoYMyGDTCdDE14/b+WpcAo3jQQjfMk8sJHwYbo8EH+0f8pjLYqvSSJsU2+WAcbVg+RpRehGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1943,"cache_read_input_tokens":58326,"cache_creation":{"ephemeral_5m_input_tokens":1943,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGA6nU1kFnvY7A2Esg7","type":"assistant","uuid":"1450544f-4359-48fa-8a37-39ee9d4c2394","timestamp":"2026-01-25T01:54:09.973Z"}
{"parentUuid":"1450544f-4359-48fa-8a37-39ee9d4c2394","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CgDBqK8PzN7Kb3wCfSjtx5","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora tengo toda la información necesaria. La causa raíz está clara. Voy a escribir el plan de implementación."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1943,"cache_read_input_tokens":58326,"cache_creation":{"ephemeral_5m_input_tokens":1943,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGA6nU1kFnvY7A2Esg7","type":"assistant","uuid":"4d3a8295-a83d-473b-8fa9-a520ad97fac5","timestamp":"2026-01-25T01:54:09.983Z"}
{"parentUuid":"4d3a8295-a83d-473b-8fa9-a520ad97fac5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CgDBqK8PzN7Kb3wCfSjtx5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Vizbt2WwPEpMyaG5mbrL3q","name":"Write","input":{"file_path":"C:\\Users\\sergio\\.claude\\plans\\sorted-spinning-crane.md","content":"# Plan: Mostrar Planes de Créditos en Superadmin (empresas-gestionar)\n\n## Problema Identificado\n\nLos planes de créditos (donde `plan_id = NULL` pero `plan_credito_id != NULL`) no se muestran en la vista de superadmin `/empresas-gestionar/{id}`, pero sí en la vista de empresa `/planes-clientes`.\n\n### Causa Raíz\n\n**Nivel 1 - Backend (`EmpresaService::getUno`):**\n```php\n// Líneas 110-117 - Solo obtiene planes por tipo_prueba\nforeach ($tipos_pruebas as $tipo_prueba) {\n    $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n        ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n}\n```\nLos métodos `obtenerPlanActivo()` y `obtenerUltimoPorTipo()` usan `whereHas('plan', ...)` que excluye planes donde `plan_id` es NULL.\n\n**Nivel 2 - Frontend (`empresas.js::mostrarPlanes`):**\n```javascript\n// Líneas 1503-1505 - Filtra planes sin relación 'plan'\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n```\n\n## Solución Propuesta\n\n### Paso 1: Backend - Agregar método para obtener planes de créditos\n\n**Archivo:** `app/Http/Repositories/Empresas/EmpresaPlanRepository.php`\n\nAgregar nuevo método `planesCreditosActivos()`:\n```php\npublic function planesCreditosActivos(int $empresa_id): Collection {\n    return $this->modelo::select(...)\n        ->with(['planCredito:id,nombre,creditos,...', 'estado:id,nombre', ...])\n        ->where('empresa_id', $empresa_id)\n        ->whereNull('plan_id')\n        ->whereNotNull('plan_credito_id')\n        ->whereIn('estado_id', [1, 4]) // ACTIVO, POR_VENCER\n        ->orderBy('created_at', 'DESC')\n        ->get();\n}\n```\n\n### Paso 2: Backend - Modificar EmpresaPlanService\n\n**Archivo:** `app/Http/Services/Empresas/EmpresaPlanService.php`\n\nAgregar método `obtenerPlanesCreditosActivos()`:\n```php\npublic function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n    return $this->repositorio->planesCreditosActivos($empresa_id);\n}\n```\n\n### Paso 3: Backend - Modificar EmpresaService::getUno\n\n**Archivo:** `app/Http/Services/Empresas/EmpresaService.php` (líneas 107-117)\n\nDespués del foreach de tipos_pruebas, agregar:\n```php\n// Obtener planes de solo créditos\n$planes_creditos = $this->empresa_plan_servicio->obtenerPlanesCreditosActivos($id);\nforeach ($planes_creditos as $plan_credito) {\n    array_push($planes, $plan_credito);\n}\n```\n\n### Paso 4: Frontend - Modificar mostrarPlanes()\n\n**Archivo:** `public/js/empresas/empresas.js` (líneas 1491-1630)\n\n1. Modificar el filtro para aceptar planes de créditos:\n```javascript\n// Cambiar de:\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n\n// A:\nlet es_plan_creditos = !planes[i].plan && planes[i].plan_credito;\nif (!planes[i].plan && !es_plan_creditos) {\n    continue;\n}\n```\n\n2. Agregar lógica para renderizar planes de créditos (similar a `planes.js` líneas 180-244):\n```javascript\nif (es_plan_creditos) {\n    // Renderizar card de plan de créditos con:\n    // - Icono de IA\n    // - Nombre del plan de créditos\n    // - Barra de progreso de créditos\n    // - Estado del plan\n    continue;\n}\n```\n\n## Archivos a Modificar\n\n| Archivo | Cambio |\n|---------|--------|\n| `app/Http/Repositories/Empresas/EmpresaPlanRepository.php` | Agregar método `planesCreditosActivos()` |\n| `app/Http/Services/Empresas/EmpresaPlanService.php` | Agregar método `obtenerPlanesCreditosActivos()` |\n| `app/Http/Services/Empresas/EmpresaService.php` | Modificar `getUno()` para incluir planes de créditos |\n| `public/js/empresas/empresas.js` | Modificar `mostrarPlanes()` para renderizar planes de créditos |\n\n## Verificación\n\n1. Acceder a `/empresas-gestionar/{id}` con una empresa que tenga planes de créditos\n2. Verificar que se muestren tanto los planes normales como los de créditos en la pestaña \"Planes\"\n3. Verificar que los datos de créditos (total, consumidos, restantes) se muestren correctamente\n4. Comparar con `/planes-clientes` para asegurar consistencia visual\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1943,"cache_read_input_tokens":58326,"cache_creation":{"ephemeral_5m_input_tokens":1943,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGA6nU1kFnvY7A2Esg7","type":"assistant","uuid":"4a976d5c-cc0f-439d-8867-c18d422c2017","timestamp":"2026-01-25T01:54:26.512Z"}
{"parentUuid":"4a976d5c-cc0f-439d-8867-c18d422c2017","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Vizbt2WwPEpMyaG5mbrL3q","type":"tool_result","content":"File created successfully at: C:\\Users\\sergio\\.claude\\plans\\sorted-spinning-crane.md"}]},"uuid":"42ea2d16-bb59-441f-b15d-7e91b6bd2e58","timestamp":"2026-01-25T01:54:27.594Z","toolUseResult":{"type":"create","filePath":"C:\\Users\\sergio\\.claude\\plans\\sorted-spinning-crane.md","content":"# Plan: Mostrar Planes de Créditos en Superadmin (empresas-gestionar)\n\n## Problema Identificado\n\nLos planes de créditos (donde `plan_id = NULL` pero `plan_credito_id != NULL`) no se muestran en la vista de superadmin `/empresas-gestionar/{id}`, pero sí en la vista de empresa `/planes-clientes`.\n\n### Causa Raíz\n\n**Nivel 1 - Backend (`EmpresaService::getUno`):**\n```php\n// Líneas 110-117 - Solo obtiene planes por tipo_prueba\nforeach ($tipos_pruebas as $tipo_prueba) {\n    $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n        ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n}\n```\nLos métodos `obtenerPlanActivo()` y `obtenerUltimoPorTipo()` usan `whereHas('plan', ...)` que excluye planes donde `plan_id` es NULL.\n\n**Nivel 2 - Frontend (`empresas.js::mostrarPlanes`):**\n```javascript\n// Líneas 1503-1505 - Filtra planes sin relación 'plan'\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n```\n\n## Solución Propuesta\n\n### Paso 1: Backend - Agregar método para obtener planes de créditos\n\n**Archivo:** `app/Http/Repositories/Empresas/EmpresaPlanRepository.php`\n\nAgregar nuevo método `planesCreditosActivos()`:\n```php\npublic function planesCreditosActivos(int $empresa_id): Collection {\n    return $this->modelo::select(...)\n        ->with(['planCredito:id,nombre,creditos,...', 'estado:id,nombre', ...])\n        ->where('empresa_id', $empresa_id)\n        ->whereNull('plan_id')\n        ->whereNotNull('plan_credito_id')\n        ->whereIn('estado_id', [1, 4]) // ACTIVO, POR_VENCER\n        ->orderBy('created_at', 'DESC')\n        ->get();\n}\n```\n\n### Paso 2: Backend - Modificar EmpresaPlanService\n\n**Archivo:** `app/Http/Services/Empresas/EmpresaPlanService.php`\n\nAgregar método `obtenerPlanesCreditosActivos()`:\n```php\npublic function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n    return $this->repositorio->planesCreditosActivos($empresa_id);\n}\n```\n\n### Paso 3: Backend - Modificar EmpresaService::getUno\n\n**Archivo:** `app/Http/Services/Empresas/EmpresaService.php` (líneas 107-117)\n\nDespués del foreach de tipos_pruebas, agregar:\n```php\n// Obtener planes de solo créditos\n$planes_creditos = $this->empresa_plan_servicio->obtenerPlanesCreditosActivos($id);\nforeach ($planes_creditos as $plan_credito) {\n    array_push($planes, $plan_credito);\n}\n```\n\n### Paso 4: Frontend - Modificar mostrarPlanes()\n\n**Archivo:** `public/js/empresas/empresas.js` (líneas 1491-1630)\n\n1. Modificar el filtro para aceptar planes de créditos:\n```javascript\n// Cambiar de:\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n\n// A:\nlet es_plan_creditos = !planes[i].plan && planes[i].plan_credito;\nif (!planes[i].plan && !es_plan_creditos) {\n    continue;\n}\n```\n\n2. Agregar lógica para renderizar planes de créditos (similar a `planes.js` líneas 180-244):\n```javascript\nif (es_plan_creditos) {\n    // Renderizar card de plan de créditos con:\n    // - Icono de IA\n    // - Nombre del plan de créditos\n    // - Barra de progreso de créditos\n    // - Estado del plan\n    continue;\n}\n```\n\n## Archivos a Modificar\n\n| Archivo | Cambio |\n|---------|--------|\n| `app/Http/Repositories/Empresas/EmpresaPlanRepository.php` | Agregar método `planesCreditosActivos()` |\n| `app/Http/Services/Empresas/EmpresaPlanService.php` | Agregar método `obtenerPlanesCreditosActivos()` |\n| `app/Http/Services/Empresas/EmpresaService.php` | Modificar `getUno()` para incluir planes de créditos |\n| `public/js/empresas/empresas.js` | Modificar `mostrarPlanes()` para renderizar planes de créditos |\n\n## Verificación\n\n1. Acceder a `/empresas-gestionar/{id}` con una empresa que tenga planes de créditos\n2. Verificar que se muestren tanto los planes normales como los de créditos en la pestaña \"Planes\"\n3. Verificar que los datos de créditos (total, consumidos, restantes) se muestren correctamente\n4. Comparar con `/planes-clientes` para asegurar consistencia visual\n","structuredPatch":[],"originalFile":null},"sourceToolAssistantUUID":"4a976d5c-cc0f-439d-8867-c18d422c2017"}
{"parentUuid":"42ea2d16-bb59-441f-b15d-7e91b6bd2e58","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ELjXBS5SLeU97HWMsJr2mT","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"He escrito el plan. Ahora necesito salir del modo plan para que el usuario pueda aprobarlo.","signature":"EoMCCkYICxgCKkD+Jl1G3stf5Km5eYX1H0ZXwp+OPt46NYKymNca8fp6gTsHOl7Spl3CzgxHRbgfvdzxL5LnVOTWc5UVs4oqUm97EgzG/AXMukqmxo9eigUaDIa9bYfs2ksadkkIPiIw0lrz4W2HQP4Uk0F9Z1jCRkAzq8DQL6Xc/ufNQ1EuZtNCiWa25pM1pwI7AlJemONRKmuFZJjqnv94sQGYPQR/+2rThqK/JAd8hTFiXVUJvQS5hPFmgr+R4yRmvAZl8WChpPWjJKXtWXLSey6O9Yy+2ZBI05D+MZZsNtAJEVf7uikmPLYQhvmBid4spIeuisj7HAzAJNVQ5gK1I+9cLhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2227,"cache_read_input_tokens":60269,"cache_creation":{"ephemeral_5m_input_tokens":2227,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGCLrrdFX5J6xBkZm5n","type":"assistant","uuid":"d381b0ce-de4c-41ca-8816-f9636218ef65","timestamp":"2026-01-25T01:54:30.288Z"}
{"parentUuid":"d381b0ce-de4c-41ca-8816-f9636218ef65","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ELjXBS5SLeU97HWMsJr2mT","type":"message","role":"assistant","content":[{"type":"text","text":"He identificado la causa raíz y creado el plan de implementación.\n\n**Resumen del problema:**\n\n1. **Backend**: `EmpresaService::getUno()` obtiene planes iterando por cada `tipo_prueba` usando métodos que tienen `whereHas('plan', ...)`, lo que excluye planes donde `plan_id` es NULL (planes de solo créditos).\n\n2. **Frontend**: `empresas.js::mostrarPlanes()` tiene un filtro que excluye planes sin la relación `plan`:\n   ```javascript\n   if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n       continue;\n   }\n   ```\n\n**La solución** requiere modificar 4 archivos:\n- Agregar método en el repositorio para obtener planes de solo créditos\n- Agregar método en el servicio EmpresaPlan\n- Modificar `EmpresaService::getUno()` para incluir planes de créditos\n- Modificar `mostrarPlanes()` en JavaScript para renderizar planes de créditos"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2227,"cache_read_input_tokens":60269,"cache_creation":{"ephemeral_5m_input_tokens":2227,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGCLrrdFX5J6xBkZm5n","type":"assistant","uuid":"0d82feac-5297-4765-a53f-10f9dcaba95f","timestamp":"2026-01-25T01:54:33.764Z"}
{"parentUuid":"0d82feac-5297-4765-a53f-10f9dcaba95f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ELjXBS5SLeU97HWMsJr2mT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01G3x6FxmthbKXzB22wkaz7i","name":"ExitPlanMode","input":{"plan":"# Plan: Mostrar Planes de Créditos en Superadmin (empresas-gestionar)\n\n## Problema Identificado\n\nLos planes de créditos (donde `plan_id = NULL` pero `plan_credito_id != NULL`) no se muestran en la vista de superadmin `/empresas-gestionar/{id}`, pero sí en la vista de empresa `/planes-clientes`.\n\n### Causa Raíz\n\n**Nivel 1 - Backend (`EmpresaService::getUno`):**\n```php\n// Líneas 110-117 - Solo obtiene planes por tipo_prueba\nforeach ($tipos_pruebas as $tipo_prueba) {\n    $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n        ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n}\n```\nLos métodos `obtenerPlanActivo()` y `obtenerUltimoPorTipo()` usan `whereHas('plan', ...)` que excluye planes donde `plan_id` es NULL.\n\n**Nivel 2 - Frontend (`empresas.js::mostrarPlanes`):**\n```javascript\n// Líneas 1503-1505 - Filtra planes sin relación 'plan'\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n```\n\n## Solución Propuesta\n\n### Paso 1: Backend - Agregar método para obtener planes de créditos\n\n**Archivo:** `app/Http/Repositories/Empresas/EmpresaPlanRepository.php`\n\nAgregar nuevo método `planesCreditosActivos()`:\n```php\npublic function planesCreditosActivos(int $empresa_id): Collection {\n    return $this->modelo::select(...)\n        ->with(['planCredito:id,nombre,creditos,...', 'estado:id,nombre', ...])\n        ->where('empresa_id', $empresa_id)\n        ->whereNull('plan_id')\n        ->whereNotNull('plan_credito_id')\n        ->whereIn('estado_id', [1, 4]) // ACTIVO, POR_VENCER\n        ->orderBy('created_at', 'DESC')\n        ->get();\n}\n```\n\n### Paso 2: Backend - Modificar EmpresaPlanService\n\n**Archivo:** `app/Http/Services/Empresas/EmpresaPlanService.php`\n\nAgregar método `obtenerPlanesCreditosActivos()`:\n```php\npublic function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n    return $this->repositorio->planesCreditosActivos($empresa_id);\n}\n```\n\n### Paso 3: Backend - Modificar EmpresaService::getUno\n\n**Archivo:** `app/Http/Services/Empresas/EmpresaService.php` (líneas 107-117)\n\nDespués del foreach de tipos_pruebas, agregar:\n```php\n// Obtener planes de solo créditos\n$planes_creditos = $this->empresa_plan_servicio->obtenerPlanesCreditosActivos($id);\nforeach ($planes_creditos as $plan_credito) {\n    array_push($planes, $plan_credito);\n}\n```\n\n### Paso 4: Frontend - Modificar mostrarPlanes()\n\n**Archivo:** `public/js/empresas/empresas.js` (líneas 1491-1630)\n\n1. Modificar el filtro para aceptar planes de créditos:\n```javascript\n// Cambiar de:\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n\n// A:\nlet es_plan_creditos = !planes[i].plan && planes[i].plan_credito;\nif (!planes[i].plan && !es_plan_creditos) {\n    continue;\n}\n```\n\n2. Agregar lógica para renderizar planes de créditos (similar a `planes.js` líneas 180-244):\n```javascript\nif (es_plan_creditos) {\n    // Renderizar card de plan de créditos con:\n    // - Icono de IA\n    // - Nombre del plan de créditos\n    // - Barra de progreso de créditos\n    // - Estado del plan\n    continue;\n}\n```\n\n## Archivos a Modificar\n\n| Archivo | Cambio |\n|---------|--------|\n| `app/Http/Repositories/Empresas/EmpresaPlanRepository.php` | Agregar método `planesCreditosActivos()` |\n| `app/Http/Services/Empresas/EmpresaPlanService.php` | Agregar método `obtenerPlanesCreditosActivos()` |\n| `app/Http/Services/Empresas/EmpresaService.php` | Modificar `getUno()` para incluir planes de créditos |\n| `public/js/empresas/empresas.js` | Modificar `mostrarPlanes()` para renderizar planes de créditos |\n\n## Verificación\n\n1. Acceder a `/empresas-gestionar/{id}` con una empresa que tenga planes de créditos\n2. Verificar que se muestren tanto los planes normales como los de créditos en la pestaña \"Planes\"\n3. Verificar que los datos de créditos (total, consumidos, restantes) se muestren correctamente\n4. Comparar con `/planes-clientes` para asegurar consistencia visual\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2227,"cache_read_input_tokens":60269,"cache_creation":{"ephemeral_5m_input_tokens":2227,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGCLrrdFX5J6xBkZm5n","type":"assistant","uuid":"75211bc6-b3f7-4494-861a-89296300bee6","timestamp":"2026-01-25T01:54:33.849Z"}
{"parentUuid":"75211bc6-b3f7-4494-861a-89296300bee6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). STOP what you are doing and wait for the user to tell you how to proceed.","is_error":true,"tool_use_id":"toolu_01G3x6FxmthbKXzB22wkaz7i"}]},"uuid":"60ff73fa-a935-4210-9068-b6416d3c0b63","timestamp":"2026-01-25T01:55:13.463Z","toolUseResult":"Error: The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). STOP what you are doing and wait for the user to tell you how to proceed.","sourceToolAssistantUUID":"75211bc6-b3f7-4494-861a-89296300bee6"}
{"parentUuid":"60ff73fa-a935-4210-9068-b6416d3c0b63","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"type":"text","text":"[Request interrupted by user for tool use]"}]},"uuid":"f4b0c236-61de-4f9b-b2c9-8b4623ab5153","timestamp":"2026-01-25T01:55:13.465Z"}
{"type":"file-history-snapshot","messageId":"63bb9be8-d7a7-44c3-a952-0d4f526fba4f","snapshot":{"messageId":"63bb9be8-d7a7-44c3-a952-0d4f526fba4f","trackedFileBackups":{},"timestamp":"2026-01-25T01:55:13.782Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":"Implement the following plan:\n\n# Plan: Mostrar Planes de Créditos en Superadmin (empresas-gestionar)\n\n## Problema Identificado\n\nLos planes de créditos (donde `plan_id = NULL` pero `plan_credito_id != NULL`) no se muestran en la vista de superadmin `/empresas-gestionar/{id}`, pero sí en la vista de empresa `/planes-clientes`.\n\n### Causa Raíz\n\n**Nivel 1 - Backend (`EmpresaService::getUno`):**\n```php\n// Líneas 110-117 - Solo obtiene planes por tipo_prueba\nforeach ($tipos_pruebas as $tipo_prueba) {\n    $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n        ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n}\n```\nLos métodos `obtenerPlanActivo()` y `obtenerUltimoPorTipo()` usan `whereHas('plan', ...)` que excluye planes donde `plan_id` es NULL.\n\n**Nivel 2 - Frontend (`empresas.js::mostrarPlanes`):**\n```javascript\n// Líneas 1503-1505 - Filtra planes sin relación 'plan'\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n```\n\n## Solución Propuesta\n\n### Paso 1: Backend - Agregar método para obtener planes de créditos\n\n**Archivo:** `app/Http/Repositories/Empresas/EmpresaPlanRepository.php`\n\nAgregar nuevo método `planesCreditosActivos()`:\n```php\npublic function planesCreditosActivos(int $empresa_id): Collection {\n    return $this->modelo::select(...)\n        ->with(['planCredito:id,nombre,creditos,...', 'estado:id,nombre', ...])\n        ->where('empresa_id', $empresa_id)\n        ->whereNull('plan_id')\n        ->whereNotNull('plan_credito_id')\n        ->whereIn('estado_id', [1, 4]) // ACTIVO, POR_VENCER\n        ->orderBy('created_at', 'DESC')\n        ->get();\n}\n```\n\n### Paso 2: Backend - Modificar EmpresaPlanService\n\n**Archivo:** `app/Http/Services/Empresas/EmpresaPlanService.php`\n\nAgregar método `obtenerPlanesCreditosActivos()`:\n```php\npublic function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n    return $this->repositorio->planesCreditosActivos($empresa_id);\n}\n```\n\n### Paso 3: Backend - Modificar EmpresaService::getUno\n\n**Archivo:** `app/Http/Services/Empresas/EmpresaService.php` (líneas 107-117)\n\nDespués del foreach de tipos_pruebas, agregar:\n```php\n// Obtener planes de solo créditos\n$planes_creditos = $this->empresa_plan_servicio->obtenerPlanesCreditosActivos($id);\nforeach ($planes_creditos as $plan_credito) {\n    array_push($planes, $plan_credito);\n}\n```\n\n### Paso 4: Frontend - Modificar mostrarPlanes()\n\n**Archivo:** `public/js/empresas/empresas.js` (líneas 1491-1630)\n\n1. Modificar el filtro para aceptar planes de créditos:\n```javascript\n// Cambiar de:\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n\n// A:\nlet es_plan_creditos = !planes[i].plan && planes[i].plan_credito;\nif (!planes[i].plan && !es_plan_creditos) {\n    continue;\n}\n```\n\n2. Agregar lógica para renderizar planes de créditos (similar a `planes.js` líneas 180-244):\n```javascript\nif (es_plan_creditos) {\n    // Renderizar card de plan de créditos con:\n    // - Icono de IA\n    // - Nombre del plan de créditos\n    // - Barra de progreso de créditos\n    // - Estado del plan\n    continue;\n}\n```\n\n## Archivos a Modificar\n\n| Archivo | Cambio |\n|---------|--------|\n| `app/Http/Repositories/Empresas/EmpresaPlanRepository.php` | Agregar método `planesCreditosActivos()` |\n| `app/Http/Services/Empresas/EmpresaPlanService.php` | Agregar método `obtenerPlanesCreditosActivos()` |\n| `app/Http/Services/Empresas/EmpresaService.php` | Modificar `getUno()` para incluir planes de créditos |\n| `public/js/empresas/empresas.js` | Modificar `mostrarPlanes()` para renderizar planes de créditos |\n\n## Verificación\n\n1. Acceder a `/empresas-gestionar/{id}` con una empresa que tenga planes de créditos\n2. Verificar que se muestren tanto los planes normales como los de créditos en la pestaña \"Planes\"\n3. Verificar que los datos de créditos (total, consumidos, restantes) se muestren correctamente\n4. Comparar con `/planes-clientes` para asegurar consistencia visual\n\n\nIf you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: C:\\Users\\sergio\\.claude\\projects\\C--Users-sergio-proyectos-Psicoalianza-2\\b38f8226-e093-42db-89cf-c257cfab7b2d.jsonl"},"uuid":"63bb9be8-d7a7-44c3-a952-0d4f526fba4f","timestamp":"2026-01-25T01:55:13.758Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"permissionMode":"acceptEdits"}
{"parentUuid":"63bb9be8-d7a7-44c3-a952-0d4f526fba4f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PLJF4BfhDWnUY8X11KZLcu","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que implemente el plan para mostrar los planes de créditos en la vista de superadmin. Voy a seguir los pasos del plan:\n\n1. Agregar método `planesCreditosActivos()` en EmpresaPlanRepository\n2. Agregar método `obtenerPlanesCreditosActivos()` en EmpresaPlanService\n3. Modificar `getUno()` en EmpresaService\n4. Modificar `mostrarPlanes()` en empresas.js\n\nPrimero necesito leer los archivos actuales para entender la estructura existente y hacer los cambios correctamente.","signature":"Eo0FCkYICxgCKkAxCbmg9FUZ/joXUQOln9xj+CoKS0pUz4R2ktUdguQXNVpoXATPhxbDckxrYL7Eu3CQ/aU0inuSSjZQhecEaYL1EgwWvXYng6hTxcB+LJgaDEpFrjlh4Ki6yeOrhyIwxI4PEQ1EI7UMJz+GJxwDuAtO835bwl3Q7rK57WcqAsS2ymaghrfyEg46n/FhNsu2KvQDKVIhHed1QJgUintxzvlcFD4Ide/sEMfMtNjGK+UG7AN2yGw/kOKUNWqglslbupKgLfs5to7xvSfngtI0ZwxXH1lPLnzsBXEvAGbc6u4noox+SsXu8SdxkJuWFYTZxvhUKtS81G0Jn/uKfBAm6ayMEN0ps8ohSSh+WIMKHo2zzEuj7g9Q3VoMHYPR0ojMDHXzzVvrOuOV4EdI2g5Bl+bhbaPaDYlIALKyKwoSO9WbamblBxvmsUAlhcdF04OzsIRtE0Gl/JyqsPPJvkpkJkmRkR/lcoKzoAwaHp3LkDs/xXCY3Cfu+vlD6vP4uACko6JfrsiGtZz58YCyphWnMG98+LsrhxgjzQElf1pa8RoweGq6wj4jXCaK7Oacs25h7e3W0M/Z8lb5rRC6Q0j1EKGCGMAkE2FIStPTqkBiiX+Nl+mAZvkfuePdujSpX6cjUdMYUpNQW86ByzP8rtjrxOsmrcZ2hWFSCWpUATPM1RY9i4tHhhc0Dakpo3GeUhNUtONXCLoBAk1BkA+9QY9DB+hFuIoFhcfxgsrK/l8vOoderT/zQFaxKOMW9DNs9brgXLjwS3snv2NitVn7h5iMBSVgFbfUP8GVTEU52lBhQ5x0+b+7Ev884oTSesA9HRaPx0cZZGeeaRwztK/yVcaHvvNEnzAHrgAYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":6263,"cache_read_input_tokens":19752,"cache_creation":{"ephemeral_5m_input_tokens":6263,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTGFjw1ZtzcbjjbeAXmU","type":"assistant","uuid":"2cd820b5-1fec-4154-9300-ccb91196a0d5","timestamp":"2026-01-25T01:55:20.188Z"}
{"parentUuid":"2cd820b5-1fec-4154-9300-ccb91196a0d5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PLJF4BfhDWnUY8X11KZLcu","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a implementar el plan. Primero necesito leer los archivos actuales para hacer los cambios correctamente."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":6263,"cache_read_input_tokens":19752,"cache_creation":{"ephemeral_5m_input_tokens":6263,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTGFjw1ZtzcbjjbeAXmU","type":"assistant","uuid":"ebcb02c2-b0f3-4e4e-be7e-a17f3daf415e","timestamp":"2026-01-25T01:55:20.382Z"}
{"parentUuid":"ebcb02c2-b0f3-4e4e-be7e-a17f3daf415e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PLJF4BfhDWnUY8X11KZLcu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FDcK828XdU4Gv2u79J6Db2","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":6263,"cache_read_input_tokens":19752,"cache_creation":{"ephemeral_5m_input_tokens":6263,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTGFjw1ZtzcbjjbeAXmU","type":"assistant","uuid":"2c105692-19e4-4d7b-b095-1e193f25332d","timestamp":"2026-01-25T01:55:20.674Z"}
{"parentUuid":"2c105692-19e4-4d7b-b095-1e193f25332d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PLJF4BfhDWnUY8X11KZLcu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01M9uKTT9fywB9g2tBEaP5q1","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":6263,"cache_read_input_tokens":19752,"cache_creation":{"ephemeral_5m_input_tokens":6263,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTGFjw1ZtzcbjjbeAXmU","type":"assistant","uuid":"cb1cd043-39e5-4e7d-b731-0f63206b6ceb","timestamp":"2026-01-25T01:55:20.709Z"}
{"parentUuid":"cb1cd043-39e5-4e7d-b731-0f63206b6ceb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PLJF4BfhDWnUY8X11KZLcu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SFk7ANJwzVHi5X4zGo2LSj","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":6263,"cache_read_input_tokens":19752,"cache_creation":{"ephemeral_5m_input_tokens":6263,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXTGFjw1ZtzcbjjbeAXmU","type":"assistant","uuid":"7b2c51dc-78e8-4e01-9a71-0a55c840eba0","timestamp":"2026-01-25T01:55:20.760Z"}
{"parentUuid":"2c105692-19e4-4d7b-b095-1e193f25332d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FDcK828XdU4Gv2u79J6Db2","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\Empresas;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\Pruebas\\TipoPrueba;\n     7→use Illuminate\\Support\\Collection;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use App\\Http\\Repositories\\BaseRepository;\n    11→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    12→use App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n    13→\n    14→class EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n    15→{\n    16→    /**\n    17→     * Ids de los roles de tipo empresa.\n    18→     *\n    19→     * @var array\n    20→     * @author Fahibram Cárcamo\n    21→     */\n    22→    private const IDS_ROLES_TIPO_EMPRESA = [\n    23→        RolRepository::ROL_PROPIETARIO_ID,\n    24→        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n    25→        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n    26→        RolRepository::ROL_EVALUADOR_ID\n    27→    ];\n    28→\n    29→    private $consulta_conteo_total_usuarios_empresa_sucursales;\n    30→\n    31→    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n    32→\n    33→    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n    39→     * @return void\n    40→     * @author Daniel Beltrán\n    41→     * @author Fahibram Cárcamo\n    42→     */\n    43→    public function __construct(EmpresaPlan $modelo) {\n    44→        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n    45→            (\n    46→                SELECT COUNT(DISTINCT eu.usuario_id)\n    47→                FROM empresas_usuarios AS eu\n    48→                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n    49→                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n    50→                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n    51→            ) AS conteo_total_usuarios_empresa_sucursales\n    52→        ';\n    53→\n    54→        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n    55→            (\n    56→                SELECT COUNT(*)\n    57→                FROM consumos\n    58→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    59→                WHERE (\n    60→                    consumos.empresa_id = empresas_planes.empresa_id\n    61→                    OR suc.empresa_id = empresas_planes.empresa_id\n    62→                )\n    63→                AND consumos.agenda_id IS NOT NULL\n    64→            ) AS conteo_total_consumos_agendas_empresa_sucursales\n    65→        ';\n    66→\n    67→        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n    68→            (\n    69→                SELECT COUNT(*)\n    70→                FROM consumos\n    71→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    72→                WHERE (\n    73→                    consumos.empresa_id = empresas_planes.empresa_id\n    74→                    OR suc.empresa_id = empresas_planes.empresa_id\n    75→                )\n    76→                AND consumos.oferta_laboral_id IS NOT NULL\n    77→            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n    78→        ';\n    79→\n    80→        parent::__construct($modelo);\n    81→    }\n    82→\n    83→    /**\n    84→     * Obtener todos los planes de empresas.\n    85→     *\n    86→     * @param Request $request Contenido de la petición.\n    87→     * @return Collection\n    88→     * @author Daniel Beltrán\n    89→     * @author Fahibram Cárcamo\n    90→     * @author Jair Carvajal\n    91→     * @author Andres Gonzalez\n    92→     */\n    93→    public function getTodo(Request $request): Collection {\n    94→        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n    95→            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    96→        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n    97→            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n    98→        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n    99→            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n   100→        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n   101→            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n   102→        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n   103→            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n   104→\n   105→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   106→        ->with([\n   107→            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n   108→            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   109→            'plan.tipoPrueba:id,nombre',\n   110→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   111→            'estado:id,nombre',\n   112→            'pruebas:id,nombre',\n   113→            'funcionalidades:id,nombre,predeterminado',\n   114→            'archivos' => function ($archivos) {\n   115→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   116→            }\n   117→        ])\n   118→        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   119→            $query->with([\n   120→                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   121→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   122→                        ->with(['empresa' => function ($empresa) {\n   123→                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n   124→                        }])\n   125→                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n   126→                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n   127→                },\n   128→                'consumos.agenda:id,prueba_id',\n   129→                'consumos.agenda.prueba:id,nombre,slug'\n   130→            ]);\n   131→        })\n   132→        ->when($con_conteo_consumos_agendas, function ($consulta) {\n   133→            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   134→        })\n   135→        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n   136→            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   137→        })\n   138→        ->when($con_conteo_consumos_creditos, function ($consulta) {\n   139→            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n   140→        })\n   141→        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n   142→            $query->where('empresa_id', $request->empresa_id);\n   143→        })\n   144→        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n   145→            $query->whereHas('plan', function ($plan) use ($request) {\n   146→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   147→            });\n   148→        })\n   149→        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n   150→            $query->whereHas('plan', function ($plan) use ($request) {\n   151→                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n   152→            });\n   153→        })\n   154→        ->when($request->filled('plan_id'), function ($query) use ($request) {\n   155→            $query->where('plan_id', $request->plan_id);\n   156→        })\n   157→        ->when(\n   158→            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n   159→            function ($query) use ($request) {\n   160→                $query->whereIn($request->campo, $request->valores);\n   161→            }\n   162→        )\n   163→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   164→            $consulta->whereIn('estado_id', $request->estado_id);\n   165→        })\n   166→        ->when(\n   167→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   168→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   169→        )\n   170→        ->when(\n   171→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   172→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   173→        )\n   174→        ->when(\n   175→            $request->filled('fecha_vencimiento_desde'),\n   176→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   177→        )\n   178→        ->when(\n   179→            $request->filled('fecha_vencimiento_hasta'),\n   180→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   181→        )\n   182→        ->when(\n   183→            $request->filled('fecha_inicio_desde'),\n   184→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   185→        )\n   186→        ->when(\n   187→            $request->filled('fecha_inicio_hasta'),\n   188→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   189→        )\n   190→        ->orderBy('created_at', 'DESC')\n   191→        ->get();\n   192→    }\n   193→\n   194→    /**\n   195→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n   196→     *\n   197→     * @param Request $request Contenido de la petición HTTP entrante.\n   198→     * @return Collection\n   199→     * @author Fahibram Cárcamo\n   200→     * @author Jair Carvajal\n   201→     */\n   202→    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n   203→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   204→            ->addSelect([\n   205→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   206→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   207→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   208→            ])\n   209→            ->whereExists(function ($subconsulta) {\n   210→                $subconsulta->select(DB::raw(1))\n   211→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   212→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   213→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   214→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   215→            })\n   216→            ->with([\n   217→                'estado:id,nombre',\n   218→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   219→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n   220→            ])\n   221→            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n   222→            ->when(\n   223→                $request->filled('tipo_prueba_id'),\n   224→                function ($consulta) use ($request) {\n   225→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   226→                },\n   227→                function ($consulta) {\n   228→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   229→                        TipoPrueba::SELECCION_ID,\n   230→                        TipoPrueba::ORGANIZACIONAL_ID,\n   231→                        TipoPrueba::VOCACIONAL_ID\n   232→                    ]));\n   233→                }\n   234→            )\n   235→            ->get();\n   236→    }\n   237→\n   238→    /**\n   239→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n   240→     *\n   241→     * @param Request $request Contenido de la petición HTTP entrante.\n   242→     * @return Collection\n   243→     * @author Fahibram Cárcamo\n   244→     * @author Andres Gonzalez\n   245→     * @author Jair Carvajal\n   246→     */\n   247→    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n   248→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   249→            ->addSelect([\n   250→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   251→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   252→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   253→            ])\n   254→            ->whereExists(function ($sub_consulta) {\n   255→                $sub_consulta->select(DB::raw(1))\n   256→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   257→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   258→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   259→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   260→            })\n   261→            ->with([\n   262→                'estado:id,nombre',\n   263→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   264→                'plan.tipoPrueba:id,nombre',\n   265→                'pruebas:id,nombre,slug',\n   266→                'funcionalidades:id,nombre,predeterminado',\n   267→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n   268→                'consumos' => function ($consumos) {\n   269→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   270→                        ->with([\n   271→                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   272→                            'agenda:id,prueba_id',\n   273→                            'agenda.prueba:id,nombre,slug'\n   274→                        ]);\n   275→                }\n   276→            ])\n   277→            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   278→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   279→            })\n   280→            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   281→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n   282→            })\n   283→            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n   284→                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n   285→                    $sub_consulta->where('empresa_id', $request->empresa_id)\n   286→                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n   287→                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n   288→                        });\n   289→                });\n   290→            })\n   291→            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   292→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   293→            }, function ($consulta) {\n   294→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   295→                    TipoPrueba::SELECCION_ID,\n   296→                    TipoPrueba::ORGANIZACIONAL_ID,\n   297→                    TipoPrueba::VOCACIONAL_ID\n   298→                ]));\n   299→            })\n   300→            ->orderBy('created_at', 'DESC')\n   301→            ->get();\n   302→    }\n   303→\n   304→    /**\n   305→     * Obtener datos básicos de los planes de empresas.\n   306→     *\n   307→     * @param Request $request Contenido de la petición.\n   308→     * @return Collection\n   309→     * @author Daniel Beltrán\n   310→     * @author Fahibram Cárcamo\n   311→     * @author Jair Carvajal\n   312→     * @author Sergio Vargas\n   313→     */\n   314→    public function getDatosBasicos(Request $request): Collection {\n   315→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   316→        ->with([\n   317→            'plan:id,tipo_prueba_id,nombre',\n   318→            'planCredito:id,nombre,creditos',\n   319→            'consumosCreditos'\n   320→        ])\n   321→        ->withCount([\n   322→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   323→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n   324→        ])\n   325→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   326→            $consulta->where('empresa_id', $request->empresa_id);\n   327→        })\n   328→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   329→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   330→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   331→            });\n   332→        })\n   333→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   334→            $consulta->whereIn('estado_id', $request->estados_ids);\n   335→        })\n   336→        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n   337→            $sentido = $request->ordenar_sentido ?? 'ASC';\n   338→            $consulta->orderBy($request->ordenar_por, $sentido);\n   339→        })\n   340→        ->get();\n   341→    }\n   342→\n   343→    /**\n   344→     * Obtener el proximo plan de creditos de la empresa.\n   345→     *\n   346→     * @param int $empresa_id ID de la empresa.\n   347→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   348→     * @return EmpresaPlan|null\n   349→     * @author Sergio Vargas\n   350→     */\n   351→    public function planProximoCreditos(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   352→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   353→        ->with(['planCredito:id,nombre,creditos,precio'])\n   354→        ->where([\n   355→            'empresa_id' => $empresa_id,\n   356→            'estado_id'  => 3\n   357→        ])\n   358→        ->whereNotNull('plan_credito_id')\n   359→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   360→            $query->where(function ($q) use ($tipo_prueba_id) {\n   361→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   362→                  ->orWhereNull('plan_id');\n   363→            });\n   364→        })\n   365→        ->orderBy('created_at', 'ASC')\n   366→        ->first();\n   367→    }\n   368→\n   369→    /**\n   370→     * Obtener el plan de creditos activo de la empresa.\n   371→     *\n   372→     * @param int $empresa_id ID de la empresa.\n   373→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   374→     * @return EmpresaPlan|null\n   375→     * @author Sergio Vargas\n   376→     */\n   377→    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   378→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   379→        ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n   380→        ->where('empresa_id', $empresa_id)\n   381→        ->whereNotNull('plan_credito_id')\n   382→        ->whereIn('estado_id', [1, 4])\n   383→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   384→            $query->where(function ($q) use ($tipo_prueba_id) {\n   385→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   386→                  ->orWhereNull('plan_id');\n   387→            });\n   388→        })\n   389→        ->first();\n   390→    }\n   391→\n   392→    /**\n   393→     * Obtener un plan de empresa.\n   394→     *\n   395→     * @param int $id ID del plan de empresa.\n   396→     * @return EmpresaPlan|null\n   397→     * @author Daniel Beltrán\n   398→     * @author Jair Carvajal\n   399→     */\n   400→    public function getUno(int $id): ?EmpresaPlan {\n   401→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   402→        ->with([\n   403→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n   404→            'plan.tipoPrueba:id,nombre',\n   405→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   406→            'estado:id,nombre',\n   407→            'pruebas:id,nombre,slug',\n   408→            'funcionalidades:id,nombre,llave,valor',\n   409→            'archivos' => function ($archivos) {\n   410→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   411→            }\n   412→        ])\n   413→        ->find($id);\n   414→    }\n   415→\n   416→    /**\n   417→     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n   418→     *\n   419→     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n   420→     *\n   421→     * @param int $empresa_id ID de la empresa.\n   422→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   423→     * @return EmpresaPlan|null\n   424→     * @author Daniel Beltrán\n   425→     * @author Fahibram Cárcamo\n   426→     * @author José Manuel Jiménez\n   427→     * @author Andres Gonzalez\n   428→     * @author Sergio Vargas\n   429→     * @author Jair Carvajal\n   430→     */\n   431→    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   432→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   433→        ->with([\n   434→            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n   435→            'plan.tipoPrueba:id,nombre',\n   436→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   437→            'estado:id,nombre',\n   438→            'pruebas:id,nombre,slug',\n   439→            'usuario:id,nombres,apellidos',\n   440→            'archivos' => function ($archivos) {\n   441→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   442→                ->orderBy('created_at', 'DESC');\n   443→            }\n   444→        ])\n   445→        ->withCount([\n   446→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   447→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n   448→            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n   449→        ])\n   450→        ->where('empresa_id', $empresa_id)\n   451→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   452→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   453→        })\n   454→        ->whereIn('estado_id', [1, 4])\n   455→        ->first();\n   456→    }\n   457→\n   458→    /**\n   459→     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n   460→     *\n   461→     * @param int $empresa_id ID de la empresa.\n   462→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   463→     * @return EmpresaPlan|null\n   464→     * @author Daniel Beltrán\n   465→     * @author Jair Carvajal\n   466→     */\n   467→    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   468→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   469→        ->with([\n   470→            'plan:id,tipo_prueba_id,nombre',\n   471→            'plan.tipoPrueba:id,nombre',\n   472→            'estado:id,nombre',\n   473→            'pruebas:id,nombre',\n   474→            'archivos' => function ($archivos) {\n   475→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   476→                ->orderBy('created_at', 'DESC');\n   477→            }\n   478→        ])\n   479→        ->where([\n   480→            'empresa_id' => $empresa_id,\n   481→            'estado_id'  => 3\n   482→        ])\n   483→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   484→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   485→        })\n   486→        ->first();\n   487→    }\n   488→\n   489→    /**\n   490→     * Obtener el último plan asignado.\n   491→     *\n   492→     * @param Request $request Contenido de la petición.\n   493→     * @return EmpresaPlan|null\n   494→     * @author Daniel Beltrán\n   495→     * @author Jair Carvajal\n   496→     */\n   497→    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n   498→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   499→        ->with([\n   500→            'plan:id,tipo_prueba_id,nombre',\n   501→            'plan.tipoPrueba:id,nombre',\n   502→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   503→            'estado:id,nombre',\n   504→            'pruebas:id,nombre',\n   505→            'archivos' => function ($archivos) {\n   506→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   507→                ->orderBy('created_at', 'DESC');\n   508→            }\n   509→        ])\n   510→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   511→            $consulta->where('empresa_id', $request->empresa_id);\n   512→        })\n   513→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   514→            $consulta->where('estado_id', $request->estado_id);\n   515→        })\n   516→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   517→            $consulta->whereIn('estado_id', $request->estados_ids);\n   518→        })\n   519→        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   520→            $consulta->where('estado_id', '!=', 3);\n   521→        })\n   522→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   523→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   524→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   525→            });\n   526→        })\n   527→        ->orderBy('created_at', 'DESC')\n   528→        ->first();\n   529→    }\n   530→\n   531→    /**\n   532→     * Sincronizar pruebas.\n   533→     *\n   534→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   535→     * @param array $pruebas ID's de las pruebas.\n   536→     * @return void\n   537→     * @author Daniel Beltrán\n   538→     */\n   539→    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n   540→        $empresa_plan->pruebas()->sync($pruebas);\n   541→    }\n   542→\n   543→    /**\n   544→     * Sincronizar funcionalidades.\n   545→     *\n   546→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   547→     * @param array $funcionalidades ID's de las funcionalidades.\n   548→     * @return void\n   549→     * @author Daniel Beltrán\n   550→     */\n   551→    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n   552→        $empresa_plan->funcionalidades()->sync($funcionalidades);\n   553→    }\n   554→\n   555→    /**\n   556→     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n   557→     *\n   558→     * @param Request $request Contenido de la petición.\n   559→     * @return ?EmpresaPlan\n   560→     * @author Fahibram Cárcamo\n   561→     * @author Jair Carvajal\n   562→     */\n   563→    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n   564→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   565→        ->with([\n   566→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n   567→            'plan.tipoPrueba:id,nombre',\n   568→            'estado:id,nombre',\n   569→            'pruebas:id,nombre',\n   570→            'funcionalidades:id,nombre,llave,valor'\n   571→        ])\n   572→        ->when(\n   573→            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n   574→            function ($consulta) {\n   575→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   576→            }\n   577→        )\n   578→        ->when(\n   579→            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n   580→            function ($consulta) {\n   581→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   582→            }\n   583→        )\n   584→        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n   585→        ->first();\n   586→    }\n   587→\n   588→    /**\n   589→     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n   590→     *\n   591→     * @return Collection\n   592→     * @author Fahibram Cárcamo\n   593→     * @author Andres Gonzalez\n   594→     * @author José Manuel Jiménez\n   595→     * @author Jair Carvajal\n   596→     * @author Daniel Beltrán\n   597→     */\n   598→    public function datosConsumosEmpresas(Request $request): Collection {\n   599→        $roles_tipo_empresa_ids = [\n   600→            RolRepository::ROL_PROPIETARIO_ID,\n   601→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   602→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   603→            RolRepository::ROL_EVALUADOR_ID\n   604→        ];\n   605→\n   606→        $matriz_conteos = [\n   607→            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n   608→            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n   609→            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n   610→                'empresasUsuarios',\n   611→                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n   612→            )\n   613→        ];\n   614→\n   615→        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n   616→\n   617→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   618→            ->addSelect([\n   619→                DB::raw('\n   620→                    (\n   621→                        SELECT COUNT(DISTINCT eu.usuario_id)\n   622→                        FROM empresas_usuarios AS eu\n   623→                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n   624→                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n   625→                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n   626→                    ) AS conteo_total_usuarios_empresa_sucursales\n   627→                '),\n   628→                DB::raw('\n   629→                    (\n   630→                        SELECT COUNT(*)\n   631→                        FROM consumos\n   632→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   633→                        WHERE (\n   634→                            consumos.empresa_id = empresas_planes.empresa_id\n   635→                            OR suc.empresa_id = empresas_planes.empresa_id\n   636→                        )\n   637→                        AND consumos.agenda_id IS NOT NULL\n   638→                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n   639→                '),\n   640→                DB::raw('\n   641→                    (\n   642→                        SELECT COUNT(*)\n   643→                        FROM consumos\n   644→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   645→                        WHERE (\n   646→                            consumos.empresa_id = empresas_planes.empresa_id\n   647→                            OR suc.empresa_id = empresas_planes.empresa_id\n   648→                        )\n   649→                        AND consumos.oferta_laboral_id IS NOT NULL\n   650→                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n   651→                '),\n   652→            ])\n   653→            ->with([\n   654→                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n   655→                'plan.tipoPrueba:id,nombre',\n   656→                'pruebas:id,nombre,slug',\n   657→                'estado:id,nombre',\n   658→                'usuario:id,nombres,apellidos',\n   659→                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n   660→                    $consulta_empresa->select($campos_empresas)\n   661→                        ->whereNull('empresa_id')\n   662→                        ->withCount([\n   663→                            ...$matriz_conteos,\n   664→                            'sucursales as conteo_sucursales'\n   665→                        ])\n   666→                        ->with([\n   667→                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n   668→                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n   669→                            }\n   670→                        ]);\n   671→                }\n   672→            ])\n   673→            ->when(\n   674→                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n   675→                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n   676→            )\n   677→            ->whereNotIn('estado_id', [3, 8])\n   678→            ->when(\n   679→                $request->filled('prueba_id'),\n   680→                fn($consulta) => $consulta->whereHas(\n   681→                    'pruebas',\n   682→                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n   683→                )\n   684→            )\n   685→            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n   686→                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n   687→            })\n   688→            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n   689→                switch ($request->plan_por) {\n   690→                    case 'por unidades':\n   691→                        $consulta_plan_por->whereNotNull('unidades');\n   692→                        break;\n   693→\n   694→                    case 'por ofertas laborales':\n   695→                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n   696→                        break;\n   697→\n   698→                    case 'por tiempo':\n   699→                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n   700→                        break;\n   701→                }\n   702→            })\n   703→            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n   704→                $fecha_inicio = $request->fecha_vencimiento;\n   705→                $fecha_fin    = $request->fecha_vencimiento;\n   706→\n   707→                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n   708→                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n   709→                    $fecha_inicio = $fechas[0];\n   710→                    $fecha_fin    = $fechas[1];\n   711→                }\n   712→\n   713→                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n   714→            })\n   715→            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n   716→                $fecha_inicio = $request->fecha_inicio;\n   717→                $fecha_fin    = $request->fecha_inicio;\n   718→\n   719→                if (strpos($request->fecha_inicio, ' a ') !== false) {\n   720→                    $fechas       = explode(' a ', $request->fecha_inicio);\n   721→                    $fecha_inicio = $fechas[0];\n   722→                    $fecha_fin    = $fechas[1];\n   723→                }\n   724→\n   725→                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n   726→            })\n   727→            ->when(\n   728→                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   729→                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n   730→            )\n   731→            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n   732→                if ($request->tipo_activacion === 'compra') {\n   733→                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n   734→                        $subconsulta->select(DB::raw(1))\n   735→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   736→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   737→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   738→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   739→                    });\n   740→                } elseif ($request->tipo_activacion === 'recompra') {\n   741→                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n   742→                        $subconsulta->select(DB::raw(1))\n   743→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   744→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   745→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   746→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   747→                    });\n   748→                }\n   749→            })\n   750→            ->get();\n   751→    }\n   752→\n   753→    /**\n   754→     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n   755→     *\n   756→     * @param Request $request Contenido de la petición HTTP entrante.\n   757→     * @return Collection\n   758→     * @author Fahibram Cárcamo\n   759→     */\n   760→    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n   761→        return $this->modelo::select(\n   762→            'empresas_planes.id',\n   763→            'empresas_planes.empresa_id',\n   764→            'empresas_planes.plan_id',\n   765→            'empresas_planes.plan_credito_id',\n   766→            'empresas_planes.usuario_id',\n   767→            'empresas_planes.estado_id',\n   768→            'empresas_planes.unidades',\n   769→            'empresas_planes.cantidad_ofertas_laborales',\n   770→            'empresas_planes.cantidad_usuarios',\n   771→            'empresas_planes.cantidad_pruebas',\n   772→            'empresas_planes.creditos',\n   773→            'empresas_planes.fecha_inicio',\n   774→            'empresas_planes.fecha_vencimiento',\n   775→            'empresas_planes.precio',\n   776→            'empresas_planes.porcentaje_descuento',\n   777→            'empresas_planes.numero_factura',\n   778→            'empresas_planes.comentario',\n   779→            'empresas_planes.plan_original',\n   780→            'empresas_planes.renovando',\n   781→            'empresas_planes.por_facturar',\n   782→            'empresas_planes.created_at',\n   783→            'planes.id',\n   784→            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n   785→            'planes.nombre AS plan_nombre',\n   786→            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n   787→            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n   788→            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n   789→            'planes.unidades AS plan_unidades',\n   790→            'planes.vigencia AS plan_vigencia',\n   791→            'planes.precio AS plan_precio',\n   792→            'tipos_pruebas.id AS tipo_prueba_id',\n   793→            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n   794→            'estados_planes.id AS estado_plan_id',\n   795→            'estados_planes.nombre AS estado_plan_nombre',\n   796→            'users.id AS usuario_usuario_id',\n   797→            'users.nombres AS usuario_nombres',\n   798→            'users.apellidos AS usuario_apellidos',\n   799→            'empresas.id AS empresa_empresa_id',\n   800→            'empresas.empresa_id',\n   801→            'empresas.nombre_comercial AS empresa_nombre_comercial',\n   802→            'empresas.razon_social AS empresa_razon_social',\n   803→            'empresas.nombre_contacto',\n   804→            'empresas.celular_contacto',\n   805→            'empresas.email_contacto',\n   806→            'empresas.telefono_contacto',\n   807→            'empresas.extension_contacto',\n   808→            'empresas.nombre_tesorero',\n   809→            'empresas.celular_tesorero',\n   810→            'empresas.telefono_tesorero',\n   811→            'empresas.email_tesorero',\n   812→            DB::raw('\n   813→                (\n   814→                    SELECT COUNT(*)\n   815→                    FROM consumos\n   816→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n   817→                )\n   818→                AS conteo_consumos_agendas\n   819→            '),\n   820→            DB::raw('\n   821→                (\n   822→                    SELECT COUNT(*)\n   823→                    FROM consumos\n   824→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n   825→                )\n   826→                AS conteo_consumos_ofertas_laborales\n   827→            '),\n   828→            DB::raw('\n   829→                (\n   830→                    SELECT COUNT(*)\n   831→                    FROM empresas\n   832→                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n   833→                )\n   834→                AS conteo_sucursales\n   835→            '),\n   836→            DB::raw('\n   837→                (\n   838→                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n   839→                    FROM empresas AS sucursales\n   840→                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n   841→                )\n   842→                AS nombres_comerciales_sucursales\n   843→            ')\n   844→        )\n   845→        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n   846→        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n   847→        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n   848→        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n   849→        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n   850→        ->whereNull('empresas.empresa_id')\n   851→        ->when(\n   852→            $request->filled('plan_por'),\n   853→            function ($consulta) use ($request) {\n   854→                switch ($request->plan_por) {\n   855→                    case 'por unidades':\n   856→                        $consulta->whereNotNull('empresas_planes.unidades');\n   857→                        break;\n   858→\n   859→                    case 'por ofertas laborales':\n   860→                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n   861→                        break;\n   862→\n   863→                    case 'por tiempo':\n   864→                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n   865→                        break;\n   866→                }\n   867→            }\n   868→        )\n   869→        ->when(\n   870→            $request->filled('tipo_prueba_id'),\n   871→            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n   872→            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n   873→                TipoPrueba::SELECCION_ID,\n   874→                TipoPrueba::ORGANIZACIONAL_ID,\n   875→                TipoPrueba::VOCACIONAL_ID\n   876→            ])\n   877→        )\n   878→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n   879→        ->when(\n   880→            $request->filled('ejecutivo_id'),\n   881→            function ($consulta) use ($request) {\n   882→                $consulta->whereExists(function ($subconsulta) use ($request) {\n   883→                    $subconsulta->select(DB::raw(1))\n   884→                        ->from('empresas_usuarios')\n   885→                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n   886→                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n   887→                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n   888→                });\n   889→            }\n   890→        )\n   891→        ->when(\n   892→            $request->filled('fecha_vencimiento'),\n   893→            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n   894→        )\n   895→        ->when(\n   896→            $request->filled('fecha_inicio'),\n   897→            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n   898→        )\n   899→        ->when(\n   900→            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   901→            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n   902→        )\n   903→        ->get();\n   904→    }\n   905→\n   906→    /**\n   907→     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n   908→     *\n   909→     * @param int $empresa_id ID de la empresa.\n   910→     * @param Request $request Contenido de la peticion.\n   911→     * @return Collection\n   912→     * @author Sergio Vargas\n   913→     */\n   914→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   915→        return $this->modelo::select(\n   916→            'id',\n   917→            'empresa_id',\n   918→            'plan_credito_id',\n   919→            'estado_id',\n   920→            'creditos',\n   921→            'fecha_inicio',\n   922→            'fecha_vencimiento',\n   923→            'precio',\n   924→            'porcentaje_descuento',\n   925→            'numero_factura',\n   926→            'comentario',\n   927→            'created_at'\n   928→        )\n   929→        ->with([\n   930→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   931→            'estado:id,nombre',\n   932→            'archivos' => function ($archivos) {\n   933→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   934→                    ->orderBy('created_at', 'DESC');\n   935→            }\n   936→        ])\n   937→        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n   938→        ->where('empresa_id', $empresa_id)\n   939→        ->whereNotNull('plan_credito_id')\n   940→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n   941→        ->when(\n   942→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   943→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   944→        )\n   945→        ->when(\n   946→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   947→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   948→        )\n   949→        ->when(\n   950→            $request->filled('fecha_vencimiento_desde'),\n   951→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   952→        )\n   953→        ->when(\n   954→            $request->filled('fecha_vencimiento_hasta'),\n   955→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   956→        )\n   957→        ->when(\n   958→            $request->filled('fecha_inicio_desde'),\n   959→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   960→        )\n   961→        ->when(\n   962→            $request->filled('fecha_inicio_hasta'),\n   963→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   964→        )\n   965→        ->orderBy('created_at', 'DESC')\n   966→        ->get();\n   967→    }\n   968→}\n   969→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"091d5284-7493-41c8-9ca9-c4197fa164fd","timestamp":"2026-01-25T01:55:23.107Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","content":"<?php\n\nnamespace App\\Http\\Repositories\\Empresas;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Repositories\\BaseRepository;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n\nclass EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n{\n    /**\n     * Ids de los roles de tipo empresa.\n     *\n     * @var array\n     * @author Fahibram Cárcamo\n     */\n    private const IDS_ROLES_TIPO_EMPRESA = [\n        RolRepository::ROL_PROPIETARIO_ID,\n        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n        RolRepository::ROL_EVALUADOR_ID\n    ];\n\n    private $consulta_conteo_total_usuarios_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(EmpresaPlan $modelo) {\n        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n            (\n                SELECT COUNT(DISTINCT eu.usuario_id)\n                FROM empresas_usuarios AS eu\n                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n            ) AS conteo_total_usuarios_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.agenda_id IS NOT NULL\n            ) AS conteo_total_consumos_agendas_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.oferta_laboral_id IS NOT NULL\n            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n        ';\n\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener todos los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function getTodo(Request $request): Collection {\n        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n            'empresa:id,empresa_id,nombre_comercial,razon_social',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,predeterminado',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n            $query->with([\n                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with(['empresa' => function ($empresa) {\n                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n                        }])\n                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n                },\n                'consumos.agenda:id,prueba_id',\n                'consumos.agenda.prueba:id,nombre,slug'\n            ]);\n        })\n        ->when($con_conteo_consumos_agendas, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n        })\n        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($con_conteo_consumos_creditos, function ($consulta) {\n            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n            $query->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n            });\n        })\n        ->when($request->filled('plan_id'), function ($query) use ($request) {\n            $query->where('plan_id', $request->plan_id);\n        })\n        ->when(\n            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n            function ($query) use ($request) {\n                $query->whereIn($request->campo, $request->valores);\n            }\n        )\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estado_id);\n        })\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($subconsulta) {\n                $subconsulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n            ])\n            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n            ->when(\n                $request->filled('tipo_prueba_id'),\n                function ($consulta) use ($request) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n                },\n                function ($consulta) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                        TipoPrueba::SELECCION_ID,\n                        TipoPrueba::ORGANIZACIONAL_ID,\n                        TipoPrueba::VOCACIONAL_ID\n                    ]));\n                }\n            )\n            ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($sub_consulta) {\n                $sub_consulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'funcionalidades:id,nombre,predeterminado',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n                'consumos' => function ($consumos) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with([\n                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n                            'agenda:id,prueba_id',\n                            'agenda.prueba:id,nombre,slug'\n                        ]);\n                }\n            ])\n            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            })\n            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n            })\n            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n                    $sub_consulta->where('empresa_id', $request->empresa_id)\n                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n                        });\n                });\n            })\n            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n            }, function ($consulta) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                    TipoPrueba::SELECCION_ID,\n                    TipoPrueba::ORGANIZACIONAL_ID,\n                    TipoPrueba::VOCACIONAL_ID\n                ]));\n            })\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener datos básicos de los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     * @author Sergio Vargas\n     */\n    public function getDatosBasicos(Request $request): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'planCredito:id,nombre,creditos',\n            'consumosCreditos'\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n            $sentido = $request->ordenar_sentido ?? 'ASC';\n            $consulta->orderBy($request->ordenar_por, $sentido);\n        })\n        ->get();\n    }\n\n    /**\n     * Obtener el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planProximoCreditos(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with(['planCredito:id,nombre,creditos,precio'])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereNotNull('plan_credito_id')\n        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n            $query->where(function ($q) use ($tipo_prueba_id) {\n                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n                  ->orWhereNull('plan_id');\n            });\n        })\n        ->orderBy('created_at', 'ASC')\n        ->first();\n    }\n\n    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->whereIn('estado_id', [1, 4])\n        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n            $query->where(function ($q) use ($tipo_prueba_id) {\n                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n                  ->orWhereNull('plan_id');\n            });\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'funcionalidades:id,nombre,llave,valor',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->find($id);\n    }\n\n    /**\n     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n     *\n     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author José Manuel Jiménez\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])\n        ->first();\n    }\n\n    /**\n     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener el último plan asignado.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->where('estado_id', $request->estado_id);\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n    }\n\n    /**\n     * Sincronizar pruebas.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $pruebas ID's de las pruebas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n        $empresa_plan->pruebas()->sync($pruebas);\n    }\n\n    /**\n     * Sincronizar funcionalidades.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $funcionalidades ID's de las funcionalidades.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n        $empresa_plan->funcionalidades()->sync($funcionalidades);\n    }\n\n    /**\n     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return ?EmpresaPlan\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,llave,valor'\n        ])\n        ->when(\n            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            }\n        )\n        ->when(\n            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n            }\n        )\n        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n        ->first();\n    }\n\n    /**\n     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n     *\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author José Manuel Jiménez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function datosConsumosEmpresas(Request $request): Collection {\n        $roles_tipo_empresa_ids = [\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID\n        ];\n\n        $matriz_conteos = [\n            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n                'empresasUsuarios',\n                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n            )\n        ];\n\n        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw('\n                    (\n                        SELECT COUNT(DISTINCT eu.usuario_id)\n                        FROM empresas_usuarios AS eu\n                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n                    ) AS conteo_total_usuarios_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.agenda_id IS NOT NULL\n                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.oferta_laboral_id IS NOT NULL\n                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n                '),\n            ])\n            ->with([\n                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n                    $consulta_empresa->select($campos_empresas)\n                        ->whereNull('empresa_id')\n                        ->withCount([\n                            ...$matriz_conteos,\n                            'sucursales as conteo_sucursales'\n                        ])\n                        ->with([\n                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n                            }\n                        ]);\n                }\n            ])\n            ->when(\n                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n            )\n            ->whereNotIn('estado_id', [3, 8])\n            ->when(\n                $request->filled('prueba_id'),\n                fn($consulta) => $consulta->whereHas(\n                    'pruebas',\n                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n                )\n            )\n            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n            })\n            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta_plan_por->whereNotNull('unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n                        break;\n                }\n            })\n            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_vencimiento;\n                $fecha_fin    = $request->fecha_vencimiento;\n\n                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_inicio;\n                $fecha_fin    = $request->fecha_inicio;\n\n                if (strpos($request->fecha_inicio, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_inicio);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when(\n                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n            )\n            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n                if ($request->tipo_activacion === 'compra') {\n                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                } elseif ($request->tipo_activacion === 'recompra') {\n                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                }\n            })\n            ->get();\n    }\n\n    /**\n     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     */\n    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n        return $this->modelo::select(\n            'empresas_planes.id',\n            'empresas_planes.empresa_id',\n            'empresas_planes.plan_id',\n            'empresas_planes.plan_credito_id',\n            'empresas_planes.usuario_id',\n            'empresas_planes.estado_id',\n            'empresas_planes.unidades',\n            'empresas_planes.cantidad_ofertas_laborales',\n            'empresas_planes.cantidad_usuarios',\n            'empresas_planes.cantidad_pruebas',\n            'empresas_planes.creditos',\n            'empresas_planes.fecha_inicio',\n            'empresas_planes.fecha_vencimiento',\n            'empresas_planes.precio',\n            'empresas_planes.porcentaje_descuento',\n            'empresas_planes.numero_factura',\n            'empresas_planes.comentario',\n            'empresas_planes.plan_original',\n            'empresas_planes.renovando',\n            'empresas_planes.por_facturar',\n            'empresas_planes.created_at',\n            'planes.id',\n            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n            'planes.nombre AS plan_nombre',\n            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n            'planes.unidades AS plan_unidades',\n            'planes.vigencia AS plan_vigencia',\n            'planes.precio AS plan_precio',\n            'tipos_pruebas.id AS tipo_prueba_id',\n            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n            'estados_planes.id AS estado_plan_id',\n            'estados_planes.nombre AS estado_plan_nombre',\n            'users.id AS usuario_usuario_id',\n            'users.nombres AS usuario_nombres',\n            'users.apellidos AS usuario_apellidos',\n            'empresas.id AS empresa_empresa_id',\n            'empresas.empresa_id',\n            'empresas.nombre_comercial AS empresa_nombre_comercial',\n            'empresas.razon_social AS empresa_razon_social',\n            'empresas.nombre_contacto',\n            'empresas.celular_contacto',\n            'empresas.email_contacto',\n            'empresas.telefono_contacto',\n            'empresas.extension_contacto',\n            'empresas.nombre_tesorero',\n            'empresas.celular_tesorero',\n            'empresas.telefono_tesorero',\n            'empresas.email_tesorero',\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n                )\n                AS conteo_consumos_agendas\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n                )\n                AS conteo_consumos_ofertas_laborales\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM empresas\n                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n                )\n                AS conteo_sucursales\n            '),\n            DB::raw('\n                (\n                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n                    FROM empresas AS sucursales\n                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n                )\n                AS nombres_comerciales_sucursales\n            ')\n        )\n        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n        ->whereNull('empresas.empresa_id')\n        ->when(\n            $request->filled('plan_por'),\n            function ($consulta) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta->whereNotNull('empresas_planes.unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n                        break;\n                }\n            }\n        )\n        ->when(\n            $request->filled('tipo_prueba_id'),\n            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n                TipoPrueba::SELECCION_ID,\n                TipoPrueba::ORGANIZACIONAL_ID,\n                TipoPrueba::VOCACIONAL_ID\n            ])\n        )\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n        ->when(\n            $request->filled('ejecutivo_id'),\n            function ($consulta) use ($request) {\n                $consulta->whereExists(function ($subconsulta) use ($request) {\n                    $subconsulta->select(DB::raw(1))\n                        ->from('empresas_usuarios')\n                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n                });\n            }\n        )\n        ->when(\n            $request->filled('fecha_vencimiento'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n        )\n        ->when(\n            $request->filled('fecha_inicio'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n        )\n        ->when(\n            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n        )\n        ->get();\n    }\n\n    /**\n     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        return $this->modelo::select(\n            'id',\n            'empresa_id',\n            'plan_credito_id',\n            'estado_id',\n            'creditos',\n            'fecha_inicio',\n            'fecha_vencimiento',\n            'precio',\n            'porcentaje_descuento',\n            'numero_factura',\n            'comentario',\n            'created_at'\n        )\n        ->with([\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                    ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n}\n","numLines":969,"startLine":1,"totalLines":969}},"sourceToolAssistantUUID":"2c105692-19e4-4d7b-b095-1e193f25332d"}
{"parentUuid":"7b2c51dc-78e8-4e01-9a71-0a55c840eba0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SFk7ANJwzVHi5X4zGo2LSj","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Empresas;\n     4→\n     5→use Exception;\n     6→use Illuminate\\Support\\Str;\n     7→use App\\Traits\\ArchivoTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use Illuminate\\Http\\Response;\n    10→use App\\Models\\Empresas\\Empresa;\n    11→use App\\Http\\Services\\BaseService;\n    12→use Illuminate\\Support\\Collection;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Exports\\Empresas\\HistorialCambiosExport;\n    16→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    17→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    18→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    19→use App\\Http\\Repositories\\Planes\\ConsumoRepository;\n    20→use App\\Http\\Repositories\\Empresas\\SectorRepository;\n    21→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    22→use App\\Http\\Services\\Configuraciones\\ArchivoService;\n    23→use Symfony\\Component\\HttpFoundation\\StreamedResponse;\n    24→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    26→use Symfony\\Component\\HttpFoundation\\{BinaryFileResponse};\n    27→use App\\Http\\Repositories\\Configuraciones\\CiudadRepository;\n    28→use App\\Http\\Repositories\\Empresas\\TamanoEmpresaRepository;\n    29→use App\\Http\\Repositories\\Usuarios\\TipoDocumentoRepository;\n    30→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    31→use App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n    32→use App\\Http\\Repositories\\Politicas\\PoliticaAceptadaRepository;\n    33→use App\\Jobs\\Configuraciones\\CrearPlantillasPorDefectoEmpresaJob;\n    34→use App\\Http\\Repositories\\Configuraciones\\ConfiguracionRepository;\n    35→use App\\Http\\Repositories\\Configuraciones\\ConfiguracionModeloRepository;\n    36→\n    37→/**\n    38→ * @property EmpresaRepository $repositorio\n    39→ */\n    40→class EmpresaService extends BaseService\n    41→{\n    42→    use ArchivoTrait;\n    43→\n    44→    private $modelo = 'App\\Models\\Empresas\\Empresa';\n    45→\n    46→    /**\n    47→     * Constructor.\n    48→     *\n    49→     * @param EmpresaRepository $repositorio Repositorio de empresas.\n    50→     * @param ArchivoService $archivo_servicio Servicio de archivos.\n    51→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    52→     * @param PoliticaAceptadaRepository $politica_aceptada_repositorio Repositorio de políticas aceptadas.\n    53→     * @param CiudadRepository $ciudad_repositorio Repositorio de ciudades.\n    54→     * @param SectorRepository $sector_repositorio Repositorio de sectores.\n    55→     * @param TamanoEmpresaRepository $tamano_empresa_repositorio Repositorio de tamaños de empresas.\n    56→     * @param TipoDocumentoRepository $tipo_documento_repositorio Repositorio de tipos de documentos.\n    57→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    58→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n    59→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n    60→     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n    61→     * @param ConfiguracionRepository $configuracion_repositorio Repositorio de configuraciones.\n    62→     * @param ConfiguracionModeloRepository $configuracion_modelo_repositorio Repositorio de configuraciones de modelos.\n    63→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    64→     * @param ConsumoRepository $consumo_repositorio Repositorio de consumos.\n    65→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    66→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    67→     * @return void\n    68→     * @author Daniel Beltrán\n    69→     * @author Jair Carvajal\n    70→     */\n    71→    public function __construct(\n    72→        EmpresaRepository $repositorio,\n    73→        protected ArchivoService $archivo_servicio,\n    74→        protected UserRepository $usuario_repositorio,\n    75→        protected PoliticaAceptadaRepository $politica_aceptada_repositorio,\n    76→        protected CiudadRepository $ciudad_repositorio,\n    77→        protected SectorRepository $sector_repositorio,\n    78→        protected TamanoEmpresaRepository $tamano_empresa_repositorio,\n    79→        protected TipoDocumentoRepository $tipo_documento_repositorio,\n    80→        protected ArchivoRepository $archivo_repositorio,\n    81→        protected TipoPruebaRepository $tipo_prueba_repositorio,\n    82→        protected EmpresaPlanRepository $empresa_plan_repositorio,\n    83→        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n    84→        protected ConfiguracionRepository $configuracion_repositorio,\n    85→        protected ConfiguracionModeloRepository $configuracion_modelo_repositorio,\n    86→        protected EmpresaPlanService $empresa_plan_servicio,\n    87→        protected ConsumoRepository $consumo_repositorio,\n    88→        protected RolRepository $rol_repositorio,\n    89→        protected ServicioIARepository $servicio_ia_repositorio\n    90→    ) {\n    91→        parent::__construct($repositorio);\n    92→    }\n    93→\n    94→    /**\n    95→     * Obtener una empresa.\n    96→     *\n    97→     * @param int $id ID de la empresa.\n    98→     * @return Empresa|null\n    99→     * @author Daniel Beltrán\n   100→     * @author Andres Gonzalez\n   101→     * @author Jair Carvajal\n   102→     */\n   103→    public function getUno(int $id): ?Empresa {\n   104→        $empresa = $this->repositorio->getUnoBasico($id);\n   105→\n   106→        if (!is_null($empresa)) {\n   107→            $planes        = [];\n   108→            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   109→\n   110→            foreach ($tipos_pruebas as $tipo_prueba) {\n   111→                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n   112→                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n   113→\n   114→                if (!is_null($plan)) {\n   115→                    array_push($planes, $plan);\n   116→                }\n   117→            }\n   118→\n   119→            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n   120→                'empresa_id'         => $id,\n   121→                'con_relaciones'     => true,\n   122→                'validar_relaciones' => true,\n   123→                'en'                 => true,\n   124→                'campo'              => 'rol_id',\n   125→                'valores'            => [\n   126→                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n   127→                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n   128→                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n   129→                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n   130→                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n   131→                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   132→                    $this->rol_repositorio::ROL_EVALUADOR_ID\n   133→                ]\n   134→            ]));\n   135→\n   136→            $usuarios = $usuarios->map(function ($usuario) {\n   137→                $eliminar = false;\n   138→\n   139→                if (\n   140→                    !$usuario->usuario->tiene_agendas\n   141→                    && !$usuario->usuario->tiene_ofertas_laborales\n   142→                    && !$usuario->usuario->tiene_procesos\n   143→                    && !$usuario->usuario->tiene_procesos\n   144→                    && !$usuario->usuario->tiene_etapa_usuario\n   145→                ) {\n   146→                    $eliminar = true;\n   147→                }\n   148→\n   149→                $usuario->usuario->eliminar = $eliminar;\n   150→                return $usuario;\n   151→            });\n   152→\n   153→            $empresa->planes                         = $planes;\n   154→            $empresa->usuarios                       = $usuarios;\n   155→            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n   156→            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n   157→                'model_type' => $this->modelo,\n   158→                'modelo_id'  => $id\n   159→            ]));\n   160→            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n   161→        }\n   162→\n   163→        return $empresa;\n   164→    }\n   165→\n   166→    /**\n   167→     * Obtener todas las empresas.\n   168→     *\n   169→     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n   170→     *\n   171→     * @param Request $request Contenido de la petición.\n   172→     * @return Collection\n   173→     * @author Daniel Beltrán\n   174→     * @author Andres Gonzalez\n   175→     */\n   176→    public function getTodo(Request $request): Collection {\n   177→        $empresas      = $this->repositorio->getTodo($request);\n   178→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   179→        $coleccion     = [];\n   180→\n   181→        foreach ($empresas as $empresa) {\n   182→            $registro = $empresa;\n   183→\n   184→            foreach ($tipos_pruebas as $tipo_prueba) {\n   185→                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n   186→\n   187→                // Obtener el plan activo, si no tiene se obtiene el último plan asignado\n   188→                $registro[$llave] = $this->empresa_plan_repositorio->planActivo($empresa->id, $tipo_prueba->id);\n   189→\n   190→                if (is_null($registro[$llave])) {\n   191→                    $registro[$llave] = $this->empresa_plan_repositorio->ultimoPlanAsignado(new Request([\n   192→                        'empresa_id'             => $empresa->id,\n   193→                        'tipo_prueba_id'         => $tipo_prueba->id,\n   194→                        'excluir_estado_proximo' => true\n   195→                    ]));\n   196→                }\n   197→\n   198→                // Verificar si tiene un plan próximo adicional al plan actual\n   199→                if (!is_null($registro[$llave])) {\n   200→                    $plan_proximo                     = $this->empresa_plan_repositorio->planProximo($empresa->id, $tipo_prueba->id);\n   201→                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n   202→                }\n   203→            }\n   204→\n   205→            $plan_creditos = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n   206→\n   207→            if ($plan_creditos && !is_null($plan_creditos['plan_credito'])) {\n   208→                $registro['plan_creditos'] = $plan_creditos;\n   209→            } else {\n   210→                $registro['plan_creditos'] = null;\n   211→            }\n   212→\n   213→            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n   214→            array_push($coleccion, $registro);\n   215→        }\n   216→\n   217→        return collect($coleccion);\n   218→    }\n   219→\n   220→    /**\n   221→     * Obtener el porcentaje de creación.\n   222→     *\n   223→     * @param int $id ID de la empresa.\n   224→     * @return int\n   225→     * @author Daniel Beltrán\n   226→     */\n   227→    public function obtenerPorcentajeCreacion(int $id): int {\n   228→        $empresa    = $this->repositorio->getUno($id);\n   229→        $porcentaje = 0;\n   230→\n   231→        if (is_null($empresa)) {\n   232→            return $porcentaje;\n   233→        }\n   234→\n   235→        if (!is_null($empresa->empresa_id)) {\n   236→            return $porcentaje;\n   237→        }\n   238→\n   239→        $porcentaje += 10;\n   240→\n   241→        if (count($empresa->archivos) > 0) {\n   242→            $porcentaje += 20;\n   243→        }\n   244→\n   245→        if (count($empresa->usuarios) > 0) {\n   246→            $porcentaje += 10;\n   247→        }\n   248→\n   249→        if (count($empresa->planes) > 0) {\n   250→            $porcentaje += 30;\n   251→        }\n   252→\n   253→        if (count($empresa->usuarios) > 1) {\n   254→            $porcentaje += 30;\n   255→        }\n   256→\n   257→        return $porcentaje;\n   258→    }\n   259→\n   260→    /**\n   261→     * Guardar empresa.\n   262→     *\n   263→     * @param Request $request Contenido de la petición.\n   264→     * @throws Exception Cuando un usuario que no es superadministrador, intenta modificar una empresa diferente a la que está logueado.\n   265→     * @return Empresa\n   266→     * @author Daniel Beltrán\n   267→     */\n   268→    public function guardar(Request $request): Empresa {\n   269→        $campos_excluidos = ['_token', '_method', 'id', 'pais_id', 'departamento_id', 'digito_verificacion', 'extension', 'extension_tesorero', 'logo', 'empresa_plan_id'];\n   270→\n   271→        if ($request->filled('digito_verificacion')) {\n   272→            $request->merge(['documento' => $request->documento . '-' . $request->digito_verificacion]);\n   273→        }\n   274→\n   275→        if ($request->filled('telefono') && $request->filled('extension')) {\n   276→            $request->merge(['telefono' => $request->telefono . '-' . $request->extension]);\n   277→        }\n   278→\n   279→        if ($request->filled('telefono_tesorero') && $request->filled('extension_tesorero')) {\n   280→            $request->merge(['telefono_tesorero' => $request->telefono_tesorero . '-' . $request->extension_tesorero]);\n   281→        }\n   282→\n   283→        // Agregar datos a la sucursal\n   284→        if ($request->filled('empresa_id')) {\n   285→            $empresa_principal = $this->repositorio->getUno($request->empresa_id);\n   286→\n   287→            if (!is_null($empresa_principal->empresa_id)) {\n   288→                throw new Exception('No se puede crearse una sucursal de otra sucursal');\n   289→            }\n   290→\n   291→            $request->merge([\n   292→                'tamano_empresa_id' => $empresa_principal->tamano_empresa_id,\n   293→                'razon_social'      => $empresa_principal->razon_social\n   294→            ]);\n   295→\n   296→            unset($empresa_principal);\n   297→        }\n   298→\n   299→        if ($request->filled('id')) {\n   300→            $rol_usuario = $this->rol_repositorio->usuarioRolActivo(Auth::id());\n   301→\n   302→            // Validar que solo el superadministrador pueda editar cualquier empresa\n   303→            if ($rol_usuario->id != RolRepository::ROL_SUPERADMIN_ID) {\n   304→                $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   305→\n   306→                if ($empresa_usuario->id != $request->empresa_id) {\n   307→                    throw new Exception('No puedes editar una empresa diferente a la que estás logueado', Response::HTTP_FORBIDDEN);\n   308→                }\n   309→            }\n   310→\n   311→            $empresa = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n   312→        } else {\n   313→            $empresa = $this->repositorio->crear($request->except($campos_excluidos));\n   314→            CrearPlantillasPorDefectoEmpresaJob::dispatch($empresa->id);\n   315→        }\n   316→\n   317→        // Renovación el plan\n   318→        if ($request->filled('empresa_plan_id')) {\n   319→            $this->empresa_plan_servicio->renovar($request->empresa_plan_id);\n   320→        }\n   321→\n   322→        // Guardar el logo de la sucursal\n   323→        if ($request->filled('empresa_id') && $request->filled('logo')) {\n   324→            $this->cambiarLogo($empresa->id, $request->logo);\n   325→        }\n   326→\n   327→        return $empresa;\n   328→    }\n   329→\n   330→    /**\n   331→     * Guardar archivos de la empresa.\n   332→     *\n   333→     * @param int $id ID de la empresa.\n   334→     * @param Request $request Contenido de la petición.\n   335→     * @return void\n   336→     * @author Daniel Beltrán\n   337→     * @author Fahibram Cárcamo\n   338→     */\n   339→    public function guardarArchivos(int $id, Request $request): void {\n   340→        if ($request->filled('logo')) {\n   341→            $this->cambiarLogo($id, $request->logo);\n   342→        }\n   343→\n   344→        foreach ($request->files->all() as $nombre_archivo_empresa => $archivo_empresa) {\n   345→            $archivo_existente = $this->archivo_repositorio->getUnoAvanzado(new Request([\n   346→                'modelo'    => $this->modelo,\n   347→                'modelo_id' => $id,\n   348→                'nombre'    => $nombre_archivo_empresa\n   349→            ]));\n   350→\n   351→            if (!is_null($archivo_existente)) {\n   352→                $this->archivo_servicio->eliminarPorModelo($this->modelo, $id, $nombre_archivo_empresa);\n   353→            }\n   354→\n   355→            $ruta = \"private/archivos/empresas/{$id}\";\n   356→            $this->generarDirectorios(\"app/{$ruta}\");\n   357→\n   358→            $nombre_archivo = $this->generarNombreArchivo($archivo_empresa);\n   359→            $this->guardarArchivoEnRuta($archivo_empresa, $ruta, $nombre_archivo);\n   360→\n   361→            $this->archivo_repositorio->crear([\n   362→                'modelo'                  => $this->modelo,\n   363→                'modelo_id'               => $id,\n   364→                'nombre'                  => $nombre_archivo_empresa,\n   365→                'nombre_original_archivo' => $nombre_archivo,\n   366→                'ruta'                    => $ruta . '/' . $nombre_archivo\n   367→            ]);\n   368→        }\n   369→    }\n   370→\n   371→    /**\n   372→     * Eliminar empresa.\n   373→     *\n   374→     * @param int $id ID de la empresa.\n   375→     * @throws Exception Cuando la empresa tiene algún registro asociado o está archivada.\n   376→     * @return void\n   377→     * @author Daniel Beltrán\n   378→     * @author Fahibram Cárcamo\n   379→     */\n   380→    public function eliminar(int $id): void {\n   381→        $empresa = $this->repositorio->getUnoAvanzado(new Request([\n   382→            'id'                       => $id,\n   383→            'contar_sucursales'        => true,\n   384→            'contar_planes'            => true,\n   385→            'contar_procesos'          => true,\n   386→            'contar_areas'             => true,\n   387→            'contar_perfiles'          => true,\n   388→            'contar_agendas'           => true,\n   389→            'contar_encuestas'         => true,\n   390→            'contar_soportes'          => true,\n   391→            'contar_usuarios'          => true,\n   392→            'contar_ordenes_servicios' => true,\n   393→            'contar_ofertas_laborales' => true,\n   394→            'contar_portales_empleos'  => true\n   395→        ]));\n   396→\n   397→        if ($empresa->activo) {\n   398→            // Validar que no tenga planes\n   399→            if ($empresa->planes_count > 0) {\n   400→                throw new Exception('La empresa tiene planes asignados');\n   401→            }\n   402→\n   403→            // Validar que no tenga sucursales\n   404→            if ($empresa->sucursales_count > 0) {\n   405→                throw new Exception('La empresa tiene sucursales asignadas');\n   406→            }\n   407→\n   408→            // Validar que no tenga procesos\n   409→            if ($empresa->procesos_count > 0) {\n   410→                throw new Exception('La empresa tiene procesos asignados');\n   411→            }\n   412→\n   413→            // Validar que no tenga áreas\n   414→            if ($empresa->areas_count > 0) {\n   415→                throw new Exception('La empresa tiene áreas asignadas');\n   416→            }\n   417→\n   418→            // Validar que no tenga perfiles\n   419→            if ($empresa->perfiles_count > 0) {\n   420→                throw new Exception('La empresa tiene perfiles asignados');\n   421→            }\n   422→\n   423→            // Validar que no tenga agendas\n   424→            if ($empresa->agendas_count > 0) {\n   425→                throw new Exception('La empresa tiene agendas asignadas');\n   426→            }\n   427→\n   428→            // Validar que no tenga encuestas\n   429→            if ($empresa->encuestas_count > 0) {\n   430→                throw new Exception('La empresa tiene encuestas asignadas');\n   431→            }\n   432→\n   433→            // Validar que no tenga soportes\n   434→            if ($empresa->soportes_count > 0) {\n   435→                throw new Exception('La empresa tiene soportes asignados');\n   436→            }\n   437→\n   438→            // Validar que no tenga usuarios\n   439→            if ($empresa->usuarios_count > 0) {\n   440→                throw new Exception('La empresa tiene usuarios asignados');\n   441→            }\n   442→\n   443→            // Validar que no tenga ordenes de servicio\n   444→            if ($empresa->ordenes_servicios_count > 0) {\n   445→                throw new Exception('La empresa tiene ordenes de servicio asignadas');\n   446→            }\n   447→\n   448→            // Validar que no tenga ofertas laborales\n   449→            if ($empresa->ofertas_laborales_count > 0) {\n   450→                throw new Exception('La empresa tiene ofertas laborales asignadas');\n   451→            }\n   452→\n   453→            // Validar que no tenga portales de empleo\n   454→            if ($empresa->portal_empleo_count > 0) {\n   455→                throw new Exception('La empresa tiene portales de empleo asignados');\n   456→            }\n   457→\n   458→            $this->repositorio->sincronizarConfiguraciones($empresa, []);\n   459→            $this->repositorio->eliminar($id);\n   460→        } else {\n   461→            throw new Exception('La empresa está archivada');\n   462→        }\n   463→    }\n   464→\n   465→    /**\n   466→     * Eliminar los usuarios de la empresa junto con sus políticas aceptadas.\n   467→     *\n   468→     * @param Empresa $empresa Empresa.\n   469→     * @param Collection $usuarios Usuarios.\n   470→     * @return void\n   471→     * @author Daniel Beltrán\n   472→     */\n   473→    public function eliminarUsuarios(Empresa $empresa, Collection $usuarios): void {\n   474→        if (count($usuarios) > 0) {\n   475→            foreach ($usuarios as $usuario_empresa) {\n   476→                // Disociar el usuario de la empresa\n   477→                $this->repositorio->disociarUsuario($empresa, $usuario_empresa->id);\n   478→\n   479→                // Disociar las políticas aceptadas del usuario para la empresa\n   480→                $this->politica_aceptada_repositorio->eliminarPorUsuarioYEmpresa($usuario_empresa->id, $empresa->id);\n   481→\n   482→                // Obtener todas las políticas aceptadas del usuario en otras empresas\n   483→                $politicas_otras_empresas = $this->politica_aceptada_repositorio->obtenerPorUsuarioYEmpresasDiferentes($usuario_empresa->id, [$empresa->id]);\n   484→\n   485→                // Obtener los datos del usuario\n   486→                $usuario = $this->usuario_repositorio->getUno($usuario_empresa->id);\n   487→\n   488→                // Validar si el usuario tiene más empresas asociadas y más políticas aceptadas de otras empresas\n   489→                if (count($usuario->empresas) == 0 && count($politicas_otras_empresas) == 0) {\n   490→                    $this->usuario_repositorio->eliminar($usuario_empresa->id);\n   491→                }\n   492→            }\n   493→        }\n   494→    }\n   495→\n   496→    /**\n   497→     * Obtener el historial de cambios.\n   498→     *\n   499→     * @param int $id ID de la empresa.\n   500→     * @return Collection\n   501→     * @author Daniel Beltrán\n   502→     */\n   503→    public function historialCambios(int $id): Collection {\n   504→        $historial       = $this->repositorio->historialCambios($id);\n   505→        $historial_final = [];\n   506→\n   507→        // Obtener los datos referenciados a través de llaves foráneas\n   508→        $ciudades         = $this->obtenerDatosReferenciados($historial, 'ciudad_id', 'ciudades_ids', $this->ciudad_repositorio);\n   509→        $ejecutivos       = $this->obtenerDatosReferenciados($historial, 'ejecutivo_id', 'usuarios_ids', $this->usuario_repositorio);\n   510→        $sectores         = $this->obtenerDatosReferenciados($historial, 'sector_id', 'sectores_ids', $this->sector_repositorio);\n   511→        $tamanos_empresas = $this->obtenerDatosReferenciados($historial, 'tamano_empresa_id', 'tamanos_empresas_ids', $this->tamano_empresa_repositorio);\n   512→        $tipos_documentos = $this->obtenerDatosReferenciados($historial, 'tipo_documento_representante_id', 'tipos_documentos_ids', $this->tipo_documento_repositorio);\n   513→\n   514→        foreach ($historial as $item) {\n   515→            array_push($historial_final, [\n   516→                'id'             => $item->id,\n   517→                'user_type'      => $item->user_type,\n   518→                'user_id'        => $item->user_id,\n   519→                'event'          => $item->event,\n   520→                'auditable_type' => $item->auditable_type,\n   521→                'auditable_id'   => $item->auditable_id,\n   522→                'created_at'     => $item->created_at,\n   523→                'user'           => $item->user,\n   524→                'old_values'     => $this->asignarCambiosHistorial($item->old_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos),\n   525→                'new_values'     => $this->asignarCambiosHistorial($item->new_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos)\n   526→            ]);\n   527→        }\n   528→\n   529→        return collect($historial_final);\n   530→    }\n   531→\n   532→    /**\n   533→     * Asignar los cambios del historial.\n   534→     *\n   535→     * @param array $valores Valores del historial (pueden ser antigüos o nuevos).\n   536→     * @param Collection $ciudades Ciudades.\n   537→     * @param Collection $ejecutivos Ejecutivos.\n   538→     * @param Collection $sectores Sectores.\n   539→     * @param Collection $tamanos_empresas Tamaños de empresas.\n   540→     * @param Collection $tipos_documentos Tipos de documentos.\n   541→     * @return array\n   542→     * @author Daniel Beltrán\n   543→     */\n   544→    private function asignarCambiosHistorial(\n   545→        array $valores,\n   546→        Collection $ciudades,\n   547→        Collection $ejecutivos,\n   548→        Collection $sectores,\n   549→        Collection $tamanos_empresas,\n   550→        Collection $tipos_documentos\n   551→    ): array {\n   552→        $valores_actualizados = [];\n   553→\n   554→        foreach ($valores as $llave => $valor) {\n   555→            $valores_actualizados[$llave] = $valor;\n   556→\n   557→            if ($llave === 'ciudad_id') {\n   558→                $ciudad                       = $ciudades->firstWhere('id', $valor);\n   559→                $valores_actualizados[$llave] = $ciudad->nombre . ', ' . $ciudad->departamento->nombre . ' - ' . $ciudad->departamento->pais->nombre;\n   560→            }\n   561→\n   562→            if ($llave === 'ejecutivo_id') {\n   563→                $valores_actualizados[$llave] = !is_null($valor) ? $ejecutivos->firstWhere('id', $valor)->nombre_completo : null;\n   564→            }\n   565→\n   566→            if ($llave === 'sector_id') {\n   567→                $valores_actualizados[$llave] = $sectores->firstWhere('id', $valor)->nombre;\n   568→            }\n   569→\n   570→            if ($llave === 'tamano_empresa_id') {\n   571→                $valores_actualizados[$llave] = $tamanos_empresas->firstWhere('id', $valor)->nombre;\n   572→            }\n   573→\n   574→            if ($llave === 'tipo_documento_representante_id') {\n   575→                $valores_actualizados[$llave] = !is_null($valor) ? $tipos_documentos->firstWhere('id', $valor)->nombre : null;\n   576→            }\n   577→        }\n   578→\n   579→        return $valores_actualizados;\n   580→    }\n   581→\n   582→    /**\n   583→     * Obtener el logo de la empresa.\n   584→     *\n   585→     * @param int $id ID de la empresa.\n   586→     * @throws Exception Cuando la empresa no tiene ningún logo.\n   587→     * @return BinaryFileResponse|StreamedResponse\n   588→     * @author Daniel Beltrán\n   589→     */\n   590→    public function getLogo(int $id): BinaryFileResponse|StreamedResponse {\n   591→        $logo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n   592→        abort_if(is_null($logo), 404, 'Esta empresa no tiene ningún logo');\n   593→        return $this->obtenerArchivoDesdeRuta($logo->ruta);\n   594→    }\n   595→\n   596→    /**\n   597→     * Cambiar el logo de la empresa.\n   598→     *\n   599→     * Elimina el logo actual y guarda el nuevo.\n   600→     *\n   601→     * @param int $id ID de la empresa.\n   602→     * @param string $logo Nuevo logo en base64.\n   603→     * @return void\n   604→     * @author Daniel Beltrán\n   605→     */\n   606→    public function cambiarLogo(int $id, string $logo): void {\n   607→        $archivo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n   608→\n   609→        if (!is_null($archivo)) {\n   610→            $this->archivo_servicio->eliminar($archivo->id);\n   611→        }\n   612→\n   613→        $this->archivo_servicio->guardarVariosBase64($this->modelo, $id, ['logo' => $logo], 'empresas');\n   614→    }\n   615→\n   616→    /**\n   617→     * Exportar Excel del historial de cambios.\n   618→     *\n   619→     * @param int $id ID de la empresa.\n   620→     * @return BinaryFileResponse|Response\n   621→     * @author Daniel Beltrán\n   622→     */\n   623→    public function exportarExcelHistorialCambios(int $id): BinaryFileResponse|Response {\n   624→        $datos = [\n   625→            'historial_cambios' => $this->historialCambios($id),\n   626→            'archivos'          => $this->archivo_repositorio->getTodo(new Request([\n   627→                'modelo'    => $this->modelo,\n   628→                'modelo_id' => $id\n   629→            ]))\n   630→        ];\n   631→\n   632→        return Excel::download(new HistorialCambiosExport($datos), 'historial-cambios.xlsx');\n   633→    }\n   634→\n   635→    /**\n   636→     * Obtiene el conteo dependiendo de id de empresas planes.\n   637→     *\n   638→     * @param int $empresa_plan_id Id de empresas planes.\n   639→     * @param Request $request Contenido de la petición.\n   640→     * @return int\n   641→     * @author Andres Gonzalez\n   642→     * @author Fahibram Cárcamo\n   643→     */\n   644→    public function conteoConsumo(int $empresa_plan_id, Request $request): int {\n   645→        return $this->consumo_repositorio->getTodo(\n   646→            new Request([\n   647→                'empresa_plan_id' => $empresa_plan_id,\n   648→                'fecha_inicio'    => $request->fecha_inicio,\n   649→                'fecha_fin'       => $request->fecha_fin\n   650→            ])\n   651→        )\n   652→        ->count();\n   653→    }\n   654→\n   655→    /**\n   656→     * Obtiene el resumen para el panel.\n   657→     *\n   658→     * @param Request $request Contenido de la petición.\n   659→     * @return array\n   660→     * @author Andres Gonzalez\n   661→     */\n   662→    public function obtenerResumen(Request $request): array {\n   663→        $resumen = $this->repositorio->obtenerResumen($request);\n   664→        $alto    = 0;\n   665→        $normal  = 0;\n   666→        $bajo    = 0;\n   667→\n   668→        $ejecutivos_procesados = [];\n   669→        $planes                = [];\n   670→        $total_precio          = 0;\n   671→        $empresas_asignadas    = 0;\n   672→        $planes_agrupados      = [];\n   673→\n   674→        foreach ($resumen['empresasPlanes'] as $empresa_plan) {\n   675→            $consumo = $this->conteoConsumo($empresa_plan->id, $request);\n   676→\n   677→            if ($consumo > $empresa_plan->unidades) {\n   678→                $alto++;\n   679→            } elseif ($consumo == $empresa_plan->unidades) {\n   680→                $normal++;\n   681→            } else {\n   682→                $bajo++;\n   683→            }\n   684→        }\n   685→\n   686→        $resumen['consumo'] = [\n   687→            'alto'   => $alto,\n   688→            'normal' => $normal,\n   689→            'bajo'   => $bajo,\n   690→        ];\n   691→\n   692→        // Top ejecutivos\n   693→        foreach ($resumen['empresa_ejecutivo'] as $ejecutivo) {\n   694→            $empresas = $this->repositorio->getTodoAgrupadoPlan(new Request([\n   695→                'ejecutivo_id' => $ejecutivo->ejecutivo_id,\n   696→                'fecha_inicio' => $request->fecha_inicio,\n   697→                'fecha_fin'    => $request->fecha_fin,\n   698→            ]));\n   699→\n   700→            foreach ($empresas as $empresa) {\n   701→                foreach ($empresa['empresas_planes'] as $plan) {\n   702→                    $empresas_asignadas++;\n   703→                    $total_precio += $plan['precio'];\n   704→\n   705→                    // Saltar la empresa plan que no tiene un plan asignado por ende es de crédito y de momento no se tiene en cuenta.\n   706→                    if ($plan['plan'] == null) {\n   707→                        continue;\n   708→                    }\n   709→\n   710→                    $planes[] = [\n   711→                        'id'          => $plan['plan']['id'],\n   712→                        'nombre'      => $plan['plan']['nombre'],\n   713→                        'descripcion' => $plan['plan']['descripcion'],\n   714→                        'precio'      => $plan['precio'],\n   715→                        'conteo'      => null\n   716→                    ];\n   717→                }\n   718→            }\n   719→\n   720→            // Agrupa los planes por el id y suma su precio y conteo.\n   721→            foreach ($planes as $plan) {\n   722→                $plan_id = $plan['id'];\n   723→\n   724→                if (!isset($planes_agrupados[$plan_id])) {\n   725→                    $planes_agrupados[$plan_id]           = $plan;\n   726→                    $planes_agrupados[$plan_id]['conteo'] = 1;\n   727→                } else {\n   728→                    $planes_agrupados[$plan_id]['precio'] += $plan['precio'];\n   729→                    $planes_agrupados[$plan_id]['conteo'] += 1;\n   730→                }\n   731→            }\n   732→\n   733→            $planes = array_values($planes_agrupados);\n   734→\n   735→            // Ordena de mayor a menor precio.\n   736→            usort($planes, function ($primero, $segundo) {\n   737→                return $segundo['precio'] <=> $primero['precio'];\n   738→            });\n   739→\n   740→            if ($total_precio > 0) {\n   741→                $ejecutivos_procesados[] = [\n   742→                    'id_ejecutivo'       => $ejecutivo->ejecutivo_id,\n   743→                    'nombre'             => $ejecutivo->ejecutivo->nombre_completo,\n   744→                    'ventas_totales'     => $total_precio,\n   745→                    'empresas_asignadas' => $empresas_asignadas,\n   746→                    'planes'             => $planes,\n   747→                ];\n   748→            }\n   749→\n   750→            // Reiniciar variables.\n   751→            $empresas_asignadas = 0;\n   752→            $total_precio       = 0;\n   753→            $planes             = [];\n   754→            $planes_agrupados   = [];\n   755→        }\n   756→\n   757→        // Ordena de mayor a menor de ventas_totales.\n   758→        usort($ejecutivos_procesados, function ($primero, $segundo) {\n   759→            return $segundo['ventas_totales'] <=> $primero['ventas_totales'];\n   760→        });\n   761→\n   762→        $resumen['ejecutivos'] = $ejecutivos_procesados;\n   763→\n   764→        unset($resumen['empresasPlanes'], $resumen['empresa_ejecutivo']);\n   765→\n   766→        return $resumen;\n   767→    }\n   768→}\n   769→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5bd544f3-2697-4e18-b977-cb6213b1d7ee","timestamp":"2026-01-25T01:55:23.134Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Illuminate\\Support\\Str;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\Response;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse App\\Exports\\Empresas\\HistorialCambiosExport;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\IA\\ServicioIARepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Planes\\ConsumoRepository;\nuse App\\Http\\Repositories\\Empresas\\SectorRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse Symfony\\Component\\HttpFoundation\\StreamedResponse;\nuse App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse Symfony\\Component\\HttpFoundation\\{BinaryFileResponse};\nuse App\\Http\\Repositories\\Configuraciones\\CiudadRepository;\nuse App\\Http\\Repositories\\Empresas\\TamanoEmpresaRepository;\nuse App\\Http\\Repositories\\Usuarios\\TipoDocumentoRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Politicas\\PoliticaAceptadaRepository;\nuse App\\Jobs\\Configuraciones\\CrearPlantillasPorDefectoEmpresaJob;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionModeloRepository;\n\n/**\n * @property EmpresaRepository $repositorio\n */\nclass EmpresaService extends BaseService\n{\n    use ArchivoTrait;\n\n    private $modelo = 'App\\Models\\Empresas\\Empresa';\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaRepository $repositorio Repositorio de empresas.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param PoliticaAceptadaRepository $politica_aceptada_repositorio Repositorio de políticas aceptadas.\n     * @param CiudadRepository $ciudad_repositorio Repositorio de ciudades.\n     * @param SectorRepository $sector_repositorio Repositorio de sectores.\n     * @param TamanoEmpresaRepository $tamano_empresa_repositorio Repositorio de tamaños de empresas.\n     * @param TipoDocumentoRepository $tipo_documento_repositorio Repositorio de tipos de documentos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param ConfiguracionRepository $configuracion_repositorio Repositorio de configuraciones.\n     * @param ConfiguracionModeloRepository $configuracion_modelo_repositorio Repositorio de configuraciones de modelos.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @param ConsumoRepository $consumo_repositorio Repositorio de consumos.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function __construct(\n        EmpresaRepository $repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected PoliticaAceptadaRepository $politica_aceptada_repositorio,\n        protected CiudadRepository $ciudad_repositorio,\n        protected SectorRepository $sector_repositorio,\n        protected TamanoEmpresaRepository $tamano_empresa_repositorio,\n        protected TipoDocumentoRepository $tipo_documento_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected TipoPruebaRepository $tipo_prueba_repositorio,\n        protected EmpresaPlanRepository $empresa_plan_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected ConfiguracionRepository $configuracion_repositorio,\n        protected ConfiguracionModeloRepository $configuracion_modelo_repositorio,\n        protected EmpresaPlanService $empresa_plan_servicio,\n        protected ConsumoRepository $consumo_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected ServicioIARepository $servicio_ia_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Obtener una empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @return Empresa|null\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?Empresa {\n        $empresa = $this->repositorio->getUnoBasico($id);\n\n        if (!is_null($empresa)) {\n            $planes        = [];\n            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n                'empresa_id'         => $id,\n                'con_relaciones'     => true,\n                'validar_relaciones' => true,\n                'en'                 => true,\n                'campo'              => 'rol_id',\n                'valores'            => [\n                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n                    $this->rol_repositorio::ROL_EVALUADOR_ID\n                ]\n            ]));\n\n            $usuarios = $usuarios->map(function ($usuario) {\n                $eliminar = false;\n\n                if (\n                    !$usuario->usuario->tiene_agendas\n                    && !$usuario->usuario->tiene_ofertas_laborales\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_etapa_usuario\n                ) {\n                    $eliminar = true;\n                }\n\n                $usuario->usuario->eliminar = $eliminar;\n                return $usuario;\n            });\n\n            $empresa->planes                         = $planes;\n            $empresa->usuarios                       = $usuarios;\n            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n                'model_type' => $this->modelo,\n                'modelo_id'  => $id\n            ]));\n            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Obtener todas las empresas.\n     *\n     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function getTodo(Request $request): Collection {\n        $empresas      = $this->repositorio->getTodo($request);\n        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n        $coleccion     = [];\n\n        foreach ($empresas as $empresa) {\n            $registro = $empresa;\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n\n                // Obtener el plan activo, si no tiene se obtiene el último plan asignado\n                $registro[$llave] = $this->empresa_plan_repositorio->planActivo($empresa->id, $tipo_prueba->id);\n\n                if (is_null($registro[$llave])) {\n                    $registro[$llave] = $this->empresa_plan_repositorio->ultimoPlanAsignado(new Request([\n                        'empresa_id'             => $empresa->id,\n                        'tipo_prueba_id'         => $tipo_prueba->id,\n                        'excluir_estado_proximo' => true\n                    ]));\n                }\n\n                // Verificar si tiene un plan próximo adicional al plan actual\n                if (!is_null($registro[$llave])) {\n                    $plan_proximo                     = $this->empresa_plan_repositorio->planProximo($empresa->id, $tipo_prueba->id);\n                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n                }\n            }\n\n            $plan_creditos = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n\n            if ($plan_creditos && !is_null($plan_creditos['plan_credito'])) {\n                $registro['plan_creditos'] = $plan_creditos;\n            } else {\n                $registro['plan_creditos'] = null;\n            }\n\n            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n            array_push($coleccion, $registro);\n        }\n\n        return collect($coleccion);\n    }\n\n    /**\n     * Obtener el porcentaje de creación.\n     *\n     * @param int $id ID de la empresa.\n     * @return int\n     * @author Daniel Beltrán\n     */\n    public function obtenerPorcentajeCreacion(int $id): int {\n        $empresa    = $this->repositorio->getUno($id);\n        $porcentaje = 0;\n\n        if (is_null($empresa)) {\n            return $porcentaje;\n        }\n\n        if (!is_null($empresa->empresa_id)) {\n            return $porcentaje;\n        }\n\n        $porcentaje += 10;\n\n        if (count($empresa->archivos) > 0) {\n            $porcentaje += 20;\n        }\n\n        if (count($empresa->usuarios) > 0) {\n            $porcentaje += 10;\n        }\n\n        if (count($empresa->planes) > 0) {\n            $porcentaje += 30;\n        }\n\n        if (count($empresa->usuarios) > 1) {\n            $porcentaje += 30;\n        }\n\n        return $porcentaje;\n    }\n\n    /**\n     * Guardar empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @throws Exception Cuando un usuario que no es superadministrador, intenta modificar una empresa diferente a la que está logueado.\n     * @return Empresa\n     * @author Daniel Beltrán\n     */\n    public function guardar(Request $request): Empresa {\n        $campos_excluidos = ['_token', '_method', 'id', 'pais_id', 'departamento_id', 'digito_verificacion', 'extension', 'extension_tesorero', 'logo', 'empresa_plan_id'];\n\n        if ($request->filled('digito_verificacion')) {\n            $request->merge(['documento' => $request->documento . '-' . $request->digito_verificacion]);\n        }\n\n        if ($request->filled('telefono') && $request->filled('extension')) {\n            $request->merge(['telefono' => $request->telefono . '-' . $request->extension]);\n        }\n\n        if ($request->filled('telefono_tesorero') && $request->filled('extension_tesorero')) {\n            $request->merge(['telefono_tesorero' => $request->telefono_tesorero . '-' . $request->extension_tesorero]);\n        }\n\n        // Agregar datos a la sucursal\n        if ($request->filled('empresa_id')) {\n            $empresa_principal = $this->repositorio->getUno($request->empresa_id);\n\n            if (!is_null($empresa_principal->empresa_id)) {\n                throw new Exception('No se puede crearse una sucursal de otra sucursal');\n            }\n\n            $request->merge([\n                'tamano_empresa_id' => $empresa_principal->tamano_empresa_id,\n                'razon_social'      => $empresa_principal->razon_social\n            ]);\n\n            unset($empresa_principal);\n        }\n\n        if ($request->filled('id')) {\n            $rol_usuario = $this->rol_repositorio->usuarioRolActivo(Auth::id());\n\n            // Validar que solo el superadministrador pueda editar cualquier empresa\n            if ($rol_usuario->id != RolRepository::ROL_SUPERADMIN_ID) {\n                $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n                if ($empresa_usuario->id != $request->empresa_id) {\n                    throw new Exception('No puedes editar una empresa diferente a la que estás logueado', Response::HTTP_FORBIDDEN);\n                }\n            }\n\n            $empresa = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $empresa = $this->repositorio->crear($request->except($campos_excluidos));\n            CrearPlantillasPorDefectoEmpresaJob::dispatch($empresa->id);\n        }\n\n        // Renovación el plan\n        if ($request->filled('empresa_plan_id')) {\n            $this->empresa_plan_servicio->renovar($request->empresa_plan_id);\n        }\n\n        // Guardar el logo de la sucursal\n        if ($request->filled('empresa_id') && $request->filled('logo')) {\n            $this->cambiarLogo($empresa->id, $request->logo);\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Guardar archivos de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function guardarArchivos(int $id, Request $request): void {\n        if ($request->filled('logo')) {\n            $this->cambiarLogo($id, $request->logo);\n        }\n\n        foreach ($request->files->all() as $nombre_archivo_empresa => $archivo_empresa) {\n            $archivo_existente = $this->archivo_repositorio->getUnoAvanzado(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id,\n                'nombre'    => $nombre_archivo_empresa\n            ]));\n\n            if (!is_null($archivo_existente)) {\n                $this->archivo_servicio->eliminarPorModelo($this->modelo, $id, $nombre_archivo_empresa);\n            }\n\n            $ruta = \"private/archivos/empresas/{$id}\";\n            $this->generarDirectorios(\"app/{$ruta}\");\n\n            $nombre_archivo = $this->generarNombreArchivo($archivo_empresa);\n            $this->guardarArchivoEnRuta($archivo_empresa, $ruta, $nombre_archivo);\n\n            $this->archivo_repositorio->crear([\n                'modelo'                  => $this->modelo,\n                'modelo_id'               => $id,\n                'nombre'                  => $nombre_archivo_empresa,\n                'nombre_original_archivo' => $nombre_archivo,\n                'ruta'                    => $ruta . '/' . $nombre_archivo\n            ]);\n        }\n    }\n\n    /**\n     * Eliminar empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa tiene algún registro asociado o está archivada.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function eliminar(int $id): void {\n        $empresa = $this->repositorio->getUnoAvanzado(new Request([\n            'id'                       => $id,\n            'contar_sucursales'        => true,\n            'contar_planes'            => true,\n            'contar_procesos'          => true,\n            'contar_areas'             => true,\n            'contar_perfiles'          => true,\n            'contar_agendas'           => true,\n            'contar_encuestas'         => true,\n            'contar_soportes'          => true,\n            'contar_usuarios'          => true,\n            'contar_ordenes_servicios' => true,\n            'contar_ofertas_laborales' => true,\n            'contar_portales_empleos'  => true\n        ]));\n\n        if ($empresa->activo) {\n            // Validar que no tenga planes\n            if ($empresa->planes_count > 0) {\n                throw new Exception('La empresa tiene planes asignados');\n            }\n\n            // Validar que no tenga sucursales\n            if ($empresa->sucursales_count > 0) {\n                throw new Exception('La empresa tiene sucursales asignadas');\n            }\n\n            // Validar que no tenga procesos\n            if ($empresa->procesos_count > 0) {\n                throw new Exception('La empresa tiene procesos asignados');\n            }\n\n            // Validar que no tenga áreas\n            if ($empresa->areas_count > 0) {\n                throw new Exception('La empresa tiene áreas asignadas');\n            }\n\n            // Validar que no tenga perfiles\n            if ($empresa->perfiles_count > 0) {\n                throw new Exception('La empresa tiene perfiles asignados');\n            }\n\n            // Validar que no tenga agendas\n            if ($empresa->agendas_count > 0) {\n                throw new Exception('La empresa tiene agendas asignadas');\n            }\n\n            // Validar que no tenga encuestas\n            if ($empresa->encuestas_count > 0) {\n                throw new Exception('La empresa tiene encuestas asignadas');\n            }\n\n            // Validar que no tenga soportes\n            if ($empresa->soportes_count > 0) {\n                throw new Exception('La empresa tiene soportes asignados');\n            }\n\n            // Validar que no tenga usuarios\n            if ($empresa->usuarios_count > 0) {\n                throw new Exception('La empresa tiene usuarios asignados');\n            }\n\n            // Validar que no tenga ordenes de servicio\n            if ($empresa->ordenes_servicios_count > 0) {\n                throw new Exception('La empresa tiene ordenes de servicio asignadas');\n            }\n\n            // Validar que no tenga ofertas laborales\n            if ($empresa->ofertas_laborales_count > 0) {\n                throw new Exception('La empresa tiene ofertas laborales asignadas');\n            }\n\n            // Validar que no tenga portales de empleo\n            if ($empresa->portal_empleo_count > 0) {\n                throw new Exception('La empresa tiene portales de empleo asignados');\n            }\n\n            $this->repositorio->sincronizarConfiguraciones($empresa, []);\n            $this->repositorio->eliminar($id);\n        } else {\n            throw new Exception('La empresa está archivada');\n        }\n    }\n\n    /**\n     * Eliminar los usuarios de la empresa junto con sus políticas aceptadas.\n     *\n     * @param Empresa $empresa Empresa.\n     * @param Collection $usuarios Usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function eliminarUsuarios(Empresa $empresa, Collection $usuarios): void {\n        if (count($usuarios) > 0) {\n            foreach ($usuarios as $usuario_empresa) {\n                // Disociar el usuario de la empresa\n                $this->repositorio->disociarUsuario($empresa, $usuario_empresa->id);\n\n                // Disociar las políticas aceptadas del usuario para la empresa\n                $this->politica_aceptada_repositorio->eliminarPorUsuarioYEmpresa($usuario_empresa->id, $empresa->id);\n\n                // Obtener todas las políticas aceptadas del usuario en otras empresas\n                $politicas_otras_empresas = $this->politica_aceptada_repositorio->obtenerPorUsuarioYEmpresasDiferentes($usuario_empresa->id, [$empresa->id]);\n\n                // Obtener los datos del usuario\n                $usuario = $this->usuario_repositorio->getUno($usuario_empresa->id);\n\n                // Validar si el usuario tiene más empresas asociadas y más políticas aceptadas de otras empresas\n                if (count($usuario->empresas) == 0 && count($politicas_otras_empresas) == 0) {\n                    $this->usuario_repositorio->eliminar($usuario_empresa->id);\n                }\n            }\n        }\n    }\n\n    /**\n     * Obtener el historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return Collection\n     * @author Daniel Beltrán\n     */\n    public function historialCambios(int $id): Collection {\n        $historial       = $this->repositorio->historialCambios($id);\n        $historial_final = [];\n\n        // Obtener los datos referenciados a través de llaves foráneas\n        $ciudades         = $this->obtenerDatosReferenciados($historial, 'ciudad_id', 'ciudades_ids', $this->ciudad_repositorio);\n        $ejecutivos       = $this->obtenerDatosReferenciados($historial, 'ejecutivo_id', 'usuarios_ids', $this->usuario_repositorio);\n        $sectores         = $this->obtenerDatosReferenciados($historial, 'sector_id', 'sectores_ids', $this->sector_repositorio);\n        $tamanos_empresas = $this->obtenerDatosReferenciados($historial, 'tamano_empresa_id', 'tamanos_empresas_ids', $this->tamano_empresa_repositorio);\n        $tipos_documentos = $this->obtenerDatosReferenciados($historial, 'tipo_documento_representante_id', 'tipos_documentos_ids', $this->tipo_documento_repositorio);\n\n        foreach ($historial as $item) {\n            array_push($historial_final, [\n                'id'             => $item->id,\n                'user_type'      => $item->user_type,\n                'user_id'        => $item->user_id,\n                'event'          => $item->event,\n                'auditable_type' => $item->auditable_type,\n                'auditable_id'   => $item->auditable_id,\n                'created_at'     => $item->created_at,\n                'user'           => $item->user,\n                'old_values'     => $this->asignarCambiosHistorial($item->old_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos),\n                'new_values'     => $this->asignarCambiosHistorial($item->new_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos)\n            ]);\n        }\n\n        return collect($historial_final);\n    }\n\n    /**\n     * Asignar los cambios del historial.\n     *\n     * @param array $valores Valores del historial (pueden ser antigüos o nuevos).\n     * @param Collection $ciudades Ciudades.\n     * @param Collection $ejecutivos Ejecutivos.\n     * @param Collection $sectores Sectores.\n     * @param Collection $tamanos_empresas Tamaños de empresas.\n     * @param Collection $tipos_documentos Tipos de documentos.\n     * @return array\n     * @author Daniel Beltrán\n     */\n    private function asignarCambiosHistorial(\n        array $valores,\n        Collection $ciudades,\n        Collection $ejecutivos,\n        Collection $sectores,\n        Collection $tamanos_empresas,\n        Collection $tipos_documentos\n    ): array {\n        $valores_actualizados = [];\n\n        foreach ($valores as $llave => $valor) {\n            $valores_actualizados[$llave] = $valor;\n\n            if ($llave === 'ciudad_id') {\n                $ciudad                       = $ciudades->firstWhere('id', $valor);\n                $valores_actualizados[$llave] = $ciudad->nombre . ', ' . $ciudad->departamento->nombre . ' - ' . $ciudad->departamento->pais->nombre;\n            }\n\n            if ($llave === 'ejecutivo_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $ejecutivos->firstWhere('id', $valor)->nombre_completo : null;\n            }\n\n            if ($llave === 'sector_id') {\n                $valores_actualizados[$llave] = $sectores->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tamano_empresa_id') {\n                $valores_actualizados[$llave] = $tamanos_empresas->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tipo_documento_representante_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $tipos_documentos->firstWhere('id', $valor)->nombre : null;\n            }\n        }\n\n        return $valores_actualizados;\n    }\n\n    /**\n     * Obtener el logo de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa no tiene ningún logo.\n     * @return BinaryFileResponse|StreamedResponse\n     * @author Daniel Beltrán\n     */\n    public function getLogo(int $id): BinaryFileResponse|StreamedResponse {\n        $logo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n        abort_if(is_null($logo), 404, 'Esta empresa no tiene ningún logo');\n        return $this->obtenerArchivoDesdeRuta($logo->ruta);\n    }\n\n    /**\n     * Cambiar el logo de la empresa.\n     *\n     * Elimina el logo actual y guarda el nuevo.\n     *\n     * @param int $id ID de la empresa.\n     * @param string $logo Nuevo logo en base64.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function cambiarLogo(int $id, string $logo): void {\n        $archivo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n\n        if (!is_null($archivo)) {\n            $this->archivo_servicio->eliminar($archivo->id);\n        }\n\n        $this->archivo_servicio->guardarVariosBase64($this->modelo, $id, ['logo' => $logo], 'empresas');\n    }\n\n    /**\n     * Exportar Excel del historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return BinaryFileResponse|Response\n     * @author Daniel Beltrán\n     */\n    public function exportarExcelHistorialCambios(int $id): BinaryFileResponse|Response {\n        $datos = [\n            'historial_cambios' => $this->historialCambios($id),\n            'archivos'          => $this->archivo_repositorio->getTodo(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id\n            ]))\n        ];\n\n        return Excel::download(new HistorialCambiosExport($datos), 'historial-cambios.xlsx');\n    }\n\n    /**\n     * Obtiene el conteo dependiendo de id de empresas planes.\n     *\n     * @param int $empresa_plan_id Id de empresas planes.\n     * @param Request $request Contenido de la petición.\n     * @return int\n     * @author Andres Gonzalez\n     * @author Fahibram Cárcamo\n     */\n    public function conteoConsumo(int $empresa_plan_id, Request $request): int {\n        return $this->consumo_repositorio->getTodo(\n            new Request([\n                'empresa_plan_id' => $empresa_plan_id,\n                'fecha_inicio'    => $request->fecha_inicio,\n                'fecha_fin'       => $request->fecha_fin\n            ])\n        )\n        ->count();\n    }\n\n    /**\n     * Obtiene el resumen para el panel.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return array\n     * @author Andres Gonzalez\n     */\n    public function obtenerResumen(Request $request): array {\n        $resumen = $this->repositorio->obtenerResumen($request);\n        $alto    = 0;\n        $normal  = 0;\n        $bajo    = 0;\n\n        $ejecutivos_procesados = [];\n        $planes                = [];\n        $total_precio          = 0;\n        $empresas_asignadas    = 0;\n        $planes_agrupados      = [];\n\n        foreach ($resumen['empresasPlanes'] as $empresa_plan) {\n            $consumo = $this->conteoConsumo($empresa_plan->id, $request);\n\n            if ($consumo > $empresa_plan->unidades) {\n                $alto++;\n            } elseif ($consumo == $empresa_plan->unidades) {\n                $normal++;\n            } else {\n                $bajo++;\n            }\n        }\n\n        $resumen['consumo'] = [\n            'alto'   => $alto,\n            'normal' => $normal,\n            'bajo'   => $bajo,\n        ];\n\n        // Top ejecutivos\n        foreach ($resumen['empresa_ejecutivo'] as $ejecutivo) {\n            $empresas = $this->repositorio->getTodoAgrupadoPlan(new Request([\n                'ejecutivo_id' => $ejecutivo->ejecutivo_id,\n                'fecha_inicio' => $request->fecha_inicio,\n                'fecha_fin'    => $request->fecha_fin,\n            ]));\n\n            foreach ($empresas as $empresa) {\n                foreach ($empresa['empresas_planes'] as $plan) {\n                    $empresas_asignadas++;\n                    $total_precio += $plan['precio'];\n\n                    // Saltar la empresa plan que no tiene un plan asignado por ende es de crédito y de momento no se tiene en cuenta.\n                    if ($plan['plan'] == null) {\n                        continue;\n                    }\n\n                    $planes[] = [\n                        'id'          => $plan['plan']['id'],\n                        'nombre'      => $plan['plan']['nombre'],\n                        'descripcion' => $plan['plan']['descripcion'],\n                        'precio'      => $plan['precio'],\n                        'conteo'      => null\n                    ];\n                }\n            }\n\n            // Agrupa los planes por el id y suma su precio y conteo.\n            foreach ($planes as $plan) {\n                $plan_id = $plan['id'];\n\n                if (!isset($planes_agrupados[$plan_id])) {\n                    $planes_agrupados[$plan_id]           = $plan;\n                    $planes_agrupados[$plan_id]['conteo'] = 1;\n                } else {\n                    $planes_agrupados[$plan_id]['precio'] += $plan['precio'];\n                    $planes_agrupados[$plan_id]['conteo'] += 1;\n                }\n            }\n\n            $planes = array_values($planes_agrupados);\n\n            // Ordena de mayor a menor precio.\n            usort($planes, function ($primero, $segundo) {\n                return $segundo['precio'] <=> $primero['precio'];\n            });\n\n            if ($total_precio > 0) {\n                $ejecutivos_procesados[] = [\n                    'id_ejecutivo'       => $ejecutivo->ejecutivo_id,\n                    'nombre'             => $ejecutivo->ejecutivo->nombre_completo,\n                    'ventas_totales'     => $total_precio,\n                    'empresas_asignadas' => $empresas_asignadas,\n                    'planes'             => $planes,\n                ];\n            }\n\n            // Reiniciar variables.\n            $empresas_asignadas = 0;\n            $total_precio       = 0;\n            $planes             = [];\n            $planes_agrupados   = [];\n        }\n\n        // Ordena de mayor a menor de ventas_totales.\n        usort($ejecutivos_procesados, function ($primero, $segundo) {\n            return $segundo['ventas_totales'] <=> $primero['ventas_totales'];\n        });\n\n        $resumen['ejecutivos'] = $ejecutivos_procesados;\n\n        unset($resumen['empresasPlanes'], $resumen['empresa_ejecutivo']);\n\n        return $resumen;\n    }\n}\n","numLines":769,"startLine":1,"totalLines":769}},"sourceToolAssistantUUID":"7b2c51dc-78e8-4e01-9a71-0a55c840eba0"}
{"parentUuid":"cb1cd043-39e5-4e7d-b731-0f63206b6ceb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01M9uKTT9fywB9g2tBEaP5q1","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Empresas;\n     4→\n     5→use Exception;\n     6→use Carbon\\Carbon;\n     7→use App\\Models\\Planes\\Plan;\n     8→use Illuminate\\Support\\Arr;\n     9→use App\\Traits\\ArchivoTrait;\n    10→use Illuminate\\Http\\Request;\n    11→use App\\Mail\\CrearUsuarioMail;\n    12→use Illuminate\\Http\\UploadedFile;\n    13→use App\\Http\\Services\\BaseService;\n    14→use App\\Models\\Pruebas\\TipoPrueba;\n    15→use Illuminate\\Support\\Collection;\n    16→use App\\Models\\Empresas\\EmpresaPlan;\n    17→use Illuminate\\Support\\Facades\\Notification;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use Illuminate\\Support\\Facades\\{Mail, Password};\n    20→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    21→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    22→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    23→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    24→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    25→use App\\Notifications\\SolicitudRenovacionPlanNotification;\n    26→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    27→use Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n    28→\n    29→/**\n    30→ * @property EmpresaPlanRepository $repositorio\n    31→ */\n    32→class EmpresaPlanService extends BaseService\n    33→{\n    34→    use ArchivoTrait;\n    35→\n    36→    /**\n    37→     * Constructor.\n    38→     *\n    39→     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n    40→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    41→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    42→     * @param PlanRepository $plan_repositorio Repositorio de planes.\n    43→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    44→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    45→     * @return void\n    46→     * @author Daniel Beltrán\n    47→     */\n    48→    public function __construct(\n    49→        EmpresaPlanRepository $repositorio,\n    50→        protected EmpresaRepository $empresa_repositorio,\n    51→        protected RolRepository $rol_repositorio,\n    52→        protected PlanRepository $plan_repositorio,\n    53→        protected PlanCreditoRepository $plan_credito_repositorio,\n    54→        protected ArchivoRepository $archivo_repositorio,\n    55→        protected UserRepository $usuario_repositorio\n    56→    ) {\n    57→        parent::__construct($repositorio);\n    58→    }\n    59→\n    60→    /**\n    61→     * Guardar un plan de empresa.\n    62→     *\n    63→     * @param Request $request Contenido de la petición.\n    64→     * @return EmpresaPlan\n    65→     * @author Sergio Vargas\n    66→     * @author Daniel Beltrán\n    67→     * @author Andres Morales\n    68→     * @author Jair Carvajal\n    69→     * @author Andres Gonzalez\n    70→     */\n    71→    public function guardar(Request $request): EmpresaPlan {\n    72→        $tiene_plan_seleccion = $request->filled('plan_id');\n    73→        $tiene_plan_creditos  = $request->filled('plan_credito_id');\n    74→        $plan_asignado        = null;\n    75→\n    76→        // Si tiene plan de selección, crear/actualizar ese plan\n    77→        if ($tiene_plan_seleccion) {\n    78→            $plan_asignado = $this->guardarPlanSeleccion($request);\n    79→        }\n    80→\n    81→        // Si tiene plan de créditos, crear ese plan por separado\n    82→        if ($tiene_plan_creditos) {\n    83→            $plan_creditos = $this->guardarPlanCreditos($request);\n    84→\n    85→            // Si no había plan de selección, retornar el de créditos\n    86→            if (!$tiene_plan_seleccion) {\n    87→                $plan_asignado = $plan_creditos;\n    88→            }\n    89→        }\n    90→\n    91→        return $plan_asignado;\n    92→    }\n    93→\n    94→    /**\n    95→     * Guardar un plan de selección.\n    96→     *\n    97→     * @param Request $request Contenido de la petición.\n    98→     * @return EmpresaPlan\n    99→     * @author Andres Gonzalez\n   100→     */\n   101→    protected function guardarPlanSeleccion(Request $request): EmpresaPlan {\n   102→        $enviar_correo    = false;\n   103→        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades', 'precio_creditos', 'porcentaje_descuento_creditos', 'plan_credito_id', 'creditos'];\n   104→        $plan             = $this->plan_repositorio->getUno($request->plan_id);\n   105→        $plan_activo      = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n   106→        $vigencia         = $plan->vigencia;\n   107→\n   108→        if ($request->filled('vigencia')) {\n   109→            $vigencia = $request->vigencia;\n   110→        }\n   111→\n   112→        if (!is_null($plan_activo)) {\n   113→            if ($request->filled('id')) {\n   114→                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n   115→                if ($request->id === $plan_activo->id) {\n   116→                    goto omitir_calcular_vigencia_seleccion;\n   117→                }\n   118→\n   119→                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n   120→                if ($vigencia == $request->vigencia) {\n   121→                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n   122→                    goto omitir_calcular_vigencia_seleccion;\n   123→                }\n   124→            }\n   125→\n   126→            // Poner el nuevo plan como proximo\n   127→            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n   128→\n   129→            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n   130→            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n   131→                // Agregar las nuevas fechas al nuevo plan\n   132→                $hoy          = now();\n   133→                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n   134→                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n   135→            }\n   136→        } else {\n   137→            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   138→\n   139→            // Validar si el plan seleccionado tiene vigencia\n   140→            if (!is_null($plan->vigencia)) {\n   141→                $request->merge($this->calcularFechasVigencia($vigencia));\n   142→            }\n   143→        }\n   144→\n   145→        omitir_calcular_vigencia_seleccion:\n   146→\n   147→        if (!$request->filled('unidades')) {\n   148→            $request->merge(['unidades' => $plan->unidades]);\n   149→        } elseif ($request->unidades != $plan->unidades) {\n   150→            $request->merge(['plan_original' => false]);\n   151→        }\n   152→\n   153→        if (!$request->filled('cantidad_ofertas_laborales')) {\n   154→            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n   155→        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n   156→            $request->merge(['plan_original' => false]);\n   157→        }\n   158→\n   159→        if (!$request->filled('cantidad_usuarios')) {\n   160→            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n   161→        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n   162→            $request->merge(['plan_original' => false]);\n   163→        }\n   164→\n   165→        if (!$request->filled('cantidad_pruebas')) {\n   166→            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n   167→        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n   168→            $request->merge(['plan_original' => false]);\n   169→        }\n   170→\n   171→        // Comprobar si se modificaron las funcionalidades respecto al plan original\n   172→        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n   173→            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n   174→            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n   175→            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n   176→\n   177→            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n   178→                $request->merge(['plan_original' => false]);\n   179→            }\n   180→        }\n   181→\n   182→        if ($request->filled('id')) {\n   183→            // Eliminar la factura actual\n   184→            if ($request->hasFile('factura')) {\n   185→                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n   186→\n   187→                if (!is_null($archivo)) {\n   188→                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n   189→                    $this->archivo_repositorio->eliminar($archivo->id);\n   190→                }\n   191→            }\n   192→\n   193→            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n   194→        } else {\n   195→            $enviar_correo = true;\n   196→            $request->merge(['usuario_id' => auth()->user()->id]);\n   197→            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n   198→        }\n   199→\n   200→        if ($request->filled('pruebas')) {\n   201→            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n   202→        }\n   203→\n   204→        if ($request->filled('funcionalidades')) {\n   205→            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n   206→        }\n   207→\n   208→        if ($request->hasFile('factura')) {\n   209→            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n   210→        }\n   211→\n   212→        if ($enviar_correo) {\n   213→            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n   214→            $usuario      = $empresa->usuarios[0];\n   215→            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n   216→            $titulo       = 'Usuario principal de la empresa creado';\n   217→            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n   218→        }\n   219→\n   220→        return $plan_asignado;\n   221→    }\n   222→\n   223→    /**\n   224→     * Guardar un plan de créditos.\n   225→     *\n   226→     * @param Request $request Contenido de la petición.\n   227→     * @return EmpresaPlan\n   228→     * @author Andres Gonzalez\n   229→     */\n   230→    protected function guardarPlanCreditos(Request $request): EmpresaPlan {\n   231→        $enviar_correo = false;\n   232→        $plan_credito  = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n   233→        $plan_activo   = $this->repositorio->planCreditosActivo($request->empresa_id);\n   234→\n   235→        // Preparar datos para el plan de créditos\n   236→        $datos_creditos = [\n   237→            'empresa_id'            => $request->empresa_id,\n   238→            'plan_id'               => null,\n   239→            'plan_credito_id'       => $request->plan_credito_id,\n   240→            'creditos'              => $plan_credito->creditos ?? 0,\n   241→            'precio'                => $request->precio_creditos ?? $plan_credito->precio ?? null,\n   242→            'porcentaje_descuento'  => $request->porcentaje_descuento_creditos ?? null,\n   243→            'numero_factura'        => $request->numero_factura,\n   244→            'comentario'            => $request->comentario,\n   245→            'fecha_inicio'          => null,\n   246→            'fecha_vencimiento'     => null,\n   247→            'usuario_id'            => auth()->user()->id,\n   248→        ];\n   249→\n   250→        // Si es edición de un plan de créditos existente\n   251→        if ($request->filled('id')) {\n   252→            // Eliminar la factura actual si se sube una nueva\n   253→            if ($request->hasFile('factura')) {\n   254→                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n   255→\n   256→                if (!is_null($archivo)) {\n   257→                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n   258→                    $this->archivo_repositorio->eliminar($archivo->id);\n   259→                }\n   260→            }\n   261→\n   262→            $plan_asignado = $this->repositorio->actualizar($request->id, $datos_creditos);\n   263→        } else {\n   264→            // Determinar estado para nuevo plan\n   265→            if (!is_null($plan_activo) && $plan_activo->id != $request->id) {\n   266→                $datos_creditos['estado_id'] = Plan::ESTADO_PROXIMO_ID;\n   267→            } else {\n   268→                $datos_creditos['estado_id'] = Plan::ESTADO_ACTIVO_ID;\n   269→            }\n   270→\n   271→            $enviar_correo = true;\n   272→            $plan_asignado = $this->repositorio->crear($datos_creditos);\n   273→        }\n   274→\n   275→        if ($request->hasFile('factura')) {\n   276→            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n   277→        }\n   278→\n   279→        return $plan_asignado;\n   280→    }\n   281→\n   282→    /**\n   283→     * Renovar el plan asignado.\n   284→     *\n   285→     * @param int $id ID del plan de la empresa que se quiere renovar.\n   286→     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n   287→     * @return EmpresaPlan Plan de la empresa renovado.\n   288→     * @author Daniel Beltrán\n   289→     */\n   290→    public function renovar(int $id): EmpresaPlan {\n   291→        $empresa_plan = $this->repositorio->getUno($id);\n   292→\n   293→        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n   294→            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n   295→        }\n   296→\n   297→        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n   298→\n   299→        $request->merge(['por_facturar' => true]);\n   300→\n   301→        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n   302→            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n   303→            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n   304→        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {\n   305→            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n   306→            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n   307→        }\n   308→\n   309→        $this->verificarYAsignarTiempo($empresa_plan, $request);\n   310→\n   311→        $plan_renovado = $this->repositorio->crear($request->toArray());\n   312→\n   313→        if ($request->filled('pruebas')) {\n   314→            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n   315→        }\n   316→\n   317→        if ($request->filled('funcionalidades')) {\n   318→            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n   319→        }\n   320→\n   321→        return $plan_renovado;\n   322→    }\n   323→\n   324→    /**\n   325→     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n   326→     *\n   327→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   328→     * @param Request $request Contenido de la petición.\n   329→     * @return void\n   330→     * @author Daniel Beltrán\n   331→     */\n   332→    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n   333→        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n   334→            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n   335→        }\n   336→    }\n   337→\n   338→    /**\n   339→     * Calcular las fechas en las que el plan estará vigente.\n   340→     *\n   341→     * @param int $vigencia Cantidad de días de vigencia.\n   342→     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n   343→     * @return array Fechas de inicio y vencimiento.\n   344→     * @author Daniel Beltrán\n   345→     */\n   346→    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n   347→        $hoy = now();\n   348→\n   349→        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n   350→\n   351→        // Si es múltiplo de 3, entonces la vigencia es en meses\n   352→\n   353→        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n   354→            $meses = $vigencia / 30;\n   355→\n   356→            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n   357→\n   358→            if ($fecha_inicio->day === 1) {\n   359→                $fecha_vencimiento->subDay();\n   360→            }\n   361→        } else {\n   362→            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n   363→\n   364→            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n   365→        }\n   366→\n   367→        return [\n   368→            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n   369→\n   370→            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n   371→        ];\n   372→    }\n   373→\n   374→    /**\n   375→     * Facturar un plan de empresa.\n   376→     *\n   377→     * @param int $id ID del plan de empresa.\n   378→     * @param Request $request Contenido de la petición.\n   379→     * @return EmpresaPlan\n   380→     * @author Daniel Beltrán\n   381→     */\n   382→    public function facturar(int $id, Request $request): EmpresaPlan {\n   383→        $empresa_plan = $this->repositorio->getUno($id);\n   384→\n   385→        if ($request->filled('vigencia')) {\n   386→            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n   387→        }\n   388→\n   389→        $request->merge(['por_facturar' => false]);\n   390→\n   391→        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n   392→\n   393→        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n   394→\n   395→        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n   396→\n   397→        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n   398→    }\n   399→\n   400→    /**\n   401→     * Guardar factura.\n   402→     *\n   403→     * @param int $id ID del plan de empresa.\n   404→     * @param int $empresa_id ID de la empresa.\n   405→     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n   406→     * @return void\n   407→     * @author Daniel Beltrán\n   408→     */\n   409→    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n   410→        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n   411→\n   412→        $this->generarDirectorios(\"app/{$ruta}\");\n   413→\n   414→        $nombre_archivo = $this->generarNombreArchivo($archivo);\n   415→\n   416→        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n   417→\n   418→        $this->archivo_repositorio->crear([\n   419→            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n   420→\n   421→            'modelo_id' => $id,\n   422→\n   423→            'nombre' => 'factura',\n   424→\n   425→            'ruta' => $ruta . '/' . $nombre_archivo\n   426→        ]);\n   427→    }\n   428→\n   429→    /**\n   430→     * Obtener el historial de recompras de una empresa por tipo de prueba.\n   431→     *\n   432→     * @param Request $request Contenido de la petición HTTP entrante.\n   433→     * @return Collection\n   434→     * @author Daniel Beltrán\n   435→     * @author Fahibram Cárcamo\n   436→     * @author Andres Morales\n   437→     * @author Andres Gonzalez\n   438→     */\n   439→    public function historialRecompras(Request $request): Collection {\n   440→        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n   441→\n   442→        $request->merge([\n   443→            'con_conteo_consumos_agendas'           => true,\n   444→            'con_conteo_consumos_ofertas_laborales' => true\n   445→        ]);\n   446→\n   447→        return match ($rol_usuario->id) {\n   448→            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n   449→\n   450→            RolRepository::ROL_PROPIETARIO_ID,\n   451→\n   452→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   453→\n   454→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   455→\n   456→            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n   457→        };\n   458→    }\n   459→\n   460→    /**\n   461→     * Obtener el historial de compras de planes con creditos para una empresa.\n   462→     *\n   463→     * @param int $empresa_id ID de la empresa.\n   464→     * @param Request $request Contenido de la peticion.\n   465→     * @return Collection\n   466→     * @author Sergio Vargas\n   467→     */\n   468→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   469→        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n   470→\n   471→        return $historial->map(function (EmpresaPlan $plan) {\n   472→            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n   473→\n   474→            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n   475→\n   476→            $plan->creditos_totales = $total_creditos;\n   477→\n   478→            $plan->creditos_consumidos = $creditos_consumidos;\n   479→\n   480→            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n   481→\n   482→            return $plan;\n   483→        });\n   484→    }\n   485→\n   486→    /**\n   487→     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n   488→     *\n   489→     * @param int $empresa_id ID de la empresa.\n   490→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   491→     * @return ?EmpresaPlan\n   492→     * @author Daniel Beltrán\n   493→     */\n   494→    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   495→        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n   496→            'empresa_id'             => $empresa_id,\n   497→            'tipo_prueba_id'         => $tipo_prueba_id,\n   498→            'excluir_estado_proximo' => true\n   499→        ]));\n   500→\n   501→        if (!is_null($plan)) {\n   502→            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   503→\n   504→            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n   505→        }\n   506→\n   507→        return $plan;\n   508→    }\n   509→\n   510→    /**\n   511→     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n   512→     *\n   513→     * @param int $id ID del plan de empresa.\n   514→     * @return ?EmpresaPlan\n   515→     * @author Daniel Beltrán\n   516→     */\n   517→    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n   518→        $plan               = $this->repositorio->getUno($id);\n   519→        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n   520→\n   521→        return $plan;\n   522→    }\n   523→\n   524→    /**\n   525→     * Obtener el plan activo de la empresa por tipo de prueba.\n   526→     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n   527→     * La propiedad se llama 'plan_proximo' y es un booleano.\n   528→     *\n   529→     * @param int $empresa_id ID de la empresa.\n   530→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   531→     * @return ?EmpresaPlan\n   532→     * @author Daniel Beltrán\n   533→     */\n   534→    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   535→        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   536→\n   537→        if (!is_null($plan)) {\n   538→            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n   539→        }\n   540→\n   541→        return $plan;\n   542→    }\n   543→\n   544→    /**\n   545→     * Solicitar la renovación de un plan específico de una empresa específica.\n   546→     *\n   547→     * @param Request $request Solicitud HTTP.\n   548→     * @return void\n   549→     * @author Fahibram Cárcamo\n   550→     * @author Andres González\n   551→     */\n   552→    public function solicitarRenovacionPlan(Request $request) {\n   553→        $tipo_plan = $request->tipo_plan ?? 'plan';\n   554→\n   555→        if ($tipo_plan === 'plan_credito') {\n   556→            $plan = $this->plan_credito_repositorio->getUno($request->plan_id);\n   557→        } else {\n   558→            $plan = $this->plan_repositorio->getUno($request->plan_id);\n   559→        }\n   560→\n   561→        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n   562→        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n   563→\n   564→        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   565→            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n   566→            'con_roles_ids' => true\n   567→        ]));\n   568→\n   569→        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   570→            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n   571→            'empresa_id'    => $request->empresa_id,\n   572→            'con_roles_ids' => true\n   573→        ]));\n   574→\n   575→        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n   576→        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n   577→    }\n   578→\n   579→    /**\n   580→     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n   581→     *\n   582→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   583→     * @return bool\n   584→     * @author Daniel Beltrán\n   585→     * @author Fahibram Cárcamo\n   586→     */\n   587→    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n   588→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   589→            return true;\n   590→        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n   591→            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n   592→                return true;\n   593→            }\n   594→        }\n   595→\n   596→        return false;\n   597→    }\n   598→\n   599→    /**\n   600→     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n   601→     *\n   602→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   603→     * @return bool\n   604→     * @author Daniel Beltrán\n   605→     * @author Fahibram Cárcamo\n   606→     */\n   607→    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   608→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   609→            return true;\n   610→        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n   611→            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n   612→                return true;\n   613→            }\n   614→        }\n   615→\n   616→        return false;\n   617→    }\n   618→\n   619→    /**\n   620→     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n   621→     *\n   622→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   623→     * @return bool\n   624→     * @author Fahibram Cárcamo\n   625→     */\n   626→    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n   627→        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n   628→    }\n   629→\n   630→    /**\n   631→     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n   632→     *\n   633→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   634→     * @return bool\n   635→     * @author Fahibram Cárcamo\n   636→     */\n   637→    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   638→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n   639→    }\n   640→\n   641→    /**\n   642→     * Verificar que la fecha de vencimiento del plan no haya pasado.\n   643→     *\n   644→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   645→     * @return bool\n   646→     * @author Andres Gonzalez\n   647→     */\n   648→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   649→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n   650→            return true;\n   651→        }\n   652→\n   653→        return false;\n   654→    }\n   655→\n   656→    /**\n   657→     * Verificar que el plan tenga vacantes disponibles.\n   658→     *\n   659→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   660→     * @return bool\n   661→     * @author Andres Gonzalez\n   662→     */\n   663→    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n   664→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n   665→    }\n   666→\n   667→    /**\n   668→     * Obtener creditos disponibles para un plan de empresa.\n   669→     *\n   670→     * @param int $empresa_plan_id ID del plan de empresa.\n   671→     * @return int\n   672→     * @author Sergio Vargas\n   673→     * @author Daniel Beltrán\n   674→     */\n   675→    public function creditosDisponibles(int $empresa_plan_id): int {\n   676→        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n   677→\n   678→        return $empresa_plan?->creditos_restantes ?? 0;\n   679→    }\n   680→\n   681→    /**\n   682→     * Obtener creditos disponibles y plan asignado de una empresa.\n   683→     *\n   684→     * @param int $empresa_id ID de la empresa.\n   685→     * @param Request $request Contenido de la peticion.\n   686→     * @return array|null\n   687→     * @author Sergio Vargas\n   688→     * @author José Manuel Jiménez\n   689→     */\n   690→    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n   691→        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n   692→            ? (int) $request->tipo_prueba_id\n   693→            : TipoPrueba::SELECCION_ID;\n   694→\n   695→        $empresa_plan = $this->repositorio->planCreditosActivo($empresa_id);\n   696→\n   697→        if (!$empresa_plan) {\n   698→            return null;\n   699→        }\n   700→\n   701→        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n   702→\n   703→        return [\n   704→            'empresa_id'           => $empresa_id,\n   705→            'empresa_plan_id'      => $empresa_plan->id,\n   706→            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n   707→            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n   708→            'plan_credito'         => $empresa_plan->planCredito ? [\n   709→                'id'       => $empresa_plan->planCredito->id,\n   710→                'nombre'   => $empresa_plan->planCredito->nombre,\n   711→                'creditos' => $empresa_plan->planCredito->creditos,\n   712→                'precio'   => $empresa_plan->planCredito->precio\n   713→            ] : null,\n   714→            'estado'               => $empresa_plan->estado ? [\n   715→                'id'     => $empresa_plan->estado->id,\n   716→                'nombre' => $empresa_plan->estado->nombre,\n   717→            ] : null\n   718→        ];\n   719→    }\n   720→\n   721→    /**\n   722→     * Validar si hay creditos suficientes.\n   723→     *\n   724→     * @param int $empresa_plan_id ID del plan de empresa.\n   725→     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n   726→     * @return bool\n   727→     * @author Sergio Vargas\n   728→     * @author Daniel Beltrán\n   729→     */\n   730→    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n   731→        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n   732→    }\n   733→}\n   734→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d96d9cba-4bdb-4ff9-9665-ff4899d9f021","timestamp":"2026-01-25T01:55:23.196Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $tiene_plan_seleccion = $request->filled('plan_id');\n        $tiene_plan_creditos  = $request->filled('plan_credito_id');\n        $plan_asignado        = null;\n\n        // Si tiene plan de selección, crear/actualizar ese plan\n        if ($tiene_plan_seleccion) {\n            $plan_asignado = $this->guardarPlanSeleccion($request);\n        }\n\n        // Si tiene plan de créditos, crear ese plan por separado\n        if ($tiene_plan_creditos) {\n            $plan_creditos = $this->guardarPlanCreditos($request);\n\n            // Si no había plan de selección, retornar el de créditos\n            if (!$tiene_plan_seleccion) {\n                $plan_asignado = $plan_creditos;\n            }\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Guardar un plan de selección.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Andres Gonzalez\n     */\n    protected function guardarPlanSeleccion(Request $request): EmpresaPlan {\n        $enviar_correo    = false;\n        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades', 'precio_creditos', 'porcentaje_descuento_creditos', 'plan_credito_id', 'creditos'];\n        $plan             = $this->plan_repositorio->getUno($request->plan_id);\n        $plan_activo      = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n        $vigencia         = $plan->vigencia;\n\n        if ($request->filled('vigencia')) {\n            $vigencia = $request->vigencia;\n        }\n\n        if (!is_null($plan_activo)) {\n            if ($request->filled('id')) {\n                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                if ($request->id === $plan_activo->id) {\n                    goto omitir_calcular_vigencia_seleccion;\n                }\n\n                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                if ($vigencia == $request->vigencia) {\n                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                    goto omitir_calcular_vigencia_seleccion;\n                }\n            }\n\n            // Poner el nuevo plan como proximo\n            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n\n            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                // Agregar las nuevas fechas al nuevo plan\n                $hoy          = now();\n                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n            }\n        } else {\n            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n\n            // Validar si el plan seleccionado tiene vigencia\n            if (!is_null($plan->vigencia)) {\n                $request->merge($this->calcularFechasVigencia($vigencia));\n            }\n        }\n\n        omitir_calcular_vigencia_seleccion:\n\n        if (!$request->filled('unidades')) {\n            $request->merge(['unidades' => $plan->unidades]);\n        } elseif ($request->unidades != $plan->unidades) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_ofertas_laborales')) {\n            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_usuarios')) {\n            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_pruebas')) {\n            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        // Comprobar si se modificaron las funcionalidades respecto al plan original\n        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n\n            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                $request->merge(['plan_original' => false]);\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($enviar_correo) {\n            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario      = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n            $titulo       = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Guardar un plan de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Andres Gonzalez\n     */\n    protected function guardarPlanCreditos(Request $request): EmpresaPlan {\n        $enviar_correo = false;\n        $plan_credito  = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n        $plan_activo   = $this->repositorio->planCreditosActivo($request->empresa_id);\n\n        // Preparar datos para el plan de créditos\n        $datos_creditos = [\n            'empresa_id'            => $request->empresa_id,\n            'plan_id'               => null,\n            'plan_credito_id'       => $request->plan_credito_id,\n            'creditos'              => $plan_credito->creditos ?? 0,\n            'precio'                => $request->precio_creditos ?? $plan_credito->precio ?? null,\n            'porcentaje_descuento'  => $request->porcentaje_descuento_creditos ?? null,\n            'numero_factura'        => $request->numero_factura,\n            'comentario'            => $request->comentario,\n            'fecha_inicio'          => null,\n            'fecha_vencimiento'     => null,\n            'usuario_id'            => auth()->user()->id,\n        ];\n\n        // Si es edición de un plan de créditos existente\n        if ($request->filled('id')) {\n            // Eliminar la factura actual si se sube una nueva\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $datos_creditos);\n        } else {\n            // Determinar estado para nuevo plan\n            if (!is_null($plan_activo) && $plan_activo->id != $request->id) {\n                $datos_creditos['estado_id'] = Plan::ESTADO_PROXIMO_ID;\n            } else {\n                $datos_creditos['estado_id'] = Plan::ESTADO_ACTIVO_ID;\n            }\n\n            $enviar_correo = true;\n            $plan_asignado = $this->repositorio->crear($datos_creditos);\n        }\n\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     *\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     *\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy = now();\n\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses = $vigencia / 30;\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n\n        $this->generarDirectorios(\"app/{$ruta}\");\n\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n\n            'modelo_id' => $id,\n\n            'nombre' => 'factura',\n\n            'ruta' => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n\n        $request->merge([\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n\n            RolRepository::ROL_PROPIETARIO_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n\n            $plan->creditos_consumidos = $creditos_consumidos;\n\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan               = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Andres González\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $tipo_plan = $request->tipo_plan ?? 'plan';\n\n        if ($tipo_plan === 'plan_credito') {\n            $plan = $this->plan_credito_repositorio->getUno($request->plan_id);\n        } else {\n            $plan = $this->plan_repositorio->getUno($request->plan_id);\n        }\n\n        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n            'empresa_id'    => $request->empresa_id,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     * @author José Manuel Jiménez\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planCreditosActivo($empresa_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null,\n            'estado'               => $empresa_plan->estado ? [\n                'id'     => $empresa_plan->estado->id,\n                'nombre' => $empresa_plan->estado->nombre,\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","numLines":734,"startLine":1,"totalLines":734}},"sourceToolAssistantUUID":"cb1cd043-39e5-4e7d-b731-0f63206b6ceb"}
{"parentUuid":"d96d9cba-4bdb-4ff9-9665-ff4899d9f021","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EDkGubg4C1YjSWXNRMsSNa","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito leer el archivo JavaScript para ver cómo está implementada la función `mostrarPlanes()`:","signature":"EpICCkYICxgCKkCkmpseRM3Yt0MLZqxcpxuZ/bY5tlEeaRvXl9YcJUqWM+wJDV6Nt0bwDLWKqma2CPem59Kn2r8FtxfLe8J2lm+uEgwNbwzSQbSeHIOr2MoaDFKxhDXPcKxNnFSQeCIwN4Ft6pociy4d/tqP5bbeMxAmvoei/MtfvnQTRFST+QyOBcWnILUA2UWtHkOHl2d1KnpVxEhh34M+ScvWt38ZMb7rTYgvs5o1qvv1MtoQMp+SwmQfQsjkxxrKBrRzHmf2GX3h2d08DLGxoa/B0eap4MYx3sI1tQrwXHoiop+zfiwjKtvG/Jy2rshNr1ZhO2+gMZ1zhl9YHzIdHUhfDm883fwSQPD6nHAOHWrxhRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11364,"cache_creation_input_tokens":29452,"cache_read_input_tokens":26015,"cache_creation":{"ephemeral_5m_input_tokens":29452,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGGTCDa6hvG2uvbYK1z","type":"assistant","uuid":"293ec670-2928-40b4-8585-7b4f01cf017c","timestamp":"2026-01-25T01:55:26.263Z"}
{"parentUuid":"293ec670-2928-40b4-8585-7b4f01cf017c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EDkGubg4C1YjSWXNRMsSNa","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora necesito leer el archivo JavaScript para ver cómo está implementada la función `mostrarPlanes()`."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11364,"cache_creation_input_tokens":29452,"cache_read_input_tokens":26015,"cache_creation":{"ephemeral_5m_input_tokens":29452,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGGTCDa6hvG2uvbYK1z","type":"assistant","uuid":"956973a2-8774-4f8a-bd41-2199dd3b3ad3","timestamp":"2026-01-25T01:55:26.643Z"}
{"parentUuid":"956973a2-8774-4f8a-bd41-2199dd3b3ad3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EDkGubg4C1YjSWXNRMsSNa","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01E9mUHB7dqAi5rAQayKpWda","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":1470,"limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11364,"cache_creation_input_tokens":29452,"cache_read_input_tokens":26015,"cache_creation":{"ephemeral_5m_input_tokens":29452,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGGTCDa6hvG2uvbYK1z","type":"assistant","uuid":"630cfe66-8d81-49f8-9763-c93990033d50","timestamp":"2026-01-25T01:55:28.195Z"}
{"parentUuid":"630cfe66-8d81-49f8-9763-c93990033d50","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01E9mUHB7dqAi5rAQayKpWda","type":"tool_result","content":"  1470→ */\n  1471→function actualizarEnlacesPrevisualizacionArchivos(archivos_empresa, reiniciar_campo_archivo = true) {\n  1472→    // Oculta todos los elementos anchor de previsualización de archivos.\n  1473→    $('.previsualizacion-archivo').addClass('d-none');\n  1474→\n  1475→    // Muestra los elementos de previsualización de archivos que corresponden con los archivos\n  1476→    // relacionados con la empresa.\n  1477→    for (let i = 0; i < archivos_empresa.length; i++) {\n  1478→        $('#archivo_' + archivos_empresa[i].nombre).prop('href', `/archivos-abrir/${archivos_empresa[i].id}`);\n  1479→        $('#archivo_' + archivos_empresa[i].nombre).removeClass('d-none');\n  1480→\n  1481→        let input_archivo = $('#' + archivos_empresa[i].nombre + '.input-file.input-form');\n  1482→        let input_archivo_label = $('label[for=\"' + archivos_empresa[i].nombre + '\"].nombre-archivo');\n  1483→        let input_archivo_boton_eliminar = $('#boton-eliminar-archivo-' + archivos_empresa[i].nombre + '.eliminar-archivo');\n  1484→\n  1485→        if(reiniciar_campo_archivo) {\n  1486→            reiniciarCampoArchivo(input_archivo, input_archivo_label, input_archivo_boton_eliminar);\n  1487→        }\n  1488→    }\n  1489→}\n  1490→\n  1491→function mostrarPlanes() {\n  1492→    let empresa_id = empresa_seleccionada.id;\n  1493→    let buscar = $('#buscador-plan').val();\n  1494→    let filtro_tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n  1495→    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n  1496→        tabla_planes.destroy();\n  1497→    }\n  1498→    $('#buscador-plan').remove();\n  1499→    $('#tbody-planes').empty();\n  1500→    let planes = empresa_seleccionada.planes;\n  1501→    if (planes.length > 0) {\n  1502→        for (let i = 0; i < planes.length; i++) {\n  1503→            if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n  1504→                continue;\n  1505→            }\n  1506→            if (\n  1507→                (filtro_tipo_prueba_id == 'Todos') ||\n  1508→                (filtro_tipo_prueba_id == '1' && planes[i].plan.tipo_prueba_id == 1) ||\n  1509→                (filtro_tipo_prueba_id == '2' && planes[i].plan.tipo_prueba_id == 2) ||\n  1510→                (filtro_tipo_prueba_id == '3' && planes[i].plan.tipo_prueba_id != 3)\n  1511→            ) {\n  1512→                let estado = obtenerEstadoPlan(\n  1513→                    planes[i].estado.id,\n  1514→                    planes[i].estado.nombre,\n  1515→                    planes[i].por_facturar,\n  1516→                    planes[i].renovando,\n  1517→                    null,\n  1518→                    planes[i].plan_proximo_id\n  1519→                );\n  1520→\n  1521→                let acciones = obtenerAcciones(\n  1522→                    planes[i].estado.id,\n  1523→                    planes[i].id, empresa_id,\n  1524→                    planes[i].plan.tipo_prueba_id,\n  1525→                    planes[i].plan.nombre,\n  1526→                    planes[i]?.archivos[0]?.id ?? '0',\n  1527→                    empresa_seleccionada.nombre_comercial\n  1528→                );\n  1529→\n  1530→                let modificado = '';\n  1531→                if (planes[i].plan_original == 0) {\n  1532→                    modificado = `<i class=\"bi bi-wrench me-3 text-blue-40\" ${crearTooltip({placement: 'top', content: 'Plan modificado', toggle: 'popover' })}></i>`;\n  1533→                }\n  1534→                let fecha_vencimiento = '';\n  1535→                if (planes[i].fecha_vencimiento != null) {\n  1536→                    fecha_vencimiento = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n  1537→                }\n  1538→                let fecha_creacion = '';\n  1539→                if (planes[i].created_at != null) {\n  1540→                    fecha_creacion = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n  1541→                }\n  1542→                let fecha_inicio = '';\n  1543→                if (planes[i].fecha_inicio != null) {\n  1544→                    fecha_inicio = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n  1545→                }\n  1546→                let pruebas_plan = '';\n  1547→                if (planes[i].pruebas !== undefined) {\n  1548→                    let pruebas = planes[i].pruebas;\n  1549→                    for (let j = 0; j < pruebas.length; j++) {\n  1550→                        pruebas_plan += `\n  1551→                            <div\n  1552→                                class=\"col-auto me-3 circulo-prueba\"\n  1553→                                style=\"background-image: url(../imagenes/logos/pruebas/${slugify(planes[i].pruebas[j].nombre)}.png)\"\n  1554→                                ${crearTooltip({placement: 'top', content: planes[i].pruebas[j].nombre, toggle: 'popover' })}\n  1555→                            ></div>\n  1556→                        `;\n  1557→                    }\n  1558→                }\n  1559→                let icono = '';\n  1560→                let title = '';\n  1561→                if (planes[i].plan.tipo_prueba_id == 1) {\n  1562→                    title = 'Selección';\n  1563→                    icono = 'bi-person-fill';\n  1564→                } else if (planes[i].plan.tipo_prueba_id == 2) {\n  1565→                    title = 'Organizacional';\n  1566→                    icono = 'bi-people-fill';\n  1567→                } else if (planes[i].plan.tipo_prueba_id == 3) {\n  1568→                    title = 'Vocacional';\n  1569→                    icono = 'bi-mortarboard-fill';\n  1570→                }\n  1571→                let opcion_editar = `\n  1572→                    <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit'\">\n  1573→                        <i class=\"bi bi-pencil-fill\"></i>\n  1574→                    </button>\n  1575→                `;\n  1576→                if (planes[i]?.plan_proximo_id) {\n  1577→                    opcion_editar = `\n  1578→                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n  1579→                            <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n  1580→                            <div class=\"dropdown-menu\">\n  1581→                                <a href=\"/empresas-planes/${planes[i].id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n  1582→                                <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n  1583→                            </div>\n  1584→                        </button>\n  1585→                    `;\n  1586→                }\n  1587→                $('#tbody-planes').append(`\n  1588→                    <tr>\n  1589→                        <td style=\"border-bottom: 0px!important;\">\n  1590→                            <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n  1591→                                <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n  1592→                                    <div class=\"col\">\n  1593→                                        <div class=\"row align-items-center\">\n  1594→                                            <div class=\"col-auto mb-0\">\n  1595→                                                <p class=\"text-gray-30 text-headline-4 mb-0\">\n  1596→                                                    <i class=\"bi ${icono} me-3\" title=\"${title}\"></i> ${modificado} ${planes[i].plan.nombre}\n  1597→                                                </p>\n  1598→                                            </div>\n  1599→                                            <div class=\"col-auto\">\n  1600→                                                ${estado}\n  1601→                                            </div>\n  1602→                                            <div class=\"col-auto\">\n  1603→                                                <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n  1604→                                                    <i class=\"bi bi-person-fill\"></i>&nbsp;<span class=\"text-label-2\">${planes[i].cantidad_usuarios}&nbsp;${fecha_vencimiento}</span>\n  1605→                                                </p>\n  1606→                                            </div>\n  1607→                                            <div class=\"col-12 mt-3\">\n  1608→                                                <div class=\"row w-100 m-0\">${pruebas_plan}</div>\n  1609→                                            </div>\n  1610→                                            <div class=\"col-12 mt-3\">\n  1611→\n  1612→                                            </div>\n  1613→                                        </div>\n  1614→                                    </div>\n  1615→                                    <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n  1616→                                        ${opcion_editar}\n  1617→                                        ${crearBoton({\n  1618→                                            clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n  1619→                                            texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n  1620→                                            adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n  1621→                                        })}\n  1622→                                        ${acciones}\n  1623→                                    </div>\n  1624→                                </div>\n  1625→                                <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n  1626→                                    <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n  1627→                                        <div>\n  1628→                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n  1629→                                                <i class=\"bi bi-briefcase\"></i>&nbsp;\n  1630→                                                <span class=\"text-label-2\">Vacantes: ${planes[i].cantidad_ofertas_laborales !== null ? planes[i].cantidad_ofertas_laborales : ''}</span>\n  1631→                                            </p>\n  1632→                                        </div>\n  1633→                                        <div>\n  1634→                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n  1635→                                                <i class=\"bi bi-box\"></i>&nbsp;\n  1636→                                                <span class=\"text-label-2\">Unidades: ${planes[i].unidades !== null ? planes[i].unidades : ''}</span>\n  1637→                                            </p>\n  1638→                                        </div>\n  1639→                                        <div>\n  1640→                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n  1641→                                                <i class=\"bi bi-clock\"></i>&nbsp;\n  1642→                                                <span class=\"text-label-2\">Tiempo: ${planes[i].vigencia_dias !== null ? planes[i].vigencia_dias : ''} días</span>\n  1643→                                            </p>\n  1644→                                        </div>\n  1645→                                        ${planes[i].usuario ? `\n  1646→                                            <div class=\"col-auto\"><i class=\"bi bi-plus-circle\"></i> Creador:</div>\n  1647→                                            <div class=\"col-auto me-3 circulo-prueba\" style=\"background-image: url(/usuarios-imagen/${planes[i].usuario.id})\"\n  1648→                                                ${crearTooltip({\n  1649→                                                    placement: `top`,\n  1650→                                                    content: `${planes[i].usuario.nombres} ${planes[i].usuario.apellidos}`,\n  1651→                                                    toggle: `popover`,\n  1652→                                                })}>\n  1653→                                            </div>\n  1654→                                            <div class=\"col\">\n  1655→                                                <div class=\"row justify-content-end\">\n  1656→                                                    <div class=\"col-auto\">\n  1657→                                                        ${fecha_creacion}\n  1658→                                                        <span class=\"fw-bold ms-3\">${fecha_inicio}</span>\n  1659→                                                    </div>\n  1660→                                                </div>\n  1661→                                            </div>\n  1662→                                        ` : ''}\n  1663→                                    </div>\n  1664→                                    <div class=\"d-flex justify-content-end align-items-end pe-3\">\n  1665→                                        <p class=\"text-label-2 mb-0\">\n  1666→                                            <span class=\"text-gray-50 me-3\">${fecha_creacion}</span>\n  1667→                                            <span class=\"text-gray-30\">${fecha_inicio}</span>\n  1668→                                        </p>\n  1669→                                    </div>\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"837be9b8-f2fb-4651-ad77-5726166a3375","timestamp":"2026-01-25T01:55:29.030Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","content":" */\nfunction actualizarEnlacesPrevisualizacionArchivos(archivos_empresa, reiniciar_campo_archivo = true) {\n    // Oculta todos los elementos anchor de previsualización de archivos.\n    $('.previsualizacion-archivo').addClass('d-none');\n\n    // Muestra los elementos de previsualización de archivos que corresponden con los archivos\n    // relacionados con la empresa.\n    for (let i = 0; i < archivos_empresa.length; i++) {\n        $('#archivo_' + archivos_empresa[i].nombre).prop('href', `/archivos-abrir/${archivos_empresa[i].id}`);\n        $('#archivo_' + archivos_empresa[i].nombre).removeClass('d-none');\n\n        let input_archivo = $('#' + archivos_empresa[i].nombre + '.input-file.input-form');\n        let input_archivo_label = $('label[for=\"' + archivos_empresa[i].nombre + '\"].nombre-archivo');\n        let input_archivo_boton_eliminar = $('#boton-eliminar-archivo-' + archivos_empresa[i].nombre + '.eliminar-archivo');\n\n        if(reiniciar_campo_archivo) {\n            reiniciarCampoArchivo(input_archivo, input_archivo_label, input_archivo_boton_eliminar);\n        }\n    }\n}\n\nfunction mostrarPlanes() {\n    let empresa_id = empresa_seleccionada.id;\n    let buscar = $('#buscador-plan').val();\n    let filtro_tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        tabla_planes.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    let planes = empresa_seleccionada.planes;\n    if (planes.length > 0) {\n        for (let i = 0; i < planes.length; i++) {\n            if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n                continue;\n            }\n            if (\n                (filtro_tipo_prueba_id == 'Todos') ||\n                (filtro_tipo_prueba_id == '1' && planes[i].plan.tipo_prueba_id == 1) ||\n                (filtro_tipo_prueba_id == '2' && planes[i].plan.tipo_prueba_id == 2) ||\n                (filtro_tipo_prueba_id == '3' && planes[i].plan.tipo_prueba_id != 3)\n            ) {\n                let estado = obtenerEstadoPlan(\n                    planes[i].estado.id,\n                    planes[i].estado.nombre,\n                    planes[i].por_facturar,\n                    planes[i].renovando,\n                    null,\n                    planes[i].plan_proximo_id\n                );\n\n                let acciones = obtenerAcciones(\n                    planes[i].estado.id,\n                    planes[i].id, empresa_id,\n                    planes[i].plan.tipo_prueba_id,\n                    planes[i].plan.nombre,\n                    planes[i]?.archivos[0]?.id ?? '0',\n                    empresa_seleccionada.nombre_comercial\n                );\n\n                let modificado = '';\n                if (planes[i].plan_original == 0) {\n                    modificado = `<i class=\"bi bi-wrench me-3 text-blue-40\" ${crearTooltip({placement: 'top', content: 'Plan modificado', toggle: 'popover' })}></i>`;\n                }\n                let fecha_vencimiento = '';\n                if (planes[i].fecha_vencimiento != null) {\n                    fecha_vencimiento = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                }\n                let fecha_creacion = '';\n                if (planes[i].created_at != null) {\n                    fecha_creacion = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                }\n                let fecha_inicio = '';\n                if (planes[i].fecha_inicio != null) {\n                    fecha_inicio = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                }\n                let pruebas_plan = '';\n                if (planes[i].pruebas !== undefined) {\n                    let pruebas = planes[i].pruebas;\n                    for (let j = 0; j < pruebas.length; j++) {\n                        pruebas_plan += `\n                            <div\n                                class=\"col-auto me-3 circulo-prueba\"\n                                style=\"background-image: url(../imagenes/logos/pruebas/${slugify(planes[i].pruebas[j].nombre)}.png)\"\n                                ${crearTooltip({placement: 'top', content: planes[i].pruebas[j].nombre, toggle: 'popover' })}\n                            ></div>\n                        `;\n                    }\n                }\n                let icono = '';\n                let title = '';\n                if (planes[i].plan.tipo_prueba_id == 1) {\n                    title = 'Selección';\n                    icono = 'bi-person-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 2) {\n                    title = 'Organizacional';\n                    icono = 'bi-people-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 3) {\n                    title = 'Vocacional';\n                    icono = 'bi-mortarboard-fill';\n                }\n                let opcion_editar = `\n                    <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit'\">\n                        <i class=\"bi bi-pencil-fill\"></i>\n                    </button>\n                `;\n                if (planes[i]?.plan_proximo_id) {\n                    opcion_editar = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n                            <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                            <div class=\"dropdown-menu\">\n                                <a href=\"/empresas-planes/${planes[i].id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n                                <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n                            </div>\n                        </button>\n                    `;\n                }\n                $('#tbody-planes').append(`\n                    <tr>\n                        <td style=\"border-bottom: 0px!important;\">\n                            <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                    <div class=\"col\">\n                                        <div class=\"row align-items-center\">\n                                            <div class=\"col-auto mb-0\">\n                                                <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                    <i class=\"bi ${icono} me-3\" title=\"${title}\"></i> ${modificado} ${planes[i].plan.nombre}\n                                                </p>\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                ${estado}\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                    <i class=\"bi bi-person-fill\"></i>&nbsp;<span class=\"text-label-2\">${planes[i].cantidad_usuarios}&nbsp;${fecha_vencimiento}</span>\n                                                </p>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n                                                <div class=\"row w-100 m-0\">${pruebas_plan}</div>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n\n                                            </div>\n                                        </div>\n                                    </div>\n                                    <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                        ${opcion_editar}\n                                        ${crearBoton({\n                                            clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                            texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                            adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                        })}\n                                        ${acciones}\n                                    </div>\n                                </div>\n                                <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                    <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-briefcase\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Vacantes: ${planes[i].cantidad_ofertas_laborales !== null ? planes[i].cantidad_ofertas_laborales : ''}</span>\n                                            </p>\n                                        </div>\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-box\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Unidades: ${planes[i].unidades !== null ? planes[i].unidades : ''}</span>\n                                            </p>\n                                        </div>\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-clock\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Tiempo: ${planes[i].vigencia_dias !== null ? planes[i].vigencia_dias : ''} días</span>\n                                            </p>\n                                        </div>\n                                        ${planes[i].usuario ? `\n                                            <div class=\"col-auto\"><i class=\"bi bi-plus-circle\"></i> Creador:</div>\n                                            <div class=\"col-auto me-3 circulo-prueba\" style=\"background-image: url(/usuarios-imagen/${planes[i].usuario.id})\"\n                                                ${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `${planes[i].usuario.nombres} ${planes[i].usuario.apellidos}`,\n                                                    toggle: `popover`,\n                                                })}>\n                                            </div>\n                                            <div class=\"col\">\n                                                <div class=\"row justify-content-end\">\n                                                    <div class=\"col-auto\">\n                                                        ${fecha_creacion}\n                                                        <span class=\"fw-bold ms-3\">${fecha_inicio}</span>\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        ` : ''}\n                                    </div>\n                                    <div class=\"d-flex justify-content-end align-items-end pe-3\">\n                                        <p class=\"text-label-2 mb-0\">\n                                            <span class=\"text-gray-50 me-3\">${fecha_creacion}</span>\n                                            <span class=\"text-gray-30\">${fecha_inicio}</span>\n                                        </p>\n                                    </div>","numLines":200,"startLine":1470,"totalLines":3611}},"sourceToolAssistantUUID":"630cfe66-8d81-49f8-9763-c93990033d50"}
{"parentUuid":"837be9b8-f2fb-4651-ad77-5726166a3375","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VoRKaAs6v7DNckegg6rqgu","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito ver cómo se muestra el plan de créditos en la vista de planes del cliente para poder replicar el estilo. Voy a buscar el archivo `planes.js` para ver la implementación actual de la visualización de planes de créditos.","signature":"EpYDCkYICxgCKkDur86kj8rnpgpxii50IQRR4AYi34dYQEWHECDJ7F0FZT4n7ponY49xZQiy/RJL1vz7zQ81++vrEZXmGhsRNMpGEgx7g8MPOHyZ74962ukaDODwhiM47Kd2EV82mSIwkhCrEIYDLWCpVg4ddzBo0WAUa6F7UDUrycl1MYUP5zcIsF1ArVSx8zSEOh/zY+OLKv0BS4g/5rKN4wzE2VMWDb4byG4B162/RPl54bEEMzCPfe74uObteP3yL3boI/361euSbM99LPlfveAz0J1L+DkgP7zKxLIpt8jB03hQQ3mc8e/egUmxSDmE5C9XPHy77pYJNcXSIXMcegJwc1PqIANNQ6hQ6PvKAyElnu08r0JV30wmJr4dVNppNOLBipFEginD2NwB2cIMKrGnkCOjovC3ccpidwtDpwtEulZ2sEKM+/yqg9d9UFmPjA0MnHgRvI8EU427p+N3341MfCShar3alDg+Raqw+7Q0EXCxcqOUfPf+TftkSjI9ciB/LcBC3lBfOEk5mmo+dWcXXOnw5RgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":15554,"cache_read_input_tokens":55467,"cache_creation":{"ephemeral_5m_input_tokens":15554,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGGsFaGFGWaZch5GMu1","type":"assistant","uuid":"1bbe934c-37f9-431c-9ffa-a4265d94b7e3","timestamp":"2026-01-25T01:55:32.598Z"}
{"parentUuid":"1bbe934c-37f9-431c-9ffa-a4265d94b7e3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VoRKaAs6v7DNckegg6rqgu","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora necesito ver cómo se muestra el plan de créditos en la vista de planes del cliente para replicar el estilo."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":15554,"cache_read_input_tokens":55467,"cache_creation":{"ephemeral_5m_input_tokens":15554,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGGsFaGFGWaZch5GMu1","type":"assistant","uuid":"a552f40b-b2fe-4bc2-ba0f-a20152b7fc69","timestamp":"2026-01-25T01:55:33.127Z"}
{"parentUuid":"a552f40b-b2fe-4bc2-ba0f-a20152b7fc69","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VoRKaAs6v7DNckegg6rqgu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LyiDG4AyDwJdnG9NBTHBKG","name":"Grep","input":{"pattern":"plan_credito|créditos|creditos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\planes.js","output_mode":"content","-n":true,"head_limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":15554,"cache_read_input_tokens":55467,"cache_creation":{"ephemeral_5m_input_tokens":15554,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGGsFaGFGWaZch5GMu1","type":"assistant","uuid":"8f8b3aad-0e90-430f-b71f-d06e5e337ec7","timestamp":"2026-01-25T01:55:35.318Z"}
{"parentUuid":"8f8b3aad-0e90-430f-b71f-d06e5e337ec7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>Path does not exist: C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\planes.js</tool_use_error>","is_error":true,"tool_use_id":"toolu_01LyiDG4AyDwJdnG9NBTHBKG"}]},"uuid":"d03408d5-93a7-4056-af17-093427de1dc2","timestamp":"2026-01-25T01:55:35.333Z","toolUseResult":"Error: Path does not exist: C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\planes.js","sourceToolAssistantUUID":"8f8b3aad-0e90-430f-b71f-d06e5e337ec7"}
{"parentUuid":"d03408d5-93a7-4056-af17-093427de1dc2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_0151RPVDz9iSFWs4ZfDvx3h5","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El archivo no existe en esa ruta. Voy a buscar el archivo planes.js en todo el proyecto.","signature":"EoACCkYICxgCKkDMCQTUl/pHGnPlzev/FPX5My0vTMy35Jf8xfXNNKyEkhz7xBvU195e2XFohcefNOiPUoCpvDGZtX7bSPQXiyC3EgzB9fr4pwyUxYxb3DkaDCCsjjHHjyj+/PPZCSIwqg0guL65spCmVOuuJYd+iaciaoJmoke2hc/x4L+NV4vhSHJBf4VRPpHg7EZPF01uKmg5lHAXDPHsqYvJeZL21ZN+NKajjGz0aryt2roc+FQMbK/z9xG7dxGDylvxoo4CbmrEWviPbKgYg9cFd9yaP9TSZEXTjjGqXC0UNYmDXwE9uFZxNMN2MGv7P5x0DIKaVy5kM3gxrCjnQxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":342,"cache_read_input_tokens":71021,"cache_creation":{"ephemeral_5m_input_tokens":342,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGHKiHhyZxvTj9pmDRr","type":"assistant","uuid":"b9809251-be26-487c-b6e6-a7cd94c7dde1","timestamp":"2026-01-25T01:55:37.568Z"}
{"parentUuid":"b9809251-be26-487c-b6e6-a7cd94c7dde1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_0151RPVDz9iSFWs4ZfDvx3h5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XWAmp7Tp1hrmf5LFuWj8G6","name":"Glob","input":{"pattern":"**/planes*.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":342,"cache_read_input_tokens":71021,"cache_creation":{"ephemeral_5m_input_tokens":342,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGHKiHhyZxvTj9pmDRr","type":"assistant","uuid":"68100220-38ca-45bd-b7d1-0eec80cce56d","timestamp":"2026-01-25T01:55:37.823Z"}
{"parentUuid":"68100220-38ca-45bd-b7d1-0eec80cce56d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XWAmp7Tp1hrmf5LFuWj8G6","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\planes\\planes.js\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js"}]},"uuid":"433f2061-084a-4080-8d69-78b040bbd803","timestamp":"2026-01-25T01:55:39.381Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\planes\\planes.js","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js"],"durationMs":842,"numFiles":2,"truncated":false},"sourceToolAssistantUUID":"68100220-38ca-45bd-b7d1-0eec80cce56d"}
{"parentUuid":"433f2061-084a-4080-8d69-78b040bbd803","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_0135b8a2Eu92w99sKePh6bfx","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Hay dos archivos planes.js. El plan mencionaba `planes.js` líneas 180-244, así que voy a leer el archivo en `public/js/empresa/planes/planes.js` que parece ser el correcto para la vista de empresa.","signature":"EvACCkYICxgCKkDL5eRgM7DppRvWscza+QRwiId46UwFCVSrtfqX+RCijAM3gqkNk/fXxqsIeyhc4sKY/wmVbwRJQzPCYtfGrPZyEgxW6+SzMMdScoE0hSQaDKCswY/6QT32sX3ikyIwKiaYtkJTY51IPJpyf8kh6wTVbOoPhoIf9XPNPS0/Fdxey/KxbNFMp32kGK79gWf2KtcBwsFk6JaaEDwY9kq6ExKiggS5wwHiDlicsKSsIKG+BugJ4ZMJdzhk+OqIaoWM1y+Y0UTvqnnYg+jqyw0UmJp1X9Vsx7heuojepx4f+QSNpzbvrI5fR4ixbZT8ZbO5DGcbcDuBORAOmitfhfKrzaVoxl0mRbOPUjTJjPNRNM/FzhpTHybS+hHOrNLmQZ1SspIKLghXx7dvp4vF/rApo44Rsj1TJ4RF8ylvuy6i/4kDYYLeAd6Lp4f1PbSWN/bkylpn8F6uldsPTAvEiIjrIdagqG8JHl6V/jIYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":168,"cache_read_input_tokens":71363,"cache_creation":{"ephemeral_5m_input_tokens":168,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGHd2b5z6BduxshGY8g","type":"assistant","uuid":"6dfd2002-2239-4eba-9560-98e56a4be91b","timestamp":"2026-01-25T01:55:43.071Z"}
{"parentUuid":"6dfd2002-2239-4eba-9560-98e56a4be91b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_0135b8a2Eu92w99sKePh6bfx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0111F2srpyGpv8ntJfPyvLdm","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","offset":160,"limit":150}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":168,"cache_read_input_tokens":71363,"cache_creation":{"ephemeral_5m_input_tokens":168,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGHd2b5z6BduxshGY8g","type":"assistant","uuid":"f9653564-287c-4b24-8f5f-d6d3ed459486","timestamp":"2026-01-25T01:55:43.806Z"}
{"parentUuid":"f9653564-287c-4b24-8f5f-d6d3ed459486","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0111F2srpyGpv8ntJfPyvLdm","type":"tool_result","content":"   160→                            </tbody>\n   161→                        </table>\n   162→                    </div>\n   163→                    <div class=\"row mt-5\">\n   164→                        <div class=\"col-auto\">\n   165→                            <p class=\"text-label-2\">\n   166→                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n   167→                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n   168→                            </p>\n   169→                        </div>\n   170→                        <div class=\"col-auto ms-auto\">\n   171→                            <p class=\"text-label-2\">\n   172→                                <span class=\"me-4\">Vigencia</span>\n   173→                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n   174→                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n   175→                            </p>\n   176→                        </div>\n   177→                    </div>\n   178→                </div>\n   179→            </div>\n   180→        ` : `\n   181→            <div class=\"card my-5\">\n   182→                <div class=\"card-body\">\n   183→                    <div class=\"row\">\n   184→                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n   185→                        <div class=\"col-auto my-auto\">\n   186→                            <p class=\"m-0 text-body-3\"><img src=\"/iconos/icono_ia_azul.svg\" alt=\"IA\" class=\"me-2\">Plan de Créditos</p>\n   187→                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n   188→                        </div>\n   189→                        <div class=\"col-auto ms-auto my-auto\">\n   190→                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n   191→                        </div>\n   192→                        <div class=\"col-auto my-auto\">\n   193→                            <div class=\"dropdown\">\n   194→                                ${crearBoton({\n   195→                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n   196→                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n   197→                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n   198→                                })}\n   199→                                <div class=\"dropdown-menu dropdown-menu-start\">\n   200→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}', 'plan_credito')\">\n   201→                                        Solicitar renovación\n   202→                                    </button>\n   203→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n   204→                                        Ver factura\n   205→                                    </button>\n   206→                                </div>\n   207→                            </div>\n   208→                        </div>\n   209→                    </div>\n   210→                    <div class=\"row mt-4\">\n   211→                        <div class=\"col-12\">\n   212→                            <div class=\"card bg-gray-90 border-0\">\n   213→                                <div class=\"card-body py-3\">\n   214→                                    <div class=\"row\">\n   215→                                        <div class=\"col-auto my-auto\">\n   216→                                            ${crearBoton({\n   217→                                                clases: 'btn-text-gray text-label-2',\n   218→                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   219→                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   220→                                            })}\n   221→                                        </div>\n   222→                                        <div class=\"col my-auto\">\n   223→                                            ${crearProgressBarTemplate('Créditos disponibles', '/iconos/icono_ia.svg', empresa_plan.creditos_consumidos ?? 0, empresa_plan.plan_credito.creditos ?? 0, true)}\n   224→                                        </div>\n   225→                                        <div class=\"col-auto my-auto ps-0\">\n   226→                                            ${crearBoton({\n   227→                                                tooltip: `${crearTooltip({\n   228→                                                    placement: `top`,\n   229→                                                    content: `Ver detalle consumo`,\n   230→                                                    toggle: `popover`,\n   231→                                                })}`,\n   232→                                                clases: 'btn-text-primary btn-circle p-2',\n   233→                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   234→                                                onclick: `abrirModalConsumosCreditos(${empresa_plan.empresa_id}, ${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}')`,\n   235→                                            })}\n   236→                                        </div>\n   237→                                    </div>\n   238→                                </div>\n   239→                            </div>\n   240→                        </div>\n   241→                    </div>\n   242→                </div>\n   243→            </div>\n   244→        `;\n   245→    }).join('');\n   246→\n   247→    $('#listado-planes').html(contenidoHTML);\n   248→    inicializarTooltips();\n   249→}\n   250→\n   251→/**\n   252→ * Crea el componente HTML de los progress bars de los consumos.\n   253→ *\n   254→ * @param {string} label Etiqueta del progress bar.\n   255→ * @param {string} icono Icono del progress bar.\n   256→ * @param {number} valor Valor actual del consumo.\n   257→ * @param {number} total Valor total del consumo.\n   258→ * @param {boolean} un_text Booleano para mostrar o no el texto.\n   259→ * @returns {string} HTML del progress bar.\n   260→ * @author Andres Morales\n   261→ * @author Andres Gonzalez\n   262→ */\n   263→function crearProgressBarTemplate(label, icono, valor, total, un_text) {\n   264→    let icono_html = '';\n   265→    if (icono) {\n   266→        if (icono.startsWith('/') || icono.includes('.svg')) {\n   267→            icono_html = `<img src=\"${icono}\" alt=\"${label}\" class=\"me-2\">`;\n   268→        } else {\n   269→            icono_html = `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>`;\n   270→        }\n   271→    }\n   272→    return `\n   273→        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono_html}${label}${un_text ? '</p>' : ''}\n   274→        ${crearProgressBar({\n   275→            label: `${valor}/${total ?? 0}`,\n   276→            height: '8px',\n   277→            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n   278→        })}\n   279→    `;\n   280→}\n   281→\n   282→/**\n   283→ * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n   284→ *\n   285→ * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n   286→ * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n   287→ * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n   288→ * @returns {string}\n   289→ * @author Andres Morales\n   290→ * @author Fahibram Cárcamo\n   291→ * @author Sergio Vargas\n   292→ */\n   293→function listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n   294→    if (!empresa_plan.plan) {\n   295→        return '';\n   296→    }\n   297→    return sucursales.map(sucursal => {\n   298→        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n   299→        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n   300→\n   301→        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n   302→            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n   303→            ?.conteo_consumos ?? 0;\n   304→\n   305→        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n   306→            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n   307→            ?.conteo_consumos ?? 0;\n   308→\n   309→        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"88bf341a-ce0a-4081-8b12-384c36419ba3","timestamp":"2026-01-25T01:55:44.666Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","content":"                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><img src=\"/iconos/icono_ia_azul.svg\" alt=\"IA\" class=\"me-2\">Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}', 'plan_credito')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', '/iconos/icono_ia.svg', empresa_plan.creditos_consumidos ?? 0, empresa_plan.plan_credito.creditos ?? 0, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Ver detalle consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumosCreditos(${empresa_plan.empresa_id}, ${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.\n * @param {number} total Valor total del consumo.\n * @param {boolean} un_text Booleano para mostrar o no el texto.\n * @returns {string} HTML del progress bar.\n * @author Andres Morales\n * @author Andres Gonzalez\n */\nfunction crearProgressBarTemplate(label, icono, valor, total, un_text) {\n    let icono_html = '';\n    if (icono) {\n        if (icono.startsWith('/') || icono.includes('.svg')) {\n            icono_html = `<img src=\"${icono}\" alt=\"${label}\" class=\"me-2\">`;\n        } else {\n            icono_html = `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>`;\n        }\n    }\n    return `\n        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono_html}${label}${un_text ? '</p>' : ''}\n        ${crearProgressBar({\n            label: `${valor}/${total ?? 0}`,\n            height: '8px',\n            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n        })}\n    `;\n}\n\n/**\n * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n *\n * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {string}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n * @author Sergio Vargas\n */\nfunction listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    if (!empresa_plan.plan) {\n        return '';\n    }\n    return sucursales.map(sucursal => {\n        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n\n        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);","numLines":150,"startLine":160,"totalLines":507}},"sourceToolAssistantUUID":"f9653564-287c-4b24-8f5f-d6d3ed459486"}
{"parentUuid":"88bf341a-ce0a-4081-8b12-384c36419ba3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01917JyKYixfbNqgdYgXJnFd","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora tengo una buena comprensión de cómo se muestran los planes de créditos en la vista de empresa (planes/planes.js líneas 180-244). Ahora puedo implementar los cambios.\n\nResumiendo los cambios necesarios:\n\n1. **Backend - EmpresaPlanRepository.php**: Agregar método `planesCreditosActivos()` para obtener todos los planes de créditos activos de una empresa (donde plan_id es NULL y plan_credito_id no es NULL).\n\n2. **Backend - EmpresaPlanService.php**: Agregar método `obtenerPlanesCreditosActivos()` que llame al repositorio.\n\n3. **Backend - EmpresaService.php**: Modificar `getUno()` para incluir los planes de créditos después del foreach de tipos_pruebas.\n\n4. **Frontend - empresas.js**: Modificar `mostrarPlanes()` para renderizar también los planes de créditos.\n\nVoy a implementar estos cambios uno por uno.","signature":"Et0HCkYICxgCKkD1DO+rB2ByvomgtIvjXg3YKfEtXGkJTpwKDf5FeiYHW7irT2SU05vKqMzwATxnZM/HGyjn2OqlbTycC3DkkxIsEgzAvJrJTGQRC0u5XgYaDL2ge4g0XgIdteBaiyIwmh4c3gowAaDkch+ISXerrNpw3qHUxv0iq0oVu2x6xCuxOShfOaCjo6aE/7gbq+gGKsQGKAqJ6nLEdX9PCitVS0enwvGFBlzVuTYYOZV7zcclftF/Xq08b9qGu0qpEs9SPcojrTcJvrpZgjWE4HH6Ovbqsy9cVPave35fQb+SI9ELv2MJl8nsEeZZwsjp90dIgwRKeJRX9peENCXrCQ/I7hxVi50J3xOecCoeyD/En2yQcV076xpV3jPlQrIda9ifNUxJ1ZoMq3B/53GxfQapfp86tt7t+ciRdvEl9A7q7gyhsyeGmmarDYjLgOeHIcEgAvfYehFGT9h2aRMG0lU/FU2oQhVPdy/0O60aFHhWnm6sU8fzCmOraEaXeJBKR0pAqH4O9XOgpyNCoU0E98djGgJKYTszFBp+yUavSXLwwjLQ/BODOgEa2Mbii7Pqb4bh4d7DruKe19c+ABPgKgOPDbzV7yZxC0PlwACywku+YuFQOk1pfnyVkaDk1ju08t3IWdbn/3AKZYmmaQp6C4Im4HiXQsZwB/Xk45dty4hHN674/6vb+vnqIH5irTDbvTJLUR3gGo2w3w5aEDEfcfLQAiWmMrrfjQqPTb6zu3hADBqKbZGNTzj/O8idA8yBwqJtvdKSZKE+WdnCZAv8etWsiJVphWoiI0D7r9XzynD0/BfWQCKyN3Z4Y2ZIgrswnKN/74oz/eiKuOpNgqJNKbCjWD4hboQKvjnfJOpj0LoK8Bnc2ALzY4/jBt7ZgoU7ht7fCHwVkml6y1dwODyXlBa1dNl68jnQmzUSi8rh1jqV91mu3ZH4oHXhfVjILrGLv0RN9TsUVazR6fLjzSVMRSY3BhLtf/OLOZq0MIp+j6lw05F8Q0CfHmNc3aXVq96K0Bldt9+xDRJ5gwXrDLRzivEYIeRMx0RPVhT+lywqkv4mR5PBurdZZCGWsa+XplayHpUt17dVWil9T4P7ThyINENMt9QM2XwegHj6IB1ROHwW0q7fq+8eRV5R/gFqVhVlLxub+yQ+j3BVZwCg8BvjXX73C9Eybk7oWOWw72Ufe1jHER66nemgt7dnRjhPem+raUpQiLp+CcWTnPAF4qas8oRCo1FRSPdja8vEPHuKmM70ygG7bW3gE2z7KLOmkHtkD5ENlvXNzHjJu0DzaISILn9QSofPzUmpBWIYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3303,"cache_read_input_tokens":71531,"cache_creation":{"ephemeral_5m_input_tokens":3303,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGJ289SuMarYV2Pz8sG","type":"assistant","uuid":"fdd15117-5bff-404f-b20b-96258ab0e8b2","timestamp":"2026-01-25T01:55:53.385Z"}
{"parentUuid":"fdd15117-5bff-404f-b20b-96258ab0e8b2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01917JyKYixfbNqgdYgXJnFd","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora tengo toda la información necesaria. Voy a implementar los cambios según el plan.\n\n**Paso 1:** Agregar el método `planesCreditosActivos()` en EmpresaPlanRepository.php"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3303,"cache_read_input_tokens":71531,"cache_creation":{"ephemeral_5m_input_tokens":3303,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGJ289SuMarYV2Pz8sG","type":"assistant","uuid":"de682a9b-85c5-409e-a5f9-af4fcec44aaf","timestamp":"2026-01-25T01:55:54.336Z"}
{"parentUuid":"de682a9b-85c5-409e-a5f9-af4fcec44aaf","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01917JyKYixfbNqgdYgXJnFd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DX6SnytEEKjMNrvvnJ1ADW","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","old_string":"    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {","new_string":"    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function planesCreditosActivos(int $empresa_id): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'created_at')\n            ->with([\n                'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'archivos' => function ($archivos) {\n                    $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                        ->orderBy('created_at', 'DESC');\n                }\n            ])\n            ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n            ->where('empresa_id', $empresa_id)\n            ->whereNull('plan_id')\n            ->whereNotNull('plan_credito_id')\n            ->whereIn('estado_id', [1, 4])\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3303,"cache_read_input_tokens":71531,"cache_creation":{"ephemeral_5m_input_tokens":3303,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGJ289SuMarYV2Pz8sG","type":"assistant","uuid":"1422fba0-16f7-4c4b-9c41-009117c538ea","timestamp":"2026-01-25T01:56:03.432Z"}
{"type":"file-history-snapshot","messageId":"1422fba0-16f7-4c4b-9c41-009117c538ea","snapshot":{"messageId":"63bb9be8-d7a7-44c3-a952-0d4f526fba4f","trackedFileBackups":{"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"1ef8fbba46b68267@v1","version":1,"backupTime":"2026-01-25T01:56:04.149Z"}},"timestamp":"2026-01-25T01:55:13.782Z"},"isSnapshotUpdate":true}
{"parentUuid":"1422fba0-16f7-4c4b-9c41-009117c538ea","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DX6SnytEEKjMNrvvnJ1ADW","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php has been updated successfully."}]},"uuid":"6598e6ba-1cc0-4fc3-8dc6-5e30d1c65a68","timestamp":"2026-01-25T01:56:04.147Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","oldString":"    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {","newString":"    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function planesCreditosActivos(int $empresa_id): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'created_at')\n            ->with([\n                'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'archivos' => function ($archivos) {\n                    $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                        ->orderBy('created_at', 'DESC');\n                }\n            ])\n            ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n            ->where('empresa_id', $empresa_id)\n            ->whereNull('plan_id')\n            ->whereNotNull('plan_credito_id')\n            ->whereIn('estado_id', [1, 4])\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {","originalFile":"<?php\n\nnamespace App\\Http\\Repositories\\Empresas;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Repositories\\BaseRepository;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n\nclass EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n{\n    /**\n     * Ids de los roles de tipo empresa.\n     *\n     * @var array\n     * @author Fahibram Cárcamo\n     */\n    private const IDS_ROLES_TIPO_EMPRESA = [\n        RolRepository::ROL_PROPIETARIO_ID,\n        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n        RolRepository::ROL_EVALUADOR_ID\n    ];\n\n    private $consulta_conteo_total_usuarios_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(EmpresaPlan $modelo) {\n        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n            (\n                SELECT COUNT(DISTINCT eu.usuario_id)\n                FROM empresas_usuarios AS eu\n                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n            ) AS conteo_total_usuarios_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.agenda_id IS NOT NULL\n            ) AS conteo_total_consumos_agendas_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.oferta_laboral_id IS NOT NULL\n            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n        ';\n\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener todos los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function getTodo(Request $request): Collection {\n        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n            'empresa:id,empresa_id,nombre_comercial,razon_social',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,predeterminado',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n            $query->with([\n                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with(['empresa' => function ($empresa) {\n                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n                        }])\n                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n                },\n                'consumos.agenda:id,prueba_id',\n                'consumos.agenda.prueba:id,nombre,slug'\n            ]);\n        })\n        ->when($con_conteo_consumos_agendas, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n        })\n        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($con_conteo_consumos_creditos, function ($consulta) {\n            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n            $query->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n            });\n        })\n        ->when($request->filled('plan_id'), function ($query) use ($request) {\n            $query->where('plan_id', $request->plan_id);\n        })\n        ->when(\n            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n            function ($query) use ($request) {\n                $query->whereIn($request->campo, $request->valores);\n            }\n        )\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estado_id);\n        })\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($subconsulta) {\n                $subconsulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n            ])\n            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n            ->when(\n                $request->filled('tipo_prueba_id'),\n                function ($consulta) use ($request) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n                },\n                function ($consulta) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                        TipoPrueba::SELECCION_ID,\n                        TipoPrueba::ORGANIZACIONAL_ID,\n                        TipoPrueba::VOCACIONAL_ID\n                    ]));\n                }\n            )\n            ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($sub_consulta) {\n                $sub_consulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'funcionalidades:id,nombre,predeterminado',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n                'consumos' => function ($consumos) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with([\n                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n                            'agenda:id,prueba_id',\n                            'agenda.prueba:id,nombre,slug'\n                        ]);\n                }\n            ])\n            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            })\n            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n            })\n            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n                    $sub_consulta->where('empresa_id', $request->empresa_id)\n                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n                        });\n                });\n            })\n            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n            }, function ($consulta) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                    TipoPrueba::SELECCION_ID,\n                    TipoPrueba::ORGANIZACIONAL_ID,\n                    TipoPrueba::VOCACIONAL_ID\n                ]));\n            })\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener datos básicos de los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     * @author Sergio Vargas\n     */\n    public function getDatosBasicos(Request $request): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'planCredito:id,nombre,creditos',\n            'consumosCreditos'\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n            $sentido = $request->ordenar_sentido ?? 'ASC';\n            $consulta->orderBy($request->ordenar_por, $sentido);\n        })\n        ->get();\n    }\n\n    /**\n     * Obtener el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planProximoCreditos(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with(['planCredito:id,nombre,creditos,precio'])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereNotNull('plan_credito_id')\n        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n            $query->where(function ($q) use ($tipo_prueba_id) {\n                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n                  ->orWhereNull('plan_id');\n            });\n        })\n        ->orderBy('created_at', 'ASC')\n        ->first();\n    }\n\n    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->whereIn('estado_id', [1, 4])\n        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n            $query->where(function ($q) use ($tipo_prueba_id) {\n                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n                  ->orWhereNull('plan_id');\n            });\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'funcionalidades:id,nombre,llave,valor',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->find($id);\n    }\n\n    /**\n     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n     *\n     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author José Manuel Jiménez\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])\n        ->first();\n    }\n\n    /**\n     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener el último plan asignado.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->where('estado_id', $request->estado_id);\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n    }\n\n    /**\n     * Sincronizar pruebas.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $pruebas ID's de las pruebas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n        $empresa_plan->pruebas()->sync($pruebas);\n    }\n\n    /**\n     * Sincronizar funcionalidades.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $funcionalidades ID's de las funcionalidades.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n        $empresa_plan->funcionalidades()->sync($funcionalidades);\n    }\n\n    /**\n     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return ?EmpresaPlan\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,llave,valor'\n        ])\n        ->when(\n            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            }\n        )\n        ->when(\n            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n            }\n        )\n        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n        ->first();\n    }\n\n    /**\n     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n     *\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author José Manuel Jiménez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function datosConsumosEmpresas(Request $request): Collection {\n        $roles_tipo_empresa_ids = [\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID\n        ];\n\n        $matriz_conteos = [\n            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n                'empresasUsuarios',\n                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n            )\n        ];\n\n        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw('\n                    (\n                        SELECT COUNT(DISTINCT eu.usuario_id)\n                        FROM empresas_usuarios AS eu\n                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n                    ) AS conteo_total_usuarios_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.agenda_id IS NOT NULL\n                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.oferta_laboral_id IS NOT NULL\n                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n                '),\n            ])\n            ->with([\n                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n                    $consulta_empresa->select($campos_empresas)\n                        ->whereNull('empresa_id')\n                        ->withCount([\n                            ...$matriz_conteos,\n                            'sucursales as conteo_sucursales'\n                        ])\n                        ->with([\n                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n                            }\n                        ]);\n                }\n            ])\n            ->when(\n                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n            )\n            ->whereNotIn('estado_id', [3, 8])\n            ->when(\n                $request->filled('prueba_id'),\n                fn($consulta) => $consulta->whereHas(\n                    'pruebas',\n                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n                )\n            )\n            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n            })\n            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta_plan_por->whereNotNull('unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n                        break;\n                }\n            })\n            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_vencimiento;\n                $fecha_fin    = $request->fecha_vencimiento;\n\n                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_inicio;\n                $fecha_fin    = $request->fecha_inicio;\n\n                if (strpos($request->fecha_inicio, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_inicio);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when(\n                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n            )\n            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n                if ($request->tipo_activacion === 'compra') {\n                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                } elseif ($request->tipo_activacion === 'recompra') {\n                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                }\n            })\n            ->get();\n    }\n\n    /**\n     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     */\n    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n        return $this->modelo::select(\n            'empresas_planes.id',\n            'empresas_planes.empresa_id',\n            'empresas_planes.plan_id',\n            'empresas_planes.plan_credito_id',\n            'empresas_planes.usuario_id',\n            'empresas_planes.estado_id',\n            'empresas_planes.unidades',\n            'empresas_planes.cantidad_ofertas_laborales',\n            'empresas_planes.cantidad_usuarios',\n            'empresas_planes.cantidad_pruebas',\n            'empresas_planes.creditos',\n            'empresas_planes.fecha_inicio',\n            'empresas_planes.fecha_vencimiento',\n            'empresas_planes.precio',\n            'empresas_planes.porcentaje_descuento',\n            'empresas_planes.numero_factura',\n            'empresas_planes.comentario',\n            'empresas_planes.plan_original',\n            'empresas_planes.renovando',\n            'empresas_planes.por_facturar',\n            'empresas_planes.created_at',\n            'planes.id',\n            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n            'planes.nombre AS plan_nombre',\n            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n            'planes.unidades AS plan_unidades',\n            'planes.vigencia AS plan_vigencia',\n            'planes.precio AS plan_precio',\n            'tipos_pruebas.id AS tipo_prueba_id',\n            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n            'estados_planes.id AS estado_plan_id',\n            'estados_planes.nombre AS estado_plan_nombre',\n            'users.id AS usuario_usuario_id',\n            'users.nombres AS usuario_nombres',\n            'users.apellidos AS usuario_apellidos',\n            'empresas.id AS empresa_empresa_id',\n            'empresas.empresa_id',\n            'empresas.nombre_comercial AS empresa_nombre_comercial',\n            'empresas.razon_social AS empresa_razon_social',\n            'empresas.nombre_contacto',\n            'empresas.celular_contacto',\n            'empresas.email_contacto',\n            'empresas.telefono_contacto',\n            'empresas.extension_contacto',\n            'empresas.nombre_tesorero',\n            'empresas.celular_tesorero',\n            'empresas.telefono_tesorero',\n            'empresas.email_tesorero',\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n                )\n                AS conteo_consumos_agendas\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n                )\n                AS conteo_consumos_ofertas_laborales\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM empresas\n                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n                )\n                AS conteo_sucursales\n            '),\n            DB::raw('\n                (\n                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n                    FROM empresas AS sucursales\n                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n                )\n                AS nombres_comerciales_sucursales\n            ')\n        )\n        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n        ->whereNull('empresas.empresa_id')\n        ->when(\n            $request->filled('plan_por'),\n            function ($consulta) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta->whereNotNull('empresas_planes.unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n                        break;\n                }\n            }\n        )\n        ->when(\n            $request->filled('tipo_prueba_id'),\n            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n                TipoPrueba::SELECCION_ID,\n                TipoPrueba::ORGANIZACIONAL_ID,\n                TipoPrueba::VOCACIONAL_ID\n            ])\n        )\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n        ->when(\n            $request->filled('ejecutivo_id'),\n            function ($consulta) use ($request) {\n                $consulta->whereExists(function ($subconsulta) use ($request) {\n                    $subconsulta->select(DB::raw(1))\n                        ->from('empresas_usuarios')\n                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n                });\n            }\n        )\n        ->when(\n            $request->filled('fecha_vencimiento'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n        )\n        ->when(\n            $request->filled('fecha_inicio'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n        )\n        ->when(\n            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n        )\n        ->get();\n    }\n\n    /**\n     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        return $this->modelo::select(\n            'id',\n            'empresa_id',\n            'plan_credito_id',\n            'estado_id',\n            'creditos',\n            'fecha_inicio',\n            'fecha_vencimiento',\n            'precio',\n            'porcentaje_descuento',\n            'numero_factura',\n            'comentario',\n            'created_at'\n        )\n        ->with([\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                    ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n}\n","structuredPatch":[{"oldStart":367,"oldLines":6,"newStart":367,"newLines":33,"lines":["     }"," ","     /**","+     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).","+     *","+     * @param int $empresa_id ID de la empresa.","+     * @return Collection","+     * @author Sergio Vargas","+     */","+    public function planesCreditosActivos(int $empresa_id): Collection {","+        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'created_at')","+            ->with([","+                'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',","+                'estado:id,nombre',","+                'usuario:id,nombres,apellidos',","+                'archivos' => function ($archivos) {","+                    $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')","+                        ->orderBy('created_at', 'DESC');","+                }","+            ])","+            ->withSum('consumosCreditos as creditos_consumidos', 'creditos')","+            ->where('empresa_id', $empresa_id)","+            ->whereNull('plan_id')","+            ->whereNotNull('plan_credito_id')","+            ->whereIn('estado_id', [1, 4])","+            ->orderBy('created_at', 'DESC')","+            ->get();","+    }","+","+    /**","      * Obtener el plan de creditos activo de la empresa.","      *","      * @param int $empresa_id ID de la empresa."]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"1422fba0-16f7-4c4b-9c41-009117c538ea"}
{"parentUuid":"6598e6ba-1cc0-4fc3-8dc6-5e30d1c65a68","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_013X7S4A4rDuG9vCmTE1suMj","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora voy a agregar el método `obtenerPlanesCreditosActivos()` en EmpresaPlanService.php","signature":"EoECCkYICxgCKkCwihhCtyv9jwa9HpJD5LnXoRRmtfZA+DLdcYM0+oB1gn3a6Tlf6RRu++RICU1xPqAxhADdKRcSaucu6yDolg6JEgxobhkDm7Jk1dmyA/8aDIGZ7yzw+JChRX7EaCIwbWX7nm9FNiwIR/hZlYmM0H2iMMVpUZF2HXa40nFLMG5BaLDmHhVBChMj3S+hK1z9KmndDgMouBr1puZQBxfRZ4hSXUt5Hng0mDq8lpU+Z71tdjkO7M4s5QYO1r/i4BByTVxp4RQLh1qFSKBaSDAufjY0J6wrcy4my7COIP5qYUtattyiq6nmWb6zltqTiuxZ/hgXV8b3cr4j88UYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1179,"cache_read_input_tokens":74834,"cache_creation":{"ephemeral_5m_input_tokens":1179,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXTGKTWec2UuiWEy8WyWt","type":"assistant","uuid":"f0509d95-5ef2-44c3-83b5-54a6256e06ed","timestamp":"2026-01-25T01:56:06.547Z"}
{"parentUuid":"f0509d95-5ef2-44c3-83b5-54a6256e06ed","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_013X7S4A4rDuG9vCmTE1suMj","type":"message","role":"assistant","content":[{"type":"text","text":"**Paso 2:** Agregar el método `obtenerPlanesCreditosActivos()` en EmpresaPlanService.php"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1179,"cache_read_input_tokens":74834,"cache_creation":{"ephemeral_5m_input_tokens":1179,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXTGKTWec2UuiWEy8WyWt","type":"assistant","uuid":"74e3d892-62ab-4b3d-95ae-5781e496b75b","timestamp":"2026-01-25T01:56:06.857Z"}
{"parentUuid":"74e3d892-62ab-4b3d-95ae-5781e496b75b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_013X7S4A4rDuG9vCmTE1suMj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Sf1XuuDGs4NhDjYxzrNk8J","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {","new_string":"    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n        return $this->repositorio->planesCreditosActivos($empresa_id);\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1179,"cache_read_input_tokens":74834,"cache_creation":{"ephemeral_5m_input_tokens":1179,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXTGKTWec2UuiWEy8WyWt","type":"assistant","uuid":"29b38322-8b17-4852-9b51-e78136ad9143","timestamp":"2026-01-25T01:56:11.179Z"}
{"type":"file-history-snapshot","messageId":"29b38322-8b17-4852-9b51-e78136ad9143","snapshot":{"messageId":"63bb9be8-d7a7-44c3-a952-0d4f526fba4f","trackedFileBackups":{"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"1ef8fbba46b68267@v1","version":1,"backupTime":"2026-01-25T01:56:04.149Z"},"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"87ffcf5aa4ef1291@v1","version":1,"backupTime":"2026-01-25T01:56:11.952Z"}},"timestamp":"2026-01-25T01:55:13.782Z"},"isSnapshotUpdate":true}
{"parentUuid":"29b38322-8b17-4852-9b51-e78136ad9143","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Sf1XuuDGs4NhDjYxzrNk8J","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated successfully."}]},"uuid":"30ccafd2-f715-4a48-bafb-b790528bb88a","timestamp":"2026-01-25T01:56:11.950Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {","newString":"    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n        return $this->repositorio->planesCreditosActivos($empresa_id);\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $tiene_plan_seleccion = $request->filled('plan_id');\n        $tiene_plan_creditos  = $request->filled('plan_credito_id');\n        $plan_asignado        = null;\n\n        // Si tiene plan de selección, crear/actualizar ese plan\n        if ($tiene_plan_seleccion) {\n            $plan_asignado = $this->guardarPlanSeleccion($request);\n        }\n\n        // Si tiene plan de créditos, crear ese plan por separado\n        if ($tiene_plan_creditos) {\n            $plan_creditos = $this->guardarPlanCreditos($request);\n\n            // Si no había plan de selección, retornar el de créditos\n            if (!$tiene_plan_seleccion) {\n                $plan_asignado = $plan_creditos;\n            }\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Guardar un plan de selección.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Andres Gonzalez\n     */\n    protected function guardarPlanSeleccion(Request $request): EmpresaPlan {\n        $enviar_correo    = false;\n        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades', 'precio_creditos', 'porcentaje_descuento_creditos', 'plan_credito_id', 'creditos'];\n        $plan             = $this->plan_repositorio->getUno($request->plan_id);\n        $plan_activo      = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n        $vigencia         = $plan->vigencia;\n\n        if ($request->filled('vigencia')) {\n            $vigencia = $request->vigencia;\n        }\n\n        if (!is_null($plan_activo)) {\n            if ($request->filled('id')) {\n                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                if ($request->id === $plan_activo->id) {\n                    goto omitir_calcular_vigencia_seleccion;\n                }\n\n                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                if ($vigencia == $request->vigencia) {\n                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                    goto omitir_calcular_vigencia_seleccion;\n                }\n            }\n\n            // Poner el nuevo plan como proximo\n            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n\n            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                // Agregar las nuevas fechas al nuevo plan\n                $hoy          = now();\n                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n            }\n        } else {\n            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n\n            // Validar si el plan seleccionado tiene vigencia\n            if (!is_null($plan->vigencia)) {\n                $request->merge($this->calcularFechasVigencia($vigencia));\n            }\n        }\n\n        omitir_calcular_vigencia_seleccion:\n\n        if (!$request->filled('unidades')) {\n            $request->merge(['unidades' => $plan->unidades]);\n        } elseif ($request->unidades != $plan->unidades) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_ofertas_laborales')) {\n            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_usuarios')) {\n            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_pruebas')) {\n            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        // Comprobar si se modificaron las funcionalidades respecto al plan original\n        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n\n            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                $request->merge(['plan_original' => false]);\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($enviar_correo) {\n            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario      = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n            $titulo       = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Guardar un plan de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Andres Gonzalez\n     */\n    protected function guardarPlanCreditos(Request $request): EmpresaPlan {\n        $enviar_correo = false;\n        $plan_credito  = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n        $plan_activo   = $this->repositorio->planCreditosActivo($request->empresa_id);\n\n        // Preparar datos para el plan de créditos\n        $datos_creditos = [\n            'empresa_id'            => $request->empresa_id,\n            'plan_id'               => null,\n            'plan_credito_id'       => $request->plan_credito_id,\n            'creditos'              => $plan_credito->creditos ?? 0,\n            'precio'                => $request->precio_creditos ?? $plan_credito->precio ?? null,\n            'porcentaje_descuento'  => $request->porcentaje_descuento_creditos ?? null,\n            'numero_factura'        => $request->numero_factura,\n            'comentario'            => $request->comentario,\n            'fecha_inicio'          => null,\n            'fecha_vencimiento'     => null,\n            'usuario_id'            => auth()->user()->id,\n        ];\n\n        // Si es edición de un plan de créditos existente\n        if ($request->filled('id')) {\n            // Eliminar la factura actual si se sube una nueva\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $datos_creditos);\n        } else {\n            // Determinar estado para nuevo plan\n            if (!is_null($plan_activo) && $plan_activo->id != $request->id) {\n                $datos_creditos['estado_id'] = Plan::ESTADO_PROXIMO_ID;\n            } else {\n                $datos_creditos['estado_id'] = Plan::ESTADO_ACTIVO_ID;\n            }\n\n            $enviar_correo = true;\n            $plan_asignado = $this->repositorio->crear($datos_creditos);\n        }\n\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     *\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     *\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy = now();\n\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses = $vigencia / 30;\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n\n        $this->generarDirectorios(\"app/{$ruta}\");\n\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n\n            'modelo_id' => $id,\n\n            'nombre' => 'factura',\n\n            'ruta' => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n\n        $request->merge([\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n\n            RolRepository::ROL_PROPIETARIO_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n\n            $plan->creditos_consumidos = $creditos_consumidos;\n\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan               = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Andres González\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $tipo_plan = $request->tipo_plan ?? 'plan';\n\n        if ($tipo_plan === 'plan_credito') {\n            $plan = $this->plan_credito_repositorio->getUno($request->plan_id);\n        } else {\n            $plan = $this->plan_repositorio->getUno($request->plan_id);\n        }\n\n        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n            'empresa_id'    => $request->empresa_id,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     * @author José Manuel Jiménez\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planCreditosActivo($empresa_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null,\n            'estado'               => $empresa_plan->estado ? [\n                'id'     => $empresa_plan->estado->id,\n                'nombre' => $empresa_plan->estado->nombre,\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":484,"oldLines":6,"newStart":484,"newLines":17,"lines":["     }"," ","     /**","+     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).","+     *","+     * @param int $empresa_id ID de la empresa.","+     * @return Collection","+     * @author Sergio Vargas","+     */","+    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {","+        return $this->repositorio->planesCreditosActivos($empresa_id);","+    }","+","+    /**","      * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.","      *","      * @param int $empresa_id ID de la empresa."]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"29b38322-8b17-4852-9b51-e78136ad9143"}
{"parentUuid":"30ccafd2-f715-4a48-bafb-b790528bb88a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_015hpU2X4qWWatAMfqtJKqA8","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora voy a modificar EmpresaService.php para incluir los planes de créditos en el método getUno()","signature":"EowCCkYICxgCKkBOYLTmAY+AW5XlHZ6C3PtcBM6O4dFrPhl1d72eN6c3/cTrROtSZBOxSNoVEPzZuYAhvpXmO+Uq4wz/NHFF8B8GEgyyzi0+UBorE7EfBzUaDPUBPQTkE00hx+47wSIw7q6mGUAh0V/tNnyo/EHhRvJCUB7sePgoWqtAg5TWqX6W8+zP/CjylMyQZHdTF2okKnRLaZ5CxokV08X2iipeVRNKaqzHuAFYH6tCgEAC0iHZOyxFy+w98wcgIffeC5VMFEPmsFt3QmL8JP1wAfhIKlsdkgkLQNZ8G3PpolCdivqD6xTHLasbe8SQ0HLlQw4nr0aN08JaM5A/TIz2jlwhNZXW6y4K7xgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":648,"cache_read_input_tokens":76013,"cache_creation":{"ephemeral_5m_input_tokens":648,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXTGL2yoQnHwHGgaGhKs5","type":"assistant","uuid":"f9141df6-7c1b-4bdf-9195-429dbd750b89","timestamp":"2026-01-25T01:56:14.613Z"}
{"parentUuid":"f9141df6-7c1b-4bdf-9195-429dbd750b89","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_015hpU2X4qWWatAMfqtJKqA8","type":"message","role":"assistant","content":[{"type":"text","text":"**Paso 3:** Modificar `getUno()` en EmpresaService.php para incluir los planes de créditos"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":648,"cache_read_input_tokens":76013,"cache_creation":{"ephemeral_5m_input_tokens":648,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXTGL2yoQnHwHGgaGhKs5","type":"assistant","uuid":"8651e925-8271-4203-ac77-6dcb241b83d2","timestamp":"2026-01-25T01:56:15.076Z"}
{"parentUuid":"8651e925-8271-4203-ac77-6dcb241b83d2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_015hpU2X4qWWatAMfqtJKqA8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CBZ2dYkdMcDdpNMMFVHNhw","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","old_string":"            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([","new_string":"            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            // Obtener planes de solo créditos (donde plan_id es NULL y plan_credito_id no es NULL)\n            $planes_creditos = $this->empresa_plan_servicio->obtenerPlanesCreditosActivos($id);\n            foreach ($planes_creditos as $plan_credito) {\n                array_push($planes, $plan_credito);\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request(["}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":648,"cache_read_input_tokens":76013,"cache_creation":{"ephemeral_5m_input_tokens":648,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXTGL2yoQnHwHGgaGhKs5","type":"assistant","uuid":"aa19ff37-7e1a-4406-9e3f-b25eba610d22","timestamp":"2026-01-25T01:56:19.951Z"}
{"type":"file-history-snapshot","messageId":"aa19ff37-7e1a-4406-9e3f-b25eba610d22","snapshot":{"messageId":"63bb9be8-d7a7-44c3-a952-0d4f526fba4f","trackedFileBackups":{"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"1ef8fbba46b68267@v1","version":1,"backupTime":"2026-01-25T01:56:04.149Z"},"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"87ffcf5aa4ef1291@v1","version":1,"backupTime":"2026-01-25T01:56:11.952Z"},"app\\Http\\Services\\Empresas\\EmpresaService.php":{"backupFileName":"8caa2eff68e60519@v1","version":1,"backupTime":"2026-01-25T01:56:20.734Z"}},"timestamp":"2026-01-25T01:55:13.782Z"},"isSnapshotUpdate":true}
{"parentUuid":"aa19ff37-7e1a-4406-9e3f-b25eba610d22","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CBZ2dYkdMcDdpNMMFVHNhw","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php has been updated successfully."}]},"uuid":"8b5a61a0-f71d-409e-b0ba-34988f87e96e","timestamp":"2026-01-25T01:56:20.732Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","oldString":"            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([","newString":"            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            // Obtener planes de solo créditos (donde plan_id es NULL y plan_credito_id no es NULL)\n            $planes_creditos = $this->empresa_plan_servicio->obtenerPlanesCreditosActivos($id);\n            foreach ($planes_creditos as $plan_credito) {\n                array_push($planes, $plan_credito);\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Illuminate\\Support\\Str;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\Response;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse App\\Exports\\Empresas\\HistorialCambiosExport;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\IA\\ServicioIARepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Planes\\ConsumoRepository;\nuse App\\Http\\Repositories\\Empresas\\SectorRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse Symfony\\Component\\HttpFoundation\\StreamedResponse;\nuse App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse Symfony\\Component\\HttpFoundation\\{BinaryFileResponse};\nuse App\\Http\\Repositories\\Configuraciones\\CiudadRepository;\nuse App\\Http\\Repositories\\Empresas\\TamanoEmpresaRepository;\nuse App\\Http\\Repositories\\Usuarios\\TipoDocumentoRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Politicas\\PoliticaAceptadaRepository;\nuse App\\Jobs\\Configuraciones\\CrearPlantillasPorDefectoEmpresaJob;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionModeloRepository;\n\n/**\n * @property EmpresaRepository $repositorio\n */\nclass EmpresaService extends BaseService\n{\n    use ArchivoTrait;\n\n    private $modelo = 'App\\Models\\Empresas\\Empresa';\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaRepository $repositorio Repositorio de empresas.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param PoliticaAceptadaRepository $politica_aceptada_repositorio Repositorio de políticas aceptadas.\n     * @param CiudadRepository $ciudad_repositorio Repositorio de ciudades.\n     * @param SectorRepository $sector_repositorio Repositorio de sectores.\n     * @param TamanoEmpresaRepository $tamano_empresa_repositorio Repositorio de tamaños de empresas.\n     * @param TipoDocumentoRepository $tipo_documento_repositorio Repositorio de tipos de documentos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param ConfiguracionRepository $configuracion_repositorio Repositorio de configuraciones.\n     * @param ConfiguracionModeloRepository $configuracion_modelo_repositorio Repositorio de configuraciones de modelos.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @param ConsumoRepository $consumo_repositorio Repositorio de consumos.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function __construct(\n        EmpresaRepository $repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected PoliticaAceptadaRepository $politica_aceptada_repositorio,\n        protected CiudadRepository $ciudad_repositorio,\n        protected SectorRepository $sector_repositorio,\n        protected TamanoEmpresaRepository $tamano_empresa_repositorio,\n        protected TipoDocumentoRepository $tipo_documento_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected TipoPruebaRepository $tipo_prueba_repositorio,\n        protected EmpresaPlanRepository $empresa_plan_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected ConfiguracionRepository $configuracion_repositorio,\n        protected ConfiguracionModeloRepository $configuracion_modelo_repositorio,\n        protected EmpresaPlanService $empresa_plan_servicio,\n        protected ConsumoRepository $consumo_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected ServicioIARepository $servicio_ia_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Obtener una empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @return Empresa|null\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?Empresa {\n        $empresa = $this->repositorio->getUnoBasico($id);\n\n        if (!is_null($empresa)) {\n            $planes        = [];\n            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n                'empresa_id'         => $id,\n                'con_relaciones'     => true,\n                'validar_relaciones' => true,\n                'en'                 => true,\n                'campo'              => 'rol_id',\n                'valores'            => [\n                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n                    $this->rol_repositorio::ROL_EVALUADOR_ID\n                ]\n            ]));\n\n            $usuarios = $usuarios->map(function ($usuario) {\n                $eliminar = false;\n\n                if (\n                    !$usuario->usuario->tiene_agendas\n                    && !$usuario->usuario->tiene_ofertas_laborales\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_etapa_usuario\n                ) {\n                    $eliminar = true;\n                }\n\n                $usuario->usuario->eliminar = $eliminar;\n                return $usuario;\n            });\n\n            $empresa->planes                         = $planes;\n            $empresa->usuarios                       = $usuarios;\n            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n                'model_type' => $this->modelo,\n                'modelo_id'  => $id\n            ]));\n            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Obtener todas las empresas.\n     *\n     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function getTodo(Request $request): Collection {\n        $empresas      = $this->repositorio->getTodo($request);\n        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n        $coleccion     = [];\n\n        foreach ($empresas as $empresa) {\n            $registro = $empresa;\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n\n                // Obtener el plan activo, si no tiene se obtiene el último plan asignado\n                $registro[$llave] = $this->empresa_plan_repositorio->planActivo($empresa->id, $tipo_prueba->id);\n\n                if (is_null($registro[$llave])) {\n                    $registro[$llave] = $this->empresa_plan_repositorio->ultimoPlanAsignado(new Request([\n                        'empresa_id'             => $empresa->id,\n                        'tipo_prueba_id'         => $tipo_prueba->id,\n                        'excluir_estado_proximo' => true\n                    ]));\n                }\n\n                // Verificar si tiene un plan próximo adicional al plan actual\n                if (!is_null($registro[$llave])) {\n                    $plan_proximo                     = $this->empresa_plan_repositorio->planProximo($empresa->id, $tipo_prueba->id);\n                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n                }\n            }\n\n            $plan_creditos = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n\n            if ($plan_creditos && !is_null($plan_creditos['plan_credito'])) {\n                $registro['plan_creditos'] = $plan_creditos;\n            } else {\n                $registro['plan_creditos'] = null;\n            }\n\n            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n            array_push($coleccion, $registro);\n        }\n\n        return collect($coleccion);\n    }\n\n    /**\n     * Obtener el porcentaje de creación.\n     *\n     * @param int $id ID de la empresa.\n     * @return int\n     * @author Daniel Beltrán\n     */\n    public function obtenerPorcentajeCreacion(int $id): int {\n        $empresa    = $this->repositorio->getUno($id);\n        $porcentaje = 0;\n\n        if (is_null($empresa)) {\n            return $porcentaje;\n        }\n\n        if (!is_null($empresa->empresa_id)) {\n            return $porcentaje;\n        }\n\n        $porcentaje += 10;\n\n        if (count($empresa->archivos) > 0) {\n            $porcentaje += 20;\n        }\n\n        if (count($empresa->usuarios) > 0) {\n            $porcentaje += 10;\n        }\n\n        if (count($empresa->planes) > 0) {\n            $porcentaje += 30;\n        }\n\n        if (count($empresa->usuarios) > 1) {\n            $porcentaje += 30;\n        }\n\n        return $porcentaje;\n    }\n\n    /**\n     * Guardar empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @throws Exception Cuando un usuario que no es superadministrador, intenta modificar una empresa diferente a la que está logueado.\n     * @return Empresa\n     * @author Daniel Beltrán\n     */\n    public function guardar(Request $request): Empresa {\n        $campos_excluidos = ['_token', '_method', 'id', 'pais_id', 'departamento_id', 'digito_verificacion', 'extension', 'extension_tesorero', 'logo', 'empresa_plan_id'];\n\n        if ($request->filled('digito_verificacion')) {\n            $request->merge(['documento' => $request->documento . '-' . $request->digito_verificacion]);\n        }\n\n        if ($request->filled('telefono') && $request->filled('extension')) {\n            $request->merge(['telefono' => $request->telefono . '-' . $request->extension]);\n        }\n\n        if ($request->filled('telefono_tesorero') && $request->filled('extension_tesorero')) {\n            $request->merge(['telefono_tesorero' => $request->telefono_tesorero . '-' . $request->extension_tesorero]);\n        }\n\n        // Agregar datos a la sucursal\n        if ($request->filled('empresa_id')) {\n            $empresa_principal = $this->repositorio->getUno($request->empresa_id);\n\n            if (!is_null($empresa_principal->empresa_id)) {\n                throw new Exception('No se puede crearse una sucursal de otra sucursal');\n            }\n\n            $request->merge([\n                'tamano_empresa_id' => $empresa_principal->tamano_empresa_id,\n                'razon_social'      => $empresa_principal->razon_social\n            ]);\n\n            unset($empresa_principal);\n        }\n\n        if ($request->filled('id')) {\n            $rol_usuario = $this->rol_repositorio->usuarioRolActivo(Auth::id());\n\n            // Validar que solo el superadministrador pueda editar cualquier empresa\n            if ($rol_usuario->id != RolRepository::ROL_SUPERADMIN_ID) {\n                $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n                if ($empresa_usuario->id != $request->empresa_id) {\n                    throw new Exception('No puedes editar una empresa diferente a la que estás logueado', Response::HTTP_FORBIDDEN);\n                }\n            }\n\n            $empresa = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $empresa = $this->repositorio->crear($request->except($campos_excluidos));\n            CrearPlantillasPorDefectoEmpresaJob::dispatch($empresa->id);\n        }\n\n        // Renovación el plan\n        if ($request->filled('empresa_plan_id')) {\n            $this->empresa_plan_servicio->renovar($request->empresa_plan_id);\n        }\n\n        // Guardar el logo de la sucursal\n        if ($request->filled('empresa_id') && $request->filled('logo')) {\n            $this->cambiarLogo($empresa->id, $request->logo);\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Guardar archivos de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function guardarArchivos(int $id, Request $request): void {\n        if ($request->filled('logo')) {\n            $this->cambiarLogo($id, $request->logo);\n        }\n\n        foreach ($request->files->all() as $nombre_archivo_empresa => $archivo_empresa) {\n            $archivo_existente = $this->archivo_repositorio->getUnoAvanzado(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id,\n                'nombre'    => $nombre_archivo_empresa\n            ]));\n\n            if (!is_null($archivo_existente)) {\n                $this->archivo_servicio->eliminarPorModelo($this->modelo, $id, $nombre_archivo_empresa);\n            }\n\n            $ruta = \"private/archivos/empresas/{$id}\";\n            $this->generarDirectorios(\"app/{$ruta}\");\n\n            $nombre_archivo = $this->generarNombreArchivo($archivo_empresa);\n            $this->guardarArchivoEnRuta($archivo_empresa, $ruta, $nombre_archivo);\n\n            $this->archivo_repositorio->crear([\n                'modelo'                  => $this->modelo,\n                'modelo_id'               => $id,\n                'nombre'                  => $nombre_archivo_empresa,\n                'nombre_original_archivo' => $nombre_archivo,\n                'ruta'                    => $ruta . '/' . $nombre_archivo\n            ]);\n        }\n    }\n\n    /**\n     * Eliminar empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa tiene algún registro asociado o está archivada.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function eliminar(int $id): void {\n        $empresa = $this->repositorio->getUnoAvanzado(new Request([\n            'id'                       => $id,\n            'contar_sucursales'        => true,\n            'contar_planes'            => true,\n            'contar_procesos'          => true,\n            'contar_areas'             => true,\n            'contar_perfiles'          => true,\n            'contar_agendas'           => true,\n            'contar_encuestas'         => true,\n            'contar_soportes'          => true,\n            'contar_usuarios'          => true,\n            'contar_ordenes_servicios' => true,\n            'contar_ofertas_laborales' => true,\n            'contar_portales_empleos'  => true\n        ]));\n\n        if ($empresa->activo) {\n            // Validar que no tenga planes\n            if ($empresa->planes_count > 0) {\n                throw new Exception('La empresa tiene planes asignados');\n            }\n\n            // Validar que no tenga sucursales\n            if ($empresa->sucursales_count > 0) {\n                throw new Exception('La empresa tiene sucursales asignadas');\n            }\n\n            // Validar que no tenga procesos\n            if ($empresa->procesos_count > 0) {\n                throw new Exception('La empresa tiene procesos asignados');\n            }\n\n            // Validar que no tenga áreas\n            if ($empresa->areas_count > 0) {\n                throw new Exception('La empresa tiene áreas asignadas');\n            }\n\n            // Validar que no tenga perfiles\n            if ($empresa->perfiles_count > 0) {\n                throw new Exception('La empresa tiene perfiles asignados');\n            }\n\n            // Validar que no tenga agendas\n            if ($empresa->agendas_count > 0) {\n                throw new Exception('La empresa tiene agendas asignadas');\n            }\n\n            // Validar que no tenga encuestas\n            if ($empresa->encuestas_count > 0) {\n                throw new Exception('La empresa tiene encuestas asignadas');\n            }\n\n            // Validar que no tenga soportes\n            if ($empresa->soportes_count > 0) {\n                throw new Exception('La empresa tiene soportes asignados');\n            }\n\n            // Validar que no tenga usuarios\n            if ($empresa->usuarios_count > 0) {\n                throw new Exception('La empresa tiene usuarios asignados');\n            }\n\n            // Validar que no tenga ordenes de servicio\n            if ($empresa->ordenes_servicios_count > 0) {\n                throw new Exception('La empresa tiene ordenes de servicio asignadas');\n            }\n\n            // Validar que no tenga ofertas laborales\n            if ($empresa->ofertas_laborales_count > 0) {\n                throw new Exception('La empresa tiene ofertas laborales asignadas');\n            }\n\n            // Validar que no tenga portales de empleo\n            if ($empresa->portal_empleo_count > 0) {\n                throw new Exception('La empresa tiene portales de empleo asignados');\n            }\n\n            $this->repositorio->sincronizarConfiguraciones($empresa, []);\n            $this->repositorio->eliminar($id);\n        } else {\n            throw new Exception('La empresa está archivada');\n        }\n    }\n\n    /**\n     * Eliminar los usuarios de la empresa junto con sus políticas aceptadas.\n     *\n     * @param Empresa $empresa Empresa.\n     * @param Collection $usuarios Usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function eliminarUsuarios(Empresa $empresa, Collection $usuarios): void {\n        if (count($usuarios) > 0) {\n            foreach ($usuarios as $usuario_empresa) {\n                // Disociar el usuario de la empresa\n                $this->repositorio->disociarUsuario($empresa, $usuario_empresa->id);\n\n                // Disociar las políticas aceptadas del usuario para la empresa\n                $this->politica_aceptada_repositorio->eliminarPorUsuarioYEmpresa($usuario_empresa->id, $empresa->id);\n\n                // Obtener todas las políticas aceptadas del usuario en otras empresas\n                $politicas_otras_empresas = $this->politica_aceptada_repositorio->obtenerPorUsuarioYEmpresasDiferentes($usuario_empresa->id, [$empresa->id]);\n\n                // Obtener los datos del usuario\n                $usuario = $this->usuario_repositorio->getUno($usuario_empresa->id);\n\n                // Validar si el usuario tiene más empresas asociadas y más políticas aceptadas de otras empresas\n                if (count($usuario->empresas) == 0 && count($politicas_otras_empresas) == 0) {\n                    $this->usuario_repositorio->eliminar($usuario_empresa->id);\n                }\n            }\n        }\n    }\n\n    /**\n     * Obtener el historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return Collection\n     * @author Daniel Beltrán\n     */\n    public function historialCambios(int $id): Collection {\n        $historial       = $this->repositorio->historialCambios($id);\n        $historial_final = [];\n\n        // Obtener los datos referenciados a través de llaves foráneas\n        $ciudades         = $this->obtenerDatosReferenciados($historial, 'ciudad_id', 'ciudades_ids', $this->ciudad_repositorio);\n        $ejecutivos       = $this->obtenerDatosReferenciados($historial, 'ejecutivo_id', 'usuarios_ids', $this->usuario_repositorio);\n        $sectores         = $this->obtenerDatosReferenciados($historial, 'sector_id', 'sectores_ids', $this->sector_repositorio);\n        $tamanos_empresas = $this->obtenerDatosReferenciados($historial, 'tamano_empresa_id', 'tamanos_empresas_ids', $this->tamano_empresa_repositorio);\n        $tipos_documentos = $this->obtenerDatosReferenciados($historial, 'tipo_documento_representante_id', 'tipos_documentos_ids', $this->tipo_documento_repositorio);\n\n        foreach ($historial as $item) {\n            array_push($historial_final, [\n                'id'             => $item->id,\n                'user_type'      => $item->user_type,\n                'user_id'        => $item->user_id,\n                'event'          => $item->event,\n                'auditable_type' => $item->auditable_type,\n                'auditable_id'   => $item->auditable_id,\n                'created_at'     => $item->created_at,\n                'user'           => $item->user,\n                'old_values'     => $this->asignarCambiosHistorial($item->old_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos),\n                'new_values'     => $this->asignarCambiosHistorial($item->new_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos)\n            ]);\n        }\n\n        return collect($historial_final);\n    }\n\n    /**\n     * Asignar los cambios del historial.\n     *\n     * @param array $valores Valores del historial (pueden ser antigüos o nuevos).\n     * @param Collection $ciudades Ciudades.\n     * @param Collection $ejecutivos Ejecutivos.\n     * @param Collection $sectores Sectores.\n     * @param Collection $tamanos_empresas Tamaños de empresas.\n     * @param Collection $tipos_documentos Tipos de documentos.\n     * @return array\n     * @author Daniel Beltrán\n     */\n    private function asignarCambiosHistorial(\n        array $valores,\n        Collection $ciudades,\n        Collection $ejecutivos,\n        Collection $sectores,\n        Collection $tamanos_empresas,\n        Collection $tipos_documentos\n    ): array {\n        $valores_actualizados = [];\n\n        foreach ($valores as $llave => $valor) {\n            $valores_actualizados[$llave] = $valor;\n\n            if ($llave === 'ciudad_id') {\n                $ciudad                       = $ciudades->firstWhere('id', $valor);\n                $valores_actualizados[$llave] = $ciudad->nombre . ', ' . $ciudad->departamento->nombre . ' - ' . $ciudad->departamento->pais->nombre;\n            }\n\n            if ($llave === 'ejecutivo_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $ejecutivos->firstWhere('id', $valor)->nombre_completo : null;\n            }\n\n            if ($llave === 'sector_id') {\n                $valores_actualizados[$llave] = $sectores->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tamano_empresa_id') {\n                $valores_actualizados[$llave] = $tamanos_empresas->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tipo_documento_representante_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $tipos_documentos->firstWhere('id', $valor)->nombre : null;\n            }\n        }\n\n        return $valores_actualizados;\n    }\n\n    /**\n     * Obtener el logo de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa no tiene ningún logo.\n     * @return BinaryFileResponse|StreamedResponse\n     * @author Daniel Beltrán\n     */\n    public function getLogo(int $id): BinaryFileResponse|StreamedResponse {\n        $logo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n        abort_if(is_null($logo), 404, 'Esta empresa no tiene ningún logo');\n        return $this->obtenerArchivoDesdeRuta($logo->ruta);\n    }\n\n    /**\n     * Cambiar el logo de la empresa.\n     *\n     * Elimina el logo actual y guarda el nuevo.\n     *\n     * @param int $id ID de la empresa.\n     * @param string $logo Nuevo logo en base64.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function cambiarLogo(int $id, string $logo): void {\n        $archivo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n\n        if (!is_null($archivo)) {\n            $this->archivo_servicio->eliminar($archivo->id);\n        }\n\n        $this->archivo_servicio->guardarVariosBase64($this->modelo, $id, ['logo' => $logo], 'empresas');\n    }\n\n    /**\n     * Exportar Excel del historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return BinaryFileResponse|Response\n     * @author Daniel Beltrán\n     */\n    public function exportarExcelHistorialCambios(int $id): BinaryFileResponse|Response {\n        $datos = [\n            'historial_cambios' => $this->historialCambios($id),\n            'archivos'          => $this->archivo_repositorio->getTodo(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id\n            ]))\n        ];\n\n        return Excel::download(new HistorialCambiosExport($datos), 'historial-cambios.xlsx');\n    }\n\n    /**\n     * Obtiene el conteo dependiendo de id de empresas planes.\n     *\n     * @param int $empresa_plan_id Id de empresas planes.\n     * @param Request $request Contenido de la petición.\n     * @return int\n     * @author Andres Gonzalez\n     * @author Fahibram Cárcamo\n     */\n    public function conteoConsumo(int $empresa_plan_id, Request $request): int {\n        return $this->consumo_repositorio->getTodo(\n            new Request([\n                'empresa_plan_id' => $empresa_plan_id,\n                'fecha_inicio'    => $request->fecha_inicio,\n                'fecha_fin'       => $request->fecha_fin\n            ])\n        )\n        ->count();\n    }\n\n    /**\n     * Obtiene el resumen para el panel.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return array\n     * @author Andres Gonzalez\n     */\n    public function obtenerResumen(Request $request): array {\n        $resumen = $this->repositorio->obtenerResumen($request);\n        $alto    = 0;\n        $normal  = 0;\n        $bajo    = 0;\n\n        $ejecutivos_procesados = [];\n        $planes                = [];\n        $total_precio          = 0;\n        $empresas_asignadas    = 0;\n        $planes_agrupados      = [];\n\n        foreach ($resumen['empresasPlanes'] as $empresa_plan) {\n            $consumo = $this->conteoConsumo($empresa_plan->id, $request);\n\n            if ($consumo > $empresa_plan->unidades) {\n                $alto++;\n            } elseif ($consumo == $empresa_plan->unidades) {\n                $normal++;\n            } else {\n                $bajo++;\n            }\n        }\n\n        $resumen['consumo'] = [\n            'alto'   => $alto,\n            'normal' => $normal,\n            'bajo'   => $bajo,\n        ];\n\n        // Top ejecutivos\n        foreach ($resumen['empresa_ejecutivo'] as $ejecutivo) {\n            $empresas = $this->repositorio->getTodoAgrupadoPlan(new Request([\n                'ejecutivo_id' => $ejecutivo->ejecutivo_id,\n                'fecha_inicio' => $request->fecha_inicio,\n                'fecha_fin'    => $request->fecha_fin,\n            ]));\n\n            foreach ($empresas as $empresa) {\n                foreach ($empresa['empresas_planes'] as $plan) {\n                    $empresas_asignadas++;\n                    $total_precio += $plan['precio'];\n\n                    // Saltar la empresa plan que no tiene un plan asignado por ende es de crédito y de momento no se tiene en cuenta.\n                    if ($plan['plan'] == null) {\n                        continue;\n                    }\n\n                    $planes[] = [\n                        'id'          => $plan['plan']['id'],\n                        'nombre'      => $plan['plan']['nombre'],\n                        'descripcion' => $plan['plan']['descripcion'],\n                        'precio'      => $plan['precio'],\n                        'conteo'      => null\n                    ];\n                }\n            }\n\n            // Agrupa los planes por el id y suma su precio y conteo.\n            foreach ($planes as $plan) {\n                $plan_id = $plan['id'];\n\n                if (!isset($planes_agrupados[$plan_id])) {\n                    $planes_agrupados[$plan_id]           = $plan;\n                    $planes_agrupados[$plan_id]['conteo'] = 1;\n                } else {\n                    $planes_agrupados[$plan_id]['precio'] += $plan['precio'];\n                    $planes_agrupados[$plan_id]['conteo'] += 1;\n                }\n            }\n\n            $planes = array_values($planes_agrupados);\n\n            // Ordena de mayor a menor precio.\n            usort($planes, function ($primero, $segundo) {\n                return $segundo['precio'] <=> $primero['precio'];\n            });\n\n            if ($total_precio > 0) {\n                $ejecutivos_procesados[] = [\n                    'id_ejecutivo'       => $ejecutivo->ejecutivo_id,\n                    'nombre'             => $ejecutivo->ejecutivo->nombre_completo,\n                    'ventas_totales'     => $total_precio,\n                    'empresas_asignadas' => $empresas_asignadas,\n                    'planes'             => $planes,\n                ];\n            }\n\n            // Reiniciar variables.\n            $empresas_asignadas = 0;\n            $total_precio       = 0;\n            $planes             = [];\n            $planes_agrupados   = [];\n        }\n\n        // Ordena de mayor a menor de ventas_totales.\n        usort($ejecutivos_procesados, function ($primero, $segundo) {\n            return $segundo['ventas_totales'] <=> $primero['ventas_totales'];\n        });\n\n        $resumen['ejecutivos'] = $ejecutivos_procesados;\n\n        unset($resumen['empresasPlanes'], $resumen['empresa_ejecutivo']);\n\n        return $resumen;\n    }\n}\n","structuredPatch":[{"oldStart":116,"oldLines":6,"newStart":116,"newLines":12,"lines":["                 }","             }"," ","+            // Obtener planes de solo créditos (donde plan_id es NULL y plan_credito_id no es NULL)","+            $planes_creditos = $this->empresa_plan_servicio->obtenerPlanesCreditosActivos($id);","+            foreach ($planes_creditos as $plan_credito) {","+                array_push($planes, $plan_credito);","+            }","+","             $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([","                 'empresa_id'         => $id,","                 'con_relaciones'     => true,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"aa19ff37-7e1a-4406-9e3f-b25eba610d22"}
{"parentUuid":"8b5a61a0-f71d-409e-b0ba-34988f87e96e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GLP4kkzXfFQsef58T9D6jx","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito modificar el archivo JavaScript `empresas.js` para renderizar los planes de créditos. Necesito ver la función `mostrarPlanes()` completa para entender bien la estructura.","signature":"EuQCCkYICxgCKkB8xFdM5wqwlrD1hzH/g4yC0Sqg0+/9MyhfcgEUerxZqh2pS5BfkSZBDMQFe1VzvR4sYjwRowT1eCRpV42gCn7yEgyVZctkm85UrRByzIAaDG3nTKKEJqaXE9oWgyIwnu+H5LAMN5c6X5WrZBs+bctaNIG9sml7+yjPo41rvJ77yLFx2FYMs3tyDu/lnD8xKssBfHRsauNY8zQu9yZhnpNtCXYTIFrOYsZIhqmyzL8dQaZBmqrVYA0bdZaX3UYyRU+rJNaoNa2UNjywQ9YbMvpm5O3vB21FlaTe83YxYvWJJngBlagt2GGvEwNF6NQwmgQR7EUJN0OKEDhemJOiujT5OEvx7+4oEY/UOLzHxikpnTGoKj3QHPMZzc9gLS4T/2zhlFYj1+kXgJJvJsmZafxiEaSAqAVeOkijgxehYR5Wl7B53FfTNK4WHj1ULF8hOSyyvM4CLIDMQ6IvKDwYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":633,"cache_read_input_tokens":76661,"cache_creation":{"ephemeral_5m_input_tokens":633,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGLghRrtKsuA58ecXMu","type":"assistant","uuid":"4502c324-6ec1-4840-966d-b12d7d52ee0c","timestamp":"2026-01-25T01:56:24.403Z"}
{"parentUuid":"4502c324-6ec1-4840-966d-b12d7d52ee0c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GLP4kkzXfFQsef58T9D6jx","type":"message","role":"assistant","content":[{"type":"text","text":"**Paso 4:** Modificar `mostrarPlanes()` en empresas.js. Primero veo más contexto del archivo."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":633,"cache_read_input_tokens":76661,"cache_creation":{"ephemeral_5m_input_tokens":633,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGLghRrtKsuA58ecXMu","type":"assistant","uuid":"d028407c-e641-4247-8842-3a5ba0a76dc7","timestamp":"2026-01-25T01:56:25.140Z"}
{"parentUuid":"d028407c-e641-4247-8842-3a5ba0a76dc7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GLP4kkzXfFQsef58T9D6jx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018w2pVsx3xrpAAfU6neABHk","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":1665,"limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":633,"cache_read_input_tokens":76661,"cache_creation":{"ephemeral_5m_input_tokens":633,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGLghRrtKsuA58ecXMu","type":"assistant","uuid":"e4d65af0-fd36-4694-b616-06923a535d91","timestamp":"2026-01-25T01:56:25.998Z"}
{"parentUuid":"e4d65af0-fd36-4694-b616-06923a535d91","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018w2pVsx3xrpAAfU6neABHk","type":"tool_result","content":"  1665→                                        <p class=\"text-label-2 mb-0\">\n  1666→                                            <span class=\"text-gray-50 me-3\">${fecha_creacion}</span>\n  1667→                                            <span class=\"text-gray-30\">${fecha_inicio}</span>\n  1668→                                        </p>\n  1669→                                    </div>\n  1670→                                </div>\n  1671→                            </div>\n  1672→                        </td>\n  1673→                    </tr>\n  1674→                `);\n  1675→            }\n  1676→        }\n  1677→\n  1678→        // Mostrar cards de planes de créditos\n  1679→        let planes_creditos_mostrados = [];\n  1680→        for (let i = 0; i < planes.length; i++) {\n  1681→            if (planes[i].plan_credito && planes[i].plan_credito.id) {\n  1682→                // Evitar duplicados de plan_credito\n  1683→                if (!planes_creditos_mostrados.includes(planes[i].plan_credito.id)) {\n  1684→                    planes_creditos_mostrados.push(planes[i].plan_credito.id);\n  1685→\n  1686→                    let plan_credito = planes[i].plan_credito;\n  1687→                    let creditos_totales = planes[i].creditos !== null ? planes[i].creditos : 0;\n  1688→                    let creditos_restantes = planes[i].creditos_restantes !== null ? planes[i].creditos_restantes : 0;\n  1689→                    let creditos_promedio = empresa_seleccionada.creditos_promedio_accion || 0;\n  1690→                    let acciones_estimadas = creditos_restantes > 0 && creditos_promedio > 0\n  1691→                        ? Math.floor(creditos_restantes / creditos_promedio)\n  1692→                        : 0;\n  1693→\n  1694→                    let estado_credito = creditos_restantes > 0\n  1695→                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n  1696→                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n  1697→\n  1698→                    let precio_informacion= '';\n  1699→                    if (plan_credito.precio) {\n  1700→                        precio_informacion= `$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}`;\n  1701→                        if (plan_credito.porcentaje_descuento && plan_credito.precio_con_descuento) {\n  1702→                            precio_informacion= `<span class=\"text-decoration-line-through text-gray-50\">$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}</span>\n  1703→                                          <span class=\"text-green-40 ms-2\">$${parseFloat(plan_credito.precio_con_descuento).toLocaleString('es-CO')}</span>\n  1704→                                          <span class=\"tag tag-sm tag-tonal-green ms-2\">-${plan_credito.porcentaje_descuento}%</span>`;\n  1705→                        }\n  1706→                    }\n  1707→\n  1708→                    let fecha_promocion = '';\n  1709→                    if (plan_credito.fecha_inicio_promocion && plan_credito.fecha_fin_promocion) {\n  1710→                        fecha_promocion = `Promoción: ${obtenerFecha(plan_credito.fecha_inicio_promocion)} - ${obtenerFecha(plan_credito.fecha_fin_promocion)}`;\n  1711→                    }\n  1712→\n  1713→                    let fecha_creacion_credito = '';\n  1714→                    if (planes[i].created_at != null) {\n  1715→                        fecha_creacion_credito = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n  1716→                    }\n  1717→\n  1718→                    let fecha_activacion_credito = '';\n  1719→                    if (planes[i].fecha_inicio != null) {\n  1720→                        fecha_activacion_credito = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n  1721→                    }\n  1722→\n  1723→                    let fecha_vencimiento_credito = '';\n  1724→                    if (planes[i].fecha_vencimiento != null) {\n  1725→                        fecha_vencimiento_credito = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n  1726→                    }\n  1727→\n  1728→                    let opcion_editar_credito = `\n  1729→                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n  1730→                            <i class=\"bi bi-pencil-fill\"></i>\n  1731→                        </button>\n  1732→                    `;\n  1733→\n  1734→                    let acciones_credito = obtenerAccionesCreditos(\n  1735→                        planes[i].estado.id,\n  1736→                        planes[i].id,\n  1737→                        empresa_id,\n  1738→                        planes[i]?.archivos[0]?.id ?? '0',\n  1739→                        empresa_seleccionada.nombre_comercial,\n  1740→                        plan_credito.nombre,\n  1741→                        plan_credito.creditos,\n  1742→                        planes[i].creditos_restantes ?? null\n  1743→                    );\n  1744→\n  1745→                    $('#tbody-planes').append(`\n  1746→                        <tr>\n  1747→                            <td style=\"border-bottom: 0px!important;\">\n  1748→                                <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n  1749→                                    <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n  1750→                                        <div class=\"col\">\n  1751→                                            <div class=\"row align-items-center\">\n  1752→                                                <div class=\"col-auto mb-0\">\n  1753→                                                    <p class=\"text-gray-30 text-headline-4 mb-0\">\n  1754→                                                        <i class=\"bi bi-coin me-3\" title=\"Plan de Créditos\"></i> ${plan_credito.nombre}\n  1755→                                                    </p>\n  1756→                                                </div>\n  1757→                                                <div class=\"col-auto\">\n  1758→                                                    ${estado_credito}\n  1759→                                                </div>\n  1760→                                                <div class=\"col-auto\">\n  1761→                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n  1762→                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n  1763→                                                    </p>\n  1764→                                                </div>\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a515db96-4c9f-4d58-bd10-b8bcaf94e9f7","timestamp":"2026-01-25T01:56:26.891Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","content":"                                        <p class=\"text-label-2 mb-0\">\n                                            <span class=\"text-gray-50 me-3\">${fecha_creacion}</span>\n                                            <span class=\"text-gray-30\">${fecha_inicio}</span>\n                                        </p>\n                                    </div>\n                                </div>\n                            </div>\n                        </td>\n                    </tr>\n                `);\n            }\n        }\n\n        // Mostrar cards de planes de créditos\n        let planes_creditos_mostrados = [];\n        for (let i = 0; i < planes.length; i++) {\n            if (planes[i].plan_credito && planes[i].plan_credito.id) {\n                // Evitar duplicados de plan_credito\n                if (!planes_creditos_mostrados.includes(planes[i].plan_credito.id)) {\n                    planes_creditos_mostrados.push(planes[i].plan_credito.id);\n\n                    let plan_credito = planes[i].plan_credito;\n                    let creditos_totales = planes[i].creditos !== null ? planes[i].creditos : 0;\n                    let creditos_restantes = planes[i].creditos_restantes !== null ? planes[i].creditos_restantes : 0;\n                    let creditos_promedio = empresa_seleccionada.creditos_promedio_accion || 0;\n                    let acciones_estimadas = creditos_restantes > 0 && creditos_promedio > 0\n                        ? Math.floor(creditos_restantes / creditos_promedio)\n                        : 0;\n\n                    let estado_credito = creditos_restantes > 0\n                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n\n                    let precio_informacion= '';\n                    if (plan_credito.precio) {\n                        precio_informacion= `$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}`;\n                        if (plan_credito.porcentaje_descuento && plan_credito.precio_con_descuento) {\n                            precio_informacion= `<span class=\"text-decoration-line-through text-gray-50\">$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}</span>\n                                          <span class=\"text-green-40 ms-2\">$${parseFloat(plan_credito.precio_con_descuento).toLocaleString('es-CO')}</span>\n                                          <span class=\"tag tag-sm tag-tonal-green ms-2\">-${plan_credito.porcentaje_descuento}%</span>`;\n                        }\n                    }\n\n                    let fecha_promocion = '';\n                    if (plan_credito.fecha_inicio_promocion && plan_credito.fecha_fin_promocion) {\n                        fecha_promocion = `Promoción: ${obtenerFecha(plan_credito.fecha_inicio_promocion)} - ${obtenerFecha(plan_credito.fecha_fin_promocion)}`;\n                    }\n\n                    let fecha_creacion_credito = '';\n                    if (planes[i].created_at != null) {\n                        fecha_creacion_credito = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                    }\n\n                    let fecha_activacion_credito = '';\n                    if (planes[i].fecha_inicio != null) {\n                        fecha_activacion_credito = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                    }\n\n                    let fecha_vencimiento_credito = '';\n                    if (planes[i].fecha_vencimiento != null) {\n                        fecha_vencimiento_credito = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                    }\n\n                    let opcion_editar_credito = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n                            <i class=\"bi bi-pencil-fill\"></i>\n                        </button>\n                    `;\n\n                    let acciones_credito = obtenerAccionesCreditos(\n                        planes[i].estado.id,\n                        planes[i].id,\n                        empresa_id,\n                        planes[i]?.archivos[0]?.id ?? '0',\n                        empresa_seleccionada.nombre_comercial,\n                        plan_credito.nombre,\n                        plan_credito.creditos,\n                        planes[i].creditos_restantes ?? null\n                    );\n\n                    $('#tbody-planes').append(`\n                        <tr>\n                            <td style=\"border-bottom: 0px!important;\">\n                                <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                    <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                        <div class=\"col\">\n                                            <div class=\"row align-items-center\">\n                                                <div class=\"col-auto mb-0\">\n                                                    <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                        <i class=\"bi bi-coin me-3\" title=\"Plan de Créditos\"></i> ${plan_credito.nombre}\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    ${estado_credito}\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>","numLines":100,"startLine":1665,"totalLines":3611}},"sourceToolAssistantUUID":"e4d65af0-fd36-4694-b616-06923a535d91"}
{"parentUuid":"a515db96-4c9f-4d58-bd10-b8bcaf94e9f7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01M7B5WgUzmETRsPY3odNX2d","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ya existe código para mostrar los planes de créditos en la vista de empresas. Veo que hay una sección que comienza en la línea 1678 para \"Mostrar cards de planes de créditos\". Sin embargo, el problema está en el filtro inicial que excluye los planes sin `plan` o `tipo_prueba_id`.\n\nVeo que el código actual en la línea 1681 valida `planes[i].plan_credito && planes[i].plan_credito.id`, lo cual parece correcto. Pero el problema es que el backend no está enviando los planes de créditos donde `plan_id` es NULL.\n\nAhora que he agregado la lógica del backend para incluir los planes de créditos, debo asegurarme de que el frontend maneje correctamente estos planes. El problema parece ser que el frontend ya tiene código para mostrar los planes de créditos, pero el backend no los estaba incluyendo.\n\nEspera, necesito verificar que los planes de créditos estén siendo calculados correctamente con los campos necesarios como `creditos_restantes`. Deja revisar el repositorio que acabo de crear.\n\nVeamos el código existente de planCreditosActivo:\n\n```php\npublic function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n    return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n    ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n    ->where('empresa_id', $empresa_id)\n    ->whereNotNull('plan_credito_id')\n    ->whereIn('estado_id', [1, 4])\n```\n\nEl método actual no filtra por `whereNull('plan_id')`, así que puede retornar planes que tienen tanto créditos como un plan regular. Por eso agregué `whereNull('plan_id')` en el nuevo método `planesCreditosActivos()` para aislar solo los planes de crédito puros. Necesito verificar que el modelo EmpresaPlan tenga el atributo calculado `creditos_restantes`.","signature":"EvwPCkYICxgCKkDNd3B7nlB4UKEtybucgHhhwLCBOrbFf/2+yEFpbUNGhc3pKsPf2kp1zBnXJgT+UaGG6tYhnjoqpxnA2qW9npd4EgxgxMNzbdSdnyObXDcaDOQdWS5dvsk9j01cESIwYAX+U4vQIyLwE2xsERDHxQUDZHa7Dz9+Csk3v1d56pUsOpBGa+AaaGemxY/hG1AKKuMO1QV9btrZqwfH6yITgAK4QwhuIRadOAV9UPsbv5/IlY6vhDDKZC2OOFGPKIaAVqx3a7XZm/Gb0MEm9C6oelbjHMSHzYyv1EZqZZRICQqk/VuqMNsYqqZeyGC1LuWR+0qydNFjwYSSYAp8Jtz7BJ9+eDq/aU49K360dBinV2l0LMZASsp5urlHpWrHoetu4hVq2dgJELeM2LHr/bOxo1+u1XKeham3wfh6Szb2rLqZ7ai3M20+XCy0yOLRfBuyuF9/DrZlX3ovZUnqWJlTOWB5/N51BOYsIH8MuMafTZgJbA1GXPeqVmzIYuWhGYh8A6tbkZ9RhPBexlPUXrfUGd7xZCzzlQe34Ybtb+2MguHVdl5hRtmbIE1fBDDrB/Atkk1UFP9mlBJm3JP9VSatYmuMrzYqX3CAkv/VmFE3qqMZCRgGV+TScuY4qG/OvP+XzERU1I5EKYF8cEduKx5wxMls5LGP81W1SDRIRukqVThBxRK0lzpxPP6mhkEbYc+EfiaHfK2IIL+4fOGNnDAmlXlR1XW8M0g08CkjFimyPqoN2743Qr7ZnHch1nWqupCg8WxwUDmEOYlsTIRevwEUNh8MR/iaa/An5LiWZAwjcXTHjLgIdBHxpLAAbzUguTukWJKGh6g9/w96/ZNgJ1z4tmBLFjvYP2R8j7VEeVTd2IYFoLHkkbQSM6/z+kFwmF/pPEXk/TFBLAiyOp9Aunyrvgr/WDnTdczk4cRkjtlygy1qPgVaf98NlsRNFlH8mIkLFgrZ3PXEvPe0tYiqGlYYeZbsjmk3cI3BPu99aapgKOyN4GJqeCyCqOjekajEid1JAVHfrg42s2Osyvx3Wipr6bGq1UdnwCYPeRaQx14N6e4qWFr96exSidZ4jIfhHyZfHdu9pZA4KLlf+bPx2ssMmsZCPts/CPEO/tLOO+PhBn3DUpPKyHTS99B9z8IWQFUEsllSyDZkaqxHagd6fSZJ50IUZ6fb6gHlPts4GhVCav4tfb8k09d827L1N77CHOUaUJZWmSR8IoaWmYZPcVSjKvVz/A54ZhGwfd/FuAJemsJFTJ0zQeKkhWnFxdgHkyS8noX+M9SBryWLwGqzHkncMcuPsQbPcS7z2ppxoZiuMIP4kYCelG/md3kvVhqY+p7O6bszixavbgpvP1YY1sq+ZaWEhsYMQibcq3+rcCJk7r1SFeisp/WVL6VMelmXOA6ZDmnt9X1uIshIMOraZxp0HWOslU5Qf2NiHI6PJjrarD8oBD6W2RaOXmrPXF0i9MW/5wzd6v4IzrPJqWsE/d5BbX2Zb5HFlgRcmdDiSHdeTaaH1PQ1BNDFPBLAZmWgubUzKNp/uHSyF2/JXMtlZb8prVZXS9NXuD/2d2XfWZ4KzkSkg5JHOeHdsf2nKh9VkMePvNOFoVzFmrv8jRbuDpUdZGI1CbAreVXQaUcaEtto1glLtlrrZVa1Jx8LIuGrW7JVYKstze8wy7PR6mevVVxt8VNyCP8/zHW11TqccTAwEbFpY7IZvvyGFci4EmUmMr+6MdOw9duhH/SwHsCVyJjkBXUhb8Bt+wTRxOBI6Gjp3ICEo5ISF5BNxwx6LFtiDH6WHFKILMYZHn14a2NbMGHpiewELVZ3f+3XZIvZq/NOgT4UyBWmRWNZnT3noOsdpYJaZYeY95sEu9wUhgZ876BEDAI8EEjPc+wT0GC91BZ8R261PMMIGQOxzUzQ3F05qiQ3CITId4mXAmBYFKtCU5XT9hA7h8TarKwcpCL9xJcJqJq2apPkLb5IN1s60iSlb6P65ZvmhzmZvC9Fdysylhm8oStSF9DCg7uh824rCjDZ5U/8QE/cn18DhbKosGtjyIElsDMofFnmAozfZ61N6nVFaH03r/3PYBtlF0QN92kyyCvPC/zXBo17dzxhTmb6jPTSR8fHvqq4P28WtLDScvCv5GlaDNbIDfnUJyQTtmFj7BdB2MVMTYaExSovqAk8C0Lko9QF8roR5kjAsqu/ctUwS+LNuYMmC4UPEnKqmY1xKDRIqAR7ruaSQFYvJyI1Jwn0la5MsqrFJHGTvtmUPdvXGBocQdRCSCIZ52FVAzqDdxgHtEoIEOWENcBRLabV77Sz02VibZLxwOhgX8VpYPoN4rEZUVRcgZQq0QMUVh4egjFW5xYpYFWK74zQhYBCliVm9bHMSgZAcbRTfU+DLujAetLSpC88J9HZj+cVQVG6LVYy1M+WsedZAEk3e4yMb9C5V70O8mlS6EHDJyMLgPK4g9Hz0LOIHsjkBN/oE0o1BA304+ByF2Hv69za/kbQdhyVjBJxcOM1yrzwW7fYD01MM3ddpQc71f2Y6sQRjmw8cGxkmh2oVjeaiSFQQHnhJ4/INgTg94BuROu8kvCVZJTXoeQbmjZf/GfN5N0U/7Ugrjy5ZuMiwYG95sUfWq+5urjzouBqms8VI0JQ+4g3ciefqFcferIq1Ez87YsBlPt2/Fxc+0CvxQQ6oOklGccYwASJSmFQ8DaGBEtLfBbC5tPIkAaHZh4U5hgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2280,"cache_read_input_tokens":77294,"cache_creation":{"ephemeral_5m_input_tokens":2280,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGM9RGzJzFPtEfc1J6S","type":"assistant","uuid":"0ece6faf-126e-43ec-88c0-85a0f860ceae","timestamp":"2026-01-25T01:56:41.323Z"}
{"parentUuid":"0ece6faf-126e-43ec-88c0-85a0f860ceae","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01M7B5WgUzmETRsPY3odNX2d","type":"message","role":"assistant","content":[{"type":"text","text":"Necesito verificar cómo se calcula `creditos_restantes` en el modelo EmpresaPlan."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2280,"cache_read_input_tokens":77294,"cache_creation":{"ephemeral_5m_input_tokens":2280,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGM9RGzJzFPtEfc1J6S","type":"assistant","uuid":"11c7f511-0e92-41d2-8e3b-a93eae7b7d62","timestamp":"2026-01-25T01:56:41.343Z"}
{"parentUuid":"11c7f511-0e92-41d2-8e3b-a93eae7b7d62","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01M7B5WgUzmETRsPY3odNX2d","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JwP4G19aW2G3jUVv5bNntM","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2280,"cache_read_input_tokens":77294,"cache_creation":{"ephemeral_5m_input_tokens":2280,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGM9RGzJzFPtEfc1J6S","type":"assistant","uuid":"c5ef565d-e018-4f03-b141-ab715fcd2747","timestamp":"2026-01-25T01:56:41.868Z"}
{"parentUuid":"c5ef565d-e018-4f03-b141-ab715fcd2747","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JwP4G19aW2G3jUVv5bNntM","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Empresas;\n     4→\n     5→use App\\Models\\Planes\\Plan;\n     6→use App\\Models\\Usuarios\\User;\n     7→use App\\Models\\Planes\\Consumo;\n     8→use App\\Models\\Pruebas\\Prueba;\n     9→use OwenIt\\Auditing\\Auditable;\n    10→use App\\Models\\IA\\ConsumoCredito;\n    11→use App\\Models\\Planes\\EstadoPlan;\n    12→use App\\Models\\Planes\\PlanCredito;\n    13→use App\\Models\\Planes\\Funcionalidad;\n    14→use App\\Models\\Configuraciones\\Archivo;\n    15→use Illuminate\\Database\\Eloquent\\Model;\n    16→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n    17→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    18→use Illuminate\\Database\\Eloquent\\Relations\\MorphMany;\n    19→use Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n    20→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    21→\n    22→class EmpresaPlan extends Model implements AuditableContract\n    23→{\n    24→    use Auditable;\n    25→\n    26→    protected $table = 'empresas_planes';\n    27→\n    28→    protected $fillable = [\n    29→        'empresa_id',\n    30→        'plan_id',\n    31→        'plan_credito_id',\n    32→        'usuario_id',\n    33→        'estado_id',\n    34→        'unidades',\n    35→        'cantidad_ofertas_laborales',\n    36→        'cantidad_usuarios',\n    37→        'cantidad_pruebas',\n    38→        'creditos',\n    39→        'fecha_inicio',\n    40→        'fecha_vencimiento',\n    41→        'precio',\n    42→        'porcentaje_descuento',\n    43→        'numero_factura',\n    44→        'comentario',\n    45→        'plan_original',\n    46→        'renovando',\n    47→        'por_facturar'\n    48→    ];\n    49→\n    50→    protected $casts = [\n    51→        'plan_credito_id'   => 'integer',\n    52→        'creditos'          => 'integer',\n    53→        'fecha_inicio'      => 'date:Y-m-d',\n    54→        'fecha_vencimiento' => 'date:Y-m-d'\n    55→    ];\n    56→\n    57→    protected $appends = [\n    58→        'vigencia_dias',\n    59→        'creditos_restantes'\n    60→    ];\n    61→\n    62→    /**\n    63→     * Obtener el atributo vigencia_dias.\n    64→     *\n    65→     * @return int\n    66→     * @author Daniel Beltrán\n    67→     */\n    68→    public function getVigenciaDiasAttribute(): int {\n    69→        $vigencia = 0;\n    70→\n    71→        if (!is_null($this->fecha_vencimiento) && !is_null($this->fecha_inicio)) {\n    72→            $vigencia = $this->fecha_inicio->diffInDays($this->fecha_vencimiento);\n    73→        }\n    74→\n    75→        return $vigencia;\n    76→    }\n    77→\n    78→    /**\n    79→     * Obtener el atributo creditos_restantes.\n    80→     *\n    81→     * @return int\n    82→     * @author Sergio Vargas\n    83→     * @author Daniel Beltrán\n    84→     */\n    85→    public function getCreditosRestantesAttribute(): int {\n    86→        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    87→    }\n    88→\n    89→    /**\n    90→     * Relación de muchos a uno con empresas.\n    91→     *\n    92→     * @return BelongsTo\n    93→     * @author Daniel Beltrán\n    94→     */\n    95→    public function empresa(): BelongsTo {\n    96→        return $this->belongsTo(Empresa::class);\n    97→    }\n    98→\n    99→    /**\n   100→     * Relación de muchos a uno con planes.\n   101→     *\n   102→     * @return BelongsTo\n   103→     * @author Daniel Beltrán\n   104→     */\n   105→    public function plan(): BelongsTo {\n   106→        return $this->belongsTo(Plan::class);\n   107→    }\n   108→\n   109→    /**\n   110→     * Relación de muchos a uno con planes_creditos.\n   111→     *\n   112→     * @return BelongsTo\n   113→     * @author Sergio Vargas\n   114→     * @author Daniel Beltrán\n   115→     * @author Jair Carvajal\n   116→     */\n   117→    public function planCredito(): BelongsTo {\n   118→        return $this->belongsTo(PlanCredito::class, 'plan_credito_id')->withDefault([]);\n   119→    }\n   120→\n   121→    /**\n   122→     * Relación de uno a varios con users.\n   123→     *\n   124→     * @return BelongsTo\n   125→     * @author José Manuel Jiménez\n   126→     */\n   127→    public function usuario(): BelongsTo {\n   128→        return $this->belongsTo(User::class);\n   129→    }\n   130→\n   131→    /**\n   132→     * Relación de muchos a uno con estados_planes.\n   133→     *\n   134→     * @return BelongsTo\n   135→     * @author Daniel Beltrán\n   136→     */\n   137→    public function estado(): BelongsTo {\n   138→        return $this->belongsTo(EstadoPlan::class);\n   139→    }\n   140→\n   141→    /**\n   142→     * Relación de uno a muchos con consumos.\n   143→     *\n   144→     * @return HasMany\n   145→     * @author Daniel Beltrán\n   146→     */\n   147→    public function consumos(): HasMany {\n   148→        return $this->hasMany(Consumo::class, 'empresa_plan_id');\n   149→    }\n   150→\n   151→    /**\n   152→     * Relación de uno a muchos con consumos de créditos.\n   153→     *\n   154→     * @return HasMany\n   155→     * @author Sergio Vargas\n   156→     * @author Daniel Beltrán\n   157→     */\n   158→    public function consumosCreditos(): HasMany {\n   159→        return $this->hasMany(ConsumoCredito::class, 'empresa_plan_id');\n   160→    }\n   161→\n   162→    /**\n   163→     * Relación de muchos a muchos con pruebas.\n   164→     *\n   165→     * @return BelongsToMany\n   166→     * @author Daniel Beltrán\n   167→     */\n   168→    public function pruebas(): BelongsToMany {\n   169→        return $this->belongsToMany(Prueba::class, 'empresas_planes_pruebas', 'empresa_plan_id', 'prueba_id')->withTimestamps();\n   170→    }\n   171→\n   172→    /**\n   173→     * Relación polimórfica de uno a muchos con archivos.\n   174→     *\n   175→     * @return MorphMany\n   176→     * @author Daniel Beltrán\n   177→     */\n   178→    public function archivos(): MorphMany {\n   179→        return $this->morphMany(Archivo::class, 'modelo', 'modelo', 'modelo_id');\n   180→    }\n   181→\n   182→    /**\n   183→     * Relación de muchos a muchos con funcionalidades.\n   184→     *\n   185→     * @return BelongsToMany\n   186→     * @author Daniel Beltrán\n   187→     */\n   188→    public function funcionalidades(): BelongsToMany {\n   189→        return $this->belongsToMany(Funcionalidad::class, 'empresas_planes_funcionalidades', 'empresa_plan_id', 'funcionalidad_id')->withTimestamps();\n   190→    }\n   191→\n   192→    /**\n   193→     * Determinar si es un plan solo de creditos (sin plan base).\n   194→     *\n   195→     * @return bool\n   196→     * @author Sergio Vargas\n   197→     */\n   198→    public function esSoloPlanCreditos(): bool {\n   199→        return !is_null($this->plan_credito_id) && is_null($this->plan_id);\n   200→    }\n   201→\n   202→    /**\n   203→     * Determinar si es un plan hibrido (plan base + creditos).\n   204→     *\n   205→     * @return bool\n   206→     * @author Sergio Vargas\n   207→     */\n   208→    public function esPlanHibrido(): bool {\n   209→        return !is_null($this->plan_id) && !is_null($this->plan_credito_id);\n   210→    }\n   211→\n   212→    /**\n   213→     * Determinar si tiene creditos asignados.\n   214→     *\n   215→     * @return bool\n   216→     * @author Sergio Vargas\n   217→     */\n   218→    public function tieneCreditos(): bool {\n   219→        return !is_null($this->plan_credito_id) || $this->creditos > 0;\n   220→    }\n   221→\n   222→    /**\n   223→     * Verificar si los creditos estan agotados.\n   224→     *\n   225→     * @return bool\n   226→     * @author Sergio Vargas\n   227→     */\n   228→    public function creditosAgotados(): bool {\n   229→        if (!$this->tieneCreditos()) {\n   230→            return false;\n   231→        }\n   232→\n   233→        return $this->creditos_restantes <= 0;\n   234→    }\n   235→}\n   236→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d72d3f40-886c-4231-b0c2-d78240dc5b08","timestamp":"2026-01-25T01:56:42.732Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php","content":"<?php\n\nnamespace App\\Models\\Empresas;\n\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Usuarios\\User;\nuse App\\Models\\Planes\\Consumo;\nuse App\\Models\\Pruebas\\Prueba;\nuse OwenIt\\Auditing\\Auditable;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Models\\Planes\\EstadoPlan;\nuse App\\Models\\Planes\\PlanCredito;\nuse App\\Models\\Planes\\Funcionalidad;\nuse App\\Models\\Configuraciones\\Archivo;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Database\\Eloquent\\Relations\\MorphMany;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\nuse OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n\nclass EmpresaPlan extends Model implements AuditableContract\n{\n    use Auditable;\n\n    protected $table = 'empresas_planes';\n\n    protected $fillable = [\n        'empresa_id',\n        'plan_id',\n        'plan_credito_id',\n        'usuario_id',\n        'estado_id',\n        'unidades',\n        'cantidad_ofertas_laborales',\n        'cantidad_usuarios',\n        'cantidad_pruebas',\n        'creditos',\n        'fecha_inicio',\n        'fecha_vencimiento',\n        'precio',\n        'porcentaje_descuento',\n        'numero_factura',\n        'comentario',\n        'plan_original',\n        'renovando',\n        'por_facturar'\n    ];\n\n    protected $casts = [\n        'plan_credito_id'   => 'integer',\n        'creditos'          => 'integer',\n        'fecha_inicio'      => 'date:Y-m-d',\n        'fecha_vencimiento' => 'date:Y-m-d'\n    ];\n\n    protected $appends = [\n        'vigencia_dias',\n        'creditos_restantes'\n    ];\n\n    /**\n     * Obtener el atributo vigencia_dias.\n     *\n     * @return int\n     * @author Daniel Beltrán\n     */\n    public function getVigenciaDiasAttribute(): int {\n        $vigencia = 0;\n\n        if (!is_null($this->fecha_vencimiento) && !is_null($this->fecha_inicio)) {\n            $vigencia = $this->fecha_inicio->diffInDays($this->fecha_vencimiento);\n        }\n\n        return $vigencia;\n    }\n\n    /**\n     * Obtener el atributo creditos_restantes.\n     *\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getCreditosRestantesAttribute(): int {\n        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    }\n\n    /**\n     * Relación de muchos a uno con empresas.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function empresa(): BelongsTo {\n        return $this->belongsTo(Empresa::class);\n    }\n\n    /**\n     * Relación de muchos a uno con planes.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function plan(): BelongsTo {\n        return $this->belongsTo(Plan::class);\n    }\n\n    /**\n     * Relación de muchos a uno con planes_creditos.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planCredito(): BelongsTo {\n        return $this->belongsTo(PlanCredito::class, 'plan_credito_id')->withDefault([]);\n    }\n\n    /**\n     * Relación de uno a varios con users.\n     *\n     * @return BelongsTo\n     * @author José Manuel Jiménez\n     */\n    public function usuario(): BelongsTo {\n        return $this->belongsTo(User::class);\n    }\n\n    /**\n     * Relación de muchos a uno con estados_planes.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function estado(): BelongsTo {\n        return $this->belongsTo(EstadoPlan::class);\n    }\n\n    /**\n     * Relación de uno a muchos con consumos.\n     *\n     * @return HasMany\n     * @author Daniel Beltrán\n     */\n    public function consumos(): HasMany {\n        return $this->hasMany(Consumo::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de uno a muchos con consumos de créditos.\n     *\n     * @return HasMany\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function consumosCreditos(): HasMany {\n        return $this->hasMany(ConsumoCredito::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de muchos a muchos con pruebas.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function pruebas(): BelongsToMany {\n        return $this->belongsToMany(Prueba::class, 'empresas_planes_pruebas', 'empresa_plan_id', 'prueba_id')->withTimestamps();\n    }\n\n    /**\n     * Relación polimórfica de uno a muchos con archivos.\n     *\n     * @return MorphMany\n     * @author Daniel Beltrán\n     */\n    public function archivos(): MorphMany {\n        return $this->morphMany(Archivo::class, 'modelo', 'modelo', 'modelo_id');\n    }\n\n    /**\n     * Relación de muchos a muchos con funcionalidades.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function funcionalidades(): BelongsToMany {\n        return $this->belongsToMany(Funcionalidad::class, 'empresas_planes_funcionalidades', 'empresa_plan_id', 'funcionalidad_id')->withTimestamps();\n    }\n\n    /**\n     * Determinar si es un plan solo de creditos (sin plan base).\n     *\n     * @return bool\n     * @author Sergio Vargas\n     */\n    public function esSoloPlanCreditos(): bool {\n        return !is_null($this->plan_credito_id) && is_null($this->plan_id);\n    }\n\n    /**\n     * Determinar si es un plan hibrido (plan base + creditos).\n     *\n     * @return bool\n     * @author Sergio Vargas\n     */\n    public function esPlanHibrido(): bool {\n        return !is_null($this->plan_id) && !is_null($this->plan_credito_id);\n    }\n\n    /**\n     * Determinar si tiene creditos asignados.\n     *\n     * @return bool\n     * @author Sergio Vargas\n     */\n    public function tieneCreditos(): bool {\n        return !is_null($this->plan_credito_id) || $this->creditos > 0;\n    }\n\n    /**\n     * Verificar si los creditos estan agotados.\n     *\n     * @return bool\n     * @author Sergio Vargas\n     */\n    public function creditosAgotados(): bool {\n        if (!$this->tieneCreditos()) {\n            return false;\n        }\n\n        return $this->creditos_restantes <= 0;\n    }\n}\n","numLines":236,"startLine":1,"totalLines":236}},"sourceToolAssistantUUID":"c5ef565d-e018-4f03-b141-ab715fcd2747"}
{"parentUuid":"d72d3f40-886c-4231-b0c2-d78240dc5b08","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_015cM2ogi2ThCgF73pHtsw3r","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El modelo ya tiene el atributo `creditos_restantes` como accessor y está en el array `$appends`, por lo que se incluirá automáticamente cuando se serialice a JSON.\n\nAhora, mirando el código del frontend en `empresas.js`, veo que ya existe código para mostrar los planes de créditos (líneas 1678 en adelante). Sin embargo, hay un problema en el filtro inicial que excluye estos planes:\n\n```javascript\n// Líneas 1503-1505\nif (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n    continue;\n}\n```\n\nEste código filtra los planes que no tienen un `plan` asociado. Los planes de solo créditos tienen `plan_id = NULL`, por lo que `planes[i].plan` sería `null` y estos planes se saltan.\n\nSin embargo, veo que hay un segundo bucle (líneas 1680 en adelante) que sí procesa los planes de créditos buscando `planes[i].plan_credito && planes[i].plan_credito.id`. \n\nEso significa que el código del frontend ya debería manejar los planes de créditos en ese segundo bucle. El problema era que el backend no estaba incluyendo estos planes en la respuesta.\n\nCon los cambios que hice en el backend, ahora los planes de solo créditos se incluirán en la respuesta, y el segundo bucle del frontend debería mostrarlos correctamente.\n\nSin embargo, debo verificar que la función `obtenerAccionesCreditos()` existe. Voy a buscarla en el archivo.","signature":"Et4LCkYICxgCKkDnz4nkpphY74SxchTPvVJH9ZLJqislSfOTwmHSUvUwj2OjTuOGWdH34S7KRyR+eQf2qH9H7x7/t0Nx3ELrdik5Egw4w8YTgDhqVmA5xLQaDDzUVgxsw5L2yrUwciIwzlhR8Ke1dt2CWgdU49exDFpp4xle17byH2KmV5p/qcghivBrJrTTgOjQU9ga/QBsKsUKSOZU7zR7ydJon7oSNgQAlF0O7F3vgP452c/TWC2Rq5lQueOD1wIIwtqhD7lr0HqYh467ybXDbgFayg/4NRhdRmRTU93ZL/VnzJaiD8OQYnWcXIosxFKUYydn7QWwruvaXVKTvrhl7/y6uyKgbb0KPkVYzrkaqpJk5jK0AlCdiYFVNIU1FTtAXSg44E2mUwA/iD6+Ab7k3EeI4eSZRXpSLN7YmmkK5+bwXRHzhVbQYFc2nyjUtIBMmnA0C2Gmj08IsmTzGeZC3tqlRYBxB612l0GLJq2t0mF+b1qfBb+J9kK1nIPTXsp6I0oJ1j92BIaZRRxgXau4bloYyrUyaIZDYrOuOcU5qtPU7oUq+hrrX+FNKct994HeHAayOQHI3CBMVdwOKIMQOuvypeqVlI6m51EHTqvlC7LkSX3ML5VRFeIhDwmmYgQTLmHdjfk+i67kkEVWaDzTRUlUiagkR5XUKIn4CR/BnC6V9u7Jwjd7TzQ6HJ6V6mvKpxvW/Yp2+23tD9sgsFDwwHWz3fVWXbklUWvsZXBMjuFRiflJEWTwbVwzdOYawsNZEx4dH3aSNZCUPjPljGfwKlFxPJs4gHzjhJYFCW++/XSvajNsc6qyzmJlkeym4Nh/YDHU1fyo2VT8FlzsXbXFgGKw2h/z1HskuSuKnhFN4lwbhpUAV8ZQqt7Syhz5bWV4qN/p96n3grYwgfBw+Qu+1JRVk+K3r5JaihtuBLqBDPvUJTA2ErcP7IRzcNnlNo4bPvYldsQDAAvmzLOuheut3g+DddzwGViwTJVDMTqFqzw6kfaHc1TWsH+CYV1c0q1at+pvY+tZTICyZA/AJ5HuyHk3p0luWm+zUn7uUw+fPW755Qs8kxx83RVZXLHgiNjRxhHWirKP6+tcID1dnS4D72LGBuaxWjh1Tb0n7tMiY6b57Xe+J0TltgivmEEl+FXJCTdjVrlLY+TDa6zFWHGJZ3x58IJYXak5yvgl2I3zclNt3gHADjhXmt16ux6A4HxvEcGsRdhSc14lo8fiHEPtsnmqsXzbPPGRty6HztU3ANO2EL4/9edB3QGHpAXL+E+3vH6lBg9WlADymcIuRZOuZI6nMIQgEIDdoYqbmGuhZsG1gOYj6o+Z7QAUtGMGQeu+c2rXHM6/Nwt0YFWevRutdPb2wBYh4uPERGOCsram5Zu5DzL4LVuBV1HoXQNJdqlYIgbCKjYSxEVX8jbnccrLniFWZp5lp6PWhDCgu7igG6yyVkzyF1085VCtYHzw3hnNyMNykBkZ0VX1YVHF8RJDNaysXOaeX11P8Ugf9uZsngxl/TLhD0hIV8VLFiBSVUCgt4gOLmFv2WevxahhFxAwtAu/RKq2t/MRsnjMmpGzt+dD0ltuZZUyyGkNCQz7JmVhCpFhOqIIgMAPZHuBPrRwvQsmOCu8TvjbhTvA4Z2HC47K0TagKmjx22Dchim5h31kRuxmQv6t9HUerq/dkfwpJwoH82EXczG9LAGF/zYomPDdRk2/7IDX1X1CESO8jNnH34wX3bKAn4KKspBwVxcuUML6H3ox1gpInMzva7LRrAzsz5aP878taHOy4ypIR9V5dNT4iwNs0zIk+6Vk+sOfXOde/CeFyxQwaj2bMriPMk8YLNkd1x9hb34rEb9H2f/FVYuIoukOUnrO/Z6FtdP/xxjEIUCvlyJnaOoVEDDoXCgwPVgIATkheYFNHVlwPAm7/qeXi6WJDrjxoqvwVtHlP1FVD4QCW9NdZjLxz/EmpBrx8wJ+Lofk5uaI0KxTdsvstA/fZuWoFKDSwtkCqTUYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3670,"cache_read_input_tokens":79574,"cache_creation":{"ephemeral_5m_input_tokens":3670,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGNK9SdrR8CarWq18ad","type":"assistant","uuid":"65b7269c-0ae5-4ece-b4ae-815b3e1dd9c4","timestamp":"2026-01-25T01:56:53.244Z"}
{"parentUuid":"65b7269c-0ae5-4ece-b4ae-815b3e1dd9c4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_015cM2ogi2ThCgF73pHtsw3r","type":"message","role":"assistant","content":[{"type":"text","text":"Veo que el modelo ya tiene `creditos_restantes` como accessor. Ahora necesito verificar si existe la función `obtenerAccionesCreditos()` en el archivo JS."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3670,"cache_read_input_tokens":79574,"cache_creation":{"ephemeral_5m_input_tokens":3670,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGNK9SdrR8CarWq18ad","type":"assistant","uuid":"c0b7cd00-9259-4481-bed7-f1e7ff79cb42","timestamp":"2026-01-25T01:56:53.986Z"}
{"parentUuid":"c0b7cd00-9259-4481-bed7-f1e7ff79cb42","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_015cM2ogi2ThCgF73pHtsw3r","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014sA4KDxcMWRUSypauwEp2L","name":"Grep","input":{"pattern":"function obtenerAccionesCreditos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3670,"cache_read_input_tokens":79574,"cache_creation":{"ephemeral_5m_input_tokens":3670,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGNK9SdrR8CarWq18ad","type":"assistant","uuid":"1f3b3a4f-4441-4e78-b42c-a008383887ce","timestamp":"2026-01-25T01:56:55.793Z"}
{"parentUuid":"1f3b3a4f-4441-4e78-b42c-a008383887ce","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014sA4KDxcMWRUSypauwEp2L","type":"tool_result","content":"1951:function obtenerAccionesCreditos(estado_id, id, empresa_id, id_archivo, nombre_comercial_empresa, nombre_plan, creditos, creditos_restantes) {"}]},"uuid":"11179799-1ce9-43fa-a661-a7dbffaea9bf","timestamp":"2026-01-25T01:56:57.155Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"1951:function obtenerAccionesCreditos(estado_id, id, empresa_id, id_archivo, nombre_comercial_empresa, nombre_plan, creditos, creditos_restantes) {","numLines":1},"sourceToolAssistantUUID":"1f3b3a4f-4441-4e78-b42c-a008383887ce"}
{"parentUuid":"11179799-1ce9-43fa-a661-a7dbffaea9bf","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YSqxfGDJJyUYjLfEbdsxYV","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"La función ya existe. Ahora veo que el código del frontend ya debería manejar los planes de créditos. Veo que en las líneas 1678-1743 ya hay código para renderizar los planes de créditos. Entonces el único problema era que el backend no estaba enviando estos planes.\n\nCon los cambios que hice en el backend, ahora los planes de solo créditos (`plan_id = NULL` y `plan_credito_id != NULL`) se incluirán en la respuesta y el frontend debería mostrarlos correctamente.\n\nDéjame verificar que los cambios del backend se aplicaron correctamente.","signature":"Es4FCkYICxgCKkAkmeX3614LYj7XYvp41QsNx/iGGybg4RLflWqOiPBSp4XZeq/1rYJ7yQSzYT3sBVz5NzlJIm0Y4TnA5sQbWXJvEgy9h+NS0079s5/FpOsaDKKzg09zgAAYq15nZiIwroF8oHaoomr/CYuRtTAaSj6nLExvHvX2mHPRKedKKnkqXK0bKYb2jHZ6syrqcRwRKrUE+memnlkA6RXIe+Q2duF8i42PsbW/T2Bb1+90xZyqsznszWkRgzCIGiDnXgTtlnjz30pF0yXuSAfICpEUBaQmd9tNe8spEbdl0uwUvknSMz9uDiEwIyokVCsJ4d+3N/tyzrkFGlKJk2ByipWK4z5RnnoMlJeD3U5G2YN8xABafOml+IoHGuDiKvMbvOZUyFx1nyShAz3qIR+A6T9AD9If3IJxDyajQQXrN2XBBNU288naKdBt3u5KCpNIratC5Nqq+n5CgT4FVeDf+kraSM4/+qXT9Cd/uSotgCta4djTyESvP0ThRiGRpSyH17ZnesRctUvoODgNDMXZqHITycdZJG8K8cSyWfiWgdwzpUZkNQ2QC3mVeTzVH8IXvtm0/oWtYZg5xV5N0NbqGAgtnO1M/vboWsX591zJpoLle00wwWNpPmb8thX8ycwpRjAWxf80AgaHn8yylROtcDdCz/S35H5UJ0aEiA42E9d8lfoKwP0A0X0nIm4jkmehvo9ru6NycAz3mI0NuC+nEBt5bQht3ExdECpRrjxBeYWcNWM3z75cXbCs6z4U7Ayxcurwd/Jh9shJQzvsnFbCxeYqm9Kjga6ksN2vbfVo/yYkf65iu6RWUoPp+LDGMesbH5fyY3WjnXGGlGVtaOAsWKPEO+RCRC63PPqZqc9exriSYuwfDm4r3H2LxbnsESZVcQimMIQHj7M/7aZPd7lBFcFSPhZrrCrJX9lMiZMi0KX14/djqx5ns5k03BgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":644,"cache_read_input_tokens":83244,"cache_creation":{"ephemeral_5m_input_tokens":644,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGPNMD9P7PqUu9eFqJC","type":"assistant","uuid":"0f69a780-7f23-486f-b502-825d1db6d9bb","timestamp":"2026-01-25T01:57:01.236Z"}
{"parentUuid":"0f69a780-7f23-486f-b502-825d1db6d9bb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YSqxfGDJJyUYjLfEbdsxYV","type":"message","role":"assistant","content":[{"type":"text","text":"Verifiquemos los cambios realizados en los archivos del backend."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":644,"cache_read_input_tokens":83244,"cache_creation":{"ephemeral_5m_input_tokens":644,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGPNMD9P7PqUu9eFqJC","type":"assistant","uuid":"38640b25-4b58-4c38-94bc-6b62304561c1","timestamp":"2026-01-25T01:57:01.719Z"}
{"parentUuid":"38640b25-4b58-4c38-94bc-6b62304561c1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YSqxfGDJJyUYjLfEbdsxYV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VXDBNE4DKKL9onsNWqqAd1","name":"Grep","input":{"pattern":"planesCreditosActivos|obtenerPlanesCreditosActivos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":644,"cache_read_input_tokens":83244,"cache_creation":{"ephemeral_5m_input_tokens":644,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGPNMD9P7PqUu9eFqJC","type":"assistant","uuid":"1ba251d5-78e8-4727-b415-668f9b206cbb","timestamp":"2026-01-25T01:57:02.882Z"}
{"parentUuid":"1ba251d5-78e8-4727-b415-668f9b206cbb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VXDBNE4DKKL9onsNWqqAd1","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php:120:            $planes_creditos = $this->empresa_plan_servicio->obtenerPlanesCreditosActivos($id);\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:493:    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:494:        return $this->repositorio->planesCreditosActivos($empresa_id);\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php:376:    public function planesCreditosActivos(int $empresa_id): Collection {"}]},"uuid":"8374d786-f13a-49ef-a634-2d19a9f453d4","timestamp":"2026-01-25T01:57:04.282Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php:120:            $planes_creditos = $this->empresa_plan_servicio->obtenerPlanesCreditosActivos($id);\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:493:    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:494:        return $this->repositorio->planesCreditosActivos($empresa_id);\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php:376:    public function planesCreditosActivos(int $empresa_id): Collection {","numLines":4},"sourceToolAssistantUUID":"1ba251d5-78e8-4727-b415-668f9b206cbb"}
{"parentUuid":"8374d786-f13a-49ef-a634-2d19a9f453d4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GAyBvzkMDHSPoLS4EBS6Bx","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Los cambios del backend están correctamente aplicados. Ahora verifico si el frontend ya tiene el código para mostrar los planes de créditos. Voy a verificar que el código existente en el frontend funciona correctamente con los nuevos datos enviados por el backend.\n\nVeo que el archivo `empresas.js` ya tiene código en las líneas 1678-1743+ para renderizar los planes de créditos. Ese código busca planes donde `planes[i].plan_credito && planes[i].plan_credito.id`, lo cual debería funcionar con los datos que ahora envía el backend.\n\nSin embargo, también necesito asegurarme de que hay una función helper `obtenerFecha()` y todas las funciones auxiliares necesarias. Vamos a ver el código completo del segundo bucle.","signature":"EoAHCkYICxgCKkBO+ngi7MTJtp4I47bZTJh/BFKlAyoWp/sQLTTFvf59ZD8gCtuKDZwL5wlJvtYeAc9Eua8jfmE3vLELDbxvLnXVEgw67HFKhgSkwZAtoosaDOR1HfddjcgYp1UcJyIwbgaxCXPOpH1fRX/y+Ov9B4etf7NAxEgmYaoTfYKkHOr3p/2oiDWHgFNSqpVME/zeKucF9g/P4dyeA0KzxTFe4Bl44R5fxZbBqXiIywbOcHxlsYykJOFAJkAeZAPaumvRCkM+8h+okIY1SeI4mJz9TvYi33Avn0YSyyF0z3YWOKG+BQ435VFG2JYGtFdiK+zLaeVEwteRnrYY06m4GSA1MLgOECsMMggdqsZbf52XjljxFCm1K4UzEkJFOZ8iTTqCaAUF/yiADIqfSawA5H7zflKduGwP0q0kj+mkOe7nWaFwK13IlE/g+ed+kkDBKYmVRnicr8x9Y19KDHJicLI4SRAgsf4bvNhEVpuWlRlXTk54LAin9cCTiVtwkv8oceL/uRNHcfZR6QNu3+RyG961nP+O/BBPdxzJwkxPpNb2a003ru1TvSjk924tTd/9cs9/Qrz9iAmxbEkuc24bitcMOxjvJzK5MnzaQ/f3H6CUA/+IUWQpw/mTh14NxEhyov5lz+ceqcF7uPOlLrYaqtYKQXRmMwaLRuCvD39Rz0QUaVc5+sBk9QE1ouPL2tlQrO+dndfUlKvt6B82/jd0Q1m0y9Xwy12iqNv84ZMOZRV9tCxYxuTFPL8XchDYFmhjkgysGYVhIB4Pi72TxQ/FprRlVdq9UNOEx4BV6mwBZcLTSEz+LTJI2JfO8lS8N+ipIDtB+3qnoq6jcYJU5VBDqt/YtjL6zTXhg9a8gnoB4iNVyQ9vAEfa9+wE2Dg/KS8xiwgEAva0kMKyfQFsTspfD7TP3VVrFL3C//oH7PSj0ucHCfDJGIxVjqWUGo0OVtiDrA0ydtXADKqqi1nplE7yHUFwEF7JBT2AawE59STPFSjUe42VIFXwShSS8ydkuWjYq1sooj9mEEERRYcT9fYCyNP++t/Cd5bw07t2Mj0Q/11Mt4xztMXjsrOZfr4BVylhdu8dOuDPnjb8Ut9ZJYa2zGjJcoKXYnNCflOv4at1MfYpCSmRf63p4TkOBzkIB1UPIjhp6PXJjM5uCEqNsifs0as4+CMmOisOto1xlO8YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":587,"cache_read_input_tokens":83888,"cache_creation":{"ephemeral_5m_input_tokens":587,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGPtnnTXV8gwkrioP4T","type":"assistant","uuid":"326b5017-daa9-4f1d-b061-ad7f1d84a4a7","timestamp":"2026-01-25T01:57:10.322Z"}
{"parentUuid":"326b5017-daa9-4f1d-b061-ad7f1d84a4a7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GAyBvzkMDHSPoLS4EBS6Bx","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora verifico que el código del frontend para planes de créditos esté completo."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":587,"cache_read_input_tokens":83888,"cache_creation":{"ephemeral_5m_input_tokens":587,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGPtnnTXV8gwkrioP4T","type":"assistant","uuid":"b3a9b0d2-569b-407d-8d43-c2e9f97ae8c6","timestamp":"2026-01-25T01:57:10.902Z"}
{"parentUuid":"b3a9b0d2-569b-407d-8d43-c2e9f97ae8c6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GAyBvzkMDHSPoLS4EBS6Bx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01145cHRBqGJGDXUCyP3rpdu","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":1760,"limit":70}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":587,"cache_read_input_tokens":83888,"cache_creation":{"ephemeral_5m_input_tokens":587,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGPtnnTXV8gwkrioP4T","type":"assistant","uuid":"0d859c52-036d-48d1-b944-6f080d16325e","timestamp":"2026-01-25T01:57:11.685Z"}
{"parentUuid":"0d859c52-036d-48d1-b944-6f080d16325e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01145cHRBqGJGDXUCyP3rpdu","type":"tool_result","content":"  1760→                                                <div class=\"col-auto\">\n  1761→                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n  1762→                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n  1763→                                                    </p>\n  1764→                                                </div>\n  1765→                                                <div class=\"col-12 mt-3\">\n  1766→                                                </div>\n  1767→                                            </div>\n  1768→                                        </div>\n  1769→                                        <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n  1770→                                            ${opcion_editar_credito}\n  1771→                                            ${crearBoton({\n  1772→                                                clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n  1773→                                                texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n  1774→                                                adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n  1775→                                            })}\n  1776→                                            ${acciones_credito}\n  1777→                                        </div>\n  1778→                                    </div>\n  1779→                                    <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n  1780→                                        <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n  1781→                                            ${crearTag({\n  1782→                                                class: 'tag-sm tag-tonal-yellow',\n  1783→                                                texto: 'Créditos disponibles: ' + creditos_restantes.toLocaleString('es-CO'),\n  1784→                                            })}\n  1785→                                            ${crearTag({\n  1786→                                                class: 'tag-sm tag-tonal-yellow',\n  1787→                                                texto: 'Créditos promedio por acción: ' + creditos_promedio.toLocaleString('es-CO'),\n  1788→                                            })}\n  1789→                                            ${crearTag({\n  1790→                                                class: 'tag-sm tag-tonal-yellow',\n  1791→                                                texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n  1792→                                            })}\n  1793→                                        </div>\n  1794→                                        <div class=\"d-flex justify-content-end align-items-end pe-3\">\n  1795→                                            <p class=\"text-label-2 mb-0\">\n  1796→                                                <span class=\"text-gray-50 me-3\">${fecha_creacion_credito}</span>\n  1797→                                                <span class=\"text-gray-30\">${fecha_activacion_credito}</span>\n  1798→                                            </p>\n  1799→                                        </div>\n  1800→                                    </div>\n  1801→                                </div>\n  1802→                            </td>\n  1803→                        </tr>\n  1804→                    `);\n  1805→                }\n  1806→            }\n  1807→        }\n  1808→\n  1809→        inicializarTooltips();\n  1810→        tabla_planes = $('#tabla-planes').DataTable({\n  1811→            \"paging\": false,\n  1812→            \"searching\": true,\n  1813→            \"ordering\": false,\n  1814→            \"info\": false\n  1815→        });\n  1816→        let buscador = $('#tabla-planes_wrapper input');\n  1817→        $(buscador).addClass('rounded-2 text-body-2');\n  1818→        $(buscador).prop('placeholder', 'Buscar');\n  1819→        $(buscador).prop('id', 'buscador-plan');\n  1820→        $('#input-busqueda').append(buscador);\n  1821→        $(buscador).val(buscar).trigger('input');\n  1822→    } else {\n  1823→        $('#fila-cabecera-tabla-planes').remove();\n  1824→        $('#tbody-planes').append(`\n  1825→            <tr class=\"w-100 d-flex justify-content-center align-items-center\" style=\"height: 480px;\">\n  1826→                <td class=\"d-flex justify-content-center align-items-center flex-column row-gap-4\">\n  1827→                    <p class=\"text-center text-gray-60 m-0\" style=\"font-size: 80px;\"><i class=\"bi bi-slash-circle m-0 p-0\"></i></p>\n  1828→                    <div class=\"m-0\">\n  1829→                        <p class=\"text-center text-body-2 text-gray-30 fs-4 mb-3\">Aún no hay planes asignados</p>\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"cb92b216-dd4b-4a21-830d-9f61a2579861","timestamp":"2026-01-25T01:57:12.611Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","content":"                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-12 mt-3\">\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                            ${opcion_editar_credito}\n                                            ${crearBoton({\n                                                clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                                texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                                adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                            })}\n                                            ${acciones_credito}\n                                        </div>\n                                    </div>\n                                    <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                        <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos disponibles: ' + creditos_restantes.toLocaleString('es-CO'),\n                                            })}\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos promedio por acción: ' + creditos_promedio.toLocaleString('es-CO'),\n                                            })}\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                                            })}\n                                        </div>\n                                        <div class=\"d-flex justify-content-end align-items-end pe-3\">\n                                            <p class=\"text-label-2 mb-0\">\n                                                <span class=\"text-gray-50 me-3\">${fecha_creacion_credito}</span>\n                                                <span class=\"text-gray-30\">${fecha_activacion_credito}</span>\n                                            </p>\n                                        </div>\n                                    </div>\n                                </div>\n                            </td>\n                        </tr>\n                    `);\n                }\n            }\n        }\n\n        inicializarTooltips();\n        tabla_planes = $('#tabla-planes').DataTable({\n            \"paging\": false,\n            \"searching\": true,\n            \"ordering\": false,\n            \"info\": false\n        });\n        let buscador = $('#tabla-planes_wrapper input');\n        $(buscador).addClass('rounded-2 text-body-2');\n        $(buscador).prop('placeholder', 'Buscar');\n        $(buscador).prop('id', 'buscador-plan');\n        $('#input-busqueda').append(buscador);\n        $(buscador).val(buscar).trigger('input');\n    } else {\n        $('#fila-cabecera-tabla-planes').remove();\n        $('#tbody-planes').append(`\n            <tr class=\"w-100 d-flex justify-content-center align-items-center\" style=\"height: 480px;\">\n                <td class=\"d-flex justify-content-center align-items-center flex-column row-gap-4\">\n                    <p class=\"text-center text-gray-60 m-0\" style=\"font-size: 80px;\"><i class=\"bi bi-slash-circle m-0 p-0\"></i></p>\n                    <div class=\"m-0\">\n                        <p class=\"text-center text-body-2 text-gray-30 fs-4 mb-3\">Aún no hay planes asignados</p>","numLines":70,"startLine":1760,"totalLines":3611}},"sourceToolAssistantUUID":"0d859c52-036d-48d1-b944-6f080d16325e"}
{"parentUuid":"cb92b216-dd4b-4a21-830d-9f61a2579861","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01R2vPBjYN2SvAxb6JQH7BGC","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El código del frontend ya está completo para mostrar los planes de créditos. El segundo bucle (líneas 1680-1807) maneja correctamente la renderización de los planes de créditos.\n\nEl problema inicial era que el backend no estaba enviando los planes de solo créditos (donde `plan_id = NULL` y `plan_credito_id != NULL`). Con los cambios que hice en el backend, ahora estos planes se incluirán en la respuesta.\n\nSin embargo, veo que hay un issue potencial: la condición `planes.length > 0` en la línea 1501 solo entrará si hay al menos un plan. Si los cambios en el backend funcionan correctamente, el array `planes` ahora debería incluir tanto los planes normales como los planes de créditos.\n\nTambién debo verificar que no haya duplicados. Por ejemplo, un plan que tiene tanto `plan_id` como `plan_credito_id` no se duplicará porque el método `planesCreditosActivos()` del repositorio filtra con `whereNull('plan_id')`.\n\nCreo que los cambios están completos. Vamos a resumir lo que se hizo:\n\n1. **EmpresaPlanRepository.php**: Agregado el método `planesCreditosActivos()` que obtiene planes donde `plan_id` es NULL y `plan_credito_id` no es NULL, con estados ACTIVO (1) o POR_VENCER (4).\n\n2. **EmpresaPlanService.php**: Agregado el método `obtenerPlanesCreditosActivos()` que llama al repositorio.\n\n3. **EmpresaService.php**: Modificado el método `getUno()` para incluir los planes de créditos después del foreach de tipos_pruebas.\n\nEl frontend ya tenía el código necesario para renderizar los planes de créditos, solo faltaba que el backend los enviara.\n\n\nLos cambios implementados en el repositorio, servicio y controlador principal aseguran que los planes de créditos se recuperen correctamente de la base de datos y se envíen al frontend con la estructura esperada.","signature":"EoEOCkYICxgCKkBAPrJjwftuL9D6s0xxj6RnZAzTEvu9ZunSUcnaHzwT7zT0MLh7FNf2sqjivb+6FCD3qrO08saOLHVT8Xlc1OnmEgwdSCvYoJi38zeN458aDLeo9yfb1n3Mz/xQ8SIw1fBZMbAls58b4Idaxd5mJ2XcyYcO+LP2stGjmb57XnbLMYyMCNS1MPP8Y4luu1qDKugM/xAzbbIyrlW/HpmdJ+5O9BTd8wCf9LdlhpveW7p+tT2V9CYjHHflVRupCWrgewXeaWnN23XS1aqxwsuQQ6SZVKlep/dQx+i+x8CQKgYFCj5XD3Z4vBvlq5W1F9QAFnqFAoluoJAdrSh1ZMTHbauZ6xx9ZW/D7VlRBkOd053nefZAExCuff+JcgRKdmLMGxKDNXTdjcRvD+yOYFAfoAz4KAEgfp+xayJGG37RPyDaFl0PZeiYP/MUGrTygeB8BkOC6bspR3P7/Tls/eNiQ75xX7/+CZG/sH8dgQpEdSRXyhs+lXQ/S9VVw5xXqHD6Arwj5wOjVDZrT5XpgqpXI49T8bbE0lpuUoW91O5NlB/HaRqeSh4nI9e9jjfpkne0CgzvFwe1NLCht0f9mSIbM0Y5hKUGw306t5lr7PZEbVoslFSjFj2W8kVTNgh5EwzNDp0tXd2LzTxoSZ4e185+/KDzxbv7W4vy7+kaL+jWt+uRj5rWo/HNeYTzUJHNwtoa9RM8CldlQxnSF6NVqNH22n8XMBTrej3yAF9/WjKYWVdEu0CDi+no53c/bplW0OA0DWwLsFkFuOUtK8/0F4l72cdYSF3Ho/j2RnEhckJidocg6JumqUVP61vzV85HQyfx0cvUSXM1CXFRJCTG1SquUjrY/n+GaY+yy8CTAkIg60EQ9i6sPgR+DVA9tZ64Iuf9ik61X0xnE35ydZPxUai33VHQ+zL6gEu1aaQbtRmjj3rekcKMCeSJS07QWam4BcnrLD3LtKGr9oSS+vGqevblDmBYU3wFADIyrK/2Hxo+2QvaDzghxk5FwVXPxBD/YgFn3G9FGSUmXiB/BT1ooyisIFM3jXT/cj3HWPKB6qA/EXwWeoCbPEAGeOCiKS03TQuRdjAVBDhTEN0aukKtQugD7XnZbLbf6nKaEqaDIqaOfhRJKVT+toq5lx2Xbta3k/p5BpUyXE0LIP1sBC3P0otneKdriVWl0Vfl4O+ha6AHxgOcRA2ag7FPZySpYWsa9FVoQTHILvEsrruANMoyJ9MbgH0tctjyFGn9n481QgHgyvJXgI11VMhrFGzFI8SdYIhq8k5HmpMQI3lCAvL19kOWGqUclY5uNVixtihQ7tGS8raJJwJOeODfr42D3B+KBBKXxPoykHC6OmeqqELsbItw0R8KcRX9mL8uyKoWWSKJdWD0mHDvFbzF3iKCnBUxWfXi80Qk5XhZZAtzO1Bvb0udzkH2uDqStVtbA277Zi+2I9vBalHwTSWIIGAaSK44Em4MVqP2d+CpLr5cFEqiXao9zm2ajZIZxs89/3O9Al41zAmFLMktus8YkXgRX4kxTCb9RWo+P73MKfUej+owxKGbM9K4S4Iq8LllUlY8njxXy5wyAj29T1Ey1Y4SZ9vs+zWKktpEt2GcPs7eKoLxpCRkdZavG5/sx1bSAPTPu/lvosKZUBin/5a22OuIH2JswX6UkAGaf1yguU2VWBGVfI0hXzDsRF4ZB2t+EfDqdHg3nEF0c3Znc8qC8sapr6AiSGb3xY80ik/QrFCUafw7bX5Hl6S4HTwZ7uPHwvYVcjM2PYpJOln5jhiZYCujzaBPiNRwHAysFg1FTK30j0Yq99SjP2mdcmeh0pIwSAcrTeNHGO/0KtXidpydZP8HpL8BDY94U4JOXzvpO+JsKXR6zs2ZHh7UQSUy7nl5ZXmo7Nq78ZWVXnlXs7IGXtGBhXaqTLofm0hsE0INJmy09wYeQQfFSVWIWCwTvXCFCsNYzv7xI4V/g7HO/Zmg7fPF6OfGs9fioj1v1PuWrfL/5oeorOutgu4nrENxq4J+nqVoswUV+JK9wgbmgBI/3nYnS1Ulk1XuxMTUvEvIF+HcYtqIxRwgSqo37EA64Pn24QxZLmlK/YO7pGSLA9uDhQfYE8vJvDaxPpCs58slj2CZlx5Aryrb4vHvc4k+m3ZduqtMyLS2rmBGDS/4YWdf4Cr+CHjpsmqi5C0LOoHELB+ndNelmZ52i/ckYr+3dYyFmLljBMnCUgc0F8r8yv8sxgpMQ0kTE4pFRSVAUuW0Ol3zdFaN2+2NxR7ZXTwBK4exHFIfd65/Reg5MS5VGR6Z4QG/ySwwAA0n+zPzAT1m9RnU9c/0hLgYU+pFLr7okcdT9gjAYiWVYDR6GI7VejrU0gP+DcTQBjCxGxnm6WoH0bUTgX4YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1762,"cache_read_input_tokens":84475,"cache_creation":{"ephemeral_5m_input_tokens":1762,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGQX37kXYJWtNezABEA","type":"assistant","uuid":"5883f2ee-2e12-4690-9ec1-0e1da3d6890e","timestamp":"2026-01-25T01:57:26.329Z"}
{"parentUuid":"5883f2ee-2e12-4690-9ec1-0e1da3d6890e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01R2vPBjYN2SvAxb6JQH7BGC","type":"message","role":"assistant","content":[{"type":"text","text":"Los cambios del backend y frontend ya están implementados. El código del frontend ya existía para manejar los planes de créditos. El problema era que el backend no los estaba incluyendo.\n\nResumo los cambios realizados:\n\n## Cambios Implementados\n\n### 1. EmpresaPlanRepository.php (línea 376)\nAgregado nuevo método `planesCreditosActivos()`:\n```php\npublic function planesCreditosActivos(int $empresa_id): Collection\n```\nEste método obtiene todos los planes de créditos activos donde `plan_id` es NULL y `plan_credito_id` no es NULL, con estados ACTIVO (1) o POR_VENCER (4).\n\n### 2. EmpresaPlanService.php (línea 493)\nAgregado método `obtenerPlanesCreditosActivos()`:\n```php\npublic function obtenerPlanesCreditosActivos(int $empresa_id): Collection\n```\nEste método llama al repositorio para obtener los planes de créditos activos.\n\n### 3. EmpresaService.php (línea 120)\nModificado el método `getUno()` para incluir los planes de créditos después del foreach de tipos_pruebas:\n```php\n// Obtener planes de solo créditos (donde plan_id es NULL y plan_credito_id no es NULL)\n$planes_creditos = $this->empresa_plan_servicio->obtenerPlanesCreditosActivos($id);\nforeach ($planes_creditos as $plan_credito) {\n    array_push($planes, $plan_credito);\n}\n```\n\n### Frontend (empresas.js)\nEl código del frontend ya existía (líneas 1678-1807) para renderizar los planes de créditos. Este código ya:\n- Muestra el icono de moneda (`bi-coin`)\n- Muestra el nombre del plan de créditos\n- Muestra el estado (Disponible/Agotado)\n- Muestra la barra de créditos disponibles, promedio por acción y acciones estimadas\n- Muestra las fechas de creación, activación y vencimiento\n- Incluye botones de edición y acciones del menú dropdown\n\nLos planes de créditos ahora aparecerán en la pestaña \"Planes\" de la vista `/empresas-gestionar/{id}` junto con los planes normales."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1762,"cache_read_input_tokens":84475,"cache_creation":{"ephemeral_5m_input_tokens":1762,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXTGQX37kXYJWtNezABEA","type":"assistant","uuid":"9f2db8b5-eeb4-4861-bfb7-d37184da5ae0","timestamp":"2026-01-25T01:57:34.767Z"}
{"parentUuid":"9f2db8b5-eeb4-4861-bfb7-d37184da5ae0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"system","subtype":"turn_duration","durationMs":141136,"timestamp":"2026-01-25T01:57:34.929Z","uuid":"d83d05cd-c8b2-4b4a-a48e-0de9effd1065","isMeta":false}
{"type":"file-history-snapshot","messageId":"3c9be7af-b61e-4db3-82a9-b315acaa8674","snapshot":{"messageId":"3c9be7af-b61e-4db3-82a9-b315acaa8674","trackedFileBackups":{"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"1ef8fbba46b68267@v1","version":1,"backupTime":"2026-01-25T01:56:04.149Z"},"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"87ffcf5aa4ef1291@v1","version":1,"backupTime":"2026-01-25T01:56:11.952Z"},"app\\Http\\Services\\Empresas\\EmpresaService.php":{"backupFileName":"8caa2eff68e60519@v1","version":1,"backupTime":"2026-01-25T01:56:20.734Z"}},"timestamp":"2026-01-25T02:00:32.309Z"},"isSnapshotUpdate":false}
{"parentUuid":"d83d05cd-c8b2-4b4a-a48e-0de9effd1065","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":"Es posible que se muestre el plan proximo como se muestra en empresa?"},"uuid":"3c9be7af-b61e-4db3-82a9-b315acaa8674","timestamp":"2026-01-25T02:00:32.281Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"permissionMode":"acceptEdits"}
{"parentUuid":"3c9be7af-b61e-4db3-82a9-b315acaa8674","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_019V1DvEfDJvqe7XpUNuW1My","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario pregunta si es posible mostrar el plan próximo de créditos como se muestra en la vista de empresa. Necesito revisar cómo se muestran los planes próximos en la vista de empresa (`/planes-clientes`) y replicar esa funcionalidad para los planes de créditos en la vista de superadmin (`/empresas-gestionar`).\n\nPrimero, voy a revisar cómo se manejan los planes próximos en el archivo `planes.js` de la vista de empresa.","signature":"EtkECkYICxgCKkCdyi5yDqS5CC0PuSK1/CZX8Xinp9Tv2LLwSFvz+m1FGi4xcXqUw0IzMGFXbSz5KhiA9jtCbTLeeUwITzHykZX0EgyTLpja72R+R0QmL+EaDHlgiVjMis+cnG4xJSIwS1YquuRlgAauiC/4robyR9Cfa9jNMMgDU9drVopW782AIJOn2U9KSNXzXJYczAWQKsADbzzG6hZf1yl7zf0MqK4J39d5LrfRKMcN6yE49JMpgOuGLdatOMyK5QOEmVWL/qXzwzmFwZdUWe2MU/QRG5Yu5KAFy0dk5y0GsTKZ+fMHYvZytdjhUVhltJl4nT9YeXyQXbmQbkAkbQOQy8RbTL9RaZN/pKpV9H55T4km/vzxG1zxr7dI793y83sHSXKBjD9KQaRrLswiLkEGEmTpWqZPgf+ZFKPf01u/tdY4Xn4SKNiz2JcwALLwrJXmly+C/jU18GklYNUiNIrINVaWLjPQixUiPkCCN6EaG7kEy4NRnc4ra2P0NYX4c8gUCoes6GV9RxJrrVRlaRBS3GUlb/CT+UBXJpDyklRnpHR/PYsf4yFP5/E+UhW8FGEWSZ6Bq8rEFiLm2MMSX4tVLoJznMYJCSLTANA7Q3L/YGV0bI+a0fPNX2gRBU18SeXVYPb4I/pLGKDzNd6pCQKDxgUUvzxF/A5y3DMRMSoXixk1Uz2WKfwjON8nZ0uXQTRi604fNC0yyST09sjaKv9DLT0zFhliGMBoyyGY+eQKWClNaFn8k9Jvxzaed9Y3Xf7DY+PfK74S3nC4ZRG4YHBN0vn1Qa0s4RgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":21,"cache_read_input_tokens":87314,"cache_creation":{"ephemeral_5m_input_tokens":21,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTGfDdY165PyzZJWaBbK","type":"assistant","uuid":"b694e350-4c2c-43fd-b642-1715f624936c","timestamp":"2026-01-25T02:00:35.660Z"}
{"parentUuid":"b694e350-4c2c-43fd-b642-1715f624936c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_019V1DvEfDJvqe7XpUNuW1My","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a revisar cómo se muestran los planes próximos en la vista de empresa para replicar esa funcionalidad."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":21,"cache_read_input_tokens":87314,"cache_creation":{"ephemeral_5m_input_tokens":21,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTGfDdY165PyzZJWaBbK","type":"assistant","uuid":"4f901794-e439-4c7a-bd68-d59054607b3c","timestamp":"2026-01-25T02:00:36.174Z"}
{"parentUuid":"4f901794-e439-4c7a-bd68-d59054607b3c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_019V1DvEfDJvqe7XpUNuW1My","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LTDvWgvmHsNZh7TcaJV3WX","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","offset":1,"limit":160}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":21,"cache_read_input_tokens":87314,"cache_creation":{"ephemeral_5m_input_tokens":21,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTGfDdY165PyzZJWaBbK","type":"assistant","uuid":"3cbea1b0-43da-409c-a13c-e21a2e25d5ac","timestamp":"2026-01-25T02:00:38.077Z"}
{"parentUuid":"3cbea1b0-43da-409c-a13c-e21a2e25d5ac","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LTDvWgvmHsNZh7TcaJV3WX","type":"tool_result","content":"     1→let empresa_id = $('#input_empresa_id').val();\n     2→let usuario_id = $('#input_usuario_id').val();\n     3→let empresas_planes = [];\n     4→let usuarios_ids = [];\n     5→let sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     6→let usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     7→let empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     8→let planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     9→usuarios_ids = usuarios.map(usuario => usuario.id);\n    10→let total_usuarios = usuarios_ids.length;\n    11→\n    12→const ESTADOS_PLANES = {\n    13→    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    14→    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    15→    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    16→    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    17→    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    18→    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n    19→};\n    20→\n    21→const ICONOS_PLANES_TIPO = {\n    22→    'Selección': 'bi-person-bounding-box',\n    23→    'Organizacional': 'bi-diagram-3-fill',\n    24→    'Vocacional': 'bi-mortarboard-fill',\n    25→};\n    26→\n    27→/**\n    28→ * Obtiene la data para mostrar en la tabla de planes de la empresa.\n    29→ *\n    30→ * @returns {void}\n    31→ * @author Andres Morales\n    32→ * @author Fahibram Cárcamo\n    33→ * @author Sergio Vargas\n    34→*/\n    35→async function traerDatos() {\n    36→    try {\n    37→        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n    38→        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n    39→        empresas_planes = respuesta.data.empresas_planes;\n    40→    } catch (error) {\n    41→        console.error(error);\n    42→    }\n    43→}\n    44→traerDatos();\n    45→\n    46→/**\n    47→ * Crea el componente html de los planes de la empresa\n    48→ *\n    49→ * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n    50→ * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n    51→ * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n    52→ * @returns {void}\n    53→ * @author Fahibram Cárcamo\n    54→ * @author Andres Morales\n    55→ * @author Jair Carvajal\n    56→ * @author Andres González\n    57→ */\n    58→function listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    59→    let contenidoHTML = empresas_planes.map(empresa_plan => {\n    60→        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n    61→        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n    62→\n    63→        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n    64→        if (!plan && !empresa_plan.plan_credito) {\n    65→            return '';\n    66→        }\n    67→        let suscripcion_ilimitada = !!fecha_vencimiento;\n    68→\n    69→        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n    70→            ? empresa_plan.fecha_inicio\n    71→            : (new Date()).toString();\n    72→\n    73→        let dias_restantes = suscripcion_ilimitada\n    74→            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n    75→            : null;\n    76→\n    77→        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n    78→        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n    79→\n    80→        return empresa_plan.plan_credito_id === null ? `\n    81→            <div class=\"card my-5\">\n    82→                <div class=\"card-body\">\n    83→                    <div class=\"row\">\n    84→                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n    85→                        <div class=\"col-auto my-auto\">\n    86→                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n    87→                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n    88→                        </div>\n    89→                        <div class=\"col-auto ms-auto my-auto\">\n    90→                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n    91→                        </div>\n    92→                        <div class=\"col-auto my-auto\">\n    93→                            <div class=\"dropdown\">\n    94→                                ${crearBoton({\n    95→                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n    96→                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n    97→                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n    98→                                })}\n    99→                                <div class=\"dropdown-menu dropdown-menu-start\">\n   100→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n   101→                                        Solicitar renovación\n   102→                                    </button>\n   103→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n   104→                                        Ver factura\n   105→                                    </button>\n   106→                                </div>\n   107→                            </div>\n   108→                        </div>\n   109→                    </div>\n   110→                    <div class=\"table-responsive mt-4\">\n   111→                        <table class=\"table\">\n   112→                            <tbody>\n   113→                                <tr id=\"contenedor_plan_padre\">\n   114→                                    <td class=\"py-0 my-0 border-0\">\n   115→                                        <div class=\"card bg-gray-90 border-0\">\n   116→                                            <div class=\"card-body py-2\">\n   117→                                                <div class=\"row\">\n   118→                                                    <div class=\"col-auto my-auto\">\n   119→                                                        ${crearBoton({\n   120→                                                            clases: 'btn-text-gray text-label-2',\n   121→                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   122→                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   123→                                                        })}\n   124→                                                    </div>\n   125→                                                    <div class=\"col my-auto\">\n   126→                                                        <div class=\"card bg-white border-0\">\n   127→                                                            <div class=\"card-body py-2\">\n   128→                                                                <div class=\"row\">\n   129→                                                                    <div class=\"col-4 px-7\">\n   130→                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n   131→                                                                    </div>\n   132→                                                                    <div class=\"col-4 px-7\">\n   133→                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n   134→                                                                    </div>\n   135→                                                                    <div class=\"col-4 px-7\">\n   136→                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n   137→                                                                    </div>\n   138→                                                                </div>\n   139→                                                            </div>\n   140→                                                        </div>\n   141→                                                    </div>\n   142→                                                    <div class=\"col-auto my-auto ps-0\">\n   143→                                                        ${crearBoton({\n   144→                                                            tooltip: `${crearTooltip({\n   145→                                                                placement: `top`,\n   146→                                                                content: `Detalle de consumo`,\n   147→                                                                toggle: `popover`,\n   148→                                                            })}`,\n   149→                                                            clases: 'btn-text-primary btn-circle p-2',\n   150→                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   151→                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n   152→                                                        })}\n   153→                                                    </div>\n   154→                                                </div>\n   155→                                            </div>\n   156→                                        </div>\n   157→                                    </td>\n   158→                                </tr>\n   159→                                ${lista_consumos_por_sucursal}\n   160→                            </tbody>\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"8a72bad4-c5f8-4a5d-8a40-9e0ee6e0d2d9","timestamp":"2026-01-25T02:00:39.348Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","content":"let empresa_id = $('#input_empresa_id').val();\nlet usuario_id = $('#input_usuario_id').val();\nlet empresas_planes = [];\nlet usuarios_ids = [];\nlet sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nusuarios_ids = usuarios.map(usuario => usuario.id);\nlet total_usuarios = usuarios_ids.length;\n\nconst ESTADOS_PLANES = {\n    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n};\n\nconst ICONOS_PLANES_TIPO = {\n    'Selección': 'bi-person-bounding-box',\n    'Organizacional': 'bi-diagram-3-fill',\n    'Vocacional': 'bi-mortarboard-fill',\n};\n\n/**\n * Obtiene la data para mostrar en la tabla de planes de la empresa.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n * @author Sergio Vargas\n*/\nasync function traerDatos() {\n    try {\n        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n        empresas_planes = respuesta.data.empresas_planes;\n    } catch (error) {\n        console.error(error);\n    }\n}\ntraerDatos();\n\n/**\n * Crea el componente html de los planes de la empresa\n *\n * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Jair Carvajal\n * @author Andres González\n */\nfunction listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    let contenidoHTML = empresas_planes.map(empresa_plan => {\n        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n\n        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n        if (!plan && !empresa_plan.plan_credito) {\n            return '';\n        }\n        let suscripcion_ilimitada = !!fecha_vencimiento;\n\n        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n            ? empresa_plan.fecha_inicio\n            : (new Date()).toString();\n\n        let dias_restantes = suscripcion_ilimitada\n            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n            : null;\n\n        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n\n        return empresa_plan.plan_credito_id === null ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>","numLines":160,"startLine":1,"totalLines":507}},"sourceToolAssistantUUID":"3cbea1b0-43da-409c-a13c-e21a2e25d5ac"}
{"parentUuid":"8a72bad4-c5f8-4a5d-8a40-9e0ee6e0d2d9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01V21FwXbaxd9fev7bDd4rqS","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Veo que en `planes.js` se obtienen los planes con el estado \"Próximo\" y se muestran con el tag correspondiente. Pero necesito ver cómo se obtienen los datos. Veamos el endpoint `empresas-planes-listado-tabla`.","signature":"EvwCCkYICxgCKkD0uatY9J1CrHPrV2Ni5jg991umVBAYW2Sptjlo3c5YxLu4oN1UHf44UuH+6EiI/AFhz5yppCIEvC2gyS4r1nlIEgzdYkdugCz5EjVtSx4aDAdMU6IVgKk1y8JnWCIw60F5slpI2pRAEmEKkt+lY8gna4N4ZKdJwTGq9IUIznrotxe+1wneckmlBq+vzuY0KuMBPo/JA6E68Uxpd+64Pvz3FC7LVeWnMXInH4NU5s+5SgCMen1YJzcGfVaL2GanIWNa48tIXvWx+HDggTBbJ7buCE6SyTxde3MHD0r/ud1ZeCDfOXvjG92ZmGvAhPKxEDqOHBoW5pu4AdF1WXOSYxogGwu8l5q8q9/gUY1RUNfDwH3EYVYL90mbpZUzGduZzRIClwSc0HvFNWQiG8kq5cCRZ7EsfWpl0tvZMlbi1lwtqQzMrji18pjHx3JhEylHiOE3x4XLRre0QCZaT8pLtORj8ZFO+mP8gKOpII0Sm2W8TEnc5ngYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3498,"cache_read_input_tokens":87335,"cache_creation":{"ephemeral_5m_input_tokens":3498,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGfmwUsr4eDZE5A7bD9","type":"assistant","uuid":"e93a299a-ecf6-4529-89fa-24864d3cec8f","timestamp":"2026-01-25T02:00:44.083Z"}
{"parentUuid":"e93a299a-ecf6-4529-89fa-24864d3cec8f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01V21FwXbaxd9fev7bDd4rqS","type":"message","role":"assistant","content":[{"type":"text","text":"Necesito ver cómo se obtienen los planes próximos en el backend para la vista de empresa."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3498,"cache_read_input_tokens":87335,"cache_creation":{"ephemeral_5m_input_tokens":3498,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGfmwUsr4eDZE5A7bD9","type":"assistant","uuid":"247ed83f-1be1-4730-9dd0-8025ad37de40","timestamp":"2026-01-25T02:00:44.905Z"}
{"parentUuid":"247ed83f-1be1-4730-9dd0-8025ad37de40","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01V21FwXbaxd9fev7bDd4rqS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JBauJD5U9uJNZcf6u9tP2k","name":"Grep","input":{"pattern":"empresas-planes-listado-tabla","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","output_mode":"content","-n":true,"glob":"**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3498,"cache_read_input_tokens":87335,"cache_creation":{"ephemeral_5m_input_tokens":3498,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGfmwUsr4eDZE5A7bD9","type":"assistant","uuid":"16aab778-9708-46a2-a3a0-fd8be25e25ca","timestamp":"2026-01-25T02:00:46.611Z"}
{"parentUuid":"16aab778-9708-46a2-a3a0-fd8be25e25ca","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JBauJD5U9uJNZcf6u9tP2k","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:270:        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');"}]},"uuid":"d7f30959-c195-4364-914d-634c07639493","timestamp":"2026-01-25T02:00:48.403Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php:270:        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');","numLines":1},"sourceToolAssistantUUID":"16aab778-9708-46a2-a3a0-fd8be25e25ca"}
{"parentUuid":"d7f30959-c195-4364-914d-634c07639493","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JRvxU4e6J4UTHf4fnKWj1Q","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Necesito ver el método `datosTabla` en el EmpresaPlanController.","signature":"EukBCkYICxgCKkBieZ+DKilKizMFXRceaNcfc0GtN1GFlB9yOQ1DSsJg+RsEMW4rEwAaYZkV4nxNfYZXAl6zXED+pEIafQSLfBVMEgw8ygynb+dUDTVsneAaDGNhh102gB+DaXV/OiIw2T9adCWLN8mLfvHqXcILrMVnesVqfup3zV1dRUeY2PlkI7ZQbV7jxejimE4marM6KlEDj3GymLUbkmSTD62mKfjEFpHvvL1IcupW2g7Awy5jhhOXYF+R6kDz6I6zvC97P7ddRv4gWA0oZOBrGRdqxehwhHgRrdqS1MJQUOcLBaLkfIkYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":443,"cache_read_input_tokens":90833,"cache_creation":{"ephemeral_5m_input_tokens":443,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGgSN2nXi7kHrM8jsw9","type":"assistant","uuid":"4d229d39-d549-4449-88fe-17691f2fffb6","timestamp":"2026-01-25T02:00:51.010Z"}
{"parentUuid":"4d229d39-d549-4449-88fe-17691f2fffb6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JRvxU4e6J4UTHf4fnKWj1Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CJJkmvub25dbNXndnisqBY","name":"Grep","input":{"pattern":"function datosTabla","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","output_mode":"content","-n":true,"-A":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":443,"cache_read_input_tokens":90833,"cache_creation":{"ephemeral_5m_input_tokens":443,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGgSN2nXi7kHrM8jsw9","type":"assistant","uuid":"132f5d07-d4e6-4501-a8c3-eb17a02103c0","timestamp":"2026-01-25T02:00:52.162Z"}
{"parentUuid":"132f5d07-d4e6-4501-a8c3-eb17a02103c0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CJJkmvub25dbNXndnisqBY","type":"tool_result","content":"118:    public function datosTabla(int $empresa_id, Request $request): JsonResponse {\n119-        $request->merge([\n120-            'empresa_id'                            => $empresa_id,\n121-            'con_conteo_consumos_agendas'           => true,\n122-            'con_conteo_consumos_ofertas_laborales' => true,\n123-            'con_conteo_consumos_creditos'          => true\n124-        ]);\n125-\n126-        return new JsonResponse([\n127-            'data' => [\n128-                'empresas_planes'             => $this->repositorio->getTodo($request),\n129-                'sucursales_consumos_agendas' => $this->empresa_repositorio\n130-                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n131-                        'empresa_id'       => $empresa_id,\n132-                        'consumos_agendas' => true\n133-                    ])),\n134-                'sucursales_consumos_ofertas_laborales' => $this->empresa_repositorio\n135-                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n136-                        'empresa_id'                 => $empresa_id,\n137-                        'consumos_ofertas_laborales' => true\n138-                    ]))\n139-            ]\n140-        ], 200);\n141-    }\n142-\n143-    /**\n144-     * Obtener un plan de empresa.\n145-     *\n146-     * @param int $id ID del plan de empresa.\n147-     * @return JsonResponse\n148-     * @author Daniel Beltrán"}]},"uuid":"6fa4648c-5e66-4f13-97ae-6442d21639e3","timestamp":"2026-01-25T02:00:53.766Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"118:    public function datosTabla(int $empresa_id, Request $request): JsonResponse {\n119-        $request->merge([\n120-            'empresa_id'                            => $empresa_id,\n121-            'con_conteo_consumos_agendas'           => true,\n122-            'con_conteo_consumos_ofertas_laborales' => true,\n123-            'con_conteo_consumos_creditos'          => true\n124-        ]);\n125-\n126-        return new JsonResponse([\n127-            'data' => [\n128-                'empresas_planes'             => $this->repositorio->getTodo($request),\n129-                'sucursales_consumos_agendas' => $this->empresa_repositorio\n130-                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n131-                        'empresa_id'       => $empresa_id,\n132-                        'consumos_agendas' => true\n133-                    ])),\n134-                'sucursales_consumos_ofertas_laborales' => $this->empresa_repositorio\n135-                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n136-                        'empresa_id'                 => $empresa_id,\n137-                        'consumos_ofertas_laborales' => true\n138-                    ]))\n139-            ]\n140-        ], 200);\n141-    }\n142-\n143-    /**\n144-     * Obtener un plan de empresa.\n145-     *\n146-     * @param int $id ID del plan de empresa.\n147-     * @return JsonResponse\n148-     * @author Daniel Beltrán","numLines":31},"sourceToolAssistantUUID":"132f5d07-d4e6-4501-a8c3-eb17a02103c0"}
{"parentUuid":"6fa4648c-5e66-4f13-97ae-6442d21639e3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PTyN96CGEwUwdP3CzwjU9P","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora entiendo. En la vista de empresa (`/planes-clientes`), los planes se obtienen usando `$this->repositorio->getTodo($request)` que trae todos los planes incluyendo los próximos.\n\nPero en la vista de superadmin (`/empresas-gestionar/{id}`), el método `EmpresaService::getUno()` solo obtiene el plan activo o el último por tipo de prueba, no los próximos.\n\nPara mostrar los planes próximos de créditos en la vista de superadmin, necesito:\n\n1. Modificar el repositorio para obtener también los planes de créditos próximos (estado_id = 3)\n2. O crear un método separado para obtener el plan próximo de créditos\n\nVoy a crear un método `planCreditosProximo()` en el repositorio y luego usarlo en el servicio y el controlador.\n\nPero primero déjame ver mejor cómo se manejan los planes próximos regulares en `getUno()`:\n```php\nforeach ($tipos_pruebas as $tipo_prueba) {\n    $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n        ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n    if (!is_null($plan)) {\n        array_push($planes, $plan);\n    }\n}\n```\n\nVeo que se obtiene el plan activo y si tiene un plan próximo, se agrega como propiedad `plan_proximo_id` dentro del mismo objeto. Pero el plan próximo en sí no se agrega como un elemento separado del array `planes`.\n\nSin embargo, mirando el frontend de `empresas.js`, veo que hay lógica para manejar `plan_proximo_id`:\n\n\nCuando existe un plan próximo, el frontend genera opciones de edición diferenciadas. Si hay `plan_proximo_id`, muestra botones para editar tanto el plan vigente como el próximo, permitiendo al usuario gestionar ambos estados del plan desde la misma interfaz.\n\nPara aplicar esta lógica a los planes de créditos, necesito implementar cambios en tres capas: agregar un método en el repositorio que recupere el próximo plan de créditos, modificar el servicio para incluir `plan_proximo_id` en la respuesta, y actualizar la vista para renderizar las opciones de edición correspondientes.","signature":"EsYVCkYICxgCKkA2Q6MQIdkMjtRqvFyEuxM8xpYGy+mClPuaSJcWIgswGlRoY3hlZV0csX4Z8WkJihKj9Ko59iA/3WlJZx9KvY0PEgwdwHzlenWR0CJv9C4aDFPWn8yP6+oLnAOKYyIw/vD2FQPrnAxWmiLcVrQHeEo3HKUXv5mRHRMVc+aB+Z6fvusxWpAYz4hYYI92OwD0Kq0Uqy1+jESp4mm7KAf/K3HHGJc/V0K3fMoRAltyiKl3Vkwku36ADenobDUJRqWePppqmat2EkHEDNbCr3ce7MY5PEJkqjSjAMyAXLcCsqqTAkT/k332C/GFQK6Ypd43kVqapm/ayfuP8Cm/MN9Bp2lv2NayCJ+63Ty9E7oKVLk93A9+GGkci95C7vFmJ3xSoJHjTJfyIY9GK3J+Y+MzJZJhthXns3IetMq8kF9Wzuh6YfAuhcGHLmQsHJ/odCvuGYvTbazLkjux0rDOX+aL23m951JHI5lZYkq1XsyAo8kNDQolyIRTYQKtIGerVryRo+mzc7CMqYFNo0Qb4VPbQA4MoKTyttn3k/yL0VnftUUQkh9IS4r2zcMh+mUwBj8/okC7dLf6dJe0fbrSaRRJ+nsHGwTFtykHq/cTo9wFmdeNvIK/RVao2GJH8ukBmTCWZolmACAfjkQ/JGAhRgo8XRkn4Cpa8CCFlBZQELI5YP1Sfvrdc4PYAEMyWOsybSB1UwLlXPg0kb5scA6EeReJFVfyE6DwopC1BOAmTEaRdiuLMT4FIwt7g8Pn9vxEOiu/anxWVtUdCwQ0PoJmhfhyB9hS+lVKcP3SRNPRXjZ/q2/wBltw28z57D5qXmJz0K3zNp6XDBDkX1wwRs+GZbn6jlfnLF0fuiTpGEacM6qywuxwo3A7Krkss4kC/Ztm10lCGUEoPLnSx9F6lNnw1pQpZyy50nXMkIu+TwJ4i0Vn/O3deLSTxudzkNBYWXxPmI8XNnEAVHRWIaUF4ILnZMSEUNK5N/7o1UiNVIjmFMu0SZNBi02JgGthXjC4mX3DDExKc8Djv5NdW3EJWY+HCMIoq6hjVL56pVhovxL/ZCD0MNAmqFSQKVkxWhtO7T3bHRPqIdhxcHnjn/DeCNz/vS/eJpzNyGeOtnL7fFTW3z6E1K4ZMIKSk1OUiPCQebUtKrkUNWvDT2AK5aUSIpqOdzOPZ9mc/Yt8TTcg++qGwK2KNTAf7EA+lvRgrvHZNb4FbCSIt0UHzqoj7lnoc/nWz+JJl/JA7NAoliAz3qBfuazKrTz88wE5UU46F3KOlH1lumehIJ5FW3QTVhJjBrLl6YJ66V7FhnHq+IYXazKtLF9k5dvAT1hqMbq+4M+YqrOWXoFNaZNBDDmHn/ZjH89YQqo2Jue45TyXVbERk2pMpr6oQWu+K2gQ53vX0Suh9NTTyZMNcVOg9Ui3t21N/QJBvsWDt4f5pER1tgJjN5IpvlSX6iMOcCNxfqREHfL9sDCAvPVY5lbm+z67CcUSagvpkOskNxTcD9n+3w9s2Y7H0KdyxfULl+JUZ1cbY7Lx6N1YYh15gHeDQxE9GkPvsPPwEpbcdZTlfYEFDmGJp5YVxOjDQv7pBy4gc5KSakYCdkievP9Jztpwv+E+LXOYetYryKR/IsZKDf2P5SSw63sIQcXs3tTIwISUc1GG0f3S7vgJDAJwRomKfGoyVMi1o8CvJAySSpZCDb28L9M5PJ97MmyDJh9gcNst7vszNHqSzUE+/Q+1ne55ckvBeuYEcy2+iPglPyhAUc2Bp0MNwDw1rLpsVqTyX29fX8F0f8UwVA0Tiy+N4xDAPSa6zvFOfdzYu0X/6fxTxTyCmmWDxqRqDFQhsy1VrofSM7zIUy4VkWLA13VdH2cWx6S5f5o2dxcJA1ZmJOCPc5PY+r/Ipk68Nq88PaFjilylTkjur6PIDibLv4N6eByZPAEFou8RjhyXBASSrLI4F8t3Y6mQ6KgRVCi2AXfxoOBB1Z4RgTD0hqcbZInXxD91KQzNOu7klEQ+bfnWf6ucLHq7idiWx26jqKGlU47G0bcglw3zOK+1yzOg4tPyvR/t0sDBVZl7Ql2/+r8yJD4nY9OPG3nFkuAYV3SvuF+4oJ0pzOUR1YaKWauu9QSGBzIwNafjvo4uQxCrU/1VGwQ+sIozrVcrn5J7lj8gmP7dClpjAHhDzYD9bMxVAYgLKdbK2AaGCTDYr+hqGNvCW2a0asqMrjkYzsmExvZtef+CjB/rJLw05c60JY32qu6kfuNPv/xnjkpULwnKHGNYVWLrzFlD/ojy7WalJV43yQKzRdgsWwKyrBY3OcGuWco1zCko6YAl07EMIzBHcJj1aqTy4lC/GLF4CKruPn3tk7a8+eRCOru6iVJeLC/Dq/Qnzi3tMjzhCSV+xJrrjCh4qP0EiEQANk5wQJTO04qc/Y+z3v9IggbHOnr5svghx4tcJ9CO8lwECLctGwfuerfhrBn9DUzKi0nkaTgIl+xfA+958/BRgNARYFKfwdltIqvnluBU+fIh6eraDC4cjf/JLhQzq7dH+wlWWYouBYAdKlFZqGuegjrQggMiCdX4iH4DaXqCW7tFMmEpYDm1ndC5gtPReK+iB+cZO+1zWnLQg4Rx1OquVdiX96l+BvXGZlLbO/+lfUsrd8236OGlDIbWA3o7ggAgVLYz4ZL5ZTHd9ZlDQTeJQHcrWThItO+zX4o7tmRJUgkTaCTDt1vErsmwikHTrxwbsHP9dzfo/FOKIXPZclOMxRfEgIG9txkraFbg76L0lWMHeUqAZ0A7MQqI8+OWlRyydqCiY7D8aWgMXFXf9egUk6QB6lp80KxkITvBHAdop2BUTwrBb+XmocUaN6MP/PA950UlCtP+xF49P6kugkmYpvX1/PSmTOybktyKXzfkTudfi9gc+HJvDB6C7nx/tlHGmePjs0+xjYpxKS2JdPf52isfbWOC6jmy4UWVdE+cs48X01HtuNOHXn44YWCe8voosRhUrzZIAnATBjhxZr5gBpsbiOO2YQFm7AzdjUTkkfeQe8cuhQXPiXrUO+8r0uAbTvI/NxbjHktkT8KcvDBZumQHJHSxKJvM6vCcASvQUjkC1ybTUGbqOcII6q9r+Z4asVsCe8lA6qXdG2SuLsq+LnKADPSwL4CRIJcjMeW1vzb0yCnIOTbq88LNSq57nO2kwFbO3Dws8znZWM+Qj0xPfjR6qY0x5uGKYWCou8Q+BAf4PIlq4YDFpybYtt4sLV9nq/vqh6Me/IxYcb6lz5aPuFstoZZPoi0FjkFk9fjMARjUiNPcx08KCQXrLNFN1CHbUGwRTlWyhVdhsZxCzZ9uexL8usjcew1pmIdTCZl2NtNexsaWHrDDKbIAyDQWkL7+/eBUJapZ7QalKQD6YAAZej0EZj2igdJvtNj+v/919bP8NYnSKS4UsGfuaklM9lbRm39xBz/ODk74KO49dQrD0cyIOb30I1Yu+nj6ckJbFLYI6LxCMQaZSXVjp1q2nUQVkfq2bBBhWO5+DIgn7pibdSnhGMsMdRilCDT89xRPrFtEsX4zubMDonSmfPPVLAJ2RcP7Rx9uCyLisQQlKi6ONYX/rSCHvU2UtdKTSfX/GaaU0Pgohmlkd9Z7MjFouiDMVWaDKvL8upnXKkcrpdIzmxYssOkvgQ0OrRtkvaeL6WhrOTJ5pcjIYU02mhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":642,"cache_read_input_tokens":91276,"cache_creation":{"ephemeral_5m_input_tokens":642,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGgqAizp4MvwRhCPbrx","type":"assistant","uuid":"890fe0e2-e9a9-4980-b09b-812622570109","timestamp":"2026-01-25T02:01:11.123Z"}
{"parentUuid":"890fe0e2-e9a9-4980-b09b-812622570109","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PTyN96CGEwUwdP3CzwjU9P","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo. Necesito agregar la lógica para mostrar el plan próximo de créditos similar a como se hace con los planes regulares. Voy a hacer los cambios necesarios.\n\n**Paso 1:** Agregar método `planCreditosProximo()` en el repositorio."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":642,"cache_read_input_tokens":91276,"cache_creation":{"ephemeral_5m_input_tokens":642,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGgqAizp4MvwRhCPbrx","type":"assistant","uuid":"65090f28-f383-4b39-b3d1-1fd65b5957fa","timestamp":"2026-01-25T02:01:11.281Z"}
{"parentUuid":"65090f28-f383-4b39-b3d1-1fd65b5957fa","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PTyN96CGEwUwdP3CzwjU9P","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015ywmM2sVXAeTaL9ENtdL4i","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","offset":376,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":642,"cache_read_input_tokens":91276,"cache_creation":{"ephemeral_5m_input_tokens":642,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGgqAizp4MvwRhCPbrx","type":"assistant","uuid":"60f62f7b-5764-4459-8da2-22408f06511b","timestamp":"2026-01-25T02:01:12.261Z"}
{"parentUuid":"60f62f7b-5764-4459-8da2-22408f06511b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015ywmM2sVXAeTaL9ENtdL4i","type":"tool_result","content":"   376→    public function planesCreditosActivos(int $empresa_id): Collection {\n   377→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'created_at')\n   378→            ->with([\n   379→                'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   380→                'estado:id,nombre',\n   381→                'usuario:id,nombres,apellidos',\n   382→                'archivos' => function ($archivos) {\n   383→                    $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   384→                        ->orderBy('created_at', 'DESC');\n   385→                }\n   386→            ])\n   387→            ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n   388→            ->where('empresa_id', $empresa_id)\n   389→            ->whereNull('plan_id')\n   390→            ->whereNotNull('plan_credito_id')\n   391→            ->whereIn('estado_id', [1, 4])\n   392→            ->orderBy('created_at', 'DESC')\n   393→            ->get();\n   394→    }\n   395→\n   396→    /**\n   397→     * Obtener el plan de creditos activo de la empresa.\n   398→     *\n   399→     * @param int $empresa_id ID de la empresa.\n   400→     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n   401→     * @return EmpresaPlan|null\n   402→     * @author Sergio Vargas\n   403→     */\n   404→    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n   405→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   406→        ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n   407→        ->where('empresa_id', $empresa_id)\n   408→        ->whereNotNull('plan_credito_id')\n   409→        ->whereIn('estado_id', [1, 4])\n   410→        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n   411→            $query->where(function ($q) use ($tipo_prueba_id) {\n   412→                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n   413→                  ->orWhereNull('plan_id');\n   414→            });\n   415→        })\n   416→        ->first();\n   417→    }\n   418→\n   419→    /**\n   420→     * Obtener un plan de empresa.\n   421→     *\n   422→     * @param int $id ID del plan de empresa.\n   423→     * @return EmpresaPlan|null\n   424→     * @author Daniel Beltrán\n   425→     * @author Jair Carvajal\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"9ec63d4b-2a99-41bc-b90d-73165da68fbf","timestamp":"2026-01-25T02:01:13.467Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","content":"    public function planesCreditosActivos(int $empresa_id): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'created_at')\n            ->with([\n                'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'archivos' => function ($archivos) {\n                    $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                        ->orderBy('created_at', 'DESC');\n                }\n            ])\n            ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n            ->where('empresa_id', $empresa_id)\n            ->whereNull('plan_id')\n            ->whereNotNull('plan_credito_id')\n            ->whereIn('estado_id', [1, 4])\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->whereIn('estado_id', [1, 4])\n        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n            $query->where(function ($q) use ($tipo_prueba_id) {\n                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n                  ->orWhereNull('plan_id');\n            });\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal","numLines":50,"startLine":376,"totalLines":996}},"sourceToolAssistantUUID":"60f62f7b-5764-4459-8da2-22408f06511b"}
{"parentUuid":"9ec63d4b-2a99-41bc-b90d-73165da68fbf","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GF6QxGGvKV1znJJGSZwt8u","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora voy a agregar un método para obtener el plan de créditos próximo.","signature":"EvIBCkYICxgCKkDIPHwb3uJPMocwvrUFZFsFyacAHFWck+bPeA8YnzHQKrEEYZurX2612lT6HMiN3URuapZzcDJ6gAksiCOLcoy7Egyya10zlqrbX2I2WdAaDDMA/qHlw2rACxAJAyIw/wraelcW4/v0BDMXZu/mix64QoXkumLdEEoShOqu0WEbXN/wFt0DBbTorvueZ7tLKlo+8oLwXZSBfzHyEKH1twxU6AxSUWiafLuhaIbAwxwDXBpT28lslbFLULGbSX5Fik0ocegpmbGlT7IjYT+yJsN+/TMxvWmCu4hQRphtA+sch1MYkmHTPKQ6eRcYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2045,"cache_read_input_tokens":91918,"cache_creation":{"ephemeral_5m_input_tokens":2045,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXTGiHbF2qJEgmAxy2QJ5","type":"assistant","uuid":"af698af8-2612-4394-8a2e-4dd4f0ad6b1a","timestamp":"2026-01-25T02:01:15.995Z"}
{"parentUuid":"af698af8-2612-4394-8a2e-4dd4f0ad6b1a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GF6QxGGvKV1znJJGSZwt8u","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01G5KhW4ALNHPiLav5f2J7bP","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","old_string":"    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {","new_string":"    /**\n     * Obtener el plan de créditos próximo de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosProximo(int $empresa_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'created_at')\n            ->with([\n                'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'archivos' => function ($archivos) {\n                    $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                        ->orderBy('created_at', 'DESC');\n                }\n            ])\n            ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n            ->where('empresa_id', $empresa_id)\n            ->whereNull('plan_id')\n            ->whereNotNull('plan_credito_id')\n            ->where('estado_id', 3)\n            ->orderBy('created_at', 'ASC')\n            ->first();\n    }\n\n    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2045,"cache_read_input_tokens":91918,"cache_creation":{"ephemeral_5m_input_tokens":2045,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXTGiHbF2qJEgmAxy2QJ5","type":"assistant","uuid":"ebd0ee48-03d6-49df-a068-f8ef9f5591bf","timestamp":"2026-01-25T02:01:22.568Z"}
{"parentUuid":"ebd0ee48-03d6-49df-a068-f8ef9f5591bf","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01G5KhW4ALNHPiLav5f2J7bP","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php has been updated successfully."}]},"uuid":"ed49e7c6-6bea-420c-8237-ae03e44f1830","timestamp":"2026-01-25T02:01:23.761Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","oldString":"    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {","newString":"    /**\n     * Obtener el plan de créditos próximo de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosProximo(int $empresa_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'created_at')\n            ->with([\n                'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'archivos' => function ($archivos) {\n                    $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                        ->orderBy('created_at', 'DESC');\n                }\n            ])\n            ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n            ->where('empresa_id', $empresa_id)\n            ->whereNull('plan_id')\n            ->whereNotNull('plan_credito_id')\n            ->where('estado_id', 3)\n            ->orderBy('created_at', 'ASC')\n            ->first();\n    }\n\n    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {","originalFile":"<?php\n\nnamespace App\\Http\\Repositories\\Empresas;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Repositories\\BaseRepository;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n\nclass EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n{\n    /**\n     * Ids de los roles de tipo empresa.\n     *\n     * @var array\n     * @author Fahibram Cárcamo\n     */\n    private const IDS_ROLES_TIPO_EMPRESA = [\n        RolRepository::ROL_PROPIETARIO_ID,\n        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n        RolRepository::ROL_EVALUADOR_ID\n    ];\n\n    private $consulta_conteo_total_usuarios_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(EmpresaPlan $modelo) {\n        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n            (\n                SELECT COUNT(DISTINCT eu.usuario_id)\n                FROM empresas_usuarios AS eu\n                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n            ) AS conteo_total_usuarios_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.agenda_id IS NOT NULL\n            ) AS conteo_total_consumos_agendas_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.oferta_laboral_id IS NOT NULL\n            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n        ';\n\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener todos los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function getTodo(Request $request): Collection {\n        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n            'empresa:id,empresa_id,nombre_comercial,razon_social',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,predeterminado',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n            $query->with([\n                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with(['empresa' => function ($empresa) {\n                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n                        }])\n                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n                },\n                'consumos.agenda:id,prueba_id',\n                'consumos.agenda.prueba:id,nombre,slug'\n            ]);\n        })\n        ->when($con_conteo_consumos_agendas, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n        })\n        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($con_conteo_consumos_creditos, function ($consulta) {\n            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n            $query->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n            });\n        })\n        ->when($request->filled('plan_id'), function ($query) use ($request) {\n            $query->where('plan_id', $request->plan_id);\n        })\n        ->when(\n            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n            function ($query) use ($request) {\n                $query->whereIn($request->campo, $request->valores);\n            }\n        )\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estado_id);\n        })\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($subconsulta) {\n                $subconsulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n            ])\n            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n            ->when(\n                $request->filled('tipo_prueba_id'),\n                function ($consulta) use ($request) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n                },\n                function ($consulta) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                        TipoPrueba::SELECCION_ID,\n                        TipoPrueba::ORGANIZACIONAL_ID,\n                        TipoPrueba::VOCACIONAL_ID\n                    ]));\n                }\n            )\n            ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($sub_consulta) {\n                $sub_consulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'funcionalidades:id,nombre,predeterminado',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n                'consumos' => function ($consumos) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with([\n                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n                            'agenda:id,prueba_id',\n                            'agenda.prueba:id,nombre,slug'\n                        ]);\n                }\n            ])\n            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            })\n            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n            })\n            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n                    $sub_consulta->where('empresa_id', $request->empresa_id)\n                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n                        });\n                });\n            })\n            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n            }, function ($consulta) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                    TipoPrueba::SELECCION_ID,\n                    TipoPrueba::ORGANIZACIONAL_ID,\n                    TipoPrueba::VOCACIONAL_ID\n                ]));\n            })\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener datos básicos de los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     * @author Sergio Vargas\n     */\n    public function getDatosBasicos(Request $request): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'planCredito:id,nombre,creditos',\n            'consumosCreditos'\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n            $sentido = $request->ordenar_sentido ?? 'ASC';\n            $consulta->orderBy($request->ordenar_por, $sentido);\n        })\n        ->get();\n    }\n\n    /**\n     * Obtener el proximo plan de creditos de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planProximoCreditos(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with(['planCredito:id,nombre,creditos,precio'])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereNotNull('plan_credito_id')\n        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n            $query->where(function ($q) use ($tipo_prueba_id) {\n                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n                  ->orWhereNull('plan_id');\n            });\n        })\n        ->orderBy('created_at', 'ASC')\n        ->first();\n    }\n\n    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function planesCreditosActivos(int $empresa_id): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'created_at')\n            ->with([\n                'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'archivos' => function ($archivos) {\n                    $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                        ->orderBy('created_at', 'DESC');\n                }\n            ])\n            ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n            ->where('empresa_id', $empresa_id)\n            ->whereNull('plan_id')\n            ->whereNotNull('plan_credito_id')\n            ->whereIn('estado_id', [1, 4])\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener el plan de creditos activo de la empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int|null $tipo_prueba_id ID del tipo de prueba (opcional).\n     * @return EmpresaPlan|null\n     * @author Sergio Vargas\n     */\n    public function planCreditosActivo(int $empresa_id, ?int $tipo_prueba_id = null): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with(['planCredito:id,nombre,creditos,precio', 'consumosCreditos'])\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->whereIn('estado_id', [1, 4])\n        ->when($tipo_prueba_id, function ($query) use ($tipo_prueba_id) {\n            $query->where(function ($q) use ($tipo_prueba_id) {\n                $q->whereHas('plan', fn($plan) => $plan->where('tipo_prueba_id', $tipo_prueba_id))\n                  ->orWhereNull('plan_id');\n            });\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'funcionalidades:id,nombre,llave,valor',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->find($id);\n    }\n\n    /**\n     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n     *\n     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author José Manuel Jiménez\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])\n        ->first();\n    }\n\n    /**\n     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener el último plan asignado.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->where('estado_id', $request->estado_id);\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n    }\n\n    /**\n     * Sincronizar pruebas.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $pruebas ID's de las pruebas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n        $empresa_plan->pruebas()->sync($pruebas);\n    }\n\n    /**\n     * Sincronizar funcionalidades.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $funcionalidades ID's de las funcionalidades.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n        $empresa_plan->funcionalidades()->sync($funcionalidades);\n    }\n\n    /**\n     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return ?EmpresaPlan\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,llave,valor'\n        ])\n        ->when(\n            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            }\n        )\n        ->when(\n            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n            }\n        )\n        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n        ->first();\n    }\n\n    /**\n     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n     *\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author José Manuel Jiménez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function datosConsumosEmpresas(Request $request): Collection {\n        $roles_tipo_empresa_ids = [\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID\n        ];\n\n        $matriz_conteos = [\n            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n                'empresasUsuarios',\n                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n            )\n        ];\n\n        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw('\n                    (\n                        SELECT COUNT(DISTINCT eu.usuario_id)\n                        FROM empresas_usuarios AS eu\n                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n                    ) AS conteo_total_usuarios_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.agenda_id IS NOT NULL\n                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.oferta_laboral_id IS NOT NULL\n                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n                '),\n            ])\n            ->with([\n                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n                    $consulta_empresa->select($campos_empresas)\n                        ->whereNull('empresa_id')\n                        ->withCount([\n                            ...$matriz_conteos,\n                            'sucursales as conteo_sucursales'\n                        ])\n                        ->with([\n                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n                            }\n                        ]);\n                }\n            ])\n            ->when(\n                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n            )\n            ->whereNotIn('estado_id', [3, 8])\n            ->when(\n                $request->filled('prueba_id'),\n                fn($consulta) => $consulta->whereHas(\n                    'pruebas',\n                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n                )\n            )\n            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n            })\n            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta_plan_por->whereNotNull('unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n                        break;\n                }\n            })\n            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_vencimiento;\n                $fecha_fin    = $request->fecha_vencimiento;\n\n                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_inicio;\n                $fecha_fin    = $request->fecha_inicio;\n\n                if (strpos($request->fecha_inicio, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_inicio);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when(\n                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n            )\n            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n                if ($request->tipo_activacion === 'compra') {\n                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                } elseif ($request->tipo_activacion === 'recompra') {\n                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                }\n            })\n            ->get();\n    }\n\n    /**\n     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     */\n    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n        return $this->modelo::select(\n            'empresas_planes.id',\n            'empresas_planes.empresa_id',\n            'empresas_planes.plan_id',\n            'empresas_planes.plan_credito_id',\n            'empresas_planes.usuario_id',\n            'empresas_planes.estado_id',\n            'empresas_planes.unidades',\n            'empresas_planes.cantidad_ofertas_laborales',\n            'empresas_planes.cantidad_usuarios',\n            'empresas_planes.cantidad_pruebas',\n            'empresas_planes.creditos',\n            'empresas_planes.fecha_inicio',\n            'empresas_planes.fecha_vencimiento',\n            'empresas_planes.precio',\n            'empresas_planes.porcentaje_descuento',\n            'empresas_planes.numero_factura',\n            'empresas_planes.comentario',\n            'empresas_planes.plan_original',\n            'empresas_planes.renovando',\n            'empresas_planes.por_facturar',\n            'empresas_planes.created_at',\n            'planes.id',\n            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n            'planes.nombre AS plan_nombre',\n            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n            'planes.unidades AS plan_unidades',\n            'planes.vigencia AS plan_vigencia',\n            'planes.precio AS plan_precio',\n            'tipos_pruebas.id AS tipo_prueba_id',\n            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n            'estados_planes.id AS estado_plan_id',\n            'estados_planes.nombre AS estado_plan_nombre',\n            'users.id AS usuario_usuario_id',\n            'users.nombres AS usuario_nombres',\n            'users.apellidos AS usuario_apellidos',\n            'empresas.id AS empresa_empresa_id',\n            'empresas.empresa_id',\n            'empresas.nombre_comercial AS empresa_nombre_comercial',\n            'empresas.razon_social AS empresa_razon_social',\n            'empresas.nombre_contacto',\n            'empresas.celular_contacto',\n            'empresas.email_contacto',\n            'empresas.telefono_contacto',\n            'empresas.extension_contacto',\n            'empresas.nombre_tesorero',\n            'empresas.celular_tesorero',\n            'empresas.telefono_tesorero',\n            'empresas.email_tesorero',\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n                )\n                AS conteo_consumos_agendas\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n                )\n                AS conteo_consumos_ofertas_laborales\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM empresas\n                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n                )\n                AS conteo_sucursales\n            '),\n            DB::raw('\n                (\n                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n                    FROM empresas AS sucursales\n                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n                )\n                AS nombres_comerciales_sucursales\n            ')\n        )\n        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n        ->whereNull('empresas.empresa_id')\n        ->when(\n            $request->filled('plan_por'),\n            function ($consulta) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta->whereNotNull('empresas_planes.unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n                        break;\n                }\n            }\n        )\n        ->when(\n            $request->filled('tipo_prueba_id'),\n            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n                TipoPrueba::SELECCION_ID,\n                TipoPrueba::ORGANIZACIONAL_ID,\n                TipoPrueba::VOCACIONAL_ID\n            ])\n        )\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n        ->when(\n            $request->filled('ejecutivo_id'),\n            function ($consulta) use ($request) {\n                $consulta->whereExists(function ($subconsulta) use ($request) {\n                    $subconsulta->select(DB::raw(1))\n                        ->from('empresas_usuarios')\n                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n                });\n            }\n        )\n        ->when(\n            $request->filled('fecha_vencimiento'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n        )\n        ->when(\n            $request->filled('fecha_inicio'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n        )\n        ->when(\n            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n        )\n        ->get();\n    }\n\n    /**\n     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        return $this->modelo::select(\n            'id',\n            'empresa_id',\n            'plan_credito_id',\n            'estado_id',\n            'creditos',\n            'fecha_inicio',\n            'fecha_vencimiento',\n            'precio',\n            'porcentaje_descuento',\n            'numero_factura',\n            'comentario',\n            'created_at'\n        )\n        ->with([\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                    ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n}\n","structuredPatch":[{"oldStart":394,"oldLines":6,"newStart":394,"newLines":33,"lines":["     }"," ","     /**","+     * Obtener el plan de créditos próximo de la empresa (donde plan_id es NULL).","+     *","+     * @param int $empresa_id ID de la empresa.","+     * @return EmpresaPlan|null","+     * @author Sergio Vargas","+     */","+    public function planCreditosProximo(int $empresa_id): ?EmpresaPlan {","+        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'created_at')","+            ->with([","+                'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',","+                'estado:id,nombre',","+                'usuario:id,nombres,apellidos',","+                'archivos' => function ($archivos) {","+                    $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')","+                        ->orderBy('created_at', 'DESC');","+                }","+            ])","+            ->withSum('consumosCreditos as creditos_consumidos', 'creditos')","+            ->where('empresa_id', $empresa_id)","+            ->whereNull('plan_id')","+            ->whereNotNull('plan_credito_id')","+            ->where('estado_id', 3)","+            ->orderBy('created_at', 'ASC')","+            ->first();","+    }","+","+    /**","      * Obtener el plan de creditos activo de la empresa.","      *","      * @param int $empresa_id ID de la empresa."]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"ebd0ee48-03d6-49df-a068-f8ef9f5591bf"}
{"parentUuid":"ed49e7c6-6bea-420c-8237-ae03e44f1830","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_019Nx6XZDTGk7j7SjAfwnbSZ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito modificar el método `obtenerPlanesCreditosActivos()` en el servicio para agregar la propiedad `plan_proximo_id` a cada plan de créditos activo.","signature":"EskCCkYICxgCKkCbR34hen6lJLjwKgh3f3xRtsEDbQuE+9ohUNCfeMkXmqGTuh1OYhoaa8/by1Y/dXmjjBVuXzZx9ijFlkPyeuU+EgzJCKf25I0vGiQpH88aDJWGyqzXnS68loXzECIwx222m5TAi0/tJadCpJGzHJN0fxKMCSpfCTRyPWYOZz+VsR3i/0o7Is6ljgevz21NKrABz+VNtxJPvsO8TFtWGhLTcMav/nvtqU17LW4EscBqyvbADm0/LWzgdyh6pGuzokvI4q+XiGV15Qmytz79Cl+q9TRY/fv4q30909V2hZMh7bAjAX+1WFTg1eqLY2QyekmFS7VA0ftzY1M+E/Jjv76PyZrKi6lPuqc+xhCVp1j2OAfuoAyOMH9jsdohNNgZV4SqHMmmUJ/5/yfWXIYkJbzgYWCzc/r9eE3z++iA34mTqecYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1239,"cache_read_input_tokens":93963,"cache_creation":{"ephemeral_5m_input_tokens":1239,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGj4uXbn9qGmb8oVPpu","type":"assistant","uuid":"b2130859-a6be-41e8-b07e-bef35b18598e","timestamp":"2026-01-25T02:01:27.195Z"}
{"parentUuid":"b2130859-a6be-41e8-b07e-bef35b18598e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_019Nx6XZDTGk7j7SjAfwnbSZ","type":"message","role":"assistant","content":[{"type":"text","text":"**Paso 2:** Modificar el método `obtenerPlanesCreditosActivos()` en el servicio para agregar `plan_proximo_id`."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1239,"cache_read_input_tokens":93963,"cache_creation":{"ephemeral_5m_input_tokens":1239,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGj4uXbn9qGmb8oVPpu","type":"assistant","uuid":"112f33e0-e448-4046-84a0-9f7c929cb5ab","timestamp":"2026-01-25T02:01:27.839Z"}
{"parentUuid":"112f33e0-e448-4046-84a0-9f7c929cb5ab","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_019Nx6XZDTGk7j7SjAfwnbSZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QUw64h8nfgXBwuZxq5iCcG","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","offset":485,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1239,"cache_read_input_tokens":93963,"cache_creation":{"ephemeral_5m_input_tokens":1239,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGj4uXbn9qGmb8oVPpu","type":"assistant","uuid":"54eb46ad-9a55-4511-aaba-88402786fb2d","timestamp":"2026-01-25T02:01:28.781Z"}
{"parentUuid":"54eb46ad-9a55-4511-aaba-88402786fb2d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QUw64h8nfgXBwuZxq5iCcG","type":"tool_result","content":"   485→\n   486→    /**\n   487→     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n   488→     *\n   489→     * @param int $empresa_id ID de la empresa.\n   490→     * @return Collection\n   491→     * @author Sergio Vargas\n   492→     */\n   493→    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n   494→        return $this->repositorio->planesCreditosActivos($empresa_id);\n   495→    }\n   496→\n   497→    /**\n   498→     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n   499→     *\n   500→     * @param int $empresa_id ID de la empresa.\n   501→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   502→     * @return ?EmpresaPlan\n   503→     * @author Daniel Beltrán\n   504→     */\n   505→    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   506→        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n   507→            'empresa_id'             => $empresa_id,\n   508→            'tipo_prueba_id'         => $tipo_prueba_id,\n   509→            'excluir_estado_proximo' => true\n   510→        ]));\n   511→\n   512→        if (!is_null($plan)) {\n   513→            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   514→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"dfa5bf08-dfc2-4afe-bf3b-4d82a169a6fe","timestamp":"2026-01-25T02:01:29.706Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","content":"\n    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n        return $this->repositorio->planesCreditosActivos($empresa_id);\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n","numLines":30,"startLine":485,"totalLines":745}},"sourceToolAssistantUUID":"54eb46ad-9a55-4511-aaba-88402786fb2d"}
{"parentUuid":"dfa5bf08-dfc2-4afe-bf3b-4d82a169a6fe","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PjJ27Ns35qRGKTjRWgzW4s","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Voy a modificar el método `obtenerPlanesCreditosActivos()` para agregar la propiedad `plan_proximo_id` a cada plan de créditos activo.","signature":"ErECCkYICxgCKkDcZUGt/ToSsj95F3AU11PItlkXBzShj6FoD8ydwP0D50tpU8rvgTGOv6XtkzrWukttpMtWwiWSRlgZhMbfso7mEgxgvJUTKLsPjZry1+EaDEl/AIax1RkHRPXxJyIwmXG8Eb3Tdaeas3lDb4AJ2qNnQXz3agxZGfXNSRRmhdj4NSUU3M89wlnl7gF9cIz6KpgBNvmZUgCuD+odn1z6Xt51uPnkqxheuVwqcZ9HXkfGRaPbTC2QyfGxHqVkYy5C4E4AttakKK5alv9Tfn5uJ+BMgnfPdNKTEl6vviP5QSWFoO1WmtBcOvgavPpeaE7Y7XO+75KBbquTS1IfnKa0GDqpoj0ew+JDZorX4/qR2eEhivv71Yxt43fWpI8rtw0WkEGvBh223wf2KOQYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":768,"cache_read_input_tokens":95202,"cache_creation":{"ephemeral_5m_input_tokens":768,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTGjURdyhyxoXNsG5LJf","type":"assistant","uuid":"f964df10-c46f-47ff-a41d-c74865aa569f","timestamp":"2026-01-25T02:01:32.153Z"}
{"parentUuid":"f964df10-c46f-47ff-a41d-c74865aa569f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PjJ27Ns35qRGKTjRWgzW4s","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JRbngfLk9PVvAAshXUyTyr","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n        return $this->repositorio->planesCreditosActivos($empresa_id);\n    }","new_string":"    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     * Incluye la propiedad plan_proximo_id si existe un plan de créditos próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n        $planes = $this->repositorio->planesCreditosActivos($empresa_id);\n        $plan_proximo = $this->repositorio->planCreditosProximo($empresa_id);\n\n        return $planes->map(function ($plan) use ($plan_proximo) {\n            $plan->plan_proximo_id = $plan_proximo?->id ?? null;\n            return $plan;\n        });\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":768,"cache_read_input_tokens":95202,"cache_creation":{"ephemeral_5m_input_tokens":768,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTGjURdyhyxoXNsG5LJf","type":"assistant","uuid":"7f683265-ecc5-4225-8234-5093b0c213db","timestamp":"2026-01-25T02:01:36.362Z"}
{"parentUuid":"7f683265-ecc5-4225-8234-5093b0c213db","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JRbngfLk9PVvAAshXUyTyr","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated successfully."}]},"uuid":"6aedd682-a236-42dd-bf8b-3d7b693bf4c1","timestamp":"2026-01-25T02:01:37.197Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n        return $this->repositorio->planesCreditosActivos($empresa_id);\n    }","newString":"    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     * Incluye la propiedad plan_proximo_id si existe un plan de créditos próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n        $planes = $this->repositorio->planesCreditosActivos($empresa_id);\n        $plan_proximo = $this->repositorio->planCreditosProximo($empresa_id);\n\n        return $planes->map(function ($plan) use ($plan_proximo) {\n            $plan->plan_proximo_id = $plan_proximo?->id ?? null;\n            return $plan;\n        });\n    }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $tiene_plan_seleccion = $request->filled('plan_id');\n        $tiene_plan_creditos  = $request->filled('plan_credito_id');\n        $plan_asignado        = null;\n\n        // Si tiene plan de selección, crear/actualizar ese plan\n        if ($tiene_plan_seleccion) {\n            $plan_asignado = $this->guardarPlanSeleccion($request);\n        }\n\n        // Si tiene plan de créditos, crear ese plan por separado\n        if ($tiene_plan_creditos) {\n            $plan_creditos = $this->guardarPlanCreditos($request);\n\n            // Si no había plan de selección, retornar el de créditos\n            if (!$tiene_plan_seleccion) {\n                $plan_asignado = $plan_creditos;\n            }\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Guardar un plan de selección.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Andres Gonzalez\n     */\n    protected function guardarPlanSeleccion(Request $request): EmpresaPlan {\n        $enviar_correo    = false;\n        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades', 'precio_creditos', 'porcentaje_descuento_creditos', 'plan_credito_id', 'creditos'];\n        $plan             = $this->plan_repositorio->getUno($request->plan_id);\n        $plan_activo      = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n        $vigencia         = $plan->vigencia;\n\n        if ($request->filled('vigencia')) {\n            $vigencia = $request->vigencia;\n        }\n\n        if (!is_null($plan_activo)) {\n            if ($request->filled('id')) {\n                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                if ($request->id === $plan_activo->id) {\n                    goto omitir_calcular_vigencia_seleccion;\n                }\n\n                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                if ($vigencia == $request->vigencia) {\n                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                    goto omitir_calcular_vigencia_seleccion;\n                }\n            }\n\n            // Poner el nuevo plan como proximo\n            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n\n            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                // Agregar las nuevas fechas al nuevo plan\n                $hoy          = now();\n                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n            }\n        } else {\n            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n\n            // Validar si el plan seleccionado tiene vigencia\n            if (!is_null($plan->vigencia)) {\n                $request->merge($this->calcularFechasVigencia($vigencia));\n            }\n        }\n\n        omitir_calcular_vigencia_seleccion:\n\n        if (!$request->filled('unidades')) {\n            $request->merge(['unidades' => $plan->unidades]);\n        } elseif ($request->unidades != $plan->unidades) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_ofertas_laborales')) {\n            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_usuarios')) {\n            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_pruebas')) {\n            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        // Comprobar si se modificaron las funcionalidades respecto al plan original\n        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n\n            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                $request->merge(['plan_original' => false]);\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($enviar_correo) {\n            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario      = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n            $titulo       = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Guardar un plan de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Andres Gonzalez\n     */\n    protected function guardarPlanCreditos(Request $request): EmpresaPlan {\n        $enviar_correo = false;\n        $plan_credito  = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n        $plan_activo   = $this->repositorio->planCreditosActivo($request->empresa_id);\n\n        // Preparar datos para el plan de créditos\n        $datos_creditos = [\n            'empresa_id'            => $request->empresa_id,\n            'plan_id'               => null,\n            'plan_credito_id'       => $request->plan_credito_id,\n            'creditos'              => $plan_credito->creditos ?? 0,\n            'precio'                => $request->precio_creditos ?? $plan_credito->precio ?? null,\n            'porcentaje_descuento'  => $request->porcentaje_descuento_creditos ?? null,\n            'numero_factura'        => $request->numero_factura,\n            'comentario'            => $request->comentario,\n            'fecha_inicio'          => null,\n            'fecha_vencimiento'     => null,\n            'usuario_id'            => auth()->user()->id,\n        ];\n\n        // Si es edición de un plan de créditos existente\n        if ($request->filled('id')) {\n            // Eliminar la factura actual si se sube una nueva\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $datos_creditos);\n        } else {\n            // Determinar estado para nuevo plan\n            if (!is_null($plan_activo) && $plan_activo->id != $request->id) {\n                $datos_creditos['estado_id'] = Plan::ESTADO_PROXIMO_ID;\n            } else {\n                $datos_creditos['estado_id'] = Plan::ESTADO_ACTIVO_ID;\n            }\n\n            $enviar_correo = true;\n            $plan_asignado = $this->repositorio->crear($datos_creditos);\n        }\n\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     *\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     *\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy = now();\n\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses = $vigencia / 30;\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n\n        $this->generarDirectorios(\"app/{$ruta}\");\n\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n\n            'modelo_id' => $id,\n\n            'nombre' => 'factura',\n\n            'ruta' => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n\n        $request->merge([\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n\n            RolRepository::ROL_PROPIETARIO_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n\n            $plan->creditos_consumidos = $creditos_consumidos;\n\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n        return $this->repositorio->planesCreditosActivos($empresa_id);\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan               = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Andres González\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $tipo_plan = $request->tipo_plan ?? 'plan';\n\n        if ($tipo_plan === 'plan_credito') {\n            $plan = $this->plan_credito_repositorio->getUno($request->plan_id);\n        } else {\n            $plan = $this->plan_repositorio->getUno($request->plan_id);\n        }\n\n        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n            'empresa_id'    => $request->empresa_id,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     * @author José Manuel Jiménez\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planCreditosActivo($empresa_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null,\n            'estado'               => $empresa_plan->estado ? [\n                'id'     => $empresa_plan->estado->id,\n                'nombre' => $empresa_plan->estado->nombre,\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":485,"oldLines":13,"newStart":485,"newLines":20,"lines":[" ","     /**","      * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).","+     * Incluye la propiedad plan_proximo_id si existe un plan de créditos próximo.","      *","      * @param int $empresa_id ID de la empresa.","      * @return Collection","      * @author Sergio Vargas","      */","     public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {","-        return $this->repositorio->planesCreditosActivos($empresa_id);","+        $planes = $this->repositorio->planesCreditosActivos($empresa_id);","+        $plan_proximo = $this->repositorio->planCreditosProximo($empresa_id);","+","+        return $planes->map(function ($plan) use ($plan_proximo) {","+            $plan->plan_proximo_id = $plan_proximo?->id ?? null;","+            return $plan;","+        });","     }"," ","     /**"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"7f683265-ecc5-4225-8234-5093b0c213db"}
{"parentUuid":"6aedd682-a236-42dd-bf8b-3d7b693bf4c1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CfCQa5M1c6pvKg8whw9PDS","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito modificar el frontend para manejar el `plan_proximo_id` de los planes de créditos. Voy a verificar el código actual del frontend para ver dónde se define `opcion_editar_credito`.","signature":"Eu0CCkYICxgCKkDLPZkd+m/cZjPtZeZ9xyn8NUDKON0TTGQWmPnasCGOGeBdTmptWuqlk12zBIdileLvPF2NvMSJiIajBCML/rV5EgwnVuf4M6lrit7ts14aDJG81H6wA0A6/Ry9LCIwGOIL0pl8X+ps68LZozv5VdcXAthKigBRgBazh6kWACo+9cUJECvbwoqnnl2gAzK1KtQB09+uFl0QEJBHFemn9qR/WKxxc0gfZ+w389jP+yBJk9doJFcBv7yXMVuLYKrIAgnIHU02DFXX7oAoCdFNge7IAE0YUq2JCwpKd1ds2b4m8TZoMDZngmcPXbqf6YRDwO+4c9EPd9fx2ph4fzsqKUxG/1/mR14IOmNidgSInB0Oy0a669GAynjp1df8qyuB3CFrTjeM39JXQRrcZVFYZwBi7JOrwIyX5ScmbFM7nVAmmgEc4Q2MyOo9lKK1Bc+r0bbR7dYE8bctY252PYulE8CkaPQ4EZIYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":587,"cache_read_input_tokens":95970,"cache_creation":{"ephemeral_5m_input_tokens":587,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGk1oXJtRfoSWtDQjBo","type":"assistant","uuid":"1e6d2f93-ae3f-40c2-9dbc-a3ef8e923073","timestamp":"2026-01-25T02:01:40.446Z"}
{"parentUuid":"1e6d2f93-ae3f-40c2-9dbc-a3ef8e923073","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CfCQa5M1c6pvKg8whw9PDS","type":"message","role":"assistant","content":[{"type":"text","text":"**Paso 3:** Modificar el frontend para mostrar la opción de editar plan próximo de créditos."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":587,"cache_read_input_tokens":95970,"cache_creation":{"ephemeral_5m_input_tokens":587,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGk1oXJtRfoSWtDQjBo","type":"assistant","uuid":"8df3c6b7-cd92-419d-9867-f2c924b0123e","timestamp":"2026-01-25T02:01:41.224Z"}
{"parentUuid":"8df3c6b7-cd92-419d-9867-f2c924b0123e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CfCQa5M1c6pvKg8whw9PDS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01S45kW97zpvwgyKXDCeUpXw","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":1720,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":587,"cache_read_input_tokens":95970,"cache_creation":{"ephemeral_5m_input_tokens":587,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGk1oXJtRfoSWtDQjBo","type":"assistant","uuid":"a793c38e-278d-4a5c-9835-96aa7bf9e6ff","timestamp":"2026-01-25T02:01:42.516Z"}
{"parentUuid":"a793c38e-278d-4a5c-9835-96aa7bf9e6ff","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01S45kW97zpvwgyKXDCeUpXw","type":"tool_result","content":"  1720→                        fecha_activacion_credito = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n  1721→                    }\n  1722→\n  1723→                    let fecha_vencimiento_credito = '';\n  1724→                    if (planes[i].fecha_vencimiento != null) {\n  1725→                        fecha_vencimiento_credito = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n  1726→                    }\n  1727→\n  1728→                    let opcion_editar_credito = `\n  1729→                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n  1730→                            <i class=\"bi bi-pencil-fill\"></i>\n  1731→                        </button>\n  1732→                    `;\n  1733→\n  1734→                    let acciones_credito = obtenerAccionesCreditos(\n  1735→                        planes[i].estado.id,\n  1736→                        planes[i].id,\n  1737→                        empresa_id,\n  1738→                        planes[i]?.archivos[0]?.id ?? '0',\n  1739→                        empresa_seleccionada.nombre_comercial,\n  1740→                        plan_credito.nombre,\n  1741→                        plan_credito.creditos,\n  1742→                        planes[i].creditos_restantes ?? null\n  1743→                    );\n  1744→\n  1745→                    $('#tbody-planes').append(`\n  1746→                        <tr>\n  1747→                            <td style=\"border-bottom: 0px!important;\">\n  1748→                                <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n  1749→                                    <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0e6b1cca-c826-4036-9f64-1b5fba20890f","timestamp":"2026-01-25T02:01:43.435Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","content":"                        fecha_activacion_credito = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                    }\n\n                    let fecha_vencimiento_credito = '';\n                    if (planes[i].fecha_vencimiento != null) {\n                        fecha_vencimiento_credito = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                    }\n\n                    let opcion_editar_credito = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n                            <i class=\"bi bi-pencil-fill\"></i>\n                        </button>\n                    `;\n\n                    let acciones_credito = obtenerAccionesCreditos(\n                        planes[i].estado.id,\n                        planes[i].id,\n                        empresa_id,\n                        planes[i]?.archivos[0]?.id ?? '0',\n                        empresa_seleccionada.nombre_comercial,\n                        plan_credito.nombre,\n                        plan_credito.creditos,\n                        planes[i].creditos_restantes ?? null\n                    );\n\n                    $('#tbody-planes').append(`\n                        <tr>\n                            <td style=\"border-bottom: 0px!important;\">\n                                <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                    <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">","numLines":30,"startLine":1720,"totalLines":3607}},"sourceToolAssistantUUID":"a793c38e-278d-4a5c-9835-96aa7bf9e6ff"}
{"parentUuid":"0e6b1cca-c826-4036-9f64-1b5fba20890f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_017qXRAwUVZdCXgrqW5izZsE","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora voy a modificar el código para que cuando exista `plan_proximo_id` en un plan de créditos, se muestre un dropdown con la opción de editar el plan vigente y el plan próximo, igual que se hace con los planes regulares.","signature":"EosDCkYICxgCKkAFY6GEcyv74iiZSbsm2wFWNPYKKpMIRBCcLTdt4aYrP8p0ipa9nhXE+jxHP45J5OtWmqoFEUDAW62A8aGRiUQmEgw3VZVfnAU4LbW+o5AaDOmgba65MIbL4RjtaCIwyxlQxOK9XstIfszSfBVl/nz+WPJxMuMhRdOJtNS8eedEbAMx6Sa/XKWXg78iDv7CKvIBScpsq5edvgbQvxgJdY4KZNmru38ETIGK84jTUvvtzku6GswaQty3XOIKn1lujd/kplwX/apQNjyzVCnGV4cw9t9fNdJuJqVIVmbCfQNyvZ5EHSCNERgFnKYlip4E06LYapCMwcb+bpXp9cG05Z3TUBO1Ml86GBP2HvzbW2OwDwF/VnLkYV3kl5bFNH6v3QrJuutFvaJ4B1Rqsaf/Q2a5h3KwGg/8CsQVosc5EnmzmlabP6YPxdO7oW8yHRu+nstlZ/AIK41BzdrA3XSMbxoy9kjWOrKQVMJ3Q+G8DuMclRBG2VQt/hCXzZFh6qpwUPTmA7UYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":860,"cache_read_input_tokens":96557,"cache_creation":{"ephemeral_5m_input_tokens":860,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTGkUtSrGLSwZ7x6usq4","type":"assistant","uuid":"b60925ef-ce3f-4360-9157-7b60a16c962f","timestamp":"2026-01-25T02:01:46.588Z"}
{"parentUuid":"b60925ef-ce3f-4360-9157-7b60a16c962f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_017qXRAwUVZdCXgrqW5izZsE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUhFqAA5E6q8JptHUGvL5K","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","old_string":"                    let opcion_editar_credito = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n                            <i class=\"bi bi-pencil-fill\"></i>\n                        </button>\n                    `;\n\n                    let acciones_credito = obtenerAccionesCreditos(","new_string":"                    let opcion_editar_credito = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n                            <i class=\"bi bi-pencil-fill\"></i>\n                        </button>\n                    `;\n                    if (planes[i]?.plan_proximo_id) {\n                        opcion_editar_credito = `\n                            <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n                                <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                                <div class=\"dropdown-menu\">\n                                    <a href=\"/empresas-planes/${planes[i].id}/edit?tipo=creditos\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n                                    <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit?tipo=creditos\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n                                </div>\n                            </button>\n                        `;\n                    }\n\n                    let acciones_credito = obtenerAccionesCreditos("}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":860,"cache_read_input_tokens":96557,"cache_creation":{"ephemeral_5m_input_tokens":860,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTGkUtSrGLSwZ7x6usq4","type":"assistant","uuid":"72b25b57-a670-424d-9c0a-2e30b4e8c55e","timestamp":"2026-01-25T02:01:51.875Z"}
{"type":"file-history-snapshot","messageId":"72b25b57-a670-424d-9c0a-2e30b4e8c55e","snapshot":{"messageId":"3c9be7af-b61e-4db3-82a9-b315acaa8674","trackedFileBackups":{"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"1ef8fbba46b68267@v1","version":1,"backupTime":"2026-01-25T01:56:04.149Z"},"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"87ffcf5aa4ef1291@v1","version":1,"backupTime":"2026-01-25T01:56:11.952Z"},"app\\Http\\Services\\Empresas\\EmpresaService.php":{"backupFileName":"8caa2eff68e60519@v1","version":1,"backupTime":"2026-01-25T01:56:20.734Z"},"public\\js\\empresas\\empresas.js":{"backupFileName":"a4bb2c0878673cd8@v1","version":1,"backupTime":"2026-01-25T02:01:52.749Z"}},"timestamp":"2026-01-25T02:00:32.309Z"},"isSnapshotUpdate":true}
{"parentUuid":"72b25b57-a670-424d-9c0a-2e30b4e8c55e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUhFqAA5E6q8JptHUGvL5K","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js has been updated successfully."}]},"uuid":"0c5c2666-78e1-40fc-8fbb-53407e575179","timestamp":"2026-01-25T02:01:52.759Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","oldString":"                    let opcion_editar_credito = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n                            <i class=\"bi bi-pencil-fill\"></i>\n                        </button>\n                    `;\n\n                    let acciones_credito = obtenerAccionesCreditos(","newString":"                    let opcion_editar_credito = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n                            <i class=\"bi bi-pencil-fill\"></i>\n                        </button>\n                    `;\n                    if (planes[i]?.plan_proximo_id) {\n                        opcion_editar_credito = `\n                            <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n                                <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                                <div class=\"dropdown-menu\">\n                                    <a href=\"/empresas-planes/${planes[i].id}/edit?tipo=creditos\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n                                    <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit?tipo=creditos\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n                                </div>\n                            </button>\n                        `;\n                    }\n\n                    let acciones_credito = obtenerAccionesCreditos(","originalFile":"let redirige_form = 'empresas-gestionar';\nlet empresa_id      = null;\nlet enlace_creacion = null;\nlet resource_url = 'empresas';\nlet logo_valido = true;\nlet validacion_logo_mensaje = '';\nif (resource_url == undefined) {\n    redirige_form = 'empresas';\n}\nlet usuarios_seleccionados = [];\nlet empresas_seleccionadas = [];\nlet url_datatable = {\n    url: resource_url + '-listado-tabla',\n};\nlet cantidad_empresas_listado = 0;\nlet empresas_listado = [];\nempresa_id_eliminar = null;\nempresa_nombre_eliminar = '';\n\nconst CAMPO_CELULAR_ID = 'celular';\nconst CAMPO_CELULAR_CONTACTO_ID = 'celular_contacto';\nconst CAMPO_CELULAR_TESORERO_ID = 'celular_tesorero';\nconst CAMPO_CELULAR_USUARIO_ID = 'celular_usuario';\n\nlet campo_celular = null;\nlet campo_celular_contacto = null;\nlet campo_celular_tesorero = null;\nlet campo_celular_usuario = null;\n\nlet columnas_datatable = [\n    { data: 'id' },\n    { data: 'sucursales_count' },\n    { data: 'id' },\n    { data: 'nombre_comercial' },\n    { data: 'razon_social' },\n    { data: 'documento' },\n    { data: 'ejecutivo.nombre_completo' },\n    { data: 'plan_seleccion' },\n    { data: 'plan_organizacional' },\n    { data: 'plan_vocacional' },\n    { data: null, name: 'acciones', orderable: false, searchable: false }\n];\n\nlet colunmasHTML = [\n    {\n        targets: [0],\n        render: function (data) {\n            return `<div class=\"check-container my-1 me-1\">\n                        <input type=\"checkbox\" class=\"form-check-input\" value=\"${data}\" name=\"empresas_seleccionadas[]\" />\n                    </div>`;\n        }\n    },\n    {\n        targets: 1,\n        render: function (data, type, row) {\n            // Agrega botón para mostrar sucursales\n            return `<span style=\"witdh:80px;\" class=\"pointer\" onclick=\"mostrarOcultarSucursales(this, ${row.id})\">${row.sucursales_count}</span>`;\n        }\n    },\n    {\n        targets: -1,\n        render: function(data, type, row) {\n            return `\n                <div class=\"text-center text-nowrap\">\n                    <button type=\"button\" class=\"btn btn-text-primary btn-circle\" onclick=\"consultarTabla('${resource_url}', ${row.id}, 'ver')\">\n                        <i class=\"bi bi-eye\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary btn-circle\" onclick=\"consultarTabla('${resource_url}', ${row.id}, 'editar')\">\n                        <i class=\"bi bi-pencil\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalArchivar(${row.id})\">\n                        <i class=\"bi bi-archive\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirHistorialCambios(${row.id}, '${row.razon_social}')\">\n                        <i class=\"bi bi-clock\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirDetalleArchivado(${row.id}, '${row.razon_social}', '${row.comentario}')\" title=\"Detalle de archivado\">\n                        <i class=\"bi bi-list\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-danger text-white btn-circle\" onclick=\"eliminarTabla('${resource_url}', ${row.id}, 'empresa')\">\n                        <i class=\"bi bi-trash\"></i>\n                    </button>\n                </div>\n            `;\n        }\n    },\n    {\n        targets: [6, 7, 8], // Columnas de planes de empresa por tipo de prueba\n        render: function (data) {\n            if (data === null) {\n                return null;\n            }\n\n            return `<span onclick=\"abrirDetallePlan(${data?.id})\" class=\"pointer\">${data?.estado?.nombre}</span>`;\n        }\n    }\n];\n\n/**\n * Función que abre el modal para filtrar las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirModalFiltrosAvanzadosEmpresas() {\n    $('#modal-filtros-avanzados-empresas').modal('show');\n}\n\n/**\n * Función busca los planes de un tipo de prueba para el filtrado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction seleccionarTipoPruebaFiltro(tipo_prueba_id) {\n    $('#filtro_plan_id').empty();\n    if (tipo_prueba_id == '') {\n        $('#filtro_plan_id').append(`<option value=\"\">Todos</option>`);\n        $('#filtro-plan').addClass('d-none');\n    } else {\n        $.ajax({\n            type : 'GET',\n            url : `/planes-listado`,\n            data : {\n                tipo_prueba_id: tipo_prueba_id\n            },\n            success: function(respuesta) {\n                let planes = respuesta.data;\n                $('#filtro_plan_id').append(`<option value=\"\">Todos</option>`);\n                for (let i = 0; i < planes.length; i++) {\n                    $('#filtro_plan_id').append(`\n                        <option value=\"${planes[i].id}\">${planes[i].nombre}</option>\n                    `);\n                }\n            },\n            error: function(error) {\n                console.log(error);\n            }\n        });\n        $('#filtro-plan').removeClass('d-none');\n    }\n}\n\n/**\n * Función recarga las empresas con el filtro aplicado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction aplicarFiltrosAvanzadosEmpresas() {\n    mostrarEmpresas();\n    $('#modal-filtros-avanzados-empresas').modal('hide');\n}\n\n/**\n * Función que limpia los filtros aplicados en las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction borrarFiltrosAvanzadosEmpresas() {\n    $('#modal-filtros-avanzados-empresas .select2-filtro').val('').trigger('change').trigger('select2:select');\n    aplicarFiltrosAvanzadosEmpresas();\n}\n\n/**\n * Función que muestra la lista de las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarEmpresas() {\n    let estado = !archivadas;\n    let tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n    let plan_id = $('#filtro_plan_id').val();\n    let ejecutivo_id = $('#filtro_ejecutivo_id').val();\n    let rango_fechas = $('#filtro_fecha_hora').val();\n    if (rango_fechas != '') {\n        rango_fechas = rango_fechas.split(\" a \");\n    }\n    let pais_id = $('#pais_id').val();\n    let departamento_id = $('#departamento_id').val();\n    let estado_plan_id = $('#filtro_estado').val();\n    let ciudad_id = $('#ciudad_id').val();\n    inicializarTooltips()\n    $.ajax({\n        type: 'GET',\n        url: `/empresas-listado-tabla`,\n        data: {\n            'solo_principales': true,\n            'estado_plan_id': estado_plan_id,\n            'activo': estado,\n            'tipo_prueba_id': tipo_prueba_id,\n            'plan_id': plan_id,\n            'ejecutivo_id': ejecutivo_id,\n            'rango_fechas': rango_fechas,\n            'pais_id': pais_id,\n            'departamento_id': departamento_id,\n            'ciudad_id': ciudad_id\n        },\n        success: function(empresas) {\n            cantidad_empresas_listado = 0;\n            empresas_listado = empresas;\n            if ($.fn.DataTable.isDataTable('#tabla-empresas')) {\n                tabla_empresas.destroy();\n            }\n            $('#buscador-empresas').remove();\n            $('#tbody-empresas').empty();\n            for (let i = 0; i < empresas.length; i++) {\n                cantidad_empresas_listado++;\n                crearItemTabla(empresas[i]);\n                let sucursales = empresas[i].sucursales;\n                for (let j = 0; j < sucursales.length; j++) {\n                    cantidad_empresas_listado++;\n                    crearItemTabla(sucursales[j], 'sucursal', empresas[i].plan_seleccion, empresas[i].plan_organizacional, empresas[i].plan_vocacional);\n                }\n            }\n            tabla_empresas = $('#tabla-empresas').DataTable({\n                language: lenguajeDatatables,\n                deferRender: true,\n                lengthMenu: [\n                    [ 10, 25, 50, 100, 200],\n                    [ 10, 25, 50, 100, 200]\n                ],\n                columnDefs: [\n                    { targets: [0, 1], orderable: false }\n                ],\n            });\n            mostrarComponenteNumeroRegistrosTabla('tabla-empresas');\n            $('colgroup').addClass('d-none');\n            mostrarOcultarColumnas();\n            tabla_empresas.on('page order length', function () {\n                setTimeout(function() {\n                    mostrarOcultarColumnas();\n                }, 30);\n            });\n            $(`#buscador-tabla-empresas`).empty();\n            $(`#buscador-tabla-empresas`).append(`\n                <div class=\"input-container input-icon mb-3\" id=\"contenedor-buscador-tabla-empresas\">\n                    <i class=\"bi bi-search\"></i>\n                    <i class=\"bi bi-filter pointer\" style=\"right: 10px!important; left: auto!important;\" onclick=\"abrirModalFiltrosAvanzadosEmpresas();\"></i>\n                </div>\n            `);\n            var buscador_datatables = $(`#tabla-empresas_wrapper .dt-search .dt-input`).first();\n            $(buscador_datatables).addClass('rounded-2 text-body-2 input-filtro');\n            $(buscador_datatables).prop('placeholder', 'Buscar');\n            $(`#contenedor-buscador-tabla-empresas`).append(buscador_datatables);\n            $(`#tabla-empresas_wrapper .dt-layout-cell.dt-end `).first().addClass('d-none');\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Función que muestra cada item de empresa o sucursal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction crearItemTabla(item, tipo = 'empresa', plan_seleccion = null, plan_organizacional = null, plan_vocacional = null) {\n    let campo_sucursal = '';\n    if (tipo == 'empresa' && item.sucursales.length > 0) {\n        campo_sucursal = `\n            <div class=\"width-60px rounded-1 badge-estado-plan badge-estado-inactivo nowrap pointer\" onclick=\"mostrarOcultarSucursales(this, ${item.id})\">\n                ${item.sucursales_count} <i class=\"bi bi-caret-down-fill\"></i>\n            </div>\n        `;\n    }\n    let planes = '';\n    let clase = '';\n    let bg = '';\n    if (tipo == 'sucursal') {\n        clase = `empresa-${item.empresa_id} d-none`;\n        bg = 'bg-gray-90';\n        planes = `\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_seleccion?.estado?.id ?? null,\n                    plan_seleccion?.estado?.nombre ?? null,\n                    plan_seleccion?.por_facturar ?? null,\n                    plan_seleccion?.renovando ?? null,\n                    plan_seleccion?.id ?? null,\n                    plan_seleccion?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_organizacional?.estado?.id ?? null,\n                    plan_organizacional?.estado?.nombre ?? null,\n                    plan_organizacional?.por_facturar ?? null,\n                    plan_organizacional?.renovando ?? null,\n                    plan_organizacional?.id ?? null,\n                    plan_organizacional?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_vocacional?.estado?.id ?? null,\n                    plan_vocacional?.estado?.nombre ?? null,\n                    plan_vocacional?.por_facturar ?? null,\n                    plan_vocacional?.renovando ?? null,\n                    plan_vocacional?.id ?? null,\n                    plan_vocacional?.plan_proximo\n                )}\n            </td>\n        `;\n    } else {\n        planes = `\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_de_seleccion?.estado?.id ?? null,\n                    item?.plan_procesos_de_seleccion?.estado?.nombre ?? null,\n                    item?.plan_procesos_de_seleccion?.por_facturar ?? null,\n                    item?.plan_procesos_de_seleccion?.renovando ?? null,\n                    item?.plan_procesos_de_seleccion?.id ?? null,\n                    item?.plan_procesos_de_seleccion?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_organizacionales?.estado?.id ?? null,\n                    item?.plan_procesos_organizacionales?.estado?.nombre ?? null,\n                    item?.plan_procesos_organizacionales?.por_facturar ?? null,\n                    item?.plan_procesos_organizacionales?.renovando ?? null,\n                    item?.plan_procesos_organizacionales?.id ?? null,\n                    item?.plan_procesos_organizacionales?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_vocacionales?.estado?.id ?? null,\n                    item?.plan_procesos_vocacionales?.estado?.nombre ?? null,\n                    item?.plan_procesos_vocacionales?.por_facturar ?? null,\n                    item?.plan_procesos_vocacionales?.renovando ?? null,\n                    item?.plan_procesos_vocacionales?.id ?? null,\n                    item?.plan_procesos_vocacionales?.plan_proximo\n                )}\n            </td>\n        `;\n    }\n    let checked = '';\n    if (empresas_seleccionadas.includes(item.id)) {\n        checked = 'checked';\n    }\n\n    $('#tbody-empresas').append(`\n        <tr class=\"${clase} ${bg}\">\n            <td class=\"${bg}\">\n                <div class=\"check-container my-1 me-1\">\n                    <input type=\"checkbox\" class=\"form-check-input\" value=\"${item.id}\" onchange=\"seleccionarCheckboxEmpresa(this.checked, this.value);\" ${checked}/>\n                </div>\n            </td>\n            <td class=\"${bg}\">${campo_sucursal ?? ''}</td>\n            <td class=\"${bg}\">${item?.id ?? ''}</td>\n            <td class=\"${bg}\">${item?.nombre_comercial ?? ''}</td>\n            <td class=\"${bg}\">${item?.razon_social ?? ''}</td>\n            <td class=\"${bg}\">${item?.documento ?? ''}</td>\n            <td class=\"${bg}\">${item?.ejecutivo?.nombre_completo ?? ''}</td>\n            ${planes}\n            <td class=\"${bg} d-none columna-ubicacion\">${item?.ciudad?.nombre ?? ''} ${item?.ciudad?.departamento?.pais?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-numero-celular\">${item?.celular ?? ''}</td>\n            <td class=\"${bg} d-none columna-correo-facturacion\">${item?.email_facturacion ?? ''}</td>\n            <td class=\"${bg} d-none columna-fecha-creacion\">${item?.created_at ?? ''}</td>\n            <td class=\"${bg} d-none columna-progreso-creacion\">${item?.porcentaje_creacion ?? ''}</td>\n            <td class=\"${bg} d-none columna-tamano-empresa\">${item?.tamano_empresa?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-sector\">${item?.sector?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-direccion\">${item?.direccion ?? ''}</td>\n            <td class=\"${bg} d-none columna-representante\">${item?.nombre_representante ?? ''}</td>\n            <td class=\"${bg} text-center\">\n                <div class=\"col-auto px-0 dropdown\">\n                    <i class=\"bi bi-three-dots dropdown-toggle text-blue-40 pointer\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                    <div class=\"dropdown-menu\">\n                        <a href=\"/empresas-gestionar/${item.id}\" class=\"dropdown-item no-visited pointer py-2\">Gestionar empresa</a>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirHistorialCambios(${item?.id}, '${item?.razon_social}', '${item?.creado_administrador}')\">Historial de cambios</div>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirModalArchivar(${item?.id})\">Archivar</div>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"cambiarEmpresa(${item?.id});\">Cambiar a esta empresa</div>\n                        <div class=\"dropdown-item no-visited pointer py-2 text-danger\" onclick=\"abrirModalConfirmarEliminarEmpresas('${item?.id}', '${item?.razon_social}')\">Eliminar</div>\n                    </div>\n                </div>\n            </td>\n        </tr>\n    `);\n}\n\n/**\n * Función que muestra u oculta las sucursales de una empresa.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarOcultarSucursales(elemento, empresa_id_padre) {\n    if ($(elemento).find('.bi-caret-down-fill').first().length > 0) {\n        $('.empresa-' + empresa_id_padre).removeClass('d-none');\n        $(elemento).find('.bi-caret-down-fill').first().removeClass('bi-caret-down-fill').addClass('bi-caret-up-fill');\n    } else {\n        $('.empresa-' + empresa_id_padre).addClass('d-none');\n        $(elemento).find('.bi-caret-up-fill').first().removeClass('bi-caret-up-fill').addClass('bi-caret-down-fill');\n    }\n}\n\n/**\n * Función que evalua que columnasn adicionales hay que mostrar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarOcultarColumnas() {\n    let columnas = $('.filtro-columna');\n    for (let i = 0; i < columnas.length; i++) {\n        let valor = $(columnas[i]).val();\n        let checked = $(columnas[i]).prop('checked');\n        if (checked) {\n            $('.' + valor).removeClass('d-none');\n        } else {\n            $('.' + valor).addClass('d-none');\n        }\n    }\n}\n\n/**\n * Función que abre el modal para confirmar la eliminación de empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirModalConfirmarEliminarEmpresas(empresa_id = null, nombre_empresa = '') {\n    empresa_id_eliminar = empresa_id;\n    nombre_empresa = 'Eliminar ' + nombre_empresa;\n    $('#nombre-confirmar-eliminacion').text(nombre_empresa);\n    $('#modal-confirmar-eliminacion').modal('show');\n}\n\n/**\n * Confirmar la eliminación de empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction confirmarEliminarEmpresas() {\n    eliminarEmpresas(empresa_id_eliminar);\n}\n\n/**\n * Eliminar empresas.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function eliminarEmpresas(empresa_id = null) {\n    await $.ajax({\n        type: 'DELETE',\n        url : `/empresas/${empresa_id}`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n        }\n    }).then((respuesta) => {\n        empresa_id_eliminar = null;\n        empresa_nombre_eliminar = '';\n        if (respuesta.tipo != undefined && respuesta.tipo == 'success') {\n            mostrarToast('success', respuesta.mensaje);\n            mostrarEmpresas();\n        } else if (respuesta.errors != undefined) {\n            mostrarToast('danger', respuesta.message);\n        }\n        $('#modal-confirmar-eliminacion').modal('hide');\n    }).catch((error) => {\n        mostrarToast('danger', error.responseJSON.errors);\n        empresa_id_eliminar = null;\n        empresa_nombre_eliminar = '';\n        $('#modal-confirmar-eliminacion').modal('hide');\n    });\n}\n\n$(document).ready(function () {\n    if (typeof opcion_form !== 'undefined' && opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;\n        $(\"#digito_verificacion\").val(numero)\n    }\n\n    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n\n    inicializarSelect2Asincrono('filtro_empresa_id', 'empresas-listado', 'razon_social', { id: 'id', nombre: 'razon_social' }, false, { solo_principales: true });\n\n    configurarFormulario('formulario-archivos');\n    configurarFormulario('formulario-contactos');\n\n    if ($('#pais_id').val() != '') {\n        $('#pais_id').trigger('change');\n    }\n    if ($('#empresa_id').val() != '') {\n        $('#empresa_id').trigger('change');\n    }\n    if ($('#filtro_empresa_id').val() != '') {\n        $('#filtro_empresa_id').trigger('change').trigger('select2:select');\n    }\n    let empresa_id = $('#formulario #id').val();\n    if (![undefined, null, ''].includes(empresa_id)) {\n        $.ajax({\n            type: 'GET',\n            url : `/empresas-logo/${empresa_id}`,\n            success: function() {\n                $('#logo_fondo_previsualizacion').addClass('d-none');\n                $('#logo_previsualizacion').attr('src', `/empresas-logo/${empresa_id}`);\n                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n            }\n        });\n    }\n    $(\"#modal-filtros-avanzados\").on(\"hidden.bs.modal\", function () {\n        $('#modal-historial-cambios-usuario').modal('show');\n    });\n    inicializarTooltips();\n});\n\nfunction postSuccess(respuesta) {\n    if (respuesta.formulario == 'formulario') {\n        if (respuesta.data.empresa_id == null) {\n            if (vista == 'crear-editar') {\n                mostrarToast('success', `La empresa se ${respuesta.accion_realizada} con éxito`);\n                $('#empresa-tab').html(`<i class=\"bi bi-check\"></i>`);\n                $('#documentos-tab').prop('disabled', false);\n                $('#documentos-tab').click();\n            } else if (vista == 'gestionar') {\n                mostrarToast('success', `La empresa se ${respuesta.accion_realizada} con éxito`);\n            }\n        } else {\n            if (vista == 'crear-editar') {\n                if (opcion_form === 'Editar') {\n                    localStorage.setItem('notificacionToast', JSON.stringify({\n                        tipo_alerta: 'success',\n                        texto_1: `La sucursal se ${respuesta.accion_realizada} con éxito`,\n                    }));\n                } else {\n                    localStorage.setItem('notificacionToast', JSON.stringify({\n                        sucursal_creada: true,\n                        id_sucursal: respuesta.data.id,\n                        nombre_comercial_sucursal: respuesta.data.nombre_comercial\n                    }));\n                }\n                if (tipo_rol_activo_usuario === 'empresa') {\n                    window.location.href = '/sucursales';\n                } else if (tipo_rol_activo_usuario === 'superadmin') {\n                    window.location.href = '/empresas';\n                }\n            } else if (vista == 'gestionar') {\n                mostrarToast('success', `La sucursal se ${respuesta.accion_realizada} con éxito`);\n            }\n        }\n    } else if (respuesta.formulario == 'formulario-archivos') {\n        if (Array.isArray(respuesta.data) && respuesta.data.length > 0) actualizarEnlacesPrevisualizacionArchivos(respuesta.data, false);\n        mostrarToast('success', `Los documentos se ${respuesta.accion_realizada} con éxito`);\n        $('#documentos-tab').html(`<i class=\"bi bi-check\"></i>`);\n        $('#contactos-tab').prop('disabled', false);\n        $('#contactos-tab').click();\n    } else if (respuesta.formulario == 'formulario-contactos') {\n        mostrarToast('success', `La información de contacto se ${respuesta.accion_realizada} con éxito`);\n        $('#contactos-tab').html(`<i class=\"bi bi-check\"></i>`);\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `La empresa se ${respuesta.accion_realizada} con éxito`,\n        }));\n        window.location.href='/empresas';\n    }\n    if (typeof respuesta.data !== 'undefined' && typeof es_sucursal !== 'undefined'){\n        if (es_sucursal == false) {\n            if (typeof respuesta.data.id !== 'undefined') {\n                $('.id').val(respuesta.data.id);\n            }\n        }\n    }\n}\n\n/**\n * Validar datos antes de enviar el formulario.\n *\n * @returns {boolean}\n * @author Daniel Beltrán\n * @author Jair Carvajal\n */\nfunction validacionAdicional() {\n    if (campo_celular !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular, CAMPO_CELULAR_ID);\n    }\n    if (campo_celular_contacto !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_contacto, CAMPO_CELULAR_CONTACTO_ID);\n    }\n    if (campo_celular_tesorero !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_tesorero, CAMPO_CELULAR_TESORERO_ID);\n    }\n    if (campo_celular_usuario !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_usuario, CAMPO_CELULAR_USUARIO_ID);\n    }\n\n    if ($('#usuario').length) {\n        $('#usuario').val('');\n        let usuario_id = $('#usuario_id').val();\n        if (usuario_id.length == 0) {\n            usuario_id = null;\n        }\n        let usuario = {\n            id                       : usuario_id,\n            tipo_documento_id        : $('#tipo_documento_id').val(),\n            documento                : $('#documento_usuario').val(),\n            nombres                  : $('#nombres').val(),\n            apellidos                : $('#apellidos').val(),\n            email                    : $('#email').val(),\n            codigo_iso2_pais_telefono: $(`#codigo_iso2_pais_${CAMPO_CELULAR_USUARIO_ID}`).val(),\n            indicativo_telefono      : $(`#indicativo_${CAMPO_CELULAR_USUARIO_ID}`).val(),\n            telefono                 : $(`#${CAMPO_CELULAR_USUARIO_ID}`).val()\n        };\n\n        $('#usuario').val(JSON.stringify(usuario));\n    }\n\n    if (!logo_valido) {\n        mostrarToast('danger', validacion_logo_mensaje);\n        return false;\n    }\n\n    return true;\n}\n\nfunction seleccionarEmpresa(empresa_id) {\n    $('.campo-sucursal').addClass('d-none');\n\n    if (empresas_principales.length) {\n        let ejecutivo = empresas_principales.filter(empresa_principal => empresa_principal.id === parseInt(empresa_id))[0].ejecutivo;\n        $('#ejecutivo-cuenta').text('Ejecutivo de cuenta: ' + ejecutivo?.nombre_completo);\n        let campo_ejecutivo_id = $('input[type=\"hidden\"]#ejecutivo_id');\n        if (campo_ejecutivo_id) {\n            campo_ejecutivo_id.val(ejecutivo?.id);\n        }\n    }\n\n    $('#empresa_id').val('');\n    if (empresa_id.length > 0) {\n        $('#empresa_id').val(empresa_id);\n        $('.campo-sucursal').removeClass('d-none');\n    }\n}\n\nfunction cambiarLogoSucursal() {\n    $('#cambiar-logo').addClass('d-none');\n    $('.campo-imagen-sucursal').removeClass('d-none');\n}\n\nfunction validarLineasTabs() {\n    let pasos = $('.nav-pasos:not(:disabled)').length;\n    for (let i = 0; i < (pasos - 1); i++) {\n        $($('.hr-tab')[i]).addClass('border-blue-40 opacity-100');\n    }\n}\n\n/**\n * Obtener los departamentos según el país seleccionado.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\n$(document).on('change', '#pais_id', function() {\n    const pais_id = $(this).val();\n    $('#departamento_id').empty();\n    $('#ciudad_id').empty();\n    if (pais_id != null && pais_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/departamentos-listado`,\n            data: {\n                pais_id: pais_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n            $('#departamento_id').append(`<option></option>`);\n            datos.forEach((item) => {\n                $('#departamento_id').append(new Option(item.nombre, item.id));\n            });\n            if ($(this).data('departamento_id') != '') {\n                $('#departamento_id').val($(this).data('departamento_id')).trigger('change');\n            }\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n});\n\n/**\n * Obtener las ciudades según el departamento seleccionado.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\n$(document).on('change', '#departamento_id', function() {\n    const departamento_id = $(this).val();\n    $('#ciudad_id').empty();\n    if (departamento_id != null && departamento_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/ciudades-listado`,\n            data: {\n                departamento_id: departamento_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n            $('#ciudad_id').append(`<option></option>`);\n            datos.forEach((item) => {\n                $('#ciudad_id').append(new Option(item.nombre, item.id));\n            });\n            if ($(this).data('ciudad_id') != '') {\n                $('#ciudad_id').val($(this).data('ciudad_id')).trigger('change');\n            }\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n});\n\n/**\n * Obtener las sucursales de la empresa seleccionada.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction buscarSucursalesEmpresa(empresa_id, sucursal_id = null) {\n    $('#filtro_sucursal_id').empty();\n    $('#filtro_sucursal_id').append(`<option value=\"\"></option>`);\n    if (empresa_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/empresas-listado`,\n            data: {\n                empresa_id: empresa_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n\n            datos.forEach((item) => {\n                let selected = '';\n                if (sucursal_id == item.id) {\n                    selected = 'selected';\n                }\n                $('#filtro_sucursal_id').append(`\n                    <option value=\"${item.id}\" ${selected}>${item.nombre_comercial}</option>\n                `);\n            });\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n}\n\n/**\n * Obtener los planes de la empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {Object} parametros Parámetros para filtrar los planes.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function getPlanesEmpresa(empresa_id, parametros = {}) {\n    $.ajax({\n        type: 'GET',\n        url : `/empresas-planes-listado/${empresa_id}`,\n        data: parametros\n    }).then((response) => {\n        const datos = response.data;\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n/**\n * Abrir el modal para archivar o desarchivar empresa.\n *\n * @param {number} id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction abrirModalArchivar(id) {\n    $('#modal-archivar').modal('show');\n    $('#empresa-archivar-id').val(null);\n    $('#empresa-archivar-id').val(id);\n}\n\n/**\n * Archivar o desarchivar empresa.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction archivar() {\n    const formulario = $('#formulario-archivar');\n\n    formulario.validate({\n        ignore: [] // No ignorar campos ocultos\n    });\n\n    const datos = new FormData(formulario[0]);\n    datos.append('_token', $('meta[name=\"csrf-token\"]').attr('content'));\n    datos.append('activo', archivadas);\n    datos.delete('id');\n\n    const id = $('#empresa-archivar-id').val();\n\n    if (formulario.valid()) {\n        $.ajax({\n            type       : 'POST',\n            url        : `/empresas-archivar/${id}`,\n            data       : datos,\n            processData: false,\n            contentType: false\n        }).then((respuesta) => {\n            mostrarToast('success', respuesta.mensaje);\n            $('#modal-archivar').modal('hide');\n            formulario[0].reset();\n            mostrarEmpresas();\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n};\n\n/**\n * Abrir el historial de cambios.\n *\n * @param {number} id ID de la empresa.\n * @param {string} razon_social Razón social de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirHistorialCambios(id, razon_social, creado_administrador = 0) {\n\n    $(document).on('shown.bs.tab', 'a.nav-item-horizontal', function () {\n        let id_tab = $(this).attr('id');\n        $('#descargar-historial').removeClass('d-none');\n        if (id_tab == 'archivos') {\n            $('#descargar-historial').addClass('d-none');\n        }\n    });\n\n    $('#modal-historial-cambios').modal('show');\n    $('#descargar-historial').attr('onclick', `descargarExcel('empresas-historial-cambios-exportar/${id}', 'historial-cambios')`);\n    $('#historial-razon-social').text(razon_social);\n    if (creado_administrador == 1) {\n        $('#forma-creacion').text('Manualmente');\n    } else {\n        $('#forma-creacion').text('Automático');\n    }\n    const TITULOS_CAMPOS = {\n        id                             : 'ID',\n        empresa_id                     : 'Empresa principal',\n        ciudad_id                      : 'Ciudad',\n        ejecutivo_id                   : 'Ejecutivo',\n        sector_id                      : 'Sector',\n        tamano_empresa_id              : 'Tamaño',\n        razon_social                   : 'Razón social',\n        nombre_comercial               : 'Nombre comercial',\n        documento                      : 'NIT',\n        direccion                      : 'Dirección',\n        celular                        : 'Celular',\n        telefono                       : 'Teléfono',\n        email_facturacion              : 'Correo para facturación electrónica',\n        es_persona_juridica            : 'Persona jurídica',\n        procesos_estimados_mensuales   : 'Procesos estimados mensuales',\n        pruebas_estimadas_mensuales    : 'Pruebas estimadas mensuales',\n        tipo_documento_representante_id: 'Tipo de documento del representante',\n        documento_representante        : 'Documento del representante',\n        nombre_representante           : 'Nombre del representante',\n        email_representante            : 'Correo del representante',\n        nombre_tesorero                : 'Nombre del tesorero',\n        celular_tesorero               : 'Celular del tesorero',\n        telefono_tesorero              : 'Teléfono del tesorero',\n        email_tesorero                 : 'Correo del tesorero',\n        nombre_contacto                : 'Nombre del contacto',\n        celular_contacto               : 'Celular del contacto',\n        email_contacto                 : 'Correo del contacto',\n        comentario                     : 'Comentario',\n        activo                         : 'Archivada'\n    };\n    const CAMPOS_ARCHIVOS = {\n        logo                : 'Logo',\n        rut                 : 'RUT',\n        camara_comercio     : 'Cámara de comercio',\n        cedula_representante: 'Cédula del representante'\n    };\n    destruirTablaExistente('tabla-historial-cambios');\n    destruirTablaExistente('tabla-archivos');\n\n    $(`#tabla-historial-cambios`).DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 200px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/empresas-historial-cambios/${id}`\n        },\n        columns: [\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Datos anteriores</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '350px',\n                render: (dato) => {\n                    var datos_anteriores = '';\n                    for (const LLAVE in dato.old_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && dato.old_values[LLAVE] !== null && LLAVE !== 'activo') {\n                            if (LLAVE === 'es_persona_juridica') {\n                                dato.old_values[LLAVE] = dato.old_values[LLAVE] ? 'Sí' : 'No';\n                            }\n\n                            datos_anteriores += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${dato.old_values[LLAVE]}</span>`;\n                        }\n                    }\n                    return `\n                        <div>\n                            ${datos_anteriores}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Datos nuevos</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '350px',\n                render: (dato) => {\n                    var datos_nuevos = '';\n                    for (const LLAVE in dato.new_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && dato.new_values[LLAVE] !== null && LLAVE !== 'activo') {\n                            if (LLAVE === 'es_persona_juridica') {\n                                dato.new_values[LLAVE] = dato.new_values[LLAVE] ? 'Sí' : 'No';\n                            }\n                            datos_nuevos += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${dato.new_values[LLAVE]}</span>`;\n                        }\n                    }\n                    return `\n                        <div>\n                            ${datos_nuevos}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Responsable</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '150px',\n                render: (dato) => {\n                    var responsable = `<span class=\"d-block text-body-3\">${dato.user.nombre_completo}</span>`;\n                    return responsable;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Fecha</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '130px',\n                render: (dato) => {\n                    const FECHA = obtenerFechaHora(dato.created_at);\n                    return `\n                        <span class=\"d-block text-body-3\">${FECHA.fecha}</span>\n                        <small class=\"text-label-2\">${FECHA.hora}</small>\n                    `;\n                }\n            }\n        ],\n        initComplete: function(settings) {\n            cargarDataTablas();\n        },\n    });\n\n    $(`#tabla-archivos`).DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 200px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/archivos`,\n            data: function (datos) {\n                datos.modelo = 'App\\\\Models\\\\Empresas\\\\Empresa';\n                datos.modelo_id = id;\n            },\n        },\n        columns: [\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Archivo</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: (dato) => {\n                    const DATO  = `<a href=\"/archivos-abrir/${dato.id}\" target=\"_blank\" class=\"text-body-3 text-blue-40\">${CAMPOS_ARCHIVOS[dato.nombre]}</a>`;\n                    return `\n                        <div>\n                            ${DATO}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Fecha</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '130px',\n                render: (dato) => {\n                    const FECHA = obtenerFechaHora(dato.created_at);\n                    return `\n                        <span class=\"d-block text-body-3\">${FECHA.fecha}</span>\n                        <small class=\"text-label-2\">${FECHA.hora}</small>\n                    `;\n                }\n            }\n        ],\n        initComplete: function(settings) {\n            cargarDataTablas();\n        },\n    });\n}\n\n/**\n * Función para formatear la hora\n *\n * @param {number} timestamp fecha a transformar.\n * @returns {Promise<Array>}\n * @author Jair Carvajal\n */\nfunction obtenerFechaHora(timestamp) {\n  // Crear objeto Date a partir del timestamp ISO\n  let fecha = new Date(timestamp);\n  // Extraer fecha en formato YYYY-MM-DD\n  let fechaStr = fecha.toISOString().split(\"T\")[0];\n  // Extraer hora en formato HH:MM:SS\n  let horaStr = fecha.toISOString().split(\"T\")[1].split(\".\")[0];\n\n  return {\n    fecha: fechaStr,\n    hora: horaStr\n  };\n}\n\n/**\n * Obtener historial de cambios.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getHistorialCambios(id) {\n    let datos = [];\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-historial-cambios/${id}`\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Obtener archivos.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getArchivos(id) {\n    let datos = [];\n\n    await $.ajax({\n        type: 'GET',\n        url : `/archivos`,\n        data: {\n            modelo   : 'App\\\\Models\\\\Empresas\\\\Empresa',\n            modelo_id: id\n        }\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Generar enlace de creación o actualización.\n *\n * @param {number} id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function generarEnlaceCreacion(id = null) {\n    enlace_creacion = null;\n    const URL       = ![undefined, null, ''].includes(id) ? `/generar-enlace-creacion/${id}` : `/generar-enlace-creacion`;\n\n    await $.ajax({\n        type: 'POST',\n        url : URL,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then((respuesta) => {\n        enlace_creacion = respuesta.data;\n        $('#enlace-creacion').text(enlace_creacion);\n        $('#modal-generar-enlace').modal('show');\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n/**\n * Copiar enlace de creación.\n *\n * @param {boolean} cerrar_modal Indica si se debe cerrar el modal.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction copiarEnlace(cerrar_modal = false) {\n    navigator.clipboard.writeText(enlace_creacion);\n\n    if (cerrar_modal) {\n        $('#modal-generar-enlace').modal('hide');\n    }\n}\n\n/**\n * Abrir detalle de archivado de la empresa.\n *\n * @param {number} id ID de la empresa.\n * @param {string} razon_social Razón social.\n * @param {string} comentario Comentario de archivado.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirDetalleArchivado(id, razon_social, comentario) {\n    $('#razon-social-archivado').text('');\n    $('#responsable-archivado').text('');\n    $('#fecha-archivado').text('');\n    $('#comentario-archivado').text('');\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-detalle-archivado/${id}`,\n        success: function(respuesta) {\n            const DETALLE = respuesta.data;\n            if (DETALLE != null) {\n                $('#razon-social-archivado').text(razon_social);\n                $('#responsable-archivado').text(DETALLE.user.nombre_completo);\n                $('#fecha-archivado').text(formatearFecha(DETALLE.created_at).fecha);\n                $('#comentario-archivado').text(comentario);\n            }\n            $('#modal-detalle-archivado').modal('show');\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Abrir detalle del plan de empresa.\n *\n * @param {number} id ID del plan de empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirDetallePlan(id) {\n    $('.tipo-prueba-plan').text('');\n    $('.nombre-plan').text('');\n    $('.unidades-plan').text('');\n    $('.tiempo-plan').text('');\n    $('.usuarios-plan').text('');\n    $('.ofertas-laborales-plan').text('');\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-planes/${id}`\n    }).then((respuesta) => {\n        let plan = respuesta.data;\n        $('#tipo-prueba-plan').text(plan.plan.tipo_prueba.nombre);\n        $('#nombre-plan').text(plan.plan.nombre);\n        $('#unidades-plan').text(plan.unidades);\n        $('#tiempo-plan').text(plan.vigencia_dias + ' Días');\n        $('#usuarios-plan').text(plan.plan.cantidad_usuarios);\n        $('#ofertas-laborales-plan').text(plan.cantidad_ofertas_laborales);\n        $('#nav-actual-tab').click();\n        if (plan.plan_proximo ) {\n            $('#nombre-plan-proximo').text(plan.plan_proximo.plan.nombre);\n            $('#unidades-plan-proximo').text(plan.plan_proximo.unidades);\n            $('#tiempo-plan-proximo').text(plan.plan_proximo.vigencia_dias + ' Días');\n            $('#usuarios-plan-proximo').text(plan.plan_proximo.cantidad_usuarios);\n            $('#ofertas-laborales-plan-proximo').text(plan.plan_proximo.cantidad_ofertas_laborales);\n            $('#contenedor-alert-proximo').removeClass('d-none');\n            $('#nav-tab-plan').removeClass('d-none');\n        } else {\n            $('#contenedor-alert-proximo').addClass('d-none');\n            $('#nav-tab-plan').addClass('d-none');\n        }\n        $('#modal-detalle-plan').modal('show');\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n//APARTADO PARA GESTIONAR EMPRESAS\nlet usuarios = [];\nlet empresa_seleccionada = null;\nlet configuraciones_defecto = [];\nlet configuraciones_personalizadas = [];\n\n/**\n * Obtener los datos del formulario de gestionar empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction obtenerDatosGestionarEmpresa(empresa_id) {\n\n    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n\n    usuarios = [];\n    usuarios_seleccionados = [];\n    empresa_seleccionada = null;\n    configuraciones_defecto = [];\n    configuraciones_personalizadas = [];\n\n    $('.id').val('');\n    $('.empresa_id').val('');\n    $('#usuario').val('');\n    $('.col-lg-6-empresa').addClass('col-lg-6');\n    $('#tabs-empresa').addClass('d-none');\n    if (empresa_id != '' && empresa_id != null) {\n        $.ajax({\n            type : 'GET',\n            url : `/empresas-gestionar-datos/${empresa_id}`,\n            processData: false,\n            contentType: false,\n            success: function(respuesta) {\n                let empresa = respuesta.data;\n                if (empresa.empresa_id != null) {\n                    $('#boton-crear-usuarios').prop('href', `/usuarios/create?empresa_id=${empresa.id}`);\n                    $('#boton-asignar-planes').prop('href', `/asignar-plan/${empresa.id}`);\n                    $('#filtro_empresa_id').append(`\n                        <option value=\"${empresa.empresa.id}\">${empresa.empresa.razon_social}</option>\n                    `);\n                    if ($('#filtro_empresa_id').val() == '' || $('#filtro_empresa_id').val() == null) {\n                        $('#filtro_empresa_id').val(empresa.empresa.id).trigger('change', {programmatic: true});\n                    }\n                    buscarSucursalesEmpresa(empresa.empresa.id, empresa.id);\n                    $('.id').val(empresa.id);\n                    $('.empresa_id').val(empresa.empresa.id);\n                    $('.empresa').addClass('d-none');\n                    $('.sucursal').removeClass('d-none');\n                    $('.col-lg-6-empresa').removeClass('col-lg-6');\n                    $('#ejecutivo-cuenta').text('Ejecutivo de cuenta: ' + empresa.ejecutivo.nombre_completo);\n                    $('#seccion-logo').addClass('d-none');\n                } else {\n                    $('#boton-crear-usuarios').prop('href', `/usuarios/create?empresa_id=${empresa.id}`);\n                    $('#boton-asignar-planes').prop('href', `/asignar-plan/${empresa.id}`);\n                    $('#filtro_empresa_id').append(`\n                        <option value=\"${empresa.id}\">${empresa.razon_social}</option>\n                    `);\n                    if ($('#filtro_empresa_id').val() == '' || $('#filtro_empresa_id').val() == null) {\n                        $('#filtro_empresa_id').val(empresa.id).trigger('change', {programmatic: true});\n                    }\n                    buscarSucursalesEmpresa(empresa_id);\n                    $('.id').val(empresa.id);\n                    $('.empresa').removeClass('d-none');\n                    $('.sucursal').addClass('d-none');\n                    $('#ejecutivo-cuenta').text('');\n                    $('#seccion-logo').removeClass('d-none');\n                }\n                if (empresa.es_persona_juridica == 1) {\n                    $(\"#es_persona_juridica_si\").prop('checked', true);\n                } else {\n                    $(\"#es_persona_juridica_no\").prop('checked', true);\n                }\n                $('#razon_social').val(empresa.razon_social);\n                $('#nombre_comercial').val(empresa.nombre_comercial);\n                let documento = empresa.documento.split('-');\n                $('#documento').val(documento[0]);\n                $('#digito_verificacion').val(documento[1]);\n                $('#sector_id').val(empresa.sector_id).trigger('change').trigger('select2:select');\n                $('#tamano_empresa_id').val(empresa.tamano_empresa_id).trigger('change').trigger('select2:select');\n                $('#procesos_estimados_mensuales').val(empresa.procesos_estimados_mensuales);\n                $('#pruebas_estimadas_mensuales').val(empresa.pruebas_estimadas_mensuales);\n                $('#pais_id').data('departamento_id', empresa.ciudad.departamento_id);\n                $('#pais_id').val(empresa.ciudad.departamento.pais_id).trigger('change').trigger('select2:select');\n                $('#departamento_id').data('ciudad_id', empresa.ciudad.id);\n                $('#departamento_id').val(empresa.departamento_id).trigger('change').trigger('select2:select');\n                $('#ciudad_id').val(empresa.ciudad_id).trigger('change').trigger('select2:select');\n                $('#direccion').val(empresa.direccion);\n                $('#celular').val(empresa.celular);\n\n                rellenarInputCelular(empresa.indicativo_celular, empresa.codigo_iso2_pais_celular, empresa.celular, CAMPO_CELULAR_ID, campo_celular);\n\n                $('#email_facturacion').val(empresa.email_facturacion);\n                $('#telefono').val(empresa.telefono);\n\n                actualizarEnlacesPrevisualizacionArchivos(empresa.archivos);\n\n                if (empresa.telefono_tesorero != null) {\n                    let telefono = empresa.telefono_tesorero.split('-');\n                    $('#telefono').val(telefono[0]);\n                    $('#extension').val(telefono[1]);\n                }\n\n                $('#ejecutivo_id').val(empresa.ejecutivo_id).trigger('change').trigger('select2:select');\n                $('#nombre_representante').val(empresa.nombre_representante);\n                $('#tipo_documento_representante_id').val(empresa.tipo_documento_representante_id).trigger('change').trigger('select2:select');\n                $('#documento_representante').val(empresa.documento_representante);\n                $('#email_representante').val(empresa.email_representante);\n                if (![undefined, null, ''].includes(empresa.id)) {\n                    if (empresa.empresa_id != null) {\n                        $.ajax({\n                            type: 'GET',\n                            url : `/empresas-logo/${empresa.id}`,\n                            success: function() {\n                                $('#logo_sucursal_fondo_previsualizacion').addClass('d-none');\n                                $('#logo_sucursal_previsualizacion').attr('src', `/empresas-logo/${empresa.id}`);\n                                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n                            }\n                        });\n                    } else {\n                        $.ajax({\n                            type: 'GET',\n                            url : `/empresas-logo/${empresa.id}`,\n                            success: function() {\n                                $('#logo_fondo_previsualizacion').addClass('d-none');\n                                $('#logo_previsualizacion').attr('src', `/empresas-logo/${empresa.id}`);\n                                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n                            }\n                        });\n                    }\n                }\n\n                if (empresa.usuarios.length > 0) {\n                    const USUARIO_EMPRESA = empresa.usuarios[0].usuario;\n\n                    $('#usuario_id').val(USUARIO_EMPRESA.id);\n                    $('#nombres').val(USUARIO_EMPRESA.nombres);\n                    $('#apellidos').val(USUARIO_EMPRESA.apellidos);\n                    $('#tipo_documento_id').val(USUARIO_EMPRESA.tipo_documento_id).trigger('change').trigger('select2:select');\n                    $('#documento_usuario').val(USUARIO_EMPRESA.documento);\n                    $('#email').val(USUARIO_EMPRESA.email);\n\n                    rellenarInputCelular(\n                        USUARIO_EMPRESA.indicativo_telefono,\n                        USUARIO_EMPRESA.codigo_iso2_pais_telefono,\n                        USUARIO_EMPRESA.telefono,\n                        CAMPO_CELULAR_USUARIO_ID,\n                        campo_celular_usuario\n                    );\n\n                    $('#usuario').val(JSON.stringify({\n                        id               : USUARIO_EMPRESA.id,\n                        tipo_documento_id: USUARIO_EMPRESA.tipo_documento_id,\n                        documento        : USUARIO_EMPRESA.documento,\n                        nombres          : USUARIO_EMPRESA.nombres,\n                        apellidos        : USUARIO_EMPRESA.apellidos,\n                        email            : USUARIO_EMPRESA.email,\n                        telefono         : USUARIO_EMPRESA.telefono\n                    }));\n                }\n\n                $('#nombre_tesorero').val(empresa.nombre_tesorero);\n                $('#email_tesorero').val(empresa.email_tesorero);\n\n                rellenarInputCelular(\n                    empresa.indicativo_celular_tesorero,\n                    empresa.codigo_iso2_pais_celular_tesorero,\n                    empresa.celular_tesorero,\n                    CAMPO_CELULAR_TESORERO_ID,\n                    campo_celular_tesorero\n                );\n\n                if ( empresa.telefono_tesorero != null) {\n                    let telefono_tesorero = empresa.telefono_tesorero.split('-');\n                    $('#telefono_tesorero').val(telefono_tesorero[0]);\n                    $('#extension_tesorero').val(empresa.telefono_tesorero[1]);\n                }\n                $('#nombre_contacto').val(empresa.nombre_contacto);\n                $('#email_contacto').val(empresa.email_contacto);\n\n                rellenarInputCelular(\n                    empresa.indicativo_celular_contacto,\n                    empresa.codigo_iso2_pais_celular_contacto,\n                    empresa.celular_contacto,\n                    CAMPO_CELULAR_CONTACTO_ID,\n                    campo_celular_contacto\n                );\n\n                empresa_seleccionada = empresa;\n                mostrarPlanes();\n                $('#empresa-tab').click();\n                $('#tabs-empresa').removeClass('d-none');\n                usuarios = empresa.usuarios;\n                mostrarUsuarios(empresa_id);\n                configuraciones_defecto = empresa.configuraciones_defecto;\n                configuraciones_personalizadas = empresa.configuraciones_personalizadas;\n                let archivos = empresa.archivos;\n                $('.contenedor-archivo').addClass('d-none');\n                archivos.forEach((archivo) => {\n                    $('#archivo_' + archivo.nombre).removeClass('d-none');\n                    $('#archivo_' + archivo.nombre).prop('href', '/archivos-abrir/' + archivo.id);\n                });\n\n                mostrarConfiguraciones();\n            },\n            error: function(error) {\n                console.log(error);\n            }\n        });\n    } else if ($('#filtro_empresa_id').val() != '' && $('#filtro_empresa_id').val() != null) {\n        obtenerDatosGestionarEmpresa($('#filtro_empresa_id').val());\n        $('#tabs-empresa').removeClass('d-none');\n    }\n};\n\n/**\n * Actualizar los elementos anchor de previsualización de archivos de la empresa.\n *\n * @param {array} archivos_empresa Arreglo de archivos de la empresa.\n * @param {boolean} reiniciar_campo_archivo Si se debe reiniciar el campo de archivo.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Gonzalez\n */\nfunction actualizarEnlacesPrevisualizacionArchivos(archivos_empresa, reiniciar_campo_archivo = true) {\n    // Oculta todos los elementos anchor de previsualización de archivos.\n    $('.previsualizacion-archivo').addClass('d-none');\n\n    // Muestra los elementos de previsualización de archivos que corresponden con los archivos\n    // relacionados con la empresa.\n    for (let i = 0; i < archivos_empresa.length; i++) {\n        $('#archivo_' + archivos_empresa[i].nombre).prop('href', `/archivos-abrir/${archivos_empresa[i].id}`);\n        $('#archivo_' + archivos_empresa[i].nombre).removeClass('d-none');\n\n        let input_archivo = $('#' + archivos_empresa[i].nombre + '.input-file.input-form');\n        let input_archivo_label = $('label[for=\"' + archivos_empresa[i].nombre + '\"].nombre-archivo');\n        let input_archivo_boton_eliminar = $('#boton-eliminar-archivo-' + archivos_empresa[i].nombre + '.eliminar-archivo');\n\n        if(reiniciar_campo_archivo) {\n            reiniciarCampoArchivo(input_archivo, input_archivo_label, input_archivo_boton_eliminar);\n        }\n    }\n}\n\nfunction mostrarPlanes() {\n    let empresa_id = empresa_seleccionada.id;\n    let buscar = $('#buscador-plan').val();\n    let filtro_tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        tabla_planes.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    let planes = empresa_seleccionada.planes;\n    if (planes.length > 0) {\n        for (let i = 0; i < planes.length; i++) {\n            if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n                continue;\n            }\n            if (\n                (filtro_tipo_prueba_id == 'Todos') ||\n                (filtro_tipo_prueba_id == '1' && planes[i].plan.tipo_prueba_id == 1) ||\n                (filtro_tipo_prueba_id == '2' && planes[i].plan.tipo_prueba_id == 2) ||\n                (filtro_tipo_prueba_id == '3' && planes[i].plan.tipo_prueba_id != 3)\n            ) {\n                let estado = obtenerEstadoPlan(\n                    planes[i].estado.id,\n                    planes[i].estado.nombre,\n                    planes[i].por_facturar,\n                    planes[i].renovando,\n                    null,\n                    planes[i].plan_proximo_id\n                );\n\n                let acciones = obtenerAcciones(\n                    planes[i].estado.id,\n                    planes[i].id, empresa_id,\n                    planes[i].plan.tipo_prueba_id,\n                    planes[i].plan.nombre,\n                    planes[i]?.archivos[0]?.id ?? '0',\n                    empresa_seleccionada.nombre_comercial\n                );\n\n                let modificado = '';\n                if (planes[i].plan_original == 0) {\n                    modificado = `<i class=\"bi bi-wrench me-3 text-blue-40\" ${crearTooltip({placement: 'top', content: 'Plan modificado', toggle: 'popover' })}></i>`;\n                }\n                let fecha_vencimiento = '';\n                if (planes[i].fecha_vencimiento != null) {\n                    fecha_vencimiento = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                }\n                let fecha_creacion = '';\n                if (planes[i].created_at != null) {\n                    fecha_creacion = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                }\n                let fecha_inicio = '';\n                if (planes[i].fecha_inicio != null) {\n                    fecha_inicio = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                }\n                let pruebas_plan = '';\n                if (planes[i].pruebas !== undefined) {\n                    let pruebas = planes[i].pruebas;\n                    for (let j = 0; j < pruebas.length; j++) {\n                        pruebas_plan += `\n                            <div\n                                class=\"col-auto me-3 circulo-prueba\"\n                                style=\"background-image: url(../imagenes/logos/pruebas/${slugify(planes[i].pruebas[j].nombre)}.png)\"\n                                ${crearTooltip({placement: 'top', content: planes[i].pruebas[j].nombre, toggle: 'popover' })}\n                            ></div>\n                        `;\n                    }\n                }\n                let icono = '';\n                let title = '';\n                if (planes[i].plan.tipo_prueba_id == 1) {\n                    title = 'Selección';\n                    icono = 'bi-person-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 2) {\n                    title = 'Organizacional';\n                    icono = 'bi-people-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 3) {\n                    title = 'Vocacional';\n                    icono = 'bi-mortarboard-fill';\n                }\n                let opcion_editar = `\n                    <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit'\">\n                        <i class=\"bi bi-pencil-fill\"></i>\n                    </button>\n                `;\n                if (planes[i]?.plan_proximo_id) {\n                    opcion_editar = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n                            <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                            <div class=\"dropdown-menu\">\n                                <a href=\"/empresas-planes/${planes[i].id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n                                <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n                            </div>\n                        </button>\n                    `;\n                }\n                $('#tbody-planes').append(`\n                    <tr>\n                        <td style=\"border-bottom: 0px!important;\">\n                            <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                    <div class=\"col\">\n                                        <div class=\"row align-items-center\">\n                                            <div class=\"col-auto mb-0\">\n                                                <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                    <i class=\"bi ${icono} me-3\" title=\"${title}\"></i> ${modificado} ${planes[i].plan.nombre}\n                                                </p>\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                ${estado}\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                    <i class=\"bi bi-person-fill\"></i>&nbsp;<span class=\"text-label-2\">${planes[i].cantidad_usuarios}&nbsp;${fecha_vencimiento}</span>\n                                                </p>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n                                                <div class=\"row w-100 m-0\">${pruebas_plan}</div>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n\n                                            </div>\n                                        </div>\n                                    </div>\n                                    <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                        ${opcion_editar}\n                                        ${crearBoton({\n                                            clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                            texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                            adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                        })}\n                                        ${acciones}\n                                    </div>\n                                </div>\n                                <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                    <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-briefcase\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Vacantes: ${planes[i].cantidad_ofertas_laborales !== null ? planes[i].cantidad_ofertas_laborales : ''}</span>\n                                            </p>\n                                        </div>\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-box\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Unidades: ${planes[i].unidades !== null ? planes[i].unidades : ''}</span>\n                                            </p>\n                                        </div>\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-clock\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Tiempo: ${planes[i].vigencia_dias !== null ? planes[i].vigencia_dias : ''} días</span>\n                                            </p>\n                                        </div>\n                                        ${planes[i].usuario ? `\n                                            <div class=\"col-auto\"><i class=\"bi bi-plus-circle\"></i> Creador:</div>\n                                            <div class=\"col-auto me-3 circulo-prueba\" style=\"background-image: url(/usuarios-imagen/${planes[i].usuario.id})\"\n                                                ${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `${planes[i].usuario.nombres} ${planes[i].usuario.apellidos}`,\n                                                    toggle: `popover`,\n                                                })}>\n                                            </div>\n                                            <div class=\"col\">\n                                                <div class=\"row justify-content-end\">\n                                                    <div class=\"col-auto\">\n                                                        ${fecha_creacion}\n                                                        <span class=\"fw-bold ms-3\">${fecha_inicio}</span>\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        ` : ''}\n                                    </div>\n                                    <div class=\"d-flex justify-content-end align-items-end pe-3\">\n                                        <p class=\"text-label-2 mb-0\">\n                                            <span class=\"text-gray-50 me-3\">${fecha_creacion}</span>\n                                            <span class=\"text-gray-30\">${fecha_inicio}</span>\n                                        </p>\n                                    </div>\n                                </div>\n                            </div>\n                        </td>\n                    </tr>\n                `);\n            }\n        }\n\n        // Mostrar cards de planes de créditos\n        let planes_creditos_mostrados = [];\n        for (let i = 0; i < planes.length; i++) {\n            if (planes[i].plan_credito && planes[i].plan_credito.id) {\n                // Evitar duplicados de plan_credito\n                if (!planes_creditos_mostrados.includes(planes[i].plan_credito.id)) {\n                    planes_creditos_mostrados.push(planes[i].plan_credito.id);\n\n                    let plan_credito = planes[i].plan_credito;\n                    let creditos_totales = planes[i].creditos !== null ? planes[i].creditos : 0;\n                    let creditos_restantes = planes[i].creditos_restantes !== null ? planes[i].creditos_restantes : 0;\n                    let creditos_promedio = empresa_seleccionada.creditos_promedio_accion || 0;\n                    let acciones_estimadas = creditos_restantes > 0 && creditos_promedio > 0\n                        ? Math.floor(creditos_restantes / creditos_promedio)\n                        : 0;\n\n                    let estado_credito = creditos_restantes > 0\n                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n\n                    let precio_informacion= '';\n                    if (plan_credito.precio) {\n                        precio_informacion= `$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}`;\n                        if (plan_credito.porcentaje_descuento && plan_credito.precio_con_descuento) {\n                            precio_informacion= `<span class=\"text-decoration-line-through text-gray-50\">$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}</span>\n                                          <span class=\"text-green-40 ms-2\">$${parseFloat(plan_credito.precio_con_descuento).toLocaleString('es-CO')}</span>\n                                          <span class=\"tag tag-sm tag-tonal-green ms-2\">-${plan_credito.porcentaje_descuento}%</span>`;\n                        }\n                    }\n\n                    let fecha_promocion = '';\n                    if (plan_credito.fecha_inicio_promocion && plan_credito.fecha_fin_promocion) {\n                        fecha_promocion = `Promoción: ${obtenerFecha(plan_credito.fecha_inicio_promocion)} - ${obtenerFecha(plan_credito.fecha_fin_promocion)}`;\n                    }\n\n                    let fecha_creacion_credito = '';\n                    if (planes[i].created_at != null) {\n                        fecha_creacion_credito = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                    }\n\n                    let fecha_activacion_credito = '';\n                    if (planes[i].fecha_inicio != null) {\n                        fecha_activacion_credito = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                    }\n\n                    let fecha_vencimiento_credito = '';\n                    if (planes[i].fecha_vencimiento != null) {\n                        fecha_vencimiento_credito = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                    }\n\n                    let opcion_editar_credito = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n                            <i class=\"bi bi-pencil-fill\"></i>\n                        </button>\n                    `;\n\n                    let acciones_credito = obtenerAccionesCreditos(\n                        planes[i].estado.id,\n                        planes[i].id,\n                        empresa_id,\n                        planes[i]?.archivos[0]?.id ?? '0',\n                        empresa_seleccionada.nombre_comercial,\n                        plan_credito.nombre,\n                        plan_credito.creditos,\n                        planes[i].creditos_restantes ?? null\n                    );\n\n                    $('#tbody-planes').append(`\n                        <tr>\n                            <td style=\"border-bottom: 0px!important;\">\n                                <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                    <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                        <div class=\"col\">\n                                            <div class=\"row align-items-center\">\n                                                <div class=\"col-auto mb-0\">\n                                                    <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                        <i class=\"bi bi-coin me-3\" title=\"Plan de Créditos\"></i> ${plan_credito.nombre}\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    ${estado_credito}\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-12 mt-3\">\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                            ${opcion_editar_credito}\n                                            ${crearBoton({\n                                                clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                                texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                                adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                            })}\n                                            ${acciones_credito}\n                                        </div>\n                                    </div>\n                                    <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                        <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos disponibles: ' + creditos_restantes.toLocaleString('es-CO'),\n                                            })}\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos promedio por acción: ' + creditos_promedio.toLocaleString('es-CO'),\n                                            })}\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                                            })}\n                                        </div>\n                                        <div class=\"d-flex justify-content-end align-items-end pe-3\">\n                                            <p class=\"text-label-2 mb-0\">\n                                                <span class=\"text-gray-50 me-3\">${fecha_creacion_credito}</span>\n                                                <span class=\"text-gray-30\">${fecha_activacion_credito}</span>\n                                            </p>\n                                        </div>\n                                    </div>\n                                </div>\n                            </td>\n                        </tr>\n                    `);\n                }\n            }\n        }\n\n        inicializarTooltips();\n        tabla_planes = $('#tabla-planes').DataTable({\n            \"paging\": false,\n            \"searching\": true,\n            \"ordering\": false,\n            \"info\": false\n        });\n        let buscador = $('#tabla-planes_wrapper input');\n        $(buscador).addClass('rounded-2 text-body-2');\n        $(buscador).prop('placeholder', 'Buscar');\n        $(buscador).prop('id', 'buscador-plan');\n        $('#input-busqueda').append(buscador);\n        $(buscador).val(buscar).trigger('input');\n    } else {\n        $('#fila-cabecera-tabla-planes').remove();\n        $('#tbody-planes').append(`\n            <tr class=\"w-100 d-flex justify-content-center align-items-center\" style=\"height: 480px;\">\n                <td class=\"d-flex justify-content-center align-items-center flex-column row-gap-4\">\n                    <p class=\"text-center text-gray-60 m-0\" style=\"font-size: 80px;\"><i class=\"bi bi-slash-circle m-0 p-0\"></i></p>\n                    <div class=\"m-0\">\n                        <p class=\"text-center text-body-2 text-gray-30 fs-4 mb-3\">Aún no hay planes asignados</p>\n                        <p class=\"text-center text-body-2 text-gray-30 mb-0\">Comienza ahora</p>\n                    </div>\n                    ${crearBoton({\n                        id: 'boton-asignar-plan',\n                        type: 'button',\n                        clases: 'btn-primary',\n                        texto: 'Asignar plan',\n                        url: `/asignar-plan/${empresa_id}`\n                    })}\n                </td>\n            </tr>\n        `);\n    }\n}\n\nfunction obtenerFecha(fecha) {\n    let fecha_obj = new Date(fecha);\n    let dia = ('0' + fecha_obj.getUTCDate()).slice(-2);\n    let mes = ('0' + (fecha_obj.getUTCMonth() + 1)).slice(-2);\n    let año = fecha_obj.getUTCFullYear();\n    return `${dia}/${mes}/${año}`;\n}\n\nfunction obtenerEstadoPlan(estado_id, nombre, por_facturar = 0, renovando = 0, empresa_plan_id = null, proximo = false) {\n\n    let detalle_empresa_plan = '';\n    if (empresa_plan_id != null) {\n        detalle_empresa_plan = `onclick=\"abrirDetallePlan(${empresa_plan_id})\"`;\n    }\n    let badge_proximo = '';\n    if (proximo) {\n        badge_proximo = `<span class=\"position-absolute badge badge-proximo bg-purple rounded-pill text-label-2 py-0 px-1 fw-normal\"><div class=\"text-white texto-proximo\">Próximo: </div>+1</span>`;\n    }\n    let estado = '';\n    if (por_facturar == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-por-facturar text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>Por facturar${badge_proximo}</span>`;\n    } else if (renovando == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-renovado text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>Renovando${badge_proximo}</span>`;\n    } else if (estado_id == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-activo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 2) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-inactivo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 3) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-proximo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 4) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-por-vencer text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 5) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-vencido text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    }\n\n    return estado;\n}\n\n/**\n * Obtener las acciones para la tabla de recompras.\n *\n * @param {number} estado_id Id del estado\n * @param {number} id Id del plan\n * @param {number} empresa_id Id de la empresa\n * @param {number} tipo_prueba_id Id del tipo de prueba\n * @param {string} tipo_prueba_nombre Nombre del tipo de prueba\n * @param {number} id_archivo Id del archivo\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa\n * @returns {string}\n * @author José Manuel Jimenez\n * @author Fahibram Cárcamo\n */\nfunction obtenerAcciones(estado_id, id, empresa_id, tipo_prueba_id, tipo_prueba_nombre, id_archivo, nombre_comercial_empresa) {\n\n    let acciones_html = '<ul class=\"dropdown-menu py-1\">';\n\n    if ([1, 4, 5].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\">\n            <button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"generarEnlaceCreacion(${id})\">Renovar</button>\n        </li>`;\n    }\n\n    acciones_html += `\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"window.location = '/facturar-plan/${id}'\">Facturación de recompra</button>\n        </li>\n        <li class=\"py-1\">\n            <button\n                type=\"button\"\n                class=\"dropdown-item text-body-2 text-gray-30\"\n                onclick=\"abrirHistorialRecompras(${empresa_id}, ${tipo_prueba_id}, '${tipo_prueba_nombre}', '${nombre_comercial_empresa}')\"\n            >\n                Historial de recompras\n            </button>\n        </li>\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"abrirFacturaPlan(${id_archivo})\">Ver factura</button>\n        </li>\n    `;\n\n    if ([1, 3].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-danger\" type=\"button\" onclick=\"eliminar(${id})\">Eliminar</button></li>`;\n    }\n\n    acciones_html += '</ul>';\n\n    return acciones_html;\n}\n\n/**\n * Generar acciones para planes de creditos.\n *\n * @param {number} estado_id Id del estado del plan.\n * @param {number} id Id del plan de empresa.\n * @param {number} empresa_id Id de la empresa.\n * @param {number} id_archivo Id del archivo.\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa\n * @returns {string}\n * @author Jose Manuel Jimenez\n * @author Fahibram Carcamo\n * @author Sergio Vargas\n */\nfunction obtenerAccionesCreditos(estado_id, id, empresa_id, id_archivo, nombre_comercial_empresa, nombre_plan, creditos, creditos_restantes) {\n\n    let acciones_html = '<ul class=\"dropdown-menu py-1\">';\n\n    if ([1, 4, 5].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\">\n            <button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"generarEnlaceCreacion(${id})\">Renovar</button>\n        </li>`;\n    }\n\n    acciones_html += `\n        <li class=\"py-1\">\n            <button\n                type=\"button\"\n                class=\"dropdown-item text-body-2 text-gray-30\"\n                onclick=\"abrirHistorialRecomprasCreditos(${empresa_id}, '${nombre_comercial_empresa}')\"\n            >\n                Historial de recompras\n            </button>\n        </li>\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"abrirFacturaPlan(${id_archivo})\">Ver factura</button>\n        </li>\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"abrirDetallePlanCreditos(${empresa_id}, '${nombre_plan}', ${creditos})\">Ver consumo</button>\n        </li>\n    `;\n\n    if ([1, 2, 3].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"inactivar(${id})\">Inactivar</button></li>`;\n    }\n\n    if ([1, 3].includes(estado_id) && creditos_restantes != null && creditos_restantes == creditos) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-danger\" type=\"button\" onclick=\"eliminar(${id})\">Eliminar</button></li>`;\n    }\n\n    acciones_html += '</ul>';\n\n    return acciones_html;\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    }\n}\n\nfunction abrirAcciones(elemento) {\n    $(elemento).parent().find('.acciones-lista').removeClass('d-none');\n}\n\n$(document).mouseup(function(e) {\n    var acciones = $(\".acciones-lista\");\n    if (!acciones.is(e.target) && acciones.has(e.target).length === 0) {\n        $(\".acciones-lista\").addClass('d-none');\n    }\n});\n\n/**\n * Agrega los usuarios a la tabla de usuarios.\n *\n * @param {number} empresa_id Id de la empresa o sucursal.\n * @returns {void}\n * @author Jose Jimenez\n * @author Fahibram Cárcamo\n * @author Andres Gonzalez\n */\nasync function mostrarUsuarios(empresa_id) {\n    let filtrar_usuarios = $('#filtrar-usuarios').val();\n    if ($.fn.DataTable.isDataTable('#tabla-usuarios')) {\n        tabla_usuarios.destroy();\n    }\n    $('#buscador-usuario').remove();\n    $('#tbody-usuarios').empty();\n    for (let i = 0; i < usuarios.length; i++) {\n        if (\n            usuarios[i].usuario != undefined &&\n            (\n                (filtrar_usuarios == 'Todos') ||\n                (filtrar_usuarios == '1' && usuarios[i].usuario.estado.id == 1) ||\n                (filtrar_usuarios == '2' && usuarios[i].usuario.estado.id == 2)\n            )\n        ) {\n            let estado = `\n                <div class=\"col-12 text-gray-30 text-end\">\n                    <span class=\"me-3\">Inactivo</span>\n                    <div class=\"custom-switch\">\n                        <input type=\"checkbox\" id=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-input\" onclick=\"activarOInactivarUsuarios(this.checked, ${usuarios[i].usuario.id})\">\n                        <label for=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-label\"></label>\n                    </div>\n                </div>\n            `;\n            if (usuarios[i].usuario.estado.id == 1) {\n                estado = `\n                    <div class=\"col-12 text-gray-30 text-end\">\n                        <span class=\"me-3\">Activo</span>\n                        <div class=\"custom-switch\">\n                            <input type=\"checkbox\" id=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-input\" onclick=\"activarOInactivarUsuarios(this.checked, ${usuarios[i].usuario.id})\" checked>\n                            <label for=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-label\"></label>\n                        </div>\n                    </div>\n                `;\n            }\n            let checked = '';\n            if (usuarios_seleccionados.includes(usuarios[i].usuario.id)) {\n                checked = 'checked';\n            }\n            $('#tbody-usuarios').append(`\n                <tr>\n                    <td style=\"border-bottom: 0px!important;\">\n                        <div class=\"border border-1 rounded rounded-3\">\n                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6 align-items-center\">\n                                <div class=\"col-auto\">\n                                    <div class=\"check-container my-1 me-1\">\n                                        <input type=\"checkbox\" class=\"form-check-input\" value=\"${usuarios[i].usuario.id}\" ${checked} onclick=\"seleccionarUsuario(this.value, this.checked);\">\n                                    </div>\n                                </div>\n                                <div class=\"col-auto w-120px px-0 text-center text-headline-7 text-gray-30\">\n                                    <div class=\"row justify-content-center mb-1\">\n                                        <div class=\"imagen-usuario\" style=\"background-image: url(/usuarios-imagen/${usuarios[i].usuario.id})\"></div>\n                                    </div>\n                                    ${usuarios[i]?.usuario?.ciudad?.nombre ?? ''}, ${usuarios[i]?.usuario?.ciudad?.departamento?.pais.nombre ?? ''}\n                                </div>\n                                <div class=\"col ps-lg-4\">\n                                    <div class=\"row w-100 mx-0\">\n                                        <div class=\"col-12 mb-0 text-gray-10 text-headline-5\">\n                                            ${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos} | <span class=\"text-headline-7 mb-0\">${obtenerEdad(usuarios[i].usuario.fecha_nacimiento)}</span>\n                                        </div>\n                                        <div class=\"col-12 mt-2 text-gray-50 text-headline-7\">\n                                            Rol: ${usuarios[i]?.rol?.name ?? ''} <span class=\"ms-3\">Cargo:</span> ${usuarios[i]?.usuario?.cargo?.nombre ?? ''}\n                                        </div>\n                                        <div class=\"col-12 mt-3 text-gray-30 text-headline-7\">\n                                            <i class=\"bi bi-envelope me-1\"></i> ${usuarios[i]?.usuario?.email} <i class=\"bi bi-telephone ms-4 me-1\"></i> ${usuarios[i]?.usuario?.telefono}\n                                        </div>\n                                        <div class=\"col-12 mt-1 text-gray-30 text-headline-7\">\n                                            <i class=\"bi bi-person-vcard me-1\"></i> ${usuarios[i]?.usuario?.tipo_documento?.abreviatura} ${usuarios[i]?.usuario?.documento}\n                                        </div>\n                                    </div>\n                                </div>\n                                <div class=\"col-auto\">\n                                    <div class=\"row\">\n                                        ${estado}\n                                        <input type=\"hidden\" id=\"usuario_id_${usuarios[i].usuario.id}\" value=\"${usuarios[i].usuario.eliminar}\">\n                                        <div class=\"col-12 pt-4 position-relative d-flex justify-content-end text-gray-30\">\n                                            <div class=\"acciones-lista bg-white rounded-4 py-2 position-absolute shadow d-none\" style=\"width: 260px; right: 0; z-index: 1000;\">\n                                                <div class=\"row m-0 w-100\">\n                                                    <div class=\"col-12 pointer py-3 h6 mb-0\" title=\"Generar acceso\" onclick=\"generarAccesoUsuarios(${usuarios[i].usuario.id});\">Generar acceso</div>\n                                                    <div class=\"col-12 pointer py-3 h6 mb-0\" title=\"Ver uso\" onclick=\"abrirHistorialCambiosUsuario(${usuarios[i].usuario.id}, '${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}', true)\">Historial de cambios</div>\n                                                    ${ usuarios[i].usuario.eliminar ? `<div class=\"col-12 pointer py-3 h6 mb-0 text-danger\" title=\"Eliminar\" onclick=\"abrirModalConfirmarEliminarUsuarios(${usuarios[i].usuario.id}, '${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}');\">Eliminar</div>` : '' }\n                                                </div>\n                                            </div>\n                                            <button\n                                                type=\"button\"\n                                                title=\"Editar\"\n                                                class=\"btn btn-text-primary-border text-white btn-circle\"\n                                                onclick=\"window.location.href='/usuarios/${usuarios[i].usuario.id}/edit?rol_id=${usuarios[i].rol.id}&empresa_id=${empresa_id}'\"\n                                            >\n                                                <i class=\"bi bi-pencil\"></i>\n                                            </button>\n                                            <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle ms-3\" onclick=\"abrirAcciones(this);\">\n                                                <i class=\"bi bi-three-dots-vertical\"></i>\n                                            </button>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </td>\n                </tr>\n            `);\n        }\n    }\n    tabla_usuarios = $('#tabla-usuarios').DataTable({\n        \"paging\": true,\n        \"searching\": true,\n        \"ordering\": false,\n        \"info\": true,\n        \"language\": lenguajeDatatables,\n        \"lengthMenu\": [ [10, 25, 50, 100, 200], [10, 25, 50, 100, 200] ],\n    });\n    mostrarComponenteNumeroRegistrosTabla('tabla-usuarios');\n    mostrarComponenteBuscarTabla('tabla-usuarios');\n    validarCheckUsuariosSeleccionados();\n}\n\nfunction seleccionarTodosUsuarios(checked) {\n    usuarios_seleccionados = [];\n    if (checked) {\n        for (let i = 0; i < usuarios.length; i++) {\n            usuarios_seleccionados.push(usuarios[i].usuario.id);\n        }\n    }\n    mostrarUsuarios();\n}\n\nfunction seleccionarUsuario(usuario_id, checked) {\n    if (checked) {\n        if (!usuarios_seleccionados.includes(parseInt(usuario_id))) {\n            usuarios_seleccionados.push(parseInt(usuario_id));\n        }\n    } else {\n        usuarios_seleccionados = usuarios_seleccionados.filter(id => id !== parseInt(usuario_id));\n    }\n    validarCheckUsuariosSeleccionados();\n}\n\nfunction validarCheckUsuariosSeleccionados() {\n    if (usuarios_seleccionados.length == 0) {\n        $('#check-seleccionar-todos').prop('indeterminate', false);\n        $('.botones-usuarios').prop('disabled', true);\n        $('#check-seleccionar-todos').prop('checked', false);\n    } else if (usuarios_seleccionados.length == usuarios.length) {\n        $('.botones-usuarios').prop('disabled', false);\n        $('#check-seleccionar-todos').prop('indeterminate', false);\n        $('#check-seleccionar-todos').prop('checked', true);\n    } else {\n        $('.botones-usuarios').prop('disabled', false);\n        $('#check-seleccionar-todos').prop('indeterminate', true);\n    }\n    $('#cantidad-seleccionados').text(usuarios_seleccionados.length);\n}\n\nfunction actualizarDataUsuarios() {\n    $.ajax({\n        type : 'GET',\n        url : `/empresas-gestionar-datos/${empresa_seleccionada.id}`,\n        processData: false,\n        contentType: false,\n        success: function(respuesta) {\n            let empresa = respuesta.data;\n            usuarios = empresa.usuarios;\n            mostrarUsuarios();\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Función para obtener edad actual de un usuario segun su fecha de nacimiénto\n *\n * @param {string} fecha_nacimiento\n * @return {string}\n * @author José Manuel Jiménez\n */\nfunction obtenerEdad(fecha_nacimiento) {\n    if (!fecha_nacimiento) {\n        return \"\";\n    }\n    const hoy = new Date();\n    const nacimiento = new Date(fecha_nacimiento);\n    let edad = hoy.getFullYear() - nacimiento.getFullYear();\n    const mes = hoy.getMonth() - nacimiento.getMonth();\n    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {\n        edad--;\n    }\n    return edad + \" años\";\n}\n\n/**\n * Abrir el historial de recompras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {string} tipo_prueba_id ID del tipo de prueba.\n * @param {string} tipo_prueba_nombre Nombre del tipo de prueba.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nasync function abrirHistorialRecompras(empresa_id, tipo_prueba_id, tipo_prueba_nombre, nombre_comercial_empresa) {\n    destruirTablaExistente('tabla-historial-recompras');\n    $('#nombre-tipo-prueba').text(tipo_prueba_nombre);\n    $('#tabla-historial-recompras').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: true,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 450px)',\n        scrollCollapse: true,\n        ajax: {\n            url : '/planes-historial-recompras',\n            data: function (datos) {\n                datos.empresa_id = empresa_id;\n                datos.tipo_prueba_id = tipo_prueba_id;\n            },\n            dataSrc: function (json) {\n                return Object.values(json.data);\n            }\n        },\n        columns: [\n            {\n                title: '<span class=\"text-body-3\">Plan</span>',\n                data: 'plan.nombre',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: (data, type, row) => `\n                    <div class=\"d-flex\">\n                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n                                data: [{ texto: 'id', value: row.id }],\n                            })}\n                        </div>\n                        &nbsp;&nbsp;\n                        <div class=\"col d-flex align-items-center pe-0\">\n                            ${\n                                row.plan_original == 0\n                                    ? `\n                                        <span\n                                            class=\"text-primary me-3\"\n                                            style=\"cursor: pointer\"\n                                            ${crearTooltip({ placement: 'bottom', content: 'Plan modificado', toggle: 'popover'})}\n                                        >\n                                            <i class=\"bi bi-wrench\"></i>\n                                        </span>\n                                    `\n                                    : ''\n                            }\n                            <span class=\"text-body-3\">${data}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Creación</span>',\n                data: 'created_at',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Activación</span>',\n                data: 'fecha_inicio',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Vencimiento</span>',\n                data: 'fecha_vencimiento',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Uso de unidades</span>',\n                data: 'conteo_total_consumos_agendas_empresa_sucursales',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    return `${data}/${row.unidades}`;\n                }\n            },\n            // Por el momento no se mostrará el conteo de consumos ni nada relacionado con ofertas laborales.\n            // {\n            //     title: '<span class=\"text-body-3\">Uso de ofertas</span>',\n            //     data: 'conteo_total_consumos_ofertas_laborales_empresa_sucursales',\n            //     className: 'text-body-3 text-center',\n            //     orderable: false,\n            //     searchable: true,\n            //     render: function (data, type, row) {\n            //         return `${data}/${row.cantidad_ofertas_laborales}`;\n            //     }\n            // },\n            {\n                title: '<span class=\"text-body-3\">Uso de tiempo</span>',\n                data: 'vigencia_dias',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data, type, row) {\n                    let fecha_hora_actuales = moment();\n                    let fecha_hora_inicio = moment(row.fecha_inicio);\n                    let dias_consumidos = fecha_hora_actuales.clone().diff(fecha_hora_inicio.clone(), 'days');\n\n                    if (row.fecha_vencimiento == null) {\n                        return `${dias_consumidos}/Ilimitado`;\n                    } else {\n                        let fecha_hora_vencimiento = moment(row.fecha_vencimiento);\n                        if (fecha_hora_actuales.clone().isAfter(fecha_hora_vencimiento.clone(), 'day')) return `${row.vigencia_dias}/${row.vigencia_dias}`;\n                        else return dias_consumidos > row.vigencia_dias ? `${row.vigencia_dias}/${row.vigencia_dias}` : `${dias_consumidos}/${row.vigencia_dias}`;\n                    }\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Adjunto</span>',\n                data: null,\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data) {\n                    let archivo_factura = data.archivos !== undefined && data.archivos !== null && data.archivos.length ? data.archivos[0] : null;\n\n                    if (archivo_factura === null) return '---';\n\n                    let arreglo_ruta_archivo = archivo_factura.ruta.split('/');\n                    let nombre_archivo_factura = arreglo_ruta_archivo[arreglo_ruta_archivo.length - 1];\n                    let indice_ultimo_punto = nombre_archivo_factura.lastIndexOf('.');\n\n                    if (indice_ultimo_punto === -1) return '---';\n\n                    let nombre_archivo_factura_sin_extension = nombre_archivo_factura.substring(0, indice_ultimo_punto);\n                    let extension_archivo_factura = nombre_archivo_factura.substring(indice_ultimo_punto);\n                    let nombre_archivo_factura_truncado = nombre_archivo_factura_sin_extension.substring(0, 6);\n\n                    return `${\n                        crearBoton({\n                            clases: 'btn-text-primary text-decoration-underline',\n                            onclick: `descargarFactura(${archivo_factura.id})`,\n                            texto: `${nombre_archivo_factura_truncado}...${extension_archivo_factura}`,\n                            tooltip: `${crearTooltip({placement: `bottom`,content: `${nombre_archivo_factura}`, toggle: 'popover' })}`\n                        })\n                    }`;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data, type, row) {\n                    return `${\n                        crearBoton({\n                            clases: 'btn-text-primary btn-circle',\n                            texto: '<i class=\"bi bi-eye\"></i>',\n                            onclick: `abrirModalConsumosRecompra(${row.id}, '${row.plan.nombre}', '${nombre_comercial_empresa}')`,\n                            tooltip: `${crearTooltip({placement: `bottom`,content: 'Ver consumo', toggle: 'popover' })}`\n                        })\n                    }`;\n                }\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n\n    $('#boton-descargar-historial-recompras').off('click');\n    $('#boton-descargar-historial-recompras').on(\n        'click',\n        evento => {\n            evento.preventDefault();\n            descargarExcel('planes-historial-recompras-exportar', 'historial-de-recompras', true, {empresa_id});\n        }\n    );\n\n    $('#modal-historial-recompras').modal('show');\n    ajustarRenderDataTable('tabla-historial-recompras');\n    cargarDataTablas();\n    $('#buscador-tabla-historial-recompras input.dt-input:not(:last)').remove();\n    $(\".acciones-lista\").addClass('d-none');\n}\n\n/**\n * Abrir el historial de recompras de creditos IA.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa.\n * @returns {void}\n * @author Sergio Vargas\n * @author José Manuel Jiménez\n */\nasync function abrirHistorialRecomprasCreditos(empresa_id, nombre_comercial_empresa) {\n    $('#modal-historial-recompras-creditos').modal('show');\n    $('#contenedor-tabla-historial-recompras-creditos').empty();\n    $('#contenedor-tabla-historial-recompras-creditos').append(`\n        ${crearTabla({\n            id: 'tabla-historial-recompras-creditos',\n            registros_paginas: true,\n            buscador_datatable: true,\n            class_tabla: 'mt-3',\n            buscador: {\n                icono: '<i class=\"bi bi-search input-icono1\"></i>',\n            },\n            botones: `\n                <div class=\"col-auto\">\n                    ${crearBoton({\n                        id: 'boton-descargar-historial-recompras-creditos',\n                        clases: 'btn-green-excel',\n                        texto: '<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo',\n                        onclick: `descargarExcel('planes-historial-creditos-exportar/${empresa_id}', 'historial-creditos-ia', true)`\n                    })}\n                </div>\n            `\n        })}\n    `);\n    $('#tabla-historial-recompras-creditos').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [10, 25, 50, 100],\n            [10, 25, 50, 100]\n        ],\n        scrollX: true,\n        ajax: {\n            url: `/planes-historial-recompras-creditos/${empresa_id}`,\n        },\n        columns: [\n            {\n                title: 'Plan',\n                data: null,\n                render: (row) => row.plan_credito?.nombre ?? '---'\n            },\n            {\n                title: 'Creacion',\n                data: 'created_at',\n                render: (data) => data ? obtenerFecha(data) : '---'\n            },\n            {\n                title: 'Activacion',\n                data: 'fecha_inicio',\n                render: (data) => data ? obtenerFecha(data) : '---'\n            },\n            {\n                title: 'Vencimiento',\n                data: 'fecha_vencimiento',\n                render: (data) => data ? obtenerFecha(data) : '---'\n            },\n            {\n                title: 'Creditos',\n                data: null,\n                render: (row) => {\n                    const total = row.creditos ?? row.plan_credito?.creditos ?? 0;\n                    return total.toLocaleString('es-CO');\n                }\n            },\n            {\n                title: 'Consumidos',\n                data: null,\n                render: (row) => (row.creditos_consumidos ?? 0).toLocaleString('es-CO')\n            },\n            {\n                title: 'Restantes',\n                data: null,\n                render: (row) => {\n                    const total = row.creditos ?? row.plan_credito?.creditos ?? 0;\n                    const consumidos = row.creditos_consumidos ?? 0;\n                    return Math.max(0, total - consumidos).toLocaleString('es-CO');\n                }\n            },\n            {\n                title: 'Estado',\n                data: null,\n                render: (row) => row.estado?.nombre ?? '---'\n            },\n            {\n                title: 'Valor de venta',\n                data: null,\n                render: (row) => row.precio ? `$${parseFloat(row.precio).toLocaleString('es-CO')}` : '---'\n            }\n        ]\n    });\n    cargarDataTablas();\n}\n\n/**\n * Abrir la ventana modal de consumos de un plan de empresa.\n *\n * @param {number} empresa_plan_id Id del registro de la tabla empresas_planes.\n * @param {string} nombre_plan Nombre del plan.\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalConsumosRecompra(empresa_plan_id, nombre_plan, nombre_comercial_empresa) {\n    $('#modal-historial-recompras').modal('hide');\n    abrirModalConsumosEmpresaPlan(empresa_plan_id, nombre_plan, nombre_comercial_empresa);\n}\n\n/**\n * Renderiza el contenido de las subtablas.\n *\n * @param {array} data Array de datos a renderizar.\n * @returns {string} HTML de la subtabla.\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction crearContenidoSubTabla(data) {\n    return `\n        <div class=\"d-flex flex-column row-gap-3 w-100 p-6\">\n            <div class=\"d-flex column-gap-5\">\n                <p class=\"m-0\">Costo<br>${formatearNumero(data.precio)}</p>\n                <p class=\"m-0\">Descuento<br>${data.porcentaje_descuento ?? '0'}%</p>\n                <p class=\"m-0\">\n                    Precio de venta\n                    <br>\n                    ${formatearNumero(data.porcentaje_descuento !== null ? (data.precio * (1 - parseInt(data.porcentaje_descuento)/100)) : data.precio)}\n                </p>\n            </div>\n            ${data.comentario == null ? '' : `<div class=\"d-flex flex-column\"><p class=\"m-0\">Detalle de uso<br>${data.comentario}</p></div>`}\n        </div>\n    `;\n}\n\n/**\n * Descargar documento de la factura de un plan.\n *\n * @param {number} id Id del archivo de la factura.\n * @returns {Promise<void>}\n * @author Fahibram Cárcamo\n */\nfunction descargarFactura(id) {\n    $.ajax({\n        type: 'POST',\n        url : `/empresas-planes-descargar-factura/${id}`,\n        data: { _token: $('meta[name=\"csrf-token\"]').attr('content') },\n        xhrFields: {\n            responseType: 'blob'\n        },\n        success: function (respuesta) {\n            let url = window.URL.createObjectURL(respuesta);\n            let a   = document.createElement('a');\n            a.href  = url;\n\n            a.download = `archivo_de_factura_${id}.pdf`;\n            document.body.appendChild(a);\n            a.click();\n            window.URL.revokeObjectURL(url);\n            document.body.removeChild(a);\n        }\n    }).then(() => {\n        mostrarToast('success', 'PDF generado correctamente.');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al descargar el archivo.');\n    });\n}\n\n/**\n * Inactivar plan de empresa.\n *\n * @param {number} id ID del plan de empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function inactivar(id) {\n    await $.ajax({\n        type: 'POST',\n        url : `/empresas-planes-actualizar/${id}`,\n        data: {\n            _token   : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method  : 'PATCH',\n            estado_id: 2\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', respuesta.message);\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\n/**\n * Generar acceso para usuarios.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function generarAccesoUsuarios(usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-generar-acceso`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n            ids   : usuarios_enviar // IDs de los usuarios seleccionados\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', `Acceso generado correctamente`);\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\n/**\n * Activar o inactivar usuarios.\n *\n * @param {boolean} activar Indica si se deben activar o inactivar los usuarios.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function activarOInactivarUsuarios(activar = true, usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-actualizar-multiples`,\n        data: {\n            _token   : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method  : 'PATCH',\n            ids      : usuarios_enviar, // IDs de los usuarios seleccionados\n            estado_id: activar ? 1 : 2\n        }\n    }).then((respuesta) => {\n        if (activar) {\n            mostrarToast('success', `Usuario(s) activados con éxito`);\n        } else {\n            mostrarToast('success', `Usuario(s) inactivados con éxito`);\n        }\n        actualizarDataUsuarios();\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\nusuario_id_eliminar = null;\nusuario_nombre_eliminar = '';\n\n/**\n * Función que abre el modal para confirmar la eliminación de usuarios.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction abrirModalConfirmarEliminarUsuarios(usuario_id = null, nombre_usuario = '') {\n    usuario_id_eliminar = usuario_id;\n    let detener_proceso = true;\n\n    for (let elemento of usuarios_seleccionados) {\n        let bandera_usuario = $(`#usuario_id_${elemento}`).val();\n        if (bandera_usuario === 'false' || bandera_usuario === false) {\n            detener_proceso = false;\n            break;\n        }\n    }\n\n    if (detener_proceso) {\n        usuario_nombre_eliminar = nombre_usuario;\n        if (nombre_usuario == '') {\n            nombre_usuario = 'Se van a eliminar ' + usuarios_seleccionados.length + ' usuario(s)';\n        } else {\n            nombre_usuario = 'Se eliminará el usuario ' + nombre_usuario;\n        }\n        $('#nombre-confirmar-eliminacion').text(nombre_usuario);\n        $('#modal-confirmar-eliminacion').modal('show');\n    }else{\n        mostrarToast('danger', 'No es posible eliminar el usuario o los usuarios seleccionados porque tienen relaciones con otros módulos.');\n    }\n\n}\n\n/**\n * Confirmar la eliminación de usuarios.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction confirmarEliminarUsuarios() {\n    eliminarUsuarios(usuario_id_eliminar);\n}\n\n/**\n * Eliminar usuarios.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function eliminarUsuarios(usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-eliminar-multiples`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n            ids   : usuarios_enviar\n        }\n    }).then((respuesta) => {\n        if (respuesta.message == 'Usuarios eliminados correctamente' && usuarios_enviar.length == 1 && respuesta.data == 0) {\n            mostrarToast('success', `Usuario eliminado correctamente`);\n        } else if (respuesta.message == 'Usuarios eliminados correctamente' && respuesta.data == 0) {\n            mostrarToast('success', `Usuarios eliminados correctamente`);\n        } else {\n            mostrarToast('neutral', `Algunos usuarios no fueron eliminados, puede que tengan auditorías.`);\n        }\n        usuarios_seleccionados = usuarios_seleccionados.filter(usuario => !usuarios_enviar.includes(usuario));\n        usuario_id_eliminar = null;\n        usuario_nombre_eliminar = '';\n        $('#modal-confirmar-eliminacion').modal('hide');\n        actualizarDataUsuarios();\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\nbuscar_usuario_id = null;\nbuscar_usuario_nombre = null;\n\n/**\n * Abrir el historial de cambios de un usuario.\n *\n * @param {number} id ID del usuario.\n * @param {string} nombre Nombre del usuario.\n * @param {boolean} limpiar True para limpiar los filtros de la tabla.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nasync function abrirHistorialCambiosUsuario(id, nombre, limpiar = false) {\n    if (limpiar) {\n        $('#filtro_tipo_accion').val('').trigger('change').trigger('select2:select');\n        $('#filtro_fecha_hora').val('');\n    }\n\n    buscar_usuario_id = id;\n    buscar_usuario_nombre = nombre;\n\n    const TITULOS_CAMPOS = {\n        id                                         : 'ID',\n        empresa_id                                 : 'Empresa',\n        area_id                                    : 'Área',\n        cargo_id                                   : 'Cargo',\n        tipo_documento_id                          : 'Tipo de documento',\n        genero_id                                  : 'Género',\n        ciudad_id                                  : 'Ciudad',\n        estado_id                                  : 'Estado',\n        nombres                                    : 'Nombres',\n        apellidos                                  : 'Apellidos',\n        documento                                  : 'Número de documento',\n        email                                      : 'Correo electrónico',\n        email_secundario                           : 'Correo electrónico corporativo',\n        fecha_nacimiento                           : 'Fecha de nacimiento',\n        direccion                                  : 'Dirección',\n        direccion_extra                            : 'Dirección adicional',\n        telefono                                   : 'Teléfono',\n        telefono_secundario                        : 'Teléfono corporativo',\n        profesion                                  : 'Profesión',\n        postgrado                                  : 'Postgrado',\n        numero_tarjeta_profesional                 : 'Número de tarjeta profesional',\n        numero_licencia_salud_ocupacional          : 'Número de licencia en salud ocupacional',\n        fecha_expedicion_licencia_salud_ocupacional: 'Fecha de expedición de la licencia en salud ocupacional',\n        password                                   : 'Contraseña'\n    };\n\n    destruirTablaExistente('tabla-historial-cambios-usuario');\n\n    $('#historial-usuario-nombre').text(nombre);\n\n    $('#tabla-historial-cambios-usuario').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: true,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 450px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/usuarios-historial-cambios/${id}`,\n            data: function (datos) {\n                let filtro_fecha_arreglo = $('#filtro_fecha_hora').val().split(' a ');\n                if (filtro_fecha_arreglo[0] !== undefined && filtro_fecha_arreglo[0] !== '') datos.fecha_desde = filtro_fecha_arreglo[0];\n                if (filtro_fecha_arreglo[1] !== undefined && filtro_fecha_arreglo[1] !== '') datos.fecha_hasta = filtro_fecha_arreglo[1];\n                if ($('#filtro_tipo_accion').val() !== undefined && $('#filtro_tipo_accion').val() !== '') datos.event = $('#filtro_tipo_accion').val();\n            },\n            dataSrc: function (json) {\n                let datos_historial_cambios_usuario = Object.values(json.data);\n                return datos_historial_cambios_usuario\n                    .filter(fila => {\n                        for (const LLAVE in fila.new_values) {\n                            if (TITULOS_CAMPOS[LLAVE] !== undefined && fila.new_values[LLAVE] !== null) return true;\n                        }\n                        for (const LLAVE in fila.old_values) {\n                            if (TITULOS_CAMPOS[LLAVE] !== undefined && fila.old_values[LLAVE] !== null) return true;\n                        }\n\n                        return false;\n                    });\n            }\n        },\n        columns: [\n            // Por el momento no se mostrará el contenido que se muestra debajo de cada fila del historial de cambios.\n            // {\n            //     title: '',\n            //     data: null,\n            //     className: 'text-body-3',\n            //     orderable: false,\n            //     searchable: false,\n            //     render: function (data, type, row) {\n            //         return `\n            //             <div class=\"d-flex\">\n            //                 <div class=\"col-auto ps-0 d-flex align-items-center\">\n            //                     ${crearBoton({\n            //                         clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n            //                         texto: '<i class=\"bi bi-chevron-down\"></i>',\n            //                         data: [{texto: 'id', value: row.id}],\n            //                     })}\n            //                 </div>\n            //             </div>\n            //         `;\n            //     }\n            // },\n            {\n                title: '<span class=\"text-body-3\">Dato anterior</span>',\n                data: null,\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    let datos_anteriores = '<p class=\"text-start mb-0\">';\n\n                    for (const LLAVE in row.old_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && row.old_values[LLAVE] !== null) {\n                            if (LLAVE === 'password') row.old_values[LLAVE] = 'Cambio de contraseña';\n                            datos_anteriores += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${row.old_values[LLAVE]}</span>`;\n                        }\n                    }\n\n                    datos_anteriores += '</p>';\n                    return datos_anteriores;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Dato nuevo</span>',\n                data: null,\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    let datos_nuevos = '<p class=\"text-start mb-0\">';\n\n                    for (const LLAVE in row.new_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && row.new_values[LLAVE] !== null) {\n                            if (LLAVE === 'password') row.new_values[LLAVE] = 'Cambio de contraseña';\n                            datos_nuevos += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${row.new_values[LLAVE]}</span>`;\n                        }\n                    }\n\n                    datos_nuevos += '</p>';\n                    return datos_nuevos;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Responsable</span>',\n                data: 'user.nombre_completo',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : data;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Fecha y hora</span>',\n                data: 'created_at',\n                className: 'text-body-3',\n                orderable: true,\n                searchable: true,\n                render: function (data) {\n                    return data == null\n                        ? '---'\n                        : `\n                            <p class='text-start mb-0'>\n                                <span class=\"text-body-3 text-gray-10\">${moment(data).format('YYYY-MM-DD')}</span><br>\n                                <span class=\"text-label-2 text-gray-30\">${moment(data).format('hh:mm A')}</span>\n                            </p>\n                        `;\n                }\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n\n    $('#boton-descargar-historial-cambios-usuario').off('click').on(\n        'click',\n        evento => {\n            evento.preventDefault();\n            descargarExcel(`usuarios-historial-cambios-exportar/${id}`, 'historial-de-cambios-de-usuario');\n        }\n    );\n\n    $('#modal-historial-cambios-usuario').modal('show');\n\n    ajustarRenderDataTable('tabla-historial-cambios-usuario');\n    cargarDataTablas();\n\n    $('#buscador-tabla-historial-recompras input.dt-input:not(:last)').remove();\n    $(\".acciones-lista\").addClass('d-none');\n}\n\nfunction abrirModalFiltrosAvanzados() {\n    $('#modal-historial-cambios-usuario').modal('hide');\n    $('#modal-filtros-avanzados').modal('show');\n}\n\nfunction aplicarFiltrosAvanzados() {\n    abrirHistorialCambiosUsuario(buscar_usuario_id, buscar_usuario_nombre);\n    $('#modal-filtros-avanzados').modal('hide');\n}\n\nfunction borrarFiltrosAvanzados() {\n    $('#filtro_tipo_accion').val('').trigger('change').trigger('select2:select');\n    flatpickr(\"#filtro_fecha_hora\", { mode: \"range\" }).clear();\n    $('#filtro_fecha_hora_alt').val('');\n    $('#modal-filtros-avanzados').modal('hide');\n    abrirHistorialCambiosUsuario(buscar_usuario_id, buscar_usuario_nombre);\n}\n\n/**\n * Obtener historial de cambios de un usuario.\n *\n * @param {number} id ID del usuario.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getHistorialCambiosUsuario(id) {\n    let datos = [];\n    await $.ajax({\n        type: 'GET',\n        url : `/usuarios-historial-cambios/${id}`,\n        data: {\n            event: $('#filtro_tipo_accion').val(),\n            created_at: $('#filtro_fecha_hora').val()\n        }\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n    return datos;\n}\n\n/**\n * Validar si 2 arrays son iguales\n *\n * @param {array} arr1 primer array a validar.\n * @param {array} arr2 segundo array a validar.\n * @returns {Boolean}\n * @author José Manuel Jiménez\n */\nfunction arraysIguales(arr1, arr2) {\n    if (arr1.length !== arr2.length) {\n        return false;\n    }\n    return arr1.every((element, index) => element === arr2[index]);\n}\n\n/**\n * Mostrar la información de la configuración\n *\n * @author José Manuel Jiménez\n */\nlet actualizar_configuracion = false;\nfunction mostrarConfiguraciones() {\n    actualizar_configuracion = false;\n    $('#configuracion-1').multiselect('destroy');\n    $('#configuracion-2').multiselect('destroy');\n    for (let i = 0; i < usuarios.length; i++) {\n        if (usuarios[i].usuario != undefined) {\n            $('#configuracion-1').append(`\n                <option value=\"${usuarios[i].usuario.id}\">${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}</option>\n            `);\n            $('#configuracion-2').append(`\n                <option value=\"${usuarios[i].usuario.id}\">${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}</option>\n            `);\n        }\n    }\n    $('.switch-config').prop('checked', true);\n    for (let i = 0; i < configuraciones_defecto.length; i++) {\n        if (configuraciones_defecto[i].id == 1) {\n            if (configuraciones_defecto[i].valor == 'todos' || configuraciones_defecto[i].valor == 'administradores') {\n                $('#configuracion-1').val([]);\n                $('#elegir_usuarios').val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-1').val(JSON.parse(configuraciones_defecto[i].valor));\n                $('#elegir_usuarios').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if (configuraciones_defecto[i].id == 2) {\n            if (configuraciones_defecto[i].valor == 'todos' || configuraciones_defecto[i].valor == 'administradores') {\n                $('#configuracion-2').val([]);\n                $('#elegir_actividad').val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-2').val(JSON.parse(configuraciones_defecto[i].valor));\n                $('#elegir_actividad').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if ([3, 4, 6, 7].includes(configuraciones_defecto[i].id) && (configuraciones_defecto[i].valor == '0')) {\n            $('#configuracion-' + configuraciones_defecto[i].id).prop('checked', false);\n        }\n        if (configuraciones_defecto[i].id == 5) {\n            $('#configuracion-' + configuraciones_defecto[i].id).val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n        }\n        if (configuraciones_defecto[i].id == 8) {\n            $('#configuracion-' + configuraciones_defecto[i].id).val(configuraciones_defecto[i].valor);\n        }\n    }\n    for (let i = 0; i < configuraciones_personalizadas.length; i++) {\n        if (configuraciones_personalizadas[i].configuracion_id == 1) {\n            if (configuraciones_personalizadas[i].valor == 'todos' || configuraciones_personalizadas[i].valor == 'administradores') {\n                $('#configuracion-1').val([]);\n                $('#elegir_usuarios').val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-1').val(JSON.parse(configuraciones_personalizadas[i].valor));\n                $('#elegir_usuarios').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 2) {\n            if (configuraciones_personalizadas[i].valor == 'todos' || configuraciones_personalizadas[i].valor == 'administradores') {\n                $('#configuracion-2').val([]);\n                $('#elegir_actividad').val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-2').val(JSON.parse(configuraciones_personalizadas[i].valor));\n                $('#elegir_actividad').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if ([3, 4, 6, 7].includes(configuraciones_personalizadas[i].configuracion_id) && (configuraciones_personalizadas[i].valor == '0')) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).prop('checked', false);\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 5) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 8) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).val(configuraciones_personalizadas[i].valor);\n        }\n    }\n    actualizar_configuracion = true;\n}\n\n/**\n * Función que se ejecut al al cambiar un switch\n *\n * @param {boolean} opcion dato que indica si esta o no seleccionado el switch.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction SeleccionarOpcionSwitch(opcion, configuracion_id) {\n    let dato = opcion ? 1 : 0;\n    actualizarConfiguracion(dato, configuracion_id);\n}\n\n/**\n * Función que se ejecuta al seleccionar una opción de los selects de visibilidad\n *\n * @param {boolean} opcion dato que indica el valor seleccionado en el select.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction SeleccionarOpcionVisibilidad(opcion, configuracion_id) {\n    inizializarMultiselect();\n    if (opcion == 'Elegir usuarios') {\n        $('#contenedor-elegir-usuarios-' + configuracion_id).addClass('col-3');\n        $('#contenedor-elegir-usuarios-' + configuracion_id).removeClass('col-6');\n        $('#contenedor-usuarios-' + configuracion_id).removeClass('d-none');\n    } else {\n        $('#contenedor-elegir-usuarios-' + configuracion_id).removeClass('col-3');\n        $('#contenedor-elegir-usuarios-' + configuracion_id).addClass('col-6');\n        $('#contenedor-usuarios-' + configuracion_id).addClass('d-none');\n    }\n    if (actualizar_configuracion) {\n        $('#configuracion-' + configuracion_id).val([]);\n        actualizarConfiguracion(opcion, configuracion_id);\n    }\n    $('#configuracion-' + configuracion_id).multiselect(\"refresh\");\n}\n\n/**\n * Función que se ejecuta al seleccionar alguno o varios usuarios.\n *\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction seleccionarOpcionSelect(configuracion_id) {\n    let usuarios_select = $('#configuracion-' + configuracion_id).val();\n    actualizarConfiguracion(JSON.stringify(usuarios_select.map(numero => parseInt(numero))), configuracion_id);\n}\n\n/**\n * Actualizar la configuración de la empresa.\n *\n * @param {any} valor valor a actualizar en la configuración seleccionada.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @returns {Promise<void>}\n * @author Daniel Beltrán, José Manuel Jiménez\n */\nasync function actualizarConfiguracion(valor, configuracion_id) {\n    if (actualizar_configuracion) {\n        if (configuracion_id == 1 || configuracion_id == 2) {\n            if (valor != 'todos' && valor != 'administradores') {\n                if (valor == '[]') {\n                    mostrarToast('neutral', `Selecciona al menos un usuario`);\n                    return false;\n                } else if (valor == 'Elegir usuarios') {\n                    return false;\n                }\n            }\n        }\n        await $.ajax({\n            type: 'POST',\n            url : `/configuraciones-modelos`,\n            data: {\n                _token          : $('meta[name=\"csrf-token\"]').attr('content'),\n                model_type      : 'App\\\\Models\\\\Empresas\\\\Empresa',\n                modelo_id       : empresa_seleccionada.id,\n                configuracion_id: configuracion_id,\n                valor           : valor\n            }\n        }).then((respuesta) => {\n            mostrarToast('success', respuesta.message);\n            datos = respuesta.data || [];\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n}\n\n/**\n * metodo para mostrar un tooltip segun el div que lo contenga.\n *\n * @param {div} div del elemento donde se va a mostrar el tooltip\n * @returns {void}\n * @author Sol Espitia\n */\nfunction mostrarTooltip(div) {\n    const tooltip = div.querySelector('.tooltip-bottom');\n    tooltip.style.display = 'inline';\n}\n\n/**\n * metodo para ocultar un tooltip segun el div que lo contenga.\n *\n * @param {div} div del elemento donde se va a mostrar el tooltip\n * @returns {void}\n * @author Sol Espitia\n */\nfunction ocultarTooltip(div) {\n    const tooltip = div.querySelector('.tooltip-bottom');\n    tooltip.style.display = 'none';\n}\n\n/**\n * metodo para seleccionar una empresa en los chackbox para descargar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction seleccionarCheckboxEmpresa(check, empresa_id) {\n    if (check) {\n        empresas_seleccionadas.push(parseInt(empresa_id));\n    } else {\n        empresas_seleccionadas = empresas_seleccionadas.filter(id => id !== parseInt(empresa_id));\n    }\n    if (empresas_seleccionadas.length == cantidad_empresas_listado) {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', false);\n        $('#check-seleccionar-todos-empresas').prop('checked', true);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    } else if (empresas_seleccionadas.length == 0) {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', false);\n        $('#check-seleccionar-todos-empresas').prop('checked', false);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`);\n    } else {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', true);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    }\n}\n\n/**\n * metodo para seleccionar todas las empresas en los chackbox para descargar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction seleccionarTodasEmpresas(check) {\n    empresas_seleccionadas = [];\n    if (check) {\n        for (let i = 0; i < empresas_listado.length; i++) {\n            empresas_seleccionadas.push(empresas_listado[i].id);\n            for (let j = 0; j < empresas_listado[i].sucursales.length; j++) {\n                empresas_seleccionadas.push(empresas_listado[i].sucursales[j].id);\n            }\n        }\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    } else {\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`);\n    }\n    mostrarEmpresas();\n}\n\n/**\n * metodo para descargar el excel pasandole los id de empresas seleccionados.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction descargarExcelEmpresas() {\n    if (empresas_seleccionadas.length > 0) {\n        descargarExcel('empresas-exportar', 'empresas', true, {\n            empresas_ids: empresas_seleccionadas\n        });\n    } else {\n        descargarExcel('empresas-exportar', 'empresas');\n    }\n}\n/**\n * Eliminar el logo de la empresa.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n */\nasync function eliminarLogo(id) {\n    await $.ajax({\n        type: 'POST',\n        url : `/empresas-eliminar-logo/${id}`,\n        data: {\n            _token : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method: 'DELETE'\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', respuesta.message);\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n$('#logo_recorte').on('change', evento => {\n    let archivo_logo = evento.target.files[0];\n    if (archivo_logo && archivo_logo.type.startsWith('image/')) {\n        const reader = new FileReader();\n        reader.onload = evento => {\n            let imagen = new Image();\n            imagen.onload = function() {\n                if (imagen.height > 500) {\n                    validacion_logo_mensaje = 'La imagen es demasiado grande. Intenta con dimensiones inferiores a 500px de alto.';\n                    logo_valido = false;\n                } else if (archivo_logo.size > 400_000) {\n                    validacion_logo_mensaje = 'La imagen es demasiado pesada. Intenta con un peso inferior o igual a 400KB.';\n                    logo_valido = false;\n                } else if (!['image/png', 'image/jpg', 'image/jpeg'].includes(archivo_logo.type)) {\n                    validacion_logo_mensaje = 'El formato no es válido. Carga una imagen en JPG o PNG.';\n                    logo_valido = false;\n                } else {\n                    validacion_logo_mensaje = '';\n                    logo_valido = true;\n                }\n            };\n            imagen.src = evento.target.result;\n        };\n        reader.readAsDataURL(archivo_logo);\n    } else {\n        alert('Por favor selecciona un archivo de imagen válido.');\n    }\n});\n\n/**\n * Abrir modal de detalle del plan de créditos.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {string} nombre_plan Nombre del plan de créditos.\n * @param {number} creditos Número de créditos del plan.\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirDetallePlanCreditos(empresa_id, nombre_plan, creditos) {\n    $('#modal-detalle-plan-creditos').modal('show');\n    $('#nombre-plan-creditos').text(nombre_plan);\n    $('#unidades-plan-creditos').text(numeroCleave(creditos));\n    creditos_empresa_id = empresa_id;\n}\n\n/**\n * Ver consumo de créditos en modal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction verConsumoCreditos() {\n    $('#modal-detalle-plan-creditos').modal('hide');\n    $('#modal-detalle-consumo-creditos').modal('show');\n    $('#contenedor-tabla-detalle-consumo-creditos').empty();\n    $('#contenedor-tabla-detalle-consumo-creditos').append(`\n        ${crearTabla({\n            id: 'tabla-consumo-creditos',\n            registros_paginas: true,\n            buscador_datatable: true,\n            class_tabla: 'mt-3',\n            buscador: {\n                icono: '<i class=\"bi bi-search input-icono1\"></i>',\n            },\n            filtro: crearFiltroDropdown({\n                id: 'filtro_dropdown',\n                name: 'filtro_dropdown',\n                buscador_datatable: true,\n                type: 'text',\n                value: '',\n                class: 'filtro-chips',\n                input_container_class: 'mb-0',\n                placeholder: 'Buscar',\n                icono: '<i class=\"bi bi-search input-icono1\"></i>',\n                icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n                dropdown: {\n                    titulo: 'Filtros avanzados',\n                    contenedor_botones_class: 'col-6',\n                    contenido: `\n                        <div class=\"row mt-5\">\n                            <div class=\"col-5 pt-2\">Acciones realizadas</div>\n                            <div class=\"col-7\">\n                                ${crearSelect2({\n                                    opciones: [],\n                                    opcion_vacia: false,\n                                    id: 'filtro_servicio_ia_id',\n                                    class: 'filtro',\n                                    input_container_class: 'mb-0',\n                                    data: [{\n                                        texto: 'filtro',\n                                        value: 'Estado'\n                                    }]\n                                })}\n                            </div>\n                        </div>\n                        <div class=\"row mt-5\">\n                            <div class=\"col-5 pt-2\">Usuarios</div>\n                            <div class=\"col-7\">\n                                ${crearSelect2({\n                                    opciones: [],\n                                    opcion_vacia: false,\n                                    id: 'filtro_usuario_id',\n                                    class: 'filtro',\n                                    input_container_class: 'mb-0',\n                                    data: [{\n                                        texto: 'filtro',\n                                        value: 'Prueba'\n                                    }]\n                                })}\n                            </div>\n                        </div>\n                        <div class=\"row mt-5 mb-2\">\n                            <div class=\"col-5 pt-2\">Fecha de consumo</div>\n                            <div class=\"col-7\">\n                                ${crearDatePicker({\n                                    id: 'filtro_fecha_consumo',\n                                    class: 'flatpickr-range filtro',\n                                    input_container_class: 'mb-1',\n                                    placeholder: 'Desde - hasta',\n                                    disabled: false,\n                                    icono: '<i class=\"bi bi-calendar4 input-icono2 text-gray-30 pointer\"></i>',\n                                    data: [{\n                                        texto: 'filtro',\n                                        value: 'Desde - Hasta'\n                                    }]\n                                })}\n                            </div>\n                        </div>\n                    `,\n                }\n            }),\n            botones: `\n                <div class=\"col-auto\">\n                    ${crearBoton({\n                        clases: 'btn-green-excel',\n                        texto: `<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`,\n                        onclick: `descargarExcelHistorialCreditos()`\n                    })}\n                </div>\n            `\n        })}\n    `);\n    $('#tabla-consumo-creditos').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [10, 25, 50, 100],\n            [10, 25, 50, 100]\n        ],\n        scrollX: true,\n        ajax: {\n            url: `/empresas/${creditos_empresa_id}/consumos-creditos`,\n            data: function(datos) {\n                datos.servicio_ia_id = $('#filtro_servicio_ia_id').val();\n                datos.usuario_id = $('#filtro_usuario_id').val();\n                let rango_fechas = $('#filtro_fecha_consumo').val();\n                if (rango_fechas != '') {\n                    rango_fechas = rango_fechas.split(\" a \");\n                    datos.desde = rango_fechas[0];\n                    datos.hasta = rango_fechas[1] || rango_fechas[0];\n                }\n            }\n        },\n        columns: [\n            {\n                title: 'Usuario',\n                data: null,\n                orderable: false,\n                searchable: false,\n                className: 'text-center',\n                render: function (dato) {\n                    return `${dato.usuario.nombre_completo}`;\n                },\n            },\n            {\n                title: 'Acción realizada',\n                data: 'servicio',\n                className: 'text-start',\n            },\n            {\n                title: 'Créditos',\n                data: 'creditos',\n                className: 'text-start',\n            },\n            {\n                title: 'Tokens reales',\n                data: 'tokens_reales',\n                className: 'text-start',\n            },\n            {\n                title: 'Fecha consumo',\n                data: null,\n                orderable: true,\n                className: 'text-center',\n                render: function (dato) {\n                    return `${moment(dato.fecha_consumo).format('DD-MM-YYYY hh:mm a')}`;\n                }\n            }\n        ]\n    });\n    $.ajax({\n        url: '/usuarios-listado',\n        type: 'GET',\n        data: {\n            empresa_id: creditos_empresa_id\n        },\n        success: function(respuesta) {\n            let usuarios = respuesta.data;\n            $('#filtro_usuario_id').empty().append('<option value=\"\">Todas</option>');\n            usuarios.forEach(usuario => {\n                $('#filtro_usuario_id').append(`<option value=\"${usuario.id}\">${usuario.nombre_completo}</option>`);\n            });\n        }\n    });\n    $.ajax({\n        url: '/servicios-ia',\n        type: 'GET',\n        success: function(respuesta) {\n            let servicios = respuesta.data;\n            $('#filtro_servicio_ia_id').empty().append('<option value=\"\">Todas</option>');\n            servicios.forEach(servicio => {\n                $('#filtro_servicio_ia_id').append(`<option value=\"${servicio.id}\">${servicio.nombre}</option>`);\n            });\n        }\n    });\n    cargarDataTablas();\n    inicializarFlatpickr();\n}\n\n/**\n * Función OBLIGATORIA para aplicar filtros dropdown.\n *\n * @param {string} filtro id del elemento html del filtro\n * @param {Object} filtros filtros aplicados\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction aplicarFiltrosDropdown() {\n    if ($('#modal-detalle-consumo-creditos').hasClass('show')) {\n        actualizarDatatables('tabla-consumo-creditos');\n    }\n}\n\n/**\n * Descargar Excel del historial de créditos.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction descargarExcelHistorialCreditos() {\n    let servicio_ia_id = $('#filtro_servicio_ia_id').val();\n    let usuario_id = $('#filtro_usuario_id').val();\n    let desde = null;\n    let hasta = null;\n    let rango_fechas = $('#filtro_fecha_consumo').val();\n    if (rango_fechas != '') {\n        rango_fechas = rango_fechas.split(\" a \");\n        desde = rango_fechas[0];\n        hasta = rango_fechas[1] || rango_fechas[0];\n    }\n    // Lógica para descargar excel\n}","structuredPatch":[{"oldStart":1730,"oldLines":6,"newStart":1730,"newLines":17,"lines":["                             <i class=\"bi bi-pencil-fill\"></i>","                         </button>","                     `;","+                    if (planes[i]?.plan_proximo_id) {","+                        opcion_editar_credito = `","+                            <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">","+                                <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>","+                                <div class=\"dropdown-menu\">","+                                    <a href=\"/empresas-planes/${planes[i].id}/edit?tipo=creditos\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>","+                                    <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit?tipo=creditos\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>","+                                </div>","+                            </button>","+                        `;","+                    }"," ","                     let acciones_credito = obtenerAccionesCreditos(","                         planes[i].estado.id,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"72b25b57-a670-424d-9c0a-2e30b4e8c55e"}
{"parentUuid":"0c5c2666-78e1-40fc-8fbb-53407e575179","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MUMTnkSy6u1uDDWReB3uhX","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora también debería mostrar un indicador visual de que hay un plan próximo, similar a cómo se muestra para los planes regulares con el estado \"Próximo\". Voy a revisar el código actual para ver cómo se muestra el estado y agregar la lógica para mostrar que hay un plan próximo.","signature":"EsgDCkYICxgCKkA05A3qkML5USktxWYqdZDX6z2eHyRPROz1N5ENpIkXr6dxAY7twM45Tw9orKC11k0F9hXejlTjzyWarirdMl7REgzdjKoS+9IoqNmMPhsaDDYrlwodhaL2r21v5SIwerJEwndHYHEEHZDEV2m8EHCXPnkeQLoMNCjQ3hc+gaaVSuYRNzRyGfguls1tvVtNKq8CB9n0SbREscfB/STE2ngsOqBh8MCfYNv4d2kTWXZoyJ/vLIWK6CTU34PVFVGm2ZW8u2awgTr44+A4HUsJS7UKzgH/gx6rbyfulVkZN7y0Wa2Ft7bFL8aOzZcc624VqmITdSuq3W4JBtQJyJCiZbv2ME2NtyUIe1YmN0TP/VxO2QHsrFnoPr8diqSeSwhrNKriH2TCklv/Kgy/pfPIBGVswtDocYJWrdVXR6My2Iqh0h/Y4grtsCSkZj/dPmVs5DHFY4twP5Xm+d4eiWSw9ri+7xqeEUHoRrN5xRV+drP6yt8oqENMqyTkFCAno1GktVnJwBXDSK5G5gO83TZArKQ/i58JmzcBatWHDFsw9PvLbHyx+H2YblUJN0AjIDYylSTrTPMc9272hLbvNmcUKnpcGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":858,"cache_read_input_tokens":97417,"cache_creation":{"ephemeral_5m_input_tokens":858,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGmAhb9RDfA7bG2GWgp","type":"assistant","uuid":"073515a2-ba15-4b1c-99e0-1f21bedb130a","timestamp":"2026-01-25T02:01:56.552Z"}
{"parentUuid":"073515a2-ba15-4b1c-99e0-1f21bedb130a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MUMTnkSy6u1uDDWReB3uhX","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a agregar un indicador visual para mostrar que hay un plan de créditos próximo, similar al tag \"Próximo\" que se usa en los planes regulares."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":858,"cache_read_input_tokens":97417,"cache_creation":{"ephemeral_5m_input_tokens":858,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGmAhb9RDfA7bG2GWgp","type":"assistant","uuid":"ee6759c4-87f3-4e04-b0dc-b7bd4c09c80d","timestamp":"2026-01-25T02:01:57.188Z"}
{"parentUuid":"ee6759c4-87f3-4e04-b0dc-b7bd4c09c80d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MUMTnkSy6u1uDDWReB3uhX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011NpSwhmNoopnkQkKnccDpt","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":1690,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":858,"cache_read_input_tokens":97417,"cache_creation":{"ephemeral_5m_input_tokens":858,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGmAhb9RDfA7bG2GWgp","type":"assistant","uuid":"a784f585-ddb2-471c-8f6c-fde8785b5683","timestamp":"2026-01-25T02:01:58.177Z"}
{"parentUuid":"a784f585-ddb2-471c-8f6c-fde8785b5683","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011NpSwhmNoopnkQkKnccDpt","type":"tool_result","content":"  1690→                    let acciones_estimadas = creditos_restantes > 0 && creditos_promedio > 0\n  1691→                        ? Math.floor(creditos_restantes / creditos_promedio)\n  1692→                        : 0;\n  1693→\n  1694→                    let estado_credito = creditos_restantes > 0\n  1695→                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n  1696→                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n  1697→\n  1698→                    let precio_informacion= '';\n  1699→                    if (plan_credito.precio) {\n  1700→                        precio_informacion= `$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}`;\n  1701→                        if (plan_credito.porcentaje_descuento && plan_credito.precio_con_descuento) {\n  1702→                            precio_informacion= `<span class=\"text-decoration-line-through text-gray-50\">$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}</span>\n  1703→                                          <span class=\"text-green-40 ms-2\">$${parseFloat(plan_credito.precio_con_descuento).toLocaleString('es-CO')}</span>\n  1704→                                          <span class=\"tag tag-sm tag-tonal-green ms-2\">-${plan_credito.porcentaje_descuento}%</span>`;\n  1705→                        }\n  1706→                    }\n  1707→\n  1708→                    let fecha_promocion = '';\n  1709→                    if (plan_credito.fecha_inicio_promocion && plan_credito.fecha_fin_promocion) {\n  1710→                        fecha_promocion = `Promoción: ${obtenerFecha(plan_credito.fecha_inicio_promocion)} - ${obtenerFecha(plan_credito.fecha_fin_promocion)}`;\n  1711→                    }\n  1712→\n  1713→                    let fecha_creacion_credito = '';\n  1714→                    if (planes[i].created_at != null) {\n  1715→                        fecha_creacion_credito = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n  1716→                    }\n  1717→\n  1718→                    let fecha_activacion_credito = '';\n  1719→                    if (planes[i].fecha_inicio != null) {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"be9a6dab-cf49-4d2a-9cfe-edf594c211a6","timestamp":"2026-01-25T02:01:59.145Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","content":"                    let acciones_estimadas = creditos_restantes > 0 && creditos_promedio > 0\n                        ? Math.floor(creditos_restantes / creditos_promedio)\n                        : 0;\n\n                    let estado_credito = creditos_restantes > 0\n                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n\n                    let precio_informacion= '';\n                    if (plan_credito.precio) {\n                        precio_informacion= `$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}`;\n                        if (plan_credito.porcentaje_descuento && plan_credito.precio_con_descuento) {\n                            precio_informacion= `<span class=\"text-decoration-line-through text-gray-50\">$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}</span>\n                                          <span class=\"text-green-40 ms-2\">$${parseFloat(plan_credito.precio_con_descuento).toLocaleString('es-CO')}</span>\n                                          <span class=\"tag tag-sm tag-tonal-green ms-2\">-${plan_credito.porcentaje_descuento}%</span>`;\n                        }\n                    }\n\n                    let fecha_promocion = '';\n                    if (plan_credito.fecha_inicio_promocion && plan_credito.fecha_fin_promocion) {\n                        fecha_promocion = `Promoción: ${obtenerFecha(plan_credito.fecha_inicio_promocion)} - ${obtenerFecha(plan_credito.fecha_fin_promocion)}`;\n                    }\n\n                    let fecha_creacion_credito = '';\n                    if (planes[i].created_at != null) {\n                        fecha_creacion_credito = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                    }\n\n                    let fecha_activacion_credito = '';\n                    if (planes[i].fecha_inicio != null) {","numLines":30,"startLine":1690,"totalLines":3618}},"sourceToolAssistantUUID":"a784f585-ddb2-471c-8f6c-fde8785b5683"}
{"parentUuid":"be9a6dab-cf49-4d2a-9cfe-edf594c211a6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KUF8QJByNutBD8GDjzCmhs","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Voy a agregar un tag indicando que hay un plan próximo después del estado del crédito.","signature":"EoECCkYICxgCKkDAf8PPxl6JWCvmRf7q8ucko03QxZluSASSeo5HLV5yvupvynqAS4SXrZaTiOJa9OTqQ7u4pF7W7kBJZayBFSV1EgwhdWbM9NIT9/LH/NYaDA0dZsrBCaC0MRXfuSIwB4D4fvsCEO2sBnQGTWoPMyuyh+3wvGyNoEJKTVgwELvigypHlsAGNSZS3nKH0G1AKmmtUjZit3UXxuBbxF457bE5JW4TZU2fqAliXOpM5H9xIq7VGWGkWRpEweU/0lroPOgAGh6sMGtLyW4uhsLcceLgUWo8o1pyqT8vb5zThR+l7dTW0DGOV3jmsCdRaSbv243+Tcedmr2L4uoYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1018,"cache_read_input_tokens":98275,"cache_creation":{"ephemeral_5m_input_tokens":1018,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTGmdyR7FxTd1kBbcowZ","type":"assistant","uuid":"21e682cc-36ab-48ca-b312-f7d81ec99ae6","timestamp":"2026-01-25T02:02:01.437Z"}
{"parentUuid":"21e682cc-36ab-48ca-b312-f7d81ec99ae6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KUF8QJByNutBD8GDjzCmhs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QRoSbnnioQ9gdKGGnK4Wes","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","old_string":"                    let estado_credito = creditos_restantes > 0\n                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n\n                    let precio_informacion= '';","new_string":"                    let estado_credito = creditos_restantes > 0\n                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n\n                    let indicador_proximo_credito = '';\n                    if (planes[i]?.plan_proximo_id) {\n                        indicador_proximo_credito = `<span class=\"tag tag-sm tag-tonal-purple ms-2\">Próximo disponible</span>`;\n                    }\n\n                    let precio_informacion= '';"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1018,"cache_read_input_tokens":98275,"cache_creation":{"ephemeral_5m_input_tokens":1018,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXTGmdyR7FxTd1kBbcowZ","type":"assistant","uuid":"9453ebcc-8ed9-4373-97fc-273bf4eea88d","timestamp":"2026-01-25T02:02:04.534Z"}
{"parentUuid":"9453ebcc-8ed9-4373-97fc-273bf4eea88d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QRoSbnnioQ9gdKGGnK4Wes","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js has been updated successfully."}]},"uuid":"4cc998b0-266e-4ebf-8c20-b504a43341fa","timestamp":"2026-01-25T02:02:05.765Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","oldString":"                    let estado_credito = creditos_restantes > 0\n                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n\n                    let precio_informacion= '';","newString":"                    let estado_credito = creditos_restantes > 0\n                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n\n                    let indicador_proximo_credito = '';\n                    if (planes[i]?.plan_proximo_id) {\n                        indicador_proximo_credito = `<span class=\"tag tag-sm tag-tonal-purple ms-2\">Próximo disponible</span>`;\n                    }\n\n                    let precio_informacion= '';","originalFile":"let redirige_form = 'empresas-gestionar';\nlet empresa_id      = null;\nlet enlace_creacion = null;\nlet resource_url = 'empresas';\nlet logo_valido = true;\nlet validacion_logo_mensaje = '';\nif (resource_url == undefined) {\n    redirige_form = 'empresas';\n}\nlet usuarios_seleccionados = [];\nlet empresas_seleccionadas = [];\nlet url_datatable = {\n    url: resource_url + '-listado-tabla',\n};\nlet cantidad_empresas_listado = 0;\nlet empresas_listado = [];\nempresa_id_eliminar = null;\nempresa_nombre_eliminar = '';\n\nconst CAMPO_CELULAR_ID = 'celular';\nconst CAMPO_CELULAR_CONTACTO_ID = 'celular_contacto';\nconst CAMPO_CELULAR_TESORERO_ID = 'celular_tesorero';\nconst CAMPO_CELULAR_USUARIO_ID = 'celular_usuario';\n\nlet campo_celular = null;\nlet campo_celular_contacto = null;\nlet campo_celular_tesorero = null;\nlet campo_celular_usuario = null;\n\nlet columnas_datatable = [\n    { data: 'id' },\n    { data: 'sucursales_count' },\n    { data: 'id' },\n    { data: 'nombre_comercial' },\n    { data: 'razon_social' },\n    { data: 'documento' },\n    { data: 'ejecutivo.nombre_completo' },\n    { data: 'plan_seleccion' },\n    { data: 'plan_organizacional' },\n    { data: 'plan_vocacional' },\n    { data: null, name: 'acciones', orderable: false, searchable: false }\n];\n\nlet colunmasHTML = [\n    {\n        targets: [0],\n        render: function (data) {\n            return `<div class=\"check-container my-1 me-1\">\n                        <input type=\"checkbox\" class=\"form-check-input\" value=\"${data}\" name=\"empresas_seleccionadas[]\" />\n                    </div>`;\n        }\n    },\n    {\n        targets: 1,\n        render: function (data, type, row) {\n            // Agrega botón para mostrar sucursales\n            return `<span style=\"witdh:80px;\" class=\"pointer\" onclick=\"mostrarOcultarSucursales(this, ${row.id})\">${row.sucursales_count}</span>`;\n        }\n    },\n    {\n        targets: -1,\n        render: function(data, type, row) {\n            return `\n                <div class=\"text-center text-nowrap\">\n                    <button type=\"button\" class=\"btn btn-text-primary btn-circle\" onclick=\"consultarTabla('${resource_url}', ${row.id}, 'ver')\">\n                        <i class=\"bi bi-eye\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary btn-circle\" onclick=\"consultarTabla('${resource_url}', ${row.id}, 'editar')\">\n                        <i class=\"bi bi-pencil\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalArchivar(${row.id})\">\n                        <i class=\"bi bi-archive\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirHistorialCambios(${row.id}, '${row.razon_social}')\">\n                        <i class=\"bi bi-clock\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirDetalleArchivado(${row.id}, '${row.razon_social}', '${row.comentario}')\" title=\"Detalle de archivado\">\n                        <i class=\"bi bi-list\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-danger text-white btn-circle\" onclick=\"eliminarTabla('${resource_url}', ${row.id}, 'empresa')\">\n                        <i class=\"bi bi-trash\"></i>\n                    </button>\n                </div>\n            `;\n        }\n    },\n    {\n        targets: [6, 7, 8], // Columnas de planes de empresa por tipo de prueba\n        render: function (data) {\n            if (data === null) {\n                return null;\n            }\n\n            return `<span onclick=\"abrirDetallePlan(${data?.id})\" class=\"pointer\">${data?.estado?.nombre}</span>`;\n        }\n    }\n];\n\n/**\n * Función que abre el modal para filtrar las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirModalFiltrosAvanzadosEmpresas() {\n    $('#modal-filtros-avanzados-empresas').modal('show');\n}\n\n/**\n * Función busca los planes de un tipo de prueba para el filtrado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction seleccionarTipoPruebaFiltro(tipo_prueba_id) {\n    $('#filtro_plan_id').empty();\n    if (tipo_prueba_id == '') {\n        $('#filtro_plan_id').append(`<option value=\"\">Todos</option>`);\n        $('#filtro-plan').addClass('d-none');\n    } else {\n        $.ajax({\n            type : 'GET',\n            url : `/planes-listado`,\n            data : {\n                tipo_prueba_id: tipo_prueba_id\n            },\n            success: function(respuesta) {\n                let planes = respuesta.data;\n                $('#filtro_plan_id').append(`<option value=\"\">Todos</option>`);\n                for (let i = 0; i < planes.length; i++) {\n                    $('#filtro_plan_id').append(`\n                        <option value=\"${planes[i].id}\">${planes[i].nombre}</option>\n                    `);\n                }\n            },\n            error: function(error) {\n                console.log(error);\n            }\n        });\n        $('#filtro-plan').removeClass('d-none');\n    }\n}\n\n/**\n * Función recarga las empresas con el filtro aplicado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction aplicarFiltrosAvanzadosEmpresas() {\n    mostrarEmpresas();\n    $('#modal-filtros-avanzados-empresas').modal('hide');\n}\n\n/**\n * Función que limpia los filtros aplicados en las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction borrarFiltrosAvanzadosEmpresas() {\n    $('#modal-filtros-avanzados-empresas .select2-filtro').val('').trigger('change').trigger('select2:select');\n    aplicarFiltrosAvanzadosEmpresas();\n}\n\n/**\n * Función que muestra la lista de las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarEmpresas() {\n    let estado = !archivadas;\n    let tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n    let plan_id = $('#filtro_plan_id').val();\n    let ejecutivo_id = $('#filtro_ejecutivo_id').val();\n    let rango_fechas = $('#filtro_fecha_hora').val();\n    if (rango_fechas != '') {\n        rango_fechas = rango_fechas.split(\" a \");\n    }\n    let pais_id = $('#pais_id').val();\n    let departamento_id = $('#departamento_id').val();\n    let estado_plan_id = $('#filtro_estado').val();\n    let ciudad_id = $('#ciudad_id').val();\n    inicializarTooltips()\n    $.ajax({\n        type: 'GET',\n        url: `/empresas-listado-tabla`,\n        data: {\n            'solo_principales': true,\n            'estado_plan_id': estado_plan_id,\n            'activo': estado,\n            'tipo_prueba_id': tipo_prueba_id,\n            'plan_id': plan_id,\n            'ejecutivo_id': ejecutivo_id,\n            'rango_fechas': rango_fechas,\n            'pais_id': pais_id,\n            'departamento_id': departamento_id,\n            'ciudad_id': ciudad_id\n        },\n        success: function(empresas) {\n            cantidad_empresas_listado = 0;\n            empresas_listado = empresas;\n            if ($.fn.DataTable.isDataTable('#tabla-empresas')) {\n                tabla_empresas.destroy();\n            }\n            $('#buscador-empresas').remove();\n            $('#tbody-empresas').empty();\n            for (let i = 0; i < empresas.length; i++) {\n                cantidad_empresas_listado++;\n                crearItemTabla(empresas[i]);\n                let sucursales = empresas[i].sucursales;\n                for (let j = 0; j < sucursales.length; j++) {\n                    cantidad_empresas_listado++;\n                    crearItemTabla(sucursales[j], 'sucursal', empresas[i].plan_seleccion, empresas[i].plan_organizacional, empresas[i].plan_vocacional);\n                }\n            }\n            tabla_empresas = $('#tabla-empresas').DataTable({\n                language: lenguajeDatatables,\n                deferRender: true,\n                lengthMenu: [\n                    [ 10, 25, 50, 100, 200],\n                    [ 10, 25, 50, 100, 200]\n                ],\n                columnDefs: [\n                    { targets: [0, 1], orderable: false }\n                ],\n            });\n            mostrarComponenteNumeroRegistrosTabla('tabla-empresas');\n            $('colgroup').addClass('d-none');\n            mostrarOcultarColumnas();\n            tabla_empresas.on('page order length', function () {\n                setTimeout(function() {\n                    mostrarOcultarColumnas();\n                }, 30);\n            });\n            $(`#buscador-tabla-empresas`).empty();\n            $(`#buscador-tabla-empresas`).append(`\n                <div class=\"input-container input-icon mb-3\" id=\"contenedor-buscador-tabla-empresas\">\n                    <i class=\"bi bi-search\"></i>\n                    <i class=\"bi bi-filter pointer\" style=\"right: 10px!important; left: auto!important;\" onclick=\"abrirModalFiltrosAvanzadosEmpresas();\"></i>\n                </div>\n            `);\n            var buscador_datatables = $(`#tabla-empresas_wrapper .dt-search .dt-input`).first();\n            $(buscador_datatables).addClass('rounded-2 text-body-2 input-filtro');\n            $(buscador_datatables).prop('placeholder', 'Buscar');\n            $(`#contenedor-buscador-tabla-empresas`).append(buscador_datatables);\n            $(`#tabla-empresas_wrapper .dt-layout-cell.dt-end `).first().addClass('d-none');\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Función que muestra cada item de empresa o sucursal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction crearItemTabla(item, tipo = 'empresa', plan_seleccion = null, plan_organizacional = null, plan_vocacional = null) {\n    let campo_sucursal = '';\n    if (tipo == 'empresa' && item.sucursales.length > 0) {\n        campo_sucursal = `\n            <div class=\"width-60px rounded-1 badge-estado-plan badge-estado-inactivo nowrap pointer\" onclick=\"mostrarOcultarSucursales(this, ${item.id})\">\n                ${item.sucursales_count} <i class=\"bi bi-caret-down-fill\"></i>\n            </div>\n        `;\n    }\n    let planes = '';\n    let clase = '';\n    let bg = '';\n    if (tipo == 'sucursal') {\n        clase = `empresa-${item.empresa_id} d-none`;\n        bg = 'bg-gray-90';\n        planes = `\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_seleccion?.estado?.id ?? null,\n                    plan_seleccion?.estado?.nombre ?? null,\n                    plan_seleccion?.por_facturar ?? null,\n                    plan_seleccion?.renovando ?? null,\n                    plan_seleccion?.id ?? null,\n                    plan_seleccion?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_organizacional?.estado?.id ?? null,\n                    plan_organizacional?.estado?.nombre ?? null,\n                    plan_organizacional?.por_facturar ?? null,\n                    plan_organizacional?.renovando ?? null,\n                    plan_organizacional?.id ?? null,\n                    plan_organizacional?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_vocacional?.estado?.id ?? null,\n                    plan_vocacional?.estado?.nombre ?? null,\n                    plan_vocacional?.por_facturar ?? null,\n                    plan_vocacional?.renovando ?? null,\n                    plan_vocacional?.id ?? null,\n                    plan_vocacional?.plan_proximo\n                )}\n            </td>\n        `;\n    } else {\n        planes = `\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_de_seleccion?.estado?.id ?? null,\n                    item?.plan_procesos_de_seleccion?.estado?.nombre ?? null,\n                    item?.plan_procesos_de_seleccion?.por_facturar ?? null,\n                    item?.plan_procesos_de_seleccion?.renovando ?? null,\n                    item?.plan_procesos_de_seleccion?.id ?? null,\n                    item?.plan_procesos_de_seleccion?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_organizacionales?.estado?.id ?? null,\n                    item?.plan_procesos_organizacionales?.estado?.nombre ?? null,\n                    item?.plan_procesos_organizacionales?.por_facturar ?? null,\n                    item?.plan_procesos_organizacionales?.renovando ?? null,\n                    item?.plan_procesos_organizacionales?.id ?? null,\n                    item?.plan_procesos_organizacionales?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_vocacionales?.estado?.id ?? null,\n                    item?.plan_procesos_vocacionales?.estado?.nombre ?? null,\n                    item?.plan_procesos_vocacionales?.por_facturar ?? null,\n                    item?.plan_procesos_vocacionales?.renovando ?? null,\n                    item?.plan_procesos_vocacionales?.id ?? null,\n                    item?.plan_procesos_vocacionales?.plan_proximo\n                )}\n            </td>\n        `;\n    }\n    let checked = '';\n    if (empresas_seleccionadas.includes(item.id)) {\n        checked = 'checked';\n    }\n\n    $('#tbody-empresas').append(`\n        <tr class=\"${clase} ${bg}\">\n            <td class=\"${bg}\">\n                <div class=\"check-container my-1 me-1\">\n                    <input type=\"checkbox\" class=\"form-check-input\" value=\"${item.id}\" onchange=\"seleccionarCheckboxEmpresa(this.checked, this.value);\" ${checked}/>\n                </div>\n            </td>\n            <td class=\"${bg}\">${campo_sucursal ?? ''}</td>\n            <td class=\"${bg}\">${item?.id ?? ''}</td>\n            <td class=\"${bg}\">${item?.nombre_comercial ?? ''}</td>\n            <td class=\"${bg}\">${item?.razon_social ?? ''}</td>\n            <td class=\"${bg}\">${item?.documento ?? ''}</td>\n            <td class=\"${bg}\">${item?.ejecutivo?.nombre_completo ?? ''}</td>\n            ${planes}\n            <td class=\"${bg} d-none columna-ubicacion\">${item?.ciudad?.nombre ?? ''} ${item?.ciudad?.departamento?.pais?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-numero-celular\">${item?.celular ?? ''}</td>\n            <td class=\"${bg} d-none columna-correo-facturacion\">${item?.email_facturacion ?? ''}</td>\n            <td class=\"${bg} d-none columna-fecha-creacion\">${item?.created_at ?? ''}</td>\n            <td class=\"${bg} d-none columna-progreso-creacion\">${item?.porcentaje_creacion ?? ''}</td>\n            <td class=\"${bg} d-none columna-tamano-empresa\">${item?.tamano_empresa?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-sector\">${item?.sector?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-direccion\">${item?.direccion ?? ''}</td>\n            <td class=\"${bg} d-none columna-representante\">${item?.nombre_representante ?? ''}</td>\n            <td class=\"${bg} text-center\">\n                <div class=\"col-auto px-0 dropdown\">\n                    <i class=\"bi bi-three-dots dropdown-toggle text-blue-40 pointer\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                    <div class=\"dropdown-menu\">\n                        <a href=\"/empresas-gestionar/${item.id}\" class=\"dropdown-item no-visited pointer py-2\">Gestionar empresa</a>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirHistorialCambios(${item?.id}, '${item?.razon_social}', '${item?.creado_administrador}')\">Historial de cambios</div>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirModalArchivar(${item?.id})\">Archivar</div>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"cambiarEmpresa(${item?.id});\">Cambiar a esta empresa</div>\n                        <div class=\"dropdown-item no-visited pointer py-2 text-danger\" onclick=\"abrirModalConfirmarEliminarEmpresas('${item?.id}', '${item?.razon_social}')\">Eliminar</div>\n                    </div>\n                </div>\n            </td>\n        </tr>\n    `);\n}\n\n/**\n * Función que muestra u oculta las sucursales de una empresa.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarOcultarSucursales(elemento, empresa_id_padre) {\n    if ($(elemento).find('.bi-caret-down-fill').first().length > 0) {\n        $('.empresa-' + empresa_id_padre).removeClass('d-none');\n        $(elemento).find('.bi-caret-down-fill').first().removeClass('bi-caret-down-fill').addClass('bi-caret-up-fill');\n    } else {\n        $('.empresa-' + empresa_id_padre).addClass('d-none');\n        $(elemento).find('.bi-caret-up-fill').first().removeClass('bi-caret-up-fill').addClass('bi-caret-down-fill');\n    }\n}\n\n/**\n * Función que evalua que columnasn adicionales hay que mostrar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarOcultarColumnas() {\n    let columnas = $('.filtro-columna');\n    for (let i = 0; i < columnas.length; i++) {\n        let valor = $(columnas[i]).val();\n        let checked = $(columnas[i]).prop('checked');\n        if (checked) {\n            $('.' + valor).removeClass('d-none');\n        } else {\n            $('.' + valor).addClass('d-none');\n        }\n    }\n}\n\n/**\n * Función que abre el modal para confirmar la eliminación de empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirModalConfirmarEliminarEmpresas(empresa_id = null, nombre_empresa = '') {\n    empresa_id_eliminar = empresa_id;\n    nombre_empresa = 'Eliminar ' + nombre_empresa;\n    $('#nombre-confirmar-eliminacion').text(nombre_empresa);\n    $('#modal-confirmar-eliminacion').modal('show');\n}\n\n/**\n * Confirmar la eliminación de empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction confirmarEliminarEmpresas() {\n    eliminarEmpresas(empresa_id_eliminar);\n}\n\n/**\n * Eliminar empresas.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function eliminarEmpresas(empresa_id = null) {\n    await $.ajax({\n        type: 'DELETE',\n        url : `/empresas/${empresa_id}`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n        }\n    }).then((respuesta) => {\n        empresa_id_eliminar = null;\n        empresa_nombre_eliminar = '';\n        if (respuesta.tipo != undefined && respuesta.tipo == 'success') {\n            mostrarToast('success', respuesta.mensaje);\n            mostrarEmpresas();\n        } else if (respuesta.errors != undefined) {\n            mostrarToast('danger', respuesta.message);\n        }\n        $('#modal-confirmar-eliminacion').modal('hide');\n    }).catch((error) => {\n        mostrarToast('danger', error.responseJSON.errors);\n        empresa_id_eliminar = null;\n        empresa_nombre_eliminar = '';\n        $('#modal-confirmar-eliminacion').modal('hide');\n    });\n}\n\n$(document).ready(function () {\n    if (typeof opcion_form !== 'undefined' && opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;\n        $(\"#digito_verificacion\").val(numero)\n    }\n\n    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n\n    inicializarSelect2Asincrono('filtro_empresa_id', 'empresas-listado', 'razon_social', { id: 'id', nombre: 'razon_social' }, false, { solo_principales: true });\n\n    configurarFormulario('formulario-archivos');\n    configurarFormulario('formulario-contactos');\n\n    if ($('#pais_id').val() != '') {\n        $('#pais_id').trigger('change');\n    }\n    if ($('#empresa_id').val() != '') {\n        $('#empresa_id').trigger('change');\n    }\n    if ($('#filtro_empresa_id').val() != '') {\n        $('#filtro_empresa_id').trigger('change').trigger('select2:select');\n    }\n    let empresa_id = $('#formulario #id').val();\n    if (![undefined, null, ''].includes(empresa_id)) {\n        $.ajax({\n            type: 'GET',\n            url : `/empresas-logo/${empresa_id}`,\n            success: function() {\n                $('#logo_fondo_previsualizacion').addClass('d-none');\n                $('#logo_previsualizacion').attr('src', `/empresas-logo/${empresa_id}`);\n                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n            }\n        });\n    }\n    $(\"#modal-filtros-avanzados\").on(\"hidden.bs.modal\", function () {\n        $('#modal-historial-cambios-usuario').modal('show');\n    });\n    inicializarTooltips();\n});\n\nfunction postSuccess(respuesta) {\n    if (respuesta.formulario == 'formulario') {\n        if (respuesta.data.empresa_id == null) {\n            if (vista == 'crear-editar') {\n                mostrarToast('success', `La empresa se ${respuesta.accion_realizada} con éxito`);\n                $('#empresa-tab').html(`<i class=\"bi bi-check\"></i>`);\n                $('#documentos-tab').prop('disabled', false);\n                $('#documentos-tab').click();\n            } else if (vista == 'gestionar') {\n                mostrarToast('success', `La empresa se ${respuesta.accion_realizada} con éxito`);\n            }\n        } else {\n            if (vista == 'crear-editar') {\n                if (opcion_form === 'Editar') {\n                    localStorage.setItem('notificacionToast', JSON.stringify({\n                        tipo_alerta: 'success',\n                        texto_1: `La sucursal se ${respuesta.accion_realizada} con éxito`,\n                    }));\n                } else {\n                    localStorage.setItem('notificacionToast', JSON.stringify({\n                        sucursal_creada: true,\n                        id_sucursal: respuesta.data.id,\n                        nombre_comercial_sucursal: respuesta.data.nombre_comercial\n                    }));\n                }\n                if (tipo_rol_activo_usuario === 'empresa') {\n                    window.location.href = '/sucursales';\n                } else if (tipo_rol_activo_usuario === 'superadmin') {\n                    window.location.href = '/empresas';\n                }\n            } else if (vista == 'gestionar') {\n                mostrarToast('success', `La sucursal se ${respuesta.accion_realizada} con éxito`);\n            }\n        }\n    } else if (respuesta.formulario == 'formulario-archivos') {\n        if (Array.isArray(respuesta.data) && respuesta.data.length > 0) actualizarEnlacesPrevisualizacionArchivos(respuesta.data, false);\n        mostrarToast('success', `Los documentos se ${respuesta.accion_realizada} con éxito`);\n        $('#documentos-tab').html(`<i class=\"bi bi-check\"></i>`);\n        $('#contactos-tab').prop('disabled', false);\n        $('#contactos-tab').click();\n    } else if (respuesta.formulario == 'formulario-contactos') {\n        mostrarToast('success', `La información de contacto se ${respuesta.accion_realizada} con éxito`);\n        $('#contactos-tab').html(`<i class=\"bi bi-check\"></i>`);\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `La empresa se ${respuesta.accion_realizada} con éxito`,\n        }));\n        window.location.href='/empresas';\n    }\n    if (typeof respuesta.data !== 'undefined' && typeof es_sucursal !== 'undefined'){\n        if (es_sucursal == false) {\n            if (typeof respuesta.data.id !== 'undefined') {\n                $('.id').val(respuesta.data.id);\n            }\n        }\n    }\n}\n\n/**\n * Validar datos antes de enviar el formulario.\n *\n * @returns {boolean}\n * @author Daniel Beltrán\n * @author Jair Carvajal\n */\nfunction validacionAdicional() {\n    if (campo_celular !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular, CAMPO_CELULAR_ID);\n    }\n    if (campo_celular_contacto !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_contacto, CAMPO_CELULAR_CONTACTO_ID);\n    }\n    if (campo_celular_tesorero !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_tesorero, CAMPO_CELULAR_TESORERO_ID);\n    }\n    if (campo_celular_usuario !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_usuario, CAMPO_CELULAR_USUARIO_ID);\n    }\n\n    if ($('#usuario').length) {\n        $('#usuario').val('');\n        let usuario_id = $('#usuario_id').val();\n        if (usuario_id.length == 0) {\n            usuario_id = null;\n        }\n        let usuario = {\n            id                       : usuario_id,\n            tipo_documento_id        : $('#tipo_documento_id').val(),\n            documento                : $('#documento_usuario').val(),\n            nombres                  : $('#nombres').val(),\n            apellidos                : $('#apellidos').val(),\n            email                    : $('#email').val(),\n            codigo_iso2_pais_telefono: $(`#codigo_iso2_pais_${CAMPO_CELULAR_USUARIO_ID}`).val(),\n            indicativo_telefono      : $(`#indicativo_${CAMPO_CELULAR_USUARIO_ID}`).val(),\n            telefono                 : $(`#${CAMPO_CELULAR_USUARIO_ID}`).val()\n        };\n\n        $('#usuario').val(JSON.stringify(usuario));\n    }\n\n    if (!logo_valido) {\n        mostrarToast('danger', validacion_logo_mensaje);\n        return false;\n    }\n\n    return true;\n}\n\nfunction seleccionarEmpresa(empresa_id) {\n    $('.campo-sucursal').addClass('d-none');\n\n    if (empresas_principales.length) {\n        let ejecutivo = empresas_principales.filter(empresa_principal => empresa_principal.id === parseInt(empresa_id))[0].ejecutivo;\n        $('#ejecutivo-cuenta').text('Ejecutivo de cuenta: ' + ejecutivo?.nombre_completo);\n        let campo_ejecutivo_id = $('input[type=\"hidden\"]#ejecutivo_id');\n        if (campo_ejecutivo_id) {\n            campo_ejecutivo_id.val(ejecutivo?.id);\n        }\n    }\n\n    $('#empresa_id').val('');\n    if (empresa_id.length > 0) {\n        $('#empresa_id').val(empresa_id);\n        $('.campo-sucursal').removeClass('d-none');\n    }\n}\n\nfunction cambiarLogoSucursal() {\n    $('#cambiar-logo').addClass('d-none');\n    $('.campo-imagen-sucursal').removeClass('d-none');\n}\n\nfunction validarLineasTabs() {\n    let pasos = $('.nav-pasos:not(:disabled)').length;\n    for (let i = 0; i < (pasos - 1); i++) {\n        $($('.hr-tab')[i]).addClass('border-blue-40 opacity-100');\n    }\n}\n\n/**\n * Obtener los departamentos según el país seleccionado.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\n$(document).on('change', '#pais_id', function() {\n    const pais_id = $(this).val();\n    $('#departamento_id').empty();\n    $('#ciudad_id').empty();\n    if (pais_id != null && pais_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/departamentos-listado`,\n            data: {\n                pais_id: pais_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n            $('#departamento_id').append(`<option></option>`);\n            datos.forEach((item) => {\n                $('#departamento_id').append(new Option(item.nombre, item.id));\n            });\n            if ($(this).data('departamento_id') != '') {\n                $('#departamento_id').val($(this).data('departamento_id')).trigger('change');\n            }\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n});\n\n/**\n * Obtener las ciudades según el departamento seleccionado.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\n$(document).on('change', '#departamento_id', function() {\n    const departamento_id = $(this).val();\n    $('#ciudad_id').empty();\n    if (departamento_id != null && departamento_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/ciudades-listado`,\n            data: {\n                departamento_id: departamento_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n            $('#ciudad_id').append(`<option></option>`);\n            datos.forEach((item) => {\n                $('#ciudad_id').append(new Option(item.nombre, item.id));\n            });\n            if ($(this).data('ciudad_id') != '') {\n                $('#ciudad_id').val($(this).data('ciudad_id')).trigger('change');\n            }\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n});\n\n/**\n * Obtener las sucursales de la empresa seleccionada.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction buscarSucursalesEmpresa(empresa_id, sucursal_id = null) {\n    $('#filtro_sucursal_id').empty();\n    $('#filtro_sucursal_id').append(`<option value=\"\"></option>`);\n    if (empresa_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/empresas-listado`,\n            data: {\n                empresa_id: empresa_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n\n            datos.forEach((item) => {\n                let selected = '';\n                if (sucursal_id == item.id) {\n                    selected = 'selected';\n                }\n                $('#filtro_sucursal_id').append(`\n                    <option value=\"${item.id}\" ${selected}>${item.nombre_comercial}</option>\n                `);\n            });\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n}\n\n/**\n * Obtener los planes de la empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {Object} parametros Parámetros para filtrar los planes.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function getPlanesEmpresa(empresa_id, parametros = {}) {\n    $.ajax({\n        type: 'GET',\n        url : `/empresas-planes-listado/${empresa_id}`,\n        data: parametros\n    }).then((response) => {\n        const datos = response.data;\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n/**\n * Abrir el modal para archivar o desarchivar empresa.\n *\n * @param {number} id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction abrirModalArchivar(id) {\n    $('#modal-archivar').modal('show');\n    $('#empresa-archivar-id').val(null);\n    $('#empresa-archivar-id').val(id);\n}\n\n/**\n * Archivar o desarchivar empresa.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction archivar() {\n    const formulario = $('#formulario-archivar');\n\n    formulario.validate({\n        ignore: [] // No ignorar campos ocultos\n    });\n\n    const datos = new FormData(formulario[0]);\n    datos.append('_token', $('meta[name=\"csrf-token\"]').attr('content'));\n    datos.append('activo', archivadas);\n    datos.delete('id');\n\n    const id = $('#empresa-archivar-id').val();\n\n    if (formulario.valid()) {\n        $.ajax({\n            type       : 'POST',\n            url        : `/empresas-archivar/${id}`,\n            data       : datos,\n            processData: false,\n            contentType: false\n        }).then((respuesta) => {\n            mostrarToast('success', respuesta.mensaje);\n            $('#modal-archivar').modal('hide');\n            formulario[0].reset();\n            mostrarEmpresas();\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n};\n\n/**\n * Abrir el historial de cambios.\n *\n * @param {number} id ID de la empresa.\n * @param {string} razon_social Razón social de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirHistorialCambios(id, razon_social, creado_administrador = 0) {\n\n    $(document).on('shown.bs.tab', 'a.nav-item-horizontal', function () {\n        let id_tab = $(this).attr('id');\n        $('#descargar-historial').removeClass('d-none');\n        if (id_tab == 'archivos') {\n            $('#descargar-historial').addClass('d-none');\n        }\n    });\n\n    $('#modal-historial-cambios').modal('show');\n    $('#descargar-historial').attr('onclick', `descargarExcel('empresas-historial-cambios-exportar/${id}', 'historial-cambios')`);\n    $('#historial-razon-social').text(razon_social);\n    if (creado_administrador == 1) {\n        $('#forma-creacion').text('Manualmente');\n    } else {\n        $('#forma-creacion').text('Automático');\n    }\n    const TITULOS_CAMPOS = {\n        id                             : 'ID',\n        empresa_id                     : 'Empresa principal',\n        ciudad_id                      : 'Ciudad',\n        ejecutivo_id                   : 'Ejecutivo',\n        sector_id                      : 'Sector',\n        tamano_empresa_id              : 'Tamaño',\n        razon_social                   : 'Razón social',\n        nombre_comercial               : 'Nombre comercial',\n        documento                      : 'NIT',\n        direccion                      : 'Dirección',\n        celular                        : 'Celular',\n        telefono                       : 'Teléfono',\n        email_facturacion              : 'Correo para facturación electrónica',\n        es_persona_juridica            : 'Persona jurídica',\n        procesos_estimados_mensuales   : 'Procesos estimados mensuales',\n        pruebas_estimadas_mensuales    : 'Pruebas estimadas mensuales',\n        tipo_documento_representante_id: 'Tipo de documento del representante',\n        documento_representante        : 'Documento del representante',\n        nombre_representante           : 'Nombre del representante',\n        email_representante            : 'Correo del representante',\n        nombre_tesorero                : 'Nombre del tesorero',\n        celular_tesorero               : 'Celular del tesorero',\n        telefono_tesorero              : 'Teléfono del tesorero',\n        email_tesorero                 : 'Correo del tesorero',\n        nombre_contacto                : 'Nombre del contacto',\n        celular_contacto               : 'Celular del contacto',\n        email_contacto                 : 'Correo del contacto',\n        comentario                     : 'Comentario',\n        activo                         : 'Archivada'\n    };\n    const CAMPOS_ARCHIVOS = {\n        logo                : 'Logo',\n        rut                 : 'RUT',\n        camara_comercio     : 'Cámara de comercio',\n        cedula_representante: 'Cédula del representante'\n    };\n    destruirTablaExistente('tabla-historial-cambios');\n    destruirTablaExistente('tabla-archivos');\n\n    $(`#tabla-historial-cambios`).DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 200px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/empresas-historial-cambios/${id}`\n        },\n        columns: [\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Datos anteriores</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '350px',\n                render: (dato) => {\n                    var datos_anteriores = '';\n                    for (const LLAVE in dato.old_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && dato.old_values[LLAVE] !== null && LLAVE !== 'activo') {\n                            if (LLAVE === 'es_persona_juridica') {\n                                dato.old_values[LLAVE] = dato.old_values[LLAVE] ? 'Sí' : 'No';\n                            }\n\n                            datos_anteriores += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${dato.old_values[LLAVE]}</span>`;\n                        }\n                    }\n                    return `\n                        <div>\n                            ${datos_anteriores}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Datos nuevos</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '350px',\n                render: (dato) => {\n                    var datos_nuevos = '';\n                    for (const LLAVE in dato.new_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && dato.new_values[LLAVE] !== null && LLAVE !== 'activo') {\n                            if (LLAVE === 'es_persona_juridica') {\n                                dato.new_values[LLAVE] = dato.new_values[LLAVE] ? 'Sí' : 'No';\n                            }\n                            datos_nuevos += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${dato.new_values[LLAVE]}</span>`;\n                        }\n                    }\n                    return `\n                        <div>\n                            ${datos_nuevos}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Responsable</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '150px',\n                render: (dato) => {\n                    var responsable = `<span class=\"d-block text-body-3\">${dato.user.nombre_completo}</span>`;\n                    return responsable;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Fecha</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '130px',\n                render: (dato) => {\n                    const FECHA = obtenerFechaHora(dato.created_at);\n                    return `\n                        <span class=\"d-block text-body-3\">${FECHA.fecha}</span>\n                        <small class=\"text-label-2\">${FECHA.hora}</small>\n                    `;\n                }\n            }\n        ],\n        initComplete: function(settings) {\n            cargarDataTablas();\n        },\n    });\n\n    $(`#tabla-archivos`).DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 200px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/archivos`,\n            data: function (datos) {\n                datos.modelo = 'App\\\\Models\\\\Empresas\\\\Empresa';\n                datos.modelo_id = id;\n            },\n        },\n        columns: [\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Archivo</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: (dato) => {\n                    const DATO  = `<a href=\"/archivos-abrir/${dato.id}\" target=\"_blank\" class=\"text-body-3 text-blue-40\">${CAMPOS_ARCHIVOS[dato.nombre]}</a>`;\n                    return `\n                        <div>\n                            ${DATO}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Fecha</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '130px',\n                render: (dato) => {\n                    const FECHA = obtenerFechaHora(dato.created_at);\n                    return `\n                        <span class=\"d-block text-body-3\">${FECHA.fecha}</span>\n                        <small class=\"text-label-2\">${FECHA.hora}</small>\n                    `;\n                }\n            }\n        ],\n        initComplete: function(settings) {\n            cargarDataTablas();\n        },\n    });\n}\n\n/**\n * Función para formatear la hora\n *\n * @param {number} timestamp fecha a transformar.\n * @returns {Promise<Array>}\n * @author Jair Carvajal\n */\nfunction obtenerFechaHora(timestamp) {\n  // Crear objeto Date a partir del timestamp ISO\n  let fecha = new Date(timestamp);\n  // Extraer fecha en formato YYYY-MM-DD\n  let fechaStr = fecha.toISOString().split(\"T\")[0];\n  // Extraer hora en formato HH:MM:SS\n  let horaStr = fecha.toISOString().split(\"T\")[1].split(\".\")[0];\n\n  return {\n    fecha: fechaStr,\n    hora: horaStr\n  };\n}\n\n/**\n * Obtener historial de cambios.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getHistorialCambios(id) {\n    let datos = [];\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-historial-cambios/${id}`\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Obtener archivos.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getArchivos(id) {\n    let datos = [];\n\n    await $.ajax({\n        type: 'GET',\n        url : `/archivos`,\n        data: {\n            modelo   : 'App\\\\Models\\\\Empresas\\\\Empresa',\n            modelo_id: id\n        }\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Generar enlace de creación o actualización.\n *\n * @param {number} id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function generarEnlaceCreacion(id = null) {\n    enlace_creacion = null;\n    const URL       = ![undefined, null, ''].includes(id) ? `/generar-enlace-creacion/${id}` : `/generar-enlace-creacion`;\n\n    await $.ajax({\n        type: 'POST',\n        url : URL,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then((respuesta) => {\n        enlace_creacion = respuesta.data;\n        $('#enlace-creacion').text(enlace_creacion);\n        $('#modal-generar-enlace').modal('show');\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n/**\n * Copiar enlace de creación.\n *\n * @param {boolean} cerrar_modal Indica si se debe cerrar el modal.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction copiarEnlace(cerrar_modal = false) {\n    navigator.clipboard.writeText(enlace_creacion);\n\n    if (cerrar_modal) {\n        $('#modal-generar-enlace').modal('hide');\n    }\n}\n\n/**\n * Abrir detalle de archivado de la empresa.\n *\n * @param {number} id ID de la empresa.\n * @param {string} razon_social Razón social.\n * @param {string} comentario Comentario de archivado.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirDetalleArchivado(id, razon_social, comentario) {\n    $('#razon-social-archivado').text('');\n    $('#responsable-archivado').text('');\n    $('#fecha-archivado').text('');\n    $('#comentario-archivado').text('');\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-detalle-archivado/${id}`,\n        success: function(respuesta) {\n            const DETALLE = respuesta.data;\n            if (DETALLE != null) {\n                $('#razon-social-archivado').text(razon_social);\n                $('#responsable-archivado').text(DETALLE.user.nombre_completo);\n                $('#fecha-archivado').text(formatearFecha(DETALLE.created_at).fecha);\n                $('#comentario-archivado').text(comentario);\n            }\n            $('#modal-detalle-archivado').modal('show');\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Abrir detalle del plan de empresa.\n *\n * @param {number} id ID del plan de empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirDetallePlan(id) {\n    $('.tipo-prueba-plan').text('');\n    $('.nombre-plan').text('');\n    $('.unidades-plan').text('');\n    $('.tiempo-plan').text('');\n    $('.usuarios-plan').text('');\n    $('.ofertas-laborales-plan').text('');\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-planes/${id}`\n    }).then((respuesta) => {\n        let plan = respuesta.data;\n        $('#tipo-prueba-plan').text(plan.plan.tipo_prueba.nombre);\n        $('#nombre-plan').text(plan.plan.nombre);\n        $('#unidades-plan').text(plan.unidades);\n        $('#tiempo-plan').text(plan.vigencia_dias + ' Días');\n        $('#usuarios-plan').text(plan.plan.cantidad_usuarios);\n        $('#ofertas-laborales-plan').text(plan.cantidad_ofertas_laborales);\n        $('#nav-actual-tab').click();\n        if (plan.plan_proximo ) {\n            $('#nombre-plan-proximo').text(plan.plan_proximo.plan.nombre);\n            $('#unidades-plan-proximo').text(plan.plan_proximo.unidades);\n            $('#tiempo-plan-proximo').text(plan.plan_proximo.vigencia_dias + ' Días');\n            $('#usuarios-plan-proximo').text(plan.plan_proximo.cantidad_usuarios);\n            $('#ofertas-laborales-plan-proximo').text(plan.plan_proximo.cantidad_ofertas_laborales);\n            $('#contenedor-alert-proximo').removeClass('d-none');\n            $('#nav-tab-plan').removeClass('d-none');\n        } else {\n            $('#contenedor-alert-proximo').addClass('d-none');\n            $('#nav-tab-plan').addClass('d-none');\n        }\n        $('#modal-detalle-plan').modal('show');\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n//APARTADO PARA GESTIONAR EMPRESAS\nlet usuarios = [];\nlet empresa_seleccionada = null;\nlet configuraciones_defecto = [];\nlet configuraciones_personalizadas = [];\n\n/**\n * Obtener los datos del formulario de gestionar empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction obtenerDatosGestionarEmpresa(empresa_id) {\n\n    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n\n    usuarios = [];\n    usuarios_seleccionados = [];\n    empresa_seleccionada = null;\n    configuraciones_defecto = [];\n    configuraciones_personalizadas = [];\n\n    $('.id').val('');\n    $('.empresa_id').val('');\n    $('#usuario').val('');\n    $('.col-lg-6-empresa').addClass('col-lg-6');\n    $('#tabs-empresa').addClass('d-none');\n    if (empresa_id != '' && empresa_id != null) {\n        $.ajax({\n            type : 'GET',\n            url : `/empresas-gestionar-datos/${empresa_id}`,\n            processData: false,\n            contentType: false,\n            success: function(respuesta) {\n                let empresa = respuesta.data;\n                if (empresa.empresa_id != null) {\n                    $('#boton-crear-usuarios').prop('href', `/usuarios/create?empresa_id=${empresa.id}`);\n                    $('#boton-asignar-planes').prop('href', `/asignar-plan/${empresa.id}`);\n                    $('#filtro_empresa_id').append(`\n                        <option value=\"${empresa.empresa.id}\">${empresa.empresa.razon_social}</option>\n                    `);\n                    if ($('#filtro_empresa_id').val() == '' || $('#filtro_empresa_id').val() == null) {\n                        $('#filtro_empresa_id').val(empresa.empresa.id).trigger('change', {programmatic: true});\n                    }\n                    buscarSucursalesEmpresa(empresa.empresa.id, empresa.id);\n                    $('.id').val(empresa.id);\n                    $('.empresa_id').val(empresa.empresa.id);\n                    $('.empresa').addClass('d-none');\n                    $('.sucursal').removeClass('d-none');\n                    $('.col-lg-6-empresa').removeClass('col-lg-6');\n                    $('#ejecutivo-cuenta').text('Ejecutivo de cuenta: ' + empresa.ejecutivo.nombre_completo);\n                    $('#seccion-logo').addClass('d-none');\n                } else {\n                    $('#boton-crear-usuarios').prop('href', `/usuarios/create?empresa_id=${empresa.id}`);\n                    $('#boton-asignar-planes').prop('href', `/asignar-plan/${empresa.id}`);\n                    $('#filtro_empresa_id').append(`\n                        <option value=\"${empresa.id}\">${empresa.razon_social}</option>\n                    `);\n                    if ($('#filtro_empresa_id').val() == '' || $('#filtro_empresa_id').val() == null) {\n                        $('#filtro_empresa_id').val(empresa.id).trigger('change', {programmatic: true});\n                    }\n                    buscarSucursalesEmpresa(empresa_id);\n                    $('.id').val(empresa.id);\n                    $('.empresa').removeClass('d-none');\n                    $('.sucursal').addClass('d-none');\n                    $('#ejecutivo-cuenta').text('');\n                    $('#seccion-logo').removeClass('d-none');\n                }\n                if (empresa.es_persona_juridica == 1) {\n                    $(\"#es_persona_juridica_si\").prop('checked', true);\n                } else {\n                    $(\"#es_persona_juridica_no\").prop('checked', true);\n                }\n                $('#razon_social').val(empresa.razon_social);\n                $('#nombre_comercial').val(empresa.nombre_comercial);\n                let documento = empresa.documento.split('-');\n                $('#documento').val(documento[0]);\n                $('#digito_verificacion').val(documento[1]);\n                $('#sector_id').val(empresa.sector_id).trigger('change').trigger('select2:select');\n                $('#tamano_empresa_id').val(empresa.tamano_empresa_id).trigger('change').trigger('select2:select');\n                $('#procesos_estimados_mensuales').val(empresa.procesos_estimados_mensuales);\n                $('#pruebas_estimadas_mensuales').val(empresa.pruebas_estimadas_mensuales);\n                $('#pais_id').data('departamento_id', empresa.ciudad.departamento_id);\n                $('#pais_id').val(empresa.ciudad.departamento.pais_id).trigger('change').trigger('select2:select');\n                $('#departamento_id').data('ciudad_id', empresa.ciudad.id);\n                $('#departamento_id').val(empresa.departamento_id).trigger('change').trigger('select2:select');\n                $('#ciudad_id').val(empresa.ciudad_id).trigger('change').trigger('select2:select');\n                $('#direccion').val(empresa.direccion);\n                $('#celular').val(empresa.celular);\n\n                rellenarInputCelular(empresa.indicativo_celular, empresa.codigo_iso2_pais_celular, empresa.celular, CAMPO_CELULAR_ID, campo_celular);\n\n                $('#email_facturacion').val(empresa.email_facturacion);\n                $('#telefono').val(empresa.telefono);\n\n                actualizarEnlacesPrevisualizacionArchivos(empresa.archivos);\n\n                if (empresa.telefono_tesorero != null) {\n                    let telefono = empresa.telefono_tesorero.split('-');\n                    $('#telefono').val(telefono[0]);\n                    $('#extension').val(telefono[1]);\n                }\n\n                $('#ejecutivo_id').val(empresa.ejecutivo_id).trigger('change').trigger('select2:select');\n                $('#nombre_representante').val(empresa.nombre_representante);\n                $('#tipo_documento_representante_id').val(empresa.tipo_documento_representante_id).trigger('change').trigger('select2:select');\n                $('#documento_representante').val(empresa.documento_representante);\n                $('#email_representante').val(empresa.email_representante);\n                if (![undefined, null, ''].includes(empresa.id)) {\n                    if (empresa.empresa_id != null) {\n                        $.ajax({\n                            type: 'GET',\n                            url : `/empresas-logo/${empresa.id}`,\n                            success: function() {\n                                $('#logo_sucursal_fondo_previsualizacion').addClass('d-none');\n                                $('#logo_sucursal_previsualizacion').attr('src', `/empresas-logo/${empresa.id}`);\n                                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n                            }\n                        });\n                    } else {\n                        $.ajax({\n                            type: 'GET',\n                            url : `/empresas-logo/${empresa.id}`,\n                            success: function() {\n                                $('#logo_fondo_previsualizacion').addClass('d-none');\n                                $('#logo_previsualizacion').attr('src', `/empresas-logo/${empresa.id}`);\n                                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n                            }\n                        });\n                    }\n                }\n\n                if (empresa.usuarios.length > 0) {\n                    const USUARIO_EMPRESA = empresa.usuarios[0].usuario;\n\n                    $('#usuario_id').val(USUARIO_EMPRESA.id);\n                    $('#nombres').val(USUARIO_EMPRESA.nombres);\n                    $('#apellidos').val(USUARIO_EMPRESA.apellidos);\n                    $('#tipo_documento_id').val(USUARIO_EMPRESA.tipo_documento_id).trigger('change').trigger('select2:select');\n                    $('#documento_usuario').val(USUARIO_EMPRESA.documento);\n                    $('#email').val(USUARIO_EMPRESA.email);\n\n                    rellenarInputCelular(\n                        USUARIO_EMPRESA.indicativo_telefono,\n                        USUARIO_EMPRESA.codigo_iso2_pais_telefono,\n                        USUARIO_EMPRESA.telefono,\n                        CAMPO_CELULAR_USUARIO_ID,\n                        campo_celular_usuario\n                    );\n\n                    $('#usuario').val(JSON.stringify({\n                        id               : USUARIO_EMPRESA.id,\n                        tipo_documento_id: USUARIO_EMPRESA.tipo_documento_id,\n                        documento        : USUARIO_EMPRESA.documento,\n                        nombres          : USUARIO_EMPRESA.nombres,\n                        apellidos        : USUARIO_EMPRESA.apellidos,\n                        email            : USUARIO_EMPRESA.email,\n                        telefono         : USUARIO_EMPRESA.telefono\n                    }));\n                }\n\n                $('#nombre_tesorero').val(empresa.nombre_tesorero);\n                $('#email_tesorero').val(empresa.email_tesorero);\n\n                rellenarInputCelular(\n                    empresa.indicativo_celular_tesorero,\n                    empresa.codigo_iso2_pais_celular_tesorero,\n                    empresa.celular_tesorero,\n                    CAMPO_CELULAR_TESORERO_ID,\n                    campo_celular_tesorero\n                );\n\n                if ( empresa.telefono_tesorero != null) {\n                    let telefono_tesorero = empresa.telefono_tesorero.split('-');\n                    $('#telefono_tesorero').val(telefono_tesorero[0]);\n                    $('#extension_tesorero').val(empresa.telefono_tesorero[1]);\n                }\n                $('#nombre_contacto').val(empresa.nombre_contacto);\n                $('#email_contacto').val(empresa.email_contacto);\n\n                rellenarInputCelular(\n                    empresa.indicativo_celular_contacto,\n                    empresa.codigo_iso2_pais_celular_contacto,\n                    empresa.celular_contacto,\n                    CAMPO_CELULAR_CONTACTO_ID,\n                    campo_celular_contacto\n                );\n\n                empresa_seleccionada = empresa;\n                mostrarPlanes();\n                $('#empresa-tab').click();\n                $('#tabs-empresa').removeClass('d-none');\n                usuarios = empresa.usuarios;\n                mostrarUsuarios(empresa_id);\n                configuraciones_defecto = empresa.configuraciones_defecto;\n                configuraciones_personalizadas = empresa.configuraciones_personalizadas;\n                let archivos = empresa.archivos;\n                $('.contenedor-archivo').addClass('d-none');\n                archivos.forEach((archivo) => {\n                    $('#archivo_' + archivo.nombre).removeClass('d-none');\n                    $('#archivo_' + archivo.nombre).prop('href', '/archivos-abrir/' + archivo.id);\n                });\n\n                mostrarConfiguraciones();\n            },\n            error: function(error) {\n                console.log(error);\n            }\n        });\n    } else if ($('#filtro_empresa_id').val() != '' && $('#filtro_empresa_id').val() != null) {\n        obtenerDatosGestionarEmpresa($('#filtro_empresa_id').val());\n        $('#tabs-empresa').removeClass('d-none');\n    }\n};\n\n/**\n * Actualizar los elementos anchor de previsualización de archivos de la empresa.\n *\n * @param {array} archivos_empresa Arreglo de archivos de la empresa.\n * @param {boolean} reiniciar_campo_archivo Si se debe reiniciar el campo de archivo.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Gonzalez\n */\nfunction actualizarEnlacesPrevisualizacionArchivos(archivos_empresa, reiniciar_campo_archivo = true) {\n    // Oculta todos los elementos anchor de previsualización de archivos.\n    $('.previsualizacion-archivo').addClass('d-none');\n\n    // Muestra los elementos de previsualización de archivos que corresponden con los archivos\n    // relacionados con la empresa.\n    for (let i = 0; i < archivos_empresa.length; i++) {\n        $('#archivo_' + archivos_empresa[i].nombre).prop('href', `/archivos-abrir/${archivos_empresa[i].id}`);\n        $('#archivo_' + archivos_empresa[i].nombre).removeClass('d-none');\n\n        let input_archivo = $('#' + archivos_empresa[i].nombre + '.input-file.input-form');\n        let input_archivo_label = $('label[for=\"' + archivos_empresa[i].nombre + '\"].nombre-archivo');\n        let input_archivo_boton_eliminar = $('#boton-eliminar-archivo-' + archivos_empresa[i].nombre + '.eliminar-archivo');\n\n        if(reiniciar_campo_archivo) {\n            reiniciarCampoArchivo(input_archivo, input_archivo_label, input_archivo_boton_eliminar);\n        }\n    }\n}\n\nfunction mostrarPlanes() {\n    let empresa_id = empresa_seleccionada.id;\n    let buscar = $('#buscador-plan').val();\n    let filtro_tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        tabla_planes.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    let planes = empresa_seleccionada.planes;\n    if (planes.length > 0) {\n        for (let i = 0; i < planes.length; i++) {\n            if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n                continue;\n            }\n            if (\n                (filtro_tipo_prueba_id == 'Todos') ||\n                (filtro_tipo_prueba_id == '1' && planes[i].plan.tipo_prueba_id == 1) ||\n                (filtro_tipo_prueba_id == '2' && planes[i].plan.tipo_prueba_id == 2) ||\n                (filtro_tipo_prueba_id == '3' && planes[i].plan.tipo_prueba_id != 3)\n            ) {\n                let estado = obtenerEstadoPlan(\n                    planes[i].estado.id,\n                    planes[i].estado.nombre,\n                    planes[i].por_facturar,\n                    planes[i].renovando,\n                    null,\n                    planes[i].plan_proximo_id\n                );\n\n                let acciones = obtenerAcciones(\n                    planes[i].estado.id,\n                    planes[i].id, empresa_id,\n                    planes[i].plan.tipo_prueba_id,\n                    planes[i].plan.nombre,\n                    planes[i]?.archivos[0]?.id ?? '0',\n                    empresa_seleccionada.nombre_comercial\n                );\n\n                let modificado = '';\n                if (planes[i].plan_original == 0) {\n                    modificado = `<i class=\"bi bi-wrench me-3 text-blue-40\" ${crearTooltip({placement: 'top', content: 'Plan modificado', toggle: 'popover' })}></i>`;\n                }\n                let fecha_vencimiento = '';\n                if (planes[i].fecha_vencimiento != null) {\n                    fecha_vencimiento = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                }\n                let fecha_creacion = '';\n                if (planes[i].created_at != null) {\n                    fecha_creacion = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                }\n                let fecha_inicio = '';\n                if (planes[i].fecha_inicio != null) {\n                    fecha_inicio = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                }\n                let pruebas_plan = '';\n                if (planes[i].pruebas !== undefined) {\n                    let pruebas = planes[i].pruebas;\n                    for (let j = 0; j < pruebas.length; j++) {\n                        pruebas_plan += `\n                            <div\n                                class=\"col-auto me-3 circulo-prueba\"\n                                style=\"background-image: url(../imagenes/logos/pruebas/${slugify(planes[i].pruebas[j].nombre)}.png)\"\n                                ${crearTooltip({placement: 'top', content: planes[i].pruebas[j].nombre, toggle: 'popover' })}\n                            ></div>\n                        `;\n                    }\n                }\n                let icono = '';\n                let title = '';\n                if (planes[i].plan.tipo_prueba_id == 1) {\n                    title = 'Selección';\n                    icono = 'bi-person-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 2) {\n                    title = 'Organizacional';\n                    icono = 'bi-people-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 3) {\n                    title = 'Vocacional';\n                    icono = 'bi-mortarboard-fill';\n                }\n                let opcion_editar = `\n                    <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit'\">\n                        <i class=\"bi bi-pencil-fill\"></i>\n                    </button>\n                `;\n                if (planes[i]?.plan_proximo_id) {\n                    opcion_editar = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n                            <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                            <div class=\"dropdown-menu\">\n                                <a href=\"/empresas-planes/${planes[i].id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n                                <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n                            </div>\n                        </button>\n                    `;\n                }\n                $('#tbody-planes').append(`\n                    <tr>\n                        <td style=\"border-bottom: 0px!important;\">\n                            <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                    <div class=\"col\">\n                                        <div class=\"row align-items-center\">\n                                            <div class=\"col-auto mb-0\">\n                                                <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                    <i class=\"bi ${icono} me-3\" title=\"${title}\"></i> ${modificado} ${planes[i].plan.nombre}\n                                                </p>\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                ${estado}\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                    <i class=\"bi bi-person-fill\"></i>&nbsp;<span class=\"text-label-2\">${planes[i].cantidad_usuarios}&nbsp;${fecha_vencimiento}</span>\n                                                </p>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n                                                <div class=\"row w-100 m-0\">${pruebas_plan}</div>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n\n                                            </div>\n                                        </div>\n                                    </div>\n                                    <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                        ${opcion_editar}\n                                        ${crearBoton({\n                                            clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                            texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                            adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                        })}\n                                        ${acciones}\n                                    </div>\n                                </div>\n                                <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                    <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-briefcase\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Vacantes: ${planes[i].cantidad_ofertas_laborales !== null ? planes[i].cantidad_ofertas_laborales : ''}</span>\n                                            </p>\n                                        </div>\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-box\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Unidades: ${planes[i].unidades !== null ? planes[i].unidades : ''}</span>\n                                            </p>\n                                        </div>\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-clock\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Tiempo: ${planes[i].vigencia_dias !== null ? planes[i].vigencia_dias : ''} días</span>\n                                            </p>\n                                        </div>\n                                        ${planes[i].usuario ? `\n                                            <div class=\"col-auto\"><i class=\"bi bi-plus-circle\"></i> Creador:</div>\n                                            <div class=\"col-auto me-3 circulo-prueba\" style=\"background-image: url(/usuarios-imagen/${planes[i].usuario.id})\"\n                                                ${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `${planes[i].usuario.nombres} ${planes[i].usuario.apellidos}`,\n                                                    toggle: `popover`,\n                                                })}>\n                                            </div>\n                                            <div class=\"col\">\n                                                <div class=\"row justify-content-end\">\n                                                    <div class=\"col-auto\">\n                                                        ${fecha_creacion}\n                                                        <span class=\"fw-bold ms-3\">${fecha_inicio}</span>\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        ` : ''}\n                                    </div>\n                                    <div class=\"d-flex justify-content-end align-items-end pe-3\">\n                                        <p class=\"text-label-2 mb-0\">\n                                            <span class=\"text-gray-50 me-3\">${fecha_creacion}</span>\n                                            <span class=\"text-gray-30\">${fecha_inicio}</span>\n                                        </p>\n                                    </div>\n                                </div>\n                            </div>\n                        </td>\n                    </tr>\n                `);\n            }\n        }\n\n        // Mostrar cards de planes de créditos\n        let planes_creditos_mostrados = [];\n        for (let i = 0; i < planes.length; i++) {\n            if (planes[i].plan_credito && planes[i].plan_credito.id) {\n                // Evitar duplicados de plan_credito\n                if (!planes_creditos_mostrados.includes(planes[i].plan_credito.id)) {\n                    planes_creditos_mostrados.push(planes[i].plan_credito.id);\n\n                    let plan_credito = planes[i].plan_credito;\n                    let creditos_totales = planes[i].creditos !== null ? planes[i].creditos : 0;\n                    let creditos_restantes = planes[i].creditos_restantes !== null ? planes[i].creditos_restantes : 0;\n                    let creditos_promedio = empresa_seleccionada.creditos_promedio_accion || 0;\n                    let acciones_estimadas = creditos_restantes > 0 && creditos_promedio > 0\n                        ? Math.floor(creditos_restantes / creditos_promedio)\n                        : 0;\n\n                    let estado_credito = creditos_restantes > 0\n                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n\n                    let precio_informacion= '';\n                    if (plan_credito.precio) {\n                        precio_informacion= `$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}`;\n                        if (plan_credito.porcentaje_descuento && plan_credito.precio_con_descuento) {\n                            precio_informacion= `<span class=\"text-decoration-line-through text-gray-50\">$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}</span>\n                                          <span class=\"text-green-40 ms-2\">$${parseFloat(plan_credito.precio_con_descuento).toLocaleString('es-CO')}</span>\n                                          <span class=\"tag tag-sm tag-tonal-green ms-2\">-${plan_credito.porcentaje_descuento}%</span>`;\n                        }\n                    }\n\n                    let fecha_promocion = '';\n                    if (plan_credito.fecha_inicio_promocion && plan_credito.fecha_fin_promocion) {\n                        fecha_promocion = `Promoción: ${obtenerFecha(plan_credito.fecha_inicio_promocion)} - ${obtenerFecha(plan_credito.fecha_fin_promocion)}`;\n                    }\n\n                    let fecha_creacion_credito = '';\n                    if (planes[i].created_at != null) {\n                        fecha_creacion_credito = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                    }\n\n                    let fecha_activacion_credito = '';\n                    if (planes[i].fecha_inicio != null) {\n                        fecha_activacion_credito = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                    }\n\n                    let fecha_vencimiento_credito = '';\n                    if (planes[i].fecha_vencimiento != null) {\n                        fecha_vencimiento_credito = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                    }\n\n                    let opcion_editar_credito = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n                            <i class=\"bi bi-pencil-fill\"></i>\n                        </button>\n                    `;\n                    if (planes[i]?.plan_proximo_id) {\n                        opcion_editar_credito = `\n                            <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n                                <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                                <div class=\"dropdown-menu\">\n                                    <a href=\"/empresas-planes/${planes[i].id}/edit?tipo=creditos\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n                                    <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit?tipo=creditos\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n                                </div>\n                            </button>\n                        `;\n                    }\n\n                    let acciones_credito = obtenerAccionesCreditos(\n                        planes[i].estado.id,\n                        planes[i].id,\n                        empresa_id,\n                        planes[i]?.archivos[0]?.id ?? '0',\n                        empresa_seleccionada.nombre_comercial,\n                        plan_credito.nombre,\n                        plan_credito.creditos,\n                        planes[i].creditos_restantes ?? null\n                    );\n\n                    $('#tbody-planes').append(`\n                        <tr>\n                            <td style=\"border-bottom: 0px!important;\">\n                                <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                    <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                        <div class=\"col\">\n                                            <div class=\"row align-items-center\">\n                                                <div class=\"col-auto mb-0\">\n                                                    <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                        <i class=\"bi bi-coin me-3\" title=\"Plan de Créditos\"></i> ${plan_credito.nombre}\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    ${estado_credito}\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-12 mt-3\">\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                            ${opcion_editar_credito}\n                                            ${crearBoton({\n                                                clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                                texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                                adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                            })}\n                                            ${acciones_credito}\n                                        </div>\n                                    </div>\n                                    <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                        <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos disponibles: ' + creditos_restantes.toLocaleString('es-CO'),\n                                            })}\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos promedio por acción: ' + creditos_promedio.toLocaleString('es-CO'),\n                                            })}\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                                            })}\n                                        </div>\n                                        <div class=\"d-flex justify-content-end align-items-end pe-3\">\n                                            <p class=\"text-label-2 mb-0\">\n                                                <span class=\"text-gray-50 me-3\">${fecha_creacion_credito}</span>\n                                                <span class=\"text-gray-30\">${fecha_activacion_credito}</span>\n                                            </p>\n                                        </div>\n                                    </div>\n                                </div>\n                            </td>\n                        </tr>\n                    `);\n                }\n            }\n        }\n\n        inicializarTooltips();\n        tabla_planes = $('#tabla-planes').DataTable({\n            \"paging\": false,\n            \"searching\": true,\n            \"ordering\": false,\n            \"info\": false\n        });\n        let buscador = $('#tabla-planes_wrapper input');\n        $(buscador).addClass('rounded-2 text-body-2');\n        $(buscador).prop('placeholder', 'Buscar');\n        $(buscador).prop('id', 'buscador-plan');\n        $('#input-busqueda').append(buscador);\n        $(buscador).val(buscar).trigger('input');\n    } else {\n        $('#fila-cabecera-tabla-planes').remove();\n        $('#tbody-planes').append(`\n            <tr class=\"w-100 d-flex justify-content-center align-items-center\" style=\"height: 480px;\">\n                <td class=\"d-flex justify-content-center align-items-center flex-column row-gap-4\">\n                    <p class=\"text-center text-gray-60 m-0\" style=\"font-size: 80px;\"><i class=\"bi bi-slash-circle m-0 p-0\"></i></p>\n                    <div class=\"m-0\">\n                        <p class=\"text-center text-body-2 text-gray-30 fs-4 mb-3\">Aún no hay planes asignados</p>\n                        <p class=\"text-center text-body-2 text-gray-30 mb-0\">Comienza ahora</p>\n                    </div>\n                    ${crearBoton({\n                        id: 'boton-asignar-plan',\n                        type: 'button',\n                        clases: 'btn-primary',\n                        texto: 'Asignar plan',\n                        url: `/asignar-plan/${empresa_id}`\n                    })}\n                </td>\n            </tr>\n        `);\n    }\n}\n\nfunction obtenerFecha(fecha) {\n    let fecha_obj = new Date(fecha);\n    let dia = ('0' + fecha_obj.getUTCDate()).slice(-2);\n    let mes = ('0' + (fecha_obj.getUTCMonth() + 1)).slice(-2);\n    let año = fecha_obj.getUTCFullYear();\n    return `${dia}/${mes}/${año}`;\n}\n\nfunction obtenerEstadoPlan(estado_id, nombre, por_facturar = 0, renovando = 0, empresa_plan_id = null, proximo = false) {\n\n    let detalle_empresa_plan = '';\n    if (empresa_plan_id != null) {\n        detalle_empresa_plan = `onclick=\"abrirDetallePlan(${empresa_plan_id})\"`;\n    }\n    let badge_proximo = '';\n    if (proximo) {\n        badge_proximo = `<span class=\"position-absolute badge badge-proximo bg-purple rounded-pill text-label-2 py-0 px-1 fw-normal\"><div class=\"text-white texto-proximo\">Próximo: </div>+1</span>`;\n    }\n    let estado = '';\n    if (por_facturar == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-por-facturar text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>Por facturar${badge_proximo}</span>`;\n    } else if (renovando == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-renovado text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>Renovando${badge_proximo}</span>`;\n    } else if (estado_id == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-activo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 2) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-inactivo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 3) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-proximo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 4) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-por-vencer text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 5) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-vencido text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    }\n\n    return estado;\n}\n\n/**\n * Obtener las acciones para la tabla de recompras.\n *\n * @param {number} estado_id Id del estado\n * @param {number} id Id del plan\n * @param {number} empresa_id Id de la empresa\n * @param {number} tipo_prueba_id Id del tipo de prueba\n * @param {string} tipo_prueba_nombre Nombre del tipo de prueba\n * @param {number} id_archivo Id del archivo\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa\n * @returns {string}\n * @author José Manuel Jimenez\n * @author Fahibram Cárcamo\n */\nfunction obtenerAcciones(estado_id, id, empresa_id, tipo_prueba_id, tipo_prueba_nombre, id_archivo, nombre_comercial_empresa) {\n\n    let acciones_html = '<ul class=\"dropdown-menu py-1\">';\n\n    if ([1, 4, 5].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\">\n            <button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"generarEnlaceCreacion(${id})\">Renovar</button>\n        </li>`;\n    }\n\n    acciones_html += `\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"window.location = '/facturar-plan/${id}'\">Facturación de recompra</button>\n        </li>\n        <li class=\"py-1\">\n            <button\n                type=\"button\"\n                class=\"dropdown-item text-body-2 text-gray-30\"\n                onclick=\"abrirHistorialRecompras(${empresa_id}, ${tipo_prueba_id}, '${tipo_prueba_nombre}', '${nombre_comercial_empresa}')\"\n            >\n                Historial de recompras\n            </button>\n        </li>\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"abrirFacturaPlan(${id_archivo})\">Ver factura</button>\n        </li>\n    `;\n\n    if ([1, 3].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-danger\" type=\"button\" onclick=\"eliminar(${id})\">Eliminar</button></li>`;\n    }\n\n    acciones_html += '</ul>';\n\n    return acciones_html;\n}\n\n/**\n * Generar acciones para planes de creditos.\n *\n * @param {number} estado_id Id del estado del plan.\n * @param {number} id Id del plan de empresa.\n * @param {number} empresa_id Id de la empresa.\n * @param {number} id_archivo Id del archivo.\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa\n * @returns {string}\n * @author Jose Manuel Jimenez\n * @author Fahibram Carcamo\n * @author Sergio Vargas\n */\nfunction obtenerAccionesCreditos(estado_id, id, empresa_id, id_archivo, nombre_comercial_empresa, nombre_plan, creditos, creditos_restantes) {\n\n    let acciones_html = '<ul class=\"dropdown-menu py-1\">';\n\n    if ([1, 4, 5].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\">\n            <button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"generarEnlaceCreacion(${id})\">Renovar</button>\n        </li>`;\n    }\n\n    acciones_html += `\n        <li class=\"py-1\">\n            <button\n                type=\"button\"\n                class=\"dropdown-item text-body-2 text-gray-30\"\n                onclick=\"abrirHistorialRecomprasCreditos(${empresa_id}, '${nombre_comercial_empresa}')\"\n            >\n                Historial de recompras\n            </button>\n        </li>\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"abrirFacturaPlan(${id_archivo})\">Ver factura</button>\n        </li>\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"abrirDetallePlanCreditos(${empresa_id}, '${nombre_plan}', ${creditos})\">Ver consumo</button>\n        </li>\n    `;\n\n    if ([1, 2, 3].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"inactivar(${id})\">Inactivar</button></li>`;\n    }\n\n    if ([1, 3].includes(estado_id) && creditos_restantes != null && creditos_restantes == creditos) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-danger\" type=\"button\" onclick=\"eliminar(${id})\">Eliminar</button></li>`;\n    }\n\n    acciones_html += '</ul>';\n\n    return acciones_html;\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    }\n}\n\nfunction abrirAcciones(elemento) {\n    $(elemento).parent().find('.acciones-lista').removeClass('d-none');\n}\n\n$(document).mouseup(function(e) {\n    var acciones = $(\".acciones-lista\");\n    if (!acciones.is(e.target) && acciones.has(e.target).length === 0) {\n        $(\".acciones-lista\").addClass('d-none');\n    }\n});\n\n/**\n * Agrega los usuarios a la tabla de usuarios.\n *\n * @param {number} empresa_id Id de la empresa o sucursal.\n * @returns {void}\n * @author Jose Jimenez\n * @author Fahibram Cárcamo\n * @author Andres Gonzalez\n */\nasync function mostrarUsuarios(empresa_id) {\n    let filtrar_usuarios = $('#filtrar-usuarios').val();\n    if ($.fn.DataTable.isDataTable('#tabla-usuarios')) {\n        tabla_usuarios.destroy();\n    }\n    $('#buscador-usuario').remove();\n    $('#tbody-usuarios').empty();\n    for (let i = 0; i < usuarios.length; i++) {\n        if (\n            usuarios[i].usuario != undefined &&\n            (\n                (filtrar_usuarios == 'Todos') ||\n                (filtrar_usuarios == '1' && usuarios[i].usuario.estado.id == 1) ||\n                (filtrar_usuarios == '2' && usuarios[i].usuario.estado.id == 2)\n            )\n        ) {\n            let estado = `\n                <div class=\"col-12 text-gray-30 text-end\">\n                    <span class=\"me-3\">Inactivo</span>\n                    <div class=\"custom-switch\">\n                        <input type=\"checkbox\" id=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-input\" onclick=\"activarOInactivarUsuarios(this.checked, ${usuarios[i].usuario.id})\">\n                        <label for=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-label\"></label>\n                    </div>\n                </div>\n            `;\n            if (usuarios[i].usuario.estado.id == 1) {\n                estado = `\n                    <div class=\"col-12 text-gray-30 text-end\">\n                        <span class=\"me-3\">Activo</span>\n                        <div class=\"custom-switch\">\n                            <input type=\"checkbox\" id=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-input\" onclick=\"activarOInactivarUsuarios(this.checked, ${usuarios[i].usuario.id})\" checked>\n                            <label for=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-label\"></label>\n                        </div>\n                    </div>\n                `;\n            }\n            let checked = '';\n            if (usuarios_seleccionados.includes(usuarios[i].usuario.id)) {\n                checked = 'checked';\n            }\n            $('#tbody-usuarios').append(`\n                <tr>\n                    <td style=\"border-bottom: 0px!important;\">\n                        <div class=\"border border-1 rounded rounded-3\">\n                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6 align-items-center\">\n                                <div class=\"col-auto\">\n                                    <div class=\"check-container my-1 me-1\">\n                                        <input type=\"checkbox\" class=\"form-check-input\" value=\"${usuarios[i].usuario.id}\" ${checked} onclick=\"seleccionarUsuario(this.value, this.checked);\">\n                                    </div>\n                                </div>\n                                <div class=\"col-auto w-120px px-0 text-center text-headline-7 text-gray-30\">\n                                    <div class=\"row justify-content-center mb-1\">\n                                        <div class=\"imagen-usuario\" style=\"background-image: url(/usuarios-imagen/${usuarios[i].usuario.id})\"></div>\n                                    </div>\n                                    ${usuarios[i]?.usuario?.ciudad?.nombre ?? ''}, ${usuarios[i]?.usuario?.ciudad?.departamento?.pais.nombre ?? ''}\n                                </div>\n                                <div class=\"col ps-lg-4\">\n                                    <div class=\"row w-100 mx-0\">\n                                        <div class=\"col-12 mb-0 text-gray-10 text-headline-5\">\n                                            ${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos} | <span class=\"text-headline-7 mb-0\">${obtenerEdad(usuarios[i].usuario.fecha_nacimiento)}</span>\n                                        </div>\n                                        <div class=\"col-12 mt-2 text-gray-50 text-headline-7\">\n                                            Rol: ${usuarios[i]?.rol?.name ?? ''} <span class=\"ms-3\">Cargo:</span> ${usuarios[i]?.usuario?.cargo?.nombre ?? ''}\n                                        </div>\n                                        <div class=\"col-12 mt-3 text-gray-30 text-headline-7\">\n                                            <i class=\"bi bi-envelope me-1\"></i> ${usuarios[i]?.usuario?.email} <i class=\"bi bi-telephone ms-4 me-1\"></i> ${usuarios[i]?.usuario?.telefono}\n                                        </div>\n                                        <div class=\"col-12 mt-1 text-gray-30 text-headline-7\">\n                                            <i class=\"bi bi-person-vcard me-1\"></i> ${usuarios[i]?.usuario?.tipo_documento?.abreviatura} ${usuarios[i]?.usuario?.documento}\n                                        </div>\n                                    </div>\n                                </div>\n                                <div class=\"col-auto\">\n                                    <div class=\"row\">\n                                        ${estado}\n                                        <input type=\"hidden\" id=\"usuario_id_${usuarios[i].usuario.id}\" value=\"${usuarios[i].usuario.eliminar}\">\n                                        <div class=\"col-12 pt-4 position-relative d-flex justify-content-end text-gray-30\">\n                                            <div class=\"acciones-lista bg-white rounded-4 py-2 position-absolute shadow d-none\" style=\"width: 260px; right: 0; z-index: 1000;\">\n                                                <div class=\"row m-0 w-100\">\n                                                    <div class=\"col-12 pointer py-3 h6 mb-0\" title=\"Generar acceso\" onclick=\"generarAccesoUsuarios(${usuarios[i].usuario.id});\">Generar acceso</div>\n                                                    <div class=\"col-12 pointer py-3 h6 mb-0\" title=\"Ver uso\" onclick=\"abrirHistorialCambiosUsuario(${usuarios[i].usuario.id}, '${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}', true)\">Historial de cambios</div>\n                                                    ${ usuarios[i].usuario.eliminar ? `<div class=\"col-12 pointer py-3 h6 mb-0 text-danger\" title=\"Eliminar\" onclick=\"abrirModalConfirmarEliminarUsuarios(${usuarios[i].usuario.id}, '${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}');\">Eliminar</div>` : '' }\n                                                </div>\n                                            </div>\n                                            <button\n                                                type=\"button\"\n                                                title=\"Editar\"\n                                                class=\"btn btn-text-primary-border text-white btn-circle\"\n                                                onclick=\"window.location.href='/usuarios/${usuarios[i].usuario.id}/edit?rol_id=${usuarios[i].rol.id}&empresa_id=${empresa_id}'\"\n                                            >\n                                                <i class=\"bi bi-pencil\"></i>\n                                            </button>\n                                            <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle ms-3\" onclick=\"abrirAcciones(this);\">\n                                                <i class=\"bi bi-three-dots-vertical\"></i>\n                                            </button>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </td>\n                </tr>\n            `);\n        }\n    }\n    tabla_usuarios = $('#tabla-usuarios').DataTable({\n        \"paging\": true,\n        \"searching\": true,\n        \"ordering\": false,\n        \"info\": true,\n        \"language\": lenguajeDatatables,\n        \"lengthMenu\": [ [10, 25, 50, 100, 200], [10, 25, 50, 100, 200] ],\n    });\n    mostrarComponenteNumeroRegistrosTabla('tabla-usuarios');\n    mostrarComponenteBuscarTabla('tabla-usuarios');\n    validarCheckUsuariosSeleccionados();\n}\n\nfunction seleccionarTodosUsuarios(checked) {\n    usuarios_seleccionados = [];\n    if (checked) {\n        for (let i = 0; i < usuarios.length; i++) {\n            usuarios_seleccionados.push(usuarios[i].usuario.id);\n        }\n    }\n    mostrarUsuarios();\n}\n\nfunction seleccionarUsuario(usuario_id, checked) {\n    if (checked) {\n        if (!usuarios_seleccionados.includes(parseInt(usuario_id))) {\n            usuarios_seleccionados.push(parseInt(usuario_id));\n        }\n    } else {\n        usuarios_seleccionados = usuarios_seleccionados.filter(id => id !== parseInt(usuario_id));\n    }\n    validarCheckUsuariosSeleccionados();\n}\n\nfunction validarCheckUsuariosSeleccionados() {\n    if (usuarios_seleccionados.length == 0) {\n        $('#check-seleccionar-todos').prop('indeterminate', false);\n        $('.botones-usuarios').prop('disabled', true);\n        $('#check-seleccionar-todos').prop('checked', false);\n    } else if (usuarios_seleccionados.length == usuarios.length) {\n        $('.botones-usuarios').prop('disabled', false);\n        $('#check-seleccionar-todos').prop('indeterminate', false);\n        $('#check-seleccionar-todos').prop('checked', true);\n    } else {\n        $('.botones-usuarios').prop('disabled', false);\n        $('#check-seleccionar-todos').prop('indeterminate', true);\n    }\n    $('#cantidad-seleccionados').text(usuarios_seleccionados.length);\n}\n\nfunction actualizarDataUsuarios() {\n    $.ajax({\n        type : 'GET',\n        url : `/empresas-gestionar-datos/${empresa_seleccionada.id}`,\n        processData: false,\n        contentType: false,\n        success: function(respuesta) {\n            let empresa = respuesta.data;\n            usuarios = empresa.usuarios;\n            mostrarUsuarios();\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Función para obtener edad actual de un usuario segun su fecha de nacimiénto\n *\n * @param {string} fecha_nacimiento\n * @return {string}\n * @author José Manuel Jiménez\n */\nfunction obtenerEdad(fecha_nacimiento) {\n    if (!fecha_nacimiento) {\n        return \"\";\n    }\n    const hoy = new Date();\n    const nacimiento = new Date(fecha_nacimiento);\n    let edad = hoy.getFullYear() - nacimiento.getFullYear();\n    const mes = hoy.getMonth() - nacimiento.getMonth();\n    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {\n        edad--;\n    }\n    return edad + \" años\";\n}\n\n/**\n * Abrir el historial de recompras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {string} tipo_prueba_id ID del tipo de prueba.\n * @param {string} tipo_prueba_nombre Nombre del tipo de prueba.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nasync function abrirHistorialRecompras(empresa_id, tipo_prueba_id, tipo_prueba_nombre, nombre_comercial_empresa) {\n    destruirTablaExistente('tabla-historial-recompras');\n    $('#nombre-tipo-prueba').text(tipo_prueba_nombre);\n    $('#tabla-historial-recompras').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: true,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 450px)',\n        scrollCollapse: true,\n        ajax: {\n            url : '/planes-historial-recompras',\n            data: function (datos) {\n                datos.empresa_id = empresa_id;\n                datos.tipo_prueba_id = tipo_prueba_id;\n            },\n            dataSrc: function (json) {\n                return Object.values(json.data);\n            }\n        },\n        columns: [\n            {\n                title: '<span class=\"text-body-3\">Plan</span>',\n                data: 'plan.nombre',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: (data, type, row) => `\n                    <div class=\"d-flex\">\n                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n                                data: [{ texto: 'id', value: row.id }],\n                            })}\n                        </div>\n                        &nbsp;&nbsp;\n                        <div class=\"col d-flex align-items-center pe-0\">\n                            ${\n                                row.plan_original == 0\n                                    ? `\n                                        <span\n                                            class=\"text-primary me-3\"\n                                            style=\"cursor: pointer\"\n                                            ${crearTooltip({ placement: 'bottom', content: 'Plan modificado', toggle: 'popover'})}\n                                        >\n                                            <i class=\"bi bi-wrench\"></i>\n                                        </span>\n                                    `\n                                    : ''\n                            }\n                            <span class=\"text-body-3\">${data}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Creación</span>',\n                data: 'created_at',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Activación</span>',\n                data: 'fecha_inicio',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Vencimiento</span>',\n                data: 'fecha_vencimiento',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Uso de unidades</span>',\n                data: 'conteo_total_consumos_agendas_empresa_sucursales',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    return `${data}/${row.unidades}`;\n                }\n            },\n            // Por el momento no se mostrará el conteo de consumos ni nada relacionado con ofertas laborales.\n            // {\n            //     title: '<span class=\"text-body-3\">Uso de ofertas</span>',\n            //     data: 'conteo_total_consumos_ofertas_laborales_empresa_sucursales',\n            //     className: 'text-body-3 text-center',\n            //     orderable: false,\n            //     searchable: true,\n            //     render: function (data, type, row) {\n            //         return `${data}/${row.cantidad_ofertas_laborales}`;\n            //     }\n            // },\n            {\n                title: '<span class=\"text-body-3\">Uso de tiempo</span>',\n                data: 'vigencia_dias',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data, type, row) {\n                    let fecha_hora_actuales = moment();\n                    let fecha_hora_inicio = moment(row.fecha_inicio);\n                    let dias_consumidos = fecha_hora_actuales.clone().diff(fecha_hora_inicio.clone(), 'days');\n\n                    if (row.fecha_vencimiento == null) {\n                        return `${dias_consumidos}/Ilimitado`;\n                    } else {\n                        let fecha_hora_vencimiento = moment(row.fecha_vencimiento);\n                        if (fecha_hora_actuales.clone().isAfter(fecha_hora_vencimiento.clone(), 'day')) return `${row.vigencia_dias}/${row.vigencia_dias}`;\n                        else return dias_consumidos > row.vigencia_dias ? `${row.vigencia_dias}/${row.vigencia_dias}` : `${dias_consumidos}/${row.vigencia_dias}`;\n                    }\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Adjunto</span>',\n                data: null,\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data) {\n                    let archivo_factura = data.archivos !== undefined && data.archivos !== null && data.archivos.length ? data.archivos[0] : null;\n\n                    if (archivo_factura === null) return '---';\n\n                    let arreglo_ruta_archivo = archivo_factura.ruta.split('/');\n                    let nombre_archivo_factura = arreglo_ruta_archivo[arreglo_ruta_archivo.length - 1];\n                    let indice_ultimo_punto = nombre_archivo_factura.lastIndexOf('.');\n\n                    if (indice_ultimo_punto === -1) return '---';\n\n                    let nombre_archivo_factura_sin_extension = nombre_archivo_factura.substring(0, indice_ultimo_punto);\n                    let extension_archivo_factura = nombre_archivo_factura.substring(indice_ultimo_punto);\n                    let nombre_archivo_factura_truncado = nombre_archivo_factura_sin_extension.substring(0, 6);\n\n                    return `${\n                        crearBoton({\n                            clases: 'btn-text-primary text-decoration-underline',\n                            onclick: `descargarFactura(${archivo_factura.id})`,\n                            texto: `${nombre_archivo_factura_truncado}...${extension_archivo_factura}`,\n                            tooltip: `${crearTooltip({placement: `bottom`,content: `${nombre_archivo_factura}`, toggle: 'popover' })}`\n                        })\n                    }`;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data, type, row) {\n                    return `${\n                        crearBoton({\n                            clases: 'btn-text-primary btn-circle',\n                            texto: '<i class=\"bi bi-eye\"></i>',\n                            onclick: `abrirModalConsumosRecompra(${row.id}, '${row.plan.nombre}', '${nombre_comercial_empresa}')`,\n                            tooltip: `${crearTooltip({placement: `bottom`,content: 'Ver consumo', toggle: 'popover' })}`\n                        })\n                    }`;\n                }\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n\n    $('#boton-descargar-historial-recompras').off('click');\n    $('#boton-descargar-historial-recompras').on(\n        'click',\n        evento => {\n            evento.preventDefault();\n            descargarExcel('planes-historial-recompras-exportar', 'historial-de-recompras', true, {empresa_id});\n        }\n    );\n\n    $('#modal-historial-recompras').modal('show');\n    ajustarRenderDataTable('tabla-historial-recompras');\n    cargarDataTablas();\n    $('#buscador-tabla-historial-recompras input.dt-input:not(:last)').remove();\n    $(\".acciones-lista\").addClass('d-none');\n}\n\n/**\n * Abrir el historial de recompras de creditos IA.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa.\n * @returns {void}\n * @author Sergio Vargas\n * @author José Manuel Jiménez\n */\nasync function abrirHistorialRecomprasCreditos(empresa_id, nombre_comercial_empresa) {\n    $('#modal-historial-recompras-creditos').modal('show');\n    $('#contenedor-tabla-historial-recompras-creditos').empty();\n    $('#contenedor-tabla-historial-recompras-creditos').append(`\n        ${crearTabla({\n            id: 'tabla-historial-recompras-creditos',\n            registros_paginas: true,\n            buscador_datatable: true,\n            class_tabla: 'mt-3',\n            buscador: {\n                icono: '<i class=\"bi bi-search input-icono1\"></i>',\n            },\n            botones: `\n                <div class=\"col-auto\">\n                    ${crearBoton({\n                        id: 'boton-descargar-historial-recompras-creditos',\n                        clases: 'btn-green-excel',\n                        texto: '<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo',\n                        onclick: `descargarExcel('planes-historial-creditos-exportar/${empresa_id}', 'historial-creditos-ia', true)`\n                    })}\n                </div>\n            `\n        })}\n    `);\n    $('#tabla-historial-recompras-creditos').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [10, 25, 50, 100],\n            [10, 25, 50, 100]\n        ],\n        scrollX: true,\n        ajax: {\n            url: `/planes-historial-recompras-creditos/${empresa_id}`,\n        },\n        columns: [\n            {\n                title: 'Plan',\n                data: null,\n                render: (row) => row.plan_credito?.nombre ?? '---'\n            },\n            {\n                title: 'Creacion',\n                data: 'created_at',\n                render: (data) => data ? obtenerFecha(data) : '---'\n            },\n            {\n                title: 'Activacion',\n                data: 'fecha_inicio',\n                render: (data) => data ? obtenerFecha(data) : '---'\n            },\n            {\n                title: 'Vencimiento',\n                data: 'fecha_vencimiento',\n                render: (data) => data ? obtenerFecha(data) : '---'\n            },\n            {\n                title: 'Creditos',\n                data: null,\n                render: (row) => {\n                    const total = row.creditos ?? row.plan_credito?.creditos ?? 0;\n                    return total.toLocaleString('es-CO');\n                }\n            },\n            {\n                title: 'Consumidos',\n                data: null,\n                render: (row) => (row.creditos_consumidos ?? 0).toLocaleString('es-CO')\n            },\n            {\n                title: 'Restantes',\n                data: null,\n                render: (row) => {\n                    const total = row.creditos ?? row.plan_credito?.creditos ?? 0;\n                    const consumidos = row.creditos_consumidos ?? 0;\n                    return Math.max(0, total - consumidos).toLocaleString('es-CO');\n                }\n            },\n            {\n                title: 'Estado',\n                data: null,\n                render: (row) => row.estado?.nombre ?? '---'\n            },\n            {\n                title: 'Valor de venta',\n                data: null,\n                render: (row) => row.precio ? `$${parseFloat(row.precio).toLocaleString('es-CO')}` : '---'\n            }\n        ]\n    });\n    cargarDataTablas();\n}\n\n/**\n * Abrir la ventana modal de consumos de un plan de empresa.\n *\n * @param {number} empresa_plan_id Id del registro de la tabla empresas_planes.\n * @param {string} nombre_plan Nombre del plan.\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalConsumosRecompra(empresa_plan_id, nombre_plan, nombre_comercial_empresa) {\n    $('#modal-historial-recompras').modal('hide');\n    abrirModalConsumosEmpresaPlan(empresa_plan_id, nombre_plan, nombre_comercial_empresa);\n}\n\n/**\n * Renderiza el contenido de las subtablas.\n *\n * @param {array} data Array de datos a renderizar.\n * @returns {string} HTML de la subtabla.\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction crearContenidoSubTabla(data) {\n    return `\n        <div class=\"d-flex flex-column row-gap-3 w-100 p-6\">\n            <div class=\"d-flex column-gap-5\">\n                <p class=\"m-0\">Costo<br>${formatearNumero(data.precio)}</p>\n                <p class=\"m-0\">Descuento<br>${data.porcentaje_descuento ?? '0'}%</p>\n                <p class=\"m-0\">\n                    Precio de venta\n                    <br>\n                    ${formatearNumero(data.porcentaje_descuento !== null ? (data.precio * (1 - parseInt(data.porcentaje_descuento)/100)) : data.precio)}\n                </p>\n            </div>\n            ${data.comentario == null ? '' : `<div class=\"d-flex flex-column\"><p class=\"m-0\">Detalle de uso<br>${data.comentario}</p></div>`}\n        </div>\n    `;\n}\n\n/**\n * Descargar documento de la factura de un plan.\n *\n * @param {number} id Id del archivo de la factura.\n * @returns {Promise<void>}\n * @author Fahibram Cárcamo\n */\nfunction descargarFactura(id) {\n    $.ajax({\n        type: 'POST',\n        url : `/empresas-planes-descargar-factura/${id}`,\n        data: { _token: $('meta[name=\"csrf-token\"]').attr('content') },\n        xhrFields: {\n            responseType: 'blob'\n        },\n        success: function (respuesta) {\n            let url = window.URL.createObjectURL(respuesta);\n            let a   = document.createElement('a');\n            a.href  = url;\n\n            a.download = `archivo_de_factura_${id}.pdf`;\n            document.body.appendChild(a);\n            a.click();\n            window.URL.revokeObjectURL(url);\n            document.body.removeChild(a);\n        }\n    }).then(() => {\n        mostrarToast('success', 'PDF generado correctamente.');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al descargar el archivo.');\n    });\n}\n\n/**\n * Inactivar plan de empresa.\n *\n * @param {number} id ID del plan de empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function inactivar(id) {\n    await $.ajax({\n        type: 'POST',\n        url : `/empresas-planes-actualizar/${id}`,\n        data: {\n            _token   : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method  : 'PATCH',\n            estado_id: 2\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', respuesta.message);\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\n/**\n * Generar acceso para usuarios.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function generarAccesoUsuarios(usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-generar-acceso`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n            ids   : usuarios_enviar // IDs de los usuarios seleccionados\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', `Acceso generado correctamente`);\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\n/**\n * Activar o inactivar usuarios.\n *\n * @param {boolean} activar Indica si se deben activar o inactivar los usuarios.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function activarOInactivarUsuarios(activar = true, usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-actualizar-multiples`,\n        data: {\n            _token   : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method  : 'PATCH',\n            ids      : usuarios_enviar, // IDs de los usuarios seleccionados\n            estado_id: activar ? 1 : 2\n        }\n    }).then((respuesta) => {\n        if (activar) {\n            mostrarToast('success', `Usuario(s) activados con éxito`);\n        } else {\n            mostrarToast('success', `Usuario(s) inactivados con éxito`);\n        }\n        actualizarDataUsuarios();\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\nusuario_id_eliminar = null;\nusuario_nombre_eliminar = '';\n\n/**\n * Función que abre el modal para confirmar la eliminación de usuarios.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction abrirModalConfirmarEliminarUsuarios(usuario_id = null, nombre_usuario = '') {\n    usuario_id_eliminar = usuario_id;\n    let detener_proceso = true;\n\n    for (let elemento of usuarios_seleccionados) {\n        let bandera_usuario = $(`#usuario_id_${elemento}`).val();\n        if (bandera_usuario === 'false' || bandera_usuario === false) {\n            detener_proceso = false;\n            break;\n        }\n    }\n\n    if (detener_proceso) {\n        usuario_nombre_eliminar = nombre_usuario;\n        if (nombre_usuario == '') {\n            nombre_usuario = 'Se van a eliminar ' + usuarios_seleccionados.length + ' usuario(s)';\n        } else {\n            nombre_usuario = 'Se eliminará el usuario ' + nombre_usuario;\n        }\n        $('#nombre-confirmar-eliminacion').text(nombre_usuario);\n        $('#modal-confirmar-eliminacion').modal('show');\n    }else{\n        mostrarToast('danger', 'No es posible eliminar el usuario o los usuarios seleccionados porque tienen relaciones con otros módulos.');\n    }\n\n}\n\n/**\n * Confirmar la eliminación de usuarios.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction confirmarEliminarUsuarios() {\n    eliminarUsuarios(usuario_id_eliminar);\n}\n\n/**\n * Eliminar usuarios.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function eliminarUsuarios(usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-eliminar-multiples`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n            ids   : usuarios_enviar\n        }\n    }).then((respuesta) => {\n        if (respuesta.message == 'Usuarios eliminados correctamente' && usuarios_enviar.length == 1 && respuesta.data == 0) {\n            mostrarToast('success', `Usuario eliminado correctamente`);\n        } else if (respuesta.message == 'Usuarios eliminados correctamente' && respuesta.data == 0) {\n            mostrarToast('success', `Usuarios eliminados correctamente`);\n        } else {\n            mostrarToast('neutral', `Algunos usuarios no fueron eliminados, puede que tengan auditorías.`);\n        }\n        usuarios_seleccionados = usuarios_seleccionados.filter(usuario => !usuarios_enviar.includes(usuario));\n        usuario_id_eliminar = null;\n        usuario_nombre_eliminar = '';\n        $('#modal-confirmar-eliminacion').modal('hide');\n        actualizarDataUsuarios();\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\nbuscar_usuario_id = null;\nbuscar_usuario_nombre = null;\n\n/**\n * Abrir el historial de cambios de un usuario.\n *\n * @param {number} id ID del usuario.\n * @param {string} nombre Nombre del usuario.\n * @param {boolean} limpiar True para limpiar los filtros de la tabla.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nasync function abrirHistorialCambiosUsuario(id, nombre, limpiar = false) {\n    if (limpiar) {\n        $('#filtro_tipo_accion').val('').trigger('change').trigger('select2:select');\n        $('#filtro_fecha_hora').val('');\n    }\n\n    buscar_usuario_id = id;\n    buscar_usuario_nombre = nombre;\n\n    const TITULOS_CAMPOS = {\n        id                                         : 'ID',\n        empresa_id                                 : 'Empresa',\n        area_id                                    : 'Área',\n        cargo_id                                   : 'Cargo',\n        tipo_documento_id                          : 'Tipo de documento',\n        genero_id                                  : 'Género',\n        ciudad_id                                  : 'Ciudad',\n        estado_id                                  : 'Estado',\n        nombres                                    : 'Nombres',\n        apellidos                                  : 'Apellidos',\n        documento                                  : 'Número de documento',\n        email                                      : 'Correo electrónico',\n        email_secundario                           : 'Correo electrónico corporativo',\n        fecha_nacimiento                           : 'Fecha de nacimiento',\n        direccion                                  : 'Dirección',\n        direccion_extra                            : 'Dirección adicional',\n        telefono                                   : 'Teléfono',\n        telefono_secundario                        : 'Teléfono corporativo',\n        profesion                                  : 'Profesión',\n        postgrado                                  : 'Postgrado',\n        numero_tarjeta_profesional                 : 'Número de tarjeta profesional',\n        numero_licencia_salud_ocupacional          : 'Número de licencia en salud ocupacional',\n        fecha_expedicion_licencia_salud_ocupacional: 'Fecha de expedición de la licencia en salud ocupacional',\n        password                                   : 'Contraseña'\n    };\n\n    destruirTablaExistente('tabla-historial-cambios-usuario');\n\n    $('#historial-usuario-nombre').text(nombre);\n\n    $('#tabla-historial-cambios-usuario').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: true,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 450px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/usuarios-historial-cambios/${id}`,\n            data: function (datos) {\n                let filtro_fecha_arreglo = $('#filtro_fecha_hora').val().split(' a ');\n                if (filtro_fecha_arreglo[0] !== undefined && filtro_fecha_arreglo[0] !== '') datos.fecha_desde = filtro_fecha_arreglo[0];\n                if (filtro_fecha_arreglo[1] !== undefined && filtro_fecha_arreglo[1] !== '') datos.fecha_hasta = filtro_fecha_arreglo[1];\n                if ($('#filtro_tipo_accion').val() !== undefined && $('#filtro_tipo_accion').val() !== '') datos.event = $('#filtro_tipo_accion').val();\n            },\n            dataSrc: function (json) {\n                let datos_historial_cambios_usuario = Object.values(json.data);\n                return datos_historial_cambios_usuario\n                    .filter(fila => {\n                        for (const LLAVE in fila.new_values) {\n                            if (TITULOS_CAMPOS[LLAVE] !== undefined && fila.new_values[LLAVE] !== null) return true;\n                        }\n                        for (const LLAVE in fila.old_values) {\n                            if (TITULOS_CAMPOS[LLAVE] !== undefined && fila.old_values[LLAVE] !== null) return true;\n                        }\n\n                        return false;\n                    });\n            }\n        },\n        columns: [\n            // Por el momento no se mostrará el contenido que se muestra debajo de cada fila del historial de cambios.\n            // {\n            //     title: '',\n            //     data: null,\n            //     className: 'text-body-3',\n            //     orderable: false,\n            //     searchable: false,\n            //     render: function (data, type, row) {\n            //         return `\n            //             <div class=\"d-flex\">\n            //                 <div class=\"col-auto ps-0 d-flex align-items-center\">\n            //                     ${crearBoton({\n            //                         clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n            //                         texto: '<i class=\"bi bi-chevron-down\"></i>',\n            //                         data: [{texto: 'id', value: row.id}],\n            //                     })}\n            //                 </div>\n            //             </div>\n            //         `;\n            //     }\n            // },\n            {\n                title: '<span class=\"text-body-3\">Dato anterior</span>',\n                data: null,\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    let datos_anteriores = '<p class=\"text-start mb-0\">';\n\n                    for (const LLAVE in row.old_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && row.old_values[LLAVE] !== null) {\n                            if (LLAVE === 'password') row.old_values[LLAVE] = 'Cambio de contraseña';\n                            datos_anteriores += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${row.old_values[LLAVE]}</span>`;\n                        }\n                    }\n\n                    datos_anteriores += '</p>';\n                    return datos_anteriores;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Dato nuevo</span>',\n                data: null,\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    let datos_nuevos = '<p class=\"text-start mb-0\">';\n\n                    for (const LLAVE in row.new_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && row.new_values[LLAVE] !== null) {\n                            if (LLAVE === 'password') row.new_values[LLAVE] = 'Cambio de contraseña';\n                            datos_nuevos += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${row.new_values[LLAVE]}</span>`;\n                        }\n                    }\n\n                    datos_nuevos += '</p>';\n                    return datos_nuevos;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Responsable</span>',\n                data: 'user.nombre_completo',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : data;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Fecha y hora</span>',\n                data: 'created_at',\n                className: 'text-body-3',\n                orderable: true,\n                searchable: true,\n                render: function (data) {\n                    return data == null\n                        ? '---'\n                        : `\n                            <p class='text-start mb-0'>\n                                <span class=\"text-body-3 text-gray-10\">${moment(data).format('YYYY-MM-DD')}</span><br>\n                                <span class=\"text-label-2 text-gray-30\">${moment(data).format('hh:mm A')}</span>\n                            </p>\n                        `;\n                }\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n\n    $('#boton-descargar-historial-cambios-usuario').off('click').on(\n        'click',\n        evento => {\n            evento.preventDefault();\n            descargarExcel(`usuarios-historial-cambios-exportar/${id}`, 'historial-de-cambios-de-usuario');\n        }\n    );\n\n    $('#modal-historial-cambios-usuario').modal('show');\n\n    ajustarRenderDataTable('tabla-historial-cambios-usuario');\n    cargarDataTablas();\n\n    $('#buscador-tabla-historial-recompras input.dt-input:not(:last)').remove();\n    $(\".acciones-lista\").addClass('d-none');\n}\n\nfunction abrirModalFiltrosAvanzados() {\n    $('#modal-historial-cambios-usuario').modal('hide');\n    $('#modal-filtros-avanzados').modal('show');\n}\n\nfunction aplicarFiltrosAvanzados() {\n    abrirHistorialCambiosUsuario(buscar_usuario_id, buscar_usuario_nombre);\n    $('#modal-filtros-avanzados').modal('hide');\n}\n\nfunction borrarFiltrosAvanzados() {\n    $('#filtro_tipo_accion').val('').trigger('change').trigger('select2:select');\n    flatpickr(\"#filtro_fecha_hora\", { mode: \"range\" }).clear();\n    $('#filtro_fecha_hora_alt').val('');\n    $('#modal-filtros-avanzados').modal('hide');\n    abrirHistorialCambiosUsuario(buscar_usuario_id, buscar_usuario_nombre);\n}\n\n/**\n * Obtener historial de cambios de un usuario.\n *\n * @param {number} id ID del usuario.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getHistorialCambiosUsuario(id) {\n    let datos = [];\n    await $.ajax({\n        type: 'GET',\n        url : `/usuarios-historial-cambios/${id}`,\n        data: {\n            event: $('#filtro_tipo_accion').val(),\n            created_at: $('#filtro_fecha_hora').val()\n        }\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n    return datos;\n}\n\n/**\n * Validar si 2 arrays son iguales\n *\n * @param {array} arr1 primer array a validar.\n * @param {array} arr2 segundo array a validar.\n * @returns {Boolean}\n * @author José Manuel Jiménez\n */\nfunction arraysIguales(arr1, arr2) {\n    if (arr1.length !== arr2.length) {\n        return false;\n    }\n    return arr1.every((element, index) => element === arr2[index]);\n}\n\n/**\n * Mostrar la información de la configuración\n *\n * @author José Manuel Jiménez\n */\nlet actualizar_configuracion = false;\nfunction mostrarConfiguraciones() {\n    actualizar_configuracion = false;\n    $('#configuracion-1').multiselect('destroy');\n    $('#configuracion-2').multiselect('destroy');\n    for (let i = 0; i < usuarios.length; i++) {\n        if (usuarios[i].usuario != undefined) {\n            $('#configuracion-1').append(`\n                <option value=\"${usuarios[i].usuario.id}\">${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}</option>\n            `);\n            $('#configuracion-2').append(`\n                <option value=\"${usuarios[i].usuario.id}\">${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}</option>\n            `);\n        }\n    }\n    $('.switch-config').prop('checked', true);\n    for (let i = 0; i < configuraciones_defecto.length; i++) {\n        if (configuraciones_defecto[i].id == 1) {\n            if (configuraciones_defecto[i].valor == 'todos' || configuraciones_defecto[i].valor == 'administradores') {\n                $('#configuracion-1').val([]);\n                $('#elegir_usuarios').val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-1').val(JSON.parse(configuraciones_defecto[i].valor));\n                $('#elegir_usuarios').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if (configuraciones_defecto[i].id == 2) {\n            if (configuraciones_defecto[i].valor == 'todos' || configuraciones_defecto[i].valor == 'administradores') {\n                $('#configuracion-2').val([]);\n                $('#elegir_actividad').val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-2').val(JSON.parse(configuraciones_defecto[i].valor));\n                $('#elegir_actividad').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if ([3, 4, 6, 7].includes(configuraciones_defecto[i].id) && (configuraciones_defecto[i].valor == '0')) {\n            $('#configuracion-' + configuraciones_defecto[i].id).prop('checked', false);\n        }\n        if (configuraciones_defecto[i].id == 5) {\n            $('#configuracion-' + configuraciones_defecto[i].id).val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n        }\n        if (configuraciones_defecto[i].id == 8) {\n            $('#configuracion-' + configuraciones_defecto[i].id).val(configuraciones_defecto[i].valor);\n        }\n    }\n    for (let i = 0; i < configuraciones_personalizadas.length; i++) {\n        if (configuraciones_personalizadas[i].configuracion_id == 1) {\n            if (configuraciones_personalizadas[i].valor == 'todos' || configuraciones_personalizadas[i].valor == 'administradores') {\n                $('#configuracion-1').val([]);\n                $('#elegir_usuarios').val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-1').val(JSON.parse(configuraciones_personalizadas[i].valor));\n                $('#elegir_usuarios').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 2) {\n            if (configuraciones_personalizadas[i].valor == 'todos' || configuraciones_personalizadas[i].valor == 'administradores') {\n                $('#configuracion-2').val([]);\n                $('#elegir_actividad').val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-2').val(JSON.parse(configuraciones_personalizadas[i].valor));\n                $('#elegir_actividad').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if ([3, 4, 6, 7].includes(configuraciones_personalizadas[i].configuracion_id) && (configuraciones_personalizadas[i].valor == '0')) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).prop('checked', false);\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 5) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 8) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).val(configuraciones_personalizadas[i].valor);\n        }\n    }\n    actualizar_configuracion = true;\n}\n\n/**\n * Función que se ejecut al al cambiar un switch\n *\n * @param {boolean} opcion dato que indica si esta o no seleccionado el switch.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction SeleccionarOpcionSwitch(opcion, configuracion_id) {\n    let dato = opcion ? 1 : 0;\n    actualizarConfiguracion(dato, configuracion_id);\n}\n\n/**\n * Función que se ejecuta al seleccionar una opción de los selects de visibilidad\n *\n * @param {boolean} opcion dato que indica el valor seleccionado en el select.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction SeleccionarOpcionVisibilidad(opcion, configuracion_id) {\n    inizializarMultiselect();\n    if (opcion == 'Elegir usuarios') {\n        $('#contenedor-elegir-usuarios-' + configuracion_id).addClass('col-3');\n        $('#contenedor-elegir-usuarios-' + configuracion_id).removeClass('col-6');\n        $('#contenedor-usuarios-' + configuracion_id).removeClass('d-none');\n    } else {\n        $('#contenedor-elegir-usuarios-' + configuracion_id).removeClass('col-3');\n        $('#contenedor-elegir-usuarios-' + configuracion_id).addClass('col-6');\n        $('#contenedor-usuarios-' + configuracion_id).addClass('d-none');\n    }\n    if (actualizar_configuracion) {\n        $('#configuracion-' + configuracion_id).val([]);\n        actualizarConfiguracion(opcion, configuracion_id);\n    }\n    $('#configuracion-' + configuracion_id).multiselect(\"refresh\");\n}\n\n/**\n * Función que se ejecuta al seleccionar alguno o varios usuarios.\n *\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction seleccionarOpcionSelect(configuracion_id) {\n    let usuarios_select = $('#configuracion-' + configuracion_id).val();\n    actualizarConfiguracion(JSON.stringify(usuarios_select.map(numero => parseInt(numero))), configuracion_id);\n}\n\n/**\n * Actualizar la configuración de la empresa.\n *\n * @param {any} valor valor a actualizar en la configuración seleccionada.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @returns {Promise<void>}\n * @author Daniel Beltrán, José Manuel Jiménez\n */\nasync function actualizarConfiguracion(valor, configuracion_id) {\n    if (actualizar_configuracion) {\n        if (configuracion_id == 1 || configuracion_id == 2) {\n            if (valor != 'todos' && valor != 'administradores') {\n                if (valor == '[]') {\n                    mostrarToast('neutral', `Selecciona al menos un usuario`);\n                    return false;\n                } else if (valor == 'Elegir usuarios') {\n                    return false;\n                }\n            }\n        }\n        await $.ajax({\n            type: 'POST',\n            url : `/configuraciones-modelos`,\n            data: {\n                _token          : $('meta[name=\"csrf-token\"]').attr('content'),\n                model_type      : 'App\\\\Models\\\\Empresas\\\\Empresa',\n                modelo_id       : empresa_seleccionada.id,\n                configuracion_id: configuracion_id,\n                valor           : valor\n            }\n        }).then((respuesta) => {\n            mostrarToast('success', respuesta.message);\n            datos = respuesta.data || [];\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n}\n\n/**\n * metodo para mostrar un tooltip segun el div que lo contenga.\n *\n * @param {div} div del elemento donde se va a mostrar el tooltip\n * @returns {void}\n * @author Sol Espitia\n */\nfunction mostrarTooltip(div) {\n    const tooltip = div.querySelector('.tooltip-bottom');\n    tooltip.style.display = 'inline';\n}\n\n/**\n * metodo para ocultar un tooltip segun el div que lo contenga.\n *\n * @param {div} div del elemento donde se va a mostrar el tooltip\n * @returns {void}\n * @author Sol Espitia\n */\nfunction ocultarTooltip(div) {\n    const tooltip = div.querySelector('.tooltip-bottom');\n    tooltip.style.display = 'none';\n}\n\n/**\n * metodo para seleccionar una empresa en los chackbox para descargar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction seleccionarCheckboxEmpresa(check, empresa_id) {\n    if (check) {\n        empresas_seleccionadas.push(parseInt(empresa_id));\n    } else {\n        empresas_seleccionadas = empresas_seleccionadas.filter(id => id !== parseInt(empresa_id));\n    }\n    if (empresas_seleccionadas.length == cantidad_empresas_listado) {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', false);\n        $('#check-seleccionar-todos-empresas').prop('checked', true);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    } else if (empresas_seleccionadas.length == 0) {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', false);\n        $('#check-seleccionar-todos-empresas').prop('checked', false);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`);\n    } else {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', true);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    }\n}\n\n/**\n * metodo para seleccionar todas las empresas en los chackbox para descargar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction seleccionarTodasEmpresas(check) {\n    empresas_seleccionadas = [];\n    if (check) {\n        for (let i = 0; i < empresas_listado.length; i++) {\n            empresas_seleccionadas.push(empresas_listado[i].id);\n            for (let j = 0; j < empresas_listado[i].sucursales.length; j++) {\n                empresas_seleccionadas.push(empresas_listado[i].sucursales[j].id);\n            }\n        }\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    } else {\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`);\n    }\n    mostrarEmpresas();\n}\n\n/**\n * metodo para descargar el excel pasandole los id de empresas seleccionados.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction descargarExcelEmpresas() {\n    if (empresas_seleccionadas.length > 0) {\n        descargarExcel('empresas-exportar', 'empresas', true, {\n            empresas_ids: empresas_seleccionadas\n        });\n    } else {\n        descargarExcel('empresas-exportar', 'empresas');\n    }\n}\n/**\n * Eliminar el logo de la empresa.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n */\nasync function eliminarLogo(id) {\n    await $.ajax({\n        type: 'POST',\n        url : `/empresas-eliminar-logo/${id}`,\n        data: {\n            _token : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method: 'DELETE'\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', respuesta.message);\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n$('#logo_recorte').on('change', evento => {\n    let archivo_logo = evento.target.files[0];\n    if (archivo_logo && archivo_logo.type.startsWith('image/')) {\n        const reader = new FileReader();\n        reader.onload = evento => {\n            let imagen = new Image();\n            imagen.onload = function() {\n                if (imagen.height > 500) {\n                    validacion_logo_mensaje = 'La imagen es demasiado grande. Intenta con dimensiones inferiores a 500px de alto.';\n                    logo_valido = false;\n                } else if (archivo_logo.size > 400_000) {\n                    validacion_logo_mensaje = 'La imagen es demasiado pesada. Intenta con un peso inferior o igual a 400KB.';\n                    logo_valido = false;\n                } else if (!['image/png', 'image/jpg', 'image/jpeg'].includes(archivo_logo.type)) {\n                    validacion_logo_mensaje = 'El formato no es válido. Carga una imagen en JPG o PNG.';\n                    logo_valido = false;\n                } else {\n                    validacion_logo_mensaje = '';\n                    logo_valido = true;\n                }\n            };\n            imagen.src = evento.target.result;\n        };\n        reader.readAsDataURL(archivo_logo);\n    } else {\n        alert('Por favor selecciona un archivo de imagen válido.');\n    }\n});\n\n/**\n * Abrir modal de detalle del plan de créditos.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {string} nombre_plan Nombre del plan de créditos.\n * @param {number} creditos Número de créditos del plan.\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirDetallePlanCreditos(empresa_id, nombre_plan, creditos) {\n    $('#modal-detalle-plan-creditos').modal('show');\n    $('#nombre-plan-creditos').text(nombre_plan);\n    $('#unidades-plan-creditos').text(numeroCleave(creditos));\n    creditos_empresa_id = empresa_id;\n}\n\n/**\n * Ver consumo de créditos en modal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction verConsumoCreditos() {\n    $('#modal-detalle-plan-creditos').modal('hide');\n    $('#modal-detalle-consumo-creditos').modal('show');\n    $('#contenedor-tabla-detalle-consumo-creditos').empty();\n    $('#contenedor-tabla-detalle-consumo-creditos').append(`\n        ${crearTabla({\n            id: 'tabla-consumo-creditos',\n            registros_paginas: true,\n            buscador_datatable: true,\n            class_tabla: 'mt-3',\n            buscador: {\n                icono: '<i class=\"bi bi-search input-icono1\"></i>',\n            },\n            filtro: crearFiltroDropdown({\n                id: 'filtro_dropdown',\n                name: 'filtro_dropdown',\n                buscador_datatable: true,\n                type: 'text',\n                value: '',\n                class: 'filtro-chips',\n                input_container_class: 'mb-0',\n                placeholder: 'Buscar',\n                icono: '<i class=\"bi bi-search input-icono1\"></i>',\n                icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n                dropdown: {\n                    titulo: 'Filtros avanzados',\n                    contenedor_botones_class: 'col-6',\n                    contenido: `\n                        <div class=\"row mt-5\">\n                            <div class=\"col-5 pt-2\">Acciones realizadas</div>\n                            <div class=\"col-7\">\n                                ${crearSelect2({\n                                    opciones: [],\n                                    opcion_vacia: false,\n                                    id: 'filtro_servicio_ia_id',\n                                    class: 'filtro',\n                                    input_container_class: 'mb-0',\n                                    data: [{\n                                        texto: 'filtro',\n                                        value: 'Estado'\n                                    }]\n                                })}\n                            </div>\n                        </div>\n                        <div class=\"row mt-5\">\n                            <div class=\"col-5 pt-2\">Usuarios</div>\n                            <div class=\"col-7\">\n                                ${crearSelect2({\n                                    opciones: [],\n                                    opcion_vacia: false,\n                                    id: 'filtro_usuario_id',\n                                    class: 'filtro',\n                                    input_container_class: 'mb-0',\n                                    data: [{\n                                        texto: 'filtro',\n                                        value: 'Prueba'\n                                    }]\n                                })}\n                            </div>\n                        </div>\n                        <div class=\"row mt-5 mb-2\">\n                            <div class=\"col-5 pt-2\">Fecha de consumo</div>\n                            <div class=\"col-7\">\n                                ${crearDatePicker({\n                                    id: 'filtro_fecha_consumo',\n                                    class: 'flatpickr-range filtro',\n                                    input_container_class: 'mb-1',\n                                    placeholder: 'Desde - hasta',\n                                    disabled: false,\n                                    icono: '<i class=\"bi bi-calendar4 input-icono2 text-gray-30 pointer\"></i>',\n                                    data: [{\n                                        texto: 'filtro',\n                                        value: 'Desde - Hasta'\n                                    }]\n                                })}\n                            </div>\n                        </div>\n                    `,\n                }\n            }),\n            botones: `\n                <div class=\"col-auto\">\n                    ${crearBoton({\n                        clases: 'btn-green-excel',\n                        texto: `<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`,\n                        onclick: `descargarExcelHistorialCreditos()`\n                    })}\n                </div>\n            `\n        })}\n    `);\n    $('#tabla-consumo-creditos').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [10, 25, 50, 100],\n            [10, 25, 50, 100]\n        ],\n        scrollX: true,\n        ajax: {\n            url: `/empresas/${creditos_empresa_id}/consumos-creditos`,\n            data: function(datos) {\n                datos.servicio_ia_id = $('#filtro_servicio_ia_id').val();\n                datos.usuario_id = $('#filtro_usuario_id').val();\n                let rango_fechas = $('#filtro_fecha_consumo').val();\n                if (rango_fechas != '') {\n                    rango_fechas = rango_fechas.split(\" a \");\n                    datos.desde = rango_fechas[0];\n                    datos.hasta = rango_fechas[1] || rango_fechas[0];\n                }\n            }\n        },\n        columns: [\n            {\n                title: 'Usuario',\n                data: null,\n                orderable: false,\n                searchable: false,\n                className: 'text-center',\n                render: function (dato) {\n                    return `${dato.usuario.nombre_completo}`;\n                },\n            },\n            {\n                title: 'Acción realizada',\n                data: 'servicio',\n                className: 'text-start',\n            },\n            {\n                title: 'Créditos',\n                data: 'creditos',\n                className: 'text-start',\n            },\n            {\n                title: 'Tokens reales',\n                data: 'tokens_reales',\n                className: 'text-start',\n            },\n            {\n                title: 'Fecha consumo',\n                data: null,\n                orderable: true,\n                className: 'text-center',\n                render: function (dato) {\n                    return `${moment(dato.fecha_consumo).format('DD-MM-YYYY hh:mm a')}`;\n                }\n            }\n        ]\n    });\n    $.ajax({\n        url: '/usuarios-listado',\n        type: 'GET',\n        data: {\n            empresa_id: creditos_empresa_id\n        },\n        success: function(respuesta) {\n            let usuarios = respuesta.data;\n            $('#filtro_usuario_id').empty().append('<option value=\"\">Todas</option>');\n            usuarios.forEach(usuario => {\n                $('#filtro_usuario_id').append(`<option value=\"${usuario.id}\">${usuario.nombre_completo}</option>`);\n            });\n        }\n    });\n    $.ajax({\n        url: '/servicios-ia',\n        type: 'GET',\n        success: function(respuesta) {\n            let servicios = respuesta.data;\n            $('#filtro_servicio_ia_id').empty().append('<option value=\"\">Todas</option>');\n            servicios.forEach(servicio => {\n                $('#filtro_servicio_ia_id').append(`<option value=\"${servicio.id}\">${servicio.nombre}</option>`);\n            });\n        }\n    });\n    cargarDataTablas();\n    inicializarFlatpickr();\n}\n\n/**\n * Función OBLIGATORIA para aplicar filtros dropdown.\n *\n * @param {string} filtro id del elemento html del filtro\n * @param {Object} filtros filtros aplicados\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction aplicarFiltrosDropdown() {\n    if ($('#modal-detalle-consumo-creditos').hasClass('show')) {\n        actualizarDatatables('tabla-consumo-creditos');\n    }\n}\n\n/**\n * Descargar Excel del historial de créditos.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction descargarExcelHistorialCreditos() {\n    let servicio_ia_id = $('#filtro_servicio_ia_id').val();\n    let usuario_id = $('#filtro_usuario_id').val();\n    let desde = null;\n    let hasta = null;\n    let rango_fechas = $('#filtro_fecha_consumo').val();\n    if (rango_fechas != '') {\n        rango_fechas = rango_fechas.split(\" a \");\n        desde = rango_fechas[0];\n        hasta = rango_fechas[1] || rango_fechas[0];\n    }\n    // Lógica para descargar excel\n}","structuredPatch":[{"oldStart":1695,"oldLines":6,"newStart":1695,"newLines":11,"lines":["                         ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`","                         : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;"," ","+                    let indicador_proximo_credito = '';","+                    if (planes[i]?.plan_proximo_id) {","+                        indicador_proximo_credito = `<span class=\"tag tag-sm tag-tonal-purple ms-2\">Próximo disponible</span>`;","+                    }","+","                     let precio_informacion= '';","                     if (plan_credito.precio) {","                         precio_informacion= `$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}`;"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"9453ebcc-8ed9-4373-97fc-273bf4eea88d"}
{"parentUuid":"4cc998b0-266e-4ebf-8c20-b504a43341fa","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CHvhrgi3fBgFN1YVSLedsM","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito agregar el `indicador_proximo_credito` en el HTML donde se muestra el estado del crédito.","signature":"EpECCkYICxgCKkD5s9TCyFWeA9dtFhGPD/qs2fV/gKwyX+NcRqjdyDR0qrPODxSMCJQ879z6gnz02SnWAtFW9Ki2MOtZSOXmMXEeEgyizx2McvGgn4nOUOwaDImQZKOZt7noUHv5yyIwmB/PLSlibBAFMDGLL8w1f7aMYjAcgM9pkZQq6w2ptiuuerBDcUs3QJxfBiWCW1HmKnn/hq8vgi0wHwIQDnvUAbu0Kq30+E6/jWTXWRI5ChmZeyaMWqj9lDD7T7KkcUGOCsJvvNe3TiFG7+eDifdxjzKZ8LOFge4iXdnVjy41c0gqbGC4HFfzXgeDM1P13n47OfnGnJJFOWGVswq00MbnIRvQg/1jA8J78+4QGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":460,"cache_read_input_tokens":99293,"cache_creation":{"ephemeral_5m_input_tokens":460,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGn9tkSWeMn7hi6Hcmi","type":"assistant","uuid":"f8be2d84-9a7a-4c74-94e6-f82c0a6d82de","timestamp":"2026-01-25T02:02:09.041Z"}
{"parentUuid":"f8be2d84-9a7a-4c74-94e6-f82c0a6d82de","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CHvhrgi3fBgFN1YVSLedsM","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora necesito agregar el indicador al HTML donde se muestra el estado."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":460,"cache_read_input_tokens":99293,"cache_creation":{"ephemeral_5m_input_tokens":460,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGn9tkSWeMn7hi6Hcmi","type":"assistant","uuid":"bf6d45ab-4b9f-40bb-af33-095543c5b258","timestamp":"2026-01-25T02:02:09.331Z"}
{"parentUuid":"bf6d45ab-4b9f-40bb-af33-095543c5b258","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CHvhrgi3fBgFN1YVSLedsM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XyVBowKvNhxtkyA2v8WW6b","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":1770,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":460,"cache_read_input_tokens":99293,"cache_creation":{"ephemeral_5m_input_tokens":460,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGn9tkSWeMn7hi6Hcmi","type":"assistant","uuid":"e6d58c49-3741-4ea8-902b-bcfaeeafe82f","timestamp":"2026-01-25T02:02:10.188Z"}
{"parentUuid":"e6d58c49-3741-4ea8-902b-bcfaeeafe82f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XyVBowKvNhxtkyA2v8WW6b","type":"tool_result","content":"  1770→                                                        <i class=\"bi bi-coin me-3\" title=\"Plan de Créditos\"></i> ${plan_credito.nombre}\n  1771→                                                    </p>\n  1772→                                                </div>\n  1773→                                                <div class=\"col-auto\">\n  1774→                                                    ${estado_credito}\n  1775→                                                </div>\n  1776→                                                <div class=\"col-auto\">\n  1777→                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n  1778→                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n  1779→                                                    </p>\n  1780→                                                </div>\n  1781→                                                <div class=\"col-12 mt-3\">\n  1782→                                                </div>\n  1783→                                            </div>\n  1784→                                        </div>\n  1785→                                        <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n  1786→                                            ${opcion_editar_credito}\n  1787→                                            ${crearBoton({\n  1788→                                                clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n  1789→                                                texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n  1790→                                                adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n  1791→                                            })}\n  1792→                                            ${acciones_credito}\n  1793→                                        </div>\n  1794→                                    </div>\n  1795→                                    <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n  1796→                                        <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n  1797→                                            ${crearTag({\n  1798→                                                class: 'tag-sm tag-tonal-yellow',\n  1799→                                                texto: 'Créditos disponibles: ' + creditos_restantes.toLocaleString('es-CO'),\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"357ee0da-2dc7-418b-bc25-1cbd365e065e","timestamp":"2026-01-25T02:02:11.179Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","content":"                                                        <i class=\"bi bi-coin me-3\" title=\"Plan de Créditos\"></i> ${plan_credito.nombre}\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    ${estado_credito}\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-12 mt-3\">\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                            ${opcion_editar_credito}\n                                            ${crearBoton({\n                                                clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                                texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                                adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                            })}\n                                            ${acciones_credito}\n                                        </div>\n                                    </div>\n                                    <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                        <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos disponibles: ' + creditos_restantes.toLocaleString('es-CO'),","numLines":30,"startLine":1770,"totalLines":3623}},"sourceToolAssistantUUID":"e6d58c49-3741-4ea8-902b-bcfaeeafe82f"}
{"parentUuid":"357ee0da-2dc7-418b-bc25-1cbd365e065e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PaTV3wjfXNoyhRYjgDQECx","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Voy a agregar el `indicador_proximo_credito` después del `estado_credito`.","signature":"EvMBCkYICxgCKkAuaHOTSoAMMlHvN0HgqwlUYgkv+8hPZulgGVtANSnun3tpF2+uQMNfVBeFuVKwcG0Hfye35btQmVWUgv3KQuO0EgzmIc8IeUAad95Nba8aDMP+ikRdSftm6GO/rSIwUo94Q+zSsM7TLjbZAv2meWJGx2jEBAR7O0Mixicu0gLIYm+1o0zKC+9Muy6FjWNOKltPD5LG1ss9F7wxNptiee8VS6fEyyrURKVL9wB8ogJ2Jz68qG5JbgDUCbU6iRz8YeSD9Xp7DuPLjrmNmYn23ZSglAesPX2vwtT7K6ttElWqRVe8q75O33ChlMAXGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":876,"cache_read_input_tokens":99753,"cache_creation":{"ephemeral_5m_input_tokens":876,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGnXiueH84ZL624CeFo","type":"assistant","uuid":"f2d89501-183c-4b7d-bbb0-bb65171a8f99","timestamp":"2026-01-25T02:02:13.982Z"}
{"parentUuid":"f2d89501-183c-4b7d-bbb0-bb65171a8f99","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PaTV3wjfXNoyhRYjgDQECx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Km1s4LCxsrh5uUURpYAYeo","name":"Edit","input":{"replace_all":false,"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","old_string":"                                                <div class=\"col-auto\">\n                                                    ${estado_credito}\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>","new_string":"                                                <div class=\"col-auto\">\n                                                    ${estado_credito}${indicador_proximo_credito}\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":876,"cache_read_input_tokens":99753,"cache_creation":{"ephemeral_5m_input_tokens":876,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXTGnXiueH84ZL624CeFo","type":"assistant","uuid":"520f0808-a01d-4b62-853b-19fbdb807fb9","timestamp":"2026-01-25T02:02:16.844Z"}
{"parentUuid":"520f0808-a01d-4b62-853b-19fbdb807fb9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Km1s4LCxsrh5uUURpYAYeo","type":"tool_result","content":"The file C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js has been updated successfully."}]},"uuid":"6ef8827f-6362-4087-94a9-a6b4074ef00c","timestamp":"2026-01-25T02:02:17.739Z","toolUseResult":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\empresas\\empresas.js","oldString":"                                                <div class=\"col-auto\">\n                                                    ${estado_credito}\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>","newString":"                                                <div class=\"col-auto\">\n                                                    ${estado_credito}${indicador_proximo_credito}\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>","originalFile":"let redirige_form = 'empresas-gestionar';\nlet empresa_id      = null;\nlet enlace_creacion = null;\nlet resource_url = 'empresas';\nlet logo_valido = true;\nlet validacion_logo_mensaje = '';\nif (resource_url == undefined) {\n    redirige_form = 'empresas';\n}\nlet usuarios_seleccionados = [];\nlet empresas_seleccionadas = [];\nlet url_datatable = {\n    url: resource_url + '-listado-tabla',\n};\nlet cantidad_empresas_listado = 0;\nlet empresas_listado = [];\nempresa_id_eliminar = null;\nempresa_nombre_eliminar = '';\n\nconst CAMPO_CELULAR_ID = 'celular';\nconst CAMPO_CELULAR_CONTACTO_ID = 'celular_contacto';\nconst CAMPO_CELULAR_TESORERO_ID = 'celular_tesorero';\nconst CAMPO_CELULAR_USUARIO_ID = 'celular_usuario';\n\nlet campo_celular = null;\nlet campo_celular_contacto = null;\nlet campo_celular_tesorero = null;\nlet campo_celular_usuario = null;\n\nlet columnas_datatable = [\n    { data: 'id' },\n    { data: 'sucursales_count' },\n    { data: 'id' },\n    { data: 'nombre_comercial' },\n    { data: 'razon_social' },\n    { data: 'documento' },\n    { data: 'ejecutivo.nombre_completo' },\n    { data: 'plan_seleccion' },\n    { data: 'plan_organizacional' },\n    { data: 'plan_vocacional' },\n    { data: null, name: 'acciones', orderable: false, searchable: false }\n];\n\nlet colunmasHTML = [\n    {\n        targets: [0],\n        render: function (data) {\n            return `<div class=\"check-container my-1 me-1\">\n                        <input type=\"checkbox\" class=\"form-check-input\" value=\"${data}\" name=\"empresas_seleccionadas[]\" />\n                    </div>`;\n        }\n    },\n    {\n        targets: 1,\n        render: function (data, type, row) {\n            // Agrega botón para mostrar sucursales\n            return `<span style=\"witdh:80px;\" class=\"pointer\" onclick=\"mostrarOcultarSucursales(this, ${row.id})\">${row.sucursales_count}</span>`;\n        }\n    },\n    {\n        targets: -1,\n        render: function(data, type, row) {\n            return `\n                <div class=\"text-center text-nowrap\">\n                    <button type=\"button\" class=\"btn btn-text-primary btn-circle\" onclick=\"consultarTabla('${resource_url}', ${row.id}, 'ver')\">\n                        <i class=\"bi bi-eye\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary btn-circle\" onclick=\"consultarTabla('${resource_url}', ${row.id}, 'editar')\">\n                        <i class=\"bi bi-pencil\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalArchivar(${row.id})\">\n                        <i class=\"bi bi-archive\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirHistorialCambios(${row.id}, '${row.razon_social}')\">\n                        <i class=\"bi bi-clock\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirDetalleArchivado(${row.id}, '${row.razon_social}', '${row.comentario}')\" title=\"Detalle de archivado\">\n                        <i class=\"bi bi-list\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-danger text-white btn-circle\" onclick=\"eliminarTabla('${resource_url}', ${row.id}, 'empresa')\">\n                        <i class=\"bi bi-trash\"></i>\n                    </button>\n                </div>\n            `;\n        }\n    },\n    {\n        targets: [6, 7, 8], // Columnas de planes de empresa por tipo de prueba\n        render: function (data) {\n            if (data === null) {\n                return null;\n            }\n\n            return `<span onclick=\"abrirDetallePlan(${data?.id})\" class=\"pointer\">${data?.estado?.nombre}</span>`;\n        }\n    }\n];\n\n/**\n * Función que abre el modal para filtrar las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirModalFiltrosAvanzadosEmpresas() {\n    $('#modal-filtros-avanzados-empresas').modal('show');\n}\n\n/**\n * Función busca los planes de un tipo de prueba para el filtrado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction seleccionarTipoPruebaFiltro(tipo_prueba_id) {\n    $('#filtro_plan_id').empty();\n    if (tipo_prueba_id == '') {\n        $('#filtro_plan_id').append(`<option value=\"\">Todos</option>`);\n        $('#filtro-plan').addClass('d-none');\n    } else {\n        $.ajax({\n            type : 'GET',\n            url : `/planes-listado`,\n            data : {\n                tipo_prueba_id: tipo_prueba_id\n            },\n            success: function(respuesta) {\n                let planes = respuesta.data;\n                $('#filtro_plan_id').append(`<option value=\"\">Todos</option>`);\n                for (let i = 0; i < planes.length; i++) {\n                    $('#filtro_plan_id').append(`\n                        <option value=\"${planes[i].id}\">${planes[i].nombre}</option>\n                    `);\n                }\n            },\n            error: function(error) {\n                console.log(error);\n            }\n        });\n        $('#filtro-plan').removeClass('d-none');\n    }\n}\n\n/**\n * Función recarga las empresas con el filtro aplicado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction aplicarFiltrosAvanzadosEmpresas() {\n    mostrarEmpresas();\n    $('#modal-filtros-avanzados-empresas').modal('hide');\n}\n\n/**\n * Función que limpia los filtros aplicados en las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction borrarFiltrosAvanzadosEmpresas() {\n    $('#modal-filtros-avanzados-empresas .select2-filtro').val('').trigger('change').trigger('select2:select');\n    aplicarFiltrosAvanzadosEmpresas();\n}\n\n/**\n * Función que muestra la lista de las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarEmpresas() {\n    let estado = !archivadas;\n    let tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n    let plan_id = $('#filtro_plan_id').val();\n    let ejecutivo_id = $('#filtro_ejecutivo_id').val();\n    let rango_fechas = $('#filtro_fecha_hora').val();\n    if (rango_fechas != '') {\n        rango_fechas = rango_fechas.split(\" a \");\n    }\n    let pais_id = $('#pais_id').val();\n    let departamento_id = $('#departamento_id').val();\n    let estado_plan_id = $('#filtro_estado').val();\n    let ciudad_id = $('#ciudad_id').val();\n    inicializarTooltips()\n    $.ajax({\n        type: 'GET',\n        url: `/empresas-listado-tabla`,\n        data: {\n            'solo_principales': true,\n            'estado_plan_id': estado_plan_id,\n            'activo': estado,\n            'tipo_prueba_id': tipo_prueba_id,\n            'plan_id': plan_id,\n            'ejecutivo_id': ejecutivo_id,\n            'rango_fechas': rango_fechas,\n            'pais_id': pais_id,\n            'departamento_id': departamento_id,\n            'ciudad_id': ciudad_id\n        },\n        success: function(empresas) {\n            cantidad_empresas_listado = 0;\n            empresas_listado = empresas;\n            if ($.fn.DataTable.isDataTable('#tabla-empresas')) {\n                tabla_empresas.destroy();\n            }\n            $('#buscador-empresas').remove();\n            $('#tbody-empresas').empty();\n            for (let i = 0; i < empresas.length; i++) {\n                cantidad_empresas_listado++;\n                crearItemTabla(empresas[i]);\n                let sucursales = empresas[i].sucursales;\n                for (let j = 0; j < sucursales.length; j++) {\n                    cantidad_empresas_listado++;\n                    crearItemTabla(sucursales[j], 'sucursal', empresas[i].plan_seleccion, empresas[i].plan_organizacional, empresas[i].plan_vocacional);\n                }\n            }\n            tabla_empresas = $('#tabla-empresas').DataTable({\n                language: lenguajeDatatables,\n                deferRender: true,\n                lengthMenu: [\n                    [ 10, 25, 50, 100, 200],\n                    [ 10, 25, 50, 100, 200]\n                ],\n                columnDefs: [\n                    { targets: [0, 1], orderable: false }\n                ],\n            });\n            mostrarComponenteNumeroRegistrosTabla('tabla-empresas');\n            $('colgroup').addClass('d-none');\n            mostrarOcultarColumnas();\n            tabla_empresas.on('page order length', function () {\n                setTimeout(function() {\n                    mostrarOcultarColumnas();\n                }, 30);\n            });\n            $(`#buscador-tabla-empresas`).empty();\n            $(`#buscador-tabla-empresas`).append(`\n                <div class=\"input-container input-icon mb-3\" id=\"contenedor-buscador-tabla-empresas\">\n                    <i class=\"bi bi-search\"></i>\n                    <i class=\"bi bi-filter pointer\" style=\"right: 10px!important; left: auto!important;\" onclick=\"abrirModalFiltrosAvanzadosEmpresas();\"></i>\n                </div>\n            `);\n            var buscador_datatables = $(`#tabla-empresas_wrapper .dt-search .dt-input`).first();\n            $(buscador_datatables).addClass('rounded-2 text-body-2 input-filtro');\n            $(buscador_datatables).prop('placeholder', 'Buscar');\n            $(`#contenedor-buscador-tabla-empresas`).append(buscador_datatables);\n            $(`#tabla-empresas_wrapper .dt-layout-cell.dt-end `).first().addClass('d-none');\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Función que muestra cada item de empresa o sucursal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction crearItemTabla(item, tipo = 'empresa', plan_seleccion = null, plan_organizacional = null, plan_vocacional = null) {\n    let campo_sucursal = '';\n    if (tipo == 'empresa' && item.sucursales.length > 0) {\n        campo_sucursal = `\n            <div class=\"width-60px rounded-1 badge-estado-plan badge-estado-inactivo nowrap pointer\" onclick=\"mostrarOcultarSucursales(this, ${item.id})\">\n                ${item.sucursales_count} <i class=\"bi bi-caret-down-fill\"></i>\n            </div>\n        `;\n    }\n    let planes = '';\n    let clase = '';\n    let bg = '';\n    if (tipo == 'sucursal') {\n        clase = `empresa-${item.empresa_id} d-none`;\n        bg = 'bg-gray-90';\n        planes = `\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_seleccion?.estado?.id ?? null,\n                    plan_seleccion?.estado?.nombre ?? null,\n                    plan_seleccion?.por_facturar ?? null,\n                    plan_seleccion?.renovando ?? null,\n                    plan_seleccion?.id ?? null,\n                    plan_seleccion?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_organizacional?.estado?.id ?? null,\n                    plan_organizacional?.estado?.nombre ?? null,\n                    plan_organizacional?.por_facturar ?? null,\n                    plan_organizacional?.renovando ?? null,\n                    plan_organizacional?.id ?? null,\n                    plan_organizacional?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_vocacional?.estado?.id ?? null,\n                    plan_vocacional?.estado?.nombre ?? null,\n                    plan_vocacional?.por_facturar ?? null,\n                    plan_vocacional?.renovando ?? null,\n                    plan_vocacional?.id ?? null,\n                    plan_vocacional?.plan_proximo\n                )}\n            </td>\n        `;\n    } else {\n        planes = `\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_de_seleccion?.estado?.id ?? null,\n                    item?.plan_procesos_de_seleccion?.estado?.nombre ?? null,\n                    item?.plan_procesos_de_seleccion?.por_facturar ?? null,\n                    item?.plan_procesos_de_seleccion?.renovando ?? null,\n                    item?.plan_procesos_de_seleccion?.id ?? null,\n                    item?.plan_procesos_de_seleccion?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_organizacionales?.estado?.id ?? null,\n                    item?.plan_procesos_organizacionales?.estado?.nombre ?? null,\n                    item?.plan_procesos_organizacionales?.por_facturar ?? null,\n                    item?.plan_procesos_organizacionales?.renovando ?? null,\n                    item?.plan_procesos_organizacionales?.id ?? null,\n                    item?.plan_procesos_organizacionales?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_vocacionales?.estado?.id ?? null,\n                    item?.plan_procesos_vocacionales?.estado?.nombre ?? null,\n                    item?.plan_procesos_vocacionales?.por_facturar ?? null,\n                    item?.plan_procesos_vocacionales?.renovando ?? null,\n                    item?.plan_procesos_vocacionales?.id ?? null,\n                    item?.plan_procesos_vocacionales?.plan_proximo\n                )}\n            </td>\n        `;\n    }\n    let checked = '';\n    if (empresas_seleccionadas.includes(item.id)) {\n        checked = 'checked';\n    }\n\n    $('#tbody-empresas').append(`\n        <tr class=\"${clase} ${bg}\">\n            <td class=\"${bg}\">\n                <div class=\"check-container my-1 me-1\">\n                    <input type=\"checkbox\" class=\"form-check-input\" value=\"${item.id}\" onchange=\"seleccionarCheckboxEmpresa(this.checked, this.value);\" ${checked}/>\n                </div>\n            </td>\n            <td class=\"${bg}\">${campo_sucursal ?? ''}</td>\n            <td class=\"${bg}\">${item?.id ?? ''}</td>\n            <td class=\"${bg}\">${item?.nombre_comercial ?? ''}</td>\n            <td class=\"${bg}\">${item?.razon_social ?? ''}</td>\n            <td class=\"${bg}\">${item?.documento ?? ''}</td>\n            <td class=\"${bg}\">${item?.ejecutivo?.nombre_completo ?? ''}</td>\n            ${planes}\n            <td class=\"${bg} d-none columna-ubicacion\">${item?.ciudad?.nombre ?? ''} ${item?.ciudad?.departamento?.pais?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-numero-celular\">${item?.celular ?? ''}</td>\n            <td class=\"${bg} d-none columna-correo-facturacion\">${item?.email_facturacion ?? ''}</td>\n            <td class=\"${bg} d-none columna-fecha-creacion\">${item?.created_at ?? ''}</td>\n            <td class=\"${bg} d-none columna-progreso-creacion\">${item?.porcentaje_creacion ?? ''}</td>\n            <td class=\"${bg} d-none columna-tamano-empresa\">${item?.tamano_empresa?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-sector\">${item?.sector?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-direccion\">${item?.direccion ?? ''}</td>\n            <td class=\"${bg} d-none columna-representante\">${item?.nombre_representante ?? ''}</td>\n            <td class=\"${bg} text-center\">\n                <div class=\"col-auto px-0 dropdown\">\n                    <i class=\"bi bi-three-dots dropdown-toggle text-blue-40 pointer\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                    <div class=\"dropdown-menu\">\n                        <a href=\"/empresas-gestionar/${item.id}\" class=\"dropdown-item no-visited pointer py-2\">Gestionar empresa</a>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirHistorialCambios(${item?.id}, '${item?.razon_social}', '${item?.creado_administrador}')\">Historial de cambios</div>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirModalArchivar(${item?.id})\">Archivar</div>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"cambiarEmpresa(${item?.id});\">Cambiar a esta empresa</div>\n                        <div class=\"dropdown-item no-visited pointer py-2 text-danger\" onclick=\"abrirModalConfirmarEliminarEmpresas('${item?.id}', '${item?.razon_social}')\">Eliminar</div>\n                    </div>\n                </div>\n            </td>\n        </tr>\n    `);\n}\n\n/**\n * Función que muestra u oculta las sucursales de una empresa.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarOcultarSucursales(elemento, empresa_id_padre) {\n    if ($(elemento).find('.bi-caret-down-fill').first().length > 0) {\n        $('.empresa-' + empresa_id_padre).removeClass('d-none');\n        $(elemento).find('.bi-caret-down-fill').first().removeClass('bi-caret-down-fill').addClass('bi-caret-up-fill');\n    } else {\n        $('.empresa-' + empresa_id_padre).addClass('d-none');\n        $(elemento).find('.bi-caret-up-fill').first().removeClass('bi-caret-up-fill').addClass('bi-caret-down-fill');\n    }\n}\n\n/**\n * Función que evalua que columnasn adicionales hay que mostrar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarOcultarColumnas() {\n    let columnas = $('.filtro-columna');\n    for (let i = 0; i < columnas.length; i++) {\n        let valor = $(columnas[i]).val();\n        let checked = $(columnas[i]).prop('checked');\n        if (checked) {\n            $('.' + valor).removeClass('d-none');\n        } else {\n            $('.' + valor).addClass('d-none');\n        }\n    }\n}\n\n/**\n * Función que abre el modal para confirmar la eliminación de empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirModalConfirmarEliminarEmpresas(empresa_id = null, nombre_empresa = '') {\n    empresa_id_eliminar = empresa_id;\n    nombre_empresa = 'Eliminar ' + nombre_empresa;\n    $('#nombre-confirmar-eliminacion').text(nombre_empresa);\n    $('#modal-confirmar-eliminacion').modal('show');\n}\n\n/**\n * Confirmar la eliminación de empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction confirmarEliminarEmpresas() {\n    eliminarEmpresas(empresa_id_eliminar);\n}\n\n/**\n * Eliminar empresas.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function eliminarEmpresas(empresa_id = null) {\n    await $.ajax({\n        type: 'DELETE',\n        url : `/empresas/${empresa_id}`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n        }\n    }).then((respuesta) => {\n        empresa_id_eliminar = null;\n        empresa_nombre_eliminar = '';\n        if (respuesta.tipo != undefined && respuesta.tipo == 'success') {\n            mostrarToast('success', respuesta.mensaje);\n            mostrarEmpresas();\n        } else if (respuesta.errors != undefined) {\n            mostrarToast('danger', respuesta.message);\n        }\n        $('#modal-confirmar-eliminacion').modal('hide');\n    }).catch((error) => {\n        mostrarToast('danger', error.responseJSON.errors);\n        empresa_id_eliminar = null;\n        empresa_nombre_eliminar = '';\n        $('#modal-confirmar-eliminacion').modal('hide');\n    });\n}\n\n$(document).ready(function () {\n    if (typeof opcion_form !== 'undefined' && opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;\n        $(\"#digito_verificacion\").val(numero)\n    }\n\n    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n\n    inicializarSelect2Asincrono('filtro_empresa_id', 'empresas-listado', 'razon_social', { id: 'id', nombre: 'razon_social' }, false, { solo_principales: true });\n\n    configurarFormulario('formulario-archivos');\n    configurarFormulario('formulario-contactos');\n\n    if ($('#pais_id').val() != '') {\n        $('#pais_id').trigger('change');\n    }\n    if ($('#empresa_id').val() != '') {\n        $('#empresa_id').trigger('change');\n    }\n    if ($('#filtro_empresa_id').val() != '') {\n        $('#filtro_empresa_id').trigger('change').trigger('select2:select');\n    }\n    let empresa_id = $('#formulario #id').val();\n    if (![undefined, null, ''].includes(empresa_id)) {\n        $.ajax({\n            type: 'GET',\n            url : `/empresas-logo/${empresa_id}`,\n            success: function() {\n                $('#logo_fondo_previsualizacion').addClass('d-none');\n                $('#logo_previsualizacion').attr('src', `/empresas-logo/${empresa_id}`);\n                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n            }\n        });\n    }\n    $(\"#modal-filtros-avanzados\").on(\"hidden.bs.modal\", function () {\n        $('#modal-historial-cambios-usuario').modal('show');\n    });\n    inicializarTooltips();\n});\n\nfunction postSuccess(respuesta) {\n    if (respuesta.formulario == 'formulario') {\n        if (respuesta.data.empresa_id == null) {\n            if (vista == 'crear-editar') {\n                mostrarToast('success', `La empresa se ${respuesta.accion_realizada} con éxito`);\n                $('#empresa-tab').html(`<i class=\"bi bi-check\"></i>`);\n                $('#documentos-tab').prop('disabled', false);\n                $('#documentos-tab').click();\n            } else if (vista == 'gestionar') {\n                mostrarToast('success', `La empresa se ${respuesta.accion_realizada} con éxito`);\n            }\n        } else {\n            if (vista == 'crear-editar') {\n                if (opcion_form === 'Editar') {\n                    localStorage.setItem('notificacionToast', JSON.stringify({\n                        tipo_alerta: 'success',\n                        texto_1: `La sucursal se ${respuesta.accion_realizada} con éxito`,\n                    }));\n                } else {\n                    localStorage.setItem('notificacionToast', JSON.stringify({\n                        sucursal_creada: true,\n                        id_sucursal: respuesta.data.id,\n                        nombre_comercial_sucursal: respuesta.data.nombre_comercial\n                    }));\n                }\n                if (tipo_rol_activo_usuario === 'empresa') {\n                    window.location.href = '/sucursales';\n                } else if (tipo_rol_activo_usuario === 'superadmin') {\n                    window.location.href = '/empresas';\n                }\n            } else if (vista == 'gestionar') {\n                mostrarToast('success', `La sucursal se ${respuesta.accion_realizada} con éxito`);\n            }\n        }\n    } else if (respuesta.formulario == 'formulario-archivos') {\n        if (Array.isArray(respuesta.data) && respuesta.data.length > 0) actualizarEnlacesPrevisualizacionArchivos(respuesta.data, false);\n        mostrarToast('success', `Los documentos se ${respuesta.accion_realizada} con éxito`);\n        $('#documentos-tab').html(`<i class=\"bi bi-check\"></i>`);\n        $('#contactos-tab').prop('disabled', false);\n        $('#contactos-tab').click();\n    } else if (respuesta.formulario == 'formulario-contactos') {\n        mostrarToast('success', `La información de contacto se ${respuesta.accion_realizada} con éxito`);\n        $('#contactos-tab').html(`<i class=\"bi bi-check\"></i>`);\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `La empresa se ${respuesta.accion_realizada} con éxito`,\n        }));\n        window.location.href='/empresas';\n    }\n    if (typeof respuesta.data !== 'undefined' && typeof es_sucursal !== 'undefined'){\n        if (es_sucursal == false) {\n            if (typeof respuesta.data.id !== 'undefined') {\n                $('.id').val(respuesta.data.id);\n            }\n        }\n    }\n}\n\n/**\n * Validar datos antes de enviar el formulario.\n *\n * @returns {boolean}\n * @author Daniel Beltrán\n * @author Jair Carvajal\n */\nfunction validacionAdicional() {\n    if (campo_celular !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular, CAMPO_CELULAR_ID);\n    }\n    if (campo_celular_contacto !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_contacto, CAMPO_CELULAR_CONTACTO_ID);\n    }\n    if (campo_celular_tesorero !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_tesorero, CAMPO_CELULAR_TESORERO_ID);\n    }\n    if (campo_celular_usuario !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_usuario, CAMPO_CELULAR_USUARIO_ID);\n    }\n\n    if ($('#usuario').length) {\n        $('#usuario').val('');\n        let usuario_id = $('#usuario_id').val();\n        if (usuario_id.length == 0) {\n            usuario_id = null;\n        }\n        let usuario = {\n            id                       : usuario_id,\n            tipo_documento_id        : $('#tipo_documento_id').val(),\n            documento                : $('#documento_usuario').val(),\n            nombres                  : $('#nombres').val(),\n            apellidos                : $('#apellidos').val(),\n            email                    : $('#email').val(),\n            codigo_iso2_pais_telefono: $(`#codigo_iso2_pais_${CAMPO_CELULAR_USUARIO_ID}`).val(),\n            indicativo_telefono      : $(`#indicativo_${CAMPO_CELULAR_USUARIO_ID}`).val(),\n            telefono                 : $(`#${CAMPO_CELULAR_USUARIO_ID}`).val()\n        };\n\n        $('#usuario').val(JSON.stringify(usuario));\n    }\n\n    if (!logo_valido) {\n        mostrarToast('danger', validacion_logo_mensaje);\n        return false;\n    }\n\n    return true;\n}\n\nfunction seleccionarEmpresa(empresa_id) {\n    $('.campo-sucursal').addClass('d-none');\n\n    if (empresas_principales.length) {\n        let ejecutivo = empresas_principales.filter(empresa_principal => empresa_principal.id === parseInt(empresa_id))[0].ejecutivo;\n        $('#ejecutivo-cuenta').text('Ejecutivo de cuenta: ' + ejecutivo?.nombre_completo);\n        let campo_ejecutivo_id = $('input[type=\"hidden\"]#ejecutivo_id');\n        if (campo_ejecutivo_id) {\n            campo_ejecutivo_id.val(ejecutivo?.id);\n        }\n    }\n\n    $('#empresa_id').val('');\n    if (empresa_id.length > 0) {\n        $('#empresa_id').val(empresa_id);\n        $('.campo-sucursal').removeClass('d-none');\n    }\n}\n\nfunction cambiarLogoSucursal() {\n    $('#cambiar-logo').addClass('d-none');\n    $('.campo-imagen-sucursal').removeClass('d-none');\n}\n\nfunction validarLineasTabs() {\n    let pasos = $('.nav-pasos:not(:disabled)').length;\n    for (let i = 0; i < (pasos - 1); i++) {\n        $($('.hr-tab')[i]).addClass('border-blue-40 opacity-100');\n    }\n}\n\n/**\n * Obtener los departamentos según el país seleccionado.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\n$(document).on('change', '#pais_id', function() {\n    const pais_id = $(this).val();\n    $('#departamento_id').empty();\n    $('#ciudad_id').empty();\n    if (pais_id != null && pais_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/departamentos-listado`,\n            data: {\n                pais_id: pais_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n            $('#departamento_id').append(`<option></option>`);\n            datos.forEach((item) => {\n                $('#departamento_id').append(new Option(item.nombre, item.id));\n            });\n            if ($(this).data('departamento_id') != '') {\n                $('#departamento_id').val($(this).data('departamento_id')).trigger('change');\n            }\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n});\n\n/**\n * Obtener las ciudades según el departamento seleccionado.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\n$(document).on('change', '#departamento_id', function() {\n    const departamento_id = $(this).val();\n    $('#ciudad_id').empty();\n    if (departamento_id != null && departamento_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/ciudades-listado`,\n            data: {\n                departamento_id: departamento_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n            $('#ciudad_id').append(`<option></option>`);\n            datos.forEach((item) => {\n                $('#ciudad_id').append(new Option(item.nombre, item.id));\n            });\n            if ($(this).data('ciudad_id') != '') {\n                $('#ciudad_id').val($(this).data('ciudad_id')).trigger('change');\n            }\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n});\n\n/**\n * Obtener las sucursales de la empresa seleccionada.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction buscarSucursalesEmpresa(empresa_id, sucursal_id = null) {\n    $('#filtro_sucursal_id').empty();\n    $('#filtro_sucursal_id').append(`<option value=\"\"></option>`);\n    if (empresa_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/empresas-listado`,\n            data: {\n                empresa_id: empresa_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n\n            datos.forEach((item) => {\n                let selected = '';\n                if (sucursal_id == item.id) {\n                    selected = 'selected';\n                }\n                $('#filtro_sucursal_id').append(`\n                    <option value=\"${item.id}\" ${selected}>${item.nombre_comercial}</option>\n                `);\n            });\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n}\n\n/**\n * Obtener los planes de la empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {Object} parametros Parámetros para filtrar los planes.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function getPlanesEmpresa(empresa_id, parametros = {}) {\n    $.ajax({\n        type: 'GET',\n        url : `/empresas-planes-listado/${empresa_id}`,\n        data: parametros\n    }).then((response) => {\n        const datos = response.data;\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n/**\n * Abrir el modal para archivar o desarchivar empresa.\n *\n * @param {number} id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction abrirModalArchivar(id) {\n    $('#modal-archivar').modal('show');\n    $('#empresa-archivar-id').val(null);\n    $('#empresa-archivar-id').val(id);\n}\n\n/**\n * Archivar o desarchivar empresa.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction archivar() {\n    const formulario = $('#formulario-archivar');\n\n    formulario.validate({\n        ignore: [] // No ignorar campos ocultos\n    });\n\n    const datos = new FormData(formulario[0]);\n    datos.append('_token', $('meta[name=\"csrf-token\"]').attr('content'));\n    datos.append('activo', archivadas);\n    datos.delete('id');\n\n    const id = $('#empresa-archivar-id').val();\n\n    if (formulario.valid()) {\n        $.ajax({\n            type       : 'POST',\n            url        : `/empresas-archivar/${id}`,\n            data       : datos,\n            processData: false,\n            contentType: false\n        }).then((respuesta) => {\n            mostrarToast('success', respuesta.mensaje);\n            $('#modal-archivar').modal('hide');\n            formulario[0].reset();\n            mostrarEmpresas();\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n};\n\n/**\n * Abrir el historial de cambios.\n *\n * @param {number} id ID de la empresa.\n * @param {string} razon_social Razón social de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirHistorialCambios(id, razon_social, creado_administrador = 0) {\n\n    $(document).on('shown.bs.tab', 'a.nav-item-horizontal', function () {\n        let id_tab = $(this).attr('id');\n        $('#descargar-historial').removeClass('d-none');\n        if (id_tab == 'archivos') {\n            $('#descargar-historial').addClass('d-none');\n        }\n    });\n\n    $('#modal-historial-cambios').modal('show');\n    $('#descargar-historial').attr('onclick', `descargarExcel('empresas-historial-cambios-exportar/${id}', 'historial-cambios')`);\n    $('#historial-razon-social').text(razon_social);\n    if (creado_administrador == 1) {\n        $('#forma-creacion').text('Manualmente');\n    } else {\n        $('#forma-creacion').text('Automático');\n    }\n    const TITULOS_CAMPOS = {\n        id                             : 'ID',\n        empresa_id                     : 'Empresa principal',\n        ciudad_id                      : 'Ciudad',\n        ejecutivo_id                   : 'Ejecutivo',\n        sector_id                      : 'Sector',\n        tamano_empresa_id              : 'Tamaño',\n        razon_social                   : 'Razón social',\n        nombre_comercial               : 'Nombre comercial',\n        documento                      : 'NIT',\n        direccion                      : 'Dirección',\n        celular                        : 'Celular',\n        telefono                       : 'Teléfono',\n        email_facturacion              : 'Correo para facturación electrónica',\n        es_persona_juridica            : 'Persona jurídica',\n        procesos_estimados_mensuales   : 'Procesos estimados mensuales',\n        pruebas_estimadas_mensuales    : 'Pruebas estimadas mensuales',\n        tipo_documento_representante_id: 'Tipo de documento del representante',\n        documento_representante        : 'Documento del representante',\n        nombre_representante           : 'Nombre del representante',\n        email_representante            : 'Correo del representante',\n        nombre_tesorero                : 'Nombre del tesorero',\n        celular_tesorero               : 'Celular del tesorero',\n        telefono_tesorero              : 'Teléfono del tesorero',\n        email_tesorero                 : 'Correo del tesorero',\n        nombre_contacto                : 'Nombre del contacto',\n        celular_contacto               : 'Celular del contacto',\n        email_contacto                 : 'Correo del contacto',\n        comentario                     : 'Comentario',\n        activo                         : 'Archivada'\n    };\n    const CAMPOS_ARCHIVOS = {\n        logo                : 'Logo',\n        rut                 : 'RUT',\n        camara_comercio     : 'Cámara de comercio',\n        cedula_representante: 'Cédula del representante'\n    };\n    destruirTablaExistente('tabla-historial-cambios');\n    destruirTablaExistente('tabla-archivos');\n\n    $(`#tabla-historial-cambios`).DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 200px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/empresas-historial-cambios/${id}`\n        },\n        columns: [\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Datos anteriores</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '350px',\n                render: (dato) => {\n                    var datos_anteriores = '';\n                    for (const LLAVE in dato.old_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && dato.old_values[LLAVE] !== null && LLAVE !== 'activo') {\n                            if (LLAVE === 'es_persona_juridica') {\n                                dato.old_values[LLAVE] = dato.old_values[LLAVE] ? 'Sí' : 'No';\n                            }\n\n                            datos_anteriores += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${dato.old_values[LLAVE]}</span>`;\n                        }\n                    }\n                    return `\n                        <div>\n                            ${datos_anteriores}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Datos nuevos</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '350px',\n                render: (dato) => {\n                    var datos_nuevos = '';\n                    for (const LLAVE in dato.new_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && dato.new_values[LLAVE] !== null && LLAVE !== 'activo') {\n                            if (LLAVE === 'es_persona_juridica') {\n                                dato.new_values[LLAVE] = dato.new_values[LLAVE] ? 'Sí' : 'No';\n                            }\n                            datos_nuevos += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${dato.new_values[LLAVE]}</span>`;\n                        }\n                    }\n                    return `\n                        <div>\n                            ${datos_nuevos}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Responsable</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '150px',\n                render: (dato) => {\n                    var responsable = `<span class=\"d-block text-body-3\">${dato.user.nombre_completo}</span>`;\n                    return responsable;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Fecha</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '130px',\n                render: (dato) => {\n                    const FECHA = obtenerFechaHora(dato.created_at);\n                    return `\n                        <span class=\"d-block text-body-3\">${FECHA.fecha}</span>\n                        <small class=\"text-label-2\">${FECHA.hora}</small>\n                    `;\n                }\n            }\n        ],\n        initComplete: function(settings) {\n            cargarDataTablas();\n        },\n    });\n\n    $(`#tabla-archivos`).DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 200px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/archivos`,\n            data: function (datos) {\n                datos.modelo = 'App\\\\Models\\\\Empresas\\\\Empresa';\n                datos.modelo_id = id;\n            },\n        },\n        columns: [\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Archivo</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: (dato) => {\n                    const DATO  = `<a href=\"/archivos-abrir/${dato.id}\" target=\"_blank\" class=\"text-body-3 text-blue-40\">${CAMPOS_ARCHIVOS[dato.nombre]}</a>`;\n                    return `\n                        <div>\n                            ${DATO}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Fecha</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '130px',\n                render: (dato) => {\n                    const FECHA = obtenerFechaHora(dato.created_at);\n                    return `\n                        <span class=\"d-block text-body-3\">${FECHA.fecha}</span>\n                        <small class=\"text-label-2\">${FECHA.hora}</small>\n                    `;\n                }\n            }\n        ],\n        initComplete: function(settings) {\n            cargarDataTablas();\n        },\n    });\n}\n\n/**\n * Función para formatear la hora\n *\n * @param {number} timestamp fecha a transformar.\n * @returns {Promise<Array>}\n * @author Jair Carvajal\n */\nfunction obtenerFechaHora(timestamp) {\n  // Crear objeto Date a partir del timestamp ISO\n  let fecha = new Date(timestamp);\n  // Extraer fecha en formato YYYY-MM-DD\n  let fechaStr = fecha.toISOString().split(\"T\")[0];\n  // Extraer hora en formato HH:MM:SS\n  let horaStr = fecha.toISOString().split(\"T\")[1].split(\".\")[0];\n\n  return {\n    fecha: fechaStr,\n    hora: horaStr\n  };\n}\n\n/**\n * Obtener historial de cambios.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getHistorialCambios(id) {\n    let datos = [];\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-historial-cambios/${id}`\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Obtener archivos.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getArchivos(id) {\n    let datos = [];\n\n    await $.ajax({\n        type: 'GET',\n        url : `/archivos`,\n        data: {\n            modelo   : 'App\\\\Models\\\\Empresas\\\\Empresa',\n            modelo_id: id\n        }\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Generar enlace de creación o actualización.\n *\n * @param {number} id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function generarEnlaceCreacion(id = null) {\n    enlace_creacion = null;\n    const URL       = ![undefined, null, ''].includes(id) ? `/generar-enlace-creacion/${id}` : `/generar-enlace-creacion`;\n\n    await $.ajax({\n        type: 'POST',\n        url : URL,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then((respuesta) => {\n        enlace_creacion = respuesta.data;\n        $('#enlace-creacion').text(enlace_creacion);\n        $('#modal-generar-enlace').modal('show');\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n/**\n * Copiar enlace de creación.\n *\n * @param {boolean} cerrar_modal Indica si se debe cerrar el modal.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction copiarEnlace(cerrar_modal = false) {\n    navigator.clipboard.writeText(enlace_creacion);\n\n    if (cerrar_modal) {\n        $('#modal-generar-enlace').modal('hide');\n    }\n}\n\n/**\n * Abrir detalle de archivado de la empresa.\n *\n * @param {number} id ID de la empresa.\n * @param {string} razon_social Razón social.\n * @param {string} comentario Comentario de archivado.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirDetalleArchivado(id, razon_social, comentario) {\n    $('#razon-social-archivado').text('');\n    $('#responsable-archivado').text('');\n    $('#fecha-archivado').text('');\n    $('#comentario-archivado').text('');\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-detalle-archivado/${id}`,\n        success: function(respuesta) {\n            const DETALLE = respuesta.data;\n            if (DETALLE != null) {\n                $('#razon-social-archivado').text(razon_social);\n                $('#responsable-archivado').text(DETALLE.user.nombre_completo);\n                $('#fecha-archivado').text(formatearFecha(DETALLE.created_at).fecha);\n                $('#comentario-archivado').text(comentario);\n            }\n            $('#modal-detalle-archivado').modal('show');\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Abrir detalle del plan de empresa.\n *\n * @param {number} id ID del plan de empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirDetallePlan(id) {\n    $('.tipo-prueba-plan').text('');\n    $('.nombre-plan').text('');\n    $('.unidades-plan').text('');\n    $('.tiempo-plan').text('');\n    $('.usuarios-plan').text('');\n    $('.ofertas-laborales-plan').text('');\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-planes/${id}`\n    }).then((respuesta) => {\n        let plan = respuesta.data;\n        $('#tipo-prueba-plan').text(plan.plan.tipo_prueba.nombre);\n        $('#nombre-plan').text(plan.plan.nombre);\n        $('#unidades-plan').text(plan.unidades);\n        $('#tiempo-plan').text(plan.vigencia_dias + ' Días');\n        $('#usuarios-plan').text(plan.plan.cantidad_usuarios);\n        $('#ofertas-laborales-plan').text(plan.cantidad_ofertas_laborales);\n        $('#nav-actual-tab').click();\n        if (plan.plan_proximo ) {\n            $('#nombre-plan-proximo').text(plan.plan_proximo.plan.nombre);\n            $('#unidades-plan-proximo').text(plan.plan_proximo.unidades);\n            $('#tiempo-plan-proximo').text(plan.plan_proximo.vigencia_dias + ' Días');\n            $('#usuarios-plan-proximo').text(plan.plan_proximo.cantidad_usuarios);\n            $('#ofertas-laborales-plan-proximo').text(plan.plan_proximo.cantidad_ofertas_laborales);\n            $('#contenedor-alert-proximo').removeClass('d-none');\n            $('#nav-tab-plan').removeClass('d-none');\n        } else {\n            $('#contenedor-alert-proximo').addClass('d-none');\n            $('#nav-tab-plan').addClass('d-none');\n        }\n        $('#modal-detalle-plan').modal('show');\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n//APARTADO PARA GESTIONAR EMPRESAS\nlet usuarios = [];\nlet empresa_seleccionada = null;\nlet configuraciones_defecto = [];\nlet configuraciones_personalizadas = [];\n\n/**\n * Obtener los datos del formulario de gestionar empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction obtenerDatosGestionarEmpresa(empresa_id) {\n\n    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n\n    usuarios = [];\n    usuarios_seleccionados = [];\n    empresa_seleccionada = null;\n    configuraciones_defecto = [];\n    configuraciones_personalizadas = [];\n\n    $('.id').val('');\n    $('.empresa_id').val('');\n    $('#usuario').val('');\n    $('.col-lg-6-empresa').addClass('col-lg-6');\n    $('#tabs-empresa').addClass('d-none');\n    if (empresa_id != '' && empresa_id != null) {\n        $.ajax({\n            type : 'GET',\n            url : `/empresas-gestionar-datos/${empresa_id}`,\n            processData: false,\n            contentType: false,\n            success: function(respuesta) {\n                let empresa = respuesta.data;\n                if (empresa.empresa_id != null) {\n                    $('#boton-crear-usuarios').prop('href', `/usuarios/create?empresa_id=${empresa.id}`);\n                    $('#boton-asignar-planes').prop('href', `/asignar-plan/${empresa.id}`);\n                    $('#filtro_empresa_id').append(`\n                        <option value=\"${empresa.empresa.id}\">${empresa.empresa.razon_social}</option>\n                    `);\n                    if ($('#filtro_empresa_id').val() == '' || $('#filtro_empresa_id').val() == null) {\n                        $('#filtro_empresa_id').val(empresa.empresa.id).trigger('change', {programmatic: true});\n                    }\n                    buscarSucursalesEmpresa(empresa.empresa.id, empresa.id);\n                    $('.id').val(empresa.id);\n                    $('.empresa_id').val(empresa.empresa.id);\n                    $('.empresa').addClass('d-none');\n                    $('.sucursal').removeClass('d-none');\n                    $('.col-lg-6-empresa').removeClass('col-lg-6');\n                    $('#ejecutivo-cuenta').text('Ejecutivo de cuenta: ' + empresa.ejecutivo.nombre_completo);\n                    $('#seccion-logo').addClass('d-none');\n                } else {\n                    $('#boton-crear-usuarios').prop('href', `/usuarios/create?empresa_id=${empresa.id}`);\n                    $('#boton-asignar-planes').prop('href', `/asignar-plan/${empresa.id}`);\n                    $('#filtro_empresa_id').append(`\n                        <option value=\"${empresa.id}\">${empresa.razon_social}</option>\n                    `);\n                    if ($('#filtro_empresa_id').val() == '' || $('#filtro_empresa_id').val() == null) {\n                        $('#filtro_empresa_id').val(empresa.id).trigger('change', {programmatic: true});\n                    }\n                    buscarSucursalesEmpresa(empresa_id);\n                    $('.id').val(empresa.id);\n                    $('.empresa').removeClass('d-none');\n                    $('.sucursal').addClass('d-none');\n                    $('#ejecutivo-cuenta').text('');\n                    $('#seccion-logo').removeClass('d-none');\n                }\n                if (empresa.es_persona_juridica == 1) {\n                    $(\"#es_persona_juridica_si\").prop('checked', true);\n                } else {\n                    $(\"#es_persona_juridica_no\").prop('checked', true);\n                }\n                $('#razon_social').val(empresa.razon_social);\n                $('#nombre_comercial').val(empresa.nombre_comercial);\n                let documento = empresa.documento.split('-');\n                $('#documento').val(documento[0]);\n                $('#digito_verificacion').val(documento[1]);\n                $('#sector_id').val(empresa.sector_id).trigger('change').trigger('select2:select');\n                $('#tamano_empresa_id').val(empresa.tamano_empresa_id).trigger('change').trigger('select2:select');\n                $('#procesos_estimados_mensuales').val(empresa.procesos_estimados_mensuales);\n                $('#pruebas_estimadas_mensuales').val(empresa.pruebas_estimadas_mensuales);\n                $('#pais_id').data('departamento_id', empresa.ciudad.departamento_id);\n                $('#pais_id').val(empresa.ciudad.departamento.pais_id).trigger('change').trigger('select2:select');\n                $('#departamento_id').data('ciudad_id', empresa.ciudad.id);\n                $('#departamento_id').val(empresa.departamento_id).trigger('change').trigger('select2:select');\n                $('#ciudad_id').val(empresa.ciudad_id).trigger('change').trigger('select2:select');\n                $('#direccion').val(empresa.direccion);\n                $('#celular').val(empresa.celular);\n\n                rellenarInputCelular(empresa.indicativo_celular, empresa.codigo_iso2_pais_celular, empresa.celular, CAMPO_CELULAR_ID, campo_celular);\n\n                $('#email_facturacion').val(empresa.email_facturacion);\n                $('#telefono').val(empresa.telefono);\n\n                actualizarEnlacesPrevisualizacionArchivos(empresa.archivos);\n\n                if (empresa.telefono_tesorero != null) {\n                    let telefono = empresa.telefono_tesorero.split('-');\n                    $('#telefono').val(telefono[0]);\n                    $('#extension').val(telefono[1]);\n                }\n\n                $('#ejecutivo_id').val(empresa.ejecutivo_id).trigger('change').trigger('select2:select');\n                $('#nombre_representante').val(empresa.nombre_representante);\n                $('#tipo_documento_representante_id').val(empresa.tipo_documento_representante_id).trigger('change').trigger('select2:select');\n                $('#documento_representante').val(empresa.documento_representante);\n                $('#email_representante').val(empresa.email_representante);\n                if (![undefined, null, ''].includes(empresa.id)) {\n                    if (empresa.empresa_id != null) {\n                        $.ajax({\n                            type: 'GET',\n                            url : `/empresas-logo/${empresa.id}`,\n                            success: function() {\n                                $('#logo_sucursal_fondo_previsualizacion').addClass('d-none');\n                                $('#logo_sucursal_previsualizacion').attr('src', `/empresas-logo/${empresa.id}`);\n                                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n                            }\n                        });\n                    } else {\n                        $.ajax({\n                            type: 'GET',\n                            url : `/empresas-logo/${empresa.id}`,\n                            success: function() {\n                                $('#logo_fondo_previsualizacion').addClass('d-none');\n                                $('#logo_previsualizacion').attr('src', `/empresas-logo/${empresa.id}`);\n                                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n                            }\n                        });\n                    }\n                }\n\n                if (empresa.usuarios.length > 0) {\n                    const USUARIO_EMPRESA = empresa.usuarios[0].usuario;\n\n                    $('#usuario_id').val(USUARIO_EMPRESA.id);\n                    $('#nombres').val(USUARIO_EMPRESA.nombres);\n                    $('#apellidos').val(USUARIO_EMPRESA.apellidos);\n                    $('#tipo_documento_id').val(USUARIO_EMPRESA.tipo_documento_id).trigger('change').trigger('select2:select');\n                    $('#documento_usuario').val(USUARIO_EMPRESA.documento);\n                    $('#email').val(USUARIO_EMPRESA.email);\n\n                    rellenarInputCelular(\n                        USUARIO_EMPRESA.indicativo_telefono,\n                        USUARIO_EMPRESA.codigo_iso2_pais_telefono,\n                        USUARIO_EMPRESA.telefono,\n                        CAMPO_CELULAR_USUARIO_ID,\n                        campo_celular_usuario\n                    );\n\n                    $('#usuario').val(JSON.stringify({\n                        id               : USUARIO_EMPRESA.id,\n                        tipo_documento_id: USUARIO_EMPRESA.tipo_documento_id,\n                        documento        : USUARIO_EMPRESA.documento,\n                        nombres          : USUARIO_EMPRESA.nombres,\n                        apellidos        : USUARIO_EMPRESA.apellidos,\n                        email            : USUARIO_EMPRESA.email,\n                        telefono         : USUARIO_EMPRESA.telefono\n                    }));\n                }\n\n                $('#nombre_tesorero').val(empresa.nombre_tesorero);\n                $('#email_tesorero').val(empresa.email_tesorero);\n\n                rellenarInputCelular(\n                    empresa.indicativo_celular_tesorero,\n                    empresa.codigo_iso2_pais_celular_tesorero,\n                    empresa.celular_tesorero,\n                    CAMPO_CELULAR_TESORERO_ID,\n                    campo_celular_tesorero\n                );\n\n                if ( empresa.telefono_tesorero != null) {\n                    let telefono_tesorero = empresa.telefono_tesorero.split('-');\n                    $('#telefono_tesorero').val(telefono_tesorero[0]);\n                    $('#extension_tesorero').val(empresa.telefono_tesorero[1]);\n                }\n                $('#nombre_contacto').val(empresa.nombre_contacto);\n                $('#email_contacto').val(empresa.email_contacto);\n\n                rellenarInputCelular(\n                    empresa.indicativo_celular_contacto,\n                    empresa.codigo_iso2_pais_celular_contacto,\n                    empresa.celular_contacto,\n                    CAMPO_CELULAR_CONTACTO_ID,\n                    campo_celular_contacto\n                );\n\n                empresa_seleccionada = empresa;\n                mostrarPlanes();\n                $('#empresa-tab').click();\n                $('#tabs-empresa').removeClass('d-none');\n                usuarios = empresa.usuarios;\n                mostrarUsuarios(empresa_id);\n                configuraciones_defecto = empresa.configuraciones_defecto;\n                configuraciones_personalizadas = empresa.configuraciones_personalizadas;\n                let archivos = empresa.archivos;\n                $('.contenedor-archivo').addClass('d-none');\n                archivos.forEach((archivo) => {\n                    $('#archivo_' + archivo.nombre).removeClass('d-none');\n                    $('#archivo_' + archivo.nombre).prop('href', '/archivos-abrir/' + archivo.id);\n                });\n\n                mostrarConfiguraciones();\n            },\n            error: function(error) {\n                console.log(error);\n            }\n        });\n    } else if ($('#filtro_empresa_id').val() != '' && $('#filtro_empresa_id').val() != null) {\n        obtenerDatosGestionarEmpresa($('#filtro_empresa_id').val());\n        $('#tabs-empresa').removeClass('d-none');\n    }\n};\n\n/**\n * Actualizar los elementos anchor de previsualización de archivos de la empresa.\n *\n * @param {array} archivos_empresa Arreglo de archivos de la empresa.\n * @param {boolean} reiniciar_campo_archivo Si se debe reiniciar el campo de archivo.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Gonzalez\n */\nfunction actualizarEnlacesPrevisualizacionArchivos(archivos_empresa, reiniciar_campo_archivo = true) {\n    // Oculta todos los elementos anchor de previsualización de archivos.\n    $('.previsualizacion-archivo').addClass('d-none');\n\n    // Muestra los elementos de previsualización de archivos que corresponden con los archivos\n    // relacionados con la empresa.\n    for (let i = 0; i < archivos_empresa.length; i++) {\n        $('#archivo_' + archivos_empresa[i].nombre).prop('href', `/archivos-abrir/${archivos_empresa[i].id}`);\n        $('#archivo_' + archivos_empresa[i].nombre).removeClass('d-none');\n\n        let input_archivo = $('#' + archivos_empresa[i].nombre + '.input-file.input-form');\n        let input_archivo_label = $('label[for=\"' + archivos_empresa[i].nombre + '\"].nombre-archivo');\n        let input_archivo_boton_eliminar = $('#boton-eliminar-archivo-' + archivos_empresa[i].nombre + '.eliminar-archivo');\n\n        if(reiniciar_campo_archivo) {\n            reiniciarCampoArchivo(input_archivo, input_archivo_label, input_archivo_boton_eliminar);\n        }\n    }\n}\n\nfunction mostrarPlanes() {\n    let empresa_id = empresa_seleccionada.id;\n    let buscar = $('#buscador-plan').val();\n    let filtro_tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        tabla_planes.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    let planes = empresa_seleccionada.planes;\n    if (planes.length > 0) {\n        for (let i = 0; i < planes.length; i++) {\n            if (!planes[i].plan || !planes[i].plan.tipo_prueba_id) {\n                continue;\n            }\n            if (\n                (filtro_tipo_prueba_id == 'Todos') ||\n                (filtro_tipo_prueba_id == '1' && planes[i].plan.tipo_prueba_id == 1) ||\n                (filtro_tipo_prueba_id == '2' && planes[i].plan.tipo_prueba_id == 2) ||\n                (filtro_tipo_prueba_id == '3' && planes[i].plan.tipo_prueba_id != 3)\n            ) {\n                let estado = obtenerEstadoPlan(\n                    planes[i].estado.id,\n                    planes[i].estado.nombre,\n                    planes[i].por_facturar,\n                    planes[i].renovando,\n                    null,\n                    planes[i].plan_proximo_id\n                );\n\n                let acciones = obtenerAcciones(\n                    planes[i].estado.id,\n                    planes[i].id, empresa_id,\n                    planes[i].plan.tipo_prueba_id,\n                    planes[i].plan.nombre,\n                    planes[i]?.archivos[0]?.id ?? '0',\n                    empresa_seleccionada.nombre_comercial\n                );\n\n                let modificado = '';\n                if (planes[i].plan_original == 0) {\n                    modificado = `<i class=\"bi bi-wrench me-3 text-blue-40\" ${crearTooltip({placement: 'top', content: 'Plan modificado', toggle: 'popover' })}></i>`;\n                }\n                let fecha_vencimiento = '';\n                if (planes[i].fecha_vencimiento != null) {\n                    fecha_vencimiento = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                }\n                let fecha_creacion = '';\n                if (planes[i].created_at != null) {\n                    fecha_creacion = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                }\n                let fecha_inicio = '';\n                if (planes[i].fecha_inicio != null) {\n                    fecha_inicio = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                }\n                let pruebas_plan = '';\n                if (planes[i].pruebas !== undefined) {\n                    let pruebas = planes[i].pruebas;\n                    for (let j = 0; j < pruebas.length; j++) {\n                        pruebas_plan += `\n                            <div\n                                class=\"col-auto me-3 circulo-prueba\"\n                                style=\"background-image: url(../imagenes/logos/pruebas/${slugify(planes[i].pruebas[j].nombre)}.png)\"\n                                ${crearTooltip({placement: 'top', content: planes[i].pruebas[j].nombre, toggle: 'popover' })}\n                            ></div>\n                        `;\n                    }\n                }\n                let icono = '';\n                let title = '';\n                if (planes[i].plan.tipo_prueba_id == 1) {\n                    title = 'Selección';\n                    icono = 'bi-person-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 2) {\n                    title = 'Organizacional';\n                    icono = 'bi-people-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 3) {\n                    title = 'Vocacional';\n                    icono = 'bi-mortarboard-fill';\n                }\n                let opcion_editar = `\n                    <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit'\">\n                        <i class=\"bi bi-pencil-fill\"></i>\n                    </button>\n                `;\n                if (planes[i]?.plan_proximo_id) {\n                    opcion_editar = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n                            <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                            <div class=\"dropdown-menu\">\n                                <a href=\"/empresas-planes/${planes[i].id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n                                <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n                            </div>\n                        </button>\n                    `;\n                }\n                $('#tbody-planes').append(`\n                    <tr>\n                        <td style=\"border-bottom: 0px!important;\">\n                            <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                    <div class=\"col\">\n                                        <div class=\"row align-items-center\">\n                                            <div class=\"col-auto mb-0\">\n                                                <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                    <i class=\"bi ${icono} me-3\" title=\"${title}\"></i> ${modificado} ${planes[i].plan.nombre}\n                                                </p>\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                ${estado}\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                    <i class=\"bi bi-person-fill\"></i>&nbsp;<span class=\"text-label-2\">${planes[i].cantidad_usuarios}&nbsp;${fecha_vencimiento}</span>\n                                                </p>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n                                                <div class=\"row w-100 m-0\">${pruebas_plan}</div>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n\n                                            </div>\n                                        </div>\n                                    </div>\n                                    <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                        ${opcion_editar}\n                                        ${crearBoton({\n                                            clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                            texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                            adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                        })}\n                                        ${acciones}\n                                    </div>\n                                </div>\n                                <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                    <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-briefcase\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Vacantes: ${planes[i].cantidad_ofertas_laborales !== null ? planes[i].cantidad_ofertas_laborales : ''}</span>\n                                            </p>\n                                        </div>\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-box\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Unidades: ${planes[i].unidades !== null ? planes[i].unidades : ''}</span>\n                                            </p>\n                                        </div>\n                                        <div>\n                                            <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                <i class=\"bi bi-clock\"></i>&nbsp;\n                                                <span class=\"text-label-2\">Tiempo: ${planes[i].vigencia_dias !== null ? planes[i].vigencia_dias : ''} días</span>\n                                            </p>\n                                        </div>\n                                        ${planes[i].usuario ? `\n                                            <div class=\"col-auto\"><i class=\"bi bi-plus-circle\"></i> Creador:</div>\n                                            <div class=\"col-auto me-3 circulo-prueba\" style=\"background-image: url(/usuarios-imagen/${planes[i].usuario.id})\"\n                                                ${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `${planes[i].usuario.nombres} ${planes[i].usuario.apellidos}`,\n                                                    toggle: `popover`,\n                                                })}>\n                                            </div>\n                                            <div class=\"col\">\n                                                <div class=\"row justify-content-end\">\n                                                    <div class=\"col-auto\">\n                                                        ${fecha_creacion}\n                                                        <span class=\"fw-bold ms-3\">${fecha_inicio}</span>\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        ` : ''}\n                                    </div>\n                                    <div class=\"d-flex justify-content-end align-items-end pe-3\">\n                                        <p class=\"text-label-2 mb-0\">\n                                            <span class=\"text-gray-50 me-3\">${fecha_creacion}</span>\n                                            <span class=\"text-gray-30\">${fecha_inicio}</span>\n                                        </p>\n                                    </div>\n                                </div>\n                            </div>\n                        </td>\n                    </tr>\n                `);\n            }\n        }\n\n        // Mostrar cards de planes de créditos\n        let planes_creditos_mostrados = [];\n        for (let i = 0; i < planes.length; i++) {\n            if (planes[i].plan_credito && planes[i].plan_credito.id) {\n                // Evitar duplicados de plan_credito\n                if (!planes_creditos_mostrados.includes(planes[i].plan_credito.id)) {\n                    planes_creditos_mostrados.push(planes[i].plan_credito.id);\n\n                    let plan_credito = planes[i].plan_credito;\n                    let creditos_totales = planes[i].creditos !== null ? planes[i].creditos : 0;\n                    let creditos_restantes = planes[i].creditos_restantes !== null ? planes[i].creditos_restantes : 0;\n                    let creditos_promedio = empresa_seleccionada.creditos_promedio_accion || 0;\n                    let acciones_estimadas = creditos_restantes > 0 && creditos_promedio > 0\n                        ? Math.floor(creditos_restantes / creditos_promedio)\n                        : 0;\n\n                    let estado_credito = creditos_restantes > 0\n                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n\n                    let indicador_proximo_credito = '';\n                    if (planes[i]?.plan_proximo_id) {\n                        indicador_proximo_credito = `<span class=\"tag tag-sm tag-tonal-purple ms-2\">Próximo disponible</span>`;\n                    }\n\n                    let precio_informacion= '';\n                    if (plan_credito.precio) {\n                        precio_informacion= `$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}`;\n                        if (plan_credito.porcentaje_descuento && plan_credito.precio_con_descuento) {\n                            precio_informacion= `<span class=\"text-decoration-line-through text-gray-50\">$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}</span>\n                                          <span class=\"text-green-40 ms-2\">$${parseFloat(plan_credito.precio_con_descuento).toLocaleString('es-CO')}</span>\n                                          <span class=\"tag tag-sm tag-tonal-green ms-2\">-${plan_credito.porcentaje_descuento}%</span>`;\n                        }\n                    }\n\n                    let fecha_promocion = '';\n                    if (plan_credito.fecha_inicio_promocion && plan_credito.fecha_fin_promocion) {\n                        fecha_promocion = `Promoción: ${obtenerFecha(plan_credito.fecha_inicio_promocion)} - ${obtenerFecha(plan_credito.fecha_fin_promocion)}`;\n                    }\n\n                    let fecha_creacion_credito = '';\n                    if (planes[i].created_at != null) {\n                        fecha_creacion_credito = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                    }\n\n                    let fecha_activacion_credito = '';\n                    if (planes[i].fecha_inicio != null) {\n                        fecha_activacion_credito = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                    }\n\n                    let fecha_vencimiento_credito = '';\n                    if (planes[i].fecha_vencimiento != null) {\n                        fecha_vencimiento_credito = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                    }\n\n                    let opcion_editar_credito = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n                            <i class=\"bi bi-pencil-fill\"></i>\n                        </button>\n                    `;\n                    if (planes[i]?.plan_proximo_id) {\n                        opcion_editar_credito = `\n                            <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n                                <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                                <div class=\"dropdown-menu\">\n                                    <a href=\"/empresas-planes/${planes[i].id}/edit?tipo=creditos\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n                                    <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit?tipo=creditos\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n                                </div>\n                            </button>\n                        `;\n                    }\n\n                    let acciones_credito = obtenerAccionesCreditos(\n                        planes[i].estado.id,\n                        planes[i].id,\n                        empresa_id,\n                        planes[i]?.archivos[0]?.id ?? '0',\n                        empresa_seleccionada.nombre_comercial,\n                        plan_credito.nombre,\n                        plan_credito.creditos,\n                        planes[i].creditos_restantes ?? null\n                    );\n\n                    $('#tbody-planes').append(`\n                        <tr>\n                            <td style=\"border-bottom: 0px!important;\">\n                                <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                    <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                        <div class=\"col\">\n                                            <div class=\"row align-items-center\">\n                                                <div class=\"col-auto mb-0\">\n                                                    <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                        <i class=\"bi bi-coin me-3\" title=\"Plan de Créditos\"></i> ${plan_credito.nombre}\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    ${estado_credito}\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-12 mt-3\">\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                            ${opcion_editar_credito}\n                                            ${crearBoton({\n                                                clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                                texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                                adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                            })}\n                                            ${acciones_credito}\n                                        </div>\n                                    </div>\n                                    <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                        <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos disponibles: ' + creditos_restantes.toLocaleString('es-CO'),\n                                            })}\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos promedio por acción: ' + creditos_promedio.toLocaleString('es-CO'),\n                                            })}\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                                            })}\n                                        </div>\n                                        <div class=\"d-flex justify-content-end align-items-end pe-3\">\n                                            <p class=\"text-label-2 mb-0\">\n                                                <span class=\"text-gray-50 me-3\">${fecha_creacion_credito}</span>\n                                                <span class=\"text-gray-30\">${fecha_activacion_credito}</span>\n                                            </p>\n                                        </div>\n                                    </div>\n                                </div>\n                            </td>\n                        </tr>\n                    `);\n                }\n            }\n        }\n\n        inicializarTooltips();\n        tabla_planes = $('#tabla-planes').DataTable({\n            \"paging\": false,\n            \"searching\": true,\n            \"ordering\": false,\n            \"info\": false\n        });\n        let buscador = $('#tabla-planes_wrapper input');\n        $(buscador).addClass('rounded-2 text-body-2');\n        $(buscador).prop('placeholder', 'Buscar');\n        $(buscador).prop('id', 'buscador-plan');\n        $('#input-busqueda').append(buscador);\n        $(buscador).val(buscar).trigger('input');\n    } else {\n        $('#fila-cabecera-tabla-planes').remove();\n        $('#tbody-planes').append(`\n            <tr class=\"w-100 d-flex justify-content-center align-items-center\" style=\"height: 480px;\">\n                <td class=\"d-flex justify-content-center align-items-center flex-column row-gap-4\">\n                    <p class=\"text-center text-gray-60 m-0\" style=\"font-size: 80px;\"><i class=\"bi bi-slash-circle m-0 p-0\"></i></p>\n                    <div class=\"m-0\">\n                        <p class=\"text-center text-body-2 text-gray-30 fs-4 mb-3\">Aún no hay planes asignados</p>\n                        <p class=\"text-center text-body-2 text-gray-30 mb-0\">Comienza ahora</p>\n                    </div>\n                    ${crearBoton({\n                        id: 'boton-asignar-plan',\n                        type: 'button',\n                        clases: 'btn-primary',\n                        texto: 'Asignar plan',\n                        url: `/asignar-plan/${empresa_id}`\n                    })}\n                </td>\n            </tr>\n        `);\n    }\n}\n\nfunction obtenerFecha(fecha) {\n    let fecha_obj = new Date(fecha);\n    let dia = ('0' + fecha_obj.getUTCDate()).slice(-2);\n    let mes = ('0' + (fecha_obj.getUTCMonth() + 1)).slice(-2);\n    let año = fecha_obj.getUTCFullYear();\n    return `${dia}/${mes}/${año}`;\n}\n\nfunction obtenerEstadoPlan(estado_id, nombre, por_facturar = 0, renovando = 0, empresa_plan_id = null, proximo = false) {\n\n    let detalle_empresa_plan = '';\n    if (empresa_plan_id != null) {\n        detalle_empresa_plan = `onclick=\"abrirDetallePlan(${empresa_plan_id})\"`;\n    }\n    let badge_proximo = '';\n    if (proximo) {\n        badge_proximo = `<span class=\"position-absolute badge badge-proximo bg-purple rounded-pill text-label-2 py-0 px-1 fw-normal\"><div class=\"text-white texto-proximo\">Próximo: </div>+1</span>`;\n    }\n    let estado = '';\n    if (por_facturar == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-por-facturar text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>Por facturar${badge_proximo}</span>`;\n    } else if (renovando == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-renovado text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>Renovando${badge_proximo}</span>`;\n    } else if (estado_id == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-activo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 2) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-inactivo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 3) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-proximo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 4) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-por-vencer text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 5) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-vencido text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    }\n\n    return estado;\n}\n\n/**\n * Obtener las acciones para la tabla de recompras.\n *\n * @param {number} estado_id Id del estado\n * @param {number} id Id del plan\n * @param {number} empresa_id Id de la empresa\n * @param {number} tipo_prueba_id Id del tipo de prueba\n * @param {string} tipo_prueba_nombre Nombre del tipo de prueba\n * @param {number} id_archivo Id del archivo\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa\n * @returns {string}\n * @author José Manuel Jimenez\n * @author Fahibram Cárcamo\n */\nfunction obtenerAcciones(estado_id, id, empresa_id, tipo_prueba_id, tipo_prueba_nombre, id_archivo, nombre_comercial_empresa) {\n\n    let acciones_html = '<ul class=\"dropdown-menu py-1\">';\n\n    if ([1, 4, 5].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\">\n            <button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"generarEnlaceCreacion(${id})\">Renovar</button>\n        </li>`;\n    }\n\n    acciones_html += `\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"window.location = '/facturar-plan/${id}'\">Facturación de recompra</button>\n        </li>\n        <li class=\"py-1\">\n            <button\n                type=\"button\"\n                class=\"dropdown-item text-body-2 text-gray-30\"\n                onclick=\"abrirHistorialRecompras(${empresa_id}, ${tipo_prueba_id}, '${tipo_prueba_nombre}', '${nombre_comercial_empresa}')\"\n            >\n                Historial de recompras\n            </button>\n        </li>\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"abrirFacturaPlan(${id_archivo})\">Ver factura</button>\n        </li>\n    `;\n\n    if ([1, 3].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-danger\" type=\"button\" onclick=\"eliminar(${id})\">Eliminar</button></li>`;\n    }\n\n    acciones_html += '</ul>';\n\n    return acciones_html;\n}\n\n/**\n * Generar acciones para planes de creditos.\n *\n * @param {number} estado_id Id del estado del plan.\n * @param {number} id Id del plan de empresa.\n * @param {number} empresa_id Id de la empresa.\n * @param {number} id_archivo Id del archivo.\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa\n * @returns {string}\n * @author Jose Manuel Jimenez\n * @author Fahibram Carcamo\n * @author Sergio Vargas\n */\nfunction obtenerAccionesCreditos(estado_id, id, empresa_id, id_archivo, nombre_comercial_empresa, nombre_plan, creditos, creditos_restantes) {\n\n    let acciones_html = '<ul class=\"dropdown-menu py-1\">';\n\n    if ([1, 4, 5].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\">\n            <button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"generarEnlaceCreacion(${id})\">Renovar</button>\n        </li>`;\n    }\n\n    acciones_html += `\n        <li class=\"py-1\">\n            <button\n                type=\"button\"\n                class=\"dropdown-item text-body-2 text-gray-30\"\n                onclick=\"abrirHistorialRecomprasCreditos(${empresa_id}, '${nombre_comercial_empresa}')\"\n            >\n                Historial de recompras\n            </button>\n        </li>\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"abrirFacturaPlan(${id_archivo})\">Ver factura</button>\n        </li>\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"abrirDetallePlanCreditos(${empresa_id}, '${nombre_plan}', ${creditos})\">Ver consumo</button>\n        </li>\n    `;\n\n    if ([1, 2, 3].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"inactivar(${id})\">Inactivar</button></li>`;\n    }\n\n    if ([1, 3].includes(estado_id) && creditos_restantes != null && creditos_restantes == creditos) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-danger\" type=\"button\" onclick=\"eliminar(${id})\">Eliminar</button></li>`;\n    }\n\n    acciones_html += '</ul>';\n\n    return acciones_html;\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    }\n}\n\nfunction abrirAcciones(elemento) {\n    $(elemento).parent().find('.acciones-lista').removeClass('d-none');\n}\n\n$(document).mouseup(function(e) {\n    var acciones = $(\".acciones-lista\");\n    if (!acciones.is(e.target) && acciones.has(e.target).length === 0) {\n        $(\".acciones-lista\").addClass('d-none');\n    }\n});\n\n/**\n * Agrega los usuarios a la tabla de usuarios.\n *\n * @param {number} empresa_id Id de la empresa o sucursal.\n * @returns {void}\n * @author Jose Jimenez\n * @author Fahibram Cárcamo\n * @author Andres Gonzalez\n */\nasync function mostrarUsuarios(empresa_id) {\n    let filtrar_usuarios = $('#filtrar-usuarios').val();\n    if ($.fn.DataTable.isDataTable('#tabla-usuarios')) {\n        tabla_usuarios.destroy();\n    }\n    $('#buscador-usuario').remove();\n    $('#tbody-usuarios').empty();\n    for (let i = 0; i < usuarios.length; i++) {\n        if (\n            usuarios[i].usuario != undefined &&\n            (\n                (filtrar_usuarios == 'Todos') ||\n                (filtrar_usuarios == '1' && usuarios[i].usuario.estado.id == 1) ||\n                (filtrar_usuarios == '2' && usuarios[i].usuario.estado.id == 2)\n            )\n        ) {\n            let estado = `\n                <div class=\"col-12 text-gray-30 text-end\">\n                    <span class=\"me-3\">Inactivo</span>\n                    <div class=\"custom-switch\">\n                        <input type=\"checkbox\" id=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-input\" onclick=\"activarOInactivarUsuarios(this.checked, ${usuarios[i].usuario.id})\">\n                        <label for=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-label\"></label>\n                    </div>\n                </div>\n            `;\n            if (usuarios[i].usuario.estado.id == 1) {\n                estado = `\n                    <div class=\"col-12 text-gray-30 text-end\">\n                        <span class=\"me-3\">Activo</span>\n                        <div class=\"custom-switch\">\n                            <input type=\"checkbox\" id=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-input\" onclick=\"activarOInactivarUsuarios(this.checked, ${usuarios[i].usuario.id})\" checked>\n                            <label for=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-label\"></label>\n                        </div>\n                    </div>\n                `;\n            }\n            let checked = '';\n            if (usuarios_seleccionados.includes(usuarios[i].usuario.id)) {\n                checked = 'checked';\n            }\n            $('#tbody-usuarios').append(`\n                <tr>\n                    <td style=\"border-bottom: 0px!important;\">\n                        <div class=\"border border-1 rounded rounded-3\">\n                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6 align-items-center\">\n                                <div class=\"col-auto\">\n                                    <div class=\"check-container my-1 me-1\">\n                                        <input type=\"checkbox\" class=\"form-check-input\" value=\"${usuarios[i].usuario.id}\" ${checked} onclick=\"seleccionarUsuario(this.value, this.checked);\">\n                                    </div>\n                                </div>\n                                <div class=\"col-auto w-120px px-0 text-center text-headline-7 text-gray-30\">\n                                    <div class=\"row justify-content-center mb-1\">\n                                        <div class=\"imagen-usuario\" style=\"background-image: url(/usuarios-imagen/${usuarios[i].usuario.id})\"></div>\n                                    </div>\n                                    ${usuarios[i]?.usuario?.ciudad?.nombre ?? ''}, ${usuarios[i]?.usuario?.ciudad?.departamento?.pais.nombre ?? ''}\n                                </div>\n                                <div class=\"col ps-lg-4\">\n                                    <div class=\"row w-100 mx-0\">\n                                        <div class=\"col-12 mb-0 text-gray-10 text-headline-5\">\n                                            ${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos} | <span class=\"text-headline-7 mb-0\">${obtenerEdad(usuarios[i].usuario.fecha_nacimiento)}</span>\n                                        </div>\n                                        <div class=\"col-12 mt-2 text-gray-50 text-headline-7\">\n                                            Rol: ${usuarios[i]?.rol?.name ?? ''} <span class=\"ms-3\">Cargo:</span> ${usuarios[i]?.usuario?.cargo?.nombre ?? ''}\n                                        </div>\n                                        <div class=\"col-12 mt-3 text-gray-30 text-headline-7\">\n                                            <i class=\"bi bi-envelope me-1\"></i> ${usuarios[i]?.usuario?.email} <i class=\"bi bi-telephone ms-4 me-1\"></i> ${usuarios[i]?.usuario?.telefono}\n                                        </div>\n                                        <div class=\"col-12 mt-1 text-gray-30 text-headline-7\">\n                                            <i class=\"bi bi-person-vcard me-1\"></i> ${usuarios[i]?.usuario?.tipo_documento?.abreviatura} ${usuarios[i]?.usuario?.documento}\n                                        </div>\n                                    </div>\n                                </div>\n                                <div class=\"col-auto\">\n                                    <div class=\"row\">\n                                        ${estado}\n                                        <input type=\"hidden\" id=\"usuario_id_${usuarios[i].usuario.id}\" value=\"${usuarios[i].usuario.eliminar}\">\n                                        <div class=\"col-12 pt-4 position-relative d-flex justify-content-end text-gray-30\">\n                                            <div class=\"acciones-lista bg-white rounded-4 py-2 position-absolute shadow d-none\" style=\"width: 260px; right: 0; z-index: 1000;\">\n                                                <div class=\"row m-0 w-100\">\n                                                    <div class=\"col-12 pointer py-3 h6 mb-0\" title=\"Generar acceso\" onclick=\"generarAccesoUsuarios(${usuarios[i].usuario.id});\">Generar acceso</div>\n                                                    <div class=\"col-12 pointer py-3 h6 mb-0\" title=\"Ver uso\" onclick=\"abrirHistorialCambiosUsuario(${usuarios[i].usuario.id}, '${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}', true)\">Historial de cambios</div>\n                                                    ${ usuarios[i].usuario.eliminar ? `<div class=\"col-12 pointer py-3 h6 mb-0 text-danger\" title=\"Eliminar\" onclick=\"abrirModalConfirmarEliminarUsuarios(${usuarios[i].usuario.id}, '${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}');\">Eliminar</div>` : '' }\n                                                </div>\n                                            </div>\n                                            <button\n                                                type=\"button\"\n                                                title=\"Editar\"\n                                                class=\"btn btn-text-primary-border text-white btn-circle\"\n                                                onclick=\"window.location.href='/usuarios/${usuarios[i].usuario.id}/edit?rol_id=${usuarios[i].rol.id}&empresa_id=${empresa_id}'\"\n                                            >\n                                                <i class=\"bi bi-pencil\"></i>\n                                            </button>\n                                            <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle ms-3\" onclick=\"abrirAcciones(this);\">\n                                                <i class=\"bi bi-three-dots-vertical\"></i>\n                                            </button>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </td>\n                </tr>\n            `);\n        }\n    }\n    tabla_usuarios = $('#tabla-usuarios').DataTable({\n        \"paging\": true,\n        \"searching\": true,\n        \"ordering\": false,\n        \"info\": true,\n        \"language\": lenguajeDatatables,\n        \"lengthMenu\": [ [10, 25, 50, 100, 200], [10, 25, 50, 100, 200] ],\n    });\n    mostrarComponenteNumeroRegistrosTabla('tabla-usuarios');\n    mostrarComponenteBuscarTabla('tabla-usuarios');\n    validarCheckUsuariosSeleccionados();\n}\n\nfunction seleccionarTodosUsuarios(checked) {\n    usuarios_seleccionados = [];\n    if (checked) {\n        for (let i = 0; i < usuarios.length; i++) {\n            usuarios_seleccionados.push(usuarios[i].usuario.id);\n        }\n    }\n    mostrarUsuarios();\n}\n\nfunction seleccionarUsuario(usuario_id, checked) {\n    if (checked) {\n        if (!usuarios_seleccionados.includes(parseInt(usuario_id))) {\n            usuarios_seleccionados.push(parseInt(usuario_id));\n        }\n    } else {\n        usuarios_seleccionados = usuarios_seleccionados.filter(id => id !== parseInt(usuario_id));\n    }\n    validarCheckUsuariosSeleccionados();\n}\n\nfunction validarCheckUsuariosSeleccionados() {\n    if (usuarios_seleccionados.length == 0) {\n        $('#check-seleccionar-todos').prop('indeterminate', false);\n        $('.botones-usuarios').prop('disabled', true);\n        $('#check-seleccionar-todos').prop('checked', false);\n    } else if (usuarios_seleccionados.length == usuarios.length) {\n        $('.botones-usuarios').prop('disabled', false);\n        $('#check-seleccionar-todos').prop('indeterminate', false);\n        $('#check-seleccionar-todos').prop('checked', true);\n    } else {\n        $('.botones-usuarios').prop('disabled', false);\n        $('#check-seleccionar-todos').prop('indeterminate', true);\n    }\n    $('#cantidad-seleccionados').text(usuarios_seleccionados.length);\n}\n\nfunction actualizarDataUsuarios() {\n    $.ajax({\n        type : 'GET',\n        url : `/empresas-gestionar-datos/${empresa_seleccionada.id}`,\n        processData: false,\n        contentType: false,\n        success: function(respuesta) {\n            let empresa = respuesta.data;\n            usuarios = empresa.usuarios;\n            mostrarUsuarios();\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Función para obtener edad actual de un usuario segun su fecha de nacimiénto\n *\n * @param {string} fecha_nacimiento\n * @return {string}\n * @author José Manuel Jiménez\n */\nfunction obtenerEdad(fecha_nacimiento) {\n    if (!fecha_nacimiento) {\n        return \"\";\n    }\n    const hoy = new Date();\n    const nacimiento = new Date(fecha_nacimiento);\n    let edad = hoy.getFullYear() - nacimiento.getFullYear();\n    const mes = hoy.getMonth() - nacimiento.getMonth();\n    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {\n        edad--;\n    }\n    return edad + \" años\";\n}\n\n/**\n * Abrir el historial de recompras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {string} tipo_prueba_id ID del tipo de prueba.\n * @param {string} tipo_prueba_nombre Nombre del tipo de prueba.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nasync function abrirHistorialRecompras(empresa_id, tipo_prueba_id, tipo_prueba_nombre, nombre_comercial_empresa) {\n    destruirTablaExistente('tabla-historial-recompras');\n    $('#nombre-tipo-prueba').text(tipo_prueba_nombre);\n    $('#tabla-historial-recompras').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: true,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 450px)',\n        scrollCollapse: true,\n        ajax: {\n            url : '/planes-historial-recompras',\n            data: function (datos) {\n                datos.empresa_id = empresa_id;\n                datos.tipo_prueba_id = tipo_prueba_id;\n            },\n            dataSrc: function (json) {\n                return Object.values(json.data);\n            }\n        },\n        columns: [\n            {\n                title: '<span class=\"text-body-3\">Plan</span>',\n                data: 'plan.nombre',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: (data, type, row) => `\n                    <div class=\"d-flex\">\n                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n                                data: [{ texto: 'id', value: row.id }],\n                            })}\n                        </div>\n                        &nbsp;&nbsp;\n                        <div class=\"col d-flex align-items-center pe-0\">\n                            ${\n                                row.plan_original == 0\n                                    ? `\n                                        <span\n                                            class=\"text-primary me-3\"\n                                            style=\"cursor: pointer\"\n                                            ${crearTooltip({ placement: 'bottom', content: 'Plan modificado', toggle: 'popover'})}\n                                        >\n                                            <i class=\"bi bi-wrench\"></i>\n                                        </span>\n                                    `\n                                    : ''\n                            }\n                            <span class=\"text-body-3\">${data}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Creación</span>',\n                data: 'created_at',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Activación</span>',\n                data: 'fecha_inicio',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Vencimiento</span>',\n                data: 'fecha_vencimiento',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Uso de unidades</span>',\n                data: 'conteo_total_consumos_agendas_empresa_sucursales',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    return `${data}/${row.unidades}`;\n                }\n            },\n            // Por el momento no se mostrará el conteo de consumos ni nada relacionado con ofertas laborales.\n            // {\n            //     title: '<span class=\"text-body-3\">Uso de ofertas</span>',\n            //     data: 'conteo_total_consumos_ofertas_laborales_empresa_sucursales',\n            //     className: 'text-body-3 text-center',\n            //     orderable: false,\n            //     searchable: true,\n            //     render: function (data, type, row) {\n            //         return `${data}/${row.cantidad_ofertas_laborales}`;\n            //     }\n            // },\n            {\n                title: '<span class=\"text-body-3\">Uso de tiempo</span>',\n                data: 'vigencia_dias',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data, type, row) {\n                    let fecha_hora_actuales = moment();\n                    let fecha_hora_inicio = moment(row.fecha_inicio);\n                    let dias_consumidos = fecha_hora_actuales.clone().diff(fecha_hora_inicio.clone(), 'days');\n\n                    if (row.fecha_vencimiento == null) {\n                        return `${dias_consumidos}/Ilimitado`;\n                    } else {\n                        let fecha_hora_vencimiento = moment(row.fecha_vencimiento);\n                        if (fecha_hora_actuales.clone().isAfter(fecha_hora_vencimiento.clone(), 'day')) return `${row.vigencia_dias}/${row.vigencia_dias}`;\n                        else return dias_consumidos > row.vigencia_dias ? `${row.vigencia_dias}/${row.vigencia_dias}` : `${dias_consumidos}/${row.vigencia_dias}`;\n                    }\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Adjunto</span>',\n                data: null,\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data) {\n                    let archivo_factura = data.archivos !== undefined && data.archivos !== null && data.archivos.length ? data.archivos[0] : null;\n\n                    if (archivo_factura === null) return '---';\n\n                    let arreglo_ruta_archivo = archivo_factura.ruta.split('/');\n                    let nombre_archivo_factura = arreglo_ruta_archivo[arreglo_ruta_archivo.length - 1];\n                    let indice_ultimo_punto = nombre_archivo_factura.lastIndexOf('.');\n\n                    if (indice_ultimo_punto === -1) return '---';\n\n                    let nombre_archivo_factura_sin_extension = nombre_archivo_factura.substring(0, indice_ultimo_punto);\n                    let extension_archivo_factura = nombre_archivo_factura.substring(indice_ultimo_punto);\n                    let nombre_archivo_factura_truncado = nombre_archivo_factura_sin_extension.substring(0, 6);\n\n                    return `${\n                        crearBoton({\n                            clases: 'btn-text-primary text-decoration-underline',\n                            onclick: `descargarFactura(${archivo_factura.id})`,\n                            texto: `${nombre_archivo_factura_truncado}...${extension_archivo_factura}`,\n                            tooltip: `${crearTooltip({placement: `bottom`,content: `${nombre_archivo_factura}`, toggle: 'popover' })}`\n                        })\n                    }`;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data, type, row) {\n                    return `${\n                        crearBoton({\n                            clases: 'btn-text-primary btn-circle',\n                            texto: '<i class=\"bi bi-eye\"></i>',\n                            onclick: `abrirModalConsumosRecompra(${row.id}, '${row.plan.nombre}', '${nombre_comercial_empresa}')`,\n                            tooltip: `${crearTooltip({placement: `bottom`,content: 'Ver consumo', toggle: 'popover' })}`\n                        })\n                    }`;\n                }\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n\n    $('#boton-descargar-historial-recompras').off('click');\n    $('#boton-descargar-historial-recompras').on(\n        'click',\n        evento => {\n            evento.preventDefault();\n            descargarExcel('planes-historial-recompras-exportar', 'historial-de-recompras', true, {empresa_id});\n        }\n    );\n\n    $('#modal-historial-recompras').modal('show');\n    ajustarRenderDataTable('tabla-historial-recompras');\n    cargarDataTablas();\n    $('#buscador-tabla-historial-recompras input.dt-input:not(:last)').remove();\n    $(\".acciones-lista\").addClass('d-none');\n}\n\n/**\n * Abrir el historial de recompras de creditos IA.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa.\n * @returns {void}\n * @author Sergio Vargas\n * @author José Manuel Jiménez\n */\nasync function abrirHistorialRecomprasCreditos(empresa_id, nombre_comercial_empresa) {\n    $('#modal-historial-recompras-creditos').modal('show');\n    $('#contenedor-tabla-historial-recompras-creditos').empty();\n    $('#contenedor-tabla-historial-recompras-creditos').append(`\n        ${crearTabla({\n            id: 'tabla-historial-recompras-creditos',\n            registros_paginas: true,\n            buscador_datatable: true,\n            class_tabla: 'mt-3',\n            buscador: {\n                icono: '<i class=\"bi bi-search input-icono1\"></i>',\n            },\n            botones: `\n                <div class=\"col-auto\">\n                    ${crearBoton({\n                        id: 'boton-descargar-historial-recompras-creditos',\n                        clases: 'btn-green-excel',\n                        texto: '<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo',\n                        onclick: `descargarExcel('planes-historial-creditos-exportar/${empresa_id}', 'historial-creditos-ia', true)`\n                    })}\n                </div>\n            `\n        })}\n    `);\n    $('#tabla-historial-recompras-creditos').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [10, 25, 50, 100],\n            [10, 25, 50, 100]\n        ],\n        scrollX: true,\n        ajax: {\n            url: `/planes-historial-recompras-creditos/${empresa_id}`,\n        },\n        columns: [\n            {\n                title: 'Plan',\n                data: null,\n                render: (row) => row.plan_credito?.nombre ?? '---'\n            },\n            {\n                title: 'Creacion',\n                data: 'created_at',\n                render: (data) => data ? obtenerFecha(data) : '---'\n            },\n            {\n                title: 'Activacion',\n                data: 'fecha_inicio',\n                render: (data) => data ? obtenerFecha(data) : '---'\n            },\n            {\n                title: 'Vencimiento',\n                data: 'fecha_vencimiento',\n                render: (data) => data ? obtenerFecha(data) : '---'\n            },\n            {\n                title: 'Creditos',\n                data: null,\n                render: (row) => {\n                    const total = row.creditos ?? row.plan_credito?.creditos ?? 0;\n                    return total.toLocaleString('es-CO');\n                }\n            },\n            {\n                title: 'Consumidos',\n                data: null,\n                render: (row) => (row.creditos_consumidos ?? 0).toLocaleString('es-CO')\n            },\n            {\n                title: 'Restantes',\n                data: null,\n                render: (row) => {\n                    const total = row.creditos ?? row.plan_credito?.creditos ?? 0;\n                    const consumidos = row.creditos_consumidos ?? 0;\n                    return Math.max(0, total - consumidos).toLocaleString('es-CO');\n                }\n            },\n            {\n                title: 'Estado',\n                data: null,\n                render: (row) => row.estado?.nombre ?? '---'\n            },\n            {\n                title: 'Valor de venta',\n                data: null,\n                render: (row) => row.precio ? `$${parseFloat(row.precio).toLocaleString('es-CO')}` : '---'\n            }\n        ]\n    });\n    cargarDataTablas();\n}\n\n/**\n * Abrir la ventana modal de consumos de un plan de empresa.\n *\n * @param {number} empresa_plan_id Id del registro de la tabla empresas_planes.\n * @param {string} nombre_plan Nombre del plan.\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalConsumosRecompra(empresa_plan_id, nombre_plan, nombre_comercial_empresa) {\n    $('#modal-historial-recompras').modal('hide');\n    abrirModalConsumosEmpresaPlan(empresa_plan_id, nombre_plan, nombre_comercial_empresa);\n}\n\n/**\n * Renderiza el contenido de las subtablas.\n *\n * @param {array} data Array de datos a renderizar.\n * @returns {string} HTML de la subtabla.\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction crearContenidoSubTabla(data) {\n    return `\n        <div class=\"d-flex flex-column row-gap-3 w-100 p-6\">\n            <div class=\"d-flex column-gap-5\">\n                <p class=\"m-0\">Costo<br>${formatearNumero(data.precio)}</p>\n                <p class=\"m-0\">Descuento<br>${data.porcentaje_descuento ?? '0'}%</p>\n                <p class=\"m-0\">\n                    Precio de venta\n                    <br>\n                    ${formatearNumero(data.porcentaje_descuento !== null ? (data.precio * (1 - parseInt(data.porcentaje_descuento)/100)) : data.precio)}\n                </p>\n            </div>\n            ${data.comentario == null ? '' : `<div class=\"d-flex flex-column\"><p class=\"m-0\">Detalle de uso<br>${data.comentario}</p></div>`}\n        </div>\n    `;\n}\n\n/**\n * Descargar documento de la factura de un plan.\n *\n * @param {number} id Id del archivo de la factura.\n * @returns {Promise<void>}\n * @author Fahibram Cárcamo\n */\nfunction descargarFactura(id) {\n    $.ajax({\n        type: 'POST',\n        url : `/empresas-planes-descargar-factura/${id}`,\n        data: { _token: $('meta[name=\"csrf-token\"]').attr('content') },\n        xhrFields: {\n            responseType: 'blob'\n        },\n        success: function (respuesta) {\n            let url = window.URL.createObjectURL(respuesta);\n            let a   = document.createElement('a');\n            a.href  = url;\n\n            a.download = `archivo_de_factura_${id}.pdf`;\n            document.body.appendChild(a);\n            a.click();\n            window.URL.revokeObjectURL(url);\n            document.body.removeChild(a);\n        }\n    }).then(() => {\n        mostrarToast('success', 'PDF generado correctamente.');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al descargar el archivo.');\n    });\n}\n\n/**\n * Inactivar plan de empresa.\n *\n * @param {number} id ID del plan de empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function inactivar(id) {\n    await $.ajax({\n        type: 'POST',\n        url : `/empresas-planes-actualizar/${id}`,\n        data: {\n            _token   : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method  : 'PATCH',\n            estado_id: 2\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', respuesta.message);\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\n/**\n * Generar acceso para usuarios.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function generarAccesoUsuarios(usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-generar-acceso`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n            ids   : usuarios_enviar // IDs de los usuarios seleccionados\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', `Acceso generado correctamente`);\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\n/**\n * Activar o inactivar usuarios.\n *\n * @param {boolean} activar Indica si se deben activar o inactivar los usuarios.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function activarOInactivarUsuarios(activar = true, usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-actualizar-multiples`,\n        data: {\n            _token   : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method  : 'PATCH',\n            ids      : usuarios_enviar, // IDs de los usuarios seleccionados\n            estado_id: activar ? 1 : 2\n        }\n    }).then((respuesta) => {\n        if (activar) {\n            mostrarToast('success', `Usuario(s) activados con éxito`);\n        } else {\n            mostrarToast('success', `Usuario(s) inactivados con éxito`);\n        }\n        actualizarDataUsuarios();\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\nusuario_id_eliminar = null;\nusuario_nombre_eliminar = '';\n\n/**\n * Función que abre el modal para confirmar la eliminación de usuarios.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction abrirModalConfirmarEliminarUsuarios(usuario_id = null, nombre_usuario = '') {\n    usuario_id_eliminar = usuario_id;\n    let detener_proceso = true;\n\n    for (let elemento of usuarios_seleccionados) {\n        let bandera_usuario = $(`#usuario_id_${elemento}`).val();\n        if (bandera_usuario === 'false' || bandera_usuario === false) {\n            detener_proceso = false;\n            break;\n        }\n    }\n\n    if (detener_proceso) {\n        usuario_nombre_eliminar = nombre_usuario;\n        if (nombre_usuario == '') {\n            nombre_usuario = 'Se van a eliminar ' + usuarios_seleccionados.length + ' usuario(s)';\n        } else {\n            nombre_usuario = 'Se eliminará el usuario ' + nombre_usuario;\n        }\n        $('#nombre-confirmar-eliminacion').text(nombre_usuario);\n        $('#modal-confirmar-eliminacion').modal('show');\n    }else{\n        mostrarToast('danger', 'No es posible eliminar el usuario o los usuarios seleccionados porque tienen relaciones con otros módulos.');\n    }\n\n}\n\n/**\n * Confirmar la eliminación de usuarios.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction confirmarEliminarUsuarios() {\n    eliminarUsuarios(usuario_id_eliminar);\n}\n\n/**\n * Eliminar usuarios.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function eliminarUsuarios(usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-eliminar-multiples`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n            ids   : usuarios_enviar\n        }\n    }).then((respuesta) => {\n        if (respuesta.message == 'Usuarios eliminados correctamente' && usuarios_enviar.length == 1 && respuesta.data == 0) {\n            mostrarToast('success', `Usuario eliminado correctamente`);\n        } else if (respuesta.message == 'Usuarios eliminados correctamente' && respuesta.data == 0) {\n            mostrarToast('success', `Usuarios eliminados correctamente`);\n        } else {\n            mostrarToast('neutral', `Algunos usuarios no fueron eliminados, puede que tengan auditorías.`);\n        }\n        usuarios_seleccionados = usuarios_seleccionados.filter(usuario => !usuarios_enviar.includes(usuario));\n        usuario_id_eliminar = null;\n        usuario_nombre_eliminar = '';\n        $('#modal-confirmar-eliminacion').modal('hide');\n        actualizarDataUsuarios();\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\nbuscar_usuario_id = null;\nbuscar_usuario_nombre = null;\n\n/**\n * Abrir el historial de cambios de un usuario.\n *\n * @param {number} id ID del usuario.\n * @param {string} nombre Nombre del usuario.\n * @param {boolean} limpiar True para limpiar los filtros de la tabla.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nasync function abrirHistorialCambiosUsuario(id, nombre, limpiar = false) {\n    if (limpiar) {\n        $('#filtro_tipo_accion').val('').trigger('change').trigger('select2:select');\n        $('#filtro_fecha_hora').val('');\n    }\n\n    buscar_usuario_id = id;\n    buscar_usuario_nombre = nombre;\n\n    const TITULOS_CAMPOS = {\n        id                                         : 'ID',\n        empresa_id                                 : 'Empresa',\n        area_id                                    : 'Área',\n        cargo_id                                   : 'Cargo',\n        tipo_documento_id                          : 'Tipo de documento',\n        genero_id                                  : 'Género',\n        ciudad_id                                  : 'Ciudad',\n        estado_id                                  : 'Estado',\n        nombres                                    : 'Nombres',\n        apellidos                                  : 'Apellidos',\n        documento                                  : 'Número de documento',\n        email                                      : 'Correo electrónico',\n        email_secundario                           : 'Correo electrónico corporativo',\n        fecha_nacimiento                           : 'Fecha de nacimiento',\n        direccion                                  : 'Dirección',\n        direccion_extra                            : 'Dirección adicional',\n        telefono                                   : 'Teléfono',\n        telefono_secundario                        : 'Teléfono corporativo',\n        profesion                                  : 'Profesión',\n        postgrado                                  : 'Postgrado',\n        numero_tarjeta_profesional                 : 'Número de tarjeta profesional',\n        numero_licencia_salud_ocupacional          : 'Número de licencia en salud ocupacional',\n        fecha_expedicion_licencia_salud_ocupacional: 'Fecha de expedición de la licencia en salud ocupacional',\n        password                                   : 'Contraseña'\n    };\n\n    destruirTablaExistente('tabla-historial-cambios-usuario');\n\n    $('#historial-usuario-nombre').text(nombre);\n\n    $('#tabla-historial-cambios-usuario').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: true,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 450px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/usuarios-historial-cambios/${id}`,\n            data: function (datos) {\n                let filtro_fecha_arreglo = $('#filtro_fecha_hora').val().split(' a ');\n                if (filtro_fecha_arreglo[0] !== undefined && filtro_fecha_arreglo[0] !== '') datos.fecha_desde = filtro_fecha_arreglo[0];\n                if (filtro_fecha_arreglo[1] !== undefined && filtro_fecha_arreglo[1] !== '') datos.fecha_hasta = filtro_fecha_arreglo[1];\n                if ($('#filtro_tipo_accion').val() !== undefined && $('#filtro_tipo_accion').val() !== '') datos.event = $('#filtro_tipo_accion').val();\n            },\n            dataSrc: function (json) {\n                let datos_historial_cambios_usuario = Object.values(json.data);\n                return datos_historial_cambios_usuario\n                    .filter(fila => {\n                        for (const LLAVE in fila.new_values) {\n                            if (TITULOS_CAMPOS[LLAVE] !== undefined && fila.new_values[LLAVE] !== null) return true;\n                        }\n                        for (const LLAVE in fila.old_values) {\n                            if (TITULOS_CAMPOS[LLAVE] !== undefined && fila.old_values[LLAVE] !== null) return true;\n                        }\n\n                        return false;\n                    });\n            }\n        },\n        columns: [\n            // Por el momento no se mostrará el contenido que se muestra debajo de cada fila del historial de cambios.\n            // {\n            //     title: '',\n            //     data: null,\n            //     className: 'text-body-3',\n            //     orderable: false,\n            //     searchable: false,\n            //     render: function (data, type, row) {\n            //         return `\n            //             <div class=\"d-flex\">\n            //                 <div class=\"col-auto ps-0 d-flex align-items-center\">\n            //                     ${crearBoton({\n            //                         clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n            //                         texto: '<i class=\"bi bi-chevron-down\"></i>',\n            //                         data: [{texto: 'id', value: row.id}],\n            //                     })}\n            //                 </div>\n            //             </div>\n            //         `;\n            //     }\n            // },\n            {\n                title: '<span class=\"text-body-3\">Dato anterior</span>',\n                data: null,\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    let datos_anteriores = '<p class=\"text-start mb-0\">';\n\n                    for (const LLAVE in row.old_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && row.old_values[LLAVE] !== null) {\n                            if (LLAVE === 'password') row.old_values[LLAVE] = 'Cambio de contraseña';\n                            datos_anteriores += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${row.old_values[LLAVE]}</span>`;\n                        }\n                    }\n\n                    datos_anteriores += '</p>';\n                    return datos_anteriores;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Dato nuevo</span>',\n                data: null,\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    let datos_nuevos = '<p class=\"text-start mb-0\">';\n\n                    for (const LLAVE in row.new_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && row.new_values[LLAVE] !== null) {\n                            if (LLAVE === 'password') row.new_values[LLAVE] = 'Cambio de contraseña';\n                            datos_nuevos += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${row.new_values[LLAVE]}</span>`;\n                        }\n                    }\n\n                    datos_nuevos += '</p>';\n                    return datos_nuevos;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Responsable</span>',\n                data: 'user.nombre_completo',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : data;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Fecha y hora</span>',\n                data: 'created_at',\n                className: 'text-body-3',\n                orderable: true,\n                searchable: true,\n                render: function (data) {\n                    return data == null\n                        ? '---'\n                        : `\n                            <p class='text-start mb-0'>\n                                <span class=\"text-body-3 text-gray-10\">${moment(data).format('YYYY-MM-DD')}</span><br>\n                                <span class=\"text-label-2 text-gray-30\">${moment(data).format('hh:mm A')}</span>\n                            </p>\n                        `;\n                }\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n\n    $('#boton-descargar-historial-cambios-usuario').off('click').on(\n        'click',\n        evento => {\n            evento.preventDefault();\n            descargarExcel(`usuarios-historial-cambios-exportar/${id}`, 'historial-de-cambios-de-usuario');\n        }\n    );\n\n    $('#modal-historial-cambios-usuario').modal('show');\n\n    ajustarRenderDataTable('tabla-historial-cambios-usuario');\n    cargarDataTablas();\n\n    $('#buscador-tabla-historial-recompras input.dt-input:not(:last)').remove();\n    $(\".acciones-lista\").addClass('d-none');\n}\n\nfunction abrirModalFiltrosAvanzados() {\n    $('#modal-historial-cambios-usuario').modal('hide');\n    $('#modal-filtros-avanzados').modal('show');\n}\n\nfunction aplicarFiltrosAvanzados() {\n    abrirHistorialCambiosUsuario(buscar_usuario_id, buscar_usuario_nombre);\n    $('#modal-filtros-avanzados').modal('hide');\n}\n\nfunction borrarFiltrosAvanzados() {\n    $('#filtro_tipo_accion').val('').trigger('change').trigger('select2:select');\n    flatpickr(\"#filtro_fecha_hora\", { mode: \"range\" }).clear();\n    $('#filtro_fecha_hora_alt').val('');\n    $('#modal-filtros-avanzados').modal('hide');\n    abrirHistorialCambiosUsuario(buscar_usuario_id, buscar_usuario_nombre);\n}\n\n/**\n * Obtener historial de cambios de un usuario.\n *\n * @param {number} id ID del usuario.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getHistorialCambiosUsuario(id) {\n    let datos = [];\n    await $.ajax({\n        type: 'GET',\n        url : `/usuarios-historial-cambios/${id}`,\n        data: {\n            event: $('#filtro_tipo_accion').val(),\n            created_at: $('#filtro_fecha_hora').val()\n        }\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n    return datos;\n}\n\n/**\n * Validar si 2 arrays son iguales\n *\n * @param {array} arr1 primer array a validar.\n * @param {array} arr2 segundo array a validar.\n * @returns {Boolean}\n * @author José Manuel Jiménez\n */\nfunction arraysIguales(arr1, arr2) {\n    if (arr1.length !== arr2.length) {\n        return false;\n    }\n    return arr1.every((element, index) => element === arr2[index]);\n}\n\n/**\n * Mostrar la información de la configuración\n *\n * @author José Manuel Jiménez\n */\nlet actualizar_configuracion = false;\nfunction mostrarConfiguraciones() {\n    actualizar_configuracion = false;\n    $('#configuracion-1').multiselect('destroy');\n    $('#configuracion-2').multiselect('destroy');\n    for (let i = 0; i < usuarios.length; i++) {\n        if (usuarios[i].usuario != undefined) {\n            $('#configuracion-1').append(`\n                <option value=\"${usuarios[i].usuario.id}\">${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}</option>\n            `);\n            $('#configuracion-2').append(`\n                <option value=\"${usuarios[i].usuario.id}\">${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}</option>\n            `);\n        }\n    }\n    $('.switch-config').prop('checked', true);\n    for (let i = 0; i < configuraciones_defecto.length; i++) {\n        if (configuraciones_defecto[i].id == 1) {\n            if (configuraciones_defecto[i].valor == 'todos' || configuraciones_defecto[i].valor == 'administradores') {\n                $('#configuracion-1').val([]);\n                $('#elegir_usuarios').val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-1').val(JSON.parse(configuraciones_defecto[i].valor));\n                $('#elegir_usuarios').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if (configuraciones_defecto[i].id == 2) {\n            if (configuraciones_defecto[i].valor == 'todos' || configuraciones_defecto[i].valor == 'administradores') {\n                $('#configuracion-2').val([]);\n                $('#elegir_actividad').val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-2').val(JSON.parse(configuraciones_defecto[i].valor));\n                $('#elegir_actividad').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if ([3, 4, 6, 7].includes(configuraciones_defecto[i].id) && (configuraciones_defecto[i].valor == '0')) {\n            $('#configuracion-' + configuraciones_defecto[i].id).prop('checked', false);\n        }\n        if (configuraciones_defecto[i].id == 5) {\n            $('#configuracion-' + configuraciones_defecto[i].id).val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n        }\n        if (configuraciones_defecto[i].id == 8) {\n            $('#configuracion-' + configuraciones_defecto[i].id).val(configuraciones_defecto[i].valor);\n        }\n    }\n    for (let i = 0; i < configuraciones_personalizadas.length; i++) {\n        if (configuraciones_personalizadas[i].configuracion_id == 1) {\n            if (configuraciones_personalizadas[i].valor == 'todos' || configuraciones_personalizadas[i].valor == 'administradores') {\n                $('#configuracion-1').val([]);\n                $('#elegir_usuarios').val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-1').val(JSON.parse(configuraciones_personalizadas[i].valor));\n                $('#elegir_usuarios').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 2) {\n            if (configuraciones_personalizadas[i].valor == 'todos' || configuraciones_personalizadas[i].valor == 'administradores') {\n                $('#configuracion-2').val([]);\n                $('#elegir_actividad').val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-2').val(JSON.parse(configuraciones_personalizadas[i].valor));\n                $('#elegir_actividad').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if ([3, 4, 6, 7].includes(configuraciones_personalizadas[i].configuracion_id) && (configuraciones_personalizadas[i].valor == '0')) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).prop('checked', false);\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 5) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 8) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).val(configuraciones_personalizadas[i].valor);\n        }\n    }\n    actualizar_configuracion = true;\n}\n\n/**\n * Función que se ejecut al al cambiar un switch\n *\n * @param {boolean} opcion dato que indica si esta o no seleccionado el switch.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction SeleccionarOpcionSwitch(opcion, configuracion_id) {\n    let dato = opcion ? 1 : 0;\n    actualizarConfiguracion(dato, configuracion_id);\n}\n\n/**\n * Función que se ejecuta al seleccionar una opción de los selects de visibilidad\n *\n * @param {boolean} opcion dato que indica el valor seleccionado en el select.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction SeleccionarOpcionVisibilidad(opcion, configuracion_id) {\n    inizializarMultiselect();\n    if (opcion == 'Elegir usuarios') {\n        $('#contenedor-elegir-usuarios-' + configuracion_id).addClass('col-3');\n        $('#contenedor-elegir-usuarios-' + configuracion_id).removeClass('col-6');\n        $('#contenedor-usuarios-' + configuracion_id).removeClass('d-none');\n    } else {\n        $('#contenedor-elegir-usuarios-' + configuracion_id).removeClass('col-3');\n        $('#contenedor-elegir-usuarios-' + configuracion_id).addClass('col-6');\n        $('#contenedor-usuarios-' + configuracion_id).addClass('d-none');\n    }\n    if (actualizar_configuracion) {\n        $('#configuracion-' + configuracion_id).val([]);\n        actualizarConfiguracion(opcion, configuracion_id);\n    }\n    $('#configuracion-' + configuracion_id).multiselect(\"refresh\");\n}\n\n/**\n * Función que se ejecuta al seleccionar alguno o varios usuarios.\n *\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction seleccionarOpcionSelect(configuracion_id) {\n    let usuarios_select = $('#configuracion-' + configuracion_id).val();\n    actualizarConfiguracion(JSON.stringify(usuarios_select.map(numero => parseInt(numero))), configuracion_id);\n}\n\n/**\n * Actualizar la configuración de la empresa.\n *\n * @param {any} valor valor a actualizar en la configuración seleccionada.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @returns {Promise<void>}\n * @author Daniel Beltrán, José Manuel Jiménez\n */\nasync function actualizarConfiguracion(valor, configuracion_id) {\n    if (actualizar_configuracion) {\n        if (configuracion_id == 1 || configuracion_id == 2) {\n            if (valor != 'todos' && valor != 'administradores') {\n                if (valor == '[]') {\n                    mostrarToast('neutral', `Selecciona al menos un usuario`);\n                    return false;\n                } else if (valor == 'Elegir usuarios') {\n                    return false;\n                }\n            }\n        }\n        await $.ajax({\n            type: 'POST',\n            url : `/configuraciones-modelos`,\n            data: {\n                _token          : $('meta[name=\"csrf-token\"]').attr('content'),\n                model_type      : 'App\\\\Models\\\\Empresas\\\\Empresa',\n                modelo_id       : empresa_seleccionada.id,\n                configuracion_id: configuracion_id,\n                valor           : valor\n            }\n        }).then((respuesta) => {\n            mostrarToast('success', respuesta.message);\n            datos = respuesta.data || [];\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n}\n\n/**\n * metodo para mostrar un tooltip segun el div que lo contenga.\n *\n * @param {div} div del elemento donde se va a mostrar el tooltip\n * @returns {void}\n * @author Sol Espitia\n */\nfunction mostrarTooltip(div) {\n    const tooltip = div.querySelector('.tooltip-bottom');\n    tooltip.style.display = 'inline';\n}\n\n/**\n * metodo para ocultar un tooltip segun el div que lo contenga.\n *\n * @param {div} div del elemento donde se va a mostrar el tooltip\n * @returns {void}\n * @author Sol Espitia\n */\nfunction ocultarTooltip(div) {\n    const tooltip = div.querySelector('.tooltip-bottom');\n    tooltip.style.display = 'none';\n}\n\n/**\n * metodo para seleccionar una empresa en los chackbox para descargar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction seleccionarCheckboxEmpresa(check, empresa_id) {\n    if (check) {\n        empresas_seleccionadas.push(parseInt(empresa_id));\n    } else {\n        empresas_seleccionadas = empresas_seleccionadas.filter(id => id !== parseInt(empresa_id));\n    }\n    if (empresas_seleccionadas.length == cantidad_empresas_listado) {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', false);\n        $('#check-seleccionar-todos-empresas').prop('checked', true);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    } else if (empresas_seleccionadas.length == 0) {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', false);\n        $('#check-seleccionar-todos-empresas').prop('checked', false);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`);\n    } else {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', true);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    }\n}\n\n/**\n * metodo para seleccionar todas las empresas en los chackbox para descargar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction seleccionarTodasEmpresas(check) {\n    empresas_seleccionadas = [];\n    if (check) {\n        for (let i = 0; i < empresas_listado.length; i++) {\n            empresas_seleccionadas.push(empresas_listado[i].id);\n            for (let j = 0; j < empresas_listado[i].sucursales.length; j++) {\n                empresas_seleccionadas.push(empresas_listado[i].sucursales[j].id);\n            }\n        }\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    } else {\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`);\n    }\n    mostrarEmpresas();\n}\n\n/**\n * metodo para descargar el excel pasandole los id de empresas seleccionados.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction descargarExcelEmpresas() {\n    if (empresas_seleccionadas.length > 0) {\n        descargarExcel('empresas-exportar', 'empresas', true, {\n            empresas_ids: empresas_seleccionadas\n        });\n    } else {\n        descargarExcel('empresas-exportar', 'empresas');\n    }\n}\n/**\n * Eliminar el logo de la empresa.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n */\nasync function eliminarLogo(id) {\n    await $.ajax({\n        type: 'POST',\n        url : `/empresas-eliminar-logo/${id}`,\n        data: {\n            _token : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method: 'DELETE'\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', respuesta.message);\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n$('#logo_recorte').on('change', evento => {\n    let archivo_logo = evento.target.files[0];\n    if (archivo_logo && archivo_logo.type.startsWith('image/')) {\n        const reader = new FileReader();\n        reader.onload = evento => {\n            let imagen = new Image();\n            imagen.onload = function() {\n                if (imagen.height > 500) {\n                    validacion_logo_mensaje = 'La imagen es demasiado grande. Intenta con dimensiones inferiores a 500px de alto.';\n                    logo_valido = false;\n                } else if (archivo_logo.size > 400_000) {\n                    validacion_logo_mensaje = 'La imagen es demasiado pesada. Intenta con un peso inferior o igual a 400KB.';\n                    logo_valido = false;\n                } else if (!['image/png', 'image/jpg', 'image/jpeg'].includes(archivo_logo.type)) {\n                    validacion_logo_mensaje = 'El formato no es válido. Carga una imagen en JPG o PNG.';\n                    logo_valido = false;\n                } else {\n                    validacion_logo_mensaje = '';\n                    logo_valido = true;\n                }\n            };\n            imagen.src = evento.target.result;\n        };\n        reader.readAsDataURL(archivo_logo);\n    } else {\n        alert('Por favor selecciona un archivo de imagen válido.');\n    }\n});\n\n/**\n * Abrir modal de detalle del plan de créditos.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {string} nombre_plan Nombre del plan de créditos.\n * @param {number} creditos Número de créditos del plan.\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirDetallePlanCreditos(empresa_id, nombre_plan, creditos) {\n    $('#modal-detalle-plan-creditos').modal('show');\n    $('#nombre-plan-creditos').text(nombre_plan);\n    $('#unidades-plan-creditos').text(numeroCleave(creditos));\n    creditos_empresa_id = empresa_id;\n}\n\n/**\n * Ver consumo de créditos en modal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction verConsumoCreditos() {\n    $('#modal-detalle-plan-creditos').modal('hide');\n    $('#modal-detalle-consumo-creditos').modal('show');\n    $('#contenedor-tabla-detalle-consumo-creditos').empty();\n    $('#contenedor-tabla-detalle-consumo-creditos').append(`\n        ${crearTabla({\n            id: 'tabla-consumo-creditos',\n            registros_paginas: true,\n            buscador_datatable: true,\n            class_tabla: 'mt-3',\n            buscador: {\n                icono: '<i class=\"bi bi-search input-icono1\"></i>',\n            },\n            filtro: crearFiltroDropdown({\n                id: 'filtro_dropdown',\n                name: 'filtro_dropdown',\n                buscador_datatable: true,\n                type: 'text',\n                value: '',\n                class: 'filtro-chips',\n                input_container_class: 'mb-0',\n                placeholder: 'Buscar',\n                icono: '<i class=\"bi bi-search input-icono1\"></i>',\n                icono3: '<i class=\"bi bi-filter input-icono3 pointer icono-filtro-avanzado\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\" data-bs-auto-close=\"outside\"></i>',\n                dropdown: {\n                    titulo: 'Filtros avanzados',\n                    contenedor_botones_class: 'col-6',\n                    contenido: `\n                        <div class=\"row mt-5\">\n                            <div class=\"col-5 pt-2\">Acciones realizadas</div>\n                            <div class=\"col-7\">\n                                ${crearSelect2({\n                                    opciones: [],\n                                    opcion_vacia: false,\n                                    id: 'filtro_servicio_ia_id',\n                                    class: 'filtro',\n                                    input_container_class: 'mb-0',\n                                    data: [{\n                                        texto: 'filtro',\n                                        value: 'Estado'\n                                    }]\n                                })}\n                            </div>\n                        </div>\n                        <div class=\"row mt-5\">\n                            <div class=\"col-5 pt-2\">Usuarios</div>\n                            <div class=\"col-7\">\n                                ${crearSelect2({\n                                    opciones: [],\n                                    opcion_vacia: false,\n                                    id: 'filtro_usuario_id',\n                                    class: 'filtro',\n                                    input_container_class: 'mb-0',\n                                    data: [{\n                                        texto: 'filtro',\n                                        value: 'Prueba'\n                                    }]\n                                })}\n                            </div>\n                        </div>\n                        <div class=\"row mt-5 mb-2\">\n                            <div class=\"col-5 pt-2\">Fecha de consumo</div>\n                            <div class=\"col-7\">\n                                ${crearDatePicker({\n                                    id: 'filtro_fecha_consumo',\n                                    class: 'flatpickr-range filtro',\n                                    input_container_class: 'mb-1',\n                                    placeholder: 'Desde - hasta',\n                                    disabled: false,\n                                    icono: '<i class=\"bi bi-calendar4 input-icono2 text-gray-30 pointer\"></i>',\n                                    data: [{\n                                        texto: 'filtro',\n                                        value: 'Desde - Hasta'\n                                    }]\n                                })}\n                            </div>\n                        </div>\n                    `,\n                }\n            }),\n            botones: `\n                <div class=\"col-auto\">\n                    ${crearBoton({\n                        clases: 'btn-green-excel',\n                        texto: `<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`,\n                        onclick: `descargarExcelHistorialCreditos()`\n                    })}\n                </div>\n            `\n        })}\n    `);\n    $('#tabla-consumo-creditos').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [10, 25, 50, 100],\n            [10, 25, 50, 100]\n        ],\n        scrollX: true,\n        ajax: {\n            url: `/empresas/${creditos_empresa_id}/consumos-creditos`,\n            data: function(datos) {\n                datos.servicio_ia_id = $('#filtro_servicio_ia_id').val();\n                datos.usuario_id = $('#filtro_usuario_id').val();\n                let rango_fechas = $('#filtro_fecha_consumo').val();\n                if (rango_fechas != '') {\n                    rango_fechas = rango_fechas.split(\" a \");\n                    datos.desde = rango_fechas[0];\n                    datos.hasta = rango_fechas[1] || rango_fechas[0];\n                }\n            }\n        },\n        columns: [\n            {\n                title: 'Usuario',\n                data: null,\n                orderable: false,\n                searchable: false,\n                className: 'text-center',\n                render: function (dato) {\n                    return `${dato.usuario.nombre_completo}`;\n                },\n            },\n            {\n                title: 'Acción realizada',\n                data: 'servicio',\n                className: 'text-start',\n            },\n            {\n                title: 'Créditos',\n                data: 'creditos',\n                className: 'text-start',\n            },\n            {\n                title: 'Tokens reales',\n                data: 'tokens_reales',\n                className: 'text-start',\n            },\n            {\n                title: 'Fecha consumo',\n                data: null,\n                orderable: true,\n                className: 'text-center',\n                render: function (dato) {\n                    return `${moment(dato.fecha_consumo).format('DD-MM-YYYY hh:mm a')}`;\n                }\n            }\n        ]\n    });\n    $.ajax({\n        url: '/usuarios-listado',\n        type: 'GET',\n        data: {\n            empresa_id: creditos_empresa_id\n        },\n        success: function(respuesta) {\n            let usuarios = respuesta.data;\n            $('#filtro_usuario_id').empty().append('<option value=\"\">Todas</option>');\n            usuarios.forEach(usuario => {\n                $('#filtro_usuario_id').append(`<option value=\"${usuario.id}\">${usuario.nombre_completo}</option>`);\n            });\n        }\n    });\n    $.ajax({\n        url: '/servicios-ia',\n        type: 'GET',\n        success: function(respuesta) {\n            let servicios = respuesta.data;\n            $('#filtro_servicio_ia_id').empty().append('<option value=\"\">Todas</option>');\n            servicios.forEach(servicio => {\n                $('#filtro_servicio_ia_id').append(`<option value=\"${servicio.id}\">${servicio.nombre}</option>`);\n            });\n        }\n    });\n    cargarDataTablas();\n    inicializarFlatpickr();\n}\n\n/**\n * Función OBLIGATORIA para aplicar filtros dropdown.\n *\n * @param {string} filtro id del elemento html del filtro\n * @param {Object} filtros filtros aplicados\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction aplicarFiltrosDropdown() {\n    if ($('#modal-detalle-consumo-creditos').hasClass('show')) {\n        actualizarDatatables('tabla-consumo-creditos');\n    }\n}\n\n/**\n * Descargar Excel del historial de créditos.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction descargarExcelHistorialCreditos() {\n    let servicio_ia_id = $('#filtro_servicio_ia_id').val();\n    let usuario_id = $('#filtro_usuario_id').val();\n    let desde = null;\n    let hasta = null;\n    let rango_fechas = $('#filtro_fecha_consumo').val();\n    if (rango_fechas != '') {\n        rango_fechas = rango_fechas.split(\" a \");\n        desde = rango_fechas[0];\n        hasta = rango_fechas[1] || rango_fechas[0];\n    }\n    // Lógica para descargar excel\n}","structuredPatch":[{"oldStart":1771,"oldLines":7,"newStart":1771,"newLines":7,"lines":["                                                     </p>","                                                 </div>","                                                 <div class=\"col-auto\">","-                                                    ${estado_credito}","+                                                    ${estado_credito}${indicador_proximo_credito}","                                                 </div>","                                                 <div class=\"col-auto\">","                                                     <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"520f0808-a01d-4b62-853b-19fbdb807fb9"}
{"parentUuid":"6ef8827f-6362-4087-94a9-a6b4074ef00c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01G2LGSSpMsTcBmJ4q8txH5Z","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora los cambios están completos. Resumamos lo que se hizo:\n\n1. **EmpresaPlanRepository.php**: Agregado el método `planCreditosProximo()` para obtener el plan de créditos con estado próximo (estado_id = 3).\n\n2. **EmpresaPlanService.php**: Modificado el método `obtenerPlanesCreditosActivos()` para agregar la propiedad `plan_proximo_id` a cada plan de créditos activo si existe un plan próximo.\n\n3. **empresas.js**:\n   - Agregado lógica para mostrar un dropdown con opciones de \"Editar plan vigente\" y \"Editar plan próximo\" cuando existe un plan de créditos próximo\n   - Agregado indicador visual \"Próximo disponible\" (tag púrpura) cuando hay un plan de créditos próximo\n\nAhora los planes de créditos próximos se mostrarán de manera similar a como se hace con los planes regulares.","signature":"EscHCkYICxgCKkDMrKOg4GQy0q0WLCNUNaxmA5+SDsWSFphEEgg4GQ1/Lz74x97qm5OhzsOJghtV5KFVlZ8cvUdz8QO4sAEVWG/dEgwF+o7eB8rk+PFw4XAaDIJK1fnv8St0x2DPoyIwWZbAalV1W0fuj/QWpO68VUAVaa4g9poIS4deVdZwixYZggucRcJA+wesdtjkck8gKq4Ggv77yTOlwxsFM91jnk62HmnZIVfbf+rXp10chY6iq+7gtI+nAtOYF0/gX8+xQqbT5Xcxy9L6R5G8F+XatlCFt8fD4zzuyUePZc31zDngGtFK8D29qSxLiZldwLy6FPSjJi1gmsz2uUxoEkfrN/SnS5xAC8a0ktGiTaVP/oYQD6J7qRPoX4iVyxuVVqmi8NC5Dud4qt2Le1vMz84GKyiSfusqRNI3uSiVyon6nL/mZHXWyc49NQwFA61EdbdpheXZHTo0AC/dvu0LL7RkY5m1/mc4j/l0vh9RxmZyYH/4mWby+4liC8nmcolmRxDfkponTxLSh33ItcDBkpefSyqS751Xijz2T6dwpuWiOyf5S29N9spYqg+nU7+BuCI2CvM/azKZVRJHuL6j/n0N+7Gw8meUEOh4icrYbkwBFQG4wrXjhP+mPmQmRhlSF+PxdW/4diwO71Csd9nQHhXIJk6xOdBsAouu+rVqVUY/XEQfcC3MmQKiqIFfUBeGEjnW99v8e4eCGOVFdRhS7KgooJ8i2TY9AEzEMZ5/uXNxYRnJPTi5v8XgYR0b3KI92pjQTNmglZbjrWjt7BvllxfzsEAjvIuocAuCiaVDu9TDVYeUOmC9aDEfNE6ZbuaK6v2CD3uBu+XbG4Ydl6hXiUAZNr3Semm4VvEBzXkHG35wYEi10exK8VABpTHvOyle0NNECSgbHiqxaGLkVeSIJOLgtfgEiq9xlFajZpFy8s7F+3UiD+X/QwVIarh+B0GscPf+35USbwDQBnI+E+kk71zoVF770w1P2pXsVo3kB9mt449OzRG6nYLpsCH58zLDauLHNRJlpogRylxFmRpFKrM6PwUnKiahJ5pgbwhrUd+JNTrN7nl5xPjWuo4hkcayis7g9PUYHmt1GzMK7kGZ04pPtBnX/rzwJKgHfPaWrwar5QPk6hl0Hf3lrtmdjiDTwv+T3FrmWNly+CSpepmYr6I1xxQsdmv00AfT/iwzcHkN0Zbg8d6WDCaGRZfkcqJWiP+QpUktw+w7+RMmUiU0Ey9yptZQo+1kaI3tKfJr8rrc6yqmzExGjY5dto0Uo+NWsoVmXhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":465,"cache_read_input_tokens":100629,"cache_creation":{"ephemeral_5m_input_tokens":465,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGo1XzHf9oArosY83HW","type":"assistant","uuid":"c7a90831-8d6d-4178-aa4a-c136c98a274a","timestamp":"2026-01-25T02:02:25.407Z"}
{"parentUuid":"c7a90831-8d6d-4178-aa4a-c136c98a274a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","message":{"model":"claude-opus-4-5-20251101","id":"msg_01G2LGSSpMsTcBmJ4q8txH5Z","type":"message","role":"assistant","content":[{"type":"text","text":"Los cambios están completos. Ahora los planes de créditos próximos se mostrarán de manera similar a los planes regulares.\n\n## Resumen de cambios adicionales:\n\n### 1. EmpresaPlanRepository.php\nAgregado nuevo método `planCreditosProximo()`:\n```php\npublic function planCreditosProximo(int $empresa_id): ?EmpresaPlan\n```\nObtiene el plan de créditos con estado próximo (estado_id = 3).\n\n### 2. EmpresaPlanService.php\nModificado `obtenerPlanesCreditosActivos()` para agregar la propiedad `plan_proximo_id` a cada plan de créditos activo si existe un plan próximo.\n\n### 3. empresas.js\n- **Dropdown de edición**: Cuando existe un plan de créditos próximo (`plan_proximo_id`), se muestra un dropdown con:\n  - \"Editar plan vigente\"\n  - \"Editar plan próximo\"\n  \n- **Indicador visual**: Se agregó un tag púrpura `\"Próximo disponible\"` junto al estado del plan cuando hay un plan de créditos próximo.\n\nAhora al acceder a `/empresas-gestionar/{id}`:\n1. Se mostrarán los planes de créditos activos donde `plan_id = NULL`\n2. Si hay un plan de créditos próximo, aparecerá el indicador \"Próximo disponible\"\n3. El botón de editar mostrará un menú desplegable para editar el plan vigente o el próximo"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":465,"cache_read_input_tokens":100629,"cache_creation":{"ephemeral_5m_input_tokens":465,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXTGo1XzHf9oArosY83HW","type":"assistant","uuid":"df57989d-8096-4d85-b819-15f614ce24bf","timestamp":"2026-01-25T02:02:30.834Z"}
{"parentUuid":"df57989d-8096-4d85-b819-15f614ce24bf","isSidechain":false,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"480aa097-2d7f-456a-9cc1-1df24a9cf23e","version":"2.1.16","gitBranch":"pre-main","slug":"sorted-spinning-crane","type":"system","subtype":"turn_duration","durationMs":118640,"timestamp":"2026-01-25T02:02:30.952Z","uuid":"a8fe8c42-363c-4348-bb5f-19666f1bca1d","isMeta":false}
{"type":"summary","summary":"Show credit plans in superadmin company management view","leafUuid":"df57989d-8096-4d85-b819-15f614ce24bf"}
