{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":"Explora el código relacionado con planes-creditos, específicamente:\n\n1. Busca el endpoint `planes-creditos/create` - encuentra el controlador, las rutas, y cómo funciona\n2. Identifica los modelos involucrados: Servicios, Créditos, Planes, y sus relaciones\n3. Encuentra el repositorio y servicio asociados (siguiendo la arquitectura Controlador-Servicio-Repositorio)\n4. Identifica cómo se almacena y obtiene la información de cuántos créditos cuesta cada servicio\n5. Busca ejemplos de otros endpoints similares que reciban un ID y devuelvan información específica\n\nProporciona rutas de archivos completas y fragmentos de código relevantes."},"uuid":"1537b2cd-299e-4326-b069-402884ccbb59","timestamp":"2026-01-15T19:41:16.925Z"}
{"parentUuid":"1537b2cd-299e-4326-b069-402884ccbb59","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QeLhu9MBrh6orhdwcZbTJT","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a explorar el código relacionado con planes-créditos de manera sistemática. Comenzaré buscando las rutas, controladores, modelos y la arquitectura del proyecto."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14791,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14791,"ephemeral_1h_input_tokens":0},"output_tokens":9,"service_tier":"standard"}},"requestId":"req_011CX9jTYsQwFCzqKDJg2vH5","type":"assistant","uuid":"e48fec7a-76f2-4529-a98e-aef5aa7bf3ea","timestamp":"2026-01-15T19:41:18.773Z"}
{"parentUuid":"e48fec7a-76f2-4529-a98e-aef5aa7bf3ea","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QeLhu9MBrh6orhdwcZbTJT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016jB1erNYnjPJQkHA4W2uBJ","name":"Bash","input":{"command":"find \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\" -type f -name \"*.php\" | grep -i route | head -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14791,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14791,"ephemeral_1h_input_tokens":0},"output_tokens":135,"service_tier":"standard"}},"requestId":"req_011CX9jTYsQwFCzqKDJg2vH5","type":"assistant","uuid":"6bfa9a78-e52b-4aa5-aeb4-43e772b990e4","timestamp":"2026-01-15T19:41:19.363Z"}
{"parentUuid":"6bfa9a78-e52b-4aa5-aeb4-43e772b990e4","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016jB1erNYnjPJQkHA4W2uBJ","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2/app/Providers/RouteServiceProvider.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/bootstrap/cache/routes-v7.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/routes/api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/routes/channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/routes/console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/routes/web.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/geo-routes/2020-11-19/api-2.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/geo-routes/2020-11-19/endpoint-rule-set-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/geo-routes/2020-11-19/paginators-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53/2013-04-01/api-2.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53/2013-04-01/endpoint-rule-set-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53/2013-04-01/paginators-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53/2013-04-01/smoke.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53/2013-04-01/waiters-2.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-cluster/2019-12-02/api-2.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-cluster/2019-12-02/endpoint-rule-set-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-cluster/2019-12-02/paginators-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-control-config/2020-11-02/api-2.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-control-config/2020-11-02/endpoint-rule-set-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-control-config/2020-11-02/paginators-1.json.php","is_error":false}]},"uuid":"2089c820-188f-4e01-84d0-4b555fadbaa5","timestamp":"2026-01-15T19:41:24.302Z","toolUseResult":{"stdout":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2/app/Providers/RouteServiceProvider.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/bootstrap/cache/routes-v7.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/routes/api.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/routes/channels.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/routes/console.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/routes/web.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/geo-routes/2020-11-19/api-2.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/geo-routes/2020-11-19/endpoint-rule-set-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/geo-routes/2020-11-19/paginators-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53/2013-04-01/api-2.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53/2013-04-01/endpoint-rule-set-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53/2013-04-01/paginators-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53/2013-04-01/smoke.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53/2013-04-01/waiters-2.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-cluster/2019-12-02/api-2.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-cluster/2019-12-02/endpoint-rule-set-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-cluster/2019-12-02/paginators-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-control-config/2020-11-02/api-2.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-control-config/2020-11-02/endpoint-rule-set-1.json.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2/vendor/aws/aws-sdk-php/src/data/route53-recovery-control-config/2020-11-02/paginators-1.json.php\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"6bfa9a78-e52b-4aa5-aeb4-43e772b990e4"}
{"parentUuid":"2089c820-188f-4e01-84d0-4b555fadbaa5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01BV8SqhwSoyrUeezMHrsh97","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a buscar archivos específicos de rutas y controladores relacionados con planes-créditos."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1358,"cache_read_input_tokens":14791,"cache_creation":{"ephemeral_5m_input_tokens":1358,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jU6xiLaQSBAqMXqbVQ","type":"assistant","uuid":"d3696cad-ced3-47bc-94e4-82f83745551f","timestamp":"2026-01-15T19:41:26.194Z"}
{"parentUuid":"d3696cad-ced3-47bc-94e4-82f83745551f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01BV8SqhwSoyrUeezMHrsh97","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013rHwP8TWYpPnHsyPg5xyCh","name":"Grep","input":{"pattern":"planes-creditos","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1358,"cache_read_input_tokens":14791,"cache_creation":{"ephemeral_5m_input_tokens":1358,"ephemeral_1h_input_tokens":0},"output_tokens":117,"service_tier":"standard"}},"requestId":"req_011CX9jU6xiLaQSBAqMXqbVQ","type":"assistant","uuid":"227fb6a2-c5af-4ea8-88df-36d5732c7741","timestamp":"2026-01-15T19:41:26.496Z"}
{"parentUuid":"227fb6a2-c5af-4ea8-88df-36d5732c7741","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013rHwP8TWYpPnHsyPg5xyCh","type":"tool_result","content":"Found 6 files\nroutes\\web.php\nroutes\\api.php\nresources\\views\\planes\\index.blade.php\nresources\\views\\planes\\paginas\\crear-creditos.blade.php\npublic\\js\\planes\\planes.js\npublic\\js\\planes\\crear-plan-creditos.js"}]},"uuid":"618498e9-663d-47bb-9522-278cc9db86bc","timestamp":"2026-01-15T19:41:30.579Z","toolUseResult":{"mode":"files_with_matches","filenames":["routes\\web.php","routes\\api.php","resources\\views\\planes\\index.blade.php","resources\\views\\planes\\paginas\\crear-creditos.blade.php","public\\js\\planes\\planes.js","public\\js\\planes\\crear-plan-creditos.js"],"numFiles":6},"sourceToolAssistantUUID":"227fb6a2-c5af-4ea8-88df-36d5732c7741"}
{"parentUuid":"618498e9-663d-47bb-9522-278cc9db86bc","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015tca12b5mWKWmuFrE7m69Q","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora voy a examinar las rutas, el controlador de planes y los archivos relacionados:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":237,"cache_read_input_tokens":16149,"cache_creation":{"ephemeral_5m_input_tokens":237,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jUZ8ZtAh6Ffybq7A5k","type":"assistant","uuid":"51dddcc4-4635-4ada-9388-700085cf596a","timestamp":"2026-01-15T19:41:32.447Z"}
{"parentUuid":"51dddcc4-4635-4ada-9388-700085cf596a","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015tca12b5mWKWmuFrE7m69Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014PUHaaqp1Q5pNF5KwVPXXt","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":237,"cache_read_input_tokens":16149,"cache_creation":{"ephemeral_5m_input_tokens":237,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jUZ8ZtAh6Ffybq7A5k","type":"assistant","uuid":"14cd6286-0024-4fbb-a933-3b435b97340d","timestamp":"2026-01-15T19:41:32.602Z"}
{"parentUuid":"14cd6286-0024-4fbb-a933-3b435b97340d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015tca12b5mWKWmuFrE7m69Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01T5zPXzAYDzkHM7fAEyRj7R","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":237,"cache_read_input_tokens":16149,"cache_creation":{"ephemeral_5m_input_tokens":237,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jUZ8ZtAh6Ffybq7A5k","type":"assistant","uuid":"cc1b96cf-d435-4872-8db9-0a15e70df05a","timestamp":"2026-01-15T19:41:32.842Z"}
{"parentUuid":"cc1b96cf-d435-4872-8db9-0a15e70df05a","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015tca12b5mWKWmuFrE7m69Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FDZW65JT38zSNr1rXeQvKv","name":"Glob","input":{"pattern":"**/Controllers/*Plan*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":237,"cache_read_input_tokens":16149,"cache_creation":{"ephemeral_5m_input_tokens":237,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jUZ8ZtAh6Ffybq7A5k","type":"assistant","uuid":"5e6f6b7a-592d-474f-9731-889b385aa921","timestamp":"2026-01-15T19:41:33.126Z"}
{"parentUuid":"5e6f6b7a-592d-474f-9731-889b385aa921","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015tca12b5mWKWmuFrE7m69Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ReG1ncN6LKs97c5pk25V2r","name":"Glob","input":{"pattern":"**/Models/Planes/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":237,"cache_read_input_tokens":16149,"cache_creation":{"ephemeral_5m_input_tokens":237,"ephemeral_1h_input_tokens":0},"output_tokens":248,"service_tier":"standard"}},"requestId":"req_011CX9jUZ8ZtAh6Ffybq7A5k","type":"assistant","uuid":"2d0dd54d-d805-44f7-b001-3b402ddd8734","timestamp":"2026-01-15T19:41:33.348Z"}
{"parentUuid":"cc1b96cf-d435-4872-8db9-0a15e70df05a","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01T5zPXzAYDzkHM7fAEyRj7R","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Http\\Request;\n     4→use Illuminate\\Support\\Facades\\Cache;\n     5→use Illuminate\\Support\\Facades\\Route;\n     6→use App\\Http\\Controllers\\IA\\ServicioIAController;\n     7→use App\\Http\\Controllers\\Agendas\\AgendaController;\n     8→use App\\Http\\Controllers\\Pruebas\\PerfilController;\n     9→use App\\Http\\Controllers\\Pruebas\\PruebaController;\n    10→use App\\Http\\Controllers\\Vacantes\\VacanteController;\n    11→use App\\Http\\Controllers\\Planes\\PlanCreditoController;\n    12→use App\\Http\\Controllers\\IA\\CategoriaServicioIAController;\n    13→use App\\Http\\Controllers\\OfertasLaborales\\EtapaController;\n    14→use App\\Http\\Controllers\\Configuraciones\\ArchivoController;\n    15→use App\\Http\\Controllers\\Vacantes\\FormatoEntrevistaController;\n    16→use App\\Http\\Controllers\\Vacantes\\EtapaVacanteUsuarioController;\n    17→use App\\Http\\Controllers\\OfertasLaborales\\OfertaLaboralController;\n    18→use App\\Http\\Controllers\\OrdenesServicios\\OrdenServicioController;\n    19→use App\\Http\\Controllers\\Vacantes\\EtapaUsuarioComentarioController;\n    20→use App\\Http\\Controllers\\OfertasLaborales\\PreguntaOfertaLaboralController;\n    21→use App\\Http\\Controllers\\OfertasLaborales\\MovimientoConfiguracionController;\n    22→use App\\Http\\Controllers\\Vacantes\\EtapaMovimientoVacanteConfiguracionController;\n    23→use App\\Http\\Controllers\\OfertasLaborales\\EtapaMovimientoConfiguracionController;\n    24→use App\\Http\\Controllers\\OfertasLaborales\\PuntajePreguntaOfertaLaboralController;\n    25→use App\\Http\\Controllers\\OfertasLaborales\\RespuestaPreguntaOfertaLaboralController;\n    26→\n    27→Route::middleware('auth:sanctum')->get('/user', function (Request $request) {\n    28→    return $request->user();\n    29→});\n    30→\n    31→/*\n    32→|--------------------------------------------------------------------------|\n    33→| Rutas de prueba                                                          |\n    34→|--------------------------------------------------------------------------|\n    35→ */\n    36→\n    37→Route::get('movimientos-configuraciones-listado', [MovimientoConfiguracionController::class, 'listado']);\n    38→Route::post('movimientos-configuraciones', [EtapaMovimientoConfiguracionController::class, 'store']);\n    39→\n    40→// Creditos IA\n    41→Route::get('planes-creditos', [PlanCreditoController::class, 'index']);\n    42→Route::post('planes-creditos', [PlanCreditoController::class, 'store']);\n    43→Route::put('planes-creditos/{id}', [PlanCreditoController::class, 'update']);\n    44→Route::delete('planes-creditos/{id}', [PlanCreditoController::class, 'destroy']);\n    45→\n    46→Route::get('categorias-servicios-ia', [CategoriaServicioIAController::class, 'index']);\n    47→Route::post('categorias-servicios-ia', [CategoriaServicioIAController::class, 'store']);\n    48→Route::put('categorias-servicios-ia/{id}', [CategoriaServicioIAController::class, 'update']);\n    49→\n    50→Route::get('servicios-ia', [ServicioIAController::class, 'index']);\n    51→Route::post('servicios-ia', [ServicioIAController::class, 'store']);\n    52→Route::put('servicios-ia/{id}', [ServicioIAController::class, 'update']);\n    53→Route::post('servicios-ia/{id}/activar', [ServicioIAController::class, 'activar']);\n    54→Route::post('servicios-ia/{id}/desactivar', [ServicioIAController::class, 'desactivar']);\n    55→\n    56→// Vacantes\n    57→Route::post('etapas-movimientos-vacantes-configuraciones', [EtapaMovimientoVacanteConfiguracionController::class, 'store']);\n    58→Route::post('vacantes-completar/{id}', [VacanteController::class, 'completar']);\n    59→\n    60→Route::post('generar-descripcion', [OrdenServicioController::class, 'generarDescripcion']);\n    61→Route::post('etapas-mover/{id}/{orden}', [EtapaController::class, 'cambiarOrden']);\n    62→\n    63→Route::post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', [OfertaLaboralController::class, 'descartarAplicante']);\n    64→\n    65→Route::post('agendas-procesar-resultados', [AgendaController::class, 'procesarResultados']);\n    66→Route::post('agendas-guardar-archivo', [AgendaController::class, 'guardarArchivoAgenda']);\n    67→\n    68→Route::get('archivos', [ArchivoController::class, 'listado']);\n    69→Route::get('archivos-obtener-uno', [ArchivoController::class, 'obtenerUno']);\n    70→\n    71→Route::resource('perfiles', PerfilController::class)->names('api.perfiles');\n    72→\n    73→Route::post('pruebas-completas-crear', [PruebaController::class, 'crearPruebaCompleta']);\n    74→\n    75→Route::get('preguntas-prefiltro', [PreguntaOfertaLaboralController::class, 'obtenerPreguntasParaResponder']);\n    76→Route::post('respuestas-preguntas-ofertas-laborales', [RespuestaPreguntaOfertaLaboralController::class, 'store']);\n    77→Route::get('verificar-etapa-completada/{etapa_vacante_usuario_id}', [EtapaVacanteUsuarioController::class, 'verificarEtapaCompletada']);\n    78→\n    79→// Adecuaciones de etapas\n    80→Route::post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', [EtapaVacanteUsuarioController::class, 'generarAdecuacionHV']);\n    81→Route::post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', [EtapaVacanteUsuarioController::class, 'generarAdecuacionPrefiltro']);\n    82→Route::post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', [EtapaVacanteUsuarioController::class, 'generarAdecuacionPruebasPsicometricas']);\n    83→Route::post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', [EtapaVacanteUsuarioController::class, 'generarAdecuacionVideoentrevista']);\n    84→Route::post('guardar-puntaje-adecuacion-reclutador', [EtapaVacanteUsuarioController::class, 'guardarPuntajeAdecuacionReclutador']);\n    85→Route::post('guardar-puntaje-pregunta-reclutador', [PuntajePreguntaOfertaLaboralController::class, 'guardarPuntajeReclutador']);\n    86→Route::resource('etapas-usuarios-comentarios', EtapaUsuarioComentarioController::class)\n    87→    ->only(['index', 'store'])\n    88→    ->names('api.etapas-usuarios-comentarios');\n    89→Route::get('obtener-adecuacion-usuario', [EtapaVacanteUsuarioController::class, 'obtenerAdecuacionUsuario']);\n    90→Route::get('obtener-candidatos-recomendados', [EtapaVacanteUsuarioController::class, 'obtenerCandidatosRecomendadosIA']);\n    91→Route::post('preguntar-candidatos-recomendados', [EtapaVacanteUsuarioController::class, 'preguntarSobreCandidatosRecomendados']);\n    92→\n    93→Route::resource('formatos-entrevistas', FormatoEntrevistaController::class)\n    94→    ->only(['store', 'update'])\n    95→    ->names('api.formatos-entrevistas');\n    96→\n    97→/**\n    98→ * Valida el token SSO recibido desde WordPress.\n    99→ *\n   100→ * Proceso:\n   101→ *  - Recibe el token firmado en el body (`token`).\n   102→ *  - Verifica firma y expiración del token.\n   103→ *  - Asegura que el nonce exista en cache (uso único) y lo invalida.\n   104→ *  - Devuelve datos del usuario admin Y del estudiante (si existe).\n   105→ *\n   106→ * @author Sergio Vargas\n   107→ */\n   108→Route::post('/sso/validate', function (Request $request) {\n   109→    $token = $request->input('token');\n   110→\n   111→    if (!$token) {\n   112→        return response()->json(['ok' => false, 'error' => 'missing_token'], 400);\n   113→    }\n   114→\n   115→    $payload = sso_verify_token($token, config('services.sso.secret'));\n   116→\n   117→    if (!$payload) {\n   118→        return response()->json(['ok' => false, 'error' => 'invalid_token'], 401);\n   119→    }\n   120→\n   121→    if (($payload['exp'] ?? 0) < time()) {\n   122→        return response()->json(['ok' => false, 'error' => 'expired'], 401);\n   123→    }\n   124→\n   125→    $nonce = $payload['nonce'] ?? null;\n   126→\n   127→    if (!$nonce) {\n   128→        return response()->json(['ok' => false, 'error' => 'missing_nonce'], 401);\n   129→    }\n   130→\n   131→    $cacheKey  = \"sso_nonce:{$nonce}\";\n   132→    $nonceData = Cache::get($cacheKey);\n   133→\n   134→    if (!$nonceData) {\n   135→        return response()->json(['ok' => false, 'error' => 'nonce_used_or_unknown'], 401);\n   136→    }\n   137→\n   138→    Cache::forget($cacheKey);\n   139→\n   140→    return response()->json([\n   141→        'ok'   => true,\n   142→        'user' => [\n   143→            'email' => $payload['email'] ?? null,\n   144→            'name'  => $payload['name'] ?? null,\n   145→            'role'  => $payload['role'] ?? 'administrator',\n   146→        ],\n   147→        'student' => $payload['student'] ?? null,\n   148→    ]);\n   149→})->middleware('throttle:60,1');\n   150→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6d1f50d9-f7c2-41ea-9899-e34a1b3193b4","timestamp":"2026-01-15T19:41:37.066Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php","content":"<?php\n\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Facades\\Cache;\nuse Illuminate\\Support\\Facades\\Route;\nuse App\\Http\\Controllers\\IA\\ServicioIAController;\nuse App\\Http\\Controllers\\Agendas\\AgendaController;\nuse App\\Http\\Controllers\\Pruebas\\PerfilController;\nuse App\\Http\\Controllers\\Pruebas\\PruebaController;\nuse App\\Http\\Controllers\\Vacantes\\VacanteController;\nuse App\\Http\\Controllers\\Planes\\PlanCreditoController;\nuse App\\Http\\Controllers\\IA\\CategoriaServicioIAController;\nuse App\\Http\\Controllers\\OfertasLaborales\\EtapaController;\nuse App\\Http\\Controllers\\Configuraciones\\ArchivoController;\nuse App\\Http\\Controllers\\Vacantes\\FormatoEntrevistaController;\nuse App\\Http\\Controllers\\Vacantes\\EtapaVacanteUsuarioController;\nuse App\\Http\\Controllers\\OfertasLaborales\\OfertaLaboralController;\nuse App\\Http\\Controllers\\OrdenesServicios\\OrdenServicioController;\nuse App\\Http\\Controllers\\Vacantes\\EtapaUsuarioComentarioController;\nuse App\\Http\\Controllers\\OfertasLaborales\\PreguntaOfertaLaboralController;\nuse App\\Http\\Controllers\\OfertasLaborales\\MovimientoConfiguracionController;\nuse App\\Http\\Controllers\\Vacantes\\EtapaMovimientoVacanteConfiguracionController;\nuse App\\Http\\Controllers\\OfertasLaborales\\EtapaMovimientoConfiguracionController;\nuse App\\Http\\Controllers\\OfertasLaborales\\PuntajePreguntaOfertaLaboralController;\nuse App\\Http\\Controllers\\OfertasLaborales\\RespuestaPreguntaOfertaLaboralController;\n\nRoute::middleware('auth:sanctum')->get('/user', function (Request $request) {\n    return $request->user();\n});\n\n/*\n|--------------------------------------------------------------------------|\n| Rutas de prueba                                                          |\n|--------------------------------------------------------------------------|\n */\n\nRoute::get('movimientos-configuraciones-listado', [MovimientoConfiguracionController::class, 'listado']);\nRoute::post('movimientos-configuraciones', [EtapaMovimientoConfiguracionController::class, 'store']);\n\n// Creditos IA\nRoute::get('planes-creditos', [PlanCreditoController::class, 'index']);\nRoute::post('planes-creditos', [PlanCreditoController::class, 'store']);\nRoute::put('planes-creditos/{id}', [PlanCreditoController::class, 'update']);\nRoute::delete('planes-creditos/{id}', [PlanCreditoController::class, 'destroy']);\n\nRoute::get('categorias-servicios-ia', [CategoriaServicioIAController::class, 'index']);\nRoute::post('categorias-servicios-ia', [CategoriaServicioIAController::class, 'store']);\nRoute::put('categorias-servicios-ia/{id}', [CategoriaServicioIAController::class, 'update']);\n\nRoute::get('servicios-ia', [ServicioIAController::class, 'index']);\nRoute::post('servicios-ia', [ServicioIAController::class, 'store']);\nRoute::put('servicios-ia/{id}', [ServicioIAController::class, 'update']);\nRoute::post('servicios-ia/{id}/activar', [ServicioIAController::class, 'activar']);\nRoute::post('servicios-ia/{id}/desactivar', [ServicioIAController::class, 'desactivar']);\n\n// Vacantes\nRoute::post('etapas-movimientos-vacantes-configuraciones', [EtapaMovimientoVacanteConfiguracionController::class, 'store']);\nRoute::post('vacantes-completar/{id}', [VacanteController::class, 'completar']);\n\nRoute::post('generar-descripcion', [OrdenServicioController::class, 'generarDescripcion']);\nRoute::post('etapas-mover/{id}/{orden}', [EtapaController::class, 'cambiarOrden']);\n\nRoute::post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', [OfertaLaboralController::class, 'descartarAplicante']);\n\nRoute::post('agendas-procesar-resultados', [AgendaController::class, 'procesarResultados']);\nRoute::post('agendas-guardar-archivo', [AgendaController::class, 'guardarArchivoAgenda']);\n\nRoute::get('archivos', [ArchivoController::class, 'listado']);\nRoute::get('archivos-obtener-uno', [ArchivoController::class, 'obtenerUno']);\n\nRoute::resource('perfiles', PerfilController::class)->names('api.perfiles');\n\nRoute::post('pruebas-completas-crear', [PruebaController::class, 'crearPruebaCompleta']);\n\nRoute::get('preguntas-prefiltro', [PreguntaOfertaLaboralController::class, 'obtenerPreguntasParaResponder']);\nRoute::post('respuestas-preguntas-ofertas-laborales', [RespuestaPreguntaOfertaLaboralController::class, 'store']);\nRoute::get('verificar-etapa-completada/{etapa_vacante_usuario_id}', [EtapaVacanteUsuarioController::class, 'verificarEtapaCompletada']);\n\n// Adecuaciones de etapas\nRoute::post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', [EtapaVacanteUsuarioController::class, 'generarAdecuacionHV']);\nRoute::post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', [EtapaVacanteUsuarioController::class, 'generarAdecuacionPrefiltro']);\nRoute::post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', [EtapaVacanteUsuarioController::class, 'generarAdecuacionPruebasPsicometricas']);\nRoute::post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', [EtapaVacanteUsuarioController::class, 'generarAdecuacionVideoentrevista']);\nRoute::post('guardar-puntaje-adecuacion-reclutador', [EtapaVacanteUsuarioController::class, 'guardarPuntajeAdecuacionReclutador']);\nRoute::post('guardar-puntaje-pregunta-reclutador', [PuntajePreguntaOfertaLaboralController::class, 'guardarPuntajeReclutador']);\nRoute::resource('etapas-usuarios-comentarios', EtapaUsuarioComentarioController::class)\n    ->only(['index', 'store'])\n    ->names('api.etapas-usuarios-comentarios');\nRoute::get('obtener-adecuacion-usuario', [EtapaVacanteUsuarioController::class, 'obtenerAdecuacionUsuario']);\nRoute::get('obtener-candidatos-recomendados', [EtapaVacanteUsuarioController::class, 'obtenerCandidatosRecomendadosIA']);\nRoute::post('preguntar-candidatos-recomendados', [EtapaVacanteUsuarioController::class, 'preguntarSobreCandidatosRecomendados']);\n\nRoute::resource('formatos-entrevistas', FormatoEntrevistaController::class)\n    ->only(['store', 'update'])\n    ->names('api.formatos-entrevistas');\n\n/**\n * Valida el token SSO recibido desde WordPress.\n *\n * Proceso:\n *  - Recibe el token firmado en el body (`token`).\n *  - Verifica firma y expiración del token.\n *  - Asegura que el nonce exista en cache (uso único) y lo invalida.\n *  - Devuelve datos del usuario admin Y del estudiante (si existe).\n *\n * @author Sergio Vargas\n */\nRoute::post('/sso/validate', function (Request $request) {\n    $token = $request->input('token');\n\n    if (!$token) {\n        return response()->json(['ok' => false, 'error' => 'missing_token'], 400);\n    }\n\n    $payload = sso_verify_token($token, config('services.sso.secret'));\n\n    if (!$payload) {\n        return response()->json(['ok' => false, 'error' => 'invalid_token'], 401);\n    }\n\n    if (($payload['exp'] ?? 0) < time()) {\n        return response()->json(['ok' => false, 'error' => 'expired'], 401);\n    }\n\n    $nonce = $payload['nonce'] ?? null;\n\n    if (!$nonce) {\n        return response()->json(['ok' => false, 'error' => 'missing_nonce'], 401);\n    }\n\n    $cacheKey  = \"sso_nonce:{$nonce}\";\n    $nonceData = Cache::get($cacheKey);\n\n    if (!$nonceData) {\n        return response()->json(['ok' => false, 'error' => 'nonce_used_or_unknown'], 401);\n    }\n\n    Cache::forget($cacheKey);\n\n    return response()->json([\n        'ok'   => true,\n        'user' => [\n            'email' => $payload['email'] ?? null,\n            'name'  => $payload['name'] ?? null,\n            'role'  => $payload['role'] ?? 'administrator',\n        ],\n        'student' => $payload['student'] ?? null,\n    ]);\n})->middleware('throttle:60,1');\n","numLines":150,"startLine":1,"totalLines":150}},"sourceToolAssistantUUID":"cc1b96cf-d435-4872-8db9-0a15e70df05a"}
{"parentUuid":"14cd6286-0024-4fbb-a933-3b435b97340d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014PUHaaqp1Q5pNF5KwVPXXt","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Str;\n     4→use Illuminate\\Http\\Request;\n     5→use Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n     6→\n     7→Route::get('/', function () {\n     8→    return redirect()->route('login');\n     9→});\n    10→\n    11→Auth::routes(['register' => false]);\n    12→\n    13→// Rutas de acceso para aplicante.\n    14→Route::group([\n    15→    'prefix'    => 'control-acceso',\n    16→    'namespace' => 'App\\Http\\Controllers\\Auth'\n    17→], function ($ruta) {\n    18→    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    19→    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    20→    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n    21→});\n    22→\n    23→// Rutas de migración de usuarios desde la base de datos antigua.\n    24→Route::group([\n    25→    'prefix'    => 'migrar-usuario-app-antigua',\n    26→    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n    27→], function ($ruta) {\n    28→    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    29→    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n    30→});\n    31→\n    32→// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\n    33→Route::group([\n    34→    'prefix'     => 'rol-empresa',\n    35→    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    36→    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n    37→], function ($ruta) {\n    38→    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    39→    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n    40→});\n    41→\n    42→// Rutas protegidas por autenticación y selección de rol y empresa.\n    43→Route::group([\n    44→    'middleware' => ['auth', 'auth.rol-empresa'],\n    45→    'namespace'  => 'App\\Http\\Controllers'\n    46→], function ($ruta) {\n    47→    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n    48→\n    49→    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n    50→        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n    51→        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n    52→\n    53→        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n    54→            // Usuarios\n    55→            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n    56→            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n    57→            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n    58→            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n    59→            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n    60→            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n    61→            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n    62→            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n    63→            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n    64→            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n    65→            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n    66→            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n    67→            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n    68→            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n    69→\n    70→            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n    71→            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n    72→            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n    73→        });\n    74→    });\n    75→\n    76→    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n    77→        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n    78→            // Pruebas\n    79→            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n    80→            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n    81→            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n    82→            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n    83→            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n    84→            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n    85→            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n    86→            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n    87→        });\n    88→\n    89→        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n    90→            // Carga masiva de pruebas\n    91→            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n    92→            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n    93→            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n    94→            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n    95→        });\n    96→\n    97→        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n    98→            // Baremos\n    99→            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n   100→            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n   101→            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n   102→            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n   103→        });\n   104→\n   105→        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n   106→            // Dimensiones\n   107→            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n   108→            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n   109→            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n   110→            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n   111→            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n   112→        });\n   113→\n   114→        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n   115→            // Factores\n   116→            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n   117→            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n   118→            $ruta->resource('factores', 'Pruebas\\FactorController');\n   119→            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n   120→        });\n   121→\n   122→        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n   123→            // Reactivos\n   124→            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n   125→            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n   126→            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n   127→\n   128→            // Opciones\n   129→            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n   130→        });\n   131→\n   132→        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n   133→            // Calificaciones\n   134→            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n   135→            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n   136→            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n   137→        });\n   138→\n   139→        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n   140→            // Grupos de opciones\n   141→            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n   142→            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n   143→            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n   144→        });\n   145→\n   146→        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n   147→            // Secciones de texto\n   148→            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n   149→            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n   150→            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n   151→        });\n   152→\n   153→        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n   154→    });\n   155→\n   156→    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n   157→        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n   158→            // Perfiles\n   159→            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n   160→            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n   161→            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n   162→        });\n   163→\n   164→        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n   165→            // Módulos de preguntas\n   166→            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n   167→            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n   168→            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n   169→            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n   170→            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n   171→        });\n   172→\n   173→        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n   174→            // Demográficas\n   175→            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n   176→            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n   177→            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n   178→        });\n   179→    });\n   180→\n   181→    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n   182→        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n   183→            // Listado de empresas\n   184→            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n   185→            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n   186→            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n   187→            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n   188→            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n   189→            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n   190→            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n   191→            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n   192→            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n   193→            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n   194→            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n   195→            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n   196→            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n   197→            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n   198→            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n   199→        });\n   200→\n   201→        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n   202→            // Gestionar empresas\n   203→            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n   204→            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n   205→            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n   206→            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n   207→\n   208→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n   209→                // Usuarios\n   210→                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n   211→                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n   212→            });\n   213→\n   214→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n   215→                // Planes\n   216→                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n   217→                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n   218→            });\n   219→        });\n   220→\n   221→        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n   222→            // Archivo de empresas\n   223→            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n   224→            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n   225→            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n   226→        });\n   227→\n   228→        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n   229→            // Migración de empresas\n   230→            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n   231→            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n   232→            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n   233→            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n   234→        });\n   235→\n   236→        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n   237→            // Portales de empleo\n   238→            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   239→            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   240→            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n   241→            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n   242→\n   243→            // Premios destacados\n   244→            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n   245→            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n   246→\n   247→            // Motivadores\n   248→            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n   249→        });\n   250→\n   251→        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n   252→        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n   253→        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n   254→    });\n   255→\n   256→    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n   257→        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n   258→        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n   259→        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n   260→        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n   261→    });\n   262→\n   263→    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n   264→        // Planes\n   265→        $ruta->resource('planes', 'Planes\\PlanController');\n   266→        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n   267→        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n   268→        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n   269→        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n   270→        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n   271→        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n   272→        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n   273→        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n   274→        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n   275→        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n   276→        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n   277→        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n   278→        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n   279→        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n   280→        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n   281→\n   282→        // Planes de Créditos - Vista de creación\n   283→        $ruta->get('planes-creditos/create', 'Planes\\PlanController@crearPlanCreditos');\n   284→        $ruta->get('planes-creditos/{id}/edit', 'Planes\\PlanController@editarPlanCreditos');\n   285→\n   286→        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n   287→            // Consumos\n   288→            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n   289→            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n   290→            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n   291→            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n   292→            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n   293→            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n   294→            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n   295→            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n   296→            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n   297→            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n   298→            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n   299→        });\n   300→\n   301→        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n   302→            // Archivo\n   303→            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n   304→            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n   305→        });\n   306→    });\n   307→\n   308→    // Perfiles laborales\n   309→    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n   310→    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n   311→    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n   312→    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n   313→\n   314→    // Preguntas de ofertas laborales\n   315→    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n   316→    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n   317→    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n   318→    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n   319→    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n   320→    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n   321→\n   322→    // Preguntas de videoentrevista\n   323→    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n   324→    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n   325→    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n   326→    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n   327→\n   328→    // Vacantes\n   329→    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n   330→    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n   331→    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n   332→    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n   333→    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n   334→    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n   335→    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n   336→    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n   337→    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n   338→    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n   339→    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n   340→    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n   341→\n   342→    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n   343→\n   344→    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n   345→    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n   346→\n   347→    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n   348→        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n   349→            // Ajustes - General\n   350→            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n   351→        });\n   352→\n   353→        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n   354→            // Ajustes - Roles y permisos\n   355→            $ruta->get('roles', 'Auth\\RolController@index');\n   356→        });\n   357→\n   358→        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n   359→            // Ajustes - Deshacer acciones\n   360→            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n   361→            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n   362→            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n   363→            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n   364→        });\n   365→\n   366→        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n   367→            // Ajustes - Ofertas y anuncios\n   368→            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n   369→            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n   370→            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n   371→            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n   372→            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n   373→        });\n   374→\n   375→        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n   376→            // Webinars\n   377→            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n   378→            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n   379→            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n   380→            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n   381→            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n   382→            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n   383→\n   384→            // Eventos\n   385→            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n   386→            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n   387→            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n   388→            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n   389→            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n   390→            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n   391→\n   392→            // Guías\n   393→            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n   394→            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n   395→            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n   396→            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n   397→            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n   398→            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n   399→\n   400→            // Tutoriales\n   401→            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n   402→            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n   403→            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n   404→            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n   405→            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n   406→\n   407→            // Podcast\n   408→            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n   409→            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n   410→            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n   411→            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n   412→            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n   413→\n   414→            // Capacitación\n   415→            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n   416→            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n   417→            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n   418→            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n   419→            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n   420→\n   421→            // Certificación\n   422→            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n   423→            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n   424→            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n   425→            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n   426→            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n   427→            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n   428→        });\n   429→    });\n   430→\n   431→    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n   432→        // Soportes\n   433→        $ruta->resource('soportes', 'Soportes\\SoporteController');\n   434→        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n   435→        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n   436→        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n   437→        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n   438→        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n   439→        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n   440→        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n   441→        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n   442→        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n   443→\n   444→        // Manuales\n   445→        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n   446→        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n   447→\n   448→        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n   449→            // Aplicantes\n   450→            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n   451→        });\n   452→\n   453→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n   454→            // Preguntas frecuentes\n   455→            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n   456→            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n   457→            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n   458→            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n   459→            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n   460→        });\n   461→\n   462→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n   463→            // Preguntas frecuentes reacciónes\n   464→            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n   465→        });\n   466→    });\n   467→\n   468→    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n   469→    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n   470→    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n   471→\n   472→    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n   473→        // Módulos\n   474→        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n   475→        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n   476→\n   477→        // Auditorías\n   478→        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n   479→\n   480→        // Accesos\n   481→        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n   482→\n   483→        // Registros de actividad\n   484→        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n   485→\n   486→        // Novedades\n   487→        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n   488→        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n   489→        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n   490→\n   491→        // Países\n   492→        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n   493→        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n   494→        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n   495→        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n   496→        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n   497→\n   498→        // Reportes\n   499→        $ruta->resource('reportes', 'Reportes\\ReporteController');\n   500→        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n   501→        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n   502→\n   503→        // Minería de datos.\n   504→        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n   505→        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n   506→\n   507→        // Pruebas completas\n   508→        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n   509→        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n   510→        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n   511→        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n   512→        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n   513→    });\n   514→\n   515→    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n   516→        // Ordenes de servicio\n   517→        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n   518→        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n   519→        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n   520→\n   521→        // Ofertas laborales\n   522→        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n   523→        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n   524→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n   525→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n   526→        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n   527→        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n   528→        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n   529→        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n   530→        ->name('sin-disponibilidad-ofertas-laborales');\n   531→        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n   532→        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n   533→        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n   534→        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n   535→        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n   536→        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n   537→        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n   538→\n   539→        // Vacantes\n   540→        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n   541→        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n   542→\n   543→        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n   544→            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n   545→            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n   546→            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n   547→            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n   548→            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n   549→            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n   550→            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n   551→            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n   552→            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n   553→        });\n   554→\n   555→        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n   556→        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n   557→        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n   558→        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n   559→        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n   560→        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n   561→        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n   562→        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n   563→        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n   564→        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n   565→        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n   566→        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n   567→        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n   568→        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n   569→        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n   570→        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n   571→        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n   572→        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n   573→        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n   574→        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n   575→        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n   576→        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n   577→\n   578→        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n   579→        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n   580→        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n   581→\n   582→        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n   583→        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n   584→        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n   585→\n   586→        // Etapas\n   587→        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n   588→        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n   589→        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n   590→        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n   591→        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n   592→        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n   593→\n   594→        // Movimientos\n   595→        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n   596→        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n   597→        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n   598→        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n   599→\n   600→        // Novedades\n   601→        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n   602→\n   603→        $ruta->get('feedback', 'DashboardController@enConstruccion');\n   604→        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n   605→\n   606→        // Procesos\n   607→        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n   608→        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n   609→        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n   610→        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n   611→        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n   612→        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n   613→        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n   614→        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n   615→        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n   616→        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n   617→        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n   618→        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n   619→        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n   620→        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n   621→        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n   622→        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n   623→        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n   624→        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n   625→        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n   626→        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n   627→        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n   628→        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n   629→        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n   630→        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n   631→        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n   632→        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n   633→        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n   634→        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n   635→        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n   636→        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n   637→        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n   638→        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n   639→\n   640→        // Firmas de rutas\n   641→        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n   642→\n   643→        // Perfiles pruebas\n   644→        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n   645→\n   646→        // Agendas\n   647→        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n   648→        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n   649→        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n   650→        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n   651→\n   652→        // Comentarios\n   653→        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n   654→\n   655→        // Usuarios\n   656→        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n   657→    });\n   658→\n   659→    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n   660→        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n   661→\n   662→        // Debug de calificaciones de agendas\n   663→        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n   664→        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n   665→        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n   666→        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n   667→    });\n   668→\n   669→    // Suplantación de rol Administrador general\n   670→    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n   671→        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n   672→    });\n   673→\n   674→    // Suplantación de rol Administrador sucursal\n   675→    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n   676→        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n   677→    });\n   678→\n   679→    // Restablecimiento de la sesión original que había antes de la suplantación\n   680→    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n   681→        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n   682→    });\n   683→\n   684→    // Ruta para completar los datos de un usuario aplicante\n   685→    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n   686→        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n   687→        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n   688→        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n   689→        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n   690→    });\n   691→\n   692→    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n   693→    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n   694→        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n   695→        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n   696→        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n   697→        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n   698→        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n   699→        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n   700→        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n   701→        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n   702→        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n   703→        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n   704→        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n   705→        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n   706→        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n   707→        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n   708→        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n   709→        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n   710→        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n   711→        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n   712→        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n   713→        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   714→        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n   715→            ->name('ofertas-laborales.detalles-aplicante');\n   716→        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   717→        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n   718→\n   719→        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n   720→    });\n   721→\n   722→    // Ofertas laborales\n   723→    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n   724→\n   725→    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n   726→    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n   727→    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n   728→    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n   729→    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n   730→    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n   731→    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n   732→\n   733→    // Usuarios\n   734→    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n   735→    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n   736→\n   737→    // Perfiles\n   738→    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n   739→    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n   740→    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n   741→    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n   742→    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n   743→\n   744→    // Archivos\n   745→    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n   746→    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n   747→    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n   748→\n   749→    // Menú clientes\n   750→    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n   751→    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n   752→    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n   753→\n   754→    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n   755→    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n   756→    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n   757→    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n   758→    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n   759→\n   760→    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n   761→    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n   762→    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n   763→    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n   764→    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n   765→    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n   766→    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n   767→    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n   768→    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n   769→\n   770→    // Agendas - Accesible para aplicantes y usuarios de empresa\n   771→    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n   772→\n   773→    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n   774→    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n   775→    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n   776→    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n   777→    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n   778→\n   779→    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n   780→    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n   781→\n   782→    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n   783→    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n   784→    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n   785→\n   786→    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n   787→    $ruta->get('novedades', 'DashboardController@enConstruccion');\n   788→\n   789→    // Áreas\n   790→    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n   791→    $ruta->post('areas', 'Empresas\\AreaController@store');\n   792→\n   793→    // Cargos\n   794→    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n   795→    $ruta->post('cargos', 'Empresas\\CargoController@store');\n   796→\n   797→    // Niveles educativos\n   798→    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n   799→\n   800→    // Áreas de estudio\n   801→    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n   802→\n   803→    // Idiomas\n   804→    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n   805→\n   806→    // Autenticación del websoket\n   807→    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n   808→\n   809→    $ruta->get('/botones', function () {\n   810→        return view('botones');\n   811→    })->name('botones');\n   812→\n   813→    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n   814→    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n   815→    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n   816→\n   817→    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n   818→    $ruta->get('analiticas', 'DashboardController@index');\n   819→    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n   820→    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n   821→    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n   822→    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n   823→    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n   824→\n   825→    // Rutas de componentes de desarrollo\n   826→    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n   827→    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n   828→\n   829→    // TODO: ruta de prueba, eliminarla próximamente\n   830→    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n   831→    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n   832→    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n   833→    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n   834→    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n   835→\n   836→    // Rutas para las encuestas\n   837→    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n   838→    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n   839→});\n   840→\n   841→// Rutas no protegidas por autenticación\n   842→Route::group([\n   843→    'namespace' => 'App\\Http\\Controllers'\n   844→], function ($ruta) {\n   845→    // Contraseñas\n   846→    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n   847→\n   848→    // Empresas\n   849→    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n   850→    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n   851→    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n   852→    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n   853→    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n   854→\n   855→    // Ordenes de servicio\n   856→    $ruta->group([\n   857→        'middleware' => 'orden-servicio-enlace-publico'\n   858→    ], function ($ruta) {\n   859→        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n   860→        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n   861→    });\n   862→\n   863→    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n   864→\n   865→    // Países\n   866→    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n   867→    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n   868→\n   869→    // Departamentos\n   870→    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n   871→\n   872→    // Ciudades\n   873→    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n   874→\n   875→    // Portales de empleo\n   876→    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n   877→    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n   878→    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n   879→    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n   880→    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n   881→    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n   882→    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n   883→\n   884→    // Firmas de rutas\n   885→    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n   886→    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n   887→    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n   888→    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n   889→\n   890→    // Archivos\n   891→    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n   892→\n   893→    // Imagen de usuarios\n   894→    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n   895→\n   896→    // Consultar reportes con firma\n   897→    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n   898→});\n   899→\n   900→/**\n   901→ * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n   902→ *\n   903→ * @author Fahibram Cárcamo\n   904→ */\n   905→Route::group([\n   906→    'prefix'     => 'rutas-firmadas',\n   907→    'middleware' => ['ruta-firmada'],\n   908→    'namespace'  => 'App\\Http\\Controllers'\n   909→], function ($ruta) {\n   910→    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n   911→    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n   912→});\n   913→\n   914→/**\n   915→ * Genera un token SSO firmado y redirige a WordPress.\n   916→ *\n   917→ * Flujo:\n   918→ *  - Requiere un usuario autenticado (será el admin en WP).\n   919→ *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n   920→ *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n   921→ *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n   922→ *  - Redirige al callback configurado en WordPress.\n   923→ *\n   924→ * @author Sergio Vargas\n   925→ */\n   926→Route::get('/sso/wordpress', function (Request $request) {\n   927→    $user = $request->user();\n   928→\n   929→    $studentId   = $request->input('student_id');\n   930→    $studentData = null;\n   931→\n   932→    if ($studentId) {\n   933→        $student = App\\Models\\Usuarios\\User::find($studentId);\n   934→\n   935→        if ($student && $student->id !== $user->id) {\n   936→            $studentData = [\n   937→                'id'    => (string) $student->id,\n   938→                'email' => $student->email,\n   939→                'name'  => $student->getNombreCompletoAttribute(),\n   940→            ];\n   941→        }\n   942→    }\n   943→\n   944→    $nonce = (string) Str::uuid();\n   945→    $exp   = now()->addSeconds(60)->timestamp;\n   946→\n   947→    Cache::put(\"sso_nonce:{$nonce}\", [\n   948→        'user_id' => $user->id,\n   949→        'exp'     => $exp,\n   950→    ], now()->addMinutes(5));\n   951→\n   952→    $payload = [\n   953→        'sub'     => (string) $user->id,\n   954→        'email'   => $user->email,\n   955→        'name'    => $user->getNombreCompletoAttribute(),\n   956→        'nonce'   => $nonce,\n   957→        'exp'     => $exp,\n   958→        'student' => $studentData,\n   959→    ];\n   960→\n   961→    $token    = sso_sign_token($payload, config('services.sso.secret'));\n   962→    $wp       = rtrim(config('services.sso.wp_url'), '/');\n   963→    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n   964→    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n   965→\n   966→    return redirect()->away(\n   967→        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n   968→    );\n   969→})->middleware('auth');\n   970→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"524119c0-49a2-4aa7-b3f6-e7517e2e6658","timestamp":"2026-01-15T19:41:37.276Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php","content":"<?php\n\nuse Illuminate\\Support\\Str;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n\nRoute::get('/', function () {\n    return redirect()->route('login');\n});\n\nAuth::routes(['register' => false]);\n\n// Rutas de acceso para aplicante.\nRoute::group([\n    'prefix'    => 'control-acceso',\n    'namespace' => 'App\\Http\\Controllers\\Auth'\n], function ($ruta) {\n    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n});\n\n// Rutas de migración de usuarios desde la base de datos antigua.\nRoute::group([\n    'prefix'    => 'migrar-usuario-app-antigua',\n    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n], function ($ruta) {\n    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n});\n\n// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\nRoute::group([\n    'prefix'     => 'rol-empresa',\n    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n], function ($ruta) {\n    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n});\n\n// Rutas protegidas por autenticación y selección de rol y empresa.\nRoute::group([\n    'middleware' => ['auth', 'auth.rol-empresa'],\n    'namespace'  => 'App\\Http\\Controllers'\n], function ($ruta) {\n    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n\n    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n\n        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n            // Usuarios\n            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n\n            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n            // Pruebas\n            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n            // Carga masiva de pruebas\n            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n            // Baremos\n            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n            // Dimensiones\n            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n            // Factores\n            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n            $ruta->resource('factores', 'Pruebas\\FactorController');\n            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n            // Reactivos\n            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n\n            // Opciones\n            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n            // Calificaciones\n            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n            // Grupos de opciones\n            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n            // Secciones de texto\n            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n        });\n\n        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n    });\n\n    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n            // Perfiles\n            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n        });\n\n        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n            // Módulos de preguntas\n            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n        });\n\n        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n            // Demográficas\n            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n            // Listado de empresas\n            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n            // Gestionar empresas\n            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n\n            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n                // Usuarios\n                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n            });\n\n            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n                // Planes\n                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n            });\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n            // Archivo de empresas\n            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n            // Migración de empresas\n            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n            // Portales de empleo\n            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n\n            // Premios destacados\n            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n\n            // Motivadores\n            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n        });\n\n        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n    });\n\n    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n    });\n\n    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n        // Planes\n        $ruta->resource('planes', 'Planes\\PlanController');\n        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n\n        // Planes de Créditos - Vista de creación\n        $ruta->get('planes-creditos/create', 'Planes\\PlanController@crearPlanCreditos');\n        $ruta->get('planes-creditos/{id}/edit', 'Planes\\PlanController@editarPlanCreditos');\n\n        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n            // Consumos\n            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n        });\n\n        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n            // Archivo\n            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n        });\n    });\n\n    // Perfiles laborales\n    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n\n    // Preguntas de ofertas laborales\n    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n\n    // Preguntas de videoentrevista\n    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n\n    // Vacantes\n    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n\n    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n\n    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n\n    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n            // Ajustes - General\n            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n            // Ajustes - Roles y permisos\n            $ruta->get('roles', 'Auth\\RolController@index');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n            // Ajustes - Deshacer acciones\n            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n            // Ajustes - Ofertas y anuncios\n            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n            // Webinars\n            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n\n            // Eventos\n            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n\n            // Guías\n            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n\n            // Tutoriales\n            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n\n            // Podcast\n            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n\n            // Capacitación\n            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n\n            // Certificación\n            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n        // Soportes\n        $ruta->resource('soportes', 'Soportes\\SoporteController');\n        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n\n        // Manuales\n        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n\n        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n            // Aplicantes\n            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n        });\n\n        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n            // Preguntas frecuentes\n            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n        });\n\n        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n            // Preguntas frecuentes reacciónes\n            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n        });\n    });\n\n    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n\n    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n        // Módulos\n        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n\n        // Auditorías\n        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n\n        // Accesos\n        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n\n        // Registros de actividad\n        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n\n        // Novedades\n        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n\n        // Países\n        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n\n        // Reportes\n        $ruta->resource('reportes', 'Reportes\\ReporteController');\n        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n\n        // Minería de datos.\n        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n\n        // Pruebas completas\n        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n    });\n\n    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n        // Ordenes de servicio\n        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n\n        // Ofertas laborales\n        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n        ->name('sin-disponibilidad-ofertas-laborales');\n        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n\n        // Vacantes\n        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n\n        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n        });\n\n        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n\n        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n\n        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n\n        // Etapas\n        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n\n        // Movimientos\n        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n\n        // Novedades\n        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n\n        $ruta->get('feedback', 'DashboardController@enConstruccion');\n        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n\n        // Procesos\n        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n\n        // Firmas de rutas\n        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n\n        // Perfiles pruebas\n        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n\n        // Agendas\n        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n\n        // Comentarios\n        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n\n        // Usuarios\n        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n    });\n\n    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n\n        // Debug de calificaciones de agendas\n        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n    });\n\n    // Suplantación de rol Administrador general\n    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n    });\n\n    // Suplantación de rol Administrador sucursal\n    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n    });\n\n    // Restablecimiento de la sesión original que había antes de la suplantación\n    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n    });\n\n    // Ruta para completar los datos de un usuario aplicante\n    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n    });\n\n    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n            ->name('ofertas-laborales.detalles-aplicante');\n        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n\n        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n    });\n\n    // Ofertas laborales\n    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n\n    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n\n    // Usuarios\n    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n\n    // Perfiles\n    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n\n    // Archivos\n    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n\n    // Menú clientes\n    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n\n    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n\n    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n\n    // Agendas - Accesible para aplicantes y usuarios de empresa\n    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n\n    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n\n    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n\n    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n\n    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n    $ruta->get('novedades', 'DashboardController@enConstruccion');\n\n    // Áreas\n    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n    $ruta->post('areas', 'Empresas\\AreaController@store');\n\n    // Cargos\n    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n    $ruta->post('cargos', 'Empresas\\CargoController@store');\n\n    // Niveles educativos\n    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n\n    // Áreas de estudio\n    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n\n    // Idiomas\n    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n\n    // Autenticación del websoket\n    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n\n    $ruta->get('/botones', function () {\n        return view('botones');\n    })->name('botones');\n\n    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n\n    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n    $ruta->get('analiticas', 'DashboardController@index');\n    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n\n    // Rutas de componentes de desarrollo\n    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n\n    // TODO: ruta de prueba, eliminarla próximamente\n    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n\n    // Rutas para las encuestas\n    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n});\n\n// Rutas no protegidas por autenticación\nRoute::group([\n    'namespace' => 'App\\Http\\Controllers'\n], function ($ruta) {\n    // Contraseñas\n    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n\n    // Empresas\n    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n\n    // Ordenes de servicio\n    $ruta->group([\n        'middleware' => 'orden-servicio-enlace-publico'\n    ], function ($ruta) {\n        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n    });\n\n    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n\n    // Países\n    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n\n    // Departamentos\n    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n\n    // Ciudades\n    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n\n    // Portales de empleo\n    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n\n    // Firmas de rutas\n    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n\n    // Archivos\n    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n\n    // Imagen de usuarios\n    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n\n    // Consultar reportes con firma\n    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n});\n\n/**\n * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n *\n * @author Fahibram Cárcamo\n */\nRoute::group([\n    'prefix'     => 'rutas-firmadas',\n    'middleware' => ['ruta-firmada'],\n    'namespace'  => 'App\\Http\\Controllers'\n], function ($ruta) {\n    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n});\n\n/**\n * Genera un token SSO firmado y redirige a WordPress.\n *\n * Flujo:\n *  - Requiere un usuario autenticado (será el admin en WP).\n *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n *  - Redirige al callback configurado en WordPress.\n *\n * @author Sergio Vargas\n */\nRoute::get('/sso/wordpress', function (Request $request) {\n    $user = $request->user();\n\n    $studentId   = $request->input('student_id');\n    $studentData = null;\n\n    if ($studentId) {\n        $student = App\\Models\\Usuarios\\User::find($studentId);\n\n        if ($student && $student->id !== $user->id) {\n            $studentData = [\n                'id'    => (string) $student->id,\n                'email' => $student->email,\n                'name'  => $student->getNombreCompletoAttribute(),\n            ];\n        }\n    }\n\n    $nonce = (string) Str::uuid();\n    $exp   = now()->addSeconds(60)->timestamp;\n\n    Cache::put(\"sso_nonce:{$nonce}\", [\n        'user_id' => $user->id,\n        'exp'     => $exp,\n    ], now()->addMinutes(5));\n\n    $payload = [\n        'sub'     => (string) $user->id,\n        'email'   => $user->email,\n        'name'    => $user->getNombreCompletoAttribute(),\n        'nonce'   => $nonce,\n        'exp'     => $exp,\n        'student' => $studentData,\n    ];\n\n    $token    = sso_sign_token($payload, config('services.sso.secret'));\n    $wp       = rtrim(config('services.sso.wp_url'), '/');\n    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n\n    return redirect()->away(\n        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n    );\n})->middleware('auth');\n","numLines":970,"startLine":1,"totalLines":970}},"sourceToolAssistantUUID":"14cd6286-0024-4fbb-a933-3b435b97340d"}
{"parentUuid":"5e6f6b7a-592d-474f-9731-889b385aa921","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FDZW65JT38zSNr1rXeQvKv","type":"tool_result","content":"No files found"}]},"uuid":"551d64d9-dedd-4f1b-ae53-fe1637ba41f1","timestamp":"2026-01-15T19:41:38.358Z","toolUseResult":{"filenames":[],"durationMs":1320,"numFiles":0,"truncated":false},"sourceToolAssistantUUID":"5e6f6b7a-592d-474f-9731-889b385aa921"}
{"parentUuid":"2d0dd54d-d805-44f7-b001-3b402ddd8734","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ReG1ncN6LKs97c5pk25V2r","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\EstadoPlan.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Funcionalidad.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\FuncionalidadPlan.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Modulo.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Consumo.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"}]},"uuid":"1b5dbcd1-f024-430c-9b25-2bc037da2883","timestamp":"2026-01-15T19:41:38.385Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\EstadoPlan.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Funcionalidad.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\FuncionalidadPlan.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Modulo.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Consumo.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"],"durationMs":1347,"numFiles":7,"truncated":false},"sourceToolAssistantUUID":"2d0dd54d-d805-44f7-b001-3b402ddd8734"}
{"parentUuid":"1b5dbcd1-f024-430c-9b25-2bc037da2883","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01K3FzkUHhCYeYvmonURiAib","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente. Ahora voy a examinar el controlador PlanController y las vistas relacionadas, además del modelo PlanCredito:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":30475,"cache_read_input_tokens":16386,"cache_creation":{"ephemeral_5m_input_tokens":30475,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jV9ubX6UaSaySmqL9g","type":"assistant","uuid":"e9c84459-8a10-419f-b456-d71b1bf29065","timestamp":"2026-01-15T19:41:41.702Z"}
{"parentUuid":"e9c84459-8a10-419f-b456-d71b1bf29065","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01K3FzkUHhCYeYvmonURiAib","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KQ1QYEaNyhUhpTdW3ZZBHP","name":"Glob","input":{"pattern":"**/Controllers/Planes/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":30475,"cache_read_input_tokens":16386,"cache_creation":{"ephemeral_5m_input_tokens":30475,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jV9ubX6UaSaySmqL9g","type":"assistant","uuid":"3e155bb9-87a8-4d9d-bb98-3708afa87545","timestamp":"2026-01-15T19:41:41.905Z"}
{"parentUuid":"3e155bb9-87a8-4d9d-bb98-3708afa87545","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01K3FzkUHhCYeYvmonURiAib","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LPesyBPHdMDE5Sa5R2kywc","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":30475,"cache_read_input_tokens":16386,"cache_creation":{"ephemeral_5m_input_tokens":30475,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jV9ubX6UaSaySmqL9g","type":"assistant","uuid":"af0be2a7-f868-4218-a7d5-729fc2a37c11","timestamp":"2026-01-15T19:41:42.192Z"}
{"parentUuid":"af0be2a7-f868-4218-a7d5-729fc2a37c11","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01K3FzkUHhCYeYvmonURiAib","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ls7xt7odVSxqpyUkv6BaiQ","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":30475,"cache_read_input_tokens":16386,"cache_creation":{"ephemeral_5m_input_tokens":30475,"ephemeral_1h_input_tokens":0},"output_tokens":226,"service_tier":"standard"}},"requestId":"req_011CX9jV9ubX6UaSaySmqL9g","type":"assistant","uuid":"ae3d550c-eb88-452d-9ff1-ae7212d1ac5d","timestamp":"2026-01-15T19:41:42.394Z"}
{"parentUuid":"af0be2a7-f868-4218-a7d5-729fc2a37c11","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LPesyBPHdMDE5Sa5R2kywc","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Planes;\n     4→\n     5→use OwenIt\\Auditing\\Auditable;\n     6→use App\\Models\\Empresas\\EmpresaPlan;\n     7→use Illuminate\\Database\\Eloquent\\Model;\n     8→use Illuminate\\Database\\Eloquent\\Builder;\n     9→use Illuminate\\Database\\Eloquent\\SoftDeletes;\n    10→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n    11→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    12→\n    13→class PlanCredito extends Model implements AuditableContract\n    14→{\n    15→    use Auditable, SoftDeletes;\n    16→\n    17→    protected $table = 'planes_creditos';\n    18→\n    19→    protected $fillable = [\n    20→        'nombre',\n    21→        'descripcion',\n    22→        'creditos',\n    23→        'precio',\n    24→        'porcentaje_descuento',\n    25→        'fecha_inicio_promocion',\n    26→        'fecha_fin_promocion',\n    27→        'activo'\n    28→    ];\n    29→\n    30→    protected $casts = [\n    31→        'creditos'               => 'integer',\n    32→        'precio'                 => 'decimal:2',\n    33→        'porcentaje_descuento'   => 'integer',\n    34→        'fecha_inicio_promocion' => 'date:Y-m-d',\n    35→        'fecha_fin_promocion'    => 'date:Y-m-d',\n    36→        'activo'                 => 'boolean'\n    37→    ];\n    38→\n    39→    protected $appends = [\n    40→        'precio_con_descuento'\n    41→    ];\n    42→\n    43→    /**\n    44→     * Filtrar registros activos.\n    45→     *\n    46→     * @param Builder $consulta Consulta.\n    47→     * @return Builder\n    48→     * @author Sergio Vargas\n    49→     * @author Daniel Beltrán\n    50→     */\n    51→    public function scopeActivos(Builder $consulta): Builder {\n    52→        return $consulta->where('activo', true);\n    53→    }\n    54→\n    55→    /**\n    56→     * Relación de uno a muchos con empresas_planes.\n    57→     *\n    58→     * @return HasMany\n    59→     * @author Sergio Vargas\n    60→     * @author Daniel Beltrán\n    61→     */\n    62→    public function empresasPlanes(): HasMany {\n    63→        return $this->hasMany(EmpresaPlan::class, 'plan_credito_id');\n    64→    }\n    65→\n    66→    /**\n    67→     * Obtener el precio con descuento aplicado.\n    68→     *\n    69→     * @return float\n    70→     * @author Sergio Vargas\n    71→     * @author Daniel Beltrán\n    72→     */\n    73→    public function getPrecioConDescuentoAttribute(): float {\n    74→        if (!$this->estaEnPromocion()) {\n    75→            return (float) $this->precio;\n    76→        }\n    77→\n    78→        $porcentaje = $this->porcentaje_descuento ?? 0;\n    79→        $descuento  = $this->precio * ($porcentaje / 100);\n    80→\n    81→        return (float) max(0, $this->precio - $descuento);\n    82→    }\n    83→\n    84→    /**\n    85→     * Verificar si el plan esta en promoción vigente.\n    86→     *\n    87→     * @return bool\n    88→     * @author Sergio Vargas\n    89→     * @author Daniel Beltrán\n    90→     */\n    91→    public function estaEnPromocion(): bool {\n    92→        if (!$this->porcentaje_descuento) {\n    93→            return false;\n    94→        }\n    95→\n    96→        $hoy = now()->startOfDay();\n    97→\n    98→        if ($this->fecha_inicio_promocion && $hoy->lt($this->fecha_inicio_promocion)) {\n    99→            return false;\n   100→        }\n   101→\n   102→        if ($this->fecha_fin_promocion && $hoy->gt($this->fecha_fin_promocion)) {\n   103→            return false;\n   104→        }\n   105→\n   106→        return true;\n   107→    }\n   108→}\n   109→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a8f42e19-fc5b-4d6e-8176-2fd77485ed56","timestamp":"2026-01-15T19:41:45.132Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php","content":"<?php\n\nnamespace App\\Models\\Planes;\n\nuse OwenIt\\Auditing\\Auditable;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Builder;\nuse Illuminate\\Database\\Eloquent\\SoftDeletes;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\nuse OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n\nclass PlanCredito extends Model implements AuditableContract\n{\n    use Auditable, SoftDeletes;\n\n    protected $table = 'planes_creditos';\n\n    protected $fillable = [\n        'nombre',\n        'descripcion',\n        'creditos',\n        'precio',\n        'porcentaje_descuento',\n        'fecha_inicio_promocion',\n        'fecha_fin_promocion',\n        'activo'\n    ];\n\n    protected $casts = [\n        'creditos'               => 'integer',\n        'precio'                 => 'decimal:2',\n        'porcentaje_descuento'   => 'integer',\n        'fecha_inicio_promocion' => 'date:Y-m-d',\n        'fecha_fin_promocion'    => 'date:Y-m-d',\n        'activo'                 => 'boolean'\n    ];\n\n    protected $appends = [\n        'precio_con_descuento'\n    ];\n\n    /**\n     * Filtrar registros activos.\n     *\n     * @param Builder $consulta Consulta.\n     * @return Builder\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function scopeActivos(Builder $consulta): Builder {\n        return $consulta->where('activo', true);\n    }\n\n    /**\n     * Relación de uno a muchos con empresas_planes.\n     *\n     * @return HasMany\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function empresasPlanes(): HasMany {\n        return $this->hasMany(EmpresaPlan::class, 'plan_credito_id');\n    }\n\n    /**\n     * Obtener el precio con descuento aplicado.\n     *\n     * @return float\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getPrecioConDescuentoAttribute(): float {\n        if (!$this->estaEnPromocion()) {\n            return (float) $this->precio;\n        }\n\n        $porcentaje = $this->porcentaje_descuento ?? 0;\n        $descuento  = $this->precio * ($porcentaje / 100);\n\n        return (float) max(0, $this->precio - $descuento);\n    }\n\n    /**\n     * Verificar si el plan esta en promoción vigente.\n     *\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function estaEnPromocion(): bool {\n        if (!$this->porcentaje_descuento) {\n            return false;\n        }\n\n        $hoy = now()->startOfDay();\n\n        if ($this->fecha_inicio_promocion && $hoy->lt($this->fecha_inicio_promocion)) {\n            return false;\n        }\n\n        if ($this->fecha_fin_promocion && $hoy->gt($this->fecha_fin_promocion)) {\n            return false;\n        }\n\n        return true;\n    }\n}\n","numLines":109,"startLine":1,"totalLines":109}},"sourceToolAssistantUUID":"af0be2a7-f868-4218-a7d5-729fc2a37c11"}
{"parentUuid":"ae3d550c-eb88-452d-9ff1-ae7212d1ac5d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ls7xt7odVSxqpyUkv6BaiQ","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Planes;\n     4→\n     5→use OwenIt\\Auditing\\Auditable;\n     6→use App\\Models\\Empresas\\Empresa;\n     7→use App\\Models\\Pruebas\\TipoPrueba;\n     8→use Illuminate\\Database\\Eloquent\\Model;\n     9→use Illuminate\\Database\\Eloquent\\SoftDeletes;\n    10→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    11→use Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\n    12→use Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n    13→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    14→\n    15→class Plan extends Model implements AuditableContract\n    16→{\n    17→    use HasFactory, SoftDeletes, Auditable;\n    18→\n    19→    public const ESTADO_ACTIVO_ID     = 1;\n    20→    public const ESTADO_INACTIVO_ID   = 2;\n    21→    public const ESTADO_PROXIMO_ID    = 3;\n    22→    public const ESTADO_POR_VENCER_ID = 4;\n    23→    public const ESTADO_VENCIDO_ID    = 5;\n    24→\n    25→    protected $table = 'planes';\n    26→\n    27→    protected $fillable = [\n    28→        'tipo_prueba_id',\n    29→        'nombre',\n    30→        'descripcion',\n    31→        'unidades',\n    32→        'cantidad_ofertas_laborales',\n    33→        'vigencia',\n    34→        'cantidad_usuarios',\n    35→        'cantidad_pruebas',\n    36→        'precio',\n    37→        'en_promocion',\n    38→        'porcentaje_descuento',\n    39→        'fecha_inicio_promocion',\n    40→        'fecha_fin_promocion',\n    41→        'comentario',\n    42→        'activo'\n    43→    ];\n    44→\n    45→    protected $casts = [\n    46→        'created_at' => 'datetime:d/m/Y',\n    47→        'updated_at' => 'datetime:d/m/Y'\n    48→    ];\n    49→\n    50→    /**\n    51→     * Relación de muchos a uno con tipos_pruebas.\n    52→     *\n    53→     * @return BelongsTo\n    54→     * @author Daniel Beltrán\n    55→     */\n    56→    public function tipoPrueba(): BelongsTo {\n    57→        return $this->belongsTo(TipoPrueba::class);\n    58→    }\n    59→\n    60→    /**\n    61→     * Relación de muchos a muchos con funcionalidades.\n    62→     *\n    63→     * @return BelongsToMany\n    64→     * @author Daniel Beltrán\n    65→     */\n    66→    public function funcionalidades(): BelongsToMany {\n    67→        return $this->belongsToMany(Funcionalidad::class, 'funcionalidades_planes', 'plan_id', 'funcionalidad_id')->withTimestamps();\n    68→    }\n    69→\n    70→    /**\n    71→     * Relación de muchos a muchos con modulos.\n    72→     *\n    73→     * @return BelongsToMany\n    74→     * @author Daniel Beltrán\n    75→     */\n    76→    public function modulos(): BelongsToMany {\n    77→        return $this->belongsToMany(Modulo::class, 'modulos_planes', 'plan_id', 'modulo_id')->withTimestamps();\n    78→    }\n    79→\n    80→    /**\n    81→     * Relación de muchos a muchos con empresas.\n    82→     *\n    83→     * @return BelongsToMany\n    84→     * @author Daniel Beltrán\n    85→     */\n    86→    public function empresas(): BelongsToMany {\n    87→        return $this->belongsToMany(Empresa::class, 'empresas_planes', 'plan_id', 'empresa_id')\n    88→        ->withPivot(['unidades', 'fecha_vencimiento', 'precio'])\n    89→        ->withTimestamps();\n    90→    }\n    91→}\n    92→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fa5f03a6-6251-4e47-9a39-dfbf8e5d2957","timestamp":"2026-01-15T19:41:45.132Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\Plan.php","content":"<?php\n\nnamespace App\\Models\\Planes;\n\nuse OwenIt\\Auditing\\Auditable;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\SoftDeletes;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\nuse OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n\nclass Plan extends Model implements AuditableContract\n{\n    use HasFactory, SoftDeletes, Auditable;\n\n    public const ESTADO_ACTIVO_ID     = 1;\n    public const ESTADO_INACTIVO_ID   = 2;\n    public const ESTADO_PROXIMO_ID    = 3;\n    public const ESTADO_POR_VENCER_ID = 4;\n    public const ESTADO_VENCIDO_ID    = 5;\n\n    protected $table = 'planes';\n\n    protected $fillable = [\n        'tipo_prueba_id',\n        'nombre',\n        'descripcion',\n        'unidades',\n        'cantidad_ofertas_laborales',\n        'vigencia',\n        'cantidad_usuarios',\n        'cantidad_pruebas',\n        'precio',\n        'en_promocion',\n        'porcentaje_descuento',\n        'fecha_inicio_promocion',\n        'fecha_fin_promocion',\n        'comentario',\n        'activo'\n    ];\n\n    protected $casts = [\n        'created_at' => 'datetime:d/m/Y',\n        'updated_at' => 'datetime:d/m/Y'\n    ];\n\n    /**\n     * Relación de muchos a uno con tipos_pruebas.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function tipoPrueba(): BelongsTo {\n        return $this->belongsTo(TipoPrueba::class);\n    }\n\n    /**\n     * Relación de muchos a muchos con funcionalidades.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function funcionalidades(): BelongsToMany {\n        return $this->belongsToMany(Funcionalidad::class, 'funcionalidades_planes', 'plan_id', 'funcionalidad_id')->withTimestamps();\n    }\n\n    /**\n     * Relación de muchos a muchos con modulos.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function modulos(): BelongsToMany {\n        return $this->belongsToMany(Modulo::class, 'modulos_planes', 'plan_id', 'modulo_id')->withTimestamps();\n    }\n\n    /**\n     * Relación de muchos a muchos con empresas.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function empresas(): BelongsToMany {\n        return $this->belongsToMany(Empresa::class, 'empresas_planes', 'plan_id', 'empresa_id')\n        ->withPivot(['unidades', 'fecha_vencimiento', 'precio'])\n        ->withTimestamps();\n    }\n}\n","numLines":92,"startLine":1,"totalLines":92}},"sourceToolAssistantUUID":"ae3d550c-eb88-452d-9ff1-ae7212d1ac5d"}
{"parentUuid":"3e155bb9-87a8-4d9d-bb98-3708afa87545","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KQ1QYEaNyhUhpTdW3ZZBHP","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ConsumoController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadPlanController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ModuloController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php"}]},"uuid":"f6584388-b96b-4e18-8ade-fb059de588d3","timestamp":"2026-01-15T19:41:46.122Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ConsumoController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\FuncionalidadPlanController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\ModuloController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php"],"durationMs":1012,"numFiles":6,"truncated":false},"sourceToolAssistantUUID":"3e155bb9-87a8-4d9d-bb98-3708afa87545"}
{"parentUuid":"f6584388-b96b-4e18-8ade-fb059de588d3","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01HHCbpU5Hd4R2NTXYYWC8Ry","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a ver el controlador PlanController y PlanCreditoController:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2635,"cache_creation_input_tokens":618,"cache_read_input_tokens":46861,"cache_creation":{"ephemeral_5m_input_tokens":618,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jVicMcxauvjohh7UQy","type":"assistant","uuid":"d01296f1-74c3-4442-ac68-d07915e3c37c","timestamp":"2026-01-15T19:41:48.251Z"}
{"parentUuid":"d01296f1-74c3-4442-ac68-d07915e3c37c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01HHCbpU5Hd4R2NTXYYWC8Ry","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0169JwvqwTYuJAxqqmMAzXLb","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2635,"cache_creation_input_tokens":618,"cache_read_input_tokens":46861,"cache_creation":{"ephemeral_5m_input_tokens":618,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jVicMcxauvjohh7UQy","type":"assistant","uuid":"526c4c57-cd38-4d0e-b71a-b95a716f4e38","timestamp":"2026-01-15T19:41:48.783Z"}
{"parentUuid":"526c4c57-cd38-4d0e-b71a-b95a716f4e38","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01HHCbpU5Hd4R2NTXYYWC8Ry","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018jER25nLR7Jjh6oWKBkRHN","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2635,"cache_creation_input_tokens":618,"cache_read_input_tokens":46861,"cache_creation":{"ephemeral_5m_input_tokens":618,"ephemeral_1h_input_tokens":0},"output_tokens":178,"service_tier":"standard"}},"requestId":"req_011CX9jVicMcxauvjohh7UQy","type":"assistant","uuid":"e8f7c19a-db49-4488-b7b0-79ee44bea7d6","timestamp":"2026-01-15T19:41:49.038Z"}
{"parentUuid":"526c4c57-cd38-4d0e-b71a-b95a716f4e38","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0169JwvqwTYuJAxqqmMAzXLb","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\View\\View;\n     7→use App\\Traits\\SesionTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use App\\Exports\\GlobalExport;\n    10→use Illuminate\\Http\\JsonResponse;\n    11→use Illuminate\\Support\\Facades\\DB;\n    12→use App\\Http\\Controllers\\Controller;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Http\\Services\\Planes\\PlanService;\n    16→use App\\Http\\Services\\Empresas\\CargoService;\n    17→use App\\Http\\Requests\\Planes\\CrearPlanRequest;\n    18→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    21→use App\\Http\\Repositories\\Pruebas\\PerfilRepository;\n    22→use App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    23→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    24→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    25→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    26→use Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    27→use App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n    28→\n    29→class PlanController extends Controller\n    30→{\n    31→    use SesionTrait;\n    32→\n    33→    /**\n    34→     * Constructor.\n    35→     *\n    36→     * @param PlanService $servicio Servicio de planes.\n    37→     * @param PlanRepository $repositorio Repositorio de planes.\n    38→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n    39→     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n    40→     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n    41→     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    42→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    43→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    44→     * @param CargoService $cargo_servicio Servicio de cargos.\n    45→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    46→     * @return void\n    47→     * @author Daniel Beltrán\n    48→     * @author Fahibram Cárcamo\n    49→     */\n    50→    public function __construct(\n    51→        private PlanService $servicio,\n    52→        private PlanRepository $repositorio,\n    53→        private PlanCreditoRepository $plan_credito_repositorio,\n    54→        private TipoPruebaRepository $tipo_prueba_repositorio,\n    55→        private RutaRepository $ruta_repositorio,\n    56→        private PerfilRepository $perfil_repositorio,\n    57→        private PruebaRepository $prueba_repositorio,\n    58→        private EmpresaRepository $empresa_repositorio,\n    59→        private RolRepository $rol_repositorio,\n    60→        private CargoService $cargo_servicio,\n    61→        private UserRepository $usuario_repositorio\n    62→    ) {}\n    63→\n    64→    /**\n    65→     * Obtener el listado de planes.\n    66→     *\n    67→     * @param Request $request Contenido de la petición.\n    68→     * @return JsonResponse\n    69→     * @author Daniel Beltrán\n    70→     */\n    71→    public function listado(Request $request): JsonResponse {\n    72→        return new JsonResponse([\n    73→            'data' => $this->repositorio->getTodo($request)\n    74→        ], 200);\n    75→    }\n    76→\n    77→    /**\n    78→     * Cargar la página principal.\n    79→     *\n    80→     * @return View\n    81→     * @author Daniel Beltrán\n    82→     */\n    83→    public function index(): View {\n    84→        return view('planes.index')->with([\n    85→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n    86→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    87→        ]);\n    88→    }\n    89→\n    90→    /**\n    91→     * Cargar la página para crear.\n    92→     *\n    93→     * @return View\n    94→     * @author Sol Espitia\n    95→     */\n    96→    public function paginaConsumos(): View {\n    97→        return view('planes.paginas.consumos')->with([\n    98→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    99→        ]);\n   100→    }\n   101→\n   102→    /**\n   103→     * Cargar la página para crear.\n   104→     *\n   105→     * @return View\n   106→     * @author Daniel Beltrán\n   107→     */\n   108→    public function create(): View {\n   109→        return view('planes.paginas.crear')->with([\n   110→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   111→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   112→        ]);\n   113→    }\n   114→\n   115→    /**\n   116→     * Obtener un plan.\n   117→     *\n   118→     * @param int $id ID del plan.\n   119→     * @return JsonResponse\n   120→     * @author Daniel Beltrán\n   121→     */\n   122→    public function show(int $id): JsonResponse {\n   123→        return new JsonResponse([\n   124→            'data' => $this->repositorio->getUno($id)\n   125→        ], 200);\n   126→    }\n   127→\n   128→    /**\n   129→     * Cargar la página para editar.\n   130→     *\n   131→     * @param int $id ID del plan.\n   132→     * @return View\n   133→     * @author Daniel Beltrán\n   134→     */\n   135→    public function edit(int $id): View {\n   136→        return view('planes.paginas.crear')->with([\n   137→            'plan'          => $this->repositorio->getUno($id),\n   138→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   139→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   140→        ]);\n   141→    }\n   142→\n   143→    /**\n   144→     * Crear plan.\n   145→     *\n   146→     * @param CrearPlanRequest $request Contenido de la petición.\n   147→     * @return JsonResponse\n   148→     * @author Daniel Beltrán\n   149→     */\n   150→    public function store(CrearPlanRequest $request): JsonResponse {\n   151→        $codigo    = 201;\n   152→        $respuesta = [\n   153→            'message' => 'Plan creado correctamente'\n   154→        ];\n   155→\n   156→        try {\n   157→            DB::beginTransaction();\n   158→            $this->servicio->guardar($request);\n   159→            DB::commit();\n   160→        } catch (Exception $error) {\n   161→            DB::rollBack();\n   162→\n   163→            $codigo    = 400;\n   164→            $respuesta = [\n   165→                'message' => 'Ocurrió un error',\n   166→                'errors'  => $error->getMessage()\n   167→            ];\n   168→        }\n   169→\n   170→        return new JsonResponse($respuesta, $codigo);\n   171→    }\n   172→\n   173→    /**\n   174→     * Actualizar plan.\n   175→     *\n   176→     * @param int $id ID del plan.\n   177→     * @param CrearPlanRequest $request Contenido de la petición.\n   178→     * @return JsonResponse\n   179→     * @author Daniel Beltrán\n   180→     */\n   181→    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n   182→        $codigo    = 200;\n   183→        $respuesta = [\n   184→            'message' => 'Plan actualizado correctamente'\n   185→        ];\n   186→\n   187→        try {\n   188→            DB::beginTransaction();\n   189→            $request->merge(['id' => $id]);\n   190→            $this->servicio->guardar($request);\n   191→            DB::commit();\n   192→        } catch (Exception $error) {\n   193→            DB::rollBack();\n   194→\n   195→            $codigo    = 400;\n   196→            $respuesta = [\n   197→                'message' => 'Ocurrió un error',\n   198→                'errors'  => $error->getMessage()\n   199→            ];\n   200→        }\n   201→\n   202→        return new JsonResponse($respuesta, $codigo);\n   203→    }\n   204→\n   205→    /**\n   206→     * Eliminar plan.\n   207→     *\n   208→     * @param int $id ID del plan.\n   209→     * @return JsonResponse\n   210→     * @author Daniel Beltrán\n   211→     */\n   212→    public function destroy(int $id): JsonResponse {\n   213→        $codigo    = 200;\n   214→        $respuesta = [\n   215→            'tipo'    => 'success',\n   216→            'mensaje' => 'Plan eliminado correctamente'\n   217→        ];\n   218→\n   219→        try {\n   220→            DB::beginTransaction();\n   221→            $this->servicio->eliminar($id);\n   222→            DB::commit();\n   223→        } catch (Exception $error) {\n   224→            DB::rollBack();\n   225→\n   226→            $codigo    = 400;\n   227→            $respuesta = [\n   228→                'message' => 'Ocurrió un error',\n   229→                'errors'  => $error->getMessage()\n   230→            ];\n   231→        }\n   232→\n   233→        return new JsonResponse($respuesta, $codigo);\n   234→    }\n   235→\n   236→    /**\n   237→     * Archivar o desarchivar plan.\n   238→     *\n   239→     * @param int $id ID del plan.\n   240→     * @param Request $request Contenido de la petición.\n   241→     * @return JsonResponse\n   242→     * @author Daniel Beltrán\n   243→     */\n   244→    public function archivar(int $id, Request $request): JsonResponse {\n   245→        $codigo    = 200;\n   246→        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n   247→        $accion    = $activo ? 'desarchivado' : 'archivado';\n   248→        $respuesta = [\n   249→            'tipo'    => 'success',\n   250→            'mensaje' => \"Plan {$accion} correctamente\"\n   251→        ];\n   252→\n   253→        $request->merge([\n   254→            'id'         => $id,\n   255→            'activo'     => $activo,\n   256→            'comentario' => $request->filled('comentario') ? $request->comentario : null\n   257→        ]);\n   258→\n   259→        try {\n   260→            DB::beginTransaction();\n   261→            $this->servicio->guardar($request);\n   262→            DB::commit();\n   263→        } catch (Exception $error) {\n   264→            DB::rollBack();\n   265→\n   266→            $codigo    = 400;\n   267→            $respuesta = [\n   268→                'message' => 'Ocurrió un error',\n   269→                'errors'  => $error->getMessage()\n   270→            ];\n   271→        }\n   272→\n   273→        return new JsonResponse($respuesta, $codigo);\n   274→    }\n   275→\n   276→    /**\n   277→     * Clonar plan.\n   278→     *\n   279→     * @param int $id ID del plan.\n   280→     * @return JsonResponse\n   281→     * @author Daniel Beltrán\n   282→     */\n   283→    public function clonar(int $id): JsonResponse {\n   284→        $codigo    = 201;\n   285→        $respuesta = [\n   286→            'message' => 'Plan clonado correctamente'\n   287→        ];\n   288→\n   289→        try {\n   290→            DB::beginTransaction();\n   291→            $respuesta['data'] = $this->servicio->clonar($id);\n   292→            DB::commit();\n   293→        } catch (Exception $error) {\n   294→            DB::rollBack();\n   295→\n   296→            $codigo    = 400;\n   297→            $respuesta = [\n   298→                'message' => 'Ocurrió un error',\n   299→                'errors'  => $error->getMessage()\n   300→            ];\n   301→        }\n   302→\n   303→        return new JsonResponse($respuesta, $codigo);\n   304→    }\n   305→\n   306→    /**\n   307→     * Obtener el historial de cambios.\n   308→     *\n   309→     * @param int $id ID del plan.\n   310→     * @return JsonResponse\n   311→     * @author Daniel Beltrán\n   312→     */\n   313→    public function historialCambios(int $id): JsonResponse {\n   314→        return new JsonResponse([\n   315→            'data' => $this->servicio->historialCambios($id)\n   316→        ], 200);\n   317→    }\n   318→\n   319→    /**\n   320→     * Exportar Excel.\n   321→     *\n   322→     * @param Request $request Contenido de la petición.\n   323→     * @return BinaryFileResponse\n   324→     * @author Daniel Beltrán\n   325→     */\n   326→    public function exportarExcel(Request $request): BinaryFileResponse {\n   327→        return Excel::download(new GlobalExport([\n   328→            'ID',\n   329→            'Nombre del plan',\n   330→            'Tipo de prueba',\n   331→            'Pruebas disponibles',\n   332→            'Tiempo',\n   333→            'Unidades',\n   334→            'Ofertas laborales',\n   335→            'Beneficios predeterminados',\n   336→            'Beneficios adicionales',\n   337→            'Usuarios',\n   338→            'Costo',\n   339→            'Fecha de creación',\n   340→            'Empresas con plan activo'\n   341→        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n   342→    }\n   343→\n   344→    /**\n   345→     * Carga la vista que muestra los planes de una empresa dada.\n   346→     *\n   347→     * @return View\n   348→     * @author Fahibram Cárcamo\n   349→     */\n   350→    public function planesClientes(): View {\n   351→        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n   352→        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n   353→        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n   354→        $empresas   = clone $sucursales;\n   355→        $empresas->push($empresa);\n   356→        $empresas_ids = array_column($empresas->toArray(), 'id');\n   357→        return view('empresa.paginas.planes.planes')->with([\n   358→            'empresa'    => $empresa,\n   359→            'usuario_id' => Auth::id(),\n   360→            'sucursales' => $empresas,\n   361→            'planes'     => $this->repositorio->getTodoBasico(),\n   362→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   363→            'perfiles'   => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n   364→            'pruebas'    => $this->prueba_repositorio->getTodo(new Request()),\n   365→            'roles'      => $this->rol_repositorio->getTodo(new Request()),\n   366→            'cargos'     => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n   367→            'usuarios'   => $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n   368→                new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n   369→                $empresa\n   370→            )\n   371→        ]);\n   372→    }\n   373→\n   374→    /**\n   375→     * Cargar la página para crear plan de créditos.\n   376→     *\n   377→     * @return View\n   378→     * @author Andres Morales\n   379→     */\n   380→    public function crearPlanCreditos(): View {\n   381→        return view('planes.paginas.crear-creditos')->with([\n   382→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   383→        ]);\n   384→    }\n   385→\n   386→    /**\n   387→     * Cargar la página para editar plan de créditos.\n   388→     *\n   389→     * @param int $id\n   390→     * @return View\n   391→     * @author Sergio Vargas\n   392→     */\n   393→    public function editarPlanCreditos(int $id): View {\n   394→        return view('planes.paginas.crear-creditos')->with([\n   395→            'plan'       => $this->plan_credito_repositorio->getUno($id),\n   396→            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n   397→        ]);\n   398→    }\n   399→}\n   400→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"64820b50-a7db-498a-a79f-45a1065e6c12","timestamp":"2026-01-15T19:41:50.979Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php","content":"<?php\n\nnamespace App\\Http\\Controllers\\Planes;\n\nuse Exception;\nuse Illuminate\\View\\View;\nuse App\\Traits\\SesionTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Exports\\GlobalExport;\nuse Illuminate\\Http\\JsonResponse;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Http\\Controllers\\Controller;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse App\\Http\\Services\\Planes\\PlanService;\nuse App\\Http\\Services\\Empresas\\CargoService;\nuse App\\Http\\Requests\\Planes\\CrearPlanRequest;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Pruebas\\PerfilRepository;\nuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\nuse Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\nuse App\\Http\\Repositories\\Configuraciones\\RutaRepository;\n\nclass PlanController extends Controller\n{\n    use SesionTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param PlanService $servicio Servicio de planes.\n     * @param PlanRepository $repositorio Repositorio de planes.\n     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de prueba.\n     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param CargoService $cargo_servicio Servicio de cargos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(\n        private PlanService $servicio,\n        private PlanRepository $repositorio,\n        private PlanCreditoRepository $plan_credito_repositorio,\n        private TipoPruebaRepository $tipo_prueba_repositorio,\n        private RutaRepository $ruta_repositorio,\n        private PerfilRepository $perfil_repositorio,\n        private PruebaRepository $prueba_repositorio,\n        private EmpresaRepository $empresa_repositorio,\n        private RolRepository $rol_repositorio,\n        private CargoService $cargo_servicio,\n        private UserRepository $usuario_repositorio\n    ) {}\n\n    /**\n     * Obtener el listado de planes.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function listado(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->repositorio->getTodo($request)\n        ], 200);\n    }\n\n    /**\n     * Cargar la página principal.\n     *\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function index(): View {\n        return view('planes.index')->with([\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Cargar la página para crear.\n     *\n     * @return View\n     * @author Sol Espitia\n     */\n    public function paginaConsumos(): View {\n        return view('planes.paginas.consumos')->with([\n            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Cargar la página para crear.\n     *\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function create(): View {\n        return view('planes.paginas.crear')->with([\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Obtener un plan.\n     *\n     * @param int $id ID del plan.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function show(int $id): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->repositorio->getUno($id)\n        ], 200);\n    }\n\n    /**\n     * Cargar la página para editar.\n     *\n     * @param int $id ID del plan.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function edit(int $id): View {\n        return view('planes.paginas.crear')->with([\n            'plan'          => $this->repositorio->getUno($id),\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Crear plan.\n     *\n     * @param CrearPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function store(CrearPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan creado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar plan.\n     *\n     * @param int $id ID del plan.\n     * @param CrearPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function update(int $id, CrearPlanRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Plan actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $request->merge(['id' => $id]);\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Eliminar plan.\n     *\n     * @param int $id ID del plan.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function destroy(int $id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'tipo'    => 'success',\n            'mensaje' => 'Plan eliminado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->eliminar($id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Archivar o desarchivar plan.\n     *\n     * @param int $id ID del plan.\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function archivar(int $id, Request $request): JsonResponse {\n        $codigo    = 200;\n        $activo    = $request->filled('activo') ? filter_var($request->activo, FILTER_VALIDATE_BOOLEAN) : false;\n        $accion    = $activo ? 'desarchivado' : 'archivado';\n        $respuesta = [\n            'tipo'    => 'success',\n            'mensaje' => \"Plan {$accion} correctamente\"\n        ];\n\n        $request->merge([\n            'id'         => $id,\n            'activo'     => $activo,\n            'comentario' => $request->filled('comentario') ? $request->comentario : null\n        ]);\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Clonar plan.\n     *\n     * @param int $id ID del plan.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function clonar(int $id): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan clonado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $respuesta['data'] = $this->servicio->clonar($id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Obtener el historial de cambios.\n     *\n     * @param int $id ID del plan.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function historialCambios(int $id): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->historialCambios($id)\n        ], 200);\n    }\n\n    /**\n     * Exportar Excel.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return BinaryFileResponse\n     * @author Daniel Beltrán\n     */\n    public function exportarExcel(Request $request): BinaryFileResponse {\n        return Excel::download(new GlobalExport([\n            'ID',\n            'Nombre del plan',\n            'Tipo de prueba',\n            'Pruebas disponibles',\n            'Tiempo',\n            'Unidades',\n            'Ofertas laborales',\n            'Beneficios predeterminados',\n            'Beneficios adicionales',\n            'Usuarios',\n            'Costo',\n            'Fecha de creación',\n            'Empresas con plan activo'\n        ], $this->servicio->datosExcel($request), 'Planes', 'excel.planes.planes'), 'planes.xlsx');\n    }\n\n    /**\n     * Carga la vista que muestra los planes de una empresa dada.\n     *\n     * @return View\n     * @author Fahibram Cárcamo\n     */\n    public function planesClientes(): View {\n        $empresa_id = $this->existeEnSesion('empresa_id') ? $this->obtenerDeSesion('empresa_id') : null;\n        $empresa    = $this->empresa_repositorio->getUnoBasico($empresa_id, new Request(['con_usuarios' => true]));\n        $sucursales = $this->empresa_repositorio->obtenerSucursales($empresa_id, new Request(['con_usuarios' => true]));\n        $empresas   = clone $sucursales;\n        $empresas->push($empresa);\n        $empresas_ids = array_column($empresas->toArray(), 'id');\n        return view('empresa.paginas.planes.planes')->with([\n            'empresa'    => $empresa,\n            'usuario_id' => Auth::id(),\n            'sucursales' => $empresas,\n            'planes'     => $this->repositorio->getTodoBasico(),\n            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'perfiles'   => $this->perfil_repositorio->obtenerPerfilesEmpresas($empresas_ids),\n            'pruebas'    => $this->prueba_repositorio->getTodo(new Request()),\n            'roles'      => $this->rol_repositorio->getTodo(new Request()),\n            'cargos'     => $this->cargo_servicio->obtenerCargosEmpresaSucursales($empresa),\n            'usuarios'   => $this->usuario_repositorio->obtenerUsuariosSucursalesEmpresa(\n                new Request(['con_rol_tipo_empresa' => true, 'con_relaciones' => true]),\n                $empresa\n            )\n        ]);\n    }\n\n    /**\n     * Cargar la página para crear plan de créditos.\n     *\n     * @return View\n     * @author Andres Morales\n     */\n    public function crearPlanCreditos(): View {\n        return view('planes.paginas.crear-creditos')->with([\n            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Cargar la página para editar plan de créditos.\n     *\n     * @param int $id\n     * @return View\n     * @author Sergio Vargas\n     */\n    public function editarPlanCreditos(int $id): View {\n        return view('planes.paginas.crear-creditos')->with([\n            'plan'       => $this->plan_credito_repositorio->getUno($id),\n            'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n        ]);\n    }\n}\n","numLines":400,"startLine":1,"totalLines":400}},"sourceToolAssistantUUID":"526c4c57-cd38-4d0e-b71a-b95a716f4e38"}
{"parentUuid":"e8f7c19a-db49-4488-b7b0-79ee44bea7d6","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018jER25nLR7Jjh6oWKBkRHN","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\Planes;\n     4→\n     5→use Exception;\n     6→use Illuminate\\Http\\Request;\n     7→use Illuminate\\Http\\JsonResponse;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Http\\Controllers\\Controller;\n    10→use App\\Http\\Services\\Planes\\PlanCreditoService;\n    11→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    12→\n    13→class PlanCreditoController extends Controller\n    14→{\n    15→    /**\n    16→     * Constructor.\n    17→     *\n    18→     * @param PlanCreditoService $servicio Servicio de planes de créditos.\n    19→     * @param PlanCreditoRepository $repositorio Repositorio de planes de créditos.\n    20→     * @return void\n    21→     * @author Sergio Vargas\n    22→     * @author Daniel Beltrán\n    23→     */\n    24→    public function __construct(\n    25→        private PlanCreditoService $servicio,\n    26→        private PlanCreditoRepository $repositorio\n    27→    ) {}\n    28→\n    29→    /**\n    30→     * Listar planes de créditos.\n    31→     *\n    32→     * @param Request $request Contenido de la petición.\n    33→     * @return JsonResponse\n    34→     * @author Sergio Vargas\n    35→     * @author Daniel Beltrán\n    36→     */\n    37→    public function index(Request $request): JsonResponse {\n    38→        return new JsonResponse([\n    39→            'data' => $this->repositorio->getTodo($request),\n    40→        ], JsonResponse::HTTP_OK);\n    41→    }\n    42→\n    43→    /**\n    44→     * Crear plan de créditos.\n    45→     *\n    46→     * @param Request $request Contenido de la petición.\n    47→     * @return JsonResponse\n    48→     * @author Sergio Vargas\n    49→     * @author Daniel Beltrán\n    50→     */\n    51→    public function store(Request $request): JsonResponse {\n    52→        $codigo    = JsonResponse::HTTP_CREATED;\n    53→        $respuesta = ['message' => 'Plan de créditos creado correctamente'];\n    54→\n    55→        try {\n    56→            DB::beginTransaction();\n    57→            $this->servicio->guardar($request);\n    58→            DB::commit();\n    59→        } catch (Exception $error) {\n    60→            DB::rollBack();\n    61→            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n    62→            $respuesta = [\n    63→                'message' => 'Ocurrio un error',\n    64→                'errors'  => $error->getMessage(),\n    65→            ];\n    66→        }\n    67→\n    68→        return new JsonResponse($respuesta, $codigo);\n    69→    }\n    70→\n    71→    /**\n    72→     * Actualizar plan de créditos.\n    73→     *\n    74→     * @param int $id ID del plan de créditos.\n    75→     * @param Request $request Contenido de la petición.\n    76→     * @return JsonResponse\n    77→     * @author Sergio Vargas\n    78→     * @author Daniel Beltrán\n    79→     */\n    80→    public function update(int $id, Request $request): JsonResponse {\n    81→        $codigo    = JsonResponse::HTTP_OK;\n    82→        $respuesta = ['message' => 'Plan de créditos actualizado correctamente'];\n    83→\n    84→        try {\n    85→            DB::beginTransaction();\n    86→            $request->merge(['id' => $id]);\n    87→            $this->servicio->guardar($request);\n    88→            DB::commit();\n    89→        } catch (Exception $error) {\n    90→            DB::rollBack();\n    91→            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n    92→            $respuesta = [\n    93→                'message' => 'Ocurrio un error',\n    94→                'errors'  => $error->getMessage(),\n    95→            ];\n    96→        }\n    97→\n    98→        return new JsonResponse($respuesta, $codigo);\n    99→    }\n   100→\n   101→    /**\n   102→     * Eliminar plan de creditos.\n   103→     *\n   104→     * @param int $id ID del plan de créditos.\n   105→     * @return JsonResponse\n   106→     * @author Sergio Vargas\n   107→     * @author Daniel Beltrán\n   108→     */\n   109→    public function destroy(int $id): JsonResponse {\n   110→        $codigo    = JsonResponse::HTTP_OK;\n   111→        $respuesta = ['message' => 'Plan de créditos eliminado correctamente'];\n   112→\n   113→        try {\n   114→            DB::beginTransaction();\n   115→            $this->repositorio->eliminar($id);\n   116→            DB::commit();\n   117→        } catch (Exception $error) {\n   118→            DB::rollBack();\n   119→            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n   120→            $respuesta = [\n   121→                'message' => 'Ocurrio un error',\n   122→                'errors'  => $error->getMessage(),\n   123→            ];\n   124→        }\n   125→\n   126→        return new JsonResponse($respuesta, $codigo);\n   127→    }\n   128→}\n   129→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e33711c8-ff1f-4302-862f-9bf56e6983d5","timestamp":"2026-01-15T19:41:50.979Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php","content":"<?php\n\nnamespace App\\Http\\Controllers\\Planes;\n\nuse Exception;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\JsonResponse;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Http\\Controllers\\Controller;\nuse App\\Http\\Services\\Planes\\PlanCreditoService;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n\nclass PlanCreditoController extends Controller\n{\n    /**\n     * Constructor.\n     *\n     * @param PlanCreditoService $servicio Servicio de planes de créditos.\n     * @param PlanCreditoRepository $repositorio Repositorio de planes de créditos.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        private PlanCreditoService $servicio,\n        private PlanCreditoRepository $repositorio\n    ) {}\n\n    /**\n     * Listar planes de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function index(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->repositorio->getTodo($request),\n        ], JsonResponse::HTTP_OK);\n    }\n\n    /**\n     * Crear plan de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function store(Request $request): JsonResponse {\n        $codigo    = JsonResponse::HTTP_CREATED;\n        $respuesta = ['message' => 'Plan de créditos creado correctamente'];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n            $respuesta = [\n                'message' => 'Ocurrio un error',\n                'errors'  => $error->getMessage(),\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar plan de créditos.\n     *\n     * @param int $id ID del plan de créditos.\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function update(int $id, Request $request): JsonResponse {\n        $codigo    = JsonResponse::HTTP_OK;\n        $respuesta = ['message' => 'Plan de créditos actualizado correctamente'];\n\n        try {\n            DB::beginTransaction();\n            $request->merge(['id' => $id]);\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n            $respuesta = [\n                'message' => 'Ocurrio un error',\n                'errors'  => $error->getMessage(),\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Eliminar plan de creditos.\n     *\n     * @param int $id ID del plan de créditos.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function destroy(int $id): JsonResponse {\n        $codigo    = JsonResponse::HTTP_OK;\n        $respuesta = ['message' => 'Plan de créditos eliminado correctamente'];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->eliminar($id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n            $respuesta = [\n                'message' => 'Ocurrio un error',\n                'errors'  => $error->getMessage(),\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n}\n","numLines":129,"startLine":1,"totalLines":129}},"sourceToolAssistantUUID":"e8f7c19a-db49-4488-b7b0-79ee44bea7d6"}
{"parentUuid":"e33711c8-ff1f-4302-862f-9bf56e6983d5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PpnesG2bMPN2FBuoQnGgfb","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora necesito ver los repositorios y servicios, además de buscar cómo se relacionan los servicios con los créditos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":9846,"cache_read_input_tokens":47479,"cache_creation":{"ephemeral_5m_input_tokens":9846,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jW5poadh4iRt59vCRt","type":"assistant","uuid":"c12a7c32-34d5-4d7c-94db-02ecadea923f","timestamp":"2026-01-15T19:41:54.675Z"}
{"parentUuid":"c12a7c32-34d5-4d7c-94db-02ecadea923f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PpnesG2bMPN2FBuoQnGgfb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YFBbr74wirQiZqMS64AqQU","name":"Glob","input":{"pattern":"**/Repositories/Planes/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":9846,"cache_read_input_tokens":47479,"cache_creation":{"ephemeral_5m_input_tokens":9846,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jW5poadh4iRt59vCRt","type":"assistant","uuid":"758b7cc6-8141-4644-b4a6-e05412226ac5","timestamp":"2026-01-15T19:41:55.056Z"}
{"parentUuid":"758b7cc6-8141-4644-b4a6-e05412226ac5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PpnesG2bMPN2FBuoQnGgfb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SX5pJQfiZ63SzkWHCNnGTP","name":"Glob","input":{"pattern":"**/Services/Planes/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":9846,"cache_read_input_tokens":47479,"cache_creation":{"ephemeral_5m_input_tokens":9846,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jW5poadh4iRt59vCRt","type":"assistant","uuid":"b69ac316-edeb-4739-b538-32566e7d4604","timestamp":"2026-01-15T19:41:55.166Z"}
{"parentUuid":"b69ac316-edeb-4739-b538-32566e7d4604","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PpnesG2bMPN2FBuoQnGgfb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016GdWNb9p552Pgr22TzfnTL","name":"Grep","input":{"pattern":"ServicioIA|servicio.*ia|credito.*servicio","type":"php","head_limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":9846,"cache_read_input_tokens":47479,"cache_creation":{"ephemeral_5m_input_tokens":9846,"ephemeral_1h_input_tokens":0},"output_tokens":227,"service_tier":"standard"}},"requestId":"req_011CX9jW5poadh4iRt59vCRt","type":"assistant","uuid":"2f9855ee-b4a8-4fd2-9901-f3271b145138","timestamp":"2026-01-15T19:41:55.699Z"}
{"parentUuid":"2f9855ee-b4a8-4fd2-9901-f3271b145138","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016GdWNb9p552Pgr22TzfnTL","type":"tool_result","content":"Found 20 files limit: 20, offset: 0\napp\\Http\\Services\\Vacantes\\EtapaVacanteService.php\napp\\Http\\Services\\Vacantes\\VacanteService.php\nroutes\\api.php\ndatabase\\seeders\\ServicioIASeeder.php\ndatabase\\seeders\\DatabaseSeeder.php\ndatabase\\migrations\\2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php\ndatabase\\seeders\\CategoriaServicioIASeeder.php\ndatabase\\migrations\\2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php\ndatabase\\migrations\\2026_01_02_000003_create_servicios_ia_table.php\ndatabase\\migrations\\2026_01_02_000002_create_categorias_servicios_ia_table.php\napp\\Traits\\IATrait.php\napp\\Models\\IA\\ConsumoCredito.php\napp\\Models\\IA\\ServicioIA.php\napp\\Models\\IA\\CategoriaServicioIA.php\napp\\Http\\Services\\IA\\ConsumoCreditoService.php\napp\\Http\\Services\\IA\\CreditoIAService.php\napp\\Http\\Repositories\\IA\\ServicioIARepository.php\napp\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php\napp\\Http\\Repositories\\IA\\CategoriaServicioIARepository.php\napp\\Http\\Controllers\\Planes\\PlanController.php"}]},"uuid":"15455b92-d470-4075-b928-c09c98966228","timestamp":"2026-01-15T19:41:59.253Z","toolUseResult":{"mode":"files_with_matches","filenames":["app\\Http\\Services\\Vacantes\\EtapaVacanteService.php","app\\Http\\Services\\Vacantes\\VacanteService.php","routes\\api.php","database\\seeders\\ServicioIASeeder.php","database\\seeders\\DatabaseSeeder.php","database\\migrations\\2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php","database\\seeders\\CategoriaServicioIASeeder.php","database\\migrations\\2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php","database\\migrations\\2026_01_02_000003_create_servicios_ia_table.php","database\\migrations\\2026_01_02_000002_create_categorias_servicios_ia_table.php","app\\Traits\\IATrait.php","app\\Models\\IA\\ConsumoCredito.php","app\\Models\\IA\\ServicioIA.php","app\\Models\\IA\\CategoriaServicioIA.php","app\\Http\\Services\\IA\\ConsumoCreditoService.php","app\\Http\\Services\\IA\\CreditoIAService.php","app\\Http\\Repositories\\IA\\ServicioIARepository.php","app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php","app\\Http\\Repositories\\IA\\CategoriaServicioIARepository.php","app\\Http\\Controllers\\Planes\\PlanController.php"],"numFiles":20,"appliedLimit":20},"sourceToolAssistantUUID":"2f9855ee-b4a8-4fd2-9901-f3271b145138"}
{"parentUuid":"758b7cc6-8141-4644-b4a6-e05412226ac5","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YFBbr74wirQiZqMS64AqQU","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\ConsumoRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\FuncionalidadPlanRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\FuncionalidadRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\ModuloRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanRepository.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php"}]},"uuid":"750588a7-03ea-40c6-a273-1b1b261c3720","timestamp":"2026-01-15T19:41:59.652Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\ConsumoRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\FuncionalidadPlanRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\FuncionalidadRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\ModuloRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanRepository.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php"],"durationMs":1281,"numFiles":6,"truncated":false},"sourceToolAssistantUUID":"758b7cc6-8141-4644-b4a6-e05412226ac5"}
{"parentUuid":"b69ac316-edeb-4739-b538-32566e7d4604","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SX5pJQfiZ63SzkWHCNnGTP","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\ConsumoService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\FuncionalidadPlanService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanService.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php"}]},"uuid":"309c756a-6ac7-49c0-a2dd-79828e27bfe8","timestamp":"2026-01-15T19:41:59.667Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\ConsumoService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\FuncionalidadPlanService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanService.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php"],"durationMs":1295,"numFiles":4,"truncated":false},"sourceToolAssistantUUID":"b69ac316-edeb-4739-b538-32566e7d4604"}
{"parentUuid":"309c756a-6ac7-49c0-a2dd-79828e27bfe8","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Px5xibNv8gcTcdDMifJbrX","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente, hay modelos y servicios de IA. Voy a examinar esos archivos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":428,"cache_creation_input_tokens":689,"cache_read_input_tokens":57325,"cache_creation":{"ephemeral_5m_input_tokens":689,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jWhpWFF3FXDK1jcFuD","type":"assistant","uuid":"161fb2f0-f4a7-4160-98ac-3de6da533b80","timestamp":"2026-01-15T19:42:01.888Z"}
{"parentUuid":"161fb2f0-f4a7-4160-98ac-3de6da533b80","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Px5xibNv8gcTcdDMifJbrX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ETf65v2dxgV3SY98VENVDX","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":428,"cache_creation_input_tokens":689,"cache_read_input_tokens":57325,"cache_creation":{"ephemeral_5m_input_tokens":689,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jWhpWFF3FXDK1jcFuD","type":"assistant","uuid":"5b53179d-0133-49b4-bff2-7ab0035b4c38","timestamp":"2026-01-15T19:42:02.419Z"}
{"parentUuid":"5b53179d-0133-49b4-bff2-7ab0035b4c38","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Px5xibNv8gcTcdDMifJbrX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01159SJ1D5nNhxPWspUEBM5Z","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":428,"cache_creation_input_tokens":689,"cache_read_input_tokens":57325,"cache_creation":{"ephemeral_5m_input_tokens":689,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jWhpWFF3FXDK1jcFuD","type":"assistant","uuid":"acd2c74a-0fc1-449e-b1b0-11a81d80f7c6","timestamp":"2026-01-15T19:42:02.764Z"}
{"parentUuid":"acd2c74a-0fc1-449e-b1b0-11a81d80f7c6","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Px5xibNv8gcTcdDMifJbrX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Jkqe33pZWTw6RSo748xctE","name":"Glob","input":{"pattern":"**/Models/IA/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":428,"cache_creation_input_tokens":689,"cache_read_input_tokens":57325,"cache_creation":{"ephemeral_5m_input_tokens":689,"ephemeral_1h_input_tokens":0},"output_tokens":230,"service_tier":"standard"}},"requestId":"req_011CX9jWhpWFF3FXDK1jcFuD","type":"assistant","uuid":"acf9eb72-642d-4890-b189-4c97edda37aa","timestamp":"2026-01-15T19:42:02.951Z"}
{"parentUuid":"5b53179d-0133-49b4-bff2-7ab0035b4c38","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ETf65v2dxgV3SY98VENVDX","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\Planes;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\Planes\\PlanCredito;\n     7→use Illuminate\\Support\\Collection;\n     8→use App\\Http\\Repositories\\BaseRepository;\n     9→\n    10→class PlanCreditoRepository extends BaseRepository\n    11→{\n    12→    /**\n    13→     * Constructor.\n    14→     *\n    15→     * @param PlanCredito $modelo Modelo de planes de créditos.\n    16→     * @return void\n    17→     * @author Sergio Vargas\n    18→     * @author Daniel Beltrán\n    19→     */\n    20→    public function __construct(PlanCredito $modelo) {\n    21→        parent::__construct($modelo);\n    22→    }\n    23→\n    24→    /**\n    25→     * Obtener planes de créditos.\n    26→     *\n    27→     * @param Request $request Contenido de la petición.\n    28→     * @return Collection\n    29→     * @author Sergio Vargas\n    30→     * @author Daniel Beltrán\n    31→     */\n    32→    public function getTodo(Request $request): Collection {\n    33→        return $this->modelo->select('id', 'nombre', 'descripcion', 'creditos', 'precio', 'porcentaje_descuento', 'fecha_inicio_promocion', 'fecha_fin_promocion', 'activo', 'created_at')\n    34→        ->withCount(['empresasPlanes as empresas_activas'])\n    35→        ->when($request->filled('activo'), function ($consulta) use ($request) {\n    36→            $consulta->where('activo', filter_var($request->activo, FILTER_VALIDATE_BOOLEAN));\n    37→        })\n    38→        ->when($request->filled('nombre'), function ($consulta) use ($request) {\n    39→            $consulta->where('nombre', 'like', \"%{$request->nombre}%\");\n    40→        })\n    41→        ->orderBy('created_at', 'DESC')\n    42→        ->get();\n    43→    }\n    44→\n    45→    /**\n    46→     * Obtener planes en promoción vigente.\n    47→     *\n    48→     * @return Collection\n    49→     * @author Sergio Vargas\n    50→     * @author Daniel Beltrán\n    51→     */\n    52→    public function planesEnPromocion(): Collection {\n    53→        return $this->modelo->select('id', 'nombre', 'descripcion', 'creditos', 'precio', 'porcentaje_descuento', 'fecha_inicio_promocion', 'fecha_fin_promocion', 'activo')\n    54→        ->where('activo', true)\n    55→        ->whereNotNull('porcentaje_descuento')\n    56→        ->where(function ($consulta) {\n    57→            $hoy = now()->startOfDay();\n    58→\n    59→            $consulta->where(function ($consulta) use ($hoy) {\n    60→                $consulta->whereNull('fecha_inicio_promocion')\n    61→                ->orWhere('fecha_inicio_promocion', '<=', $hoy);\n    62→            })->where(function ($consulta) use ($hoy) {\n    63→                $consulta->whereNull('fecha_fin_promocion')\n    64→                ->orWhere('fecha_fin_promocion', '>=', $hoy);\n    65→            });\n    66→        })\n    67→        ->get();\n    68→    }\n    69→}\n    70→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3362a977-ca2e-4773-9541-f17eb0e9a788","timestamp":"2026-01-15T19:42:05.741Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php","content":"<?php\n\nnamespace App\\Http\\Repositories\\Planes;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Planes\\PlanCredito;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\BaseRepository;\n\nclass PlanCreditoRepository extends BaseRepository\n{\n    /**\n     * Constructor.\n     *\n     * @param PlanCredito $modelo Modelo de planes de créditos.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(PlanCredito $modelo) {\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener planes de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getTodo(Request $request): Collection {\n        return $this->modelo->select('id', 'nombre', 'descripcion', 'creditos', 'precio', 'porcentaje_descuento', 'fecha_inicio_promocion', 'fecha_fin_promocion', 'activo', 'created_at')\n        ->withCount(['empresasPlanes as empresas_activas'])\n        ->when($request->filled('activo'), function ($consulta) use ($request) {\n            $consulta->where('activo', filter_var($request->activo, FILTER_VALIDATE_BOOLEAN));\n        })\n        ->when($request->filled('nombre'), function ($consulta) use ($request) {\n            $consulta->where('nombre', 'like', \"%{$request->nombre}%\");\n        })\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    /**\n     * Obtener planes en promoción vigente.\n     *\n     * @return Collection\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function planesEnPromocion(): Collection {\n        return $this->modelo->select('id', 'nombre', 'descripcion', 'creditos', 'precio', 'porcentaje_descuento', 'fecha_inicio_promocion', 'fecha_fin_promocion', 'activo')\n        ->where('activo', true)\n        ->whereNotNull('porcentaje_descuento')\n        ->where(function ($consulta) {\n            $hoy = now()->startOfDay();\n\n            $consulta->where(function ($consulta) use ($hoy) {\n                $consulta->whereNull('fecha_inicio_promocion')\n                ->orWhere('fecha_inicio_promocion', '<=', $hoy);\n            })->where(function ($consulta) use ($hoy) {\n                $consulta->whereNull('fecha_fin_promocion')\n                ->orWhere('fecha_fin_promocion', '>=', $hoy);\n            });\n        })\n        ->get();\n    }\n}\n","numLines":70,"startLine":1,"totalLines":70}},"sourceToolAssistantUUID":"5b53179d-0133-49b4-bff2-7ab0035b4c38"}
{"parentUuid":"acd2c74a-0fc1-449e-b1b0-11a81d80f7c6","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01159SJ1D5nNhxPWspUEBM5Z","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Planes;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Http\\Services\\BaseService;\n     7→use App\\Models\\Planes\\PlanCredito;\n     8→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n     9→\n    10→/**\n    11→ * @property PlanCreditoRepository $repositorio\n    12→ */\n    13→class PlanCreditoService extends BaseService\n    14→{\n    15→    /**\n    16→     * Constructor.\n    17→     *\n    18→     * @param PlanCreditoRepository $repositorio Repositorio de planes de créditos.\n    19→     * @return void\n    20→     * @author Sergio Vargas\n    21→     * @author Daniel Beltrán\n    22→     */\n    23→    public function __construct(PlanCreditoRepository $repositorio) {\n    24→        parent::__construct($repositorio);\n    25→    }\n    26→\n    27→    /**\n    28→     * Crear o actualizar un plan de créditos.\n    29→     *\n    30→     * @param Request $request Contenido de la petición.\n    31→     * @return PlanCredito\n    32→     * @author Sergio Vargas\n    33→     * @author Daniel Beltrán\n    34→     */\n    35→    public function guardar(Request $request): PlanCredito {\n    36→        $campos_excluidos = ['_token', '_method', 'id'];\n    37→\n    38→        if ($request->filled('id')) {\n    39→            return $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n    40→        }\n    41→\n    42→        return $this->repositorio->crear($request->except($campos_excluidos));\n    43→    }\n    44→\n    45→    /**\n    46→     * Calcular el precio final del plan.\n    47→     *\n    48→     * @param PlanCredito $plan Plan de crédito.\n    49→     * @return float\n    50→     * @author Sergio Vargas\n    51→     * @author Daniel Beltrán\n    52→     */\n    53→    public function calcularPrecioFinal(PlanCredito $plan): float {\n    54→        return $plan->precio_con_descuento;\n    55→    }\n    56→}\n    57→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"bcb93ae0-b405-4b52-8a45-2a89ac39419f","timestamp":"2026-01-15T19:42:05.742Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Planes;\n\nuse Illuminate\\Http\\Request;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Planes\\PlanCredito;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n\n/**\n * @property PlanCreditoRepository $repositorio\n */\nclass PlanCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param PlanCreditoRepository $repositorio Repositorio de planes de créditos.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(PlanCreditoRepository $repositorio) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Crear o actualizar un plan de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return PlanCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function guardar(Request $request): PlanCredito {\n        $campos_excluidos = ['_token', '_method', 'id'];\n\n        if ($request->filled('id')) {\n            return $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        }\n\n        return $this->repositorio->crear($request->except($campos_excluidos));\n    }\n\n    /**\n     * Calcular el precio final del plan.\n     *\n     * @param PlanCredito $plan Plan de crédito.\n     * @return float\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function calcularPrecioFinal(PlanCredito $plan): float {\n        return $plan->precio_con_descuento;\n    }\n}\n","numLines":57,"startLine":1,"totalLines":57}},"sourceToolAssistantUUID":"acd2c74a-0fc1-449e-b1b0-11a81d80f7c6"}
{"parentUuid":"acf9eb72-642d-4890-b189-4c97edda37aa","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Jkqe33pZWTw6RSo748xctE","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\CategoriaServicioIA.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php"}]},"uuid":"e01df846-4d55-4af9-8357-241c5f2e9e6e","timestamp":"2026-01-15T19:42:06.934Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\CategoriaServicioIA.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php"],"durationMs":1220,"numFiles":3,"truncated":false},"sourceToolAssistantUUID":"acf9eb72-642d-4890-b189-4c97edda37aa"}
{"parentUuid":"e01df846-4d55-4af9-8357-241c5f2e9e6e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RDssNhyZTNmVgj3b9u9Sfr","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a ver los modelos de IA y las vistas de crear-creditos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2989,"cache_read_input_tokens":58014,"cache_creation":{"ephemeral_5m_input_tokens":2989,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jXFZE55eTo36SVVTY7","type":"assistant","uuid":"e522273e-6d49-4cc1-b086-126c90c025a9","timestamp":"2026-01-15T19:42:08.812Z"}
{"parentUuid":"e522273e-6d49-4cc1-b086-126c90c025a9","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RDssNhyZTNmVgj3b9u9Sfr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SxqPEgMU3Y7wXmoiyS3yHW","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2989,"cache_read_input_tokens":58014,"cache_creation":{"ephemeral_5m_input_tokens":2989,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jXFZE55eTo36SVVTY7","type":"assistant","uuid":"6bb6a440-1ae0-4f23-ac9e-d8ec9eef6104","timestamp":"2026-01-15T19:42:09.140Z"}
{"parentUuid":"6bb6a440-1ae0-4f23-ac9e-d8ec9eef6104","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RDssNhyZTNmVgj3b9u9Sfr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01F3uvc9732EBo1kawwxUW79","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2989,"cache_read_input_tokens":58014,"cache_creation":{"ephemeral_5m_input_tokens":2989,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jXFZE55eTo36SVVTY7","type":"assistant","uuid":"b72c8231-ee3f-4cde-8467-a66a51013370","timestamp":"2026-01-15T19:42:09.513Z"}
{"parentUuid":"b72c8231-ee3f-4cde-8467-a66a51013370","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RDssNhyZTNmVgj3b9u9Sfr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QYvxoinCWdYE9MR6MfG7Ac","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\paginas\\crear-creditos.blade.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2989,"cache_read_input_tokens":58014,"cache_creation":{"ephemeral_5m_input_tokens":2989,"ephemeral_1h_input_tokens":0},"output_tokens":247,"service_tier":"standard"}},"requestId":"req_011CX9jXFZE55eTo36SVVTY7","type":"assistant","uuid":"82bcf497-6fc8-4ba2-8fc5-97d7af640569","timestamp":"2026-01-15T19:42:09.738Z"}
{"parentUuid":"6bb6a440-1ae0-4f23-ac9e-d8ec9eef6104","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SxqPEgMU3Y7wXmoiyS3yHW","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\IA;\n     4→\n     5→use Illuminate\\Database\\Eloquent\\Model;\n     6→use Illuminate\\Database\\Eloquent\\Builder;\n     7→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n     8→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n     9→\n    10→class ServicioIA extends Model\n    11→{\n    12→    protected $table = 'servicios_ia';\n    13→\n    14→    protected $fillable = [\n    15→        'categoria_servicio_ia_id',\n    16→        'nombre',\n    17→        'endpoint',\n    18→        'descripcion',\n    19→        'consume_creditos',\n    20→        'activo'\n    21→    ];\n    22→\n    23→    protected $casts = [\n    24→        'categoria_servicio_ia_id' => 'integer',\n    25→        'consume_creditos'         => 'integer',\n    26→        'activo'                   => 'boolean'\n    27→    ];\n    28→\n    29→    /**\n    30→     * Filtrar por registros activos.\n    31→     *\n    32→     * @param Builder $consulta Consulta.\n    33→     * @return Builder\n    34→     * @author Sergio Vargas\n    35→     * @author Daniel Beltrán\n    36→     */\n    37→    public function scopeActivos(Builder $consulta): Builder {\n    38→        return $consulta->where('activo', true);\n    39→    }\n    40→\n    41→    /**\n    42→     * Filtrar por endpoint.\n    43→     *\n    44→     * @param Builder $consulta Consulta.\n    45→     * @param string $endpoint Enpoint por el cual filtrar.\n    46→     * @return Builder\n    47→     * @author Sergio Vargas\n    48→     * @author Daniel Beltrán\n    49→     */\n    50→    public function scopePorEndpoint(Builder $consulta, string $endpoint): Builder {\n    51→        return $consulta->where('endpoint', $endpoint);\n    52→    }\n    53→\n    54→    /**\n    55→     * Relación de muchos a uno con categorias_ia.\n    56→     *\n    57→     * @return BelongsTo\n    58→     * @author Sergio Vargas\n    59→     * @author Daniel Beltrán\n    60→     */\n    61→    public function categoria(): BelongsTo {\n    62→        return $this->belongsTo(CategoriaServicioIA::class, 'categoria_servicio_ia_id');\n    63→    }\n    64→\n    65→    /**\n    66→     * Relación de uno a muchos con consumos_creditos.\n    67→     *\n    68→     * @return HasMany\n    69→     * @author Sergio Vargas\n    70→     * @author Daniel Beltrán\n    71→     */\n    72→    public function consumosCreditos(): HasMany {\n    73→        return $this->hasMany(ConsumoCredito::class, 'servicio_ia_id');\n    74→    }\n    75→}\n    76→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"47e21d9a-7788-4cfc-88c7-cf01a62bbad2","timestamp":"2026-01-15T19:42:12.660Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php","content":"<?php\n\nnamespace App\\Models\\IA;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Builder;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n\nclass ServicioIA extends Model\n{\n    protected $table = 'servicios_ia';\n\n    protected $fillable = [\n        'categoria_servicio_ia_id',\n        'nombre',\n        'endpoint',\n        'descripcion',\n        'consume_creditos',\n        'activo'\n    ];\n\n    protected $casts = [\n        'categoria_servicio_ia_id' => 'integer',\n        'consume_creditos'         => 'integer',\n        'activo'                   => 'boolean'\n    ];\n\n    /**\n     * Filtrar por registros activos.\n     *\n     * @param Builder $consulta Consulta.\n     * @return Builder\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function scopeActivos(Builder $consulta): Builder {\n        return $consulta->where('activo', true);\n    }\n\n    /**\n     * Filtrar por endpoint.\n     *\n     * @param Builder $consulta Consulta.\n     * @param string $endpoint Enpoint por el cual filtrar.\n     * @return Builder\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function scopePorEndpoint(Builder $consulta, string $endpoint): Builder {\n        return $consulta->where('endpoint', $endpoint);\n    }\n\n    /**\n     * Relación de muchos a uno con categorias_ia.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function categoria(): BelongsTo {\n        return $this->belongsTo(CategoriaServicioIA::class, 'categoria_servicio_ia_id');\n    }\n\n    /**\n     * Relación de uno a muchos con consumos_creditos.\n     *\n     * @return HasMany\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function consumosCreditos(): HasMany {\n        return $this->hasMany(ConsumoCredito::class, 'servicio_ia_id');\n    }\n}\n","numLines":76,"startLine":1,"totalLines":76}},"sourceToolAssistantUUID":"6bb6a440-1ae0-4f23-ac9e-d8ec9eef6104"}
{"parentUuid":"b72c8231-ee3f-4cde-8467-a66a51013370","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01F3uvc9732EBo1kawwxUW79","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\IA;\n     4→\n     5→use App\\Models\\Usuarios\\User;\n     6→use App\\Models\\Agendas\\Agenda;\n     7→use App\\Models\\Empresas\\Empresa;\n     8→use App\\Models\\Vacantes\\Vacante;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use Illuminate\\Database\\Eloquent\\Model;\n    11→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    12→\n    13→class ConsumoCredito extends Model\n    14→{\n    15→    protected $table = 'consumos_creditos';\n    16→\n    17→    protected $fillable = [\n    18→        'usuario_id',\n    19→        'empresa_id',\n    20→        'empresa_plan_id',\n    21→        'agenda_id',\n    22→        'vacante_id',\n    23→        'servicio_ia_id',\n    24→        'creditos',\n    25→        'ruta_endpoint',\n    26→        'nombre_servicio',\n    27→        'modelo',\n    28→        'tokens_entrada',\n    29→        'tokens_salida',\n    30→        'tokens_totales',\n    31→        'caracteres_entrada',\n    32→        'costo_estimado_usd',\n    33→        'huella_peticion',\n    34→        'extracto_peticion',\n    35→        'extracto_respuesta',\n    36→        'estado',\n    37→        'latencia_ms',\n    38→        'mensaje_error'\n    39→    ];\n    40→\n    41→    protected $casts = [\n    42→        'usuario_id'         => 'integer',\n    43→        'empresa_id'         => 'integer',\n    44→        'empresa_plan_id'    => 'integer',\n    45→        'agenda_id'          => 'integer',\n    46→        'vacante_id'         => 'integer',\n    47→        'servicio_ia_id'     => 'integer',\n    48→        'creditos'           => 'integer',\n    49→        'tokens_entrada'     => 'integer',\n    50→        'tokens_salida'      => 'integer',\n    51→        'tokens_totales'     => 'integer',\n    52→        'caracteres_entrada' => 'integer',\n    53→        'costo_estimado_usd' => 'decimal:6',\n    54→        'latencia_ms'        => 'integer',\n    55→        'created_at'         => 'datetime'\n    56→    ];\n    57→\n    58→    public $timestamps = false;\n    59→\n    60→    /**\n    61→     * Relación de muchos a uno con users.\n    62→     *\n    63→     * @return BelongsTo\n    64→     * @author Sergio Vargas\n    65→     * @author Daniel Beltrán\n    66→     */\n    67→    public function usuario(): BelongsTo {\n    68→        return $this->belongsTo(User::class, 'usuario_id');\n    69→    }\n    70→\n    71→    /**\n    72→     * Relación de muchos a uno con empresas.\n    73→     *\n    74→     * @return BelongsTo\n    75→     * @author Sergio Vargas\n    76→     * @author Daniel Beltrán\n    77→     */\n    78→    public function empresa(): BelongsTo {\n    79→        return $this->belongsTo(Empresa::class);\n    80→    }\n    81→\n    82→    /**\n    83→     * Relación de muchos a uno con empresas_planes.\n    84→     *\n    85→     * @return BelongsTo\n    86→     * @author Sergio Vargas\n    87→     * @author Daniel Beltrán\n    88→     */\n    89→    public function empresaPlan(): BelongsTo {\n    90→        return $this->belongsTo(EmpresaPlan::class, 'empresa_plan_id');\n    91→    }\n    92→\n    93→    /**\n    94→     * Relación de muchos a uno con servicios_ia.\n    95→     *\n    96→     * @return BelongsTo\n    97→     * @author Sergio Vargas\n    98→     * @author Daniel Beltrán\n    99→     */\n   100→    public function servicioIA(): BelongsTo {\n   101→        return $this->belongsTo(ServicioIA::class, 'servicio_ia_id');\n   102→    }\n   103→\n   104→    /**\n   105→     * Relación de muchos a uno con agendas.\n   106→     *\n   107→     * @return BelongsTo\n   108→     * @author Sergio Vargas\n   109→     * @author Daniel Beltrán\n   110→     */\n   111→    public function agenda(): BelongsTo {\n   112→        return $this->belongsTo(Agenda::class);\n   113→    }\n   114→\n   115→    /**\n   116→     * Relación de muchos a uno con vacantes.\n   117→     *\n   118→     * @return BelongsTo\n   119→     * @author Sergio Vargas\n   120→     * @author Daniel Beltrán\n   121→     */\n   122→    public function vacante(): BelongsTo {\n   123→        return $this->belongsTo(Vacante::class);\n   124→    }\n   125→}\n   126→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b0d6ac27-0a84-4dca-86c5-c2934d193767","timestamp":"2026-01-15T19:42:12.660Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php","content":"<?php\n\nnamespace App\\Models\\IA;\n\nuse App\\Models\\Usuarios\\User;\nuse App\\Models\\Agendas\\Agenda;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Models\\Vacantes\\Vacante;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n\nclass ConsumoCredito extends Model\n{\n    protected $table = 'consumos_creditos';\n\n    protected $fillable = [\n        'usuario_id',\n        'empresa_id',\n        'empresa_plan_id',\n        'agenda_id',\n        'vacante_id',\n        'servicio_ia_id',\n        'creditos',\n        'ruta_endpoint',\n        'nombre_servicio',\n        'modelo',\n        'tokens_entrada',\n        'tokens_salida',\n        'tokens_totales',\n        'caracteres_entrada',\n        'costo_estimado_usd',\n        'huella_peticion',\n        'extracto_peticion',\n        'extracto_respuesta',\n        'estado',\n        'latencia_ms',\n        'mensaje_error'\n    ];\n\n    protected $casts = [\n        'usuario_id'         => 'integer',\n        'empresa_id'         => 'integer',\n        'empresa_plan_id'    => 'integer',\n        'agenda_id'          => 'integer',\n        'vacante_id'         => 'integer',\n        'servicio_ia_id'     => 'integer',\n        'creditos'           => 'integer',\n        'tokens_entrada'     => 'integer',\n        'tokens_salida'      => 'integer',\n        'tokens_totales'     => 'integer',\n        'caracteres_entrada' => 'integer',\n        'costo_estimado_usd' => 'decimal:6',\n        'latencia_ms'        => 'integer',\n        'created_at'         => 'datetime'\n    ];\n\n    public $timestamps = false;\n\n    /**\n     * Relación de muchos a uno con users.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function usuario(): BelongsTo {\n        return $this->belongsTo(User::class, 'usuario_id');\n    }\n\n    /**\n     * Relación de muchos a uno con empresas.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function empresa(): BelongsTo {\n        return $this->belongsTo(Empresa::class);\n    }\n\n    /**\n     * Relación de muchos a uno con empresas_planes.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function empresaPlan(): BelongsTo {\n        return $this->belongsTo(EmpresaPlan::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de muchos a uno con servicios_ia.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function servicioIA(): BelongsTo {\n        return $this->belongsTo(ServicioIA::class, 'servicio_ia_id');\n    }\n\n    /**\n     * Relación de muchos a uno con agendas.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function agenda(): BelongsTo {\n        return $this->belongsTo(Agenda::class);\n    }\n\n    /**\n     * Relación de muchos a uno con vacantes.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function vacante(): BelongsTo {\n        return $this->belongsTo(Vacante::class);\n    }\n}\n","numLines":126,"startLine":1,"totalLines":126}},"sourceToolAssistantUUID":"b72c8231-ee3f-4cde-8467-a66a51013370"}
{"parentUuid":"82bcf497-6fc8-4ba2-8fc5-97d7af640569","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QYvxoinCWdYE9MR6MfG7Ac","type":"tool_result","content":"     1→@extends('layouts.app')\n     2→\n     3→@php\n     4→    $accion = isset($plan) ? 'Editar' : 'Crear';\n     5→@endphp\n     6→\n     7→@section('titulo', \"{$accion} plan de créditos\")\n     8→\n     9→@section('estilos')\n    10→    <link rel=\"stylesheet\" href=\"{{ asset('css/planes/planes-creditos.css') }}\">\n    11→@endsection\n    12→\n    13→@section('contenido')\n    14→    <div class=\"row\">\n    15→        <div class=\"col-12 mb-5 d-flex align-items-center\">\n    16→            <i class=\"bi bi-chevron-left me-3 text-blue-40 cursor-pointer\" id=\"regresar_planes\" type=\"button\"></i>\n    17→            <h5 class=\"mb-0 text-body-1\">{{ \"{$accion} plan de creditos\" }}</h5>\n    18→        </div>\n    19→\n    20→        <div class=\"col-12 col-xl-8 offset-xl-2\">\n    21→            <form id=\"formulario-plan-creditos\" data-url=\"/planes-creditos\">\n    22→                @csrf\n    23→\n    24→                @isset($plan)\n    25→                    <input type=\"hidden\" id=\"id\" name=\"id\" value=\"{{$plan->id}}\">\n    26→                @endisset\n    27→\n    28→                {{-- Datos del plan --}}\n    29→                <div class=\"row mb-8\">\n    30→                    <div class=\"col-12 mb-4\">\n    31→                        <h4 class=\"text-headline-5 fw-bold\">Datos del plan</h4>\n    32→                    </div>\n    33→\n    34→                    <div class=\"col-12 mb-5\">\n    35→                        ${crearInput({\n    36→                            id: 'nombre',\n    37→                            name: 'nombre',\n    38→                            type: 'text',\n    39→                            label: 'Nombre del plan',\n    40→                            value: '{{ $plan->nombre ?? \"\" }}',\n    41→                            required: true,\n    42→                            maxlength: 150,\n    43→                            autocomplete: 'off'\n    44→                        })}\n    45→                    </div>\n    46→\n    47→                    <div class=\"col-12 col-lg-6 mb-5\">\n    48→                        ${crearInput({\n    49→                            id: 'creditos_disponibles',\n    50→                            name: 'creditos',\n    51→                            type: 'number',\n    52→                            label: 'Cantidad de créditos disponibles',\n    53→                            value: '{{ $plan->creditos ?? \"\" }}',\n    54→                            required: true,\n    55→                            min: 1,\n    56→                            autocomplete: 'off',\n    57→                            onchange: 'calcularAccionesEstimadas()'\n    58→                        })}\n    59→                    </div>\n    60→\n    61→                    <div class=\"col-12 col-lg-6 mb-5\">\n    62→                        ${crearInput({\n    63→                            id: 'precio',\n    64→                            name: 'precio',\n    65→                            type: 'text',\n    66→                            label: 'Costo del plan (COP)',\n    67→                            value: '{{ $plan->precio ?? \"\" }}',\n    68→                            required: true,\n    69→                            min: 0,\n    70→                            autocomplete: 'off',\n    71→                            cleave: true\n    72→                        })}\n    73→                    </div>\n    74→                </div>\n    75→\n    76→                {{-- Consumo de créditos por funcionalidad --}}\n    77→                <div class=\"row mb-6\">\n    78→                    <div class=\"col-12 mb-4\">\n    79→                        <h4 class=\"text-headline-5 fw-bold\">Consumo de créditos por funcionalidad</h4>\n    80→                    </div>\n    81→\n    82→                    <div class=\"col-12\">\n    83→                        <div class=\"accordion-creditos border border-gray-60 rounded-3\">\n    84→                            <div class=\"accordion-header bg-blue-80 border-bottom border-gray-60 p-4 cursor-pointer\" id=\"accordion-funcionalidades\" onclick=\"alternarAcordeon()\">\n    85→                                <div class=\"d-flex justify-content-between align-items-center\">\n    86→                                    <h5 class=\"mb-0 text-body-1 text-blue-20\">Funcionalidades con IA (<span id=\"total-funcionalidades\">0</span>)</h5>\n    87→                                    <i class=\"bi bi-chevron-up text-blue-20\" id=\"icon-accordion\"></i>\n    88→                                </div>\n    89→                            </div>\n    90→\n    91→                            <div class=\"accordion-content bg-white p-4\" id=\"accordion-body\">\n    92→                                {{-- Header de tabla --}}\n    93→                                <div class=\"row mb-3\">\n    94→                                    <div class=\"col-8\">\n    95→                                        <h6 class=\"text-headline-6 fw-bold mb-0\">Funcionalidad o acción</h6>\n    96→                                    </div>\n    97→                                    <div class=\"col-4 text-end\">\n    98→                                        <h6 class=\"text-headline-6 fw-bold mb-0\">Créditos que consume</h6>\n    99→                                    </div>\n   100→                                </div>\n   101→\n   102→                                {{-- Lista de funcionalidades --}}\n   103→                                <div id=\"lista-funcionalidades\"></div>\n   104→\n   105→                                {{-- Promedio de créditos --}}\n   106→                                <div class=\"row mt-4\">\n   107→                                    <div class=\"col-12 text-end\">\n   108→                                        <h5 class=\"text-headline-5 fw-bold mb-0\">\n   109→                                            Créditos promedio por acción: <span id=\"promedio-creditos\">3,3</span>\n   110→                                        </h5>\n   111→                                    </div>\n   112→                                </div>\n   113→                            </div>\n   114→                        </div>\n   115→                    </div>\n   116→                </div>\n   117→\n   118→                {{-- Alerta informativa --}}\n   119→                <div class=\"row mb-6\">\n   120→                    <div class=\"col-12\">\n   121→                        ${crearAlerta('info', `\n   122→                            <p class=\"text-label-1 mb-2\">A partir de los créditos disponibles y el consumo promedio de créditos por acción, se estima la cantidad de acciones mediante la siguiente fórmula:</p>\n   123→                            <p class=\"text-label-1 mb-0\">Créditos disponibles (<span id=\"creditos-formula\">0</span>) / Créditos promedio por acción (<span id=\"promedio-formula\">0</span>) = <strong><span id=\"acciones-estimadas\">0</span> Acciones estimadas</strong>.</p>\n   124→                        `)}\n   125→                    </div>\n   126→                </div>\n   127→\n   128→                {{-- Botones de acción --}}\n   129→                <div class=\"row\">\n   130→                    <div class=\"col-12 text-center\">\n   131→                        ${crearBoton({\n   132→                            type: 'button',\n   133→                            id: 'cancelar-formulario',\n   134→                            clases: 'btn-outline-primary me-3',\n   135→                            texto: 'Cancelar',\n   136→                            adicional: 'style=\"min-width: 200px;\"'\n   137→                        })}\n   138→\n   139→                        ${crearBoton({\n   140→                            type: 'button',\n   141→                            id: 'boton_enviar',\n   142→                            clases: 'btn-primary',\n   143→                            texto: '{{ isset($plan) ? \"Guardar plan\" : \"Crear plan\" }}',\n   144→                            onclick: 'guardarPlanCreditos()',\n   145→                            adicional: 'style=\"min-width: 200px;\"'\n   146→                        })}\n   147→                    </div>\n   148→                </div>\n   149→            </form>\n   150→        </div>\n   151→    </div>\n   152→@endsection\n   153→\n   154→@section('scripts')\n   155→    <script src=\"{{ asset('js/planes/crear-plan-creditos.js') }}\" type=\"text/javascript\"></script>\n   156→    <script>\n   157→        @isset($plan)\n   158→            let dato_plan = @json($plan);\n   159→        @endisset\n   160→\n   161→        var ruta_actual = @json(url()->current());\n   162→    </script>\n   163→@endsection\n   164→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0b194eeb-1bdc-407e-937b-71ca6ebeef71","timestamp":"2026-01-15T19:42:12.661Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\paginas\\crear-creditos.blade.php","content":"@extends('layouts.app')\n\n@php\n    $accion = isset($plan) ? 'Editar' : 'Crear';\n@endphp\n\n@section('titulo', \"{$accion} plan de créditos\")\n\n@section('estilos')\n    <link rel=\"stylesheet\" href=\"{{ asset('css/planes/planes-creditos.css') }}\">\n@endsection\n\n@section('contenido')\n    <div class=\"row\">\n        <div class=\"col-12 mb-5 d-flex align-items-center\">\n            <i class=\"bi bi-chevron-left me-3 text-blue-40 cursor-pointer\" id=\"regresar_planes\" type=\"button\"></i>\n            <h5 class=\"mb-0 text-body-1\">{{ \"{$accion} plan de creditos\" }}</h5>\n        </div>\n\n        <div class=\"col-12 col-xl-8 offset-xl-2\">\n            <form id=\"formulario-plan-creditos\" data-url=\"/planes-creditos\">\n                @csrf\n\n                @isset($plan)\n                    <input type=\"hidden\" id=\"id\" name=\"id\" value=\"{{$plan->id}}\">\n                @endisset\n\n                {{-- Datos del plan --}}\n                <div class=\"row mb-8\">\n                    <div class=\"col-12 mb-4\">\n                        <h4 class=\"text-headline-5 fw-bold\">Datos del plan</h4>\n                    </div>\n\n                    <div class=\"col-12 mb-5\">\n                        ${crearInput({\n                            id: 'nombre',\n                            name: 'nombre',\n                            type: 'text',\n                            label: 'Nombre del plan',\n                            value: '{{ $plan->nombre ?? \"\" }}',\n                            required: true,\n                            maxlength: 150,\n                            autocomplete: 'off'\n                        })}\n                    </div>\n\n                    <div class=\"col-12 col-lg-6 mb-5\">\n                        ${crearInput({\n                            id: 'creditos_disponibles',\n                            name: 'creditos',\n                            type: 'number',\n                            label: 'Cantidad de créditos disponibles',\n                            value: '{{ $plan->creditos ?? \"\" }}',\n                            required: true,\n                            min: 1,\n                            autocomplete: 'off',\n                            onchange: 'calcularAccionesEstimadas()'\n                        })}\n                    </div>\n\n                    <div class=\"col-12 col-lg-6 mb-5\">\n                        ${crearInput({\n                            id: 'precio',\n                            name: 'precio',\n                            type: 'text',\n                            label: 'Costo del plan (COP)',\n                            value: '{{ $plan->precio ?? \"\" }}',\n                            required: true,\n                            min: 0,\n                            autocomplete: 'off',\n                            cleave: true\n                        })}\n                    </div>\n                </div>\n\n                {{-- Consumo de créditos por funcionalidad --}}\n                <div class=\"row mb-6\">\n                    <div class=\"col-12 mb-4\">\n                        <h4 class=\"text-headline-5 fw-bold\">Consumo de créditos por funcionalidad</h4>\n                    </div>\n\n                    <div class=\"col-12\">\n                        <div class=\"accordion-creditos border border-gray-60 rounded-3\">\n                            <div class=\"accordion-header bg-blue-80 border-bottom border-gray-60 p-4 cursor-pointer\" id=\"accordion-funcionalidades\" onclick=\"alternarAcordeon()\">\n                                <div class=\"d-flex justify-content-between align-items-center\">\n                                    <h5 class=\"mb-0 text-body-1 text-blue-20\">Funcionalidades con IA (<span id=\"total-funcionalidades\">0</span>)</h5>\n                                    <i class=\"bi bi-chevron-up text-blue-20\" id=\"icon-accordion\"></i>\n                                </div>\n                            </div>\n\n                            <div class=\"accordion-content bg-white p-4\" id=\"accordion-body\">\n                                {{-- Header de tabla --}}\n                                <div class=\"row mb-3\">\n                                    <div class=\"col-8\">\n                                        <h6 class=\"text-headline-6 fw-bold mb-0\">Funcionalidad o acción</h6>\n                                    </div>\n                                    <div class=\"col-4 text-end\">\n                                        <h6 class=\"text-headline-6 fw-bold mb-0\">Créditos que consume</h6>\n                                    </div>\n                                </div>\n\n                                {{-- Lista de funcionalidades --}}\n                                <div id=\"lista-funcionalidades\"></div>\n\n                                {{-- Promedio de créditos --}}\n                                <div class=\"row mt-4\">\n                                    <div class=\"col-12 text-end\">\n                                        <h5 class=\"text-headline-5 fw-bold mb-0\">\n                                            Créditos promedio por acción: <span id=\"promedio-creditos\">3,3</span>\n                                        </h5>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                {{-- Alerta informativa --}}\n                <div class=\"row mb-6\">\n                    <div class=\"col-12\">\n                        ${crearAlerta('info', `\n                            <p class=\"text-label-1 mb-2\">A partir de los créditos disponibles y el consumo promedio de créditos por acción, se estima la cantidad de acciones mediante la siguiente fórmula:</p>\n                            <p class=\"text-label-1 mb-0\">Créditos disponibles (<span id=\"creditos-formula\">0</span>) / Créditos promedio por acción (<span id=\"promedio-formula\">0</span>) = <strong><span id=\"acciones-estimadas\">0</span> Acciones estimadas</strong>.</p>\n                        `)}\n                    </div>\n                </div>\n\n                {{-- Botones de acción --}}\n                <div class=\"row\">\n                    <div class=\"col-12 text-center\">\n                        ${crearBoton({\n                            type: 'button',\n                            id: 'cancelar-formulario',\n                            clases: 'btn-outline-primary me-3',\n                            texto: 'Cancelar',\n                            adicional: 'style=\"min-width: 200px;\"'\n                        })}\n\n                        ${crearBoton({\n                            type: 'button',\n                            id: 'boton_enviar',\n                            clases: 'btn-primary',\n                            texto: '{{ isset($plan) ? \"Guardar plan\" : \"Crear plan\" }}',\n                            onclick: 'guardarPlanCreditos()',\n                            adicional: 'style=\"min-width: 200px;\"'\n                        })}\n                    </div>\n                </div>\n            </form>\n        </div>\n    </div>\n@endsection\n\n@section('scripts')\n    <script src=\"{{ asset('js/planes/crear-plan-creditos.js') }}\" type=\"text/javascript\"></script>\n    <script>\n        @isset($plan)\n            let dato_plan = @json($plan);\n        @endisset\n\n        var ruta_actual = @json(url()->current());\n    </script>\n@endsection\n","numLines":164,"startLine":1,"totalLines":164}},"sourceToolAssistantUUID":"82bcf497-6fc8-4ba2-8fc5-97d7af640569"}
{"parentUuid":"0b194eeb-1bdc-407e-937b-71ca6ebeef71","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XsAV7L1MWP2wVmojcxWmfC","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente. Ahora voy a ver el archivo JavaScript y buscar cómo se obtienen los servicios y sus créditos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":5346,"cache_read_input_tokens":61003,"cache_creation":{"ephemeral_5m_input_tokens":5346,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jXh68UyuPYtE7EXc6X","type":"assistant","uuid":"f4ef0960-e6ca-43bd-af09-eeb375239fdf","timestamp":"2026-01-15T19:42:15.060Z"}
{"parentUuid":"f4ef0960-e6ca-43bd-af09-eeb375239fdf","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XsAV7L1MWP2wVmojcxWmfC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0151q7Sfpx5WXRuoirPy96iX","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\planes\\crear-plan-creditos.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":5346,"cache_read_input_tokens":61003,"cache_creation":{"ephemeral_5m_input_tokens":5346,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jXh68UyuPYtE7EXc6X","type":"assistant","uuid":"50df4d44-dbb4-4290-9b4a-86fd08a27da2","timestamp":"2026-01-15T19:42:15.463Z"}
{"parentUuid":"50df4d44-dbb4-4290-9b4a-86fd08a27da2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XsAV7L1MWP2wVmojcxWmfC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015wpDXMc9E9YdJ2ZuvwqPSM","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\IA\\ServicioIAController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":5346,"cache_read_input_tokens":61003,"cache_creation":{"ephemeral_5m_input_tokens":5346,"ephemeral_1h_input_tokens":0},"output_tokens":190,"service_tier":"standard"}},"requestId":"req_011CX9jXh68UyuPYtE7EXc6X","type":"assistant","uuid":"75fbf22a-f410-4bf5-ac14-0312d87b457a","timestamp":"2026-01-15T19:42:15.834Z"}
{"parentUuid":"50df4d44-dbb4-4290-9b4a-86fd08a27da2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0151q7Sfpx5WXRuoirPy96iX","type":"tool_result","content":"     1→var promedio_creditos_global = 0;\n     2→var acordeon_abierto = true;\n     3→var adherirse_precio = null;\n     4→\n     5→const TIEMPO_REDIRECCION = 1500;\n     6→const API_PLANES_CREDITOS = '/api/planes-creditos';\n     7→const API_SERVICIOS_IA = '/api/servicios-ia';\n     8→const DEBOUNCE_GUARDADO_MS = 800;\n     9→const TIMERS_GUARDADO_SERVICIOS = {};\n    10→\n    11→/**\n    12→ * Inicializar el formulario.\n    13→ *\n    14→ * @returns {void}\n    15→ * @author Andres Morales\n    16→ * @author Sergio Vargas\n    17→ */\n    18→$(document).ready(function() {\n    19→    if ($('#precio').length && typeof Cleave !== 'undefined') {\n    20→        adherirse_precio = new Cleave('#precio', {\n    21→            numeral: true,\n    22→            numeralThousandsGroupStyle: 'thousand',\n    23→            numeralDecimalMark: ',',\n    24→            delimiter: '.',\n    25→            numeralPositiveOnly: true\n    26→        });\n    27→    }\n    28→\n    29→    calcularPromedioCreditos();\n    30→    calcularAccionesEstimadas();\n    31→\n    32→    $('#regresar_planes, #cancelar-formulario').on('click', function() {\n    33→        window.location.href = '/planes';\n    34→    });\n    35→\n    36→    $(document).on('input', '.input-credito', function() {\n    37→        calcularPromedioCreditos();\n    38→        programarGuardadoServicio($(this));\n    39→    });\n    40→\n    41→    $('#creditos_disponibles').on('input', function() {\n    42→        calcularAccionesEstimadas();\n    43→    });\n    44→\n    45→    $.validator.addMethod('cleaveNumber', function(value, element) {\n    46→        let valor_limpio = value.replace(/\\./g, '').replace(',', '.');\n    47→        return !isNaN(valor_limpio) && parseFloat(valor_limpio) >= 0;\n    48→    }, 'Debe ser un número válido');\n    49→\n    50→    $('#formulario-plan-creditos').validate({\n    51→        ignore: [],\n    52→        rules: {\n    53→            nombre: {\n    54→                required: true,\n    55→                maxlength: 150\n    56→            },\n    57→            creditos: {\n    58→                required: true,\n    59→                min: 1,\n    60→                number: true\n    61→            },\n    62→            precio: {\n    63→                required: true,\n    64→                cleaveNumber: true\n    65→            }\n    66→        },\n    67→        messages: {\n    68→            nombre: {\n    69→                required: 'El nombre del plan es obligatorio',\n    70→                maxlength: 'El nombre no puede exceder 150 caracteres'\n    71→            },\n    72→            creditos: {\n    73→                required: 'La cantidad de créditos es obligatoria',\n    74→                min: 'Debe ser al menos 1 crédito',\n    75→                number: 'Debe ser un número válido'\n    76→            },\n    77→            precio: {\n    78→                required: 'El costo del plan es obligatorio',\n    79→                cleaveNumber: 'Debe ser un número válido mayor o igual a 0'\n    80→            }\n    81→        }\n    82→    });\n    83→\n    84→    $('.input-credito').each(function() {\n    85→        $(this).rules('add', {\n    86→            required: true,\n    87→            min: 1,\n    88→            max: 100,\n    89→            number: true,\n    90→            messages: {\n    91→                required: 'Este campo es obligatorio',\n    92→                min: 'Debe ser al menos 1',\n    93→                max: 'No puede exceder 100',\n    94→                number: 'Debe ser un número válido'\n    95→            }\n    96→        });\n    97→    });\n    98→\n    99→    cargarServiciosIA();\n   100→});\n   101→\n   102→/**\n   103→ * Calcular el promedio de créditos por acción.\n   104→ *\n   105→ * @returns {void}\n   106→ * @author Andres Morales\n   107→ */\n   108→function calcularPromedioCreditos() {\n   109→    let total_creditos = 0;\n   110→    let cantidad_funcionalidades = 0;\n   111→\n   112→    $('.input-credito').each(function() {\n   113→        let valor = parseInt($(this).val()) || 0;\n   114→        total_creditos += valor;\n   115→        cantidad_funcionalidades++;\n   116→    });\n   117→\n   118→    let promedio = cantidad_funcionalidades > 0\n   119→        ? (total_creditos / cantidad_funcionalidades).toFixed(1)\n   120→        : 0;\n   121→\n   122→    promedio_creditos_global = parseFloat(promedio);\n   123→\n   124→    $('#promedio-creditos').text(promedio.toString().replace('.', ','));\n   125→    $('#promedio-formula').text(promedio.toString().replace('.', ','));\n   126→    $('#total-funcionalidades').text(cantidad_funcionalidades);\n   127→\n   128→    calcularAccionesEstimadas();\n   129→}\n   130→\n   131→/**\n   132→ * Calcular las acciones estimadas.\n   133→ *\n   134→ * @returns {void}\n   135→ * @author Andres Morales\n   136→ */\n   137→function calcularAccionesEstimadas() {\n   138→    let creditos_disponibles = parseInt($('#creditos_disponibles').val()) || 0;\n   139→    let promedio = promedio_creditos_global;\n   140→\n   141→    let acciones_estimadas = 0;\n   142→    if (creditos_disponibles > 0 && promedio > 0) {\n   143→        acciones_estimadas = Math.floor(creditos_disponibles / promedio);\n   144→    }\n   145→\n   146→    $('#creditos-formula').text(new Intl.NumberFormat('es-CO').format(creditos_disponibles));\n   147→    $('#acciones-estimadas').text(new Intl.NumberFormat('es-CO').format(acciones_estimadas));\n   148→}\n   149→\n   150→/**\n   151→ * Alternar el acordeón.\n   152→ *\n   153→ * @returns {void}\n   154→ * @author Andres Morales\n   155→ */\n   156→function alternarAcordeon() {\n   157→    acordeon_abierto = !acordeon_abierto;\n   158→\n   159→    if (acordeon_abierto) {\n   160→        $('#accordion-body').slideDown(300);\n   161→        $('#icon-accordion').removeClass('bi-chevron-down').addClass('bi-chevron-up');\n   162→    } else {\n   163→        $('#accordion-body').slideUp(300);\n   164→        $('#icon-accordion').removeClass('bi-chevron-up').addClass('bi-chevron-down');\n   165→    }\n   166→}\n   167→\n   168→/**\n   169→ * Guardar plan de créditos.\n   170→ *\n   171→ * @returns {void}\n   172→ * @author Andres Morales\n   173→ * @author Andres Gonzalez\n   174→ * @author Sergio Vargas\n   175→ */\n   176→function guardarPlanCreditos() {\n   177→    let formulario = $('#formulario-plan-creditos');\n   178→\n   179→    if (!formulario.valid()) {\n   180→        mostrarToast('error', 'Por favor complete todos los campos requeridos correctamente');\n   181→        return;\n   182→    }\n   183→\n   184→    let datos = new FormData(formulario[0]);\n   185→\n   186→    if (adherirse_precio) {\n   187→        let precio_sin_formato = adherirse_precio.getRawValue();\n   188→        datos.set('precio', precio_sin_formato);\n   189→    }\n   190→\n   191→    let id = $('#id').val();\n   192→    let url = id ? `${API_PLANES_CREDITOS}/${id}` : API_PLANES_CREDITOS;\n   193→\n   194→    if (id) {\n   195→        datos.append('_method', 'PUT');\n   196→    }\n   197→\n   198→    $('#boton_enviar').prop('disabled', true);\n   199→\n   200→    actualizarServiciosIA()\n   201→        .then(() => guardarPlanCreditosAjax(url, datos))\n   202→        .then((respuesta) => {\n   203→            mostrarToast('success', respuesta.message || 'Plan de créditos guardado correctamente');\n   204→            setTimeout(() => {\n   205→                window.location.href = '/planes';\n   206→            }, TIEMPO_REDIRECCION);\n   207→        })\n   208→        .catch((error) => {\n   209→            $('#boton_enviar').prop('disabled', false);\n   210→\n   211→            if (error.responseJSON && error.responseJSON.message) {\n   212→                mostrarToast('error', error.responseJSON.message);\n   213→            } else if (error.responseJSON && error.responseJSON.errors) {\n   214→                let errores = Object.values(error.responseJSON.errors).flat();\n   215→                mostrarToast('error', errores.join('<br>'));\n   216→            } else {\n   217→                mostrarToast('error', 'Error al guardar el plan de créditos');\n   218→            }\n   219→        });\n   220→}\n   221→\n   222→/**\n   223→ * Cargar datos del plan al editar.\n   224→ *\n   225→ * @returns {void}\n   226→ * @author Andres Morales\n   227→ */\n   228→if (typeof dato_plan !== 'undefined' && dato_plan) {\n   229→    $(document).ready(function() {\n   230→        $('#nombre').val(dato_plan.nombre);\n   231→        $('#creditos_disponibles').val(dato_plan.creditos);\n   232→        $('#precio').val(dato_plan.precio);\n   233→\n   234→        calcularPromedioCreditos();\n   235→        calcularAccionesEstimadas();\n   236→    });\n   237→}\n   238→\n   239→/**\n   240→ * Actualizar los créditos de servicios IA.\n   241→ *\n   242→ * @returns {Promise}\n   243→ * @author Andres Morales\n   244→ * @author Sergio Vargas\n   245→ */\n   246→function actualizarServiciosIA() {\n   247→    let solicitudes = [];\n   248→\n   249→    $('.input-credito').each(function() {\n   250→        let valor = parseInt($(this).val()) || 0;\n   251→        let servicio_id = $(this).data('servicio-id');\n   252→\n   253→        if (!servicio_id) {\n   254→            return;\n   255→        }\n   256→\n   257→        solicitudes.push(actualizarServicioIA(servicio_id, valor));\n   258→    });\n   259→\n   260→    return Promise.all(solicitudes);\n   261→}\n   262→\n   263→/**\n   264→ * Guardar plan de créditos por API.\n   265→ *\n   266→ * @param {string} url Enlace.\n   267→ * @param {FormData} datos Datos.\n   268→ * @returns {Promise}\n   269→ * @author Andres Morales\n   270→ * @author Sergio Vargas\n   271→ */\n   272→function guardarPlanCreditosAjax(url, datos) {\n   273→    return $.ajax({\n   274→        type: 'POST',\n   275→        url: url,\n   276→        data: datos,\n   277→        processData: false,\n   278→        contentType: false\n   279→    });\n   280→}\n   281→\n   282→/**\n   283→ * Programar guardado de un servicio con debounce.\n   284→ *\n   285→ * @param {jQuery} $input Campo.\n   286→ * @returns {void}\n   287→ * @author Andres Morales\n   288→ * @author Sergio Vargas\n   289→ */\n   290→function programarGuardadoServicio($input) {\n   291→    let servicio_id = $input.data('servicio-id');\n   292→    if (!servicio_id) {\n   293→        return;\n   294→    }\n   295→\n   296→    marcarEstadoGuardado(servicio_id, 'Guardando...', 'text-gray-60');\n   297→\n   298→    if (TIMERS_GUARDADO_SERVICIOS[servicio_id]) {\n   299→        clearTimeout(TIMERS_GUARDADO_SERVICIOS[servicio_id]);\n   300→    }\n   301→\n   302→    TIMERS_GUARDADO_SERVICIOS[servicio_id] = setTimeout(() => {\n   303→        let valor = parseInt($input.val()) || 0;\n   304→        actualizarServicioIA(servicio_id, valor)\n   305→            .then(() => {\n   306→                marcarEstadoGuardado(servicio_id, 'Guardado', 'text-success');\n   307→            })\n   308→            .catch(() => {\n   309→                marcarEstadoGuardado(servicio_id, 'Error al guardar', 'text-danger');\n   310→            });\n   311→    }, DEBOUNCE_GUARDADO_MS);\n   312→}\n   313→\n   314→/**\n   315→ * Actualizar créditos de un servicio IA.\n   316→ *\n   317→ * @param {number} servicio_id ID del servicio.\n   318→ * @param {number} valor Valor.\n   319→ * @returns {Promise}\n   320→ * @author Andres Morales\n   321→ * @author Sergio Vargas\n   322→ */\n   323→function actualizarServicioIA(servicio_id, valor) {\n   324→    return $.ajax({\n   325→        type: 'PUT',\n   326→        url: `${API_SERVICIOS_IA}/${servicio_id}`,\n   327→        data: {\n   328→            consume_creditos: valor\n   329→        },\n   330→        headers: {\n   331→            'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n   332→        }\n   333→    });\n   334→}\n   335→\n   336→/**\n   337→ * Mostrar estado de guardado por servicio.\n   338→ *\n   339→ * @param {number} servicio_id ID del servicio.\n   340→ * @param {string} mensaje Mensaje.\n   341→ * @param {string} clase Clase.\n   342→ * @returns {void}\n   343→ * @author Andres Morales\n   344→ * @author Sergio Vargas\n   345→ */\n   346→function marcarEstadoGuardado(servicio_id, mensaje, clase) {\n   347→    let $estado = $(`.estado-guardado[data-servicio-id=\"${servicio_id}\"]`);\n   348→    if (!$estado.length) {\n   349→        return;\n   350→    }\n   351→\n   352→    $estado.removeClass('text-gray-60 text-success text-danger').addClass(clase).text(mensaje);\n   353→\n   354→    if (clase === 'text-success') {\n   355→        setTimeout(() => {\n   356→            $estado.fadeOut(400, function() {\n   357→                $(this).text('').show();\n   358→            });\n   359→        }, 1200);\n   360→    }\n   361→}\n   362→\n   363→/**\n   364→ * Cargar servicios IA y renderizar créditos.\n   365→ *\n   366→ * @returns {void}\n   367→ * @author Andres Morales\n   368→ * @author Sergio Vargas\n   369→ */\n   370→function cargarServiciosIA() {\n   371→    $('#lista-funcionalidades').html('<p class=\"text-body-2 mb-0\">Cargando servicios...</p>');\n   372→\n   373→    $.get(API_SERVICIOS_IA)\n   374→        .then((respuesta) => {\n   375→            let servicios = respuesta.data || [];\n   376→            renderizarServiciosIA(servicios);\n   377→        })\n   378→        .catch(() => {\n   379→            $('#lista-funcionalidades').html('<p class=\"text-body-2 mb-0 text-danger\">No se pudieron cargar los servicios.</p>');\n   380→        });\n   381→}\n   382→\n   383→/**\n   384→ * Renderizar lista de servicios IA.\n   385→ *\n   386→ * @param {Array} servicios Servicios.\n   387→ * @returns {void}\n   388→ * @author Andres Morales\n   389→ * @author Sergio Vargas\n   390→ */\n   391→function renderizarServiciosIA(servicios) {\n   392→    let contenedor = $('#lista-funcionalidades');\n   393→    contenedor.empty();\n   394→\n   395→    if (!servicios.length) {\n   396→        contenedor.html('<p class=\"text-body-2 mb-0\">No hay servicios configurados.</p>');\n   397→        $('#total-funcionalidades').text('0');\n   398→        calcularPromedioCreditos();\n   399→        return;\n   400→    }\n   401→\n   402→    servicios.forEach((servicio) => {\n   403→        let nombre = servicio.nombre || servicio.endpoint;\n   404→        let categoria = servicio.categoria && servicio.categoria.nombre ? ` (${servicio.categoria.nombre})` : '';\n   405→        let valor = servicio.consume_creditos ?? 0;\n   406→\n   407→        let fila = `\n   408→            <div class=\"row mb-3 align-items-center funcionalidad-item\">\n   409→                <div class=\"col-8\">\n   410→                    <p class=\"text-body-2 mb-1\">${nombre}${categoria}</p>\n   411→                    <span class=\"text-label-2 text-gray-60 estado-guardado\" data-servicio-id=\"${servicio.id}\"></span>\n   412→                </div>\n   413→                <div class=\"col-4\">\n   414→                    ${crearInput({\n   415→                        id: 'credito_servicio_' + servicio.id,\n   416→                        name: 'servicios[' + servicio.id + ']',\n   417→                        type: 'number',\n   418→                        value: valor,\n   419→                        required: true,\n   420→                        min: 0,\n   421→                        max: 100,\n   422→                        class: 'input-credito',\n   423→                        onchange: 'calcularPromedioCreditos()',\n   424→                        data: [\n   425→                            { texto: 'servicio-id', value: servicio.id }\n   426→                        ]\n   427→                    })}\n   428→                </div>\n   429→            </div>\n   430→        `;\n   431→\n   432→        contenedor.append(fila);\n   433→    });\n   434→\n   435→    $('.input-credito').each(function() {\n   436→        $(this).rules('add', {\n   437→            required: true,\n   438→            min: 0,\n   439→            max: 100,\n   440→            number: true,\n   441→            messages: {\n   442→                required: 'Este campo es obligatorio',\n   443→                min: 'Debe ser al menos 0',\n   444→                max: 'No puede exceder 100',\n   445→                number: 'Debe ser un número válido'\n   446→            }\n   447→        });\n   448→    });\n   449→\n   450→    $('#total-funcionalidades').text(servicios.length);\n   451→    calcularPromedioCreditos();\n   452→}\n   453→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0c26fd09-ff82-412b-a02e-2822c60e2763","timestamp":"2026-01-15T19:42:17.718Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\planes\\crear-plan-creditos.js","content":"var promedio_creditos_global = 0;\nvar acordeon_abierto = true;\nvar adherirse_precio = null;\n\nconst TIEMPO_REDIRECCION = 1500;\nconst API_PLANES_CREDITOS = '/api/planes-creditos';\nconst API_SERVICIOS_IA = '/api/servicios-ia';\nconst DEBOUNCE_GUARDADO_MS = 800;\nconst TIMERS_GUARDADO_SERVICIOS = {};\n\n/**\n * Inicializar el formulario.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Sergio Vargas\n */\n$(document).ready(function() {\n    if ($('#precio').length && typeof Cleave !== 'undefined') {\n        adherirse_precio = new Cleave('#precio', {\n            numeral: true,\n            numeralThousandsGroupStyle: 'thousand',\n            numeralDecimalMark: ',',\n            delimiter: '.',\n            numeralPositiveOnly: true\n        });\n    }\n\n    calcularPromedioCreditos();\n    calcularAccionesEstimadas();\n\n    $('#regresar_planes, #cancelar-formulario').on('click', function() {\n        window.location.href = '/planes';\n    });\n\n    $(document).on('input', '.input-credito', function() {\n        calcularPromedioCreditos();\n        programarGuardadoServicio($(this));\n    });\n\n    $('#creditos_disponibles').on('input', function() {\n        calcularAccionesEstimadas();\n    });\n\n    $.validator.addMethod('cleaveNumber', function(value, element) {\n        let valor_limpio = value.replace(/\\./g, '').replace(',', '.');\n        return !isNaN(valor_limpio) && parseFloat(valor_limpio) >= 0;\n    }, 'Debe ser un número válido');\n\n    $('#formulario-plan-creditos').validate({\n        ignore: [],\n        rules: {\n            nombre: {\n                required: true,\n                maxlength: 150\n            },\n            creditos: {\n                required: true,\n                min: 1,\n                number: true\n            },\n            precio: {\n                required: true,\n                cleaveNumber: true\n            }\n        },\n        messages: {\n            nombre: {\n                required: 'El nombre del plan es obligatorio',\n                maxlength: 'El nombre no puede exceder 150 caracteres'\n            },\n            creditos: {\n                required: 'La cantidad de créditos es obligatoria',\n                min: 'Debe ser al menos 1 crédito',\n                number: 'Debe ser un número válido'\n            },\n            precio: {\n                required: 'El costo del plan es obligatorio',\n                cleaveNumber: 'Debe ser un número válido mayor o igual a 0'\n            }\n        }\n    });\n\n    $('.input-credito').each(function() {\n        $(this).rules('add', {\n            required: true,\n            min: 1,\n            max: 100,\n            number: true,\n            messages: {\n                required: 'Este campo es obligatorio',\n                min: 'Debe ser al menos 1',\n                max: 'No puede exceder 100',\n                number: 'Debe ser un número válido'\n            }\n        });\n    });\n\n    cargarServiciosIA();\n});\n\n/**\n * Calcular el promedio de créditos por acción.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction calcularPromedioCreditos() {\n    let total_creditos = 0;\n    let cantidad_funcionalidades = 0;\n\n    $('.input-credito').each(function() {\n        let valor = parseInt($(this).val()) || 0;\n        total_creditos += valor;\n        cantidad_funcionalidades++;\n    });\n\n    let promedio = cantidad_funcionalidades > 0\n        ? (total_creditos / cantidad_funcionalidades).toFixed(1)\n        : 0;\n\n    promedio_creditos_global = parseFloat(promedio);\n\n    $('#promedio-creditos').text(promedio.toString().replace('.', ','));\n    $('#promedio-formula').text(promedio.toString().replace('.', ','));\n    $('#total-funcionalidades').text(cantidad_funcionalidades);\n\n    calcularAccionesEstimadas();\n}\n\n/**\n * Calcular las acciones estimadas.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction calcularAccionesEstimadas() {\n    let creditos_disponibles = parseInt($('#creditos_disponibles').val()) || 0;\n    let promedio = promedio_creditos_global;\n\n    let acciones_estimadas = 0;\n    if (creditos_disponibles > 0 && promedio > 0) {\n        acciones_estimadas = Math.floor(creditos_disponibles / promedio);\n    }\n\n    $('#creditos-formula').text(new Intl.NumberFormat('es-CO').format(creditos_disponibles));\n    $('#acciones-estimadas').text(new Intl.NumberFormat('es-CO').format(acciones_estimadas));\n}\n\n/**\n * Alternar el acordeón.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction alternarAcordeon() {\n    acordeon_abierto = !acordeon_abierto;\n\n    if (acordeon_abierto) {\n        $('#accordion-body').slideDown(300);\n        $('#icon-accordion').removeClass('bi-chevron-down').addClass('bi-chevron-up');\n    } else {\n        $('#accordion-body').slideUp(300);\n        $('#icon-accordion').removeClass('bi-chevron-up').addClass('bi-chevron-down');\n    }\n}\n\n/**\n * Guardar plan de créditos.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Andres Gonzalez\n * @author Sergio Vargas\n */\nfunction guardarPlanCreditos() {\n    let formulario = $('#formulario-plan-creditos');\n\n    if (!formulario.valid()) {\n        mostrarToast('error', 'Por favor complete todos los campos requeridos correctamente');\n        return;\n    }\n\n    let datos = new FormData(formulario[0]);\n\n    if (adherirse_precio) {\n        let precio_sin_formato = adherirse_precio.getRawValue();\n        datos.set('precio', precio_sin_formato);\n    }\n\n    let id = $('#id').val();\n    let url = id ? `${API_PLANES_CREDITOS}/${id}` : API_PLANES_CREDITOS;\n\n    if (id) {\n        datos.append('_method', 'PUT');\n    }\n\n    $('#boton_enviar').prop('disabled', true);\n\n    actualizarServiciosIA()\n        .then(() => guardarPlanCreditosAjax(url, datos))\n        .then((respuesta) => {\n            mostrarToast('success', respuesta.message || 'Plan de créditos guardado correctamente');\n            setTimeout(() => {\n                window.location.href = '/planes';\n            }, TIEMPO_REDIRECCION);\n        })\n        .catch((error) => {\n            $('#boton_enviar').prop('disabled', false);\n\n            if (error.responseJSON && error.responseJSON.message) {\n                mostrarToast('error', error.responseJSON.message);\n            } else if (error.responseJSON && error.responseJSON.errors) {\n                let errores = Object.values(error.responseJSON.errors).flat();\n                mostrarToast('error', errores.join('<br>'));\n            } else {\n                mostrarToast('error', 'Error al guardar el plan de créditos');\n            }\n        });\n}\n\n/**\n * Cargar datos del plan al editar.\n *\n * @returns {void}\n * @author Andres Morales\n */\nif (typeof dato_plan !== 'undefined' && dato_plan) {\n    $(document).ready(function() {\n        $('#nombre').val(dato_plan.nombre);\n        $('#creditos_disponibles').val(dato_plan.creditos);\n        $('#precio').val(dato_plan.precio);\n\n        calcularPromedioCreditos();\n        calcularAccionesEstimadas();\n    });\n}\n\n/**\n * Actualizar los créditos de servicios IA.\n *\n * @returns {Promise}\n * @author Andres Morales\n * @author Sergio Vargas\n */\nfunction actualizarServiciosIA() {\n    let solicitudes = [];\n\n    $('.input-credito').each(function() {\n        let valor = parseInt($(this).val()) || 0;\n        let servicio_id = $(this).data('servicio-id');\n\n        if (!servicio_id) {\n            return;\n        }\n\n        solicitudes.push(actualizarServicioIA(servicio_id, valor));\n    });\n\n    return Promise.all(solicitudes);\n}\n\n/**\n * Guardar plan de créditos por API.\n *\n * @param {string} url Enlace.\n * @param {FormData} datos Datos.\n * @returns {Promise}\n * @author Andres Morales\n * @author Sergio Vargas\n */\nfunction guardarPlanCreditosAjax(url, datos) {\n    return $.ajax({\n        type: 'POST',\n        url: url,\n        data: datos,\n        processData: false,\n        contentType: false\n    });\n}\n\n/**\n * Programar guardado de un servicio con debounce.\n *\n * @param {jQuery} $input Campo.\n * @returns {void}\n * @author Andres Morales\n * @author Sergio Vargas\n */\nfunction programarGuardadoServicio($input) {\n    let servicio_id = $input.data('servicio-id');\n    if (!servicio_id) {\n        return;\n    }\n\n    marcarEstadoGuardado(servicio_id, 'Guardando...', 'text-gray-60');\n\n    if (TIMERS_GUARDADO_SERVICIOS[servicio_id]) {\n        clearTimeout(TIMERS_GUARDADO_SERVICIOS[servicio_id]);\n    }\n\n    TIMERS_GUARDADO_SERVICIOS[servicio_id] = setTimeout(() => {\n        let valor = parseInt($input.val()) || 0;\n        actualizarServicioIA(servicio_id, valor)\n            .then(() => {\n                marcarEstadoGuardado(servicio_id, 'Guardado', 'text-success');\n            })\n            .catch(() => {\n                marcarEstadoGuardado(servicio_id, 'Error al guardar', 'text-danger');\n            });\n    }, DEBOUNCE_GUARDADO_MS);\n}\n\n/**\n * Actualizar créditos de un servicio IA.\n *\n * @param {number} servicio_id ID del servicio.\n * @param {number} valor Valor.\n * @returns {Promise}\n * @author Andres Morales\n * @author Sergio Vargas\n */\nfunction actualizarServicioIA(servicio_id, valor) {\n    return $.ajax({\n        type: 'PUT',\n        url: `${API_SERVICIOS_IA}/${servicio_id}`,\n        data: {\n            consume_creditos: valor\n        },\n        headers: {\n            'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    });\n}\n\n/**\n * Mostrar estado de guardado por servicio.\n *\n * @param {number} servicio_id ID del servicio.\n * @param {string} mensaje Mensaje.\n * @param {string} clase Clase.\n * @returns {void}\n * @author Andres Morales\n * @author Sergio Vargas\n */\nfunction marcarEstadoGuardado(servicio_id, mensaje, clase) {\n    let $estado = $(`.estado-guardado[data-servicio-id=\"${servicio_id}\"]`);\n    if (!$estado.length) {\n        return;\n    }\n\n    $estado.removeClass('text-gray-60 text-success text-danger').addClass(clase).text(mensaje);\n\n    if (clase === 'text-success') {\n        setTimeout(() => {\n            $estado.fadeOut(400, function() {\n                $(this).text('').show();\n            });\n        }, 1200);\n    }\n}\n\n/**\n * Cargar servicios IA y renderizar créditos.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Sergio Vargas\n */\nfunction cargarServiciosIA() {\n    $('#lista-funcionalidades').html('<p class=\"text-body-2 mb-0\">Cargando servicios...</p>');\n\n    $.get(API_SERVICIOS_IA)\n        .then((respuesta) => {\n            let servicios = respuesta.data || [];\n            renderizarServiciosIA(servicios);\n        })\n        .catch(() => {\n            $('#lista-funcionalidades').html('<p class=\"text-body-2 mb-0 text-danger\">No se pudieron cargar los servicios.</p>');\n        });\n}\n\n/**\n * Renderizar lista de servicios IA.\n *\n * @param {Array} servicios Servicios.\n * @returns {void}\n * @author Andres Morales\n * @author Sergio Vargas\n */\nfunction renderizarServiciosIA(servicios) {\n    let contenedor = $('#lista-funcionalidades');\n    contenedor.empty();\n\n    if (!servicios.length) {\n        contenedor.html('<p class=\"text-body-2 mb-0\">No hay servicios configurados.</p>');\n        $('#total-funcionalidades').text('0');\n        calcularPromedioCreditos();\n        return;\n    }\n\n    servicios.forEach((servicio) => {\n        let nombre = servicio.nombre || servicio.endpoint;\n        let categoria = servicio.categoria && servicio.categoria.nombre ? ` (${servicio.categoria.nombre})` : '';\n        let valor = servicio.consume_creditos ?? 0;\n\n        let fila = `\n            <div class=\"row mb-3 align-items-center funcionalidad-item\">\n                <div class=\"col-8\">\n                    <p class=\"text-body-2 mb-1\">${nombre}${categoria}</p>\n                    <span class=\"text-label-2 text-gray-60 estado-guardado\" data-servicio-id=\"${servicio.id}\"></span>\n                </div>\n                <div class=\"col-4\">\n                    ${crearInput({\n                        id: 'credito_servicio_' + servicio.id,\n                        name: 'servicios[' + servicio.id + ']',\n                        type: 'number',\n                        value: valor,\n                        required: true,\n                        min: 0,\n                        max: 100,\n                        class: 'input-credito',\n                        onchange: 'calcularPromedioCreditos()',\n                        data: [\n                            { texto: 'servicio-id', value: servicio.id }\n                        ]\n                    })}\n                </div>\n            </div>\n        `;\n\n        contenedor.append(fila);\n    });\n\n    $('.input-credito').each(function() {\n        $(this).rules('add', {\n            required: true,\n            min: 0,\n            max: 100,\n            number: true,\n            messages: {\n                required: 'Este campo es obligatorio',\n                min: 'Debe ser al menos 0',\n                max: 'No puede exceder 100',\n                number: 'Debe ser un número válido'\n            }\n        });\n    });\n\n    $('#total-funcionalidades').text(servicios.length);\n    calcularPromedioCreditos();\n}\n","numLines":453,"startLine":1,"totalLines":453}},"sourceToolAssistantUUID":"50df4d44-dbb4-4290-9b4a-86fd08a27da2"}
{"parentUuid":"75fbf22a-f410-4bf5-ac14-0312d87b457a","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015wpDXMc9E9YdJ2ZuvwqPSM","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Controllers\\IA;\n     4→\n     5→use Exception;\n     6→use Illuminate\\Http\\Request;\n     7→use Illuminate\\Http\\JsonResponse;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Http\\Controllers\\Controller;\n    10→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    11→\n    12→class ServicioIAController extends Controller\n    13→{\n    14→    public function __construct(private ServicioIARepository $repositorio) {}\n    15→\n    16→    /**\n    17→     * Obtener listado de servicios de IA.\n    18→     *\n    19→     * @param Request $request Contenido de la petición.\n    20→     * @return JsonResponse\n    21→     * @author Sergio Vargas\n    22→     * @author Daniel Beltrán\n    23→     */\n    24→    public function index(Request $request): JsonResponse {\n    25→        return new JsonResponse([\n    26→            'data' => $this->repositorio->getTodo($request),\n    27→        ], JsonResponse::HTTP_OK);\n    28→    }\n    29→\n    30→    /**\n    31→     * Crear servicio de IA.\n    32→     *\n    33→     * @param Request $request Contenido de la petición.\n    34→     * @return JsonResponse\n    35→     * @author Sergio Vargas\n    36→     * @author Daniel Beltrán\n    37→     */\n    38→    public function store(Request $request): JsonResponse {\n    39→        $codigo    = JsonResponse::HTTP_CREATED;\n    40→        $respuesta = ['message' => 'Servicio de IA creado correctamente'];\n    41→\n    42→        try {\n    43→            DB::beginTransaction();\n    44→            $this->repositorio->crear($request->except(['_token', '_method', 'id']));\n    45→            DB::commit();\n    46→        } catch (Exception $error) {\n    47→            DB::rollBack();\n    48→            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n    49→            $respuesta = [\n    50→                'message' => 'Ocurrio un error',\n    51→                'errors'  => $error->getMessage(),\n    52→            ];\n    53→        }\n    54→\n    55→        return new JsonResponse($respuesta, $codigo);\n    56→    }\n    57→\n    58→    /**\n    59→     * Actualizar servicio de IA.\n    60→     *\n    61→     * @param int $id ID del servicio de IA.\n    62→     * @param Request $request Contenido de la petición.\n    63→     * @return JsonResponse\n    64→     * @author Sergio Vargas\n    65→     * @author Daniel Beltrán\n    66→     */\n    67→    public function update(int $id, Request $request): JsonResponse {\n    68→        $codigo    = JsonResponse::HTTP_OK;\n    69→        $respuesta = ['message' => 'Servicio de IA actualizado correctamente'];\n    70→\n    71→        try {\n    72→            DB::beginTransaction();\n    73→            $this->repositorio->actualizar($id, $request->except(['_token', '_method', 'id']));\n    74→            DB::commit();\n    75→        } catch (Exception $error) {\n    76→            DB::rollBack();\n    77→            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n    78→            $respuesta = [\n    79→                'message' => 'Ocurrio un error',\n    80→                'errors'  => $error->getMessage(),\n    81→            ];\n    82→        }\n    83→\n    84→        return new JsonResponse($respuesta, $codigo);\n    85→    }\n    86→\n    87→    /**\n    88→     * Activar servicio de IA.\n    89→     *\n    90→     * @param int $id ID del servicio de IA.\n    91→     * @return JsonResponse\n    92→     * @author Sergio Vargas\n    93→     * @author Daniel Beltrán\n    94→     */\n    95→    public function activar(int $id): JsonResponse {\n    96→        return $this->cambiarEstado($id, true, 'Servicio IA activado correctamente');\n    97→    }\n    98→\n    99→    /**\n   100→     * Desactivar servicio de IA.\n   101→     *\n   102→     * @param int $id ID del servicio de IA.\n   103→     * @return JsonResponse\n   104→     * @author Sergio Vargas\n   105→     * @author Daniel Beltrán\n   106→     */\n   107→    public function desactivar(int $id): JsonResponse {\n   108→        return $this->cambiarEstado($id, false, 'Servicio IA desactivado correctamente');\n   109→    }\n   110→\n   111→    /**\n   112→     * Cambiar estado activo del servicio de IA.\n   113→     *\n   114→     * @param int $id ID del servicio de IA.\n   115→     * @param bool $activo Estado del servicio.\n   116→     * @param string $mensaje Mensaje de respuesta.\n   117→     * @return JsonResponse\n   118→     * @author Sergio Vargas\n   119→     * @author Daniel Beltrán\n   120→     */\n   121→    private function cambiarEstado(int $id, bool $activo, string $mensaje): JsonResponse {\n   122→        $codigo    = JsonResponse::HTTP_OK;\n   123→        $respuesta = ['message' => $mensaje];\n   124→\n   125→        try {\n   126→            DB::beginTransaction();\n   127→            $this->repositorio->actualizar($id, ['activo' => $activo]);\n   128→            DB::commit();\n   129→        } catch (Exception $error) {\n   130→            DB::rollBack();\n   131→            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n   132→            $respuesta = [\n   133→                'message' => 'Ocurrió un error',\n   134→                'errors'  => $error->getMessage(),\n   135→            ];\n   136→        }\n   137→\n   138→        return new JsonResponse($respuesta, $codigo);\n   139→    }\n   140→}\n   141→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d3811c2a-3d2c-4a2c-bf78-c1e544e19d1e","timestamp":"2026-01-15T19:42:17.718Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\IA\\ServicioIAController.php","content":"<?php\n\nnamespace App\\Http\\Controllers\\IA;\n\nuse Exception;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\JsonResponse;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Http\\Controllers\\Controller;\nuse App\\Http\\Repositories\\IA\\ServicioIARepository;\n\nclass ServicioIAController extends Controller\n{\n    public function __construct(private ServicioIARepository $repositorio) {}\n\n    /**\n     * Obtener listado de servicios de IA.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function index(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->repositorio->getTodo($request),\n        ], JsonResponse::HTTP_OK);\n    }\n\n    /**\n     * Crear servicio de IA.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function store(Request $request): JsonResponse {\n        $codigo    = JsonResponse::HTTP_CREATED;\n        $respuesta = ['message' => 'Servicio de IA creado correctamente'];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->crear($request->except(['_token', '_method', 'id']));\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n            $respuesta = [\n                'message' => 'Ocurrio un error',\n                'errors'  => $error->getMessage(),\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar servicio de IA.\n     *\n     * @param int $id ID del servicio de IA.\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function update(int $id, Request $request): JsonResponse {\n        $codigo    = JsonResponse::HTTP_OK;\n        $respuesta = ['message' => 'Servicio de IA actualizado correctamente'];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->actualizar($id, $request->except(['_token', '_method', 'id']));\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n            $respuesta = [\n                'message' => 'Ocurrio un error',\n                'errors'  => $error->getMessage(),\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Activar servicio de IA.\n     *\n     * @param int $id ID del servicio de IA.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function activar(int $id): JsonResponse {\n        return $this->cambiarEstado($id, true, 'Servicio IA activado correctamente');\n    }\n\n    /**\n     * Desactivar servicio de IA.\n     *\n     * @param int $id ID del servicio de IA.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function desactivar(int $id): JsonResponse {\n        return $this->cambiarEstado($id, false, 'Servicio IA desactivado correctamente');\n    }\n\n    /**\n     * Cambiar estado activo del servicio de IA.\n     *\n     * @param int $id ID del servicio de IA.\n     * @param bool $activo Estado del servicio.\n     * @param string $mensaje Mensaje de respuesta.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function cambiarEstado(int $id, bool $activo, string $mensaje): JsonResponse {\n        $codigo    = JsonResponse::HTTP_OK;\n        $respuesta = ['message' => $mensaje];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->actualizar($id, ['activo' => $activo]);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n            $codigo    = JsonResponse::HTTP_BAD_REQUEST;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage(),\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n}\n","numLines":141,"startLine":1,"totalLines":141}},"sourceToolAssistantUUID":"75fbf22a-f410-4bf5-ac14-0312d87b457a"}
{"parentUuid":"d3811c2a-3d2c-4a2c-bf78-c1e544e19d1e","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01X9XNkVXSojS3HHKp1RbKAq","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora voy a buscar por repositorios y servicios de IA para completar la información:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":7876,"cache_read_input_tokens":66349,"cache_creation":{"ephemeral_5m_input_tokens":7876,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jY3rYPoBLpzows9rPV","type":"assistant","uuid":"004deec7-967d-42db-9b3a-8f9b29354d9c","timestamp":"2026-01-15T19:42:19.886Z"}
{"parentUuid":"004deec7-967d-42db-9b3a-8f9b29354d9c","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01X9XNkVXSojS3HHKp1RbKAq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01D9Tb6E4DgY5rgD31XPHvFw","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ServicioIARepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":7876,"cache_read_input_tokens":66349,"cache_creation":{"ephemeral_5m_input_tokens":7876,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jY3rYPoBLpzows9rPV","type":"assistant","uuid":"5b9214a0-93c2-4046-8f3e-6818ecadffe2","timestamp":"2026-01-15T19:42:20.666Z"}
{"parentUuid":"5b9214a0-93c2-4046-8f3e-6818ecadffe2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01X9XNkVXSojS3HHKp1RbKAq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GK4Vhwyj9Lm8FNjM2bH82A","name":"Glob","input":{"pattern":"**/Controllers/IA/**/*.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":7876,"cache_read_input_tokens":66349,"cache_creation":{"ephemeral_5m_input_tokens":7876,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jY3rYPoBLpzows9rPV","type":"assistant","uuid":"235ff2f9-3ee0-4a59-82c2-d3e5fcf9130b","timestamp":"2026-01-15T19:42:20.919Z"}
{"parentUuid":"235ff2f9-3ee0-4a59-82c2-d3e5fcf9130b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01X9XNkVXSojS3HHKp1RbKAq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XuaRiE3B8RXqoTaCdcvJgB","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\CategoriaServicioIA.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":7876,"cache_read_input_tokens":66349,"cache_creation":{"ephemeral_5m_input_tokens":7876,"ephemeral_1h_input_tokens":0},"output_tokens":231,"service_tier":"standard"}},"requestId":"req_011CX9jY3rYPoBLpzows9rPV","type":"assistant","uuid":"7df43f12-f3a6-43e2-991a-f2d926a1ab34","timestamp":"2026-01-15T19:42:21.271Z"}
{"parentUuid":"5b9214a0-93c2-4046-8f3e-6818ecadffe2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01D9Tb6E4DgY5rgD31XPHvFw","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\IA;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\IA\\ServicioIA;\n     7→use Illuminate\\Support\\Collection;\n     8→use App\\Http\\Repositories\\BaseRepository;\n     9→use App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n    10→\n    11→class ServicioIARepository extends BaseRepository implements ObtenerUnoAvanzado\n    12→{\n    13→    /**\n    14→     * Constructor.\n    15→     *\n    16→     * @param ServicioIA $modelo Modelo de servicios de IA.\n    17→     * @return void\n    18→     * @author Sergio Vargas\n    19→     * @author Daniel Beltrán\n    20→     */\n    21→    public function __construct(ServicioIA $modelo) {\n    22→        parent::__construct($modelo);\n    23→    }\n    24→\n    25→    /**\n    26→     * Obtener servicios de IA.\n    27→     *\n    28→     * @param Request $request Contenido de la petición.\n    29→     * @return Collection\n    30→     * @author Sergio Vargas\n    31→     * @author Daniel Beltrán\n    32→     */\n    33→    public function getTodo(Request $request): Collection {\n    34→        return $this->modelo->select('id', 'categoria_servicio_ia_id', 'nombre', 'endpoint', 'descripcion', 'consume_creditos')\n    35→        ->with('categoria')\n    36→        ->when($request->filled('activo'), function ($consulta) use ($request) {\n    37→            $consulta->where('activo', filter_var($request->activo, FILTER_VALIDATE_BOOLEAN));\n    38→        })\n    39→        ->when($request->filled('categoria_servicio_ia_id'), function ($consulta) use ($request) {\n    40→            $consulta->where('categoria_servicio_ia_id', $request->categoria_servicio_ia_id);\n    41→        })\n    42→        ->orderBy('created_at', 'DESC')\n    43→        ->get();\n    44→    }\n    45→\n    46→    /**\n    47→     * Obtener un servicio de IA en base a filtros avanzados.\n    48→     *\n    49→     * @param Request $request Contenido de la petición.\n    50→     * @return ?ServicioIA\n    51→     * @author Daniel Beltrán\n    52→     */\n    53→    public function getUnoAvanzado(Request $request): ?ServicioIA {\n    54→        return $this->modelo->select('id', 'categoria_servicio_ia_id', 'nombre', 'endpoint', 'descripcion', 'consume_creditos', 'activo')\n    55→        ->when($request->filled('endpoint'), fn($consulta) => $consulta->where('endpoint', $request->endpoint))\n    56→        ->first();\n    57→    }\n    58→}\n    59→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"182765c9-ab0e-40a9-a35d-3b79a79df5f0","timestamp":"2026-01-15T19:42:24.073Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ServicioIARepository.php","content":"<?php\n\nnamespace App\\Http\\Repositories\\IA;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\IA\\ServicioIA;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\BaseRepository;\nuse App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n\nclass ServicioIARepository extends BaseRepository implements ObtenerUnoAvanzado\n{\n    /**\n     * Constructor.\n     *\n     * @param ServicioIA $modelo Modelo de servicios de IA.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(ServicioIA $modelo) {\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener servicios de IA.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getTodo(Request $request): Collection {\n        return $this->modelo->select('id', 'categoria_servicio_ia_id', 'nombre', 'endpoint', 'descripcion', 'consume_creditos')\n        ->with('categoria')\n        ->when($request->filled('activo'), function ($consulta) use ($request) {\n            $consulta->where('activo', filter_var($request->activo, FILTER_VALIDATE_BOOLEAN));\n        })\n        ->when($request->filled('categoria_servicio_ia_id'), function ($consulta) use ($request) {\n            $consulta->where('categoria_servicio_ia_id', $request->categoria_servicio_ia_id);\n        })\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    /**\n     * Obtener un servicio de IA en base a filtros avanzados.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return ?ServicioIA\n     * @author Daniel Beltrán\n     */\n    public function getUnoAvanzado(Request $request): ?ServicioIA {\n        return $this->modelo->select('id', 'categoria_servicio_ia_id', 'nombre', 'endpoint', 'descripcion', 'consume_creditos', 'activo')\n        ->when($request->filled('endpoint'), fn($consulta) => $consulta->where('endpoint', $request->endpoint))\n        ->first();\n    }\n}\n","numLines":59,"startLine":1,"totalLines":59}},"sourceToolAssistantUUID":"5b9214a0-93c2-4046-8f3e-6818ecadffe2"}
{"parentUuid":"7df43f12-f3a6-43e2-991a-f2d926a1ab34","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XuaRiE3B8RXqoTaCdcvJgB","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\IA;\n     4→\n     5→use Illuminate\\Database\\Eloquent\\Model;\n     6→use Illuminate\\Database\\Eloquent\\Builder;\n     7→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n     8→\n     9→class CategoriaServicioIA extends Model\n    10→{\n    11→    protected $table = 'categorias_servicios_ia';\n    12→\n    13→    protected $fillable = [\n    14→        'nombre',\n    15→        'codigo',\n    16→        'descripcion',\n    17→        'orden',\n    18→        'activo'\n    19→    ];\n    20→\n    21→    protected $casts = [\n    22→        'orden'  => 'integer',\n    23→        'activo' => 'boolean'\n    24→    ];\n    25→\n    26→    /**\n    27→     * Filtrar la consulta por registros activos.\n    28→     *\n    29→     * @param Builder $consulta Consulta.\n    30→     * @author Sergio Vargas\n    31→     * @author Daniel Beltrán\n    32→     */\n    33→    public function scopeActivas(Builder $consulta): Builder {\n    34→        return $consulta->where('activo', true);\n    35→    }\n    36→\n    37→    /**\n    38→     * Relación de uno a muchos con servicios_ia.\n    39→     *\n    40→     * @return HasMany\n    41→     * @author Sergio Vargas\n    42→     * @author Daniel Beltrán\n    43→     */\n    44→    public function servicios(): HasMany {\n    45→        return $this->hasMany(ServicioIA::class, 'categoria_servicio_ia_id');\n    46→    }\n    47→}\n    48→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"12c4aa88-3d79-4a13-b5a2-f8876868a913","timestamp":"2026-01-15T19:42:24.074Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\CategoriaServicioIA.php","content":"<?php\n\nnamespace App\\Models\\IA;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Builder;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n\nclass CategoriaServicioIA extends Model\n{\n    protected $table = 'categorias_servicios_ia';\n\n    protected $fillable = [\n        'nombre',\n        'codigo',\n        'descripcion',\n        'orden',\n        'activo'\n    ];\n\n    protected $casts = [\n        'orden'  => 'integer',\n        'activo' => 'boolean'\n    ];\n\n    /**\n     * Filtrar la consulta por registros activos.\n     *\n     * @param Builder $consulta Consulta.\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function scopeActivas(Builder $consulta): Builder {\n        return $consulta->where('activo', true);\n    }\n\n    /**\n     * Relación de uno a muchos con servicios_ia.\n     *\n     * @return HasMany\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function servicios(): HasMany {\n        return $this->hasMany(ServicioIA::class, 'categoria_servicio_ia_id');\n    }\n}\n","numLines":48,"startLine":1,"totalLines":48}},"sourceToolAssistantUUID":"7df43f12-f3a6-43e2-991a-f2d926a1ab34"}
{"parentUuid":"235ff2f9-3ee0-4a59-82c2-d3e5fcf9130b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GK4Vhwyj9Lm8FNjM2bH82A","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\IA\\CategoriaServicioIAController.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\IA\\ServicioIAController.php"}]},"uuid":"fa33fe37-6535-48b6-93e8-ed92d9104ab2","timestamp":"2026-01-15T19:42:25.088Z","toolUseResult":{"filenames":["C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\IA\\CategoriaServicioIAController.php","C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\IA\\ServicioIAController.php"],"durationMs":1036,"numFiles":2,"truncated":false},"sourceToolAssistantUUID":"235ff2f9-3ee0-4a59-82c2-d3e5fcf9130b"}
{"parentUuid":"fa33fe37-6535-48b6-93e8-ed92d9104ab2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_018AFb8fb3fiXhNEdtCsPz1u","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente. Ahora voy a ver la base de datos para entender la relación de tablas:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":598,"cache_creation_input_tokens":1394,"cache_read_input_tokens":74225,"cache_creation":{"ephemeral_5m_input_tokens":1394,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jYbUZhHtau3T4jo1Yc","type":"assistant","uuid":"30a1a169-fadf-4c4d-bdf6-aaaced60826f","timestamp":"2026-01-15T19:42:27.081Z"}
{"parentUuid":"30a1a169-fadf-4c4d-bdf6-aaaced60826f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_018AFb8fb3fiXhNEdtCsPz1u","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018FdhHSanS2H1fJ1ugenLCU","name":"Bash","input":{"command":"find \"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\" -type f -name \"*planes*\" -o -name \"*servicios_ia*\" -o -name \"*consumo*credito*\" | head -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":598,"cache_creation_input_tokens":1394,"cache_read_input_tokens":74225,"cache_creation":{"ephemeral_5m_input_tokens":1394,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jYbUZhHtau3T4jo1Yc","type":"assistant","uuid":"4a5109ca-4cb4-460c-bdd4-4a10f345ade3","timestamp":"2026-01-15T19:42:27.857Z"}
{"parentUuid":"4a5109ca-4cb4-460c-bdd4-4a10f345ade3","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_018AFb8fb3fiXhNEdtCsPz1u","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016gzHnREAA5AwF9wMsJRai6","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":598,"cache_creation_input_tokens":1394,"cache_read_input_tokens":74225,"cache_creation":{"ephemeral_5m_input_tokens":1394,"ephemeral_1h_input_tokens":0},"output_tokens":211,"service_tier":"standard"}},"requestId":"req_011CX9jYbUZhHtau3T4jo1Yc","type":"assistant","uuid":"f7d2ed38-1375-4509-9065-dd8dd2914009","timestamp":"2026-01-15T19:42:28.299Z"}
{"parentUuid":"f7d2ed38-1375-4509-9065-dd8dd2914009","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016gzHnREAA5AwF9wMsJRai6","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\IA;\n     4→\n     5→use Carbon\\Carbon;\n     6→use App\\Models\\IA\\ConsumoCredito;\n     7→use Illuminate\\Support\\Collection;\n     8→use App\\Http\\Repositories\\BaseRepository;\n     9→\n    10→class ConsumoCreditoRepository extends BaseRepository\n    11→{\n    12→    /**\n    13→     * Constructor.\n    14→     *\n    15→     * @param ConsumoCredito $modelo Modelo de consumos de créditos.\n    16→     * @return void\n    17→     * @author Sergio Vargas\n    18→     * @author Daniel Beltrán\n    19→     */\n    20→    public function __construct(ConsumoCredito $modelo) {\n    21→        parent::__construct($modelo);\n    22→    }\n    23→\n    24→    /**\n    25→     * Obtener consumo por usuario.\n    26→     *\n    27→     * @param int $usuario_id ID del usuario.\n    28→     * @param ?Carbon $desde Fecha inicial.\n    29→     * @param ?Carbon $hasta Fecha final.\n    30→     * @return Collection\n    31→     * @author Sergio Vargas\n    32→     * @author Daniel Beltrán\n    33→     */\n    34→    public function obtenerConsumoPorUsuario(int $usuario_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n    35→        return $this->modelo\n    36→        ->where('usuario_id', $usuario_id)\n    37→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n    38→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n    39→        ->get();\n    40→    }\n    41→\n    42→    /**\n    43→     * Obtener consumo por empresa.\n    44→     *\n    45→     * @param int $empresa_id ID de la empresa.\n    46→     * @param ?Carbon $desde Fecha inicial.\n    47→     * @param ?Carbon $hasta Fecha final.\n    48→     * @return Collection\n    49→     * @author Sergio Vargas\n    50→     * @author Daniel Beltrán\n    51→     */\n    52→    public function obtenerConsumoPorEmpresa(int $empresa_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n    53→        return $this->modelo\n    54→        ->where('empresa_id', $empresa_id)\n    55→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n    56→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n    57→        ->get();\n    58→    }\n    59→\n    60→    /**\n    61→     * Obtener estadísticas por endpoint.\n    62→     *\n    63→     * @param string $ruta_endpoint Endpoint.\n    64→     * @param ?Carbon $desde Fecha inicial.\n    65→     * @param ?Carbon $hasta Fecha final.\n    66→     * @return ?object\n    67→     * @author Sergio Vargas\n    68→     * @author Daniel Beltrán\n    69→     */\n    70→    public function obtenerEstadisticasPorEndpoint(string $ruta_endpoint, ?Carbon $desde = null, ?Carbon $hasta = null): ?object {\n    71→        return $this->modelo\n    72→        ->where('ruta_endpoint', $ruta_endpoint)\n    73→        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n    74→        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n    75→        ->selectRaw('\n    76→            COUNT(*) as total_peticiones,\n    77→            SUM(tokens_totales) as total_tokens,\n    78→            SUM(costo_estimado_usd) as costo_total,\n    79→            AVG(latencia_ms) as latencia_promedio_ms\n    80→        ')\n    81→        ->first();\n    82→    }\n    83→\n    84→    /**\n    85→     * Obtener consumos por plan de empresa.\n    86→     *\n    87→     * @param int $empresa_plan_id ID del plan de empresa.\n    88→     * @return Collection\n    89→     * @author Sergio Vargas\n    90→     * @author Daniel Beltrán\n    91→     */\n    92→    public function obtenerConsumoPorEmpresaPlan(int $empresa_plan_id): Collection {\n    93→        return $this->modelo\n    94→        ->where('empresa_plan_id', $empresa_plan_id)\n    95→        ->get();\n    96→    }\n    97→\n    98→    /**\n    99→     * Obtener estadísticas por servicio de IA.\n   100→     *\n   101→     * @param int $empresa_id ID de la empresa.\n   102→     * @return Collection\n   103→     * @author Sergio Vargas\n   104→     * @author Daniel Beltrán\n   105→     */\n   106→    public function estadisticasPorServicio(int $empresa_id): Collection {\n   107→        return $this->modelo\n   108→        ->where('empresa_id', $empresa_id)\n   109→        ->selectRaw('servicio_ia_id, COUNT(*) as total_peticiones, SUM(creditos) as total_creditos')\n   110→        ->groupBy('servicio_ia_id')\n   111→        ->get();\n   112→    }\n   113→\n   114→    /**\n   115→     * Obtener total de créditos consumidos por plan de empresa.\n   116→     *\n   117→     * @param int $empresa_plan_id ID del plan de empresa.\n   118→     * @return int\n   119→     * @author Sergio Vargas\n   120→     * @author Daniel Beltrán\n   121→     */\n   122→    public function totalCreditosConsumidos(int $empresa_plan_id): int {\n   123→        return (int) $this->modelo->where('empresa_plan_id', $empresa_plan_id)->sum('creditos');\n   124→    }\n   125→}\n   126→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"33368013-e200-4ec1-bdc6-e9cd777a2d5e","timestamp":"2026-01-15T19:42:29.621Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php","content":"<?php\n\nnamespace App\\Http\\Repositories\\IA;\n\nuse Carbon\\Carbon;\nuse App\\Models\\IA\\ConsumoCredito;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\BaseRepository;\n\nclass ConsumoCreditoRepository extends BaseRepository\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCredito $modelo Modelo de consumos de créditos.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(ConsumoCredito $modelo) {\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener consumo por usuario.\n     *\n     * @param int $usuario_id ID del usuario.\n     * @param ?Carbon $desde Fecha inicial.\n     * @param ?Carbon $hasta Fecha final.\n     * @return Collection\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function obtenerConsumoPorUsuario(int $usuario_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n        return $this->modelo\n        ->where('usuario_id', $usuario_id)\n        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n        ->get();\n    }\n\n    /**\n     * Obtener consumo por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param ?Carbon $desde Fecha inicial.\n     * @param ?Carbon $hasta Fecha final.\n     * @return Collection\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function obtenerConsumoPorEmpresa(int $empresa_id, ?Carbon $desde = null, ?Carbon $hasta = null): Collection {\n        return $this->modelo\n        ->where('empresa_id', $empresa_id)\n        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n        ->get();\n    }\n\n    /**\n     * Obtener estadísticas por endpoint.\n     *\n     * @param string $ruta_endpoint Endpoint.\n     * @param ?Carbon $desde Fecha inicial.\n     * @param ?Carbon $hasta Fecha final.\n     * @return ?object\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function obtenerEstadisticasPorEndpoint(string $ruta_endpoint, ?Carbon $desde = null, ?Carbon $hasta = null): ?object {\n        return $this->modelo\n        ->where('ruta_endpoint', $ruta_endpoint)\n        ->when($desde, fn($consulta) => $consulta->where('created_at', '>=', $desde))\n        ->when($hasta, fn($consulta) => $consulta->where('created_at', '<=', $hasta))\n        ->selectRaw('\n            COUNT(*) as total_peticiones,\n            SUM(tokens_totales) as total_tokens,\n            SUM(costo_estimado_usd) as costo_total,\n            AVG(latencia_ms) as latencia_promedio_ms\n        ')\n        ->first();\n    }\n\n    /**\n     * Obtener consumos por plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function obtenerConsumoPorEmpresaPlan(int $empresa_plan_id): Collection {\n        return $this->modelo\n        ->where('empresa_plan_id', $empresa_plan_id)\n        ->get();\n    }\n\n    /**\n     * Obtener estadísticas por servicio de IA.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function estadisticasPorServicio(int $empresa_id): Collection {\n        return $this->modelo\n        ->where('empresa_id', $empresa_id)\n        ->selectRaw('servicio_ia_id, COUNT(*) as total_peticiones, SUM(creditos) as total_creditos')\n        ->groupBy('servicio_ia_id')\n        ->get();\n    }\n\n    /**\n     * Obtener total de créditos consumidos por plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function totalCreditosConsumidos(int $empresa_plan_id): int {\n        return (int) $this->modelo->where('empresa_plan_id', $empresa_plan_id)->sum('creditos');\n    }\n}\n","numLines":126,"startLine":1,"totalLines":126}},"sourceToolAssistantUUID":"f7d2ed38-1375-4509-9065-dd8dd2914009"}
{"parentUuid":"4a5109ca-4cb4-460c-bdd4-4a10f345ade3","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018FdhHSanS2H1fJ1ugenLCU","type":"tool_result","content":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_01_072424_create_estados_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_01_072426_create_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_01_074417_create_modulos_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_01_074425_create_funcionalidades_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_06_164436_create_empresas_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_07_15_094318_create_empresas_planes_pruebas_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_09_02_164635_create_empresas_planes_funcionalidades_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2025_07_02_072226_add_usuario_id_to_empresa_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000001_create_planes_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000002_create_categorias_servicios_ia_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000003_create_servicios_ia_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000005_rename_consumos_tokens_openai_to_consumos_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php","is_error":false}]},"uuid":"ffdab489-1562-4a82-8142-0bb7f328b001","timestamp":"2026-01-15T19:42:30.266Z","toolUseResult":{"stdout":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_01_072424_create_estados_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_01_072426_create_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_01_074417_create_modulos_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_01_074425_create_funcionalidades_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_03_06_164436_create_empresas_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_07_15_094318_create_empresas_planes_pruebas_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2024_09_02_164635_create_empresas_planes_funcionalidades_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2025_07_02_072226_add_usuario_id_to_empresa_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000001_create_planes_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000002_create_categorias_servicios_ia_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000003_create_servicios_ia_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000004_add_creditos_fields_to_empresas_planes_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000005_rename_consumos_tokens_openai_to_consumos_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php\nC:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations/2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"4a5109ca-4cb4-460c-bdd4-4a10f345ade3"}
{"parentUuid":"ffdab489-1562-4a82-8142-0bb7f328b001","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DsCT4urHc7frFTfaaktyUw","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora voy a revisar las migraciones para entender la estructura de la base de datos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1782,"cache_creation_input_tokens":1838,"cache_read_input_tokens":75619,"cache_creation":{"ephemeral_5m_input_tokens":1838,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jYy7KenNxqzEhDMQPD","type":"assistant","uuid":"1ba94af9-608b-4cc0-9362-9327d61c38d2","timestamp":"2026-01-15T19:42:32.152Z"}
{"parentUuid":"1ba94af9-608b-4cc0-9362-9327d61c38d2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DsCT4urHc7frFTfaaktyUw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KwrMkDgnaduWXLq3KLaDhA","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000001_create_planes_creditos_table.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1782,"cache_creation_input_tokens":1838,"cache_read_input_tokens":75619,"cache_creation":{"ephemeral_5m_input_tokens":1838,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jYy7KenNxqzEhDMQPD","type":"assistant","uuid":"cade5906-45d6-44c1-8be5-5242c3f89c8d","timestamp":"2026-01-15T19:42:32.842Z"}
{"parentUuid":"cade5906-45d6-44c1-8be5-5242c3f89c8d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DsCT4urHc7frFTfaaktyUw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TEdboRemtiXc99AQ1y8pHm","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000003_create_servicios_ia_table.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1782,"cache_creation_input_tokens":1838,"cache_read_input_tokens":75619,"cache_creation":{"ephemeral_5m_input_tokens":1838,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jYy7KenNxqzEhDMQPD","type":"assistant","uuid":"13ebb2ac-763f-48cc-b677-7ad654a280d6","timestamp":"2026-01-15T19:42:33.235Z"}
{"parentUuid":"13ebb2ac-763f-48cc-b677-7ad654a280d6","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DsCT4urHc7frFTfaaktyUw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LXYQSka2N1H5WmMBFzaqFE","name":"Grep","input":{"pattern":"consumos_creditos|consumos_tokens","type":"php","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations","head_limit":5}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1782,"cache_creation_input_tokens":1838,"cache_read_input_tokens":75619,"cache_creation":{"ephemeral_5m_input_tokens":1838,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jYy7KenNxqzEhDMQPD","type":"assistant","uuid":"e56fcc5d-50b3-411c-87f1-0beb020b9ed2","timestamp":"2026-01-15T19:42:33.902Z"}
{"parentUuid":"cade5906-45d6-44c1-8be5-5242c3f89c8d","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KwrMkDgnaduWXLq3KLaDhA","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Facades\\Schema;\n     4→use Illuminate\\Database\\Schema\\Blueprint;\n     5→use Illuminate\\Database\\Migrations\\Migration;\n     6→\n     7→return new class extends Migration\n     8→{\n     9→    /**\n    10→     * Run the migrations.\n    11→     */\n    12→    public function up(): void {\n    13→        Schema::create('planes_creditos', function (Blueprint $table) {\n    14→            $table->id();\n    15→            $table->string('nombre', 100)->comment('Nombre del plan');\n    16→            $table->text('descripcion')->nullable()->comment('Descripción');\n    17→            $table->integer('creditos')->comment('Créditos');\n    18→            $table->decimal('precio', 10, 2)->comment('Precio');\n    19→            $table->smallInteger('porcentaje_descuento')->nullable()->comment('Porcentaje de descuento');\n    20→            $table->date('fecha_inicio_promocion')->nullable()->comment('Fecha de inicio de la promoción');\n    21→            $table->date('fecha_fin_promocion')->nullable()->comment('Fecha final de la promoción');\n    22→            $table->boolean('activo')->default(true)->comment('Indica si el registro está activo');\n    23→            $table->timestamps();\n    24→            $table->softDeletes();\n    25→\n    26→            $table->comment('Planes de créditos');\n    27→        });\n    28→    }\n    29→\n    30→    /**\n    31→     * Reverse the migrations.\n    32→     */\n    33→    public function down(): void {\n    34→        Schema::dropIfExists('planes_creditos');\n    35→    }\n    36→};\n    37→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"bed1e3ed-e821-49e0-88e7-819848fd9654","timestamp":"2026-01-15T19:42:36.694Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000001_create_planes_creditos_table.php","content":"<?php\n\nuse Illuminate\\Support\\Facades\\Schema;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Database\\Migrations\\Migration;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void {\n        Schema::create('planes_creditos', function (Blueprint $table) {\n            $table->id();\n            $table->string('nombre', 100)->comment('Nombre del plan');\n            $table->text('descripcion')->nullable()->comment('Descripción');\n            $table->integer('creditos')->comment('Créditos');\n            $table->decimal('precio', 10, 2)->comment('Precio');\n            $table->smallInteger('porcentaje_descuento')->nullable()->comment('Porcentaje de descuento');\n            $table->date('fecha_inicio_promocion')->nullable()->comment('Fecha de inicio de la promoción');\n            $table->date('fecha_fin_promocion')->nullable()->comment('Fecha final de la promoción');\n            $table->boolean('activo')->default(true)->comment('Indica si el registro está activo');\n            $table->timestamps();\n            $table->softDeletes();\n\n            $table->comment('Planes de créditos');\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void {\n        Schema::dropIfExists('planes_creditos');\n    }\n};\n","numLines":37,"startLine":1,"totalLines":37}},"sourceToolAssistantUUID":"cade5906-45d6-44c1-8be5-5242c3f89c8d"}
{"parentUuid":"13ebb2ac-763f-48cc-b677-7ad654a280d6","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TEdboRemtiXc99AQ1y8pHm","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Facades\\Schema;\n     4→use Illuminate\\Database\\Schema\\Blueprint;\n     5→use Illuminate\\Database\\Migrations\\Migration;\n     6→\n     7→return new class extends Migration\n     8→{\n     9→    /**\n    10→     * Run the migrations.\n    11→     */\n    12→    public function up(): void {\n    13→        Schema::create('servicios_ia', function (Blueprint $table) {\n    14→            $table->id();\n    15→            $table->foreignId('categoria_servicio_ia_id')->constrained('categorias_servicios_ia')->comment('Categoría de servicio de IA');\n    16→            $table->string('nombre', 150)->comment('Nombre');\n    17→            $table->string('endpoint', 100)->unique()->comment('Endpoint');\n    18→            $table->text('descripcion')->nullable()->comment('Descripción');\n    19→            $table->integer('consume_creditos')->default(0)->comment('Cantidad de créditos que consume');\n    20→            $table->boolean('activo')->default(true)->comment('Indica si el registro está activo');\n    21→            $table->timestamps();\n    22→\n    23→            $table->index(['categoria_servicio_ia_id', 'activo']);\n    24→            $table->comment('Servicios de IA');\n    25→        });\n    26→    }\n    27→\n    28→    /**\n    29→     * Reverse the migrations.\n    30→     */\n    31→    public function down(): void {\n    32→        Schema::dropIfExists('servicios_ia');\n    33→    }\n    34→};\n    35→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"132dee95-fc58-4406-90a9-7b3ba1b94cc3","timestamp":"2026-01-15T19:42:36.695Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000003_create_servicios_ia_table.php","content":"<?php\n\nuse Illuminate\\Support\\Facades\\Schema;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Database\\Migrations\\Migration;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void {\n        Schema::create('servicios_ia', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('categoria_servicio_ia_id')->constrained('categorias_servicios_ia')->comment('Categoría de servicio de IA');\n            $table->string('nombre', 150)->comment('Nombre');\n            $table->string('endpoint', 100)->unique()->comment('Endpoint');\n            $table->text('descripcion')->nullable()->comment('Descripción');\n            $table->integer('consume_creditos')->default(0)->comment('Cantidad de créditos que consume');\n            $table->boolean('activo')->default(true)->comment('Indica si el registro está activo');\n            $table->timestamps();\n\n            $table->index(['categoria_servicio_ia_id', 'activo']);\n            $table->comment('Servicios de IA');\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void {\n        Schema::dropIfExists('servicios_ia');\n    }\n};\n","numLines":35,"startLine":1,"totalLines":35}},"sourceToolAssistantUUID":"13ebb2ac-763f-48cc-b677-7ad654a280d6"}
{"parentUuid":"e56fcc5d-50b3-411c-87f1-0beb020b9ed2","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LXYQSka2N1H5WmMBFzaqFE","type":"tool_result","content":"Found 4 files limit: 5, offset: 0\ndatabase\\migrations\\2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php\ndatabase\\migrations\\2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php\ndatabase\\migrations\\2026_01_02_000005_rename_consumos_tokens_openai_to_consumos_creditos_table.php\ndatabase\\migrations\\2025_12_05_152922_create_consumos_tokens_openai_table.php"}]},"uuid":"944114d8-f453-44a1-a867-70a3bb56b436","timestamp":"2026-01-15T19:42:37.298Z","toolUseResult":{"mode":"files_with_matches","filenames":["database\\migrations\\2026_01_02_000007_rename_creditos_consumidos_to_creditos_in_consumos_creditos_table.php","database\\migrations\\2026_01_02_000006_add_servicio_ia_id_to_consumos_creditos_table.php","database\\migrations\\2026_01_02_000005_rename_consumos_tokens_openai_to_consumos_creditos_table.php","database\\migrations\\2025_12_05_152922_create_consumos_tokens_openai_table.php"],"numFiles":4,"appliedLimit":5},"sourceToolAssistantUUID":"e56fcc5d-50b3-411c-87f1-0beb020b9ed2"}
{"parentUuid":"944114d8-f453-44a1-a867-70a3bb56b436","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01U6myErKv9DQEmtRY21HRpn","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora voy a ver la migración donde se crean consumos_creditos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":3425,"cache_read_input_tokens":77457,"cache_creation":{"ephemeral_5m_input_tokens":3425,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jZVYenA8JyFoS3dN6o","type":"assistant","uuid":"dd2937bd-a590-4a88-afcb-5b84bd85fc7f","timestamp":"2026-01-15T19:42:39.567Z"}
{"parentUuid":"dd2937bd-a590-4a88-afcb-5b84bd85fc7f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01U6myErKv9DQEmtRY21HRpn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RwdJuhZx93oSUZ9WC9tFW1","name":"Read","input":{"file_path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2025_12_05_152922_create_consumos_tokens_openai_table.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":3425,"cache_read_input_tokens":77457,"cache_creation":{"ephemeral_5m_input_tokens":3425,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jZVYenA8JyFoS3dN6o","type":"assistant","uuid":"9fa35e35-bcc0-41fb-90a9-ec3d6ad6023f","timestamp":"2026-01-15T19:42:40.079Z"}
{"parentUuid":"9fa35e35-bcc0-41fb-90a9-ec3d6ad6023f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01U6myErKv9DQEmtRY21HRpn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018ZTuC3fzhhgYsAkTr59so2","name":"Grep","input":{"pattern":"ejemplo|endpoint.*plans-creditos|similar.*endpoint","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers","type":"php","head_limit":10}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":3425,"cache_read_input_tokens":77457,"cache_creation":{"ephemeral_5m_input_tokens":3425,"ephemeral_1h_input_tokens":0},"output_tokens":245,"service_tier":"standard"}},"requestId":"req_011CX9jZVYenA8JyFoS3dN6o","type":"assistant","uuid":"2f07b46f-2733-481b-a7f0-87af91ecef84","timestamp":"2026-01-15T19:42:40.831Z"}
{"parentUuid":"9fa35e35-bcc0-41fb-90a9-ec3d6ad6023f","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RwdJuhZx93oSUZ9WC9tFW1","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Database\\Migrations\\Migration;\n     4→use Illuminate\\Database\\Schema\\Blueprint;\n     5→use Illuminate\\Support\\Facades\\Schema;\n     6→\n     7→return new class extends Migration\n     8→{\n     9→    /**\n    10→     * Run the migrations.\n    11→     */\n    12→    public function up(): void\n    13→    {\n    14→        Schema::create('consumos_tokens_openai', function (Blueprint $table) {\n    15→            $table->id();\n    16→\n    17→            // Contexto de usuario/empresa\n    18→            $table->foreignId('usuario_id')->nullable()->constrained('users')->nullOnDelete();\n    19→            $table->foreignId('empresa_id')->nullable()->constrained('empresas')->nullOnDelete();\n    20→\n    21→            // Contexto de proceso (opcional)\n    22→            $table->foreignId('agenda_id')->nullable()->constrained('agendas')->nullOnDelete();\n    23→            $table->foreignId('vacante_id')->nullable()->constrained('vacantes')->nullOnDelete();\n    24→\n    25→            // Datos del endpoint y servicio\n    26→            $table->string('ruta_endpoint', 100); // ej: \"generar-vacante\"\n    27→            $table->string('nombre_servicio', 150)->nullable(); // ej: \"ia_vacantes.generar_vacante\"\n    28→            $table->string('modelo', 50)->default('desconocido'); // ej: \"gpt-4-0125-preview\"\n    29→\n    30→            // Tokens consumidos\n    31→            $table->integer('tokens_entrada')->default(0);\n    32→            $table->integer('tokens_salida')->default(0);\n    33→            $table->integer('tokens_totales')->default(0);\n    34→            $table->integer('caracteres_entrada')->nullable(); // Caracteres de entrada (opcional)\n    35→\n    36→            // Costo estimado\n    37→            $table->decimal('costo_estimado_usd', 10, 6)->default(0.000000);\n    38→\n    39→            // Huella digital y extractos de petición/respuesta\n    40→            $table->string('huella_peticion', 64)->nullable(); // SHA256 del payload\n    41→            $table->text('extracto_peticion')->nullable(); // Primeros 500 chars del request\n    42→            $table->text('extracto_respuesta')->nullable(); // Primeros 500 chars del response\n    43→\n    44→            // Metadata de ejecución\n    45→            $table->string('estado', 20)->default('exitoso'); // exitoso, error, timeout\n    46→            $table->integer('latencia_ms')->nullable(); // Tiempo de respuesta en ms\n    47→            $table->text('mensaje_error')->nullable(); // Mensaje de error si falla\n    48→\n    49→            // Auditoría\n    50→            $table->timestamp('created_at')->useCurrent();\n    51→            $table->index(['usuario_id', 'created_at']);\n    52→            $table->index(['empresa_id', 'created_at']);\n    53→            $table->index(['ruta_endpoint', 'created_at']);\n    54→            $table->index('huella_peticion');\n    55→        });\n    56→    }\n    57→\n    58→    /**\n    59→     * Reverse the migrations.\n    60→     */\n    61→    public function down(): void\n    62→    {\n    63→        Schema::dropIfExists('consumos_tokens_openai');\n    64→    }\n    65→};\n    66→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"45635de3-60ed-4c59-bc58-8bd7d5cbd9c8","timestamp":"2026-01-15T19:42:42.800Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2025_12_05_152922_create_consumos_tokens_openai_table.php","content":"<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        Schema::create('consumos_tokens_openai', function (Blueprint $table) {\n            $table->id();\n\n            // Contexto de usuario/empresa\n            $table->foreignId('usuario_id')->nullable()->constrained('users')->nullOnDelete();\n            $table->foreignId('empresa_id')->nullable()->constrained('empresas')->nullOnDelete();\n\n            // Contexto de proceso (opcional)\n            $table->foreignId('agenda_id')->nullable()->constrained('agendas')->nullOnDelete();\n            $table->foreignId('vacante_id')->nullable()->constrained('vacantes')->nullOnDelete();\n\n            // Datos del endpoint y servicio\n            $table->string('ruta_endpoint', 100); // ej: \"generar-vacante\"\n            $table->string('nombre_servicio', 150)->nullable(); // ej: \"ia_vacantes.generar_vacante\"\n            $table->string('modelo', 50)->default('desconocido'); // ej: \"gpt-4-0125-preview\"\n\n            // Tokens consumidos\n            $table->integer('tokens_entrada')->default(0);\n            $table->integer('tokens_salida')->default(0);\n            $table->integer('tokens_totales')->default(0);\n            $table->integer('caracteres_entrada')->nullable(); // Caracteres de entrada (opcional)\n\n            // Costo estimado\n            $table->decimal('costo_estimado_usd', 10, 6)->default(0.000000);\n\n            // Huella digital y extractos de petición/respuesta\n            $table->string('huella_peticion', 64)->nullable(); // SHA256 del payload\n            $table->text('extracto_peticion')->nullable(); // Primeros 500 chars del request\n            $table->text('extracto_respuesta')->nullable(); // Primeros 500 chars del response\n\n            // Metadata de ejecución\n            $table->string('estado', 20)->default('exitoso'); // exitoso, error, timeout\n            $table->integer('latencia_ms')->nullable(); // Tiempo de respuesta en ms\n            $table->text('mensaje_error')->nullable(); // Mensaje de error si falla\n\n            // Auditoría\n            $table->timestamp('created_at')->useCurrent();\n            $table->index(['usuario_id', 'created_at']);\n            $table->index(['empresa_id', 'created_at']);\n            $table->index(['ruta_endpoint', 'created_at']);\n            $table->index('huella_peticion');\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::dropIfExists('consumos_tokens_openai');\n    }\n};\n","numLines":66,"startLine":1,"totalLines":66}},"sourceToolAssistantUUID":"9fa35e35-bcc0-41fb-90a9-ec3d6ad6023f"}
{"parentUuid":"2f07b46f-2733-481b-a7f0-87af91ecef84","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018ZTuC3fzhhgYsAkTr59so2","type":"tool_result","content":"No files found"}]},"uuid":"2289ea04-4fa6-4e7f-a6ed-c87701066e3b","timestamp":"2026-01-15T19:42:43.448Z","toolUseResult":{"mode":"files_with_matches","filenames":[],"numFiles":0,"appliedLimit":10},"sourceToolAssistantUUID":"2f07b46f-2733-481b-a7f0-87af91ecef84"}
{"parentUuid":"2289ea04-4fa6-4e7f-a6ed-c87701066e3b","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_019TTy3H9owbZxpDgnhmytq5","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente. Tengo suficiente información. Ahora voy a buscar archivos similares para ver ejemplos de endpoints que reciben un ID:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1720,"cache_read_input_tokens":80882,"cache_creation":{"ephemeral_5m_input_tokens":1720,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jZx1NBqhmNWL5EGG1d","type":"assistant","uuid":"bc6aa3af-a45c-4788-bd8b-6f9709711936","timestamp":"2026-01-15T19:42:45.640Z"}
{"parentUuid":"bc6aa3af-a45c-4788-bd8b-6f9709711936","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_019TTy3H9owbZxpDgnhmytq5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01722punveb5A6jy849PyKVJ","name":"Grep","input":{"pattern":"public function show\\(int \\$id","type":"php","path":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers","head_limit":5}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1720,"cache_read_input_tokens":80882,"cache_creation":{"ephemeral_5m_input_tokens":1720,"ephemeral_1h_input_tokens":0},"output_tokens":174,"service_tier":"standard"}},"requestId":"req_011CX9jZx1NBqhmNWL5EGG1d","type":"assistant","uuid":"b356e942-e66a-4888-b112-b17772ce03c7","timestamp":"2026-01-15T19:42:46.614Z"}
{"parentUuid":"b356e942-e66a-4888-b112-b17772ce03c7","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01722punveb5A6jy849PyKVJ","type":"tool_result","content":"Found 5 files limit: 5, offset: 0\napp\\Http\\Controllers\\Planes\\PlanController.php\napp\\Http\\Controllers\\Vacantes\\FormatoEntrevistaController.php\napp\\Http\\Controllers\\Usuarios\\UserController.php\napp\\Http\\Controllers\\Procesos\\ProcesoController.php\napp\\Http\\Controllers\\Vacantes\\VacanteController.php"}]},"uuid":"5cd43f59-a360-4a5b-9502-8a8a15894dfe","timestamp":"2026-01-15T19:42:48.074Z","toolUseResult":{"mode":"files_with_matches","filenames":["app\\Http\\Controllers\\Planes\\PlanController.php","app\\Http\\Controllers\\Vacantes\\FormatoEntrevistaController.php","app\\Http\\Controllers\\Usuarios\\UserController.php","app\\Http\\Controllers\\Procesos\\ProcesoController.php","app\\Http\\Controllers\\Vacantes\\VacanteController.php"],"numFiles":5,"appliedLimit":5},"sourceToolAssistantUUID":"b356e942-e66a-4888-b112-b17772ce03c7"}
{"parentUuid":"5cd43f59-a360-4a5b-9502-8a8a15894dfe","isSidechain":true,"userType":"external","cwd":"C:\\Users\\sergio\\proyectos\\Psicoalianza-2","sessionId":"75d76570-3385-4c44-b7aa-515695839163","version":"2.1.6","gitBranch":"pre-main","agentId":"a8197fc","slug":"idempotent-twirling-crab","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01M5sqCMQRcmSASBatMfowmN","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. Ahora tengo toda la información que necesito. Voy a compilar un informe completo sobre la arquitectura planes-créditos.\n\n## Resumen de Exploración: Planes-Créditos\n\nHe explorado exhaustivamente el código relacionado con planes-créditos y he identificado toda la arquitectura. A continuación presento mi análisis completo:\n\n---\n\n## 1. ENDPOINT `planes-creditos/create`\n\n### Rutas\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php` (líneas 282-284)\n\n```php\n// Planes de Créditos - Vista de creación\n$ruta->get('planes-creditos/create', 'Planes\\PlanController@crearPlanCreditos');\n$ruta->get('planes-creditos/{id}/edit', 'Planes\\PlanController@editarPlanCreditos');\n```\n\n**Archivo API:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php` (líneas 40-44)\n\n```php\n// Creditos IA\nRoute::get('planes-creditos', [PlanCreditoController::class, 'index']);\nRoute::post('planes-creditos', [PlanCreditoController::class, 'store']);\nRoute::put('planes-creditos/{id}', [PlanCreditoController::class, 'update']);\nRoute::delete('planes-creditos/{id}', [PlanCreditoController::class, 'destroy']);\n```\n\n---\n\n## 2. CONTROLADOR: PlanController\n\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php`\n\n### Métodos principales para planes-créditos:\n\n```php\n// Líneas 380-384: Cargar página de creación de plan de créditos\npublic function crearPlanCreditos(): View {\n    return view('planes.paginas.crear-creditos')->with([\n        'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    ]);\n}\n\n// Líneas 393-398: Cargar página de edición de plan de créditos\npublic function editarPlanCreditos(int $id): View {\n    return view('planes.paginas.crear-creditos')->with([\n        'plan'       => $this->plan_credito_repositorio->getUno($id),\n        'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    ]);\n}\n```\n\n### Constructor del controlador (líneas 50-62):\nInyecta `PlanCreditoRepository` que se utiliza para obtener datos de planes de créditos.\n\n---\n\n## 3. CONTROLADOR DE API: PlanCreditoController\n\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php`\n\nSigue arquitectura **Controlador-Servicio-Repositorio**:\n\n```php\nclass PlanCreditoController extends Controller {\n    public function __construct(\n        private PlanCreditoService $servicio,\n        private PlanCreditoRepository $repositorio\n    ) {}\n\n    // Líneas 37-40: Listar planes de créditos\n    public function index(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->repositorio->getTodo($request),\n        ], JsonResponse::HTTP_OK);\n    }\n\n    // Líneas 51-68: Crear plan de créditos\n    public function store(Request $request): JsonResponse {\n        try {\n            DB::beginTransaction();\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n            // Error handling...\n        }\n    }\n\n    // Líneas 80-98: Actualizar plan de créditos\n    public function update(int $id, Request $request): JsonResponse {\n        try {\n            DB::beginTransaction();\n            $request->merge(['id' => $id]);\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            // Error handling...\n        }\n    }\n}\n```\n\n---\n\n## 4. MODELOS INVOLUCRADOS\n\n### Modelo PlanCredito\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php`\n\n```php\nclass PlanCredito extends Model implements AuditableContract {\n    protected $table = 'planes_creditos';\n\n    protected $fillable = [\n        'nombre',\n        'descripcion',\n        'creditos',\n        'precio',\n        'porcentaje_descuento',\n        'fecha_inicio_promocion',\n        'fecha_fin_promocion',\n        'activo'\n    ];\n\n    // Relación uno a muchos con empresas_planes\n    public function empresasPlanes(): HasMany {\n        return $this->hasMany(EmpresaPlan::class, 'plan_credito_id');\n    }\n\n    // Calcula precio con descuento aplicado\n    public function getPrecioConDescuentoAttribute(): float {\n        if (!$this->estaEnPromocion()) {\n            return (float) $this->precio;\n        }\n        $descuento = $this->precio * ($this->porcentaje_descuento / 100);\n        return (float) max(0, $this->precio - $descuento);\n    }\n}\n```\n\n### Modelo ServicioIA\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php`\n\n```php\nclass ServicioIA extends Model {\n    protected $table = 'servicios_ia';\n\n    protected $fillable = [\n        'categoria_servicio_ia_id',\n        'nombre',\n        'endpoint',\n        'descripcion',\n        'consume_creditos',  // CLAVE: Créditos que consume este servicio\n        'activo'\n    ];\n\n    // Relación con categorías\n    public function categoria(): BelongsTo {\n        return $this->belongsTo(CategoriaServicioIA::class, 'categoria_servicio_ia_id');\n    }\n\n    // Relación con consumos de créditos\n    public function consumosCreditos(): HasMany {\n        return $this->hasMany(ConsumoCredito::class, 'servicio_ia_id');\n    }\n}\n```\n\n### Modelo ConsumoCredito\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php`\n\n```php\nclass ConsumoCredito extends Model {\n    protected $table = 'consumos_creditos';\n\n    protected $fillable = [\n        'usuario_id',\n        'empresa_id',\n        'empresa_plan_id',\n        'agenda_id',\n        'vacante_id',\n        'servicio_ia_id',\n        'creditos',  // Créditos consumidos en esta transacción\n        'ruta_endpoint',\n        'nombre_servicio',\n        // ... más campos\n    ];\n\n    // Relaciones\n    public function servicioIA(): BelongsTo {\n        return $this->belongsTo(ServicioIA::class, 'servicio_ia_id');\n    }\n}\n```\n\n---\n\n## 5. REPOSITORIO Y SERVICIO: Arquitectura Obligatoria\n\n### Repositorio: PlanCreditoRepository\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php`\n\n```php\nclass PlanCreditoRepository extends BaseRepository {\n    \n    // Obtiene todos los planes con filtros\n    public function getTodo(Request $request): Collection {\n        return $this->modelo->select('id', 'nombre', 'descripcion', 'creditos', 'precio', \n            'porcentaje_descuento', 'fecha_inicio_promocion', 'fecha_fin_promocion', 'activo', 'created_at')\n        ->withCount(['empresasPlanes as empresas_activas'])\n        ->when($request->filled('activo'), function ($consulta) use ($request) {\n            $consulta->where('activo', filter_var($request->activo, FILTER_VALIDATE_BOOLEAN));\n        })\n        ->when($request->filled('nombre'), function ($consulta) use ($request) {\n            $consulta->where('nombre', 'like', \"%{$request->nombre}%\");\n        })\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    // Obtiene planes en promoción vigente\n    public function planesEnPromocion(): Collection {\n        return $this->modelo->select('id', 'nombre', 'descripcion', 'creditos', 'precio', \n            'porcentaje_descuento', 'fecha_inicio_promocion', 'fecha_fin_promocion', 'activo')\n        ->where('activo', true)\n        ->whereNotNull('porcentaje_descuento')\n        ->where(function ($consulta) {\n            $hoy = now()->startOfDay();\n            // Lógica de fechas de promoción...\n        })->get();\n    }\n}\n```\n\n### Servicio: PlanCreditoService\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php`\n\n```php\nclass PlanCreditoService extends BaseService {\n    \n    // Crear o actualizar un plan de créditos\n    public function guardar(Request $request): PlanCredito {\n        $campos_excluidos = ['_token', '_method', 'id'];\n\n        if ($request->filled('id')) {\n            return $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        }\n\n        return $this->repositorio->crear($request->except($campos_excluidos));\n    }\n\n    // Calcular el precio final del plan\n    public function calcularPrecioFinal(PlanCredito $plan): float {\n        return $plan->precio_con_descuento;\n    }\n}\n```\n\n### Repositorio: ServicioIARepository\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ServicioIARepository.php`\n\n```php\nclass ServicioIARepository extends BaseRepository {\n    \n    // Obtiene todos los servicios de IA con sus créditos\n    public function getTodo(Request $request): Collection {\n        return $this->modelo->select('id', 'categoria_servicio_ia_id', 'nombre', 'endpoint', \n            'descripcion', 'consume_creditos')\n        ->with('categoria')\n        ->when($request->filled('activo'), function ($consulta) use ($request) {\n            $consulta->where('activo', filter_var($request->activo, FILTER_VALIDATE_BOOLEAN));\n        })\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    // Obtener un servicio por endpoint (ej: para buscar información específica)\n    public function getUnoAvanzado(Request $request): ?ServicioIA {\n        return $this->modelo->select('id', 'categoria_servicio_ia_id', 'nombre', 'endpoint', \n            'descripcion', 'consume_creditos', 'activo')\n        ->when($request->filled('endpoint'), fn($consulta) => $consulta->where('endpoint', $request->endpoint))\n        ->first();\n    }\n}\n```\n\n---\n\n## 6. VISTA Y FRONTEND\n\n### Vista: crear-creditos.blade.php\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\paginas\\crear-creditos.blade.php`\n\n**Estructura:**\n- Formulario con inputs para nombre, créditos disponibles, precio\n- Sección de acordeón que muestra consumo de créditos por funcionalidad\n- Lista dinámica de servicios IA obtenida por AJAX\n\n### JavaScript Frontend\n**Archivo:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\planes\\crear-plan-creditos.js`\n\n```javascript\nconst API_PLANES_CREDITOS = '/api/planes-creditos';\nconst API_SERVICIOS_IA = '/api/servicios-ia';\n\n// Cargar servicios IA y renderizar sus créditos\nfunction cargarServiciosIA() {\n    $.get(API_SERVICIOS_IA)\n        .then((respuesta) => {\n            let servicios = respuesta.data || [];\n            renderizarServiciosIA(servicios);\n        });\n}\n\n// Renderizar lista de servicios con inputs para créditos\nfunction renderizarServiciosIA(servicios) {\n    servicios.forEach((servicio) => {\n        let nombre = servicio.nombre || servicio.endpoint;\n        let categoria = servicio.categoria && servicio.categoria.nombre ? \n            ` (${servicio.categoria.nombre})` : '';\n        let valor = servicio.consume_creditos ?? 0;\n        \n        // Crear input para cada servicio\n        let fila = `\n            <div class=\"row mb-3 align-items-center\">\n                <div class=\"col-8\">\n                    <p class=\"text-body-2 mb-1\">${nombre}${categoria}</p>\n                </div>\n                <div class=\"col-4\">\n                    ${crearInput({\n                        id: 'credito_servicio_' + servicio.id,\n                        type: 'number',\n                        value: valor,\n                        class: 'input-credito',\n                        data: [{ texto: 'servicio-id', value: servicio.id }]\n                    })}\n                </div>\n            </div>\n        `;\n        contenedor.append(fila);\n    });\n}\n\n// Guardar plan de créditos\nfunction guardarPlanCreditos() {\n    // Actualizar todos los servicios primero\n    actualizarServiciosIA()\n        .then(() => guardarPlanCreditosAjax(url, datos))\n        .then((respuesta) => {\n            mostrarToast('success', respuesta.message);\n            // Redirigir...\n        });\n}\n\n// Actualizar créditos de cada servicio IA\nfunction actualizarServicioIA(servicio_id, valor) {\n    return $.ajax({\n        type: 'PUT',\n        url: `/api/servicios-ia/${servicio_id}`,\n        data: {\n            consume_creditos: valor  // IMPORTANTE: Aquí se guarda cuántos créditos consume\n        },\n        headers: {\n            'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    });\n}\n```\n\n---\n\n## 7. FLUJO DE DATOS: Cómo se almacenan y obtienen créditos\n\n### Diagrama de flujo:\n\n```\nFRONTEND (crear-plan-creditos.js)\n    ↓\n1. $.get('/api/servicios-ia')  ← Obtiene lista de servicios IA con consume_creditos\n    ↓ (datos retornados)\n   respuesta.data = [\n       { id: 1, nombre: 'Generar vacante', consume_creditos: 5, categoria: {...} },\n       { id: 2, nombre: 'Generar HV', consume_creditos: 3, categoria: {...} },\n       ...\n   ]\n    ↓\n2. renderizarServiciosIA(servicios) ← Renderiza inputs para cada servicio\n    ↓\n3. Usuario edita valores de créditos en cada input\n    ↓\n4. programarGuardadoServicio() con debounce (800ms)\n    ↓\n5. $.ajax(PUT, '/api/servicios-ia/{id}', { consume_creditos: valor })\n    ↓\nBACKEND (ServicioIAController@update)\n    ↓\nServicioIARepository->actualizar(id, { consume_creditos: valor })\n    ↓\nBD: servicios_ia.consume_creditos = valor  ← ALMACENADO\n    ↓\n6. Guardar plan de créditos completo\n    ↓\n   $.post('/api/planes-creditos', { nombre, creditos, precio })\n    ↓\nPlanCreditoController@store → PlanCreditoService@guardar\n    ↓\nBD: planes_creditos (nueva entrada)\n```\n\n---\n\n## 8. TABLA DE BASE DE DATOS\n\n### Tabla: `planes_creditos`\n**Migración:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000001_create_planes_creditos_table.php`\n\n```sql\nCREATE TABLE planes_creditos (\n    id BIGINT PRIMARY KEY AUTO_INCREMENT,\n    nombre VARCHAR(100),\n    descripcion TEXT,\n    creditos INT,              -- Total de créditos del plan\n    precio DECIMAL(10,2),\n    porcentaje_descuento SMALLINT,\n    fecha_inicio_promocion DATE,\n    fecha_fin_promocion DATE,\n    activo BOOLEAN DEFAULT TRUE,\n    created_at TIMESTAMP,\n    updated_at TIMESTAMP,\n    deleted_at TIMESTAMP\n);\n```\n\n### Tabla: `servicios_ia`\n**Migración:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000003_create_servicios_ia_table.php`\n\n```sql\nCREATE TABLE servicios_ia (\n    id BIGINT PRIMARY KEY AUTO_INCREMENT,\n    categoria_servicio_ia_id BIGINT,  -- FK\n    nombre VARCHAR(150),\n    endpoint VARCHAR(100) UNIQUE,     -- ej: \"generar-vacante\"\n    descripcion TEXT,\n    consume_creditos INT DEFAULT 0,   -- CLAVE: Créditos que consume este servicio\n    activo BOOLEAN DEFAULT TRUE,\n    created_at TIMESTAMP,\n    updated_at TIMESTAMP,\n    \n    FOREIGN KEY (categoria_servicio_ia_id) REFERENCES categorias_servicios_ia(id),\n    INDEX (categoria_servicio_ia_id, activo)\n);\n```\n\n### Tabla: `consumos_creditos`\n**Migración:** `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2025_12_05_152922_create_consumos_tokens_openai_table.php`\n\n```sql\nCREATE TABLE consumos_creditos (\n    id BIGINT PRIMARY KEY AUTO_INCREMENT,\n    usuario_id BIGINT,\n    empresa_id BIGINT,\n    empresa_plan_id BIGINT,\n    agenda_id BIGINT,\n    vacante_id BIGINT,\n    servicio_ia_id BIGINT,            -- FK a servicios_ia\n    creditos INT,                      -- Créditos consumidos en esta transacción\n    ruta_endpoint VARCHAR(100),\n    nombre_servicio VARCHAR(150),\n    modelo VARCHAR(50),\n    tokens_entrada INT,\n    tokens_salida INT,\n    tokens_totales INT,\n    caracteres_entrada INT,\n    costo_estimado_usd DECIMAL(10,6),\n    huella_peticion VARCHAR(64),\n    extracto_peticion TEXT,\n    extracto_respuesta TEXT,\n    estado VARCHAR(20),\n    latencia_ms INT,\n    mensaje_error TEXT,\n    created_at TIMESTAMP,\n    \n    INDEX (usuario_id, created_at),\n    INDEX (empresa_id, created_at),\n    INDEX (ruta_endpoint, created_at),\n    INDEX (huella_peticion)\n);\n```\n\n---\n\n## 9. EJEMPLOS DE ENDPOINTS SIMILARES\n\n### Endpoint que recibe ID y devuelve información específica\n\n**Ejemplo 1: Obtener un plan específico (edit)**\n```php\n// Ruta\n$ruta->get('planes-creditos/{id}/edit', 'Planes\\PlanController@editarPlanCreditos');\n\n// Controlador\npublic function editarPlanCreditos(int $id): View {\n    return view('planes.paginas.crear-creditos')->with([\n        'plan' => $this->plan_credito_repositorio->getUno($id),\n        'rutas_menu' => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true]))\n    ]);\n}\n\n// Repositorio (heredado de BaseRepository)\npublic function getUno($id) { \n    // Retorna un único registro por ID\n}\n```\n\n**Ejemplo 2: Obtener servicio IA por endpoint (búsqueda avanzada)**\n```php\n// En ServicioIARepository\npublic function getUnoAvanzado(Request $request): ?ServicioIA {\n    return $this->modelo->select('id', 'categoria_servicio_ia_id', 'nombre', 'endpoint', \n        'descripcion', 'consume_creditos', 'activo')\n    ->when($request->filled('endpoint'), \n        fn($consulta) => $consulta->where('endpoint', $request->endpoint))\n    ->first();\n}\n```\n\n**Ejemplo 3: Obtener consumo de créditos por plan (ConsumoCreditoRepository)**\n```php\n// En ConsumoCreditoRepository\npublic function obtenerConsumoPorEmpresaPlan(int $empresa_plan_id): Collection {\n    return $this->modelo\n    ->where('empresa_plan_id', $empresa_plan_id)\n    ->get();\n}\n\npublic function totalCreditosConsumidos(int $empresa_plan_id): int {\n    return (int) $this->modelo->where('empresa_plan_id', $empresa_plan_id)->sum('creditos');\n}\n```\n\n---\n\n## Resumen de Archivos Clave\n\n| Componente | Ruta Absoluta |\n|-----------|---------------|\n| **Rutas Web** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\web.php` |\n| **Rutas API** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\routes\\api.php` |\n| **Controlador Principal** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanController.php` |\n| **Controlador API** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\Planes\\PlanCreditoController.php` |\n| **Controlador IA** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Controllers\\IA\\ServicioIAController.php` |\n| **Modelo PlanCredito** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\Planes\\PlanCredito.php` |\n| **Modelo ServicioIA** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ServicioIA.php` |\n| **Modelo ConsumoCredito** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Models\\IA\\ConsumoCredito.php` |\n| **Repositorio PlanCredito** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\Planes\\PlanCreditoRepository.php` |\n| **Repositorio ServicioIA** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ServicioIARepository.php` |\n| **Repositorio ConsumoCredito** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Repositories\\IA\\ConsumoCreditoRepository.php` |\n| **Servicio PlanCredito** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\app\\Http\\Services\\Planes\\PlanCreditoService.php` |\n| **Vista Crear Créditos** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\resources\\views\\planes\\paginas\\crear-creditos.blade.php` |\n| **JavaScript Frontend** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\public\\js\\planes\\crear-plan-creditos.js` |\n| **Migración Planes** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000001_create_planes_creditos_table.php` |\n| **Migración Servicios IA** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2026_01_02_000003_create_servicios_ia_table.php` |\n| **Migración Consumos** | `C:\\Users\\sergio\\proyectos\\Psicoalianza-2\\database\\migrations\\2025_12_05_152922_create_consumos_tokens_openai_table.php` |"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":321,"cache_read_input_tokens":82602,"cache_creation":{"ephemeral_5m_input_tokens":321,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX9jaGaKo41dJGLeameGN","type":"assistant","uuid":"6954d355-8cbe-41bd-959e-4678fb8c9b81","timestamp":"2026-01-15T19:43:30.644Z"}
